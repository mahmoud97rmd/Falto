================================================================================
Ù…Ø³ØªØ®Ø±Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter
================================================================================

ğŸ“‹ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: falto
ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: /root/falto
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: 2026-01-18 23:05:26
ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: 870
ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·Ø±: 45,184
ğŸ’¾ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 1.2 MB

================================================================================
ğŸ“‘ Ø§Ù„ÙÙ‡Ø±Ø³
================================================================================


ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib
------------------------------------------------------------
  1. ğŸ“„ lib/app.dart (773.0 B, 28 Ø³Ø·Ø±)
  2. ğŸ“„ lib/main.dart (580.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/integration
------------------------------------------------------------
  3. ğŸ“„ lib/core/integration/webhook_handler.dart (377.0 B, 11 Ø³Ø·Ø±)
  4. ğŸ“„ lib/core/integration/webhook_push_bridge.dart (351.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/integration/telegram
------------------------------------------------------------
  5. ğŸ“„ lib/core/integration/telegram/telegram_bot.dart (275.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/localization
------------------------------------------------------------
  6. ğŸ“„ lib/core/localization/app_localizations.dart (265.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/sync
------------------------------------------------------------
  7. ğŸ“„ lib/core/sync/event_sync_controller.dart (465.0 B, 20 Ø³Ø·Ø±)
  8. ğŸ“„ lib/core/sync/timestamp_aligner.dart (386.0 B, 12 Ø³Ø·Ø±)
  9. ğŸ“„ lib/core/sync/indicator_throttler.dart (399.0 B, 18 Ø³Ø·Ø±)
 10. ğŸ“„ lib/core/sync/rest_ws_sync_coordinator.dart (467.0 B, 22 Ø³Ø·Ø±)
 11. ğŸ“„ lib/core/sync/compute_guard.dart (261.0 B, 14 Ø³Ø·Ø±)
 12. ğŸ“„ lib/core/sync/signal_sync_controller.dart (407.0 B, 18 Ø³Ø·Ø±)
 13. ğŸ“„ lib/core/sync/sync_manager.dart (42.0 B, 2 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/sync/cloud
------------------------------------------------------------
 14. ğŸ“„ lib/core/sync/cloud/cloud_sync_service.dart (629.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/log
------------------------------------------------------------
 15. ğŸ“„ lib/core/log/logger_service.dart (317.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/navigation
------------------------------------------------------------
 16. ğŸ“„ lib/core/navigation/app_router.dart (491.0 B, 17 Ø³Ø·Ø±)
 17. ğŸ“„ lib/core/navigation/fade_route.dart (392.0 B, 13 Ø³Ø·Ø±)
 18. ğŸ“„ lib/core/navigation/router_observer_fix.dart (299.0 B, 13 Ø³Ø·Ø±)
 19. ğŸ“„ lib/core/navigation/bloc_auto_dispose_route.dart (413.0 B, 16 Ø³Ø·Ø±)
 20. ğŸ“„ lib/core/navigation/router_bloc_cleanup.dart (408.0 B, 17 Ø³Ø·Ø±)
 21. ğŸ“„ lib/core/navigation/back_handler.dart (384.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/init
------------------------------------------------------------
 22. ğŸ“„ lib/core/init/app_initializer.dart (489.0 B, 20 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/market
------------------------------------------------------------
 23. ğŸ“„ lib/core/market/symbol_normalizer.dart (474.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc
------------------------------------------------------------
 24. ğŸ“„ lib/core/bloc/app_bloc_observer.dart (578.0 B, 21 Ø³Ø·Ø±)
 25. ğŸ“„ lib/core/bloc/bloc_observer.dart (542.0 B, 21 Ø³Ø·Ø±)
 26. ğŸ“„ lib/core/bloc/stream_handler.dart (238.0 B, 13 Ø³Ø·Ø±)
 27. ğŸ“„ lib/core/bloc/base_bloc.dart (359.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/subscription_manager
------------------------------------------------------------
 28. ğŸ“„ lib/core/bloc/subscription_manager/subscription_manager.dart (601.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/mixins
------------------------------------------------------------
 29. ğŸ“„ lib/core/bloc/mixins/event_guard.dart (113.0 B, 6 Ø³Ø·Ø±)
 30. ğŸ“„ lib/core/bloc/mixins/stream_controller_guard.dart (543.0 B, 23 Ø³Ø·Ø±)
 31. ğŸ“„ lib/core/bloc/mixins/side_effect_queue.dart (242.0 B, 11 Ø³Ø·Ø±)
 32. ğŸ“„ lib/core/bloc/mixins/stream_controller_manager.dart (459.0 B, 20 Ø³Ø·Ø±)
 33. ğŸ“„ lib/core/bloc/mixins/safe_dispose_mixin.dart (351.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/subscriptions
------------------------------------------------------------
 34. ğŸ“„ lib/core/bloc/subscriptions/subscription_manager.dart (277.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/providers
------------------------------------------------------------
 35. ğŸ“„ lib/core/bloc/providers/app_bloc_providers.dart (744.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/guards
------------------------------------------------------------
 36. ğŸ“„ lib/core/bloc/guards/async_dispose_guard.dart (319.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/sync
------------------------------------------------------------
 37. ğŸ“„ lib/core/bloc/sync/bloc_init_barrier.dart (237.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/root
------------------------------------------------------------
 38. ğŸ“„ lib/core/bloc/root/root_event.dart (335.0 B, 15 Ø³Ø·Ø±)
 39. ğŸ“„ lib/core/bloc/root/root_state.dart (352.0 B, 17 Ø³Ø·Ø±)
 40. ğŸ“„ lib/core/bloc/root/root_bloc.dart (586.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/init
------------------------------------------------------------
 41. ğŸ“„ lib/core/bloc/init/bloc_init_coordinator.dart (275.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/live_chart
------------------------------------------------------------
 42. ğŸ“„ lib/core/bloc/live_chart/live_chart_bloc.dart (1.6 KB, 58 Ø³Ø·Ø±)
 43. ğŸ“„ lib/core/bloc/live_chart/live_chart_event.dart (374.0 B, 15 Ø³Ø·Ø±)
 44. ğŸ“„ lib/core/bloc/live_chart/live_chart_state.dart (475.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/bloc/backtest
------------------------------------------------------------
 45. ğŸ“„ lib/core/bloc/backtest/backtest_bloc.dart (718.0 B, 29 Ø³Ø·Ø±)
 46. ğŸ“„ lib/core/bloc/backtest/backtest_event.dart (247.0 B, 13 Ø³Ø·Ø±)
 47. ğŸ“„ lib/core/bloc/backtest/backtest_state.dart (397.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/isolate
------------------------------------------------------------
 48. ğŸ“„ lib/core/isolate/isolate_helpers.dart (1.6 KB, 60 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/theme
------------------------------------------------------------
 49. ğŸ“„ lib/core/theme/app_theme.dart (160.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/markets
------------------------------------------------------------
 50. ğŸ“„ lib/core/markets/search_filter.dart (345.0 B, 12 Ø³Ø·Ø±)
 51. ğŸ“„ lib/core/markets/filter.dart (184.0 B, 6 Ø³Ø·Ø±)
 52. ğŸ“„ lib/core/markets/market_definitions.dart (161.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state
------------------------------------------------------------
 53. ğŸ“„ lib/core/state/subscription_cleanup_fix.dart (309.0 B, 16 Ø³Ø·Ø±)
 54. ğŸ“„ lib/core/state/bloc_close_fix.dart (157.0 B, 8 Ø³Ø·Ø±)
 55. ğŸ“„ lib/core/state/mode_mutex.dart (187.0 B, 8 Ø³Ø·Ø±)
 56. ğŸ“„ lib/core/state/debounce_helper.dart (296.0 B, 15 Ø³Ø·Ø±)
 57. ğŸ“„ lib/core/state/event_queue.dart (449.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/shared
------------------------------------------------------------
 58. ğŸ“„ lib/core/state/shared/latest_price_holder_fix.dart (122.0 B, 6 Ø³Ø·Ø±)
 59. ğŸ“„ lib/core/state/shared/price_volume_state.dart (284.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/bloc
------------------------------------------------------------
 60. ğŸ“„ lib/core/state/bloc/bloc_event_cancel_fix.dart (405.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/tab
------------------------------------------------------------
 61. ğŸ“„ lib/core/state/tab/tab_state_preserver.dart (251.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/event
------------------------------------------------------------
 62. ğŸ“„ lib/core/state/event/event_queue_fix.dart (413.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/paging
------------------------------------------------------------
 63. ğŸ“„ lib/core/state/paging/paging_tracker.dart (188.0 B, 9 Ø³Ø·Ø±)
 64. ğŸ“„ lib/core/state/paging/paging_guard.dart (183.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/empty
------------------------------------------------------------
 65. ğŸ“„ lib/core/state/empty/empty_state.dart (163.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/state/guard
------------------------------------------------------------
 66. ğŸ“„ lib/core/state/guard/state_transition_locker.dart (225.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart
------------------------------------------------------------
 67. ğŸ“„ lib/core/chart/chart_controller_manager.dart (313.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart/update
------------------------------------------------------------
 68. ğŸ“„ lib/core/chart/update/batch_update_manager.dart (401.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart/filter
------------------------------------------------------------
 69. ğŸ“„ lib/core/chart/filter/chart_filter_fix.dart (272.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart/gap
------------------------------------------------------------
 70. ğŸ“„ lib/core/chart/gap/gap_fill_manager.dart (1022.0 B, 37 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart/data
------------------------------------------------------------
 71. ğŸ“„ lib/core/chart/data/chart_data_stitcher.dart (477.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/utils
------------------------------------------------------------
 72. ğŸ“„ lib/core/utils/debounce.dart (273.0 B, 18 Ø³Ø·Ø±)
 73. ğŸ“„ lib/core/utils/secure_storage.dart (1.0 KB, 37 Ø³Ø·Ø±)
 74. ğŸ“„ lib/core/utils/network_checker.dart (279.0 B, 12 Ø³Ø·Ø±)
 75. ğŸ“„ lib/core/utils/notification_service.dart (1.1 KB, 39 Ø³Ø·Ø±)
 76. ğŸ“„ lib/core/utils/logger.dart (141.0 B, 8 Ø³Ø·Ø±)
 77. ğŸ“„ lib/core/utils/settings_debouncer.dart (263.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network
------------------------------------------------------------
 78. ğŸ“„ lib/core/network/retry_interceptor.dart (377.0 B, 15 Ø³Ø·Ø±)
 79. ğŸ“„ lib/core/network/rest_client.dart (40.0 B, 2 Ø³Ø·Ø±)
 80. ğŸ“„ lib/core/network/ws_manager.dart (38.0 B, 2 Ø³Ø·Ø±)
 81. ğŸ“„ lib/core/network/markets_api.dart (358.0 B, 15 Ø³Ø·Ø±)
 82. ğŸ“„ lib/core/network/rate_limit_interceptor.dart (438.0 B, 15 Ø³Ø·Ø±)
 83. ğŸ“„ lib/core/network/oanda_stream_client.dart (704.0 B, 33 Ø³Ø·Ø±)
 84. ğŸ“„ lib/core/network/error_utils.dart (524.0 B, 14 Ø³Ø·Ø±)
 85. ğŸ“„ lib/core/network/oanda_rest_config.dart (221.0 B, 6 Ø³Ø·Ø±)
 86. ğŸ“„ lib/core/network/oanda_rest_client.dart (818.0 B, 24 Ø³Ø·Ø±)
 87. ğŸ“„ lib/core/network/error_handler.dart (359.0 B, 7 Ø³Ø·Ø±)
 88. ğŸ“„ lib/core/network/network_listener_fix.dart (595.0 B, 23 Ø³Ø·Ø±)
 89. ğŸ“„ lib/core/network/fallback_manager.dart (349.0 B, 11 Ø³Ø·Ø±)
 90. ğŸ“„ lib/core/network/rest_error.dart (92.0 B, 4 Ø³Ø·Ø±)
 91. ğŸ“„ lib/core/network/network_service.dart (543.0 B, 20 Ø³Ø·Ø±)
 92. ğŸ“„ lib/core/network/network_observer.dart (455.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/security
------------------------------------------------------------
 93. ğŸ“„ lib/core/network/security/http_pinning_client.dart (682.0 B, 22 Ø³Ø·Ø±)
 94. ğŸ“„ lib/core/network/security/certificate_pinning.dart (469.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/security/pinning
------------------------------------------------------------
 95. ğŸ“„ lib/core/network/security/pinning/ws_pinned_io.dart (754.0 B, 26 Ø³Ø·Ø±)
 96. ğŸ“„ lib/core/network/security/pinning/pin_store.dart (531.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/error
------------------------------------------------------------
 97. ğŸ“„ lib/core/network/error/network_error_handler.dart (967.0 B, 35 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/retry
------------------------------------------------------------
 98. ğŸ“„ lib/core/network/retry/network_bounce_handler_fix.dart (270.0 B, 12 Ø³Ø·Ø±)
 99. ğŸ“„ lib/core/network/retry/retry_with_backoff.dart (357.0 B, 15 Ø³Ø·Ø±)
100. ğŸ“„ lib/core/network/retry/retry_limiter.dart (464.0 B, 22 Ø³Ø·Ø±)
101. ğŸ“„ lib/core/network/retry/retry_policy.dart (1.4 KB, 62 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws
------------------------------------------------------------
102. ğŸ“„ lib/core/network/ws/ws_reconnect_fix.dart (375.0 B, 18 Ø³Ø·Ø±)
103. ğŸ“„ lib/core/network/ws/ws_reconnect_guard_fix.dart (387.0 B, 18 Ø³Ø·Ø±)
104. ğŸ“„ lib/core/network/ws/ws_reconnect_manager.dart (722.0 B, 27 Ø³Ø·Ø±)
105. ğŸ“„ lib/core/network/ws/ws_timeframe_guard.dart (299.0 B, 12 Ø³Ø·Ø±)
106. ğŸ“„ lib/core/network/ws/ws_disconnect_on_offline.dart (349.0 B, 15 Ø³Ø·Ø±)
107. ğŸ“„ lib/core/network/ws/ws_channel_manager.dart (598.0 B, 25 Ø³Ø·Ø±)
108. ğŸ“„ lib/core/network/ws/ws_manager.dart (354.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/transport
------------------------------------------------------------
109. ğŸ“„ lib/core/network/ws/transport/ws_transport_retry.dart (661.0 B, 24 Ø³Ø·Ø±)
110. ğŸ“„ lib/core/network/ws/transport/ws_transport.dart (1.3 KB, 50 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/parsers
------------------------------------------------------------
111. ğŸ“„ lib/core/network/ws/parsers/safe_ws_parser.dart (236.0 B, 7 Ø³Ø·Ø±)
112. ğŸ“„ lib/core/network/ws/parsers/tick_parser_fix.dart (196.0 B, 8 Ø³Ø·Ø±)
113. ğŸ“„ lib/core/network/ws/parsers/safe_depth_parser.dart (257.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/manager
------------------------------------------------------------
114. ğŸ“„ lib/core/network/ws/manager/ws_switch_manager.dart (644.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/security
------------------------------------------------------------
115. ğŸ“„ lib/core/network/ws/security/ws_certificate_pinning.dart (287.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/registry
------------------------------------------------------------
116. ğŸ“„ lib/core/network/ws/registry/ws_subscription_registry.dart (281.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/error
------------------------------------------------------------
117. ğŸ“„ lib/core/network/ws/error/ws_error_handler.dart (310.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/smart
------------------------------------------------------------
118. ğŸ“„ lib/core/network/ws/smart/ws_smart_manager.dart (1.3 KB, 52 Ø³Ø·Ø±)
119. ğŸ“„ lib/core/network/ws/smart/ws_smart_reconnect_fix.dart (772.0 B, 31 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/lifecycle
------------------------------------------------------------
120. ğŸ“„ lib/core/network/ws/lifecycle/ws_lifecycle_handler.dart (362.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/pipeline
------------------------------------------------------------
121. ğŸ“„ lib/core/network/ws/pipeline/ws_pipeline.dart (40.0 B, 2 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/ws/backoff
------------------------------------------------------------
122. ğŸ“„ lib/core/network/ws/backoff/ws_backoff_manager.dart (302.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/rest
------------------------------------------------------------
123. ğŸ“„ lib/core/network/rest/cancelable_request.dart (294.0 B, 14 Ø³Ø·Ø±)
124. ğŸ“„ lib/core/network/rest/rest_timeout.dart (227.0 B, 9 Ø³Ø·Ø±)
125. ğŸ“„ lib/core/network/rest/rest_client.dart (1.9 KB, 79 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/rest/guard
------------------------------------------------------------
126. ğŸ“„ lib/core/network/rest/guard/rest_fetch_guard.dart (235.0 B, 9 Ø³Ø·Ø±)
127. ğŸ“„ lib/core/network/rest/guard/safe_rest_response.dart (310.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/rest/parsers
------------------------------------------------------------
128. ğŸ“„ lib/core/network/rest/parsers/safe_api_parser.dart (524.0 B, 15 Ø³Ø·Ø±)
129. ğŸ“„ lib/core/network/rest/parsers/safe_json_parser.dart (165.0 B, 5 Ø³Ø·Ø±)
130. ğŸ“„ lib/core/network/rest/parsers/json_safe_helpers.dart (346.0 B, 11 Ø³Ø·Ø±)
131. ğŸ“„ lib/core/network/rest/parsers/safe_map_parser.dart (182.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/rest/timeout
------------------------------------------------------------
132. ğŸ“„ lib/core/network/rest/timeout/timeout_handler.dart (300.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/rest/throttle
------------------------------------------------------------
133. ğŸ“„ lib/core/network/rest/throttle/rest_throttle.dart (317.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/http
------------------------------------------------------------
134. ğŸ“„ lib/core/network/http/rest_client.dart (1006.0 B, 32 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/manager
------------------------------------------------------------
135. ğŸ“„ lib/core/network/manager/network_mode_coordinator.dart (587.0 B, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/pinning
------------------------------------------------------------
136. ğŸ“„ lib/core/network/pinning/http_pinning_client.dart (592.0 B, 20 Ø³Ø·Ø±)
137. ğŸ“„ lib/core/network/pinning/ws_pinned_io.dart (728.0 B, 26 Ø³Ø·Ø±)
138. ğŸ“„ lib/core/network/pinning/pin_store.dart (371.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/websocket
------------------------------------------------------------
139. ğŸ“„ lib/core/network/websocket/ping_manager.dart (351.0 B, 19 Ø³Ø·Ø±)
140. ğŸ“„ lib/core/network/websocket/message_verifier.dart (259.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/oanda
------------------------------------------------------------
141. ğŸ“„ lib/core/network/oanda/oanda_config.dart (277.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/oanda/client
------------------------------------------------------------
142. ğŸ“„ lib/core/network/oanda/client/oanda_rest_client.dart (1.5 KB, 42 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/network/oanda/stream
------------------------------------------------------------
143. ğŸ“„ lib/core/network/oanda/stream/oanda_stream_client.dart (1.3 KB, 44 Ø³Ø·Ø±)
144. ğŸ“„ lib/core/network/oanda/stream/oanda_ws_client.dart (1.5 KB, 59 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/buffer
------------------------------------------------------------
145. ğŸ“„ lib/core/buffer/ring_buffer.dart (352.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/logging
------------------------------------------------------------
146. ğŸ“„ lib/core/logging/audit_logger.dart (517.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/logging/ui
------------------------------------------------------------
147. ğŸ“„ lib/core/logging/ui/logs_page.dart (607.0 B, 23 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/models
------------------------------------------------------------
148. ğŸ“„ lib/core/models/candle_entity.dart (22.0 B, 1 Ø³Ø·Ø±)
149. ğŸ“„ lib/core/models/tick_entity.dart (20.0 B, 1 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/models/adapters
------------------------------------------------------------
150. ğŸ“„ lib/core/models/adapters/candle_entity_adapter.dart (791.0 B, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/models/price
------------------------------------------------------------
151. ğŸ“„ lib/core/models/price/spread_model.dart (153.0 B, 8 Ø³Ø·Ø±)
152. ğŸ“„ lib/core/models/price/spread_fix.dart (150.0 B, 4 Ø³Ø·Ø±)
153. ğŸ“„ lib/core/models/price/market_price.dart (363.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/models/dto
------------------------------------------------------------
154. ğŸ“„ lib/core/models/dto/candle_dto.dart (550.0 B, 28 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/models/factories
------------------------------------------------------------
155. ğŸ“„ lib/core/models/factories/candle_factory.dart (519.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage
------------------------------------------------------------
156. ğŸ“„ lib/core/storage/replay_storage.dart (366.0 B, 19 Ø³Ø·Ø±)
157. ğŸ“„ lib/core/storage/preferences.dart (398.0 B, 13 Ø³Ø·Ø±)
158. ğŸ“„ lib/core/storage/hive_cleanup_fix.dart (173.0 B, 9 Ø³Ø·Ø±)
159. ğŸ“„ lib/core/storage/safe_storage.dart (376.0 B, 23 Ø³Ø·Ø±)
160. ğŸ“„ lib/core/storage/usage_monitor.dart (376.0 B, 15 Ø³Ø·Ø±)
161. ğŸ“„ lib/core/storage/transactional_file_saver.dart (267.0 B, 10 Ø³Ø·Ø±)
162. ğŸ“„ lib/core/storage/file_write_safe.dart (317.0 B, 13 Ø³Ø·Ø±)
163. ğŸ“„ lib/core/storage/shared_prefs_cleaner.dart (218.0 B, 8 Ø³Ø·Ø±)
164. ğŸ“„ lib/core/storage/watchlist.dart (457.0 B, 20 Ø³Ø·Ø±)
165. ğŸ“„ lib/core/storage/safe_restore.dart (224.0 B, 10 Ø³Ø·Ø±)
166. ğŸ“„ lib/core/storage/app_preferences.dart (401.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/oanda
------------------------------------------------------------
167. ğŸ“„ lib/core/storage/oanda/secure_storage.dart (712.0 B, 28 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/cache
------------------------------------------------------------
168. ğŸ“„ lib/core/storage/cache/cache_manager.dart (1.1 KB, 39 Ø³Ø·Ø±)
169. ğŸ“„ lib/core/storage/cache/ttl_cache.dart (952.0 B, 41 Ø³Ø·Ø±)
170. ğŸ“„ lib/core/storage/cache/cache_strategy.dart (182.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/script
------------------------------------------------------------
171. ğŸ“„ lib/core/storage/script/script_hive.dart (51.0 B, 2 Ø³Ø·Ø±)
172. ğŸ“„ lib/core/storage/script/script_storage.dart (23.0 B, 1 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/chart_cache
------------------------------------------------------------
173. ğŸ“„ lib/core/storage/chart_cache/chart_cache_hive.dart (430.0 B, 22 Ø³Ø·Ø±)
174. ğŸ“„ lib/core/storage/chart_cache/chart_cache_storage.dart (765.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/strategy
------------------------------------------------------------
175. ğŸ“„ lib/core/storage/strategy/strategy_storage.dart (184.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/hive_adapters
------------------------------------------------------------
176. ğŸ“„ lib/core/storage/hive_adapters/candle_adapter.dart (1.1 KB, 56 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/theme
------------------------------------------------------------
177. ğŸ“„ lib/core/storage/theme/theme_storage.dart (22.0 B, 1 Ø³Ø·Ø±)
178. ğŸ“„ lib/core/storage/theme/theme_hive.dart (49.0 B, 2 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/audit
------------------------------------------------------------
179. ğŸ“„ lib/core/storage/audit/audit_storage.dart (22.0 B, 1 Ø³Ø·Ø±)
180. ğŸ“„ lib/core/storage/audit/audit_hive.dart (49.0 B, 2 Ø³Ø·Ø±)
181. ğŸ“„ lib/core/storage/audit/audit_flush_on_error.dart (248.0 B, 8 Ø³Ø·Ø±)
182. ğŸ“„ lib/core/storage/audit/event_audit_manager3.dart (684.0 B, 24 Ø³Ø·Ø±)
183. ğŸ“„ lib/core/storage/audit/event_audit_manager2.dart (533.0 B, 21 Ø³Ø·Ø±)
184. ğŸ“„ lib/core/storage/audit/event_audit_manager.dart (391.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/sync
------------------------------------------------------------
185. ğŸ“„ lib/core/storage/sync/preferences_write_lock.dart (297.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/transaction
------------------------------------------------------------
186. ğŸ“„ lib/core/storage/transaction/transactional_write_fix.dart (265.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/replay
------------------------------------------------------------
187. ğŸ“„ lib/core/storage/replay/replay_storage.dart (472.0 B, 16 Ø³Ø·Ø±)
188. ğŸ“„ lib/core/storage/replay/replay_hive.dart (281.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/indicator
------------------------------------------------------------
189. ğŸ“„ lib/core/storage/indicator/indicator_settings_storage.dart (572.0 B, 17 Ø³Ø·Ø±)
190. ğŸ“„ lib/core/storage/indicator/indicator_hive.dart (73.0 B, 2 Ø³Ø·Ø±)
191. ğŸ“„ lib/core/storage/indicator/indicator_storage.dart (34.0 B, 1 Ø³Ø·Ø±)
192. ğŸ“„ lib/core/storage/indicator/indicator_settings_storage2.dart (599.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/storage/hive
------------------------------------------------------------
193. ğŸ“„ lib/core/storage/hive/hive_migration.dart (435.0 B, 15 Ø³Ø·Ø±)
194. ğŸ“„ lib/core/storage/hive/compactor.dart (138.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/performance
------------------------------------------------------------
195. ğŸ“„ lib/core/performance/fps_monitor.dart (392.0 B, 13 Ø³Ø·Ø±)
196. ğŸ“„ lib/core/performance/performance_and_cache_manager.dart (2.4 KB, 98 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/error
------------------------------------------------------------
197. ğŸ“„ lib/core/error/failure.dart (394.0 B, 20 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/di
------------------------------------------------------------
198. ğŸ“„ lib/core/di/dependency_injection.dart (369.0 B, 13 Ø³Ø·Ø±)
199. ğŸ“„ lib/core/di/hive_init.dart (217.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/startup
------------------------------------------------------------
200. ğŸ“„ lib/core/startup/loading_coordinator.dart (96.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/monitoring
------------------------------------------------------------
201. ğŸ“„ lib/core/monitoring/production_monitoring_setup.dart (1.2 KB, 41 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/errors
------------------------------------------------------------
202. ğŸ“„ lib/core/errors/app_error.dart (713.0 B, 31 Ø³Ø·Ø±)
203. ğŸ“„ lib/core/errors/failures.dart (340.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/notifications
------------------------------------------------------------
204. ğŸ“„ lib/core/notifications/firebase_messaging_service.dart (361.0 B, 14 Ø³Ø·Ø±)
205. ğŸ“„ lib/core/notifications/notification_service.dart (677.0 B, 20 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/cache
------------------------------------------------------------
206. ğŸ“„ lib/core/cache/history_cache_guard.dart (701.0 B, 20 Ø³Ø·Ø±)
207. ğŸ“„ lib/core/cache/persistent_history_cache.dart (793.0 B, 23 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/webview
------------------------------------------------------------
208. ğŸ“„ lib/core/webview/webview_controller_cleanup_fix.dart (167.0 B, 7 Ø³Ø·Ø±)
209. ğŸ“„ lib/core/webview/js_sl_tp_fix.js (151.0 B, 7 Ø³Ø·Ø±)
210. ğŸ“„ lib/core/webview/webview_error_guard.dart (339.0 B, 13 Ø³Ø·Ø±)
211. ğŸ“„ lib/core/webview/js_batch_update.js (238.0 B, 8 Ø³Ø·Ø±)
212. ğŸ“„ lib/core/webview/js_error_filter.js (141.0 B, 4 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/webview/guard
------------------------------------------------------------
213. ğŸ“„ lib/core/webview/guard/webview_js_ready_guard.dart (493.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/drawing
------------------------------------------------------------
214. ğŸ“„ lib/core/drawing/undo_redo_drawing_manager.dart (2.2 KB, 88 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/data/sanitizer
------------------------------------------------------------
215. ğŸ“„ lib/core/data/sanitizer/data_sanitizer.dart (383.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/data/gap_fill
------------------------------------------------------------
216. ğŸ“„ lib/core/data/gap_fill/gap_fill_manager.dart (901.0 B, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/lifecycle
------------------------------------------------------------
217. ğŸ“„ lib/core/lifecycle/resume_load_coordinator_fix.dart (152.0 B, 7 Ø³Ø·Ø±)
218. ğŸ“„ lib/core/lifecycle/resource_lifecycle_observer_fix.dart (374.0 B, 12 Ø³Ø·Ø±)
219. ğŸ“„ lib/core/lifecycle/init_once_guard.dart (188.0 B, 9 Ø³Ø·Ø±)
220. ğŸ“„ lib/core/lifecycle/app_lifecycle_manager.dart (439.0 B, 14 Ø³Ø·Ø±)
221. ğŸ“„ lib/core/lifecycle/app_lifecycle_observer.dart (358.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/time
------------------------------------------------------------
222. ğŸ“„ lib/core/time/time_zone_config.dart (329.0 B, 12 Ø³Ø·Ø±)
223. ğŸ“„ lib/core/time/market_hours_filter_fix.dart (271.0 B, 11 Ø³Ø·Ø±)
224. ğŸ“„ lib/core/time/time_formatter.dart (111.0 B, 5 Ø³Ø·Ø±)
225. ğŸ“„ lib/core/time/iso_date_normalizer.dart (237.0 B, 9 Ø³Ø·Ø±)
226. ğŸ“„ lib/core/time/time_canon.dart (621.0 B, 22 Ø³Ø·Ø±)
227. ğŸ“„ lib/core/time/session_filter.dart (210.0 B, 7 Ø³Ø·Ø±)
228. ğŸ“„ lib/core/time/time_normalizer.dart (217.0 B, 7 Ø³Ø·Ø±)
229. ğŸ“„ lib/core/time/market_hours_filter.dart (388.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/settings
------------------------------------------------------------
230. ğŸ“„ lib/core/settings/mode_storage.dart (72.0 B, 3 Ø³Ø·Ø±)
231. ğŸ“„ lib/core/settings/server_mode.dart (153.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/export
------------------------------------------------------------
232. ğŸ“„ lib/core/export/csv_exporter.dart (412.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/export/pdf
------------------------------------------------------------
233. ğŸ“„ lib/core/export/pdf/pdf_report.dart (316.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/export/settings
------------------------------------------------------------
234. ğŸ“„ lib/core/export/settings/json_settings_exporter.dart (536.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/security
------------------------------------------------------------
235. ğŸ“„ lib/core/security/token_refresh_guard.dart (446.0 B, 16 Ø³Ø·Ø±)
236. ğŸ“„ lib/core/security/secure_storage_manager.dart (577.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/security/refresh
------------------------------------------------------------
237. ğŸ“„ lib/core/security/refresh/token_refresh_guard.dart (860.0 B, 28 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/mode
------------------------------------------------------------
238. ğŸ“„ lib/core/mode/mode_stream_manager.dart (284.0 B, 14 Ø³Ø·Ø±)
239. ğŸ“„ lib/core/mode/app_mode_guard.dart (341.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/audio
------------------------------------------------------------
240. ğŸ“„ lib/core/audio/alert_sound.dart (263.0 B, 8 Ø³Ø·Ø±)
241. ğŸ“„ lib/core/audio/alert_sound_singleton.dart (425.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/streams
------------------------------------------------------------
242. ğŸ“„ lib/core/streams/symbol_stream_guard.dart (315.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/ui
------------------------------------------------------------
243. ğŸ“„ lib/core/ui/theme_setup.dart (243.0 B, 10 Ø³Ø·Ø±)
244. ğŸ“„ lib/core/ui/theme_notifier.dart (239.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/ui/fonts
------------------------------------------------------------
245. ğŸ“„ lib/core/ui/fonts/text_style_manager.dart (247.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/ui/theme
------------------------------------------------------------
246. ğŸ“„ lib/core/ui/theme/app_themes.dart (369.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/ui/styles
------------------------------------------------------------
247. ğŸ“„ lib/core/ui/styles/app_theme.dart (494.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/ui/widgets
------------------------------------------------------------
248. ğŸ“„ lib/core/ui/widgets/responsive_widget.dart (436.0 B, 19 Ø³Ø·Ø±)
249. ğŸ“„ lib/core/ui/widgets/error_screen.dart (639.0 B, 24 Ø³Ø·Ø±)
250. ğŸ“„ lib/core/ui/widgets/shimmer_placeholder.dart (536.0 B, 22 Ø³Ø·Ø±)
251. ğŸ“„ lib/core/ui/widgets/add_to_watchlist_sheet.dart (662.0 B, 25 Ø³Ø·Ø±)
252. ğŸ“„ lib/core/ui/widgets/loading_widget.dart (493.0 B, 20 Ø³Ø·Ø±)
253. ğŸ“„ lib/core/ui/widgets/base_scaffold.dart (563.0 B, 29 Ø³Ø·Ø±)
254. ğŸ“„ lib/core/ui/widgets/error_widget.dart (411.0 B, 17 Ø³Ø·Ø±)
255. ğŸ“„ lib/core/ui/widgets/chart_webview.dart (364.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/persistence
------------------------------------------------------------
256. ğŸ“„ lib/core/persistence/persistent_state_manager.dart (511.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/compute
------------------------------------------------------------
257. ğŸ“„ lib/core/compute/backtest_save_isolate.dart (115.0 B, 5 Ø³Ø·Ø±)
258. ğŸ“„ lib/core/compute/async_loader_fix.dart (109.0 B, 5 Ø³Ø·Ø±)
259. ğŸ“„ lib/core/compute/history_fetch_isolate.dart (137.0 B, 6 Ø³Ø·Ø±)
260. ğŸ“„ lib/core/compute/isolate_task_manager.dart (367.0 B, 18 Ø³Ø·Ø±)
261. ğŸ“„ lib/core/compute/backtest_chunked_runner.dart (252.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/permissions
------------------------------------------------------------
262. ğŸ“„ lib/core/permissions/permission_manager.dart (372.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart_sync_manager
------------------------------------------------------------
263. ğŸ“„ lib/core/chart_sync_manager/multi_tf_sync.dart (3.7 KB, 120 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/execution
------------------------------------------------------------
264. ğŸ“„ lib/core/execution/offline_alerts_backtest_settings.dart (5.3 KB, 216 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/filters
------------------------------------------------------------
265. ğŸ“„ lib/core/filters/candle_outlier_filter.dart (586.0 B, 18 Ø³Ø·Ø±)
266. ğŸ“„ lib/core/filters/price_spike_filter.dart (210.0 B, 7 Ø³Ø·Ø±)
267. ğŸ“„ lib/core/filters/range_filter_fix.dart (280.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/telemetry
------------------------------------------------------------
268. ğŸ“„ lib/core/telemetry/sentry_service.dart (213.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/ui_helpers
------------------------------------------------------------
269. ğŸ“„ lib/core/ui_helpers/app_init_and_replay_alert_ui.dart (1.9 KB, 69 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/timeframes
------------------------------------------------------------
270. ğŸ“„ lib/core/timeframes/timeframe_utils.dart (462.0 B, 20 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/queue
------------------------------------------------------------
271. ğŸ“„ lib/core/queue/execution_queue.dart (532.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/widgets
------------------------------------------------------------
272. ğŸ“„ lib/core/widgets/keep_alive_chart.dart (483.0 B, 22 Ø³Ø·Ø±)
273. ğŸ“„ lib/core/widgets/error_view.dart (975.0 B, 39 Ø³Ø·Ø±)
274. ğŸ“„ lib/core/widgets/crosshair.dart (794.0 B, 31 Ø³Ø·Ø±)
275. ğŸ“„ lib/core/widgets/marker_painter.dart (627.0 B, 24 Ø³Ø·Ø±)
276. ğŸ“„ lib/core/widgets/notification_toast.dart (241.0 B, 11 Ø³Ø·Ø±)
277. ğŸ“„ lib/core/widgets/shimmer_placeholder.dart (531.0 B, 22 Ø³Ø·Ø±)
278. ğŸ“„ lib/core/widgets/error_display.dart (768.0 B, 29 Ø³Ø·Ø±)
279. ğŸ“„ lib/core/widgets/animation_controller_guard.dart (308.0 B, 14 Ø³Ø·Ø±)
280. ğŸ“„ lib/core/widgets/keep_alive_responsive.dart (512.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/widgets/loading
------------------------------------------------------------
281. ğŸ“„ lib/core/widgets/loading/shimmer_loader.dart (531.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/widgets/mixins
------------------------------------------------------------
282. ğŸ“„ lib/core/widgets/mixins/safe_widget_dispose.dart (590.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/widgets/fix
------------------------------------------------------------
283. ğŸ“„ lib/core/widgets/fix/disposable_stateful.dart (216.0 B, 12 Ø³Ø·Ø±)
284. ğŸ“„ lib/core/widgets/fix/repaint_boundary_chart.dart (263.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/async
------------------------------------------------------------
285. ğŸ“„ lib/core/async/batch_computer.dart (343.0 B, 13 Ø³Ø·Ø±)
286. ğŸ“„ lib/core/async/dispatcher.dart (241.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/backtest
------------------------------------------------------------
287. ğŸ“„ lib/core/backtest/backtest_engine.dart (2.6 KB, 104 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/indicators
------------------------------------------------------------
288. ğŸ“„ lib/core/indicators/indicator_models.dart (298.0 B, 15 Ø³Ø·Ø±)
289. ğŸ“„ lib/core/indicators/indicator_engine.dart (1.9 KB, 65 Ø³Ø·Ø±)
290. ğŸ“„ lib/core/indicators/indicator_painter.dart (1.5 KB, 54 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/drawing_tools
------------------------------------------------------------
291. ğŸ“„ lib/core/drawing_tools/drawing_tools_integration.dart (4.6 KB, 211 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/core/chart_interaction
------------------------------------------------------------
292. ğŸ“„ lib/core/chart_interaction/zoom_pan_crosshair.dart (3.8 KB, 143 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain
------------------------------------------------------------
293. ğŸ“„ lib/features/strategy/domain/strategy_engine.dart (320.0 B, 14 Ø³Ø·Ø±)
294. ğŸ“„ lib/features/strategy/domain/strategy_model.dart (310.0 B, 13 Ø³Ø·Ø±)
295. ğŸ“„ lib/features/strategy/domain/strategy_safe_eval_fix.dart (108.0 B, 4 Ø³Ø·Ø±)
296. ğŸ“„ lib/features/strategy/domain/strategy_engine_cleanup_fix.dart (98.0 B, 3 Ø³Ø·Ø±)
297. ğŸ“„ lib/features/strategy/domain/signal_evaluator_sync_fix.dart (381.0 B, 15 Ø³Ø·Ø±)
298. ğŸ“„ lib/features/strategy/domain/undo_redo_manager.dart (329.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain/fsm
------------------------------------------------------------
299. ğŸ“„ lib/features/strategy/domain/fsm/strategy_state.dart (89.0 B, 8 Ø³Ø·Ø±)
300. ğŸ“„ lib/features/strategy/domain/fsm/strategy_fsm.dart (371.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain/signal
------------------------------------------------------------
301. ğŸ“„ lib/features/strategy/domain/signal/signal.dart (135.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain/ast
------------------------------------------------------------
302. ğŸ“„ lib/features/strategy/domain/ast/greater_than_node.dart (374.0 B, 15 Ø³Ø·Ø±)
303. ğŸ“„ lib/features/strategy/domain/ast/and_node.dart (313.0 B, 14 Ø³Ø·Ø±)
304. ğŸ“„ lib/features/strategy/domain/ast/expr_node.dart (185.0 B, 6 Ø³Ø·Ø±)
305. ğŸ“„ lib/features/strategy/domain/ast/cross_up_node.dart (662.0 B, 29 Ø³Ø·Ø±)
306. ğŸ“„ lib/features/strategy/domain/ast/expr.dart (637.0 B, 35 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain/indicators
------------------------------------------------------------
307. ğŸ“„ lib/features/strategy/domain/indicators/ema_indicator.dart (22.0 B, 1 Ø³Ø·Ø±)
308. ğŸ“„ lib/features/strategy/domain/indicators/rsi_indicator.dart (22.0 B, 1 Ø³Ø·Ø±)
309. ğŸ“„ lib/features/strategy/domain/indicators/bollinger_indicator.dart (1.1 KB, 39 Ø³Ø·Ø±)
310. ğŸ“„ lib/features/strategy/domain/indicators/ema.dart (699.0 B, 32 Ø³Ø·Ø±)
311. ğŸ“„ lib/features/strategy/domain/indicators/indicator.dart (318.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain/evaluator
------------------------------------------------------------
312. ğŸ“„ lib/features/strategy/domain/evaluator/example_strategy.dart (40.0 B, 1 Ø³Ø·Ø±)
313. ğŸ“„ lib/features/strategy/domain/evaluator/sequential_evaluator.dart (945.0 B, 41 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/domain/dsl
------------------------------------------------------------
314. ğŸ“„ lib/features/strategy/domain/dsl/strategy_dsl.dart (166.0 B, 5 Ø³Ø·Ø±)
315. ğŸ“„ lib/features/strategy/domain/dsl/strategy_dsl_safe_eval.dart (288.0 B, 9 Ø³Ø·Ø±)
316. ğŸ“„ lib/features/strategy/domain/dsl/strategy_dsl_safety.dart (116.0 B, 5 Ø³Ø·Ø±)
317. ğŸ“„ lib/features/strategy/domain/dsl/strategy_dsl_validator.dart (356.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/presentation/widgets
------------------------------------------------------------
318. ğŸ“„ lib/features/strategy/presentation/widgets/strategy_dsl_editor.dart (749.0 B, 30 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy/presentation/bloc
------------------------------------------------------------
319. ğŸ“„ lib/features/strategy/presentation/bloc/strategy_builder_event.dart (924.0 B, 42 Ø³Ø·Ø±)
320. ğŸ“„ lib/features/strategy/presentation/bloc/strategy_builder_state.dart (367.0 B, 15 Ø³Ø·Ø±)
321. ğŸ“„ lib/features/strategy/presentation/bloc/strategy_builder_bloc.dart (2.2 KB, 65 Ø³Ø·Ø±)
322. ğŸ“„ lib/features/strategy/presentation/bloc/strategy_bloc.dart (329.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market_depth/data
------------------------------------------------------------
323. ğŸ“„ lib/features/market_depth/data/order_book_ws.dart (556.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market_depth/presentation/widgets
------------------------------------------------------------
324. ğŸ“„ lib/features/market_depth/presentation/widgets/order_book_view.dart (554.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market_depth/presentation/bloc
------------------------------------------------------------
325. ğŸ“„ lib/features/market_depth/presentation/bloc/order_book_state_fix.dart (128.0 B, 6 Ø³Ø·Ø±)
326. ğŸ“„ lib/features/market_depth/presentation/bloc/order_book_reset_fix.dart (475.0 B, 16 Ø³Ø·Ø±)
327. ğŸ“„ lib/features/market_depth/presentation/bloc/order_book_bloc.dart (605.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market_depth/domain
------------------------------------------------------------
328. ğŸ“„ lib/features/market_depth/domain/order_book_safe.dart (130.0 B, 6 Ø³Ø·Ø±)
329. ğŸ“„ lib/features/market_depth/domain/order_book_sync.dart (308.0 B, 13 Ø³Ø·Ø±)
330. ğŸ“„ lib/features/market_depth/domain/order_book.dart (260.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/presentation
------------------------------------------------------------
331. ğŸ“„ lib/features/settings/presentation/settings_screen.dart (604.0 B, 23 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/presentation/pages
------------------------------------------------------------
332. ğŸ“„ lib/features/settings/presentation/pages/settings_page.dart (1.5 KB, 53 Ø³Ø·Ø±)
333. ğŸ“„ lib/features/settings/presentation/pages/theme_switch.dart (696.0 B, 31 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/presentation/pages/theme
------------------------------------------------------------
334. ğŸ“„ lib/features/settings/presentation/pages/theme/theme_settings_page.dart (2.4 KB, 78 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/presentation/widgets
------------------------------------------------------------
335. ğŸ“„ lib/features/settings/presentation/widgets/color_picker_tile.dart (805.0 B, 32 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/presentation/bloc/theme
------------------------------------------------------------
336. ğŸ“„ lib/features/settings/presentation/bloc/theme/theme_bloc.dart (1.1 KB, 39 Ø³Ø·Ø±)
337. ğŸ“„ lib/features/settings/presentation/bloc/theme/theme_event.dart (285.0 B, 13 Ø³Ø·Ø±)
338. ğŸ“„ lib/features/settings/presentation/bloc/theme/theme_state.dart (289.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/domain
------------------------------------------------------------
339. ğŸ“„ lib/features/settings/domain/chart_settings_lock_fix.dart (209.0 B, 10 Ø³Ø·Ø±)
340. ğŸ“„ lib/features/settings/domain/chart_style_settings.dart (134.0 B, 5 Ø³Ø·Ø±)
341. ğŸ“„ lib/features/settings/domain/trading_profile.dart (206.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/domain/theme
------------------------------------------------------------
342. ğŸ“„ lib/features/settings/domain/theme/app_theme.dart (1.6 KB, 58 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/domain/controllers
------------------------------------------------------------
343. ğŸ“„ lib/features/settings/domain/controllers/chart_settings_controller_fix.dart (1.0 KB, 36 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/data
------------------------------------------------------------
344. ğŸ“„ lib/features/settings/data/undo_redo_storage.dart (570.0 B, 15 Ø³Ø·Ø±)
345. ğŸ“„ lib/features/settings/data/chart_settings_storage.dart (524.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/settings/data/theme
------------------------------------------------------------
346. ğŸ“„ lib/features/settings/data/theme/theme_repository.dart (590.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/common/data/cache
------------------------------------------------------------
347. ğŸ“„ lib/features/common/data/cache/bloc_state_cache.dart (211.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/watchlist/domain
------------------------------------------------------------
348. ğŸ“„ lib/features/watchlist/domain/watchlist_clean_guard.dart (108.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/widgets
------------------------------------------------------------
349. ğŸ“„ lib/features/chart/presentation/widgets/chart_webview.dart (1.3 KB, 51 Ø³Ø·Ø±)
350. ğŸ“„ lib/features/chart/presentation/widgets/indicator_selector.dart (1.0 KB, 35 Ø³Ø·Ø±)
351. ğŸ“„ lib/features/chart/presentation/widgets/real_time_price_chart.dart (0.0 B, 0 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/widgets/chart_interactions
------------------------------------------------------------
352. ğŸ“„ lib/features/chart/presentation/widgets/chart_interactions/interaction_toolkit.dart (2.8 KB, 101 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/widgets/chart_draw_tools
------------------------------------------------------------
353. ğŸ“„ lib/features/chart/presentation/widgets/chart_draw_tools/drawing_tools_painter.dart (543.0 B, 23 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/widgets/chart_indicators
------------------------------------------------------------
354. ğŸ“„ lib/features/chart/presentation/widgets/chart_indicators/indicator_painter.dart (1.4 KB, 48 Ø³Ø·Ø±)
355. ğŸ“„ lib/features/chart/presentation/widgets/chart_indicators/ema_indicator_painter.dart (656.0 B, 26 Ø³Ø·Ø±)
356. ğŸ“„ lib/features/chart/presentation/widgets/chart_indicators/integrated_indicators.dart (5.2 KB, 214 Ø³Ø·Ø±)
357. ğŸ“„ lib/features/chart/presentation/widgets/chart_indicators/ema_indicator.dart (849.0 B, 28 Ø³Ø·Ø±)
358. ğŸ“„ lib/features/chart/presentation/widgets/chart_indicators/rsi_subchart.dart (1008.0 B, 40 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/widgets/chart_core
------------------------------------------------------------
359. ğŸ“„ lib/features/chart/presentation/widgets/chart_core/chart_gesture_detector.dart (1.0 KB, 41 Ø³Ø·Ø±)
360. ğŸ“„ lib/features/chart/presentation/widgets/chart_core/candlestick_chart_canvas.dart (1.9 KB, 78 Ø³Ø·Ø±)
361. ğŸ“„ lib/features/chart/presentation/widgets/chart_core/crosshair_overlay.dart (964.0 B, 48 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/pages
------------------------------------------------------------
362. ğŸ“„ lib/features/chart/presentation/pages/chart_page.dart (1.5 KB, 52 Ø³Ø·Ø±)
363. ğŸ“„ lib/features/chart/presentation/pages/interactive_chart_page.dart (2.5 KB, 78 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/bloc
------------------------------------------------------------
364. ğŸ“„ lib/features/chart/presentation/bloc/chart_bloc_with_subscription_fix.dart (664.0 B, 25 Ø³Ø·Ø±)
365. ğŸ“„ lib/features/chart/presentation/bloc/candles_event.dart (187.0 B, 8 Ø³Ø·Ø±)
366. ğŸ“„ lib/features/chart/presentation/bloc/candles_bloc.dart (394.0 B, 13 Ø³Ø·Ø±)
367. ğŸ“„ lib/features/chart/presentation/bloc/candles_state.dart (401.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/bloc/live_chart
------------------------------------------------------------
368. ğŸ“„ lib/features/chart/presentation/bloc/live_chart/live_chart_state.dart (409.0 B, 17 Ø³Ø·Ø±)
369. ğŸ“„ lib/features/chart/presentation/bloc/live_chart/live_chart_bloc.dart (1.0 KB, 39 Ø³Ø·Ø±)
370. ğŸ“„ lib/features/chart/presentation/bloc/live_chart/live_chart_event.dart (245.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/presentation/bloc/indicators
------------------------------------------------------------
371. ğŸ“„ lib/features/chart/presentation/bloc/indicators/indicators_event.dart (145.0 B, 7 Ø³Ø·Ø±)
372. ğŸ“„ lib/features/chart/presentation/bloc/indicators/indicators_state.dart (213.0 B, 8 Ø³Ø·Ø±)
373. ğŸ“„ lib/features/chart/presentation/bloc/indicators/indicators_bloc.dart (630.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/data
------------------------------------------------------------
374. ğŸ“„ lib/features/chart/data/orientation_state_fix.dart (536.0 B, 17 Ø³Ø·Ø±)
375. ğŸ“„ lib/features/chart/data/view_state_storage.dart (526.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/data/storage
------------------------------------------------------------
376. ğŸ“„ lib/features/chart/data/storage/chart_view_state_storage.dart (534.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/data/sync
------------------------------------------------------------
377. ğŸ“„ lib/features/chart/data/sync/history_stream_sync_manager.dart (1.1 KB, 45 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/domain
------------------------------------------------------------
378. ğŸ“„ lib/features/chart/domain/chart_zones_repository.dart (404.0 B, 13 Ø³Ø·Ø±)
379. ğŸ“„ lib/features/chart/domain/touch_event_filter.dart (164.0 B, 7 Ø³Ø·Ø±)
380. ğŸ“„ lib/features/chart/domain/touch_mode_guard.dart (92.0 B, 5 Ø³Ø·Ø±)
381. ğŸ“„ lib/features/chart/domain/draw_mode_flag.dart (151.0 B, 6 Ø³Ø·Ø±)
382. ğŸ“„ lib/features/chart/domain/drawing_storage.dart (433.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/domain/drawing
------------------------------------------------------------
383. ğŸ“„ lib/features/chart/domain/drawing/trendline_mapping_fix.dart (610.0 B, 22 Ø³Ø·Ø±)
384. ğŸ“„ lib/features/chart/domain/drawing/draw_tool_mapping_fix.dart (1.1 KB, 31 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/domain/tools
------------------------------------------------------------
385. ğŸ“„ lib/features/chart/domain/tools/drawing_tool_sync.dart (555.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/domain/usecases
------------------------------------------------------------
386. ğŸ“„ lib/features/chart/domain/usecases/load_historical_candles.dart (471.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/chart/domain/indicators
------------------------------------------------------------
387. ğŸ“„ lib/features/chart/domain/indicators/macd_indicator.dart (868.0 B, 32 Ø³Ø·Ø±)
388. ğŸ“„ lib/features/chart/domain/indicators/ema_indicator.dart (604.0 B, 23 Ø³Ø·Ø±)
389. ğŸ“„ lib/features/chart/domain/indicators/rsi_indicator.dart (1.1 KB, 38 Ø³Ø·Ø±)
390. ğŸ“„ lib/features/chart/domain/indicators/indicator_manager.dart (454.0 B, 20 Ø³Ø·Ø±)
391. ğŸ“„ lib/features/chart/domain/indicators/indicator_base.dart (239.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/presentation/widgets
------------------------------------------------------------
392. ğŸ“„ lib/features/replay/presentation/widgets/replay_controls.dart (586.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/presentation/bloc
------------------------------------------------------------
393. ğŸ“„ lib/features/replay/presentation/bloc/replay_bloc_fix.dart (590.0 B, 24 Ø³Ø·Ø±)
394. ğŸ“„ lib/features/replay/presentation/bloc/replay_state.dart (246.0 B, 7 Ø³Ø·Ø±)
395. ğŸ“„ lib/features/replay/presentation/bloc/replay_bloc.dart (785.0 B, 26 Ø³Ø·Ø±)
396. ğŸ“„ lib/features/replay/presentation/bloc/replay_event.dart (333.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/presentation/pages
------------------------------------------------------------
397. ğŸ“„ lib/features/replay/presentation/pages/replay_page.dart (2.6 KB, 64 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/domain
------------------------------------------------------------
398. ğŸ“„ lib/features/replay/domain/replay_volume_fix.dart (175.0 B, 9 Ø³Ø·Ø±)
399. ğŸ“„ lib/features/replay/domain/replay_execution_lock.dart (192.0 B, 10 Ø³Ø·Ø±)
400. ğŸ“„ lib/features/replay/domain/replay_engine_reset_fix.dart (80.0 B, 5 Ø³Ø·Ø±)
401. ğŸ“„ lib/features/replay/domain/replay_strategy_sync_fix.dart (123.0 B, 6 Ø³Ø·Ø±)
402. ğŸ“„ lib/features/replay/domain/replay_engine_cleanup_fix.dart (136.0 B, 9 Ø³Ø·Ø±)
403. ğŸ“„ lib/features/replay/domain/replay_scheduler_fix.dart (253.0 B, 15 Ø³Ø·Ø±)
404. ğŸ“„ lib/features/replay/domain/replay_scheduler.dart (282.0 B, 15 Ø³Ø·Ø±)
405. ğŸ“„ lib/features/replay/domain/replay_engine2.dart (882.0 B, 31 Ø³Ø·Ø±)
406. ğŸ“„ lib/features/replay/domain/replay_engine.dart (798.0 B, 34 Ø³Ø·Ø±)
407. ğŸ“„ lib/features/replay/domain/replay_state.dart (67.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/domain/entities
------------------------------------------------------------
408. ğŸ“„ lib/features/replay/domain/entities/replay_event.dart (299.0 B, 9 Ø³Ø·Ø±)
409. ğŸ“„ lib/features/replay/domain/entities/speed.dart (353.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/domain/controller
------------------------------------------------------------
410. ğŸ“„ lib/features/replay/domain/controller/replay_controller.dart (527.0 B, 26 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/domain/engine
------------------------------------------------------------
411. ğŸ“„ lib/features/replay/domain/engine/replay_engine.dart (972.0 B, 47 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/replay/data/datasources
------------------------------------------------------------
412. ğŸ“„ lib/features/replay/data/datasources/replay_data_source.dart (630.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/alerts/domain
------------------------------------------------------------
413. ğŸ“„ lib/features/alerts/domain/alert_condition.dart (335.0 B, 13 Ø³Ø·Ø±)
414. ğŸ“„ lib/features/alerts/domain/alert_engine.dart (1.1 KB, 41 Ø³Ø·Ø±)
415. ğŸ“„ lib/features/alerts/domain/alert_rate_limit_fix.dart (283.0 B, 13 Ø³Ø·Ø±)
416. ğŸ“„ lib/features/alerts/domain/alert_rate_manager.dart (289.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/alerts/presentation
------------------------------------------------------------
417. ğŸ“„ lib/features/alerts/presentation/alert_log_screen.dart (793.0 B, 31 Ø³Ø·Ø±)
418. ğŸ“„ lib/features/alerts/presentation/alert_notifier.dart (285.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/alerts/presentation/bloc
------------------------------------------------------------
419. ğŸ“„ lib/features/alerts/presentation/bloc/alert_bloc_cleanup.dart (302.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/alerts/data
------------------------------------------------------------
420. ğŸ“„ lib/features/alerts/data/alert_preferences.dart (516.0 B, 15 Ø³Ø·Ø±)
421. ğŸ“„ lib/features/alerts/data/alert_log_repository.dart (385.0 B, 13 Ø³Ø·Ø±)
422. ğŸ“„ lib/features/alerts/data/alert_persistence_fix.dart (497.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/domain
------------------------------------------------------------
423. ğŸ“„ lib/features/backtest/domain/backtest_network_bounce_guard.dart (299.0 B, 11 Ø³Ø·Ø±)
424. ğŸ“„ lib/features/backtest/domain/signal_eval_buffer_fix.dart (216.0 B, 10 Ø³Ø·Ø±)
425. ğŸ“„ lib/features/backtest/domain/backtest_equity_update_fix.dart (242.0 B, 7 Ø³Ø·Ø±)
426. ğŸ“„ lib/features/backtest/domain/backtest_sync_signals_fix.dart (105.0 B, 6 Ø³Ø·Ø±)
427. ğŸ“„ lib/features/backtest/domain/backtest_cancel_guard.dart (123.0 B, 6 Ø³Ø·Ø±)
428. ğŸ“„ lib/features/backtest/domain/backtest_controller.dart (163.0 B, 11 Ø³Ø·Ø±)
429. ğŸ“„ lib/features/backtest/domain/backtest_cancel_token.dart (133.0 B, 5 Ø³Ø·Ø±)
430. ğŸ“„ lib/features/backtest/domain/backtest_engine2.dart (703.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/domain/check
------------------------------------------------------------
431. ğŸ“„ lib/features/backtest/domain/check/preflight_check.dart (284.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/domain/engine
------------------------------------------------------------
432. ğŸ“„ lib/features/backtest/domain/engine/backtest_engine_fix.dart (777.0 B, 36 Ø³Ø·Ø±)
433. ğŸ“„ lib/features/backtest/domain/engine/backtest_completion_guard.dart (154.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/domain/cancel
------------------------------------------------------------
434. ğŸ“„ lib/features/backtest/domain/cancel/backtest_cancel_guard2.dart (135.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/domain/strategy
------------------------------------------------------------
435. ğŸ“„ lib/features/backtest/domain/strategy/strategy_freeze_guard.dart (161.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/presentation/bloc
------------------------------------------------------------
436. ğŸ“„ lib/features/backtest/presentation/bloc/backtest_control_fix.dart (233.0 B, 12 Ø³Ø·Ø±)
437. ğŸ“„ lib/features/backtest/presentation/bloc/backtest_mode_guard_fix.dart (504.0 B, 19 Ø³Ø·Ø±)
438. ğŸ“„ lib/features/backtest/presentation/bloc/backtest_bloc.dart (590.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/backtest/presentation/pages
------------------------------------------------------------
439. ğŸ“„ lib/features/backtest/presentation/pages/backtest_page.dart (292.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/tape/domain
------------------------------------------------------------
440. ğŸ“„ lib/features/tape/domain/tape_event.dart (182.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/tape/presentation/widgets
------------------------------------------------------------
441. ğŸ“„ lib/features/tape/presentation/widgets/tape_view.dart (484.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_builder/presentation/canvas
------------------------------------------------------------
442. ğŸ“„ lib/features/strategy_builder/presentation/canvas/strategy_canvas.dart (1.4 KB, 50 Ø³Ø·Ø±)
443. ğŸ“„ lib/features/strategy_builder/presentation/canvas/connection_painter.dart (820.0 B, 32 Ø³Ø·Ø±)
444. ğŸ“„ lib/features/strategy_builder/presentation/canvas/node_widget.dart (1.6 KB, 62 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_builder/presentation/widgets
------------------------------------------------------------
445. ğŸ“„ lib/features/strategy_builder/presentation/widgets/block_palette.dart (1.5 KB, 52 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_builder/domain/entities
------------------------------------------------------------
446. ğŸ“„ lib/features/strategy_builder/domain/entities/block.dart (274.0 B, 9 Ø³Ø·Ø±)
447. ğŸ“„ lib/features/strategy_builder/domain/entities/block_type.dart (184.0 B, 17 Ø³Ø·Ø±)
448. ğŸ“„ lib/features/strategy_builder/domain/entities/connection.dart (144.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_builder/domain/models
------------------------------------------------------------
449. ğŸ“„ lib/features/strategy_builder/domain/models/strategy_graph.dart (1.2 KB, 40 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_builder/domain/interpreter
------------------------------------------------------------
450. ğŸ“„ lib/features/strategy_builder/domain/interpreter/strategy_interpreter.dart (1.7 KB, 62 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_builder/data
------------------------------------------------------------
451. ğŸ“„ lib/features/strategy_builder/data/strategy_storage.dart (600.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/account/domain
------------------------------------------------------------
452. ğŸ“„ lib/features/account/domain/account_model.dart (754.0 B, 30 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/presentation/pages
------------------------------------------------------------
453. ğŸ“„ lib/features/trading/presentation/pages/trading_page.dart (303.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/presentation/widgets
------------------------------------------------------------
454. ğŸ“„ lib/features/trading/presentation/widgets/trade_action_button.dart (509.0 B, 20 Ø³Ø·Ø±)
455. ğŸ“„ lib/features/trading/presentation/widgets/stop_take_input.dart (724.0 B, 28 Ø³Ø·Ø±)
456. ğŸ“„ lib/features/trading/presentation/widgets/signals_panel.dart (369.0 B, 15 Ø³Ø·Ø±)
457. ğŸ“„ lib/features/trading/presentation/widgets/market_order_dialog.dart (1.3 KB, 45 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/presentation/bloc
------------------------------------------------------------
458. ğŸ“„ lib/features/trading/presentation/bloc/orders_update_guard.dart (304.0 B, 10 Ø³Ø·Ø±)
459. ğŸ“„ lib/features/trading/presentation/bloc/trading_extension.dart (233.0 B, 7 Ø³Ø·Ø±)
460. ğŸ“„ lib/features/trading/presentation/bloc/trading_event.dart (540.0 B, 29 Ø³Ø·Ø±)
461. ğŸ“„ lib/features/trading/presentation/bloc/trading_bloc.dart (921.0 B, 29 Ø³Ø·Ø±)
462. ğŸ“„ lib/features/trading/presentation/bloc/trading_state.dart (245.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain
------------------------------------------------------------
463. ğŸ“„ lib/features/trading/domain/order_submit_guard.dart (100.0 B, 3 Ø³Ø·Ø±)
464. ğŸ“„ lib/features/trading/domain/slipped_execution.dart (214.0 B, 11 Ø³Ø·Ø±)
465. ğŸ“„ lib/features/trading/domain/lot_manager.dart (188.0 B, 10 Ø³Ø·Ø±)
466. ğŸ“„ lib/features/trading/domain/slippage_model.dart (207.0 B, 10 Ø³Ø·Ø±)
467. ğŸ“„ lib/features/trading/domain/execution_engine.dart (282.0 B, 13 Ø³Ø·Ø±)
468. ğŸ“„ lib/features/trading/domain/order_safe_guard.dart (226.0 B, 10 Ø³Ø·Ø±)
469. ğŸ“„ lib/features/trading/domain/sl_tp_settings.dart (154.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/hedging
------------------------------------------------------------
470. ğŸ“„ lib/features/trading/domain/hedging/hedge_manager.dart (122.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/usecases
------------------------------------------------------------
471. ğŸ“„ lib/features/trading/domain/usecases/place_order_usecase.dart (230.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/interface
------------------------------------------------------------
472. ğŸ“„ lib/features/trading/domain/interface/trading_engine.dart (170.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/history
------------------------------------------------------------
473. ğŸ“„ lib/features/trading/domain/history/trade_history.dart (161.0 B, 7 Ø³Ø·Ø±)
474. ğŸ“„ lib/features/trading/domain/history/trade_history_fix.dart (250.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/models
------------------------------------------------------------
475. ğŸ“„ lib/features/trading/domain/models/order.dart (1.0 KB, 47 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/errors
------------------------------------------------------------
476. ğŸ“„ lib/features/trading/domain/errors/execution_error.dart (240.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/simulation
------------------------------------------------------------
477. ğŸ“„ lib/features/trading/domain/simulation/sim_order_ring_buffer.dart (345.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/risk
------------------------------------------------------------
478. ğŸ“„ lib/features/trading/domain/risk/position_sizing.dart (260.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/execution
------------------------------------------------------------
479. ğŸ“„ lib/features/trading/domain/execution/execution_snapshot_guard.dart (318.0 B, 14 Ø³Ø·Ø±)
480. ğŸ“„ lib/features/trading/domain/execution/execution_queue.dart (297.0 B, 13 Ø³Ø·Ø±)
481. ğŸ“„ lib/features/trading/domain/execution/slippage_guard.dart (253.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/audit
------------------------------------------------------------
482. ğŸ“„ lib/features/trading/domain/audit/reject_logger.dart (194.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/domain/order
------------------------------------------------------------
483. ğŸ“„ lib/features/trading/domain/order/order.dart (720.0 B, 30 Ø³Ø·Ø±)
484. ğŸ“„ lib/features/trading/domain/order/partial_execution_engine.dart (296.0 B, 14 Ø³Ø·Ø±)
485. ğŸ“„ lib/features/trading/domain/order/retriable_execution_engine.dart (752.0 B, 27 Ø³Ø·Ø±)
486. ğŸ“„ lib/features/trading/domain/order/oco_execution_engine.dart (133.0 B, 7 Ø³Ø·Ø±)
487. ğŸ“„ lib/features/trading/domain/order/oco_order.dart (126.0 B, 6 Ø³Ø·Ø±)
488. ğŸ“„ lib/features/trading/domain/order/advanced_order.dart (385.0 B, 19 Ø³Ø·Ø±)
489. ğŸ“„ lib/features/trading/domain/order/fee_model.dart (219.0 B, 9 Ø³Ø·Ø±)
490. ğŸ“„ lib/features/trading/domain/order/execution_with_fees.dart (263.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/data
------------------------------------------------------------
491. ğŸ“„ lib/features/trading/data/sl_tp_storage_fix.dart (709.0 B, 23 Ø³Ø·Ø±)
492. ğŸ“„ lib/features/trading/data/oanda_trade_client.dart (1.7 KB, 61 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/data/exchanges/crypto
------------------------------------------------------------
493. ğŸ“„ lib/features/trading/data/exchanges/crypto/crypto_api.dart (278.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/trading/data/exchanges/stock
------------------------------------------------------------
494. ğŸ“„ lib/features/trading/data/exchanges/stock/stock_api.dart (276.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data
------------------------------------------------------------
495. ğŸ“„ lib/features/market/data/candle_normalizer.dart (790.0 B, 31 Ø³Ø·Ø±)
496. ğŸ“„ lib/features/market/data/tick_aggregator.dart (1.6 KB, 61 Ø³Ø·Ø±)
497. ğŸ“„ lib/features/market/data/oanda_market_repository.dart (640.0 B, 21 Ø³Ø·Ø±)
498. ğŸ“„ lib/features/market/data/market_repository.dart (1.4 KB, 45 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/stream
------------------------------------------------------------
499. ğŸ“„ lib/features/market/data/stream/live_stream_adapter.dart (1.4 KB, 51 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/stream/repositories
------------------------------------------------------------
500. ğŸ“„ lib/features/market/data/stream/repositories/oanda_stream_repository.dart (693.0 B, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/stream/mappers
------------------------------------------------------------
501. ğŸ“„ lib/features/market/data/stream/mappers/ws_tick_mapper.dart (599.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/stream/dtos
------------------------------------------------------------
502. ğŸ“„ lib/features/market/data/stream/dtos/ws_tick_dto.dart (471.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/repositories
------------------------------------------------------------
503. ğŸ“„ lib/features/market/data/repositories/oanda_market_repository.dart (1.3 KB, 40 Ø³Ø·Ø±)
504. ğŸ“„ lib/features/market/data/repositories/market_repository_impl.dart (4.4 KB, 152 Ø³Ø·Ø±)
505. ğŸ“„ lib/features/market/data/repositories/market_repository.dart (211.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/repositories/audit
------------------------------------------------------------
506. ğŸ“„ lib/features/market/data/repositories/audit/audit_repository.dart (576.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/datasources
------------------------------------------------------------
507. ğŸ“„ lib/features/market/data/datasources/timeframe_storage.dart (407.0 B, 15 Ø³Ø·Ø±)
508. ğŸ“„ lib/features/market/data/datasources/oanda_ws_manager.dart (1.6 KB, 77 Ø³Ø·Ø±)
509. ğŸ“„ lib/features/market/data/datasources/candles_cache.dart (554.0 B, 18 Ø³Ø·Ø±)
510. ğŸ“„ lib/features/market/data/datasources/local_storage.dart (504.0 B, 21 Ø³Ø·Ø±)
511. ğŸ“„ lib/features/market/data/datasources/oanda_ws_client.dart (858.0 B, 37 Ø³Ø·Ø±)
512. ğŸ“„ lib/features/market/data/datasources/oanda_rest_client.dart (746.0 B, 34 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/cache
------------------------------------------------------------
513. ğŸ“„ lib/features/market/data/cache/history_cache_by_tf.dart (461.0 B, 17 Ø³Ø·Ø±)
514. ğŸ“„ lib/features/market/data/cache/candle_cache_cleaner.dart (314.0 B, 12 Ø³Ø·Ø±)
515. ğŸ“„ lib/features/market/data/cache/tick_buffer.dart (271.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/storage
------------------------------------------------------------
516. ğŸ“„ lib/features/market/data/storage/export_utils.dart (1.1 KB, 34 Ø³Ø·Ø±)
517. ğŸ“„ lib/features/market/data/storage/strategy_settings.dart (1.1 KB, 41 Ø³Ø·Ø±)
518. ğŸ“„ lib/features/market/data/storage/settings_storage.dart (473.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/models
------------------------------------------------------------
519. ğŸ“„ lib/features/market/data/models/tick_model.dart (732.0 B, 35 Ø³Ø·Ø±)
520. ğŸ“„ lib/features/market/data/models/candle_entity_mapper.dart (287.0 B, 15 Ø³Ø·Ø±)
521. ğŸ“„ lib/features/market/data/models/candle_model.dart (739.0 B, 38 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/models/position
------------------------------------------------------------
522. ğŸ“„ lib/features/market/data/models/position/position_model.dart (886.0 B, 28 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/streaming
------------------------------------------------------------
523. ğŸ“„ lib/features/market/data/streaming/tick_aggregator.dart (1.4 KB, 68 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/repository
------------------------------------------------------------
524. ğŸ“„ lib/features/market/data/repository/candle_repository_with_filter.dart (644.0 B, 21 Ø³Ø·Ø±)
525. ğŸ“„ lib/features/market/data/repository/timeframe_transition_fix.dart (255.0 B, 6 Ø³Ø·Ø±)
526. ğŸ“„ lib/features/market/data/repository/history_refresh_fix.dart (203.0 B, 5 Ø³Ø·Ø±)
527. ğŸ“„ lib/features/market/data/repository/market_repository_impl.dart (496.0 B, 16 Ø³Ø·Ø±)
528. ğŸ“„ lib/features/market/data/repository/boot_history_restore_fix.dart (351.0 B, 12 Ø³Ø·Ø±)
529. ğŸ“„ lib/features/market/data/repository/market_repository_error_fix.dart (379.0 B, 12 Ø³Ø·Ø±)
530. ğŸ“„ lib/features/market/data/repository/history_paging.dart (514.0 B, 20 Ø³Ø·Ø±)
531. ğŸ“„ lib/features/market/data/repository/instant_first_candle_fix.dart (303.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/trading
------------------------------------------------------------
532. ğŸ“„ lib/features/market/data/trading/virtual_exchange.dart (1.4 KB, 52 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/dtos
------------------------------------------------------------
533. ğŸ“„ lib/features/market/data/dtos/instrument_dto.dart (665.0 B, 26 Ø³Ø·Ø±)
534. ğŸ“„ lib/features/market/data/dtos/candle_dto.dart (869.0 B, 37 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/adapters
------------------------------------------------------------
535. ğŸ“„ lib/features/market/data/adapters/audit_log_adapter.dart (455.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/data/mappers
------------------------------------------------------------
536. ğŸ“„ lib/features/market/data/mappers/candle_mapper.dart (710.0 B, 25 Ø³Ø·Ø±)
537. ğŸ“„ lib/features/market/data/mappers/instrument_mapper.dart (362.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages
------------------------------------------------------------
538. ğŸ“„ lib/features/market/presentation/pages/interactive_chart_page.dart (2.5 KB, 89 Ø³Ø·Ø±)
539. ğŸ“„ lib/features/market/presentation/pages/oanda_settings_page.dart (2.8 KB, 93 Ø³Ø·Ø±)
540. ğŸ“„ lib/features/market/presentation/pages/market_chart_page.dart (223.0 B, 10 Ø³Ø·Ø±)
541. ğŸ“„ lib/features/market/presentation/pages/home_page.dart (1.8 KB, 54 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/alerts
------------------------------------------------------------
542. ğŸ“„ lib/features/market/presentation/pages/alerts/alerts_page.dart (3.8 KB, 120 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/positions
------------------------------------------------------------
543. ğŸ“„ lib/features/market/presentation/pages/positions/positions_page.dart (4.3 KB, 115 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/audit
------------------------------------------------------------
544. ğŸ“„ lib/features/market/presentation/pages/audit/audit_page.dart (1.5 KB, 45 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/backtest
------------------------------------------------------------
545. ğŸ“„ lib/features/market/presentation/pages/backtest/backtest_page.dart (2.5 KB, 73 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/strategy_comparison
------------------------------------------------------------
546. ğŸ“„ lib/features/market/presentation/pages/strategy_comparison/strategy_comparison_page.dart (2.0 KB, 62 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/analytics
------------------------------------------------------------
547. ğŸ“„ lib/features/market/presentation/pages/analytics/analytics_page.dart (1.6 KB, 46 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/pages/settings
------------------------------------------------------------
548. ğŸ“„ lib/features/market/presentation/pages/settings/strategy_settings_page.dart (4.5 KB, 108 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc
------------------------------------------------------------
549. ğŸ“„ lib/features/market/presentation/bloc/chart_bloc_sync_fix.dart (703.0 B, 28 Ø³Ø·Ø±)
550. ğŸ“„ lib/features/market/presentation/bloc/auto_fetch_bloc.dart (400.0 B, 14 Ø³Ø·Ø±)
551. ğŸ“„ lib/features/market/presentation/bloc/timeframe_loading_fix.dart (221.0 B, 10 Ø³Ø·Ø±)
552. ğŸ“„ lib/features/market/presentation/bloc/zoom_debounce_fix.dart (377.0 B, 14 Ø³Ø·Ø±)
553. ğŸ“„ lib/features/market/presentation/bloc/market_sync_bloc_fix.dart (378.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/analytics
------------------------------------------------------------
554. ğŸ“„ lib/features/market/presentation/bloc/analytics/analytics_event.dart (148.0 B, 6 Ø³Ø·Ø±)
555. ğŸ“„ lib/features/market/presentation/bloc/analytics/analytics_bloc.dart (633.0 B, 20 Ø³Ø·Ø±)
556. ğŸ“„ lib/features/market/presentation/bloc/analytics/analytics_state.dart (341.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/trading
------------------------------------------------------------
557. ğŸ“„ lib/features/market/presentation/bloc/trading/trading_event.dart (460.0 B, 23 Ø³Ø·Ø±)
558. ğŸ“„ lib/features/market/presentation/bloc/trading/trading_bloc.dart (1.7 KB, 56 Ø³Ø·Ø±)
559. ğŸ“„ lib/features/market/presentation/bloc/trading/trading_state.dart (533.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/strategy_comparison
------------------------------------------------------------
560. ğŸ“„ lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_event.dart (251.0 B, 9 Ø³Ø·Ø±)
561. ğŸ“„ lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_state.dart (369.0 B, 15 Ø³Ø·Ø±)
562. ğŸ“„ lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_bloc.dart (736.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/chart
------------------------------------------------------------
563. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_bloc.dart (1.6 KB, 60 Ø³Ø·Ø±)
564. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_state.dart (538.0 B, 25 Ø³Ø·Ø±)
565. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_event.dart (354.0 B, 15 Ø³Ø·Ø±)
566. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_bloc_order_fix.dart (247.0 B, 8 Ø³Ø·Ø±)
567. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_bloc_error_handling.dart (310.0 B, 12 Ø³Ø·Ø±)
568. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_state_reset.dart (314.0 B, 11 Ø³Ø·Ø±)
569. ğŸ“„ lib/features/market/presentation/bloc/chart/history_cache_fix.dart (275.0 B, 15 Ø³Ø·Ø±)
570. ğŸ“„ lib/features/market/presentation/bloc/chart/chart_bloc_fix.dart (410.0 B, 17 Ø³Ø·Ø±)
571. ğŸ“„ lib/features/market/presentation/bloc/chart/timeframe_stream_fix.dart (304.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/positions
------------------------------------------------------------
572. ğŸ“„ lib/features/market/presentation/bloc/positions/positions_event.dart (450.0 B, 19 Ø³Ø·Ø±)
573. ğŸ“„ lib/features/market/presentation/bloc/positions/positions_state.dart (350.0 B, 15 Ø³Ø·Ø±)
574. ğŸ“„ lib/features/market/presentation/bloc/positions/positions_bloc.dart (1.7 KB, 53 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/drawing_tools
------------------------------------------------------------
575. ğŸ“„ lib/features/market/presentation/bloc/drawing_tools/drawing_event.dart (439.0 B, 18 Ø³Ø·Ø±)
576. ğŸ“„ lib/features/market/presentation/bloc/drawing_tools/drawing_bloc.dart (1.3 KB, 50 Ø³Ø·Ø±)
577. ğŸ“„ lib/features/market/presentation/bloc/drawing_tools/drawing_state.dart (451.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/oanda
------------------------------------------------------------
578. ğŸ“„ lib/features/market/presentation/bloc/oanda/oanda_state.dart (339.0 B, 13 Ø³Ø·Ø±)
579. ğŸ“„ lib/features/market/presentation/bloc/oanda/oanda_event.dart (101.0 B, 4 Ø³Ø·Ø±)
580. ğŸ“„ lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart (376.0 B, 16 Ø³Ø·Ø±)
581. ğŸ“„ lib/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart (1.7 KB, 58 Ø³Ø·Ø±)
582. ğŸ“„ lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart (324.0 B, 15 Ø³Ø·Ø±)
583. ğŸ“„ lib/features/market/presentation/bloc/oanda/oanda_bloc.dart (542.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/settings
------------------------------------------------------------
584. ğŸ“„ lib/features/market/presentation/bloc/settings/settings_state.dart (394.0 B, 17 Ø³Ø·Ø±)
585. ğŸ“„ lib/features/market/presentation/bloc/settings/settings_bloc.dart (2.1 KB, 81 Ø³Ø·Ø±)
586. ğŸ“„ lib/features/market/presentation/bloc/settings/settings_event.dart (668.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/alerts
------------------------------------------------------------
587. ğŸ“„ lib/features/market/presentation/bloc/alerts/alert_state.dart (224.0 B, 10 Ø³Ø·Ø±)
588. ğŸ“„ lib/features/market/presentation/bloc/alerts/alert_bloc.dart (1.3 KB, 46 Ø³Ø·Ø±)
589. ğŸ“„ lib/features/market/presentation/bloc/alerts/alert_event.dart (392.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/audit
------------------------------------------------------------
590. ğŸ“„ lib/features/market/presentation/bloc/audit/audit_bloc.dart (816.0 B, 28 Ø³Ø·Ø±)
591. ğŸ“„ lib/features/market/presentation/bloc/audit/audit_state.dart (290.0 B, 15 Ø³Ø·Ø±)
592. ğŸ“„ lib/features/market/presentation/bloc/audit/audit_event.dart (116.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/market
------------------------------------------------------------
593. ğŸ“„ lib/features/market/presentation/bloc/market/market_effect.dart (281.0 B, 13 Ø³Ø·Ø±)
594. ğŸ“„ lib/features/market/presentation/bloc/market/market_bloc.dart (1.8 KB, 68 Ø³Ø·Ø±)
595. ğŸ“„ lib/features/market/presentation/bloc/market/market_state.dart (639.0 B, 29 Ø³Ø·Ø±)
596. ğŸ“„ lib/features/market/presentation/bloc/market/market_event.dart (298.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/ws
------------------------------------------------------------
597. ğŸ“„ lib/features/market/presentation/bloc/ws/ws_manager_bloc_fix.dart (506.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/backtest
------------------------------------------------------------
598. ğŸ“„ lib/features/market/presentation/bloc/backtest/backtest_state.dart (468.0 B, 19 Ø³Ø·Ø±)
599. ğŸ“„ lib/features/market/presentation/bloc/backtest/backtest_event.dart (463.0 B, 17 Ø³Ø·Ø±)
600. ğŸ“„ lib/features/market/presentation/bloc/backtest/backtest_bloc.dart (1.4 KB, 48 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/markets
------------------------------------------------------------
601. ğŸ“„ lib/features/market/presentation/bloc/markets/markets_state.dart (378.0 B, 17 Ø³Ø·Ø±)
602. ğŸ“„ lib/features/market/presentation/bloc/markets/markets_bloc.dart (1.6 KB, 64 Ø³Ø·Ø±)
603. ğŸ“„ lib/features/market/presentation/bloc/markets/markets_event.dart (114.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/stream
------------------------------------------------------------
604. ğŸ“„ lib/features/market/presentation/bloc/stream/stream_bloc.dart (1.3 KB, 56 Ø³Ø·Ø±)
605. ğŸ“„ lib/features/market/presentation/bloc/stream/stream_state.dart (350.0 B, 16 Ø³Ø·Ø±)
606. ğŸ“„ lib/features/market/presentation/bloc/stream/stream_event.dart (450.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/smart_alert
------------------------------------------------------------
607. ğŸ“„ lib/features/market/presentation/bloc/smart_alert/smart_alert_event.dart (413.0 B, 18 Ø³Ø·Ø±)
608. ğŸ“„ lib/features/market/presentation/bloc/smart_alert/smart_alert_bloc.dart (944.0 B, 28 Ø³Ø·Ø±)
609. ğŸ“„ lib/features/market/presentation/bloc/smart_alert/smart_alert_state.dart (191.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/bloc/trading_real
------------------------------------------------------------
610. ğŸ“„ lib/features/market/presentation/bloc/trading_real/trading_real_event.dart (207.0 B, 8 Ø³Ø·Ø±)
611. ğŸ“„ lib/features/market/presentation/bloc/trading_real/trading_real_bloc.dart (808.0 B, 26 Ø³Ø·Ø±)
612. ğŸ“„ lib/features/market/presentation/bloc/trading_real/trading_real_state.dart (381.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/screens
------------------------------------------------------------
613. ğŸ“„ lib/features/market/presentation/screens/market_info_screen.dart (458.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/widgets
------------------------------------------------------------
614. ğŸ“„ lib/features/market/presentation/widgets/timeframe_selector.dart (1.6 KB, 53 Ø³Ø·Ø±)
615. ğŸ“„ lib/features/market/presentation/widgets/crosshair_overlay.dart (585.0 B, 26 Ø³Ø·Ø±)
616. ğŸ“„ lib/features/market/presentation/widgets/smart_alert_dialog.dart (2.0 KB, 61 Ø³Ø·Ø±)
617. ğŸ“„ lib/features/market/presentation/widgets/trading_positions_widget.dart (922.0 B, 29 Ø³Ø·Ø±)
618. ğŸ“„ lib/features/market/presentation/widgets/webview_chart.dart (667.0 B, 26 Ø³Ø·Ø±)
619. ğŸ“„ lib/features/market/presentation/widgets/market_list_widget.dart (501.0 B, 21 Ø³Ø·Ø±)
620. ğŸ“„ lib/features/market/presentation/widgets/candlestick_chart_real.dart (583.0 B, 25 Ø³Ø·Ø±)
621. ğŸ“„ lib/features/market/presentation/widgets/signal_marker.dart (650.0 B, 31 Ø³Ø·Ø±)
622. ğŸ“„ lib/features/market/presentation/widgets/subchart_rsi_painter.dart (1.1 KB, 40 Ø³Ø·Ø±)
623. ğŸ“„ lib/features/market/presentation/widgets/overlay_indicators_painter.dart (1.4 KB, 51 Ø³Ø·Ø±)
624. ğŸ“„ lib/features/market/presentation/widgets/candles_painter.dart (1.6 KB, 48 Ø³Ø·Ø±)
625. ğŸ“„ lib/features/market/presentation/widgets/candlestick_chart.dart (847.0 B, 37 Ø³Ø·Ø±)
626. ğŸ“„ lib/features/market/presentation/widgets/instrument_list_widget.dart (1.7 KB, 60 Ø³Ø·Ø±)
627. ğŸ“„ lib/features/market/presentation/widgets/real_trade_dialog.dart (2.2 KB, 68 Ø³Ø·Ø±)
628. ğŸ“„ lib/features/market/presentation/widgets/price_alert_dialog.dart (2.0 KB, 69 Ø³Ø·Ø±)
629. ğŸ“„ lib/features/market/presentation/widgets/chart_screen_lifecycle_fix.dart (624.0 B, 26 Ø³Ø·Ø±)
630. ğŸ“„ lib/features/market/presentation/widgets/indicator_overlay.dart (891.0 B, 37 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/widgets/chart_utils
------------------------------------------------------------
631. ğŸ“„ lib/features/market/presentation/widgets/chart_utils/chart_mapper.dart (681.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/widgets/custom_chart
------------------------------------------------------------
632. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/drawing_painter.dart (978.0 B, 44 Ø³Ø·Ø±)
633. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/candles_painter.dart (1.9 KB, 67 Ø³Ø·Ø±)
634. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/custom_chart_widget.dart (1.8 KB, 59 Ø³Ø·Ø±)
635. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/indicator_painter.dart (588.0 B, 24 Ø³Ø·Ø±)
636. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/subchart_rsi_painter.dart (1.2 KB, 33 Ø³Ø·Ø±)
637. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/multi_indicator_chart.dart (1.3 KB, 48 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/widgets/custom_chart/utils
------------------------------------------------------------
638. ğŸ“„ lib/features/market/presentation/widgets/custom_chart/utils/chart_mapping.dart (563.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/widgets/backtest
------------------------------------------------------------
639. ğŸ“„ lib/features/market/presentation/widgets/backtest/backtest_report_widget.dart (599.0 B, 20 Ø³Ø·Ø±)
640. ğŸ“„ lib/features/market/presentation/widgets/backtest/equity_curve_widget.dart (639.0 B, 24 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/presentation/widgets/drawing_tools
------------------------------------------------------------
641. ğŸ“„ lib/features/market/presentation/widgets/drawing_tools/drawing_overlay.dart (1.4 KB, 65 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain
------------------------------------------------------------
642. ğŸ“„ lib/features/market/domain/candle_deduper.dart (313.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/strategy
------------------------------------------------------------
643. ğŸ“„ lib/features/market/domain/strategy/strategy_manager.dart (2.0 KB, 76 Ø³Ø·Ø±)
644. ğŸ“„ lib/features/market/domain/strategy/strategy_config.dart (528.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/strategy/multi
------------------------------------------------------------
645. ğŸ“„ lib/features/market/domain/strategy/multi/strategy_set.dart (297.0 B, 14 Ø³Ø·Ø±)
646. ğŸ“„ lib/features/market/domain/strategy/multi/multi_strategy_runner.dart (679.0 B, 26 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/entities
------------------------------------------------------------
647. ğŸ“„ lib/features/market/domain/entities/tick.dart (176.0 B, 11 Ø³Ø·Ø±)
648. ğŸ“„ lib/features/market/domain/entities/candle.dart (456.0 B, 23 Ø³Ø·Ø±)
649. ğŸ“„ lib/features/market/domain/entities/instrument.dart (449.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/timeframes
------------------------------------------------------------
650. ğŸ“„ lib/features/market/domain/timeframes/timeframe.dart (631.0 B, 34 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/analytics
------------------------------------------------------------
651. ğŸ“„ lib/features/market/domain/analytics/analytics_calculator.dart (29.0 B, 1 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/usecases
------------------------------------------------------------
652. ğŸ“„ lib/features/market/domain/usecases/evaluate_strategy.dart (89.0 B, 5 Ø³Ø·Ø±)
653. ğŸ“„ lib/features/market/domain/usecases/run_backtest.dart (521.0 B, 14 Ø³Ø·Ø±)
654. ğŸ“„ lib/features/market/domain/usecases/get_saved_credentials.dart (259.0 B, 11 Ø³Ø·Ø±)
655. ğŸ“„ lib/features/market/domain/usecases/save_oanda_credentials.dart (357.0 B, 17 Ø³Ø·Ø±)
656. ğŸ“„ lib/features/market/domain/usecases/get_historical_candles.dart (428.0 B, 17 Ø³Ø·Ø±)
657. ğŸ“„ lib/features/market/domain/usecases/stream_ticks.dart (273.0 B, 12 Ø³Ø·Ø±)
658. ğŸ“„ lib/features/market/domain/usecases/get_available_instruments.dart (266.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/streaming
------------------------------------------------------------
659. ğŸ“„ lib/features/market/domain/streaming/live_stream_adapter.dart (1.3 KB, 49 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/indicators
------------------------------------------------------------
660. ğŸ“„ lib/features/market/domain/indicators/stochastic_calculator.dart (1.7 KB, 78 Ø³Ø·Ø±)
661. ğŸ“„ lib/features/market/domain/indicators/bollinger_calculator.dart (1.1 KB, 38 Ø³Ø·Ø±)
662. ğŸ“„ lib/features/market/domain/indicators/macd_calculator.dart (1.5 KB, 44 Ø³Ø·Ø±)
663. ğŸ“„ lib/features/market/domain/indicators/rsi_calculator.dart (1.1 KB, 37 Ø³Ø·Ø±)
664. ğŸ“„ lib/features/market/domain/indicators/ema_calculator.dart (933.0 B, 35 Ø³Ø·Ø±)
665. ğŸ“„ lib/features/market/domain/indicators/indicator_series.dart (201.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/indicators/advanced
------------------------------------------------------------
666. ğŸ“„ lib/features/market/domain/indicators/advanced/macd_calculator.dart (1.4 KB, 58 Ø³Ø·Ø±)
667. ğŸ“„ lib/features/market/domain/indicators/advanced/rsi_calculator.dart (1.3 KB, 48 Ø³Ø·Ø±)
668. ğŸ“„ lib/features/market/domain/indicators/advanced/bollinger_calculator.dart (1.3 KB, 50 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/indicators/types
------------------------------------------------------------
669. ğŸ“„ lib/features/market/domain/indicators/types/indicator_series.dart (259.0 B, 13 Ø³Ø·Ø±)
670. ğŸ“„ lib/features/market/domain/indicators/types/indicator_type.dart (800.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/chart
------------------------------------------------------------
671. ğŸ“„ lib/features/market/domain/chart/x_axis_range.dart (193.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/repositories
------------------------------------------------------------
672. ğŸ“„ lib/features/market/domain/repositories/market_repository.dart (73.0 B, 3 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/repository
------------------------------------------------------------
673. ğŸ“„ lib/features/market/domain/repository/market_repository.dart (235.0 B, 6 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/stream
------------------------------------------------------------
674. ğŸ“„ lib/features/market/domain/stream/stream_repository.dart (226.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/audit
------------------------------------------------------------
675. ğŸ“„ lib/features/market/domain/audit/audit_log.dart (1003.0 B, 47 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/trading
------------------------------------------------------------
676. ğŸ“„ lib/features/market/domain/trading/trade_position.dart (486.0 B, 23 Ø³Ø·Ø±)
677. ğŸ“„ lib/features/market/domain/trading/strategy_manager.dart (1.6 KB, 58 Ø³Ø·Ø±)
678. ğŸ“„ lib/features/market/domain/trading/trade_result.dart (318.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/trading/orders
------------------------------------------------------------
679. ğŸ“„ lib/features/market/domain/trading/orders/order_request.dart (689.0 B, 27 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/alerts
------------------------------------------------------------
680. ğŸ“„ lib/features/market/domain/alerts/price_alert.dart (198.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/alerts/smart
------------------------------------------------------------
681. ğŸ“„ lib/features/market/domain/alerts/smart/smart_alert.dart (495.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/alerts/smart/engine
------------------------------------------------------------
682. ğŸ“„ lib/features/market/domain/alerts/smart/engine/smart_alert_engine.dart (2.0 KB, 66 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/models
------------------------------------------------------------
683. ğŸ“„ lib/features/market/domain/models/instrument.dart (815.0 B, 29 Ø³Ø·Ø±)
684. ğŸ“„ lib/features/market/domain/models/tick.dart (1.2 KB, 51 Ø³Ø·Ø±)
685. ğŸ“„ lib/features/market/domain/models/candle.dart (2.2 KB, 95 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/backtest
------------------------------------------------------------
686. ğŸ“„ lib/features/market/domain/backtest/backtest_engine.dart (48.0 B, 2 Ø³Ø·Ø±)
687. ğŸ“„ lib/features/market/domain/backtest/backtest_models.dart (767.0 B, 40 Ø³Ø·Ø±)
688. ğŸ“„ lib/features/market/domain/backtest/backtest_result.dart (451.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/sync
------------------------------------------------------------
689. ğŸ“„ lib/features/market/domain/sync/market_sync_coordinator.dart (729.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/market/domain/aggregator
------------------------------------------------------------
690. ğŸ“„ lib/features/market/domain/aggregator/candle_aggregator.dart (2.5 KB, 96 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/dashboard/presentation
------------------------------------------------------------
691. ğŸ“„ lib/features/dashboard/presentation/dashboard_screen.dart (363.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/alert/presentation/bloc
------------------------------------------------------------
692. ğŸ“„ lib/features/alert/presentation/bloc/smart_alert_bloc.dart (1.1 KB, 39 Ø³Ø·Ø±)
693. ğŸ“„ lib/features/alert/presentation/bloc/smart_alert_state.dart (375.0 B, 17 Ø³Ø·Ø±)
694. ğŸ“„ lib/features/alert/presentation/bloc/smart_alert_event.dart (427.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/home/presentation/pages
------------------------------------------------------------
695. ğŸ“„ lib/features/home/presentation/pages/home_page.dart (213.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_script/domain
------------------------------------------------------------
696. ğŸ“„ lib/features/strategy_script/domain/ast.dart (768.0 B, 37 Ø³Ø·Ø±)
697. ğŸ“„ lib/features/strategy_script/domain/token.dart (238.0 B, 18 Ø³Ø·Ø±)
698. ğŸ“„ lib/features/strategy_script/domain/tokenizer.dart (1.6 KB, 66 Ø³Ø·Ø±)
699. ğŸ“„ lib/features/strategy_script/domain/interpreter.dart (1.0 KB, 36 Ø³Ø·Ø±)
700. ğŸ“„ lib/features/strategy_script/domain/parser.dart (1.4 KB, 64 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_script/presentation/pages
------------------------------------------------------------
701. ğŸ“„ lib/features/strategy_script/presentation/pages/script_editor_page.dart (1.2 KB, 45 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/strategy_script/data
------------------------------------------------------------
702. ğŸ“„ lib/features/strategy_script/data/script_storage.dart (402.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/analytics/domain
------------------------------------------------------------
703. ğŸ“„ lib/features/analytics/domain/risk_analyzer.dart (338.0 B, 15 Ø³Ø·Ø±)
704. ğŸ“„ lib/features/analytics/domain/liquidity_analyzer.dart (333.0 B, 15 Ø³Ø·Ø±)
705. ğŸ“„ lib/features/analytics/domain/strategy_comparer.dart (304.0 B, 13 Ø³Ø·Ø±)
706. ğŸ“„ lib/features/analytics/domain/trade_statistics.dart (661.0 B, 27 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/domain
------------------------------------------------------------
707. ğŸ“„ lib/features/indicators/domain/ema_calculator.dart (405.0 B, 22 Ø³Ø·Ø±)
708. ğŸ“„ lib/features/indicators/domain/rsi_calculator.dart (811.0 B, 36 Ø³Ø·Ø±)
709. ğŸ“„ lib/features/indicators/domain/compute_lock.dart (239.0 B, 13 Ø³Ø·Ø±)
710. ğŸ“„ lib/features/indicators/domain/visible_synchronizer_fix.dart (274.0 B, 9 Ø³Ø·Ø±)
711. ğŸ“„ lib/features/indicators/domain/indicator_cache_cleanup.dart (109.0 B, 5 Ø³Ø·Ø±)
712. ğŸ“„ lib/features/indicators/domain/sync_aligner.dart (157.0 B, 7 Ø³Ø·Ø±)
713. ğŸ“„ lib/features/indicators/domain/live_indicator_updater.dart (697.0 B, 22 Ø³Ø·Ø±)
714. ğŸ“„ lib/features/indicators/domain/visible_range_engine.dart (291.0 B, 11 Ø³Ø·Ø±)
715. ğŸ“„ lib/features/indicators/domain/indicator_queue_fix.dart (215.0 B, 14 Ø³Ø·Ø±)
716. ğŸ“„ lib/features/indicators/domain/indicator_engine_compute_fix.dart (487.0 B, 16 Ø³Ø·Ø±)
717. ğŸ“„ lib/features/indicators/domain/indicator_update_lock.dart (218.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/domain/gap
------------------------------------------------------------
718. ğŸ“„ lib/features/indicators/domain/gap/gap_aware_indicator.dart (996.0 B, 32 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/data/cache
------------------------------------------------------------
719. ğŸ“„ lib/features/indicators/data/cache/indicator_results_cache_fix.dart (245.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/plugins
------------------------------------------------------------
720. ğŸ“„ lib/features/indicators/plugins/ema_plugin.dart (575.0 B, 23 Ø³Ø·Ø±)
721. ğŸ“„ lib/features/indicators/plugins/vwap_plugin_fix.dart (308.0 B, 10 Ø³Ø·Ø±)
722. ğŸ“„ lib/features/indicators/plugins/rsi_plugin_fix.dart (137.0 B, 6 Ø³Ø·Ø±)
723. ğŸ“„ lib/features/indicators/plugins/vwap_plugin.dart (499.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/presentation
------------------------------------------------------------
724. ğŸ“„ lib/features/indicators/presentation/indicator_selector.dart (531.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/presentation/bloc
------------------------------------------------------------
725. ğŸ“„ lib/features/indicators/presentation/bloc/indicators_event.dart (318.0 B, 15 Ø³Ø·Ø±)
726. ğŸ“„ lib/features/indicators/presentation/bloc/indicators_bloc.dart (546.0 B, 21 Ø³Ø·Ø±)
727. ğŸ“„ lib/features/indicators/presentation/bloc/indicators_state.dart (420.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/engine
------------------------------------------------------------
728. ğŸ“„ lib/features/indicators/engine/zoom_sensitive_engine.dart (415.0 B, 12 Ø³Ø·Ø±)
729. ğŸ“„ lib/features/indicators/engine/plugin_manager_cleanup_fix.dart (350.0 B, 16 Ø³Ø·Ø±)
730. ğŸ“„ lib/features/indicators/engine/indicator_engine.dart (458.0 B, 19 Ø³Ø·Ø±)
731. ğŸ“„ lib/features/indicators/engine/plugin_manager_fix.dart (318.0 B, 13 Ø³Ø·Ø±)
732. ğŸ“„ lib/features/indicators/engine/zoom_sensitive_engine_fix.dart (461.0 B, 15 Ø³Ø·Ø±)
733. ğŸ“„ lib/features/indicators/engine/windowed_engine.dart (477.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/indicators/render
------------------------------------------------------------
734. ğŸ“„ lib/features/indicators/render/batch_indicator_renderer.dart (200.0 B, 9 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/portrait/presentation/pages
------------------------------------------------------------
735. ğŸ“„ lib/features/portrait/presentation/pages/alerts_portrait_page.dart (903.0 B, 27 Ø³Ø·Ø±)
736. ğŸ“„ lib/features/portrait/presentation/pages/indicators_portrait_page.dart (1018.0 B, 29 Ø³Ø·Ø±)
737. ğŸ“„ lib/features/portrait/presentation/pages/portrait_home_page.dart (1.2 KB, 42 Ø³Ø·Ø±)
738. ğŸ“„ lib/features/portrait/presentation/pages/orders_portrait_page.dart (896.0 B, 26 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/portrait/presentation/widgets
------------------------------------------------------------
739. ğŸ“„ lib/features/portrait/presentation/widgets/portrait_tabs.dart (756.0 B, 23 Ø³Ø·Ø±)
740. ğŸ“„ lib/features/portrait/presentation/widgets/portrait_floating_controls.dart (1.3 KB, 47 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/stream/presentation/bloc
------------------------------------------------------------
741. ğŸ“„ lib/features/stream/presentation/bloc/price_stream_bloc.dart (949.0 B, 36 Ø³Ø·Ø±)
742. ğŸ“„ lib/features/stream/presentation/bloc/price_stream_event.dart (427.0 B, 17 Ø³Ø·Ø±)
743. ğŸ“„ lib/features/stream/presentation/bloc/price_stream_state.dart (499.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/features/stream/data
------------------------------------------------------------
744. ğŸ“„ lib/features/stream/data/price_stream.dart (193.0 B, 10 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/market/data/repositories
------------------------------------------------------------
745. ğŸ“„ lib/market/data/repositories/market_repository.dart (1.2 KB, 42 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/flavors
------------------------------------------------------------
746. ğŸ“„ lib/flavors/flavors.dart (35.0 B, 1 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/repositories/market
------------------------------------------------------------
747. ğŸ“„ lib/repositories/market/market_repository.dart (2.4 KB, 85 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: lib/ui/pages
------------------------------------------------------------
748. ğŸ“„ lib/ui/pages/live_chart_page.dart (2.4 KB, 73 Ø³Ø·Ø±)
749. ğŸ“„ lib/ui/pages/backtest_result_page.dart (2.2 KB, 71 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test
------------------------------------------------------------
750. ğŸ“„ test/widget_test.dart (1.0 KB, 30 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/network/ws
------------------------------------------------------------
751. ğŸ“„ test/network/ws/ws_pipeline_test.dart (432.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/sync
------------------------------------------------------------
752. ğŸ“„ test/sync/sync_manager_test.dart (824.0 B, 27 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/storage/script
------------------------------------------------------------
753. ğŸ“„ test/storage/script/script_storage_test.dart (662.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/storage/theme
------------------------------------------------------------
754. ğŸ“„ test/storage/theme/theme_storage_test.dart (989.0 B, 30 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/storage/indicator
------------------------------------------------------------
755. ğŸ“„ test/storage/indicator/indicator_storage_test.dart (707.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/storage/audit
------------------------------------------------------------
756. ğŸ“„ test/storage/audit/audit_storage_test.dart (655.0 B, 21 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/ws
------------------------------------------------------------
757. ğŸ“„ test/ws/ws_manager_test.dart (378.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/unit
------------------------------------------------------------
758. ğŸ“„ test/unit/analytics_calculator_test.dart (541.0 B, 18 Ø³Ø·Ø±)
759. ğŸ“„ test/unit/chart_bloc_test.dart (1.2 KB, 34 Ø³Ø·Ø±)
760. ğŸ“„ test/unit/indicator_test.dart (672.0 B, 19 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/unit/backtest
------------------------------------------------------------
761. ğŸ“„ test/unit/backtest/backtest_engine_profit_test.dart (1.0 KB, 27 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/unit/indicators
------------------------------------------------------------
762. ğŸ“„ test/unit/indicators/rsi_no_loss_test.dart (658.0 B, 24 Ø³Ø·Ø±)
763. ğŸ“„ test/unit/indicators/ema_indicator_edge_test.dart (677.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/unit/streaming
------------------------------------------------------------
764. ğŸ“„ test/unit/streaming/tick_aggregator_test.dart (710.0 B, 20 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/unit/network
------------------------------------------------------------
765. ğŸ“„ test/unit/network/rest_token_expired_test.dart (485.0 B, 15 Ø³Ø·Ø±)
766. ğŸ“„ test/unit/network/rest_client_test.dart (778.0 B, 27 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/unit/models
------------------------------------------------------------
767. ğŸ“„ test/unit/models/candle_tick_test.dart (903.0 B, 40 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/strategy
------------------------------------------------------------
768. ğŸ“„ test/strategy/sequential_evaluator_test.dart (681.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/features/market/presentation/widgets
------------------------------------------------------------
769. ğŸ“„ test/features/market/presentation/widgets/backtest_report_widget_test.dart (691.0 B, 20 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/features/market/domain/indicators
------------------------------------------------------------
770. ğŸ“„ test/features/market/domain/indicators/ema_test.dart (453.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/backtest
------------------------------------------------------------
771. ğŸ“„ test/backtest/backtest_engine_test.dart (966.0 B, 31 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc
------------------------------------------------------------
772. ğŸ“„ test/bloc/chart_bloc_test.dart (1.1 KB, 33 Ø³Ø·Ø±)
773. ğŸ“„ test/bloc/market_bloc_test.dart (1023.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc/strategy_builder
------------------------------------------------------------
774. ğŸ“„ test/bloc/strategy_builder/strategy_builder_bloc_test.dart (952.0 B, 26 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc/trading
------------------------------------------------------------
775. ğŸ“„ test/bloc/trading/trading_bloc_test.dart (1.4 KB, 43 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc/oanda_setup
------------------------------------------------------------
776. ğŸ“„ test/bloc/oanda_setup/oanda_setup_bloc_test.dart (1.1 KB, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc/replay
------------------------------------------------------------
777. ğŸ“„ test/bloc/replay/replay_edge_test.dart (964.0 B, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc/backtest
------------------------------------------------------------
778. ğŸ“„ test/bloc/backtest/backtest_cancel_test.dart (722.0 B, 17 Ø³Ø·Ø±)
779. ğŸ“„ test/bloc/backtest/backtest_bloc_test.dart (1023.0 B, 31 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/bloc/chart
------------------------------------------------------------
780. ğŸ“„ test/bloc/chart/chart_bloc_test.dart (1.5 KB, 42 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/domain
------------------------------------------------------------
781. ğŸ“„ test/domain/candle_normalizer_test.dart (605.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/domain/backtest
------------------------------------------------------------
782. ğŸ“„ test/domain/backtest/backtest_engine_test.dart (766.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/domain/indicators
------------------------------------------------------------
783. ğŸ“„ test/domain/indicators/rsi_calculator_test.dart (626.0 B, 20 Ø³Ø·Ø±)
784. ğŸ“„ test/domain/indicators/ema_calculator_test.dart (671.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/indicators
------------------------------------------------------------
785. ğŸ“„ test/indicators/ema_rsi_test.dart (972.0 B, 30 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/performance
------------------------------------------------------------
786. ğŸ“„ test/performance/indicator_perf_test.dart (624.0 B, 22 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/models
------------------------------------------------------------
787. ğŸ“„ test/models/candle_entity_test.dart (592.0 B, 23 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/stress
------------------------------------------------------------
788. ğŸ“„ test/stress/backtest_stress_test.dart (843.0 B, 25 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/widget
------------------------------------------------------------
789. ğŸ“„ test/widget/home_page_test.dart (593.0 B, 17 Ø³Ø·Ø±)
790. ğŸ“„ test/widget/chart_page_test.dart (526.0 B, 15 Ø³Ø·Ø±)
791. ğŸ“„ test/widget/chart_widget_test.dart (523.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/integration
------------------------------------------------------------
792. ğŸ“„ test/integration/backtest_analytics_test.dart (876.0 B, 22 Ø³Ø·Ø±)
793. ğŸ“„ test/integration/navigation_test.dart (513.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/integration/ws
------------------------------------------------------------
794. ğŸ“„ test/integration/ws/ws_reconnect_test.dart (408.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/pinning
------------------------------------------------------------
795. ğŸ“„ test/pinning/pin_fail_test.dart (418.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/widgets
------------------------------------------------------------
796. ğŸ“„ test/widgets/strategy_builder_test.dart (459.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/widgets/offline
------------------------------------------------------------
797. ğŸ“„ test/widgets/offline/offline_banner_test.dart (342.0 B, 11 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: test/widgets/chart
------------------------------------------------------------
798. ğŸ“„ test/widgets/chart/interactive_chart_test.dart (595.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: integration_test
------------------------------------------------------------
799. ğŸ“„ integration_test/chart_integration_test.dart (813.0 B, 19 Ø³Ø·Ø±)
800. ğŸ“„ integration_test/app_flow_test.dart (557.0 B, 17 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/staging/res/values
------------------------------------------------------------
801. ğŸ“„ android/app/src/staging/res/values/strings.xml (81.0 B, 3 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/dev/res/values
------------------------------------------------------------
802. ğŸ“„ android/app/src/dev/res/values/strings.xml (77.0 B, 3 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main
------------------------------------------------------------
803. ğŸ“„ android/app/src/main/AndroidManifest.xml (2.2 KB, 45 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main/java/io/flutter/plugins
------------------------------------------------------------
804. ğŸ“„ android/app/src/main/java/io/flutter/plugins/GeneratedPluginRegistrant.java (1.3 KB, 34 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main/kotlin/com/example/flutter_trading_app
------------------------------------------------------------
805. ğŸ“„ android/app/src/main/kotlin/com/example/flutter_trading_app/MainActivity.kt (133.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main/res/drawable-v21
------------------------------------------------------------
806. ğŸ“„ android/app/src/main/res/drawable-v21/launch_background.xml (438.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main/res/drawable
------------------------------------------------------------
807. ğŸ“„ android/app/src/main/res/drawable/launch_background.xml (434.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main/res/values-night
------------------------------------------------------------
808. ğŸ“„ android/app/src/main/res/values-night/styles.xml (995.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/main/res/values
------------------------------------------------------------
809. ğŸ“„ android/app/src/main/res/values/styles.xml (996.0 B, 18 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/debug
------------------------------------------------------------
810. ğŸ“„ android/app/src/debug/AndroidManifest.xml (378.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/app/src/profile
------------------------------------------------------------
811. ğŸ“„ android/app/src/profile/AndroidManifest.xml (378.0 B, 7 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Runner.xcodeproj/project.xcworkspace/xcshareddata
------------------------------------------------------------
812. ğŸ“„ ios/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist (238.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Runner.xcworkspace/xcshareddata
------------------------------------------------------------
813. ğŸ“„ ios/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist (238.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Runner
------------------------------------------------------------
814. ğŸ“„ ios/Runner/AppDelegate.swift (539.0 B, 16 Ø³Ø·Ø±)
815. ğŸ“„ ios/Runner/Info.plist (2.2 KB, 70 Ø³Ø·Ø±)
816. ğŸ“„ ios/Runner/Runner-Bridging-Header.h (38.0 B, 1 Ø³Ø·Ø±)
817. ğŸ“„ ios/Runner/SceneDelegate.swift (76.0 B, 6 Ø³Ø·Ø±)
818. ğŸ“„ ios/Runner/GeneratedPluginRegistrant.h (378.0 B, 19 Ø³Ø·Ø±)
819. ğŸ“„ ios/Runner/GeneratedPluginRegistrant.m (845.0 B, 28 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Runner/Assets.xcassets/AppIcon.appiconset
------------------------------------------------------------
820. ğŸ“„ ios/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json (2.5 KB, 122 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Runner/Assets.xcassets/LaunchImage.imageset
------------------------------------------------------------
821. ğŸ“„ ios/Runner/Assets.xcassets/LaunchImage.imageset/Contents.json (391.0 B, 23 Ø³Ø·Ø±)
822. ğŸ“„ ios/Runner/Assets.xcassets/LaunchImage.imageset/README.md (336.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/RunnerTests
------------------------------------------------------------
823. ğŸ“„ ios/RunnerTests/RunnerTests.swift (285.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/Runner.xcodeproj/project.xcworkspace/xcshareddata
------------------------------------------------------------
824. ğŸ“„ macos/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist (238.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/Runner.xcworkspace/xcshareddata
------------------------------------------------------------
825. ğŸ“„ macos/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist (238.0 B, 8 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/Runner
------------------------------------------------------------
826. ğŸ“„ macos/Runner/AppDelegate.swift (311.0 B, 13 Ø³Ø·Ø±)
827. ğŸ“„ macos/Runner/Info.plist (1.0 KB, 32 Ø³Ø·Ø±)
828. ğŸ“„ macos/Runner/MainFlutterWindow.swift (388.0 B, 15 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/Runner/Assets.xcassets/AppIcon.appiconset
------------------------------------------------------------
829. ğŸ“„ macos/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json (1.3 KB, 68 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/RunnerTests
------------------------------------------------------------
830. ğŸ“„ macos/RunnerTests/RunnerTests.swift (290.0 B, 12 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: windows/runner
------------------------------------------------------------
831. ğŸ“„ windows/runner/CMakeLists.txt (1.8 KB, 40 Ø³Ø·Ø±)
832. ğŸ“„ windows/runner/flutter_window.cpp (2.1 KB, 71 Ø³Ø·Ø±)
833. ğŸ“„ windows/runner/flutter_window.h (928.0 B, 33 Ø³Ø·Ø±)
834. ğŸ“„ windows/runner/main.cpp (1.2 KB, 43 Ø³Ø·Ø±)
835. ğŸ“„ windows/runner/resource.h (432.0 B, 16 Ø³Ø·Ø±)
836. ğŸ“„ windows/runner/utils.cpp (2.1 KB, 69 Ø³Ø·Ø±)
837. ğŸ“„ windows/runner/utils.h (672.0 B, 19 Ø³Ø·Ø±)
838. ğŸ“„ windows/runner/win32_window.cpp (8.3 KB, 288 Ø³Ø·Ø±)
839. ğŸ“„ windows/runner/win32_window.h (3.4 KB, 102 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: scripts
------------------------------------------------------------
840. ğŸ“„ scripts/release_android.sh (20.0 B, 1 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: scripts/ci_cd
------------------------------------------------------------
841. ğŸ“„ scripts/ci_cd/ci_cd_and_deployment.sh (943.0 B, 37 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: assets
------------------------------------------------------------
842. ğŸ“„ assets/chart.html (742.0 B, 29 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: assets/js
------------------------------------------------------------
843. ğŸ“„ assets/js/sl_tp_overlay.js (285.0 B, 13 Ø³Ø·Ø±)
844. ğŸ“„ assets/js/equity_curve.js (123.0 B, 4 Ø³Ø·Ø±)
845. ğŸ“„ assets/js/zone_overlay.js (317.0 B, 12 Ø³Ø·Ø±)
846. ğŸ“„ assets/js/chart_extension.js (171.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: assets/lightweight_charts
------------------------------------------------------------
847. ğŸ“„ assets/lightweight_charts/chart.html (1.6 KB, 66 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: docs
------------------------------------------------------------
848. ğŸ“„ docs/PRODUCTION_SETUP.md (420.0 B, 16 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: [Ø§Ù„Ø¬Ø°Ø±]
------------------------------------------------------------
849. ğŸ“„ build.yaml (147.0 B, 8 Ø³Ø·Ø±)
850. ğŸ“„ pubspec.yaml (783.0 B, 43 Ø³Ø·Ø±)
851. ğŸ“„ 90.py (23.7 KB, 619 Ø³Ø·Ø±)
852. ğŸ“„ README.md (641.0 B, 17 Ø³Ø·Ø±)
853. ğŸ“„ analysis_options.yaml (1.4 KB, 28 Ø³Ø·Ø±)
854. ğŸ“„ opl.sh (10.7 KB, 322 Ø³Ø·Ø±)
855. ğŸ“„ flutter_trading_app_codes_20260118_200203.txt (293.0 B, 9 Ø³Ø·Ø±)
856. ğŸ“„ oppp.py (18.6 KB, 453 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android
------------------------------------------------------------
857. ğŸ“„ android/key.properties (118.0 B, 4 Ø³Ø·Ø±)
858. ğŸ“„ android/local.properties (125.0 B, 5 Ø³Ø·Ø±)
859. ğŸ“„ android/gradle.properties (138.0 B, 2 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: android/gradle/wrapper
------------------------------------------------------------
860. ğŸ“„ android/gradle/wrapper/gradle-wrapper.properties (200.0 B, 5 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: batch_scripts_fixed
------------------------------------------------------------
861. ğŸ“„ batch_scripts_fixed/batch_002.sh (602.3 KB, 22,289 Ø³Ø·Ø±)
862. ğŸ“„ batch_scripts_fixed/batch_001.sh (18.6 KB, 475 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Flutter
------------------------------------------------------------
863. ğŸ“„ ios/Flutter/AppFrameworkInfo.plist (720.0 B, 24 Ø³Ø·Ø±)
864. ğŸ“„ ios/Flutter/flutter_export_environment.sh (614.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: ios/Flutter/ephemeral
------------------------------------------------------------
865. ğŸ“„ ios/Flutter/ephemeral/flutter_lldb_helper.py (1.2 KB, 32 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/Flutter
------------------------------------------------------------
866. ğŸ“„ macos/Flutter/GeneratedPluginRegistrant.swift (427.0 B, 14 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: macos/Flutter/ephemeral
------------------------------------------------------------
867. ğŸ“„ macos/Flutter/ephemeral/flutter_export_environment.sh (578.0 B, 13 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: windows
------------------------------------------------------------
868. ğŸ“„ windows/CMakeLists.txt (4.1 KB, 108 Ø³Ø·Ø±)

ğŸ“‚ Ù…Ø¬Ù„Ø¯: windows/flutter
------------------------------------------------------------
869. ğŸ“„ windows/flutter/CMakeLists.txt (3.7 KB, 109 Ø³Ø·Ø±)
870. ğŸ“„ windows/flutter/generated_plugin_registrant.h (302.0 B, 15 Ø³Ø·Ø±)

================================================================================
ğŸ“„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª
================================================================================

================================================================================
Ø§Ù„Ù…Ù„Ù 1: lib/app.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/app.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 773.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter/material.dart';
import 'features/market/presentation/pages/home_page.dart';

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Trading App',
      debugShowCheckedModeBanner: false,
      theme: ThemeData.light().copyWith(
        primaryColor: Colors.blue,
        colorScheme: ColorScheme.light(
          primary: Colors.blue,
          secondary: Colors.blueAccent,
        ),
      ),
      darkTheme: ThemeData.dark().copyWith(
        primaryColor: Colors.teal,
        colorScheme: ColorScheme.dark(
          primary: Colors.teal,
          secondary: Colors.tealAccent,
        ),
      ),
      themeMode: ThemeMode.system,
      home: HomePage(),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/app.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 2: lib/main.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/main.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 580.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter/material.dart';
import 'core/init/app_initializer.dart';
import 'core/navigation/app_router.dart';
import 'core/theme/app_theme.dart';

Future<void> main() async {
  await AppInitializer.initialize();
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Trading App',
      theme: AppTheme.lightTheme,
      darkTheme: AppTheme.darkTheme,
      onGenerateRoute: AppRouter.generateRoute,
      initialRoute: '/',
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/main.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 3: lib/core/integration/webhook_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/integration/webhook_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 377.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

typedef WebhookHandlerFunc = Future<void> Function(Map<String, dynamic>);

class WebhookHandler {
  final Map<String, WebhookHandlerFunc> handlers = {};

  void register(String event, WebhookHandlerFunc fn) => handlers[event] = fn;

  Future<void> handle(String event, Map<String, dynamic> body) async {
    if (handlers.containsKey(event)) await handlers[event]!(body);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/integration/webhook_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 4: lib/core/integration/webhook_push_bridge.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/integration/webhook_push_bridge.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 351.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import '../notifications/firebase_messaging_service.dart';

class WebhookPushBridge {
  final FirebaseMessagingService fcm;

  WebhookPushBridge(this.fcm);

  Future<void> sendPushOnWebhook(Map<String, dynamic> body) async {
    final token = await fcm.getToken();
    if (token != null) {
      // ØªÙ†ÙÙŠØ° POST Ù„FCM API (Server Side)
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/integration/webhook_push_bridge.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 5: lib/core/integration/telegram/telegram_bot.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/integration/telegram/telegram_bot.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 275.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:telebot/telebot.dart';

class TelegramBot {
  final String token;
  final Telebot _bot;

  TelegramBot(this.token) : _bot = Telebot(token);

  void start() {
    _bot.start();
    _bot.onMessage((msg) {
      print("Telegram Msg: ${msg.text}");
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/integration/telegram/telegram_bot.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 6: lib/core/localization/app_localizations.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/localization/app_localizations.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 265.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'dart:ui';

class AppLocalizations {
  static String networkError() => "Network error occurred.";
  static String unknownError() => "Unknown error.";
  static String priceInvalid() => "Invalid price data.";
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/localization/app_localizations.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 7: lib/core/sync/event_sync_controller.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/event_sync_controller.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 465.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'dart:async';

/// Ensures only one update type is processed at a time.
/// Other events wait in queue.
class EventSyncController {
  final _queue = StreamController<Function()>();

  EventSyncController() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  /// add an event to execution queue
  void addToQueue(void Function() task) {
    _queue.add(task);
  }

  Future<void> close() async {
    await _queue.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/event_sync_controller.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 8: lib/core/sync/timestamp_aligner.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/timestamp_aligner.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 386.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

class TimestampAligner {
  static double alignWeightedAverage(
      double currentValue,
      DateTime currentTimestamp,
      double latestValue,
      DateTime latestTimestamp) {
    final dt = latestTimestamp.difference(currentTimestamp).inMilliseconds;
    final w1 = dt <= 0 ? 1.0 : 1 / (1 + dt);
    final w2 = 1 - w1;
    return (currentValue * w1) + (latestValue * w2);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/timestamp_aligner.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 9: lib/core/sync/indicator_throttler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/indicator_throttler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 399.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';

class IndicatorThrottler {
  final Duration delay;
  Timer? _timer;
  List<dynamic> _pending = [];

  IndicatorThrottler({this.delay = const Duration(milliseconds: 50)});

  void add(dynamic data, void Function(List<dynamic>) compute) {
    _pending.add(data);
    _timer?.cancel();
    _timer = Timer(delay, () {
      compute(_pending);
      _pending.clear();
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/indicator_throttler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 10: lib/core/sync/rest_ws_sync_coordinator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/rest_ws_sync_coordinator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 467.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'dart:async';

class RestWsSyncCoordinator {
  bool _historyLoaded = false;
  final List<Function()> _pendingConnectWs = [];

  void historyLoaded() {
    _historyLoaded = true;
    while (_pendingConnectWs.isNotEmpty) {
      final action = _pendingConnectWs.removeAt(0);
      action();
    }
  }

  void connectWsWhenReady(Function() connectFn) {
    if (_historyLoaded) {
      connectFn();
    } else {
      _pendingConnectWs.add(connectFn);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/rest_ws_sync_coordinator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 11: lib/core/sync/compute_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/compute_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 261.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:async';

class ComputeGuard {
  bool _busy = false;

  Future<void> run(Future<void> Function() fn) async {
    while (_busy) {
      await Future.delayed(Duration(milliseconds: 5));
    }
    _busy = true;
    await fn();
    _busy = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/compute_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 12: lib/core/sync/signal_sync_controller.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/signal_sync_controller.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 407.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';

/// Ensures that indicator values are updated before evaluating signals.
class SignalSyncController {
  final _queue = StreamController<Function()>();

  SignalSyncController() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  void addTask(Function() task) {
    _queue.add(task);
  }

  Future<void> dispose() async {
    await _queue.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/signal_sync_controller.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 13: lib/core/sync/sync_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/sync_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 42.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

// sync_manager.dart
class SyncManager {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/sync_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 14: lib/core/sync/cloud/cloud_sync_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/sync/cloud/cloud_sync_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 629.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù€ Firebase/Backend Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§

class CloudSyncService {
  static Future<void> uploadUserSettings(Map<String, dynamic> settings) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("cloud_user_settings", jsonEncode(settings));
  }

  static Future<Map<String, dynamic>?> downloadUserSettings() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString("cloud_user_settings");
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/sync/cloud/cloud_sync_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 15: lib/core/log/logger_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/log/logger_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 317.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

class LoggerService {
  static bool _enabled = true;

  static void init() {
    log('LoggerService initialized');
  }

  static void log(String message) {
    if (_enabled) {
      print('[LOG] $message');
    }
  }

  static void error(String message, [Object? e]) {
    print('[ERROR] $message ${e ?? ""}');
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/log/logger_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 16: lib/core/navigation/app_router.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/navigation/app_router.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 491.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter/material.dart';
import '../../features/home/presentation/pages/home_page.dart';

class AppRouter {
  static Route<dynamic> generateRoute(RouteSettings settings) {
    switch (settings.name) {
      case '/':
        return MaterialPageRoute(builder: (_) => HomePage());
      default:
        return MaterialPageRoute(
          builder: (_) => Scaffold(
            body: Center(child: Text('Route not found: ${settings.name}')),
          ),
        );
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/navigation/app_router.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 17: lib/core/navigation/fade_route.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/navigation/fade_route.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 392.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/material.dart';

class FadeRoute extends PageRouteBuilder {
  final Widget page;

  FadeRoute(this.page)
      : super(
          pageBuilder: (context, animation, secondaryAnimation) => page,
          transitionsBuilder: (context, animation, secondaryAnimation, child) {
            return FadeTransition(opacity: animation, child: child);
          },
        );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/navigation/fade_route.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 18: lib/core/navigation/router_observer_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/navigation/router_observer_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 299.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/widgets.dart';

class RouterObserverFix extends RouteObserver<PageRoute<dynamic>> {
  @override
  void didPop(Route route, Route? previousRoute) {
    // Ø¥ÙŠÙ‚Ø§Ù Replay / Streams
  }

  @override
  void didPush(Route route, Route? previousRoute) {
    // Ù…Ù…Ø§Ø«Ù„
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/navigation/router_observer_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 19: lib/core/navigation/bloc_auto_dispose_route.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/navigation/bloc_auto_dispose_route.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 413.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter/widgets.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class BlocAutoDisposeRoute<T> extends MaterialPageRoute<T> {
  final BlocProvider _provider;

  BlocAutoDisposeRoute({required Widget child, required BlocProvider provider})
      : _provider = provider,
        super(builder: (_) => child);

  @override
  void dispose() {
    _provider.close();
    super.dispose();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/navigation/bloc_auto_dispose_route.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 20: lib/core/navigation/router_bloc_cleanup.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/navigation/router_bloc_cleanup.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 408.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter/widgets.dart';

class RouterBlocCleanup extends RouteObserver<PageRoute<dynamic>> {
  @override
  void didPop(Route route, Route? previousRoute) {
    if (route is PageRoute) {
      // dispatch cleanup event to relevant Blocs
    }
  }

  @override
  void didPush(Route route, Route? previousRoute) {
    if (previousRoute is PageRoute) {
      // dispatch cleanup event
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/navigation/router_bloc_cleanup.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 21: lib/core/navigation/back_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/navigation/back_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 384.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter/material.dart';

class BackHandler extends StatelessWidget {
  final Widget child;
  final VoidCallback onBack;

  BackHandler({required this.child, required this.onBack});

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: () async {
        onBack();
        return false;
      },
      child: child,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/navigation/back_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 22: lib/core/init/app_initializer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/init/app_initializer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 489.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter/material.dart';
import '../di/dependency_injection.dart';
import '../log/logger_service.dart';

class AppInitializer {
  static Future<void> initialize() async {
    WidgetsFlutterBinding.ensureInitialized();

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ DI
    await DependencyInjection.init();

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ÙˆØ¬Ø±
    LoggerService.init();

    // Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ©:
    // - Firebase.init()
    // - Hive.init()
    // - SecureStorage.init()
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/init/app_initializer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 23: lib/core/market/symbol_normalizer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/market/symbol_normalizer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 474.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

class SymbolNormalizer {
  /// ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ ØµÙŠØºØ© Ø±Ù…Ø²ÙŠØ© Ù„Ù€ "CONCAT" (Ø¨Ø¯ÙˆÙ† underscore)
  static String normalize(String sym) {
    return sym.replaceAll("_", "").toUpperCase();
  }

  /// ÙŠÙØµÙ‘Ù„ Ø§Ù„ØµÙŠØºØ© Ø¥Ù„Ù‰ Ø²ÙˆØ¬/Ø³ÙˆÙ‚
  static String formatWithUnderscore(String sym) {
    final n = normalize(sym);
    // Ù…Ø«Ø§Ù„: XAUUSD â†’ XAU_USD
    if (n.length == 6) {
      return "${n.substring(0, 3)}_${n.substring(3)}";
    }
    return sym;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/market/symbol_normalizer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 24: lib/core/bloc/app_bloc_observer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/app_bloc_observer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 578.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

class AppBlocObserver extends BlocObserver {
  @override
  void onEvent(Bloc bloc, Object? event) {
    super.onEvent(bloc, event);
    print('[BlocEvent] ${bloc.runtimeType} $event');
  }

  @override
  void onChange(BlocBase bloc, Change change) {
    super.onChange(bloc, change);
    print('[BlocChange] ${bloc.runtimeType} $change');
  }

  @override
  void onError(BlocBase bloc, Object error, StackTrace stackTrace) {
    super.onError(bloc, error, stackTrace);
    print('[BlocError] ${bloc.runtimeType} $error');
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/app_bloc_observer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 25: lib/core/bloc/bloc_observer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/bloc_observer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 542.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

class AppBlocObserver extends BlocObserver {
  @override
  void onEvent(Bloc bloc, Object? event) {
    super.onEvent(bloc, event);
    // debugPrint('Bloc Event: $event');
  }

  @override
  void onChange(BlocBase bloc, Change change) {
    super.onChange(bloc, change);
    // debugPrint('Bloc Change: $change');
  }

  @override
  void onError(BlocBase bloc, Object error, StackTrace stackTrace) {
    super.onError(bloc, error, stackTrace);
    // debugPrint('Bloc Error: $error');
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/bloc_observer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 26: lib/core/bloc/stream_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/stream_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:async';

class StreamHandler<T> {
  StreamSubscription? _sub;

  void listen(Stream<T> stream, void Function(T) onData) {
    _sub = stream.listen(onData);
  }

  Future<void> cancel() async {
    await _sub?.cancel();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/stream_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 27: lib/core/bloc/base_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/base_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 359.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

abstract class BaseEvent {}

abstract class BaseState {}

abstract class BaseEffect {}

abstract class BaseBloc<E extends BaseEvent, S extends BaseState>
    extends Bloc<E, S> {
  BaseBloc(S initialState) : super(initialState);

  void emitSafe(S state) {
    if (!isClosed) {
      emit(state);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/base_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 28: lib/core/bloc/subscription_manager/subscription_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/subscription_manager/subscription_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 601.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'dart:async';

/// A manager that keeps only one active subscription at a time.
/// Cancels previous one automatically when a new one is added.
class SubscriptionManager {
  StreamSubscription<dynamic>? _current;

  /// Replace the current subscription with a new one,
  /// canceling the previous if it exists.
  void replace(StreamSubscription<dynamic> newSub) {
    _current?.cancel();
    _current = newSub;
  }

  /// Cancel and clear the current subscription.
  Future<void> dispose() async {
    if (_current != null) {
      await _current!.cancel();
      _current = null;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/subscription_manager/subscription_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 29: lib/core/bloc/mixins/event_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/mixins/event_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 113.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

mixin EventGuard<T> {
  bool isValidEvent(T event) {
    if (event == null) return false;
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/mixins/event_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 30: lib/core/bloc/mixins/stream_controller_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/mixins/stream_controller_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 543.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';

mixin StreamControllerGuard on BlocBase {
  final List<StreamController> _controllers = [];

  StreamController<T> createController<T>({bool broadcast = false}) {
    final c = broadcast
        ? StreamController<T>.broadcast()
        : StreamController<T>();
    _controllers.add(c);
    return c;
  }

  @override
  Future<void> close() async {
    for (final c in _controllers) {
      await c.close();
    }
    _controllers.clear();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/mixins/stream_controller_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 31: lib/core/bloc/mixins/side_effect_queue.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/mixins/side_effect_queue.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 242.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

mixin SideEffectQueue<E> on BlocBase<E> {
  final List<E> _effects = [];

  void addEffect(E effect) => _effects.add(effect);

  List<E> consumeEffects() {
    final copy = List<E>.from(_effects);
    _effects.clear();
    return copy;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/mixins/side_effect_queue.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 32: lib/core/bloc/mixins/stream_controller_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/mixins/stream_controller_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 459.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'dart:async';

mixin StreamControllerManager {
  final List<StreamController> _controllers = [];

  StreamController<T> createController<T>({bool broadcast = false}) {
    final c = broadcast
        ? StreamController<T>.broadcast()
        : StreamController<T>();
    _controllers.add(c);
    return c;
  }

  Future<void> disposeControllers() async {
    for (final c in _controllers) {
      await c.close();
    }
    _controllers.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/mixins/stream_controller_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 33: lib/core/bloc/mixins/safe_dispose_mixin.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/mixins/safe_dispose_mixin.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 351.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';

mixin SafeDisposeMixin on BlocBase {
  final List<StreamSubscription> _subs = [];

  void addSub(StreamSubscription sub) => _subs.add(sub);

  @override
  Future<void> close() async {
    for (final s in _subs) await s.cancel();
    _subs.clear();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/mixins/safe_dispose_mixin.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 34: lib/core/bloc/subscriptions/subscription_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/subscriptions/subscription_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 277.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:async';

class SubscriptionManager {
  final List<StreamSubscription> _subs = [];

  void add(StreamSubscription sub) {
    _subs.add(sub);
  }

  Future<void> cancelAll() async {
    for (final s in _subs) {
      await s.cancel();
    }
    _subs.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/subscriptions/subscription_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 35: lib/core/bloc/providers/app_bloc_providers.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/providers/app_bloc_providers.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 744.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

import '../root/root_bloc.dart';
import '../../features/market/presentation/bloc/market/market_bloc.dart';
import '../../features/market/presentation/bloc/stream/stream_bloc.dart';
import '../../features/trading/presentation/bloc/trading_bloc.dart';

class AppBlocProviders {
  static List<BlocProvider> all(
    dynamic marketRepo,
    dynamic streamAdapter,
  ) {
    return [
      BlocProvider<RootBloc>(create: (_) => RootBloc()),
      BlocProvider<MarketBloc>(
          create: (_) => MarketBloc(marketRepo, streamAdapter)),
      BlocProvider<StreamBloc>(
          create: (_) => StreamBloc(streamAdapter)),
      BlocProvider<TradingBloc>(create: (_) => TradingBloc()),
    ];
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/providers/app_bloc_providers.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 36: lib/core/bloc/guards/async_dispose_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/guards/async_dispose_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 319.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:async';

class AsyncDisposeGuard {
  bool _disposing = false;
  final List<Future<void>> _pending = [];

  void track(Future<void> future) {
    if (!_disposing) _pending.add(future);
  }

  Future<void> dispose() async {
    _disposing = true;
    await Future.wait(_pending);
    _pending.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/guards/async_dispose_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 37: lib/core/bloc/sync/bloc_init_barrier.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/sync/bloc_init_barrier.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 237.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class BlocInitBarrier {
  bool chartReady = false;
  bool indicatorReady = false;

  bool get allReady => chartReady && indicatorReady;

  void setChartReady() => chartReady = true;
  void setIndicatorReady() => indicatorReady = true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/sync/bloc_init_barrier.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 38: lib/core/bloc/root/root_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/root/root_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 335.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class RootEvent {}

class InitApp extends RootEvent {}

class TerminateApp extends RootEvent {}

class ConnectionStatusChanged extends RootEvent {
  final bool connected;
  ConnectionStatusChanged(this.connected);
}

class GlobalErrorOccurred extends RootEvent {
  final String message;
  GlobalErrorOccurred(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/root/root_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 39: lib/core/bloc/root/root_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/root/root_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 352.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

abstract class RootState {}

class AppUninitialized extends RootState {}

class AppReady extends RootState {}

class AppTerminated extends RootState {}

class AppErrorState extends RootState {
  final String message;
  AppErrorState(this.message);
}

class ConnectivityState extends RootState {
  final bool online;
  ConnectivityState(this.online);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/root/root_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 40: lib/core/bloc/root/root_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/root/root_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 586.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'root_event.dart';
import 'root_state.dart';

class RootBloc extends Bloc<RootEvent, RootState> {
  RootBloc() : super(AppUninitialized()) {
    on<InitApp>((event, emit) {
      emit(AppReady());
    });

    on<ConnectionStatusChanged>((event, emit) {
      emit(ConnectivityState(event.connected));
    });

    on<GlobalErrorOccurred>((event, emit) {
      emit(AppErrorState(event.message));
    });

    on<TerminateApp>((event, emit) {
      // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Cleanup Ù‡Ù†Ø§
      emit(AppTerminated());
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/root/root_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 41: lib/core/bloc/init/bloc_init_coordinator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/init/bloc_init_coordinator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 275.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

typedef InitFuture = Future<void> Function();

class BlocInitCoordinator {
  final List<InitFuture> _initializers = [];

  void add(InitFuture fn) => _initializers.add(fn);

  Future<void> run() async {
    for (final init in _initializers) {
      await init();
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/init/bloc_init_coordinator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 42: lib/core/bloc/live_chart/live_chart_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/live_chart/live_chart_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 58
================================================================================

import 'dart:async';
import 'package:bloc/bloc.dart';
import '../../../repositories/market/market_repository.dart';
import '../../sync/sync_manager.dart';
import '../../../features/market/data/streaming/tick_aggregator.dart';
import 'live_chart_event.dart';
import 'live_chart_state.dart';

class LiveChartBloc extends Bloc<LiveChartEvent, LiveChartState> {
  final MarketRepository repository;
  final SyncManager syncManager;

  StreamSubscription? _streamSub;

  LiveChartBloc({
    required this.repository,
    required this.syncManager,
  }) : super(LiveChartInitial()) {
    on<LiveChartStart>(_onStart);
    on<LiveChartStop>(_onStop);
    on<LiveChartCandleReceived>(_onCandle);
  }

  Future<void> _onStart(
      LiveChartStart event, Emitter<LiveChartState> emit) async {
    emit(LiveChartLoading());

    try {
      await repository.stopLive();

      final stream = repository.startLiveStream(wsUrl: event.wsUrl);

      _streamSub = stream.listen((candle) {
        add(LiveChartCandleReceived(candle));
      });

      emit(LiveChartRunning([]));
    } catch (e) {
      emit(LiveChartError(e.toString()));
    }
  }

  Future<void> _onStop(
      LiveChartStop event, Emitter<LiveChartState> emit) async {
    await repository.stopLive();
    await _streamSub?.cancel();
    emit(LiveChartStopped());
  }

  void _onCandle(
      LiveChartCandleReceived event, Emitter<LiveChartState> emit) {
    if (state is LiveChartRunning) {
      final current = (state as LiveChartRunning).candles;
      final updated = List.of(current)..add(event.candle);
      emit(LiveChartRunning(updated));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/live_chart/live_chart_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 43: lib/core/bloc/live_chart/live_chart_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/live_chart/live_chart_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 374.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../features/market/data/streaming/tick_aggregator.dart';

abstract class LiveChartEvent {}

class LiveChartStart extends LiveChartEvent {
  final String wsUrl;
  LiveChartStart(this.wsUrl);
}

class LiveChartCandleReceived extends LiveChartEvent {
  final Candle candle;
  LiveChartCandleReceived(this.candle);
}

class LiveChartStop extends LiveChartEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/live_chart/live_chart_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 44: lib/core/bloc/live_chart/live_chart_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/live_chart/live_chart_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 475.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import '../../../features/market/data/streaming/tick_aggregator.dart';

abstract class LiveChartState {}

class LiveChartInitial extends LiveChartState {}

class LiveChartLoading extends LiveChartState {}

class LiveChartRunning extends LiveChartState {
  final List<Candle> candles;
  LiveChartRunning(this.candles);
}

class LiveChartStopped extends LiveChartState {}

class LiveChartError extends LiveChartState {
  final String message;
  LiveChartError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/live_chart/live_chart_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 45: lib/core/bloc/backtest/backtest_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/backtest/backtest_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 718.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:bloc/bloc.dart';
import '../../../core/backtest/backtest_engine.dart';
import 'backtest_event.dart';
import 'backtest_state.dart';

class BacktestBloc extends Bloc<BacktestEvent, BacktestState> {
  final BacktestEngine engine;

  BacktestBloc({required this.engine}) : super(BacktestInitial()) {
    on<BacktestStart>(_onStart);
  }

  Future<void> _onStart(
      BacktestStart event, Emitter<BacktestState> emit) async {
    emit(BacktestRunning());

    try {
      final result = await engine.run(
        symbol: event.symbol,
        start: event.start,
        end: event.end,
      );

      emit(BacktestSuccess(result));
    } catch (e) {
      emit(BacktestError(e.toString()));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/backtest/backtest_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 46: lib/core/bloc/backtest/backtest_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/backtest/backtest_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 247.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

abstract class BacktestEvent {}

class BacktestStart extends BacktestEvent {
  final String symbol;
  final DateTime start;
  final DateTime end;

  BacktestStart({
    required this.symbol,
    required this.start,
    required this.end,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/backtest/backtest_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 47: lib/core/bloc/backtest/backtest_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/bloc/backtest/backtest_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 397.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../../../core/backtest/backtest_engine.dart';

abstract class BacktestState {}

class BacktestInitial extends BacktestState {}

class BacktestRunning extends BacktestState {}

class BacktestSuccess extends BacktestState {
  final BacktestResult result;
  BacktestSuccess(this.result);
}

class BacktestError extends BacktestState {
  final String message;
  BacktestError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/bloc/backtest/backtest_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 48: lib/core/isolate/isolate_helpers.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/isolate/isolate_helpers.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 60
================================================================================

import 'dart:developer';
import 'package:flutter/foundation.dart';
import '../../features/market/domain/indicators/ema.dart';
import '../../features/market/domain/indicators/stochastic.dart';
import '../../features/market/domain/entities/candle.dart';

class IndicatorParams {
  final List<Candle> candles;
  final int emaShort;
  final int emaLong;
  final int stochPeriod;
  final int stochSmoothK;
  final int stochSmoothD;

  IndicatorParams({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.stochPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
  });
}

class IndicatorResult {
  final List<double> emaShort;
  final List<double> emaLong;
  final List<double> stochK;
  final List<double> stochD;

  IndicatorResult({
    required this.emaShort,
    required this.emaLong,
    required this.stochK,
    required this.stochD,
  });
}

Future<IndicatorResult> computeIndicatorsInBackground(IndicatorParams params) async {
  return await compute(_calculateIndicators, params);
}

IndicatorResult _calculateIndicators(IndicatorParams params) {
  try {
    final emaShort = calculateEMA(params.candles, params.emaShort);
    final emaLong = calculateEMA(params.candles, params.emaLong);
    final stochK = calculateStochK(params.candles, params.stochPeriod, params.stochSmoothK);
    final stochD = smoothStochD(stochK, params.stochSmoothD);

    return IndicatorResult(
      emaShort: emaShort,
      emaLong: emaLong,
      stochK: stochK,
      stochD: stochD,
    );
  } catch (e) {
    log("Indicator isolate error: $e");
    rethrow;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/isolate/isolate_helpers.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 49: lib/core/theme/app_theme.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/theme/app_theme.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 160.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import 'package:flutter/material.dart';

class AppTheme {
  static ThemeData lightTheme = ThemeData.light();
  static ThemeData darkTheme = ThemeData.dark();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/theme/app_theme.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 50: lib/core/markets/search_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/markets/search_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 345.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'market_definitions.dart';

class MarketSearchFilter {
  static List<Instrument> search(List<Instrument> all, String q) {
    return all.where((i) => i.symbol.contains(q.toUpperCase())).toList();
  }

  static List<Instrument> sortByName(List<Instrument> all) {
    all.sort((a, b) => a.symbol.compareTo(b.symbol));
    return all;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/markets/search_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 51: lib/core/markets/filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/markets/filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 184.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import 'market_definitions.dart';

class MarketFilter {
  static List<Instrument> byType(List<Instrument> list, MarketType type) =>
      list.where((i) => i.type == type).toList();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/markets/filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 52: lib/core/markets/market_definitions.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/markets/market_definitions.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 161.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

enum MarketType { forex, crypto, commodity, stock }

class Instrument {
  final String symbol;
  final MarketType type;

  Instrument(this.symbol, this.type);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/markets/market_definitions.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 53: lib/core/state/subscription_cleanup_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/subscription_cleanup_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 309.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:async';

mixin SubscriptionCleanupFix {
  final List<StreamSubscription> _subs = [];

  void addSub(StreamSubscription sub) => _subs.add(sub);

  @override
  Future<void> close() async {
    for (final s in _subs) {
      await s.cancel();
    }
    _subs.clear();
    await super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/subscription_cleanup_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 54: lib/core/state/bloc_close_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/bloc_close_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 157.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

mixin BlocCloseFix on BlocBase {
  @override
  Future<void> close() async {
    await super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/bloc_close_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 55: lib/core/state/mode_mutex.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/mode_mutex.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 187.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class ModeMutex {
  bool _replayActive = false;

  bool get canStartLive => !_replayActive;

  void startReplay() => _replayActive = true;
  void stopReplay() => _replayActive = false;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/mode_mutex.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 56: lib/core/state/debounce_helper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/debounce_helper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 296.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class DebounceHelper<T> {
  final Duration delay;
  Timer? _timer;
  void Function(T)? _action;

  DebounceHelper(this.delay);

  void call(T value, void Function(T) action) {
    _action = action;
    _timer?.cancel();
    _timer = Timer(delay, () => action(value));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/debounce_helper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 57: lib/core/state/event_queue.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/event_queue.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 449.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'dart:async';

class EventQueue<T> {
  final _queue = StreamController<T>();
  bool _processing = false;

  void add(T event) {
    _queue.add(event);
    if (!_processing) _process();
  }

  void _process() async {
    _processing = true;
    await for (final e in _queue.stream) {
      // ÙŠÙ…Ø±Ù‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ù€ Bloc Ø£Ùˆ Handler Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    }
    _processing = false;
  }

  void dispose() => _queue.close();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/event_queue.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 58: lib/core/state/shared/latest_price_holder_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/shared/latest_price_holder_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 122.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class LatestPriceHolderFix {
  double? _price;

  void update(double v) => _price = v;
  double? get current => _price;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/shared/latest_price_holder_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 59: lib/core/state/shared/price_volume_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/shared/price_volume_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 284.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:flutter/foundation.dart';

class PriceVolumeState with ChangeNotifier {
  double _price = 0, _volume = 0;

  double get price => _price;
  double get volume => _volume;

  void update(double p, double v) {
    _price = p;
    _volume = v;
    notifyListeners();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/shared/price_volume_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 60: lib/core/state/bloc/bloc_event_cancel_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/bloc/bloc_event_cancel_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 405.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';

mixin BlocEventCancelFix<Event> on Bloc<Event, dynamic> {
  final List<StreamSubscription> _evtSubs = [];

  void addCancelable(StreamSubscription sub) => _evtSubs.add(sub);

  @override
  Future<void> close() async {
    for (final s in _evtSubs) {
      await s.cancel();
    }
    _evtSubs.clear();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/bloc/bloc_event_cancel_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 61: lib/core/state/tab/tab_state_preserver.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/tab/tab_state_preserver.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 251.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'package:flutter/widgets.dart';

class TabStatePreserver with WidgetsBindingObserver {
  final Map<String, dynamic> _states = {};

  void save(String key, dynamic state) => _states[key] = state;
  dynamic restore(String key) => _states[key];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/tab/tab_state_preserver.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 62: lib/core/state/event/event_queue_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/event/event_queue_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 413.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';

class EventQueueFix<T> {
  final _queue = StreamController<T>();
  bool _processing = false;

  void add(T evt) { _queue.add(evt); if (!_processing) _process(); }

  void _process() async {
    _processing = true;
    await for (final e in _queue.stream) {
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¯Ø« Ø¯Ø§Ø®Ù„ Bloc Ø£Ùˆ Handler
    }
    _processing = false;
  }

  void dispose() => _queue.close();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/event/event_queue_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 63: lib/core/state/paging/paging_tracker.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/paging/paging_tracker.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 188.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class PagingTracker {
  final Set<int> _loadedPages = {};

  bool canLoad(int page) {
    if (_loadedPages.contains(page)) return false;
    _loadedPages.add(page);
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/paging/paging_tracker.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 64: lib/core/state/paging/paging_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/paging/paging_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 183.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class PagingGuard {
  final Set<int> loadedPages = {};

  bool canLoad(int page) {
    if (loadedPages.contains(page)) return false;
    loadedPages.add(page);
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/paging/paging_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 65: lib/core/state/empty/empty_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/empty/empty_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 163.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

abstract class EmptyState {}

class LoadingState {}

class HasDataState<T> {
  final T data;
  HasDataState(this.data);
}

class NoDataState extends EmptyState {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/empty/empty_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 66: lib/core/state/guard/state_transition_locker.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/state/guard/state_transition_locker.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 225.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class StateTransitionLocker {
  bool _processing = false;

  Future<void> safeTransition(Future<void> Function() fn) async {
    if (_processing) return;
    _processing = true;
    await fn();
    _processing = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/state/guard/state_transition_locker.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 67: lib/core/chart/chart_controller_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart/chart_controller_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 313.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter/animation.dart';

class ChartControllerManager {
  final List<AnimationController> _controllers = [];

  void register(AnimationController c) {
    _controllers.add(c);
  }

  void disposeAll() {
    for (final c in _controllers) {
      c.dispose();
    }
    _controllers.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart/chart_controller_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 68: lib/core/chart/update/batch_update_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart/update/batch_update_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 401.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';

class BatchUpdateManager {
  final Duration delay;
  Timer? _timer;
  List<dynamic> _pending = [];

  BatchUpdateManager({this.delay = const Duration(milliseconds: 50)});

  void add(dynamic data, void Function(List<dynamic>) callback) {
    _pending.add(data);
    _timer?.cancel();
    _timer = Timer(delay, () {
      callback(_pending);
      _pending.clear();
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart/update/batch_update_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 69: lib/core/chart/filter/chart_filter_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart/filter/chart_filter_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 272.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import '../../core/models/candle_entity.dart';

class ChartFilterFix {
  static List<CandleEntity> applyRange(
      List<CandleEntity> data, double minPrice, double maxPrice) {
    return data.where((c) =>
        c.high >= minPrice && c.low <= maxPrice).toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart/filter/chart_filter_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 70: lib/core/chart/gap/gap_fill_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart/gap/gap_fill_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1022.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import '../../../../core/models/candle_entity.dart';

class GapFillManager {
  static List<CandleEntity> fill(
      List<CandleEntity> data, Duration interval) {
    final List<CandleEntity> filled = [];
    if (data.isEmpty) return filled;

    for (int i = 0; i < data.length - 1; i++) {
      final current = data[i];
      final next = data[i + 1];
      filled.add(current);

      final gap = next.timeUtc
          .difference(current.timeUtc)
          .inMilliseconds;
      final step = interval.inMilliseconds;

      if (gap > step) {
        final missing = (gap / step).floor() - 1;
        for (int j = 1; j <= missing; j++) {
          final t = current.timeUtc.add(Duration(milliseconds: step * j));
          filled.add(CandleEntity(
            timeUtc: t,
            open: current.close,
            high: current.close,
            low: current.close,
            close: current.close,
            volume: 0,
          ));
        }
      }
    }
    filled.add(data.last);
    return filled;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart/gap/gap_fill_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 71: lib/core/chart/data/chart_data_stitcher.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart/data/chart_data_stitcher.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 477.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import '../../../../core/models/candle_entity.dart';

class ChartDataStitcher {
  List<CandleEntity> merge(
      List<CandleEntity> history, List<CandleEntity> live) {
    final Map<int, CandleEntity> map = {};
    for (final c in history) {
      map[c.timeUtc.millisecondsSinceEpoch] = c;
    }
    for (final c in live) {
      map[c.timeUtc.millisecondsSinceEpoch] = c;
    }
    final keys = map.keys.toList()..sort();
    return keys.map((k) => map[k]!).toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart/data/chart_data_stitcher.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 72: lib/core/utils/debounce.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/utils/debounce.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 273.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';

class Debouncer {
  final Duration delay;
  Timer? _timer;

  Debouncer(this.delay);

  void call(void Function() action) {
    _timer?.cancel();
    _timer = Timer(delay, action);
  }

  void cancel() {
    _timer?.cancel();
    _timer = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/utils/debounce.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 73: lib/core/utils/secure_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/utils/secure_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class SecureStorage {
  // Singleton
  static final _storage = FlutterSecureStorage();

  static const _keyApiToken = "secure_oanda_api_token";
  static const _keyAccountId = "secure_oanda_account_id";

  /// Save credentials securely
  static Future<void> saveCredentials({
    required String apiToken,
    required String accountId,
  }) async {
    await _storage.write(key: _keyApiToken, value: apiToken);
    await _storage.write(key: _keyAccountId, value: accountId);
  }

  /// Read secure keys
  static Future<Map<String, String>?> readCredentials() async {
    final token = await _storage.read(key: _keyApiToken);
    final accId = await _storage.read(key: _keyAccountId);

    if (token == null || accId == null) return null;

    return {
      "apiToken": token,
      "accountId": accId,
    };
  }

  /// Delete secure keys
  static Future<void> clearCredentials() async {
    await _storage.delete(key: _keyApiToken);
    await _storage.delete(key: _keyAccountId);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/utils/secure_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 74: lib/core/utils/network_checker.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/utils/network_checker.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 279.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'dart:io';

class NetworkChecker {
  static Future<bool> isConnected() async {
    try {
      final result = await InternetAddress.lookup('example.com');
      return result.isNotEmpty && result[0].rawAddress.isNotEmpty;
    } catch (_) {
      return false;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/utils/network_checker.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 75: lib/core/utils/notification_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/utils/notification_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  static final _notifier = FlutterLocalNotificationsPlugin();

  static Future<void> init() async {
    final androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');

    final initSettings = InitializationSettings(
      android: androidSettings,
    );

    await _notifier.initialize(
      initSettings,
      onDidReceiveNotificationResponse: (response) {
        // handle notification tapped logic if needed
      },
    );
  }

  static Future<void> showNotification({
    required int id,
    required String title,
    required String body,
  }) async {
    const androidDetails = AndroidNotificationDetails(
      'trade_channel',
      'Trade Notifications',
      channelDescription: 'Notifications for trade signals and events',
      importance: Importance.high,
      priority: Priority.high,
      ticker: 'ticker',
    );

    const details = NotificationDetails(android: androidDetails);

    await _notifier.show(id, title, body, details);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/utils/notification_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 76: lib/core/utils/logger.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/utils/logger.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 141.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'package:logger/logger.dart';

var appLogger = Logger(
  printer: PrettyPrinter(
    methodCount: 0,
    errorMethodCount: 5,
  ),
);

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/utils/logger.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 77: lib/core/utils/settings_debouncer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/utils/settings_debouncer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 263.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:async';

class SettingsDebouncer {
  final Duration delay;
  Timer? _timer;

  SettingsDebouncer({this.delay = const Duration(milliseconds: 300)});

  void save(void Function() saveFn) {
    _timer?.cancel();
    _timer = Timer(delay, saveFn);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/utils/settings_debouncer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 78: lib/core/network/retry_interceptor.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/retry_interceptor.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 377.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:dio/dio.dart';
import 'package:dio_retry/dio_retry.dart';
import 'package:dio_retry/strategies/exponential_retry_strategy.dart';

class RestRetryInterceptor {
  static void apply(Dio dio) {
    dio.interceptors.add(
      RetryInterceptor(
        dio: dio,
        logPrint: print,
        retryDelays: ExponentialRetryStrategy().delays,
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/retry_interceptor.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 79: lib/core/network/rest_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 40.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

// rest_client.dart
class RestClient {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 80: lib/core/network/ws_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 38.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

// ws_manager.dart
class WSManager {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 81: lib/core/network/markets_api.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/markets_api.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 358.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'rest_client.dart';
import '../models/dto/instrument_dto.dart';

class MarketsApi {
  final RestClient client;

  MarketsApi(this.client);

  Future<List<InstrumentDto>> fetchAll() async {
    final res = await client.get("/instruments");
    return (res['instruments'] as List)
        .map((j) => InstrumentDto.fromJson(j))
        .toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/markets_api.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 82: lib/core/network/rate_limit_interceptor.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rate_limit_interceptor.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 438.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:dio/dio.dart';

class RateLimitInterceptor extends Interceptor {
  @override
  void onError(DioError err, ErrorInterceptorHandler handler) {
    if (err.response?.statusCode == 429) {
      final retryAfter = int.tryParse(err.response?.headers.value('retry-after') ?? '1') ?? 1;
      Future.delayed(Duration(seconds: retryAfter), () {
        handler.next(err);
      });
      return;
    }
    handler.next(err);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rate_limit_interceptor.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 83: lib/core/network/oanda_stream_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda_stream_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 704.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 33
================================================================================


bool _disposed = false;
void startStreaming() {
  _connect();
}

void _connect() async {
  final channel = IOWebSocketChannel.connect(_url);

  channel.stream.listen((msg) {
    _lastReceivedTime = DateTime.now();
    _onMessage(msg);
  }, onError: (e) {
    if (!_disposed) Future.delayed(Duration(seconds: 2), () => _connect());
  }, onDone: () {
    if (!_disposed) Future.delayed(Duration(seconds: 2), () => _connect());
  });

  _startHeartbeatMonitor();
}

void _startHeartbeatMonitor() {
  Timer.periodic(Duration(seconds: 10), (t) {
    if (DateTime.now().difference(_lastReceivedTime).inSeconds > 30) {
      // reconnect
      _connect();
    }
  });
}

void dispose() {
  _disposed = true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda_stream_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 84: lib/core/network/error_utils.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/error_utils.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 524.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:dio/dio.dart';

enum OandaErrorType { network, client, server, rateLimit, unknown }

OandaErrorType classifyError(DioError e) {
  if (e.type == DioErrorType.connectTimeout || e.type == DioErrorType.receiveTimeout) {
    return OandaErrorType.network;
  }
  final status = e.response?.statusCode ?? 0;
  if (status >= 400 && status < 500) return OandaErrorType.client;
  if (status == 429) return OandaErrorType.rateLimit;
  if (status >= 500) return OandaErrorType.server;
  return OandaErrorType.unknown;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/error_utils.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 85: lib/core/network/oanda_rest_config.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda_rest_config.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 221.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class OandaConfig {
  static const bool useLive = false; // false = practice, true = live
  static String get baseUrl => useLive
      ? "https://api-fxtrade.oanda.com/v3"
      : "https://api-fxpractice.oanda.com/v3";
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda_rest_config.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 86: lib/core/network/oanda_rest_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda_rest_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 818.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================


  Future<Map<String, dynamic>> fetchOpenPositions() async {
    final endpoint = "/accounts/\$accountId/openPositions";
    final response = await _dio.get(endpoint);
    return response.data;
  }

  Future<Map<String, dynamic>> closePosition(String instrument) async {
    final endpoint = "/accounts/\$accountId/positions/\$instrument/close";
    final response = await _dio.put(endpoint);
    return response.data;
  }

  Future<Map<String, dynamic>> modifyPosition(String instrument, Map<String, dynamic> body) async {
    final endpoint = "/accounts/\$accountId/positions/\$instrument";
    final response = await _dio.put(endpoint, data: body);
    return response.data;
  }

  void setTokenExpiredCallback(Function()? callback) {
    _tokenExpiredCallback = callback;
  }

  Function()? _tokenExpiredCallback;

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda_rest_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 87: lib/core/network/error_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/error_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 359.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class NetworkErrorHandler {
  static String parseError(dynamic error) {
    if (error.toString().contains('SocketException')) return "Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
    if (error.toString().contains('TimeoutException')) return "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„.";
    return "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/error_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 88: lib/core/network/network_listener_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/network_listener_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 595.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:flutter/material.dart';
import 'network_observer.dart';

class NetworkStateListener extends StatefulWidget {
  final Widget child;
  NetworkStateListener(this.child);

  @override
  _NetworkStateListenerState createState() => _NetworkStateListenerState();
}

class _NetworkStateListenerState extends State<NetworkStateListener> {
  @override
  void initState() {
    super.initState();
    NetworkObserver().stream.listen((state) {
      setState(() {}); // triggers rebuild to show Online/Offline
    });
  }

  @override
  Widget build(BuildContext context) => widget.child;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/network_listener_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 89: lib/core/network/fallback_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/fallback_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 349.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

enum SourceStatus { healthy, degraded, offline }

class FallbackManager {
  SourceStatus status = SourceStatus.healthy;

  void markDegraded() => status = SourceStatus.degraded;
  void markOffline() => status = SourceStatus.offline;
  void markHealthy() => status = SourceStatus.healthy;

  bool shouldUseRest() => status != SourceStatus.healthy;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/fallback_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 90: lib/core/network/rest_error.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest_error.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 92.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

class RestError implements Exception {
  final String message;
  RestError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest_error.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 91: lib/core/network/network_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/network_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 543.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'dart:async';
import 'package:connectivity_plus/connectivity_plus.dart';

enum NetworkStatus { online, offline }

class NetworkService {
  final _controller = StreamController<NetworkStatus>.broadcast();

  NetworkService() {
    Connectivity().onConnectivityChanged.listen((status) {
      if (status == ConnectivityResult.none) {
        _controller.add(NetworkStatus.offline);
      } else {
        _controller.add(NetworkStatus.online);
      }
    });
  }

  Stream<NetworkStatus> get networkStatusStream => _controller.stream;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/network_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 92: lib/core/network/network_observer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/network_observer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 455.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'dart:async';
import 'package:connectivity_plus/connectivity_plus.dart';

enum NetState { online, offline }

class NetworkObserver {
  final _controller = StreamController<NetState>.broadcast();

  NetworkObserver() {
    Connectivity().onConnectivityChanged.listen((status) {
      _controller.add(status == ConnectivityResult.none
        ? NetState.offline : NetState.online);
    });
  }

  Stream<NetState> get stream => _controller.stream;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/network_observer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 93: lib/core/network/security/http_pinning_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/security/http_pinning_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 682.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'dart:io';
import 'package:http/io_client.dart';
import '../pinning/pin_store.dart';
import '../../settings/mode_storage.dart';
import '../../settings/server_mode.dart';

class HttpPinningClient {
  static Future<IOClient> create() async {
    final mode = await ModeStorage.load();
    final pins = mode == ServerMode.live
        ? [...PinStore.liveRestPins, ...PinStore.liveStreamPins]
        : [...PinStore.sandboxRestPins, ...PinStore.sandboxStreamPins];

    final httpClient = HttpClient()
      ..badCertificateCallback = (cert, host, port) {
        final sha256 = cert.sha256;
        return pins.contains(sha256);
      };

    return IOClient(httpClient);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/security/http_pinning_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 94: lib/core/network/security/certificate_pinning.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/security/certificate_pinning.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 469.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:io';
import 'package:http/io_client.dart';

class CertificatePinning {
  static HttpClient getPinnedHttpClient() {
    final client = HttpClient();
    client.badCertificateCallback =
        (X509Certificate cert, String host, int port) {
      // Ø¶Ø¹ Ø§Ù„Ù€ SHA256 Pins Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ OANDA Ù‡Ù†Ø§
      return cert.sha256 == "SHA256_PIN_OF_OANDA";
    };
    return client;
  }

  static IOClient getIOClient() => IOClient(getPinnedHttpClient());
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/security/certificate_pinning.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 95: lib/core/network/security/pinning/ws_pinned_io.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/security/pinning/ws_pinned_io.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 754.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'dart:io';
import 'package:web_socket_channel/io.dart';
import '../pinning/pin_store.dart';
import '../../settings/mode_storage.dart';
import '../../settings/server_mode.dart';

class WsPinningFactory {
  static Future<IOWebSocketChannel> connectWithPinning(
      Uri uri, Map<String, dynamic> headers) async {
    final mode = await ModeStorage.load();
    final pins = mode == ServerMode.live
        ? PinStore.liveStreamPins
        : PinStore.sandboxStreamPins;

    final client = HttpClient()
      ..badCertificateCallback = (cert, host, port) {
        return pins.contains(cert.sha256);
      };

    return IOWebSocketChannel.connect(
      uri,
      customClient: client,
      headers: headers.cast<String, dynamic>(),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/security/pinning/ws_pinned_io.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 96: lib/core/network/security/pinning/pin_store.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/security/pinning/pin_store.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 531.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

class PinStore {
  /// **Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰**
  static const List<String> sandboxRestPins = [
    "REPLACE_WITH_SANDBOX_REST_SHA256_BASE64",
  ];

  static const List<String> sandboxStreamPins = [
    "REPLACE_WITH_SANDBOX_STREAM_SHA256_BASE64",
  ];

  static const List<String> liveRestPins = [
    "REPLACE_WITH_LIVE_REST_SHA256_BASE64",
  ];

  static const List<String> liveStreamPins = [
    "REPLACE_WITH_LIVE_STREAM_SHA256_BASE64",
  ];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/security/pinning/pin_store.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 97: lib/core/network/error/network_error_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/error/network_error_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 967.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 35
================================================================================

import 'dart:io';

enum NetworkErrorType {
  noConnection,
  timeout,
  serverError,
  unknown
}

class NetworkErrorHandler {
  static NetworkErrorType classify(error) {
    if (error is SocketException) {
      return NetworkErrorType.noConnection;
    } else if (error is TimeoutException) {
      return NetworkErrorType.timeout;
    } else if (error.toString().contains('500')) {
      return NetworkErrorType.serverError;
    }
    return NetworkErrorType.unknown;
  }

  static String message(NetworkErrorType type) {
    switch (type) {
      case NetworkErrorType.noConnection:
        return "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
      case NetworkErrorType.timeout:
        return "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„.";
      case NetworkErrorType.serverError:
        return "Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….";
      case NetworkErrorType.unknown:
      default:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©.";
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/error/network_error_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 98: lib/core/network/retry/network_bounce_handler_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/retry/network_bounce_handler_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 270.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'dart:async';

class NetworkBounceHandlerFix {
  Timer? _bounceTimer;

  void onNetworkChange(bool isOnline, void Function() onReconnect) {
    _bounceTimer?.cancel();
    if (isOnline) {
      _bounceTimer = Timer(Duration(seconds: 1), onReconnect);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/retry/network_bounce_handler_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 99: lib/core/network/retry/retry_with_backoff.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/retry/retry_with_backoff.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 357.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

Future<T> retryWithBackoff<T>(
    Future<T> Function() fn, {
    int retries = 3,
    Duration delay = const Duration(milliseconds: 500),
  }) async {
  try {
    return await fn();
  } catch (e) {
    if (retries > 0) {
      await Future.delayed(delay);
      return retryWithBackoff(fn, retries: retries - 1, delay: delay * 2);
    }
    rethrow;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/retry/retry_with_backoff.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 100: lib/core/network/retry/retry_limiter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/retry/retry_limiter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 464.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'dart:async';

class RetryLimiter {
  final int maxAttempts;
  final Duration baseDelay;

  RetryLimiter({this.maxAttempts = 3, this.baseDelay = const Duration(seconds: 1)});

  Future<T?> run<T>(Future<T> Function() fn) async {
    int attempts = 0;

    while (attempts < maxAttempts) {
      try {
        return await fn();
      } catch (e) {
        attempts++;
        await Future.delayed(baseDelay * attempts);
      }
    }
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/retry/retry_limiter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 101: lib/core/network/retry/retry_policy.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/retry/retry_policy.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 62
================================================================================

import 'dart:async';

enum RetryErrorType {
  timeout,
  server,
  client,
  unknown,
}

class RetryPolicy {
  final int maxAttempts;
  final Duration baseDelay;
  final bool enableJitter;

  RetryPolicy({
    this.maxAttempts = 5,
    this.baseDelay = const Duration(seconds: 1),
    this.enableJitter = true,
  });

  Duration _jitter(Duration d) {
    if (!enableJitter) return d;
    final millis = d.inMilliseconds;
    final jitter = (millis * 0.5).toInt();
    return Duration(milliseconds: millis + jitter);
  }

  Future<T> execute<T>(
    Future<T> Function() action, {
    required void Function(int attempt, Duration delay, RetryErrorType type) onRetry,
  }) async {
    int attempts = 0;
    Duration delay = baseDelay;

    while (true) {
      try {
        return await action();
      } catch (e) {
        attempts++;
        if (attempts >= maxAttempts) rethrow;

        final errorType = _classifyError(e);

        // Logging retry attempt
        onRetry(attempts, delay, errorType);

        await Future.delayed(_jitter(delay));

        // Exponential backoff
        delay = Duration(seconds: delay.inSeconds * 2);
      }
    }
  }

  RetryErrorType _classifyError(Object error) {
    final msg = error.toString().toLowerCase();
    if (msg.contains("timeout")) return RetryErrorType.timeout;
    if (msg.contains("5")) return RetryErrorType.server;
    if (msg.contains("4")) return RetryErrorType.client;
    return RetryErrorType.unknown;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/retry/retry_policy.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 102: lib/core/network/ws/ws_reconnect_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_reconnect_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 375.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';
import 'ws_reconnect_manager.dart';

class WsReconnectFix {
  final WsReconnectManager manager;
  Timer? _retry;

  WsReconnectFix(this.manager);

  void attempt(void Function(dynamic) onData) {
    _retry?.cancel();
    _retry = Timer.periodic(Duration(seconds: 5), (_) {
      manager.connect(onData);
    });
  }

  void stop() => _retry?.cancel();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_reconnect_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 103: lib/core/network/ws/ws_reconnect_guard_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_reconnect_guard_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 387.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:async';
import 'ws_reconnect_manager.dart';

class WsReconnectGuardFix {
  final WsReconnectManager manager;
  bool _attempting = false;

  WsReconnectGuardFix(this.manager);

  void attemptReconnect(void Function(dynamic) onData) {
    if (_attempting) return;
    _attempting = true;
    manager.connect((msg) {
      onData(msg);
      _attempting = false;
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_reconnect_guard_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 104: lib/core/network/ws/ws_reconnect_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_reconnect_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 722.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class WsReconnectManager {
  final String url;
  WebSocketChannel? _channel;
  Timer? _reconnectTimer;

  WsReconnectManager(this.url);

  void connect(void Function(dynamic) onData) {
    _channel = WebSocketChannel.connect(Uri.parse(url));
    _channel?.stream.listen(onData,
        onError: (_) => _scheduleReconnect(onData),
        onDone: () => _scheduleReconnect(onData));
  }

  void _scheduleReconnect(void Function(dynamic) onData) {
    _reconnectTimer?.cancel();
    _reconnectTimer = Timer(Duration(seconds: 5), () => connect(onData));
  }

  void dispose() {
    _channel?.sink.close();
    _reconnectTimer?.cancel();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_reconnect_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 105: lib/core/network/ws/ws_timeframe_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_timeframe_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 299.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'ws_channel_manager.dart';

class WsTimeframeGuard {
  final WSChannelManager manager;

  WsTimeframeGuard(this.manager);

  void switchTimeframe(String newSymbol, String url) {
    manager.dispose(); // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ø§ØªØµØ§Ù„ Ø³Ø§Ø¨Ù‚
    manager.connectForSymbol(newSymbol, url);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_timeframe_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 106: lib/core/network/ws/ws_disconnect_on_offline.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_disconnect_on_offline.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 349.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'ws_channel_manager.dart';
import '../network_observer.dart';

class WsDisconnectOnOffline {
  final WSChannelManager manager;
  final NetworkObserver observer;

  WsDisconnectOnOffline(this.manager, this.observer) {
    observer.stream.listen((state) {
      if (state == NetState.offline) {
        manager.dispose();
      }
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_disconnect_on_offline.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 107: lib/core/network/ws/ws_channel_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_channel_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 598.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:web_socket_channel/web_socket_channel.dart';

class WSChannelManager {
  WebSocketChannel? _channel;
  String? _currentSymbol;

  WebSocketChannel? get channel => _channel;

  void connectForSymbol(String symbol, String url) {
    if (_currentSymbol == symbol) {
      return; // Already connected for same
    }
    _disconnect();
    _currentSymbol = symbol;
    _channel = WebSocketChannel.connect(Uri.parse("$url?symbol=$symbol"));
  }

  void _disconnect() {
    _channel?.sink.close();
    _channel = null;
    _currentSymbol = null;
  }

  void dispose() => _disconnect();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_channel_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 108: lib/core/network/ws/ws_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/ws_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 354.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../../log/logger_service.dart';

class WsManager {
  bool _connected = false;

  Future<void> connect(String url) async {
    LoggerService.log('Connecting to WS: $url');
    _connected = true;
  }

  Future<void> disconnect() async {
    LoggerService.log('WS disconnected');
    _connected = false;
  }

  bool get isConnected => _connected;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/ws_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 109: lib/core/network/ws/transport/ws_transport_retry.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/transport/ws_transport_retry.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 661.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter/foundation.dart';
import '../ws_transport.dart';
import '../../retry/retry_policy.dart';

class WsTransportRetry {
  final RetryPolicy _retry = RetryPolicy(maxAttempts: 4);

  Future<void> connectWithRetry({
    required String accountId,
    required String instrument,
    required Function(dynamic) onData,
    required WsTransport transport,
  }) async {
    await _retry.execute(() {
      return transport.connect(
        accountId: accountId,
        instrument: instrument,
        onData: onData,
      );
    }, onRetry: (attempt, delay, type) {
      debugPrint("WS RETRY \$attempt delay=\$delay type=\$type");
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/transport/ws_transport_retry.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 110: lib/core/network/ws/transport/ws_transport.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/transport/ws_transport.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 50
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../../pinning/ws_pinned_io.dart';
import '../../../core/settings/server_mode.dart';
import '../../../core/settings/mode_storage.dart';
import '../../../logging/audit_logger.dart';

typedef WsOnMsg = void Function(dynamic);

class WsTransport {
  WebSocketChannel? _channel;
  StreamSubscription? _sub;
  bool _manuallyClosed = false;

  Future<String> _baseUrl() async {
    final mode = await ModeStorage.load();
    return mode == ServerMode.live
        ? "wss://stream-fxtrade.oanda.com/v3"
        : "wss://stream-fxpractice.oanda.com/v3";
  }

  Future<void> connect({
    required String accountId,
    required String instruments,
    required Map<String, String> headers,
    required WsOnMsg onData,
  }) async {
    final base = await _baseUrl();
    final url =
        "\$base/accounts/\$accountId/pricing/stream?instruments=\$instruments";

    AuditLogger.log("WS CONNECT", {"url": url});

    _channel = await WsPinnedFactory.connectWithPinning(
      Uri.parse(url),
      headers,
    );

    _sub = _channel!.stream.listen((msg) {
      onData(msg);
    }, onError: (e) {
      AuditLogger.log("WS ERROR", {"error": e.toString()});
    });
  }

  void disconnect() {
    _sub?.cancel();
    _channel?.sink.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/transport/ws_transport.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 111: lib/core/network/ws/parsers/safe_ws_parser.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/parsers/safe_ws_parser.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 236.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import '../../../../core/data/sanitizer/data_sanitizer.dart';

Map<String, dynamic>? safeWS(Map<String, dynamic>? data) {
  if (data == null) return null;
  if (!DataSanitizer.isValidNumber(data['price'])) return null;
  return data;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/parsers/safe_ws_parser.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 112: lib/core/network/ws/parsers/tick_parser_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/parsers/tick_parser_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 196.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

Map<String, dynamic>? safeParse(dynamic data) {
  try {
    if (data == null || data['price'] == null) return null;
    return data as Map<String, dynamic>;
  } catch (_) {
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/parsers/tick_parser_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 113: lib/core/network/ws/parsers/safe_depth_parser.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/parsers/safe_depth_parser.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 257.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

Map<String, dynamic>? parseSafeDepth(Map<String, dynamic>? data) {
  if (data == null) return null;
  if (!data.containsKey('bids') || !data.containsKey('asks')) return null;
  return {
    'bids': data['bids'] ?? [],
    'asks': data['asks'] ?? [],
  };
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/parsers/safe_depth_parser.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 114: lib/core/network/ws/manager/ws_switch_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/manager/ws_switch_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 644.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class WsSwitchManager {
  WebSocketChannel? _currentChannel;
  StreamSubscription? _currentSub;

  void switchTo(String url, void Function(dynamic) onData) {
    // Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    _currentSub?.cancel();
    _currentChannel?.sink.close();

    // ÙØªØ­ Ø¬Ø¯ÙŠØ¯
    _currentChannel = WebSocketChannel.connect(Uri.parse(url));
    _currentSub = _currentChannel!.stream.listen(onData);
  }

  Future<void> dispose() async {
    await _currentSub?.cancel();
    _currentChannel?.sink.close();
    _currentChannel = null;
    _currentSub = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/manager/ws_switch_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 115: lib/core/network/ws/security/ws_certificate_pinning.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/security/ws_certificate_pinning.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 287.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'dart:io';
import 'package:web_socket_channel/io.dart';

class WsCertPinning {
  static IOWebSocketChannel connectPinned(
      String url, SecurityContext context) {
    return IOWebSocketChannel.connect(
      url,
      customClient: HttpClient(context: context),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/security/ws_certificate_pinning.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 116: lib/core/network/ws/registry/ws_subscription_registry.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/registry/ws_subscription_registry.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 281.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:async';

class WsSubscriptionRegistry {
  final List<StreamSubscription> _subs = [];

  void register(StreamSubscription sub) => _subs.add(sub);

  Future<void> clearAll() async {
    for (final sub in _subs) {
      await sub.cancel();
    }
    _subs.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/registry/ws_subscription_registry.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 117: lib/core/network/ws/error/ws_error_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/error/ws_error_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 310.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'package:web_socket_channel/web_socket_channel.dart';

class WsErrorHandler {
  void bind(WebSocketChannel channel, void Function(dynamic) onData) {
    channel.stream.listen(
      (msg) => onData(msg),
      onError: (_) => channel.sink.close(),
      onDone: () => channel.sink.close(),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/error/ws_error_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 118: lib/core/network/ws/smart/ws_smart_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/smart/ws_smart_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 52
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../network_observer.dart';

/// Smart WS Manager: handles connect/disconnect cleanly,
/// autoâ€‘reconnect, disposals on app pause, and prevents leaks.
class WSSmartManager {
  WebSocketChannel? _channel;
  final String url;
  final NetworkObserver _observer;
  Timer? _reconnectTimer;

  bool _connected = false;

  WSSmartManager(this.url, this._observer) {
    _observer.stream.listen((state) {
      if (state == NetState.offline) {
        _disconnect();
      } else {
        _scheduleReconnect();
      }
    });
  }

  void connect(void Function(dynamic) onData) {
    _disconnect(); // always clean before new
    _channel = WebSocketChannel.connect(Uri.parse(url));
    _channel!.stream.listen(onData,
        onError: (_) => _scheduleReconnect(),
        onDone: () => _scheduleReconnect());
    _connected = true;
  }

  void _scheduleReconnect() {
    _reconnectTimer?.cancel();
    _reconnectTimer = Timer(const Duration(seconds: 5), () {
      if (_connected) return;
      connect((_) {});
    });
  }

  void _disconnect() {
    _reconnectTimer?.cancel();
    _channel?.sink.close();
    _channel = null;
    _connected = false;
  }

  void dispose() {
    _disconnect();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/smart/ws_smart_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 119: lib/core/network/ws/smart/ws_smart_reconnect_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/smart/ws_smart_reconnect_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 772.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class WSSmartReconnectFix {
  WebSocketChannel? _chan;
  final String url;
  Timer? _retry;
  int _fails = 0;

  WSSmartReconnectFix(this.url);

  void connect(void Function(dynamic) onData) {
    _chan?.sink.close();
    _chan = WebSocketChannel.connect(Uri.parse(url));
    _chan!.stream.listen(onData, onError: (_) => scheduleReconnect(onData),
        onDone: () => scheduleReconnect(onData));
    _fails = 0;
  }

  void scheduleReconnect(void Function(dynamic) onData) {
    _retry?.cancel();
    _fails++;
    final delay = Duration(seconds: 2 * _fails);
    _retry = Timer(delay, () => connect(onData));
  }

  void dispose() {
    _retry?.cancel();
    _chan?.sink.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/smart/ws_smart_reconnect_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 120: lib/core/network/ws/lifecycle/ws_lifecycle_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/lifecycle/ws_lifecycle_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 362.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter/widgets.dart';
import '../ws_channel_manager.dart';

class WsLifecycleHandler extends WidgetsBindingObserver {
  final WSChannelManager manager;

  WsLifecycleHandler(this.manager);

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.paused) {
      manager.dispose();
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/lifecycle/ws_lifecycle_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 121: lib/core/network/ws/pipeline/ws_pipeline.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/pipeline/ws_pipeline.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 40.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

// ws_pipeline.dart
class WsPipeline {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/pipeline/ws_pipeline.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 122: lib/core/network/ws/backoff/ws_backoff_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/ws/backoff/ws_backoff_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 302.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class WsBackoffManager {
  int _attempts = 0;
  Timer? _timer;

  void scheduleReconnect(Function() reconnect) {
    _timer?.cancel();
    _attempts++;
    final wait = Duration(seconds: 2 * _attempts);
    _timer = Timer(wait, reconnect);
  }

  void reset() => _attempts = 0;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/ws/backoff/ws_backoff_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 123: lib/core/network/rest/cancelable_request.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/cancelable_request.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 294.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:async';

class CancelableRequest {
  bool _cancelled = false;

  void cancel() => _cancelled = true;

  Future<T?> execute<T>(Future<T> Function() fn) async {
    if (_cancelled) return null;
    final result = await fn();
    if (_cancelled) return null;
    return result;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/cancelable_request.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 124: lib/core/network/rest/rest_timeout.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/rest_timeout.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 227.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'dart:async';

extension HttpTimeout<T> on Future<T> {
  Future<T> withTimeout(Duration timeout) {
    return this.timeout(timeout, onTimeout: () {
      throw Exception("Request Timeout after \$timeout");
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/rest_timeout.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 125: lib/core/network/rest/rest_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/rest_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.9 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 79
================================================================================

import 'dart:convert';
import 'dart:async';
import 'package:http/http.dart' as http;

class RestClient {
  final String baseUrl;
  final Map<String, String> defaultHeaders;

  RestClient({
    required this.baseUrl,
    Map<String, String>? defaultHeaders,
  }) : defaultHeaders = defaultHeaders ?? {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        };

  Future<http.Response> get(
    String endpoint, {
    Map<String, String>? headers,
    Map<String, String>? query,
  }) async {
    final uri = Uri.parse(baseUrl + endpoint).replace(queryParameters: query);
    final mergedHeaders = {...defaultHeaders, ...?headers};

    final response = await http.get(uri, headers: mergedHeaders);
    _validateResponse(response);
    return response;
  }

  Future<http.Response> post(
    String endpoint, {
    Map<String, String>? headers,
    Object? body,
  }) async {
    final uri = Uri.parse(baseUrl + endpoint);
    final mergedHeaders = {...defaultHeaders, ...?headers};

    final response = await http.post(
      uri,
      headers: mergedHeaders,
      body: jsonEncode(body),
    );

    _validateResponse(response);
    return response;
  }

  Future<http.Response> delete(
    String endpoint, {
    Map<String, String>? headers,
  }) async {
    final uri = Uri.parse(baseUrl + endpoint);
    final mergedHeaders = {...defaultHeaders, ...?headers};

    final response = await http.delete(uri, headers: mergedHeaders);
    _validateResponse(response);
    return response;
  }

  void _validateResponse(http.Response response) {
    if (response.statusCode >= 400) {
      throw RestException(
        response.statusCode,
        response.body,
      );
    }
  }
}

class RestException implements Exception {
  final int statusCode;
  final String body;

  RestException(this.statusCode, this.body);

  @override
  String toString() =>
      'RestException(statusCode: $statusCode, body: $body)';
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/rest_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 126: lib/core/network/rest/guard/rest_fetch_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/guard/rest_fetch_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 235.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class RestFetchGuard {
  final Map<String, dynamic> _cache = {};

  bool shouldFetch(String key) => !_cache.containsKey(key);

  void save(String key, dynamic value) => _cache[key] = value;

  dynamic get(String key) => _cache[key];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/guard/rest_fetch_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 127: lib/core/network/rest/guard/safe_rest_response.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/guard/safe_rest_response.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 310.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:convert';
import 'package:http/http.dart' as http;

class SafeRestResponse {
  static Map<String, dynamic>? parse(http.Response res) {
    if (res.statusCode != 200) return null;
    try {
      return jsonDecode(res.body) as Map<String, dynamic>;
    } catch (_) {
      return null;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/guard/safe_rest_response.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 128: lib/core/network/rest/parsers/safe_api_parser.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/parsers/safe_api_parser.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 524.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../../core/data/sanitizer/data_sanitizer.dart';

class SafeApiParser {
  static Map<String, dynamic> parseCandle(Map<String, dynamic>? json) {
    if (json == null) return {};
    return {
      'time': json['time'] ?? '',
      'open': DataSanitizer.safeDouble(json['open']),
      'high': DataSanitizer.safeDouble(json['high']),
      'low': DataSanitizer.safeDouble(json['low']),
      'close': DataSanitizer.safeDouble(json['close']),
      'volume': DataSanitizer.safeDouble(json['volume']),
    };
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/parsers/safe_api_parser.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 129: lib/core/network/rest/parsers/safe_json_parser.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/parsers/safe_json_parser.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 165.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

T? safeJsonParse<T>(Map<String, dynamic>? json, String key) {
  if (json == null) return null;
  if (!json.containsKey(key)) return null;
  return json[key] as T;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/parsers/safe_json_parser.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 130: lib/core/network/rest/parsers/json_safe_helpers.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/parsers/json_safe_helpers.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 346.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

T safeParse<T>(dynamic value, T fallback) {
  try {
    if (value == null) return fallback;
    if (value is T) return value;
    if (T == double) return double.tryParse(value.toString()) as T? ?? fallback;
    if (T == int) return int.tryParse(value.toString()) as T? ?? fallback;
    return fallback;
  } catch (_) {
    return fallback;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/parsers/json_safe_helpers.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 131: lib/core/network/rest/parsers/safe_map_parser.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/parsers/safe_map_parser.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 182.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

T? parseSafe<T>(Map<String, dynamic>? json, String key) {
  if (json == null) return null;
  final val = json[key];
  if (val == null) return null;
  return val is T ? val : null;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/parsers/safe_map_parser.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 132: lib/core/network/rest/timeout/timeout_handler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/timeout/timeout_handler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 300.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:http/http.dart' as http;

class TimeoutHandler {
  final Duration timeout;

  TimeoutHandler(this.timeout);

  Future<http.Response?> run(Future<http.Response> Function() fn) async {
    try {
      return await fn().timeout(timeout);
    } catch (_) {
      return null;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/timeout/timeout_handler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 133: lib/core/network/rest/throttle/rest_throttle.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/rest/throttle/rest_throttle.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 317.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:async';

class RestThrottle {
  final Duration interval;
  DateTime _last = DateTime.fromMillisecondsSinceEpoch(0);

  RestThrottle(this.interval);

  bool canFetch() {
    if (DateTime.now().difference(_last) >= interval) {
      _last = DateTime.now();
      return true;
    }
    return false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/rest/throttle/rest_throttle.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 134: lib/core/network/http/rest_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/http/rest_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1006.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

import 'dart:convert';
import 'package:http/http.dart' as http;
import '../pinning/http_pinning_client.dart';
import '../../logging/audit_logger.dart';
import '../../core/settings/server_mode.dart';
import '../../core/settings/mode_storage.dart';

/// REST Client with Retry + Pinning
class RestClient {
  Future<String> _baseUrl() async {
    final mode = await ModeStorage.load();
    return mode == ServerMode.live
        ? "https://api-fxtrade.oanda.com/v3"
        : "https://api-fxpractice.oanda.com/v3";
  }

  Future<dynamic> get(String path,
      {Map<String, String>? headers}) async {
    final client = await HttpPinningClient.create();
    final url = "\${await _baseUrl()}\$path";

    AuditLogger.log("REST GET", {"url": url, "headers": headers});

    final res = await client.get(Uri.parse(url), headers: headers);

    if (res.statusCode < 200 || res.statusCode >= 300) {
      throw Exception("REST GET \${res.statusCode}: \${res.body}");
    }

    return jsonDecode(res.body);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/http/rest_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 135: lib/core/network/manager/network_mode_coordinator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/manager/network_mode_coordinator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 587.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'dart:async';
import '../network_observer.dart';

class NetworkModeCoordinator {
  bool _isOffline = false;
  final List<Function()> _onReconnectTasks = [];

  void updateState(NetState state) {
    if (state == NetState.offline) {
      _isOffline = true;
    } else {
      if (_isOffline) {
        _isOffline = false;
        _runReconnectTasks();
      }
    }
  }

  void scheduleOnReconnect(Function() task) {
    _onReconnectTasks.add(task);
  }

  void _runReconnectTasks() {
    for (final t in _onReconnectTasks) {
      t();
    }
    _onReconnectTasks.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/manager/network_mode_coordinator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 136: lib/core/network/pinning/http_pinning_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/pinning/http_pinning_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 592.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'dart:io';
import 'package:http/io_client.dart';
import '../../core/settings/server_mode.dart';
import '../../core/settings/mode_storage.dart';
import 'pin_store.dart';

class HttpPinningClient {
  static Future<IOClient> create() async {
    final mode = await ModeStorage.load();

    final httpClient = HttpClient()
      ..badCertificateCallback = (cert, host, port) {
        final pins = mode == ServerMode.live
            ? PinStore.liveRestPins
            : PinStore.sandboxRestPins;
        return pins.contains(cert.sha256);
      };
    return IOClient(httpClient);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/pinning/http_pinning_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 137: lib/core/network/pinning/ws_pinned_io.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/pinning/ws_pinned_io.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 728.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'dart:io';
import 'package:web_socket_channel/io.dart';
import '../../core/settings/server_mode.dart';
import '../../core/settings/mode_storage.dart';
import 'pin_store.dart';

class WsPinnedFactory {
  static Future<IOWebSocketChannel> connectWithPinning(
      Uri uri, Map<String, dynamic> headers) async {
    final mode = await ModeStorage.load();
    final pins = mode == ServerMode.live
        ? PinStore.liveStreamPins
        : PinStore.sandboxStreamPins;

    final client = HttpClient()
      ..badCertificateCallback = (cert, host, port) {
        return pins.contains(cert.sha256);
      };

    return IOWebSocketChannel.connect(
      uri,
      customClient: client,
      headers: headers,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/pinning/ws_pinned_io.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 138: lib/core/network/pinning/pin_store.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/pinning/pin_store.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 371.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

class PinStore {
  static const List<String> sandboxRestPins = [
    "REPLACE_WITH_SANDBOX_REST_PIN"
  ];
  static const List<String> sandboxStreamPins = [
    "REPLACE_WITH_SANDBOX_STREAM_PIN"
  ];
  static const List<String> liveRestPins = [
    "REPLACE_WITH_LIVE_REST_PIN"
  ];
  static const List<String> liveStreamPins = [
    "REPLACE_WITH_LIVE_STREAM_PIN"
  ];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/pinning/pin_store.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 139: lib/core/network/websocket/ping_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/websocket/ping_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 351.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class PingManager {
  final WebSocketChannel channel;
  late Timer _timer;

  PingManager(this.channel);

  void start() {
    _timer = Timer.periodic(Duration(seconds: 20), (_) {
      channel.sink.add('ping');
    });
  }

  void stop() {
    _timer.cancel();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/websocket/ping_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 140: lib/core/network/websocket/message_verifier.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/websocket/message_verifier.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 259.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

class MessageVerifier {
  int? lastId;

  bool isInOrder(int newId) {
    if (lastId == null) {
      lastId = newId;
      return true;
    }

    if (newId > lastId!) {
      lastId = newId;
      return true;
    }

    return false; // out-of-order
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/websocket/message_verifier.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 141: lib/core/network/oanda/oanda_config.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda/oanda_config.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 277.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class OandaConfig {
  static const String restBaseUrl = "https://api-fxpractice.oanda.com/v3";
  static const String streamBaseUrl = "https://stream-fxpractice.oanda.com/v3";
  static const String tokenKey = "oanda_token";
  static const String accountKey = "oanda_account";
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda/oanda_config.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 142: lib/core/network/oanda/client/oanda_rest_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda/client/oanda_rest_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 42
================================================================================

import 'dart:convert';
import 'package:http/http.dart' as http;
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaRestClient {
  Future<http.Response> _call(String url) async {
    final token = await SecureStorageManager.readOandaToken();
    final headers = {
      "Authorization": "Bearer \$token",
      "Content-Type": "application/json",
    };
    return http.get(Uri.parse(url), headers: headers);
  }

  Future<List<String>> fetchInstruments() async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/accounts/\$accountId/instruments";
    final res = await _call(url);
    if (res.statusCode == 200) {
      final json = jsonDecode(res.body);
      final list = json["instruments"] as List;
      return list.map((i) => i["name"].toString()).toList();
    }
    throw Exception("OANDA fetchInstruments failed: \${res.body}");
  }

  Future<List<Map<String, dynamic>>> fetchCandles(
      String symbol, String granularity) async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/instruments/\$symbol/candles?granularity=\$granularity&count=500";
    final res = await _call(url);
    if (res.statusCode == 200) {
      final json = jsonDecode(res.body);
      final candles = json["candles"] as List;
      return candles.map((c) => c as Map<String, dynamic>).toList();
    }
    throw Exception("OANDA fetchCandles failed: \${res.body}");
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda/client/oanda_rest_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 143: lib/core/network/oanda/stream/oanda_stream_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda/stream/oanda_stream_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 44
================================================================================

import 'package:web_socket_channel/web_socket_channel.dart';
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaStreamClient {
  WebSocketChannel? _channel;

  void connect(String symbol, Function(dynamic

// ========================================

// ==== Code Block 1706 ====
cat > lib/core/network/oanda/stream/oanda_ws_client.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaWSClient {
  WebSocketChannel? _channel;
  StreamSubscription? _subs;

  void connect(String symbol, void Function(dynamic) onData,
      {void Function()? onDone, void Function(dynamic)? onError}) async {
    final token = await SecureStorageManager.readOandaToken();
    final url =
        "\${OandaConfig.streamBaseUrl}/accounts/\${await SecureStorageManager.readOandaAccount()}/pricing/stream?instruments=\$symbol";
    _channel = WebSocketChannel.connect(
      Uri.parse(url),
      headers: {"Authorization": "Bearer \$token"},
    );

    _subs = _channel!.stream.listen(
      onData,
      onError: onError,
      onDone: onDone,
    );
  }

  void disconnect() {
    _subs?.cancel();
    _channel?.sink.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda/stream/oanda_stream_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 144: lib/core/network/oanda/stream/oanda_ws_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/network/oanda/stream/oanda_ws_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 59
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaWSClient {
  WebSocketChannel? _channel;
  StreamSubscription? _subs;
  bool _manuallyClosed = false;

  Future<void> connect(
    String symbol,
    void Function(dynamic) onData, {
    void Function()? onDone,
    void Function(dynamic)? onError,
  }) async {
    _manuallyClosed = false;
    final token = await SecureStorageManager.readOandaToken();
    final account =
        await SecureStorageManager.readOandaAccount();

    final url =
        "\${OandaConfig.streamBaseUrl}/accounts/\$account/pricing/stream?instruments=\$symbol";

    _channel = WebSocketChannel.connect(
      Uri.parse(url),
      headers: {"Authorization": "Bearer \$token"},
    );

    _subs = _channel!.stream.listen(
      onData,
      onError: (e) {
        onError?.call(e);
        if (!_manuallyClosed) {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
          Future.delayed(Duration(seconds: 2), () {
            connect(symbol, onData,
                onDone: onDone, onError: onError);
          });
        }
      },
      onDone: () {
        onDone?.call();
        if (!_manuallyClosed) {
          Future.delayed(Duration(seconds: 2), () {
            connect(symbol, onData,
                onDone: onDone, onError: onError);
          });
        }
      },
    );
  }

  void disconnect() {
    _manuallyClosed = true;
    _subs?.cancel();
    _channel?.sink.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/network/oanda/stream/oanda_ws_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 145: lib/core/buffer/ring_buffer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/buffer/ring_buffer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 352.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

class RingBuffer<T> {
  final int capacity;
  final List<T> _buffer = [];
  int _index = 0;

  RingBuffer(this.capacity);

  void add(T item) {
    if (_buffer.length < capacity) {
      _buffer.add(item);
    } else {
      _buffer[_index] = item;
      _index = (_index + 1) % capacity;
    }
  }

  List<T> toList() => List.unmodifiable(_buffer);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/buffer/ring_buffer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 146: lib/core/logging/audit_logger.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/logging/audit_logger.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 517.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:hive/hive.dart';
import 'dart:convert';

class AuditLogger {
  static const _box = "audit_logs";

  static Future<void> init() async {
    await Hive.openBox(_box);
  }

  static void log(String event, dynamic payload) {
    final box = Hive.box(_box);
    box.add({
      "timestamp": DateTime.now().toIso8601String(),
      "event": event,
      "payload": jsonEncode(payload),
    });
  }

  static List<dynamic> getAllLogs() {
    final box = Hive.box(_box);
    return box.values.toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/logging/audit_logger.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 147: lib/core/logging/ui/logs_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/logging/ui/logs_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 607.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:flutter/material.dart';
import '../audit_logger.dart';

class LogsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final logs = AuditLogger.getAllLogs();
    return Scaffold(
      appBar: AppBar(title: Text("System Logs")),
      body: ListView.builder(
        itemCount: logs.length,
        itemBuilder: (c, i) {
          final item = logs[i];
          return ListTile(
            title: Text(item["event"]),
            subtitle: Text(item["payload"]),
            trailing: Text(item["timestamp"]),
          );
        },
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/logging/ui/logs_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 148: lib/core/models/candle_entity.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/candle_entity.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 22.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class CandleEntity {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/candle_entity.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 149: lib/core/models/tick_entity.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/tick_entity.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 20.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class TickEntity {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/tick_entity.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 150: lib/core/models/adapters/candle_entity_adapter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/adapters/candle_entity_adapter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 791.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:hive/hive.dart';
import '../candle_entity.dart';

class CandleEntityAdapter extends TypeAdapter<CandleEntity> {
  @override
  final typeId = 1;

  @override
  CandleEntity read(BinaryReader reader) {
    return CandleEntity(
      timeUtc: DateTime.fromMillisecondsSinceEpoch(reader.readInt()),
      open: reader.readDouble(),
      high: reader.readDouble(),
      low: reader.readDouble(),
      close: reader.readDouble(),
      volume: reader.readDouble(),
    );
  }

  @override
  void write(BinaryWriter writer, CandleEntity obj) {
    writer.writeInt(obj.timeUtc.millisecondsSinceEpoch);
    writer.writeDouble(obj.open);
    writer.writeDouble(obj.high);
    writer.writeDouble(obj.low);
    writer.writeDouble(obj.close);
    writer.writeDouble(obj.volume);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/adapters/candle_entity_adapter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 151: lib/core/models/price/spread_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/price/spread_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 153.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class SpreadModel {
  final double bid;
  final double ask;

  SpreadModel({required this.bid, required this.ask});

  double get spread => ask - bid;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/price/spread_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 152: lib/core/models/price/spread_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/price/spread_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 150.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

class SpreadCalculator {
  static double forBuy(double ask, double bid) => ask - bid;
  static double forSell(double bid, double ask) => bid - ask;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/price/spread_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 153: lib/core/models/price/market_price.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/price/market_price.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 363.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

enum PriceType { bid, ask, mid }

class MarketPrice {
  final double bid;
  final double ask;

  MarketPrice({required this.bid, required this.ask});

  double of(PriceType type) {
    switch (type) {
      case PriceType.bid:
        return bid;
      case PriceType.ask:
        return ask;
      case PriceType.mid:
        return (bid + ask) / 2;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/price/market_price.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 154: lib/core/models/dto/candle_dto.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/dto/candle_dto.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 550.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

class CandleDto {
  final String time;
  final String open;
  final String high;
  final String low;
  final String close;
  final String volume;

  CandleDto({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });

  factory CandleDto.fromJson(Map<String, dynamic> json) {
    return CandleDto(
      time: json['time'],
      open: json['o'],
      high: json['h'],
      low: json['l'],
      close: json['c'],
      volume: json['v'],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/dto/candle_dto.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 155: lib/core/models/factories/candle_factory.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/models/factories/candle_factory.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 519.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import '../candle_entity.dart';

class CandleFactory {
  static CandleEntity fromJson(Map<String, dynamic>? json) {
    return CandleEntity(
      timeUtc: DateTime.tryParse(json?['time'] ?? '') ?? DateTime.now().toUtc(),
      open: (json?['open'] as num?)?.toDouble() ?? 0.0,
      high: (json?['high'] as num?)?.toDouble() ?? 0.0,
      low: (json?['low'] as num?)?.toDouble() ?? 0.0,
      close: (json?['close'] as num?)?.toDouble() ?? 0.0,
      volume: (json?['volume'] as num?)?.toDouble() ?? 0.0,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/models/factories/candle_factory.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 156: lib/core/storage/replay_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/replay_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 366.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:hive/hive.dart';

part 'replay_storage.g.dart';

@HiveType(typeId: 5)
class ReplayStateEntity extends HiveObject {
  @HiveField(0)
  final String symbol;
  @HiveField(1)
  final String timeframe;
  @HiveField(2)
  final int lastIndex;

  ReplayStateEntity({
    required this.symbol,
    required this.timeframe,
    required this.lastIndex,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/replay_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 157: lib/core/storage/preferences.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/preferences.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 398.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:shared_preferences/shared_preferences.dart';

class UserPreferences {
  static Future<void> saveTheme(bool isDark) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('darkMode', isDark);
  }

  static Future<bool> loadTheme() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool('darkMode') ?? false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/preferences.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 158: lib/core/storage/hive_cleanup_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/hive_cleanup_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 173.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'package:hive/hive.dart';

Future<void> closeAllHiveBoxes() async {
  for (var box in Hive.boxes.values) {
    if (box.isOpen) {
      await box.close();
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/hive_cleanup_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 159: lib/core/storage/safe_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/safe_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 376.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:hive/hive.dart';

class SafeStorage {
  final Box box;

  SafeStorage(this.box);

  T? read<T>(String key) {
    try {
      return box.get(key) as T?;
    } catch (e) {
      return null;
    }
  }

  Future<void> write<T>(String key, T value) async {
    try {
      await box.put(key, value);
    } catch (e) {
      print("Storage error: $e");
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/safe_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 160: lib/core/storage/usage_monitor.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/usage_monitor.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 376.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:io';
import 'package:path_provider/path_provider.dart';

class StorageUsageMonitor {
  Future<int> calculateUsedBytes() async {
    final dir = await getApplicationDocumentsDirectory();
    int total = 0;
    await for (var file in dir.list(recursive: true)) {
      if (file is File) {
        total += await file.length();
      }
    }
    return total;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/usage_monitor.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 161: lib/core/storage/transactional_file_saver.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/transactional_file_saver.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 267.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'dart:io';

class TransactionalFileSaver {
  static Future<void> safeWrite(String path, String data) async {
    final temp = File(path + ".tmp");
    await temp.writeAsString(data);
    final original = File(path);
    await temp.rename(original.path);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/transactional_file_saver.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 162: lib/core/storage/file_write_safe.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/file_write_safe.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 317.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:io';

class FileWriteSafe {
  static Future<void> save(String path, String content) async {
    final tmp = File("$path.tmp");
    await tmp.writeAsString(content);
    final original = File(path);
    if (await original.exists()) {
      await original.delete();
    }
    await tmp.rename(path);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/file_write_safe.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 163: lib/core/storage/shared_prefs_cleaner.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/shared_prefs_cleaner.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 218.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'package:shared_preferences/shared_preferences.dart';

class SharedPrefsCleaner {
  static Future<void> cleanAll() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/shared_prefs_cleaner.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 164: lib/core/storage/watchlist.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/watchlist.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 457.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:hive/hive.dart';

class WatchlistManager {
  final Box _box = Hive.box("watchlist_box");

  List<String> getAll() =>
      _box.values.cast<String>().toList();

  Future<void> add(String symbol) async {
    if (!_box.values.contains(symbol)) {
      await _box.add(symbol);
    }
  }

  Future<void> remove(String symbol) async {
    final key = _box.keys
        .firstWhere((k) => _box.get(k) == symbol);
    await _box.delete(key);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/watchlist.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 165: lib/core/storage/safe_restore.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/safe_restore.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 224.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:hive/hive.dart';

Future<void> safeRestore(String boxName) async {
  try {
    await Hive.openBox(boxName);
  } catch (err) {
    await Hive.deleteBoxFromDisk(boxName);
    await Hive.openBox(boxName);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/safe_restore.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 166: lib/core/storage/app_preferences.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/app_preferences.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 401.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:shared_preferences/shared_preferences.dart';

class AppPreferences {
  static Future<void> saveThemeMode(bool isDark) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setBool("dark_mode", isDark);
  }

  static Future<bool> loadThemeMode() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool("dark_mode") ?? false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/app_preferences.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 167: lib/core/storage/oanda/secure_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/oanda/secure_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 712.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class OandaSecureStorage {
  final _storage = FlutterSecureStorage();

  static const _tokenKey = "oanda_token";
  static const _accountIdKey = "oanda_account";

  Future<void> saveToken(String token) async {
    await _storage.write(key: _tokenKey, value: token);
  }

  Future<String?> loadToken() async {
    return await _storage.read(key: _tokenKey);
  }

  Future<void> saveAccountId(String id) async {
    await _storage.write(key: _accountIdKey, value: id);
  }

  Future<String?> loadAccountId() async {
    return await _storage.read(key: _accountIdKey);
  }

  Future<void> clearAll() async {
    await _storage.deleteAll();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/oanda/secure_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 168: lib/core/storage/cache/cache_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/cache/cache_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'package:hive/hive.dart';
import 'cache_strategy.dart';
import 'ttl_cache.dart';

class CacheManager {
  static final _inst = CacheManager._();
  CacheManager._();

  static CacheManager get instance => _inst;

  late CacheStrategy _symbolsCache;
  late CacheStrategy _instrumentsCache;

  Future<void> init() async {
    final symBox = Hive.box("cache_symbols");
    _symbolsCache = TtlCache(symBox, ttl: Duration(minutes: 10));

    final insBox = Hive.box("cache_instruments");
    _instrumentsCache = TtlCache(insBox, ttl: Duration(minutes: 30));
  }

  Future<List<String>?> getSymbols(String key) =>
      _symbolsCache.read(key);

  Future<void> setSymbols(String key, List<String> val) =>
      _symbolsCache.write(key, val);

  Future<void> deleteSymbols(String key) =>
      _symbolsCache.delete(key);

  Future<List<dynamic>?> getInstruments(String key) =>
      _instrumentsCache.read(key);

  Future<void> setInstruments(String key, List<dynamic> val) =>
      _instrumentsCache.write(key, val);

  Future<void> deleteInstruments(String key) =>
      _instrumentsCache.delete(key);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/cache/cache_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 169: lib/core/storage/cache/ttl_cache.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/cache/ttl_cache.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 952.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 41
================================================================================

import 'dart:convert';
import 'package:hive/hive.dart';
import 'cache_strategy.dart';

class TtlCache<T> implements CacheStrategy<T> {
  final Box _box;
  final Duration ttl;

  TtlCache(this._box, {required this.ttl});

  @override
  Future<void> write(String key, T value) async {
    final wrapper = {
      "ts": DateTime.now().millisecondsSinceEpoch,
      "data": value,
    };
    await _box.put(key, wrapper);
  }

  @override
  Future<T?> read(String key) async {
    final stored = _box.get(key);
    if (stored == null) return null;
    final ts = stored["ts"] as int;
    final diff =
        DateTime.now().millisecondsSinceEpoch - ts;
    if (Duration(milliseconds: diff) > ttl) {
      await _box.delete(key);
      return null;
    }
    return stored["data"] as T;
  }

  @override
  Future<void> delete(String key) async => _box.delete(key);

  @override
  bool shouldInvalidate(String key) {
    return !_box.containsKey(key);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/cache/ttl_cache.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 170: lib/core/storage/cache/cache_strategy.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/cache/cache_strategy.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 182.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

abstract class CacheStrategy<T> {
  Future<T?> read(String key);
  Future<void> write(String key, T value);
  Future<void> delete(String key);
  bool shouldInvalidate(String key);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/cache/cache_strategy.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 171: lib/core/storage/script/script_hive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/script/script_hive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 51.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

class ScriptEntityAdapter {}
class ScriptEntity {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/script/script_hive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 172: lib/core/storage/script/script_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/script/script_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 23.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class ScriptStorage {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/script/script_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 173: lib/core/storage/chart_cache/chart_cache_hive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/chart_cache/chart_cache_hive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 430.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:hive/hive.dart';
import '../../../core/models/candle_entity.dart';

part "chart_cache_hive.g.dart";

@HiveType(typeId: 50)
class ChartCacheEntity extends HiveObject {
  @HiveField(0)
  final String symbol;

  @HiveField(1)
  final String timeframe;

  @HiveField(2)
  final List<CandleEntity> candles;

  ChartCacheEntity({
    required this.symbol,
    required this.timeframe,
    required this.candles,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/chart_cache/chart_cache_hive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 174: lib/core/storage/chart_cache/chart_cache_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/chart_cache/chart_cache_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 765.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:hive/hive.dart';
import 'chart_cache_hive.dart';

class ChartCacheStorage {
  static const _box = "chart_cache_box";

  Future<void> save(
      String symbol, String timeframe, List<CandleEntity> candles) async {
    final box = await Hive.openBox<ChartCacheEntity>(_box);
    await box.put("${symbol}_$timeframe",
        ChartCacheEntity(symbol: symbol, timeframe: timeframe, candles: candles));
  }

  Future<List<CandleEntity>> get(String symbol, String timeframe) async {
    final box = await Hive.openBox<ChartCacheEntity>(_box);
    final entity = box.get("${symbol}_$timeframe");
    return entity?.candles ?? [];
  }

  Future<void> clear() async {
    final box = await Hive.openBox<ChartCacheEntity>(_box);
    await box.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/chart_cache/chart_cache_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 175: lib/core/storage/strategy/strategy_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/strategy/strategy_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 184.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import '../../../../core/models/strategy_graph.dart';

abstract class StrategyStorage {
  Future<void> save(String id, StrategyGraph graph);
  Future<StrategyGraph> load(String id);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/strategy/strategy_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 176: lib/core/storage/hive_adapters/candle_adapter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/hive_adapters/candle_adapter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 56
================================================================================

import 'package:hive/hive.dart';
import '../../features/market/domain/models/candle.dart';

part 'candle_adapter.g.dart';

@HiveType(typeId: 1)
class HiveCandle {
  @HiveField(0)
  final int time;

  @HiveField(1)
  final double open;

  @HiveField(2)
  final double high;

  @HiveField(3)
  final double low;

  @HiveField(4)
  final double close;

  HiveCandle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });
}

// Adapter Serializer
class HiveCandleAdapter extends TypeAdapter<HiveCandle> {
  @override
  final typeId = 1;

  @override
  HiveCandle read(BinaryReader reader) {
    return HiveCandle(
      time: reader.readInt(),
      open: reader.readDouble(),
      high: reader.readDouble(),
      low: reader.readDouble(),
      close: reader.readDouble(),
    );
  }

  @override
  void write(BinaryWriter writer, HiveCandle obj) {
    writer.writeInt(obj.time);
    writer.writeDouble(obj.open);
    writer.writeDouble(obj.high);
    writer.writeDouble(obj.low);
    writer.writeDouble(obj.close);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/hive_adapters/candle_adapter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 177: lib/core/storage/theme/theme_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/theme/theme_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 22.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class ThemeStorage {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/theme/theme_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 178: lib/core/storage/theme/theme_hive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/theme/theme_hive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 49.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

class ThemeEntityAdapter {}
class ThemeEntity {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/theme/theme_hive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 179: lib/core/storage/audit/audit_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/audit/audit_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 22.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class AuditStorage {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/audit/audit_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 180: lib/core/storage/audit/audit_hive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/audit/audit_hive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 49.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

class AuditEntityAdapter {}
class AuditEntity {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/audit/audit_hive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 181: lib/core/storage/audit/audit_flush_on_error.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/audit/audit_flush_on_error.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 248.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'event_audit_manager3.dart';

Future<void> flushAuditOnError() async {
  final events = await EventAuditManager3.getAllSorted();
  for (var e in events) {
    //  Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/audit/audit_flush_on_error.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 182: lib/core/storage/audit/event_audit_manager3.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/audit/event_audit_manager3.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 684.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:hive/hive.dart';

class EventAuditManager3 {
  static Box? _box;

  static Future<Box> _openBox() async {
    if (_box != null && _box!.isOpen) return _box!;
    _box = await Hive.openBox('eventAudit');
    return _box!;
  }

  static Future<void> log(String event) async {
    final box = await _openBox();
    final timestamp = DateTime.now().toUtc().toIso8601String();
    await box.add({'event': event, 'timestamp': timestamp});
  }

  static Future<List<Map>> getAllSorted() async {
    final box = await _openBox();
    final values = box.values.cast<Map>().toList();
    values.sort((a, b) => a['timestamp'].compareTo(b['timestamp']));
    return values;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/audit/event_audit_manager3.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 183: lib/core/storage/audit/event_audit_manager2.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/audit/event_audit_manager2.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 533.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:hive/hive.dart';

class EventAuditManager2 {
  static Box? _box;

  static Future<Box> _openBox() async {
    if (_box != null && _box!.isOpen) return _box!;
    _box = await Hive.openBox('eventAudit');
    return _box!;
  }

  static Future<void> log(String event) async {
    final b = await _openBox();
    await b.add({'event': event, 'timestamp': DateTime.now().toIso8601String()});
  }

  static Future<List<Map>> getAll() async {
    final b = await _openBox();
    return b.values.cast<Map>().toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/audit/event_audit_manager2.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 184: lib/core/storage/audit/event_audit_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/audit/event_audit_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 391.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:hive/hive.dart';

class EventAuditManager {
  static Future<void> log(String event) async {
    final box = await Hive.openBox('eventAudit');
    await box.add({'event': event, 'timestamp': DateTime.now().toIso8601String()});
  }

  static Future<List<Map>> getAll() async {
    final box = await Hive.openBox('eventAudit');
    return box.values.cast<Map>().toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/audit/event_audit_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 185: lib/core/storage/sync/preferences_write_lock.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/sync/preferences_write_lock.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 297.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class PreferencesWriteLock {
  Completer<void>? _lock;

  Future<void> synchronized(Future<void> Function() fn) async {
    while (_lock != null) {
      await _lock!.future;
    }
    _lock = Completer<void>();
    await fn();
    _lock!.complete();
    _lock = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/sync/preferences_write_lock.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 186: lib/core/storage/transaction/transactional_write_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/transaction/transactional_write_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 265.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'dart:io';

class TransactionalStorage {
  static Future<void> safeWrite(String path, String data) async {
    final temp = File(path + ".tmp");
    await temp.writeAsString(data);
    final original = File(path);
    await temp.rename(original.path);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/transaction/transactional_write_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 187: lib/core/storage/replay/replay_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/replay/replay_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 472.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:hive/hive.dart';
import 'replay_hive.dart';

class ReplayStorage {
  static const _box = "replay_box";

  Future<void> save(String symbol, int index) async {
    final box = await Hive.openBox<ReplayStateEntity>(_box);
    await box.put(symbol, ReplayStateEntity(symbol: symbol, lastIndex: index));
  }

  Future<ReplayStateEntity?> load(String symbol) async {
    final box = await Hive.openBox<ReplayStateEntity>(_box);
    return box.get(symbol);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/replay/replay_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 188: lib/core/storage/replay/replay_hive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/replay/replay_hive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 281.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:hive/hive.dart';

part 'replay_hive.g.dart';

@HiveType(typeId: 14)
class ReplayStateEntity extends HiveObject {
  @HiveField(0)
  final String symbol;

  @HiveField(1)
  final int lastIndex;

  ReplayStateEntity({required this.symbol, required this.lastIndex});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/replay/replay_hive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 189: lib/core/storage/indicator/indicator_settings_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/indicator/indicator_settings_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 572.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class IndicatorSettingsStorageSP {
  static const _key = "indicatorSettings";

  static Future<void> save(String id, Map<String, dynamic> params) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(_key + id, jsonEncode(params));
  }

  static Future<Map<String, dynamic>?> load(String id) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(_key + id);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/indicator/indicator_settings_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 190: lib/core/storage/indicator/indicator_hive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/indicator/indicator_hive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 73.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

class IndicatorSettingsEntityAdapter {}
class IndicatorSettingsEntity {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/indicator/indicator_hive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 191: lib/core/storage/indicator/indicator_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/indicator/indicator_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 34.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class IndicatorSettingsStorage {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/indicator/indicator_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 192: lib/core/storage/indicator/indicator_settings_storage2.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/indicator/indicator_settings_storage2.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 599.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class IndicatorSettingsStorage2 {
  static Future<void> save(String id, Map<String, dynamic> params) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "indicator_settings_$id";
    prefs.setString(key, jsonEncode(params));
  }

  static Future<Map<String, dynamic>?> load(String id) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "indicator_settings_$id";
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/indicator/indicator_settings_storage2.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 193: lib/core/storage/hive/hive_migration.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/hive/hive_migration.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 435.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:hive/hive.dart';

Future<void> performMigration(Box box, int fromVersion, int toVersion) async {
  if (fromVersion < 2 && toVersion >= 2) {
    // Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ØªØ­Ø¯ÙŠØ« schema
    final all = box.toMap();
    for (var k in all.keys) {
      final entry = all[k];
      if (entry is Map && !entry.containsKey('volume')) {
        entry['volume'] = '0';
        await box.put(k, entry);
      }
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/hive/hive_migration.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 194: lib/core/storage/hive/compactor.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/storage/hive/compactor.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 138.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import 'package:hive/hive.dart';

Future<void> compactIfNeeded(Box box) async {
  if (box.length > 1000) {
    await box.compact();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/storage/hive/compactor.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 195: lib/core/performance/fps_monitor.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/performance/fps_monitor.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 392.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/scheduler.dart';

class FPSMonitor {
  void start(void Function(int) callback) {
    int lastFrameTime = 0;
    SchedulerBinding.instance.addTimingsCallback((timings) {
      final frameTime = timings.first.totalSpan.inMilliseconds;
      final fps = frameTime == 0 ? 0 : (1000 / frameTime).round();
      callback(fps);
      lastFrameTime = frameTime;
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/performance/fps_monitor.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 196: lib/core/performance/performance_and_cache_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/performance/performance_and_cache_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 98
================================================================================

import 'dart:async';
import 'package:flutter/widgets.dart';
import 'package:collection/collection.dart';
import '../../features/market/domain/entities/candle.dart';

/// ============================================================
/// 1) HISTORY CACHE MANAGER (Memory + Paging + Throttle WS)
/// ============================================================

class HistoryCacheManager {
  final Map<String, List<Candle>> _cache = {};

  // Load and cache history
  List<Candle> load(String key, List<Candle> data) {
    _cache[key] = data;
    return _cache[key]!;
  }

  // Get cached
  List<Candle>? get(String key) => _cache[key];

  // Clear
  void clear(String key) => _cache.remove(key);

  // Clear all
  void clearAll() => _cache.clear();
}

/// ===============================================
/// 2) WebSocket Debouncer / Throttler
/// ===============================================

class WsThrottle {
  final Duration duration;
  Timer? _timer;
  final List<Map<String, dynamic>> _buffer = [];

  WsThrottle([this.duration = const Duration(milliseconds: 250)]);

  void call(Map<String, dynamic> data, void Function(Map<String, dynamic>) emit) {
    _buffer.add(data);

    _timer?.cancel();
    _timer = Timer(duration, () {
      if (_buffer.isNotEmpty) {
        final last = _buffer.last;
        _buffer.clear();
        emit(last);
      }
    });
  }

  void dispose() {
    _timer?.cancel();
    _buffer.clear();
  }
}

/// ===============================================
/// 3) Custom Painter Cache (RepaintBoundary Helper)
/// ===============================================

class CachedPainter extends CustomPainter {
  final List<Candle> candles;
  final CustomPainter innerPainter;

  CachedPainter({required this.candles, required this.innerPainter});

  @override
  void paint(Canvas canvas, Size size) {
    innerPainter.paint(canvas, size);
  }

  @override
  bool shouldRepaint(covariant CachedPainter oldDelegate) {
    // Only redraw when data changes
    final eq = ListEquality().equals;
    return !eq(oldDelegate.candles, candles);
  }
}

/// ===============================================
/// 4) Canvas Update Scheduler
/// ===============================================

class RenderScheduler {
  bool _locked = false;

  void requestRender(VoidCallback callback) {
    if (_locked) return;
    _locked = true;

    WidgetsBinding.instance.addPostFrameCallback((_) {
      callback();
      _locked = false;
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/performance/performance_and_cache_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 197: lib/core/error/failure.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/error/failure.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 394.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

abstract class Failure {
  final String message;
  Failure(this.message);
}

class NetworkFailure extends Failure {
  NetworkFailure(String m) : super(m);
}

class AuthFailure extends Failure {
  AuthFailure(String m) : super(m);
}

class ParsingFailure extends Failure {
  ParsingFailure(String m) : super(m);
}

class UnknownFailure extends Failure {
  UnknownFailure(String m) : super(m);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/error/failure.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 198: lib/core/di/dependency_injection.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/di/dependency_injection.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 369.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import '../log/logger_service.dart';

class DependencyInjection {
  static bool _initialized = false;

  static Future<void> init() async {
    if (_initialized) return;
    _initialized = true;

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø¤Ù‚ØªØ§Ù‹ Ø­ØªÙ‰ Ù†Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹)
    LoggerService.log('DependencyInjection initialized');
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/di/dependency_injection.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 199: lib/core/di/hive_init.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/di/hive_init.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 217.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'package:hive_flutter/hive_flutter.dart';

import '../models/adapters/candle_entity_adapter.dart';

Future<void> initHive() async {
  await Hive.initFlutter();

  Hive.registerAdapter(CandleEntityAdapter());
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/di/hive_init.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 200: lib/core/startup/loading_coordinator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/startup/loading_coordinator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 96.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class LoadingCoordinator {
  bool isDone = false;

  void complete() {
    isDone = true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/startup/loading_coordinator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 201: lib/core/monitoring/production_monitoring_setup.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/monitoring/production_monitoring_setup.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 41
================================================================================

import 'package:flutter/widgets.dart';
import 'package:sentry_flutter/sentry_flutter.dart';

/// ======================================================
/// 1) Initialize Sentry (Crash Reporting + Performance)
/// ======================================================
class ProductionMonitoring {
  static Future<void> init({
    required String dsn,
    bool enablePerformance = true,
  }) async {
    await SentryFlutter.init(
      (options) {
        options.dsn = dsn;
        options.tracesSampleRate = enablePerformance ? 1.0 : 0.0;
      },
      // ensure Init before Widgets binding
      appRunner: () => runApp(MyApp()),
    );
  }
}

/// ======================================================
/// 2) Error Handler (Global)
/*
   Ø£ÙŠ Ø®Ø·Ø£ ØºÙŠØ± Ù…Ù„ØªÙ‚Ø· Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø³Ù†ØªØ±ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
*/
void setupGlobalErrorHandler() {
  FlutterError.onError = (FlutterErrorDetails details) {
    FlutterError.dumpErrorToConsole(details);
    Sentry.captureException(
      details.exception,
      stackTrace: details.stack,
    );
  };

  PlatformDispatcher.instance.onError = (error, stack) {
    Sentry.captureException(error, stackTrace: stack);
    return true;
  };
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/monitoring/production_monitoring_setup.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 202: lib/core/errors/app_error.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/errors/app_error.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 713.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

abstract class AppError {
  String get message;
}

class NetworkError implements AppError {
  @override
  String get message => "No internet connection";
}

class ServerError implements AppError {
  final String details;
  ServerError(this.details);

  @override
  String get message => "Server error: $details";
}

class TimeoutError implements AppError {
  @override
  String get message => "Request timed out. Please try again.";
}

class InvalidCredentialsError implements AppError {
  @override
  String get message => "Invalid credentials. Please check your API Token and Account ID.";
}

class UnknownError implements AppError {
  @override
  String get message => "Something went wrong. Please retry.";
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/errors/app_error.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 203: lib/core/errors/failures.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/errors/failures.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 340.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

abstract class Failure {
  final String message;
  Failure(this.message);
}

class ServerFailure extends Failure {
  ServerFailure(String message): super(message);
}

class CacheFailure extends Failure {
  CacheFailure(String message): super(message);
}

class UnknownFailure extends Failure {
  UnknownFailure(): super("Unknown Error");
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/errors/failures.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 204: lib/core/notifications/firebase_messaging_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/notifications/firebase_messaging_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 361.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:firebase_messaging/firebase_messaging.dart';

class FirebaseMessagingService {
  final FirebaseMessaging _fcm = FirebaseMessaging.instance;

  Future<void> init() async {
    await _fcm.requestPermission();
    FirebaseMessaging.onMessage.listen((msg) {
      // Handle foreground
    });
  }

  Future<String?> getToken() => _fcm.getToken();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/notifications/firebase_messaging_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 205: lib/core/notifications/notification_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/notifications/notification_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 677.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  final _flutterNotif = FlutterLocalNotificationsPlugin();

  Future<void> init() async {
    const android = AndroidInitializationSettings('@mipmap/ic_launcher');
    const settings = InitializationSettings(android: android);
    await _flutterNotif.initialize(settings);
  }

  Future<void> show(String title, String body) async {
    const androidDetails = AndroidNotificationDetails(
      "channel_id",
      "channel_name",
      importance: Importance.max,
    );
    await _flutterNotif.show(0, title, body, NotificationDetails(android: androidDetails));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/notifications/notification_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 206: lib/core/cache/history_cache_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/cache/history_cache_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 701.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class HistoryCacheGuard {
  static Future<void> save(
      String symbol, String timeframe, List<Map<String, dynamic>> data) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "$symbol-$timeframe";
    prefs.setString(key, jsonEncode(data));
  }

  static Future<List<Map<String, dynamic>>?> load(
      String symbol, String timeframe) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "$symbol-$timeframe";
    final str = prefs.getString(key);
    if (str == null) return null;
    return (jsonDecode(str) as List).cast<Map<String, dynamic>>();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/cache/history_cache_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 207: lib/core/cache/persistent_history_cache.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/cache/persistent_history_cache.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 793.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class PersistentHistoryCache {
  static const _keyPrefix = "history_cache_";

  static Future<void> save(String key, List<Map<String, dynamic>> data) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(_keyPrefix + key, jsonEncode(data));
  }

  static Future<List<Map<String, dynamic>>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(_keyPrefix + key);
    if (str == null) return null;
    return (jsonDecode(str) as List).cast<Map<String, dynamic>>();
  }

  static Future<void> clear(String key) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.remove(_keyPrefix + key);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/cache/persistent_history_cache.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 208: lib/core/webview/webview_controller_cleanup_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/webview/webview_controller_cleanup_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 167.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import 'package:webview_flutter/webview_flutter.dart';

class WebViewControllerCleanupFix {
  void disposeController(WebViewController? ctrl) {
    ctrl = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/webview/webview_controller_cleanup_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 209: lib/core/webview/js_sl_tp_fix.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/webview/js_sl_tp_fix.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 151.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

function drawSLTPWhenReady(sl, tp) {
  if (!window.chart) {
    setTimeout(() => drawSLTPWhenReady(sl, tp), 50);
    return;
  }
  drawSLTP(sl, tp);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/webview/js_sl_tp_fix.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 210: lib/core/webview/webview_error_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/webview/webview_error_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 339.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:webview_flutter/webview_flutter.dart';

class WebViewErrorGuard {
  static void guard(WebViewController ctrl) {
    ctrl.setJavaScriptMode(JavaScriptMode.unrestricted);
    ctrl.addJavaScriptChannel(
      'ErrorGuard',
      onMessageReceived: (msg) {
        // ØªØ±Ø³Ù„ Ø£ÙŠ Ø®Ø·Ø£ Ø£Ùˆ ØªØ­Ø°ÙŠØ±
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/webview/webview_error_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 211: lib/core/webview/js_batch_update.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/webview/js_batch_update.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

function batchUpdate(seriesData) {
  const chunkSize = 500;
  for (let i = 0; i < seriesData.length; i += chunkSize) {
    setTimeout(() => {
      chart.series[0].setData(seriesData.slice(i, i + chunkSize));
    }, i / chunkSize);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/webview/js_batch_update.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 212: lib/core/webview/js_error_filter.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/webview/js_error_filter.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 141.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

window.onerror = function(message, source, lineno, colno, error) {
  if (message.includes('ResizeObserver')) return true;
  return false;
};

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/webview/js_error_filter.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 213: lib/core/webview/guard/webview_js_ready_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/webview/guard/webview_js_ready_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 493.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:webview_flutter/webview_flutter.dart';

class WebViewJSReadyGuard {
  static Future<void> evaluateWhenReady(
      WebViewController ctrl, String script) async {
    final ready = await ctrl
        .runJavascriptReturningResult("document.readyState === 'complete'");
    if (ready == '"complete"') {
      await ctrl.runJavascript(script);
    } else {
      ctrl.runJavascript(
          "document.addEventListener('DOMContentLoaded', function() { $script });");
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/webview/guard/webview_js_ready_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 214: lib/core/drawing/undo_redo_drawing_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/drawing/undo_redo_drawing_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 88
================================================================================

import 'package:flutter/material.dart';

/// =================================================================
/// 1) Undo/Redo Stack Manager for Drawing Tools
/// =================================================================

class DrawingCommand {
  final String id;
  final dynamic data;

  DrawingCommand(this.id, this.data);
}

class UndoRedoManager {
  final List<DrawingCommand> _undoStack = [];
  final List<DrawingCommand> _redoStack = [];

  void execute(DrawingCommand command) {
    _undoStack.add(command);
    _redoStack.clear();
  }

  DrawingCommand? undo() {
    if (_undoStack.isEmpty) return null;

    final last = _undoStack.removeLast();
    _redoStack.add(last);
    return last;
  }

  DrawingCommand? redo() {
    if (_redoStack.isEmpty) return null;
    final cmd = _redoStack.removeLast();
    _undoStack.add(cmd);
    return cmd;
  }

  void clear() {
    _undoStack.clear();
    _redoStack.clear();
  }

  bool get canUndo => _undoStack.isNotEmpty;
  bool get canRedo => _redoStack.isNotEmpty;
}

/// =================================================================
/// 2) Controller Helper to Integrate with Widgets
/// =================================================================

class DrawingController {
  final UndoRedoManager manager = UndoRedoManager();
  // Last drawn objects cache
  final List<Offset> trendPoints = [];

  void addTrendLine(Offset a, Offset b) {
    final data = {'type': 'trend', 'a': a, 'b': b};
    manager.execute(DrawingCommand("trend_line", data));
    trendPoints.addAll([a, b]);
  }

  Offset? undoTrendLine() {
    final cmd = manager.undo();
    if (cmd == null) return null;
    if (cmd.id == "trend_line") {
      trendPoints.removeRange(trendPoints.length - 2, trendPoints.length);
      return Offset.zero; // returns for UI refresh if needed
    }
    return null;
  }

  Offset? redoTrendLine() {
    final cmd = manager.redo();
    if (cmd == null) return null;
    if (cmd.id == "trend_line") {
      final a = cmd.data['a'] as Offset;
      final b = cmd.data['b'] as Offset;
      trendPoints.addAll([a, b]);
      return b;
    }
    return null;
  }

  void clearAll() {
    manager.clear();
    trendPoints.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/drawing/undo_redo_drawing_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 215: lib/core/data/sanitizer/data_sanitizer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/data/sanitizer/data_sanitizer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 383.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

class DataSanitizer {
  static bool isValidNumber(dynamic v) {
    if (v == null) return false;
    if (v is num) return true;
    return num.tryParse(v.toString()) != null;
  }

  static double safeDouble(dynamic v, {double fallback = 0.0}) {
    return isValidNumber(v) ? double.parse(v.toString()) : fallback;
  }

  static bool isValidMap(Map? m) => m != null && m.isNotEmpty;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/data/sanitizer/data_sanitizer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 216: lib/core/data/gap_fill/gap_fill_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/data/gap_fill/gap_fill_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 901.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter/foundation.dart';
import '../../../features/market/domain/entities/candle.dart';

class GapFillManager {
  static List<Candle> fillGaps(
      List<Candle> history, Candle lastLive, Duration timeframe) {
    final List<Candle> result = List.from(history);

    DateTime expectedNext =
        history.isEmpty ? lastLive.time : history.last.time.add(timeframe);

    while (expectedNext.isBefore(lastLive.time)) {
      // Ø§Ù†Ø³Ø® Ø¢Ø®Ø± Ø´Ù…Ø¹Ø© Ù…ØªÙˆÙ‚Ø¹Ø© ÙˆØ§Ù…Ù„Ø£Ù‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø±
      final c = Candle(
        time: expectedNext,
        open: history.last.close,
        high: history.last.close,
        low: history.last.close,
        close: history.last.close,
      );
      result.add(c);
      expectedNext =
          expectedNext.add(timeframe); // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
    }

    result.add(lastLive);
    return result;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/data/gap_fill/gap_fill_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 217: lib/core/lifecycle/resume_load_coordinator_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/lifecycle/resume_load_coordinator_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 152.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class ResumeLoadCoordinatorFix {
  bool _historyDone = false;

  void markHistoryDone() => _historyDone = true;

  bool canStartWS() => _historyDone;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/lifecycle/resume_load_coordinator_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 218: lib/core/lifecycle/resource_lifecycle_observer_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/lifecycle/resource_lifecycle_observer_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 374.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:flutter/widgets.dart';

class ResourceLifecycleObserverFix extends WidgetsBindingObserver {
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.detached ||
        state == AppLifecycleState.inactive ||
        state == AppLifecycleState.paused) {
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù‡Ù†Ø§
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/lifecycle/resource_lifecycle_observer_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 219: lib/core/lifecycle/init_once_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/lifecycle/init_once_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 188.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class InitOnceGuard {
  bool _initialized = false;

  Future<void> runOnce(Future<void> Function() fn) async {
    if (_initialized) return;
    _initialized = true;
    await fn();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/lifecycle/init_once_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 220: lib/core/lifecycle/app_lifecycle_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/lifecycle/app_lifecycle_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 439.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:flutter/widgets.dart';
import '../persistence/persistent_state_manager.dart';

class AppLifecycleManager extends WidgetsBindingObserver {
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      // Ù…Ø«Ø§Ù„: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„ Chart
      PersistentStateManager.load("chart_state")?.then((data) {
        // dispatch to ChartBloc
      });
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/lifecycle/app_lifecycle_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 221: lib/core/lifecycle/app_lifecycle_observer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/lifecycle/app_lifecycle_observer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 358.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'package:flutter/widgets.dart';

class AppLifecycleObserver extends WidgetsBindingObserver {
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.detached ||
        state == AppLifecycleState.inactive) {
      // Ù‡Ù†Ø§ Ù‚Ù… Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (WebSockets, Streams, Timers)
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/lifecycle/app_lifecycle_observer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 222: lib/core/time/time_zone_config.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/time_zone_config.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 329.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

class TimeZoneConfig {
  static const Map<String, int> instrumentOffsets = {
    "BTC_USD": -4, // Ù…Ø«Ø§Ù„ EDT
    "EUR_USD": 0,  // UTC
    "AAPL": -5     // EST
  };

  static DateTime toLocal(String symbol, DateTime utc) {
    final offset = instrumentOffsets[symbol] ?? 0;
    return utc.add(Duration(hours: offset));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/time_zone_config.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 223: lib/core/time/market_hours_filter_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/market_hours_filter_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 271.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

class MarketHoursFilterFix {
  static bool isMarketOpen(DateTime t) {
    final utc = t.toUtc();
    final weekday = utc.weekday;
    // Forex example:
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) {
      return false;
    }
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/market_hours_filter_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 224: lib/core/time/time_formatter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/time_formatter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 111.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class TimeFormatter {
  static String format(DateTime utc) {
    return utc.toLocal().toIso8601String();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/time_formatter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 225: lib/core/time/iso_date_normalizer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/iso_date_normalizer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 237.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class IsoDateNormalizer {
  static String normalize(dynamic value) {
    try {
      return DateTime.parse(value.toString()).toUtc().toIso8601String();
    } catch (_) {
      return DateTime.now().toUtc().toIso8601String();
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/iso_date_normalizer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 226: lib/core/time/time_canon.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/time_canon.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 621.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

class TimeCanon {
  /// ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ DateTime Ø£Ùˆ String Ø¥Ù„Ù‰ UTC Ù…ÙˆØ­Ù‘Ø¯
  static DateTime toUtc(dynamic t) {
    if (t is DateTime) {
      return t.toUtc();
    }
    if (t is String) {
      return DateTime.parse(t).toUtc();
    }
    throw ArgumentError("Unsupported time type: $t");
  }

  /// ÙŠÙ‚Ø§Ø±Ù† Ø²Ù…Ù†ÙŠÙ† Ø¨Ø¹Ø¯ ØªÙˆØ­ÙŠØ¯Ù‡Ù…Ø§
  static bool isSameInstant(dynamic a, dynamic b) {
    return toUtc(a).isAtSameMomentAs(toUtc(b));
  }

  /// ÙŠØ¶Ù…Ù† Ø£Ù† Ø£ÙŠ Timestamp ØµØ§Ø¯Ø± Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡Ùˆ UTC ÙÙ‚Ø·
  static String isoUtc(DateTime t) {
    return t.toUtc().toIso8601String();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/time_canon.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 227: lib/core/time/session_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/session_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 210.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class SessionFilter {
  static bool isWithinMarketHours(DateTime utc) {
    final weekday = utc.weekday;
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) return false;
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/session_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 228: lib/core/time/time_normalizer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/time_normalizer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 217.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class TimeNormalizer {
  static DateTime toUtc(dynamic input) {
    if (input is String) return DateTime.parse(input).toUtc();
    if (input is DateTime) return input.toUtc();
    return DateTime.now().toUtc();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/time_normalizer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 229: lib/core/time/market_hours_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/time/market_hours_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 388.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class MarketHoursFilter {
  static bool isMarketOpen(DateTime timeUtc) {
    final weekday = timeUtc.weekday;
    final hour = timeUtc.hour;
    // Ø£Ù…Ø«Ù„Ø© (Forex): Ù…Ù† Ø§Ù„Ø£Ø­Ø¯ 22:00 Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù…Ø¹Ø© 22:00 UTC
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) return false;
    if (hour < 22 && weekday == DateTime.sunday) return false;
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/time/market_hours_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 230: lib/core/settings/mode_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/settings/mode_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 72.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 3
================================================================================

class ModeStorage {
  Future<String> getMode() async => 'production';
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/settings/mode_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 231: lib/core/settings/server_mode.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/settings/server_mode.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 153.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

enum ServerMode { production, staging }

ServerMode getServerMode() {
  // TODO: Replace with actual environment logic
  return ServerMode.production;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/settings/server_mode.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 232: lib/core/export/csv_exporter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/export/csv_exporter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 412.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:io';
import 'package:path_provider/path_provider.dart';

class CsvExporter {
  static Future<String> exportTrades(List<List<String>> rows) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File('${dir.path}/trades_export.csv');
    final sink = file.openWrite();
    for (var r in rows) sink.writeln(r.join(','));
    await sink.close();
    return file.path;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/export/csv_exporter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 233: lib/core/export/pdf/pdf_report.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/export/pdf/pdf_report.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 316.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart';

class PdfReport {
  static Future<List<int>> generate(List<String> lines) async {
    final pdf = Document();
    pdf.addPage(Page(build: (_) {
      return Column(children: lines.map((l) => Text(l)).toList());
    }));
    return pdf.save();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/export/pdf/pdf_report.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 234: lib/core/export/settings/json_settings_exporter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/export/settings/json_settings_exporter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 536.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:io';
import 'package:path_provider/path_provider.dart';

class JsonSettingsExporter {
  static Future<String> save(Map<String, dynamic> settings) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File('${dir.path}/settings_export.json');
    await file.writeAsString(settings.toString());
    return file.path;
  }

  static Future<Map<String, dynamic>> load(File file) async {
    final content = await file.readAsString();
    return Map<String, dynamic>.from(jsonDecode(content));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/export/settings/json_settings_exporter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 235: lib/core/security/token_refresh_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/security/token_refresh_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 446.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class TokenRefreshGuard {
  final FlutterSecureStorage _storage = const FlutterSecureStorage();

  Future<String?> refresh(String oldToken) async {
    try {
      // logic to refresh via REST
      final newToken = oldToken + "_refreshed"; 
      await _storage.write(key: "apiToken", value: newToken);
      return newToken;
    } catch (_) {
      return null;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/security/token_refresh_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 236: lib/core/security/secure_storage_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/security/secure_storage_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 577.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class SecureStorageManager {
  static final _storage = FlutterSecureStorage();

  static Future<void> saveOandaToken(String token) =>
      _storage.write(key: OandaConfig.tokenKey, value: token);

  static Future<String?> readOandaToken() =>
      _storage.read(key: OandaConfig.tokenKey);

  static Future<void> saveOandaAccount(String id) =>
      _storage.write(key: OandaConfig.accountKey, value: id);

  static Future<String?> readOandaAccount() =>
      _storage.read(key: OandaConfig.accountKey);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/security/secure_storage_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 237: lib/core/security/refresh/token_refresh_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/security/refresh/token_refresh_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 860.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../oanda/oanda_config.dart';

class TokenRefreshGuard {
  final _storage = FlutterSecureStorage();

  Future<String?> refresh(String oldToken) async {
    try {
      final res = await http.post(
        Uri.parse("\${OandaConfig.restBaseUrl}/oauth2/token"),
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: {
          'grant_type': 'refresh_token',
          'refresh_token': oldToken,
        },
      );
      if (res.statusCode == 200) {
        final json = jsonDecode(res.body);
        final newToken = json['access_token'];
        await _storage.write(key: OandaConfig.tokenKey, value: newToken);
        return newToken;
      }
    } catch (_) {}
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/security/refresh/token_refresh_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 238: lib/core/mode/mode_stream_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/mode/mode_stream_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 284.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:async';

class ModeStreamManager {
  final List<StreamSubscription> _streams = [];

  void register(StreamSubscription sub) => _streams.add(sub);

  Future<void> clearAll() async {
    for (final s in _streams) {
      await s.cancel();
    }
    _streams.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/mode/mode_stream_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 239: lib/core/mode/app_mode_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/mode/app_mode_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 341.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

enum AppMode { live, backtest }

class AppModeGuard {
  AppMode _current = AppMode.live;

  AppMode get current => _current;

  bool canEnterBacktest() => _current != AppMode.backtest;
  bool canEnterLive() => _current != AppMode.live;

  void enterBacktest() => _current = AppMode.backtest;
  void enterLive() => _current = AppMode.live;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/mode/app_mode_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 240: lib/core/audio/alert_sound.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/audio/alert_sound.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 263.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'package:audioplayers/audioplayers.dart';

class AlertSound {
  final AudioPlayer _player = AudioPlayer();

  Future<void> playBuy() => _player.play(AssetSource('audio/buy.mp3'));
  Future<void> playSell() => _player.play(AssetSource('audio/sell.mp3'));
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/audio/alert_sound.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 241: lib/core/audio/alert_sound_singleton.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/audio/alert_sound_singleton.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 425.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:audioplayers/audioplayers.dart';

class AlertSoundManager {
  static final AlertSoundManager _instance = AlertSoundManager._internal();
  factory AlertSoundManager() => _instance;

  final AudioPlayer _player = AudioPlayer();

  AlertSoundManager._internal();

  Future<void> playBuy() => _player.play(AssetSource('audio/buy.mp3'));
  Future<void> playSell() => _player.play(AssetSource('audio/sell.mp3'));
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/audio/alert_sound_singleton.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 242: lib/core/streams/symbol_stream_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/streams/symbol_stream_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 315.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class SymbolStreamGuard {
  StreamSubscription? _sub;

  void bind(Stream stream, void Function(dynamic) onData) {
    _sub?.cancel(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯Ø§Ø¦Ù…Ù‹Ø§
    _sub = stream.listen(onData);
  }

  void dispose() {
    _sub?.cancel();
    _sub = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/streams/symbol_stream_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 243: lib/core/ui/theme_setup.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/theme_setup.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 243.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:flutter/material.dart';

final lightTheme = ThemeData.light().copyWith(
  primaryColor: Colors.blue,
  scaffoldBackgroundColor: Colors.white,
);

final darkTheme = ThemeData.dark().copyWith(
  primaryColor: Colors.blueGrey,
);

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/theme_setup.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 244: lib/core/ui/theme_notifier.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/theme_notifier.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 239.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:flutter/material.dart';

class ThemeNotifier extends ChangeNotifier {
  ThemeMode _mode = ThemeMode.system;

  ThemeMode get mode => _mode;

  void setMode(ThemeMode value) {
    _mode = value;
    notifyListeners();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/theme_notifier.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 245: lib/core/ui/fonts/text_style_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/fonts/text_style_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 247.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'package:flutter/material.dart';

class TextStyleManager {
  static TextStyle headline(BuildContext ctx) =>
      Theme.of(ctx).textTheme.headline6!;

  static TextStyle body(BuildContext ctx) =>
      Theme.of(ctx).textTheme.bodyText2!;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/fonts/text_style_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 246: lib/core/ui/theme/app_themes.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/theme/app_themes.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 369.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/material.dart';

final ThemeData lightTheme = ThemeData(
  colorScheme: ColorScheme.fromSeed(seedColor: Colors.indigo),
  useMaterial3: true,
  scaffoldBackgroundColor: Colors.white,
);

final ThemeData darkTheme = ThemeData(
  brightness: Brightness.dark,
  colorScheme: ColorScheme.fromSeed(seedColor: Colors.indigo),
  useMaterial3: true,
);

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/theme/app_themes.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 247: lib/core/ui/styles/app_theme.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/styles/app_theme.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 494.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter/material.dart';

final ThemeData kLightTheme = ThemeData(
  primarySwatch: Colors.indigo,
  visualDensity: VisualDensity.adaptivePlatformDensity,
  scaffoldBackgroundColor: Colors.white,
  appBarTheme: AppBarTheme(
    elevation: 0,
    backgroundColor: Colors.indigo,
    titleTextStyle: TextStyle(
      fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white),
  ),
);

final ThemeData kDarkTheme = ThemeData.dark().copyWith(
  primaryColor: Colors.indigo,
);

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/styles/app_theme.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 248: lib/core/ui/widgets/responsive_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/responsive_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 436.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter/material.dart';

class ResponsiveWidget extends StatelessWidget {
  final Widget mobile;
  final Widget tablet;

  const ResponsiveWidget({
    required this.mobile,
    required this.tablet,
  });

  @override
  Widget build(BuildContext context) => LayoutBuilder(
        builder: (context, constraints) {
          if (constraints.maxWidth > 600) return tablet;
          return mobile;
        },
      );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/responsive_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 249: lib/core/ui/widgets/error_screen.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/error_screen.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 639.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter/material.dart';

class ErrorScreen extends StatelessWidget {
  final String message;
  const ErrorScreen(this.message);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(mainAxisSize: MainAxisSize.min, children: [
          Icon(Icons.error, size: 64, color: Colors.red),
          SizedBox(height: 12),
          Text(message, textAlign: TextAlign.center),
          SizedBox(height: 20),
          ElevatedButton(
            child: Text("Retry"),
            onPressed: () => Navigator.pop(context),
          ),
        ]),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/error_screen.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 250: lib/core/ui/widgets/shimmer_placeholder.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/shimmer_placeholder.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 536.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

class ShimmerPlaceholder extends StatelessWidget {
  final double width;
  final double height;

  const ShimmerPlaceholder({required this.width, required this.height});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey.shade300,
      highlightColor: Colors.grey.shade100,
      child: Container(
        width: width,
        height: height,
        color: Colors.grey,
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/shimmer_placeholder.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 251: lib/core/ui/widgets/add_to_watchlist_sheet.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/add_to_watchlist_sheet.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 662.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:flutter/material.dart';
import '../../../../core/storage/watchlist.dart';

class AddToWatchlistSheet extends StatelessWidget {
  final String symbol;
  const AddToWatchlistSheet(this.symbol);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: EdgeInsets.all(16),
      child: Column(mainAxisSize: MainAxisSize.min, children: [
        Text("Add \${symbol} to Watchlist?"),
        SizedBox(height: 10),
        ElevatedButton(
          child: Text("Add"),
          onPressed: () {
            WatchlistManager().add(symbol);
            Navigator.pop(context);
          },
        ),
      ]),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/add_to_watchlist_sheet.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 252: lib/core/ui/widgets/loading_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/loading_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 493.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter/material.dart';

class LoadingWidget extends StatelessWidget {
  final String message;
  const LoadingWidget({this.message = "Loading..."});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          CircularProgressIndicator(),
          SizedBox(height: 12),
          Text(message, style: Theme.of(context).textTheme.bodyMedium),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/loading_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 253: lib/core/ui/widgets/base_scaffold.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/base_scaffold.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 563.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter/material.dart';

class BaseScaffold extends StatelessWidget {
  final String title;
  final Widget body;
  final List<Widget>? actions;

  const BaseScaffold({
    required this.title,
    required this.body,
    this.actions,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(title),
        actions: actions,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: body,
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/base_scaffold.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 254: lib/core/ui/widgets/error_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/error_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 411.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter/material.dart';

class AppErrorWidget extends StatelessWidget {
  final String message;
  AppErrorWidget(this.message);

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(mainAxisSize: MainAxisSize.min, children: [
        Icon(Icons.error, size: 42, color: Colors.red),
        SizedBox(height: 10),
        Text(message),
      ]),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/error_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 255: lib/core/ui/widgets/chart_webview.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui/widgets/chart_webview.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 364.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class ChartWebView extends StatelessWidget {
  final String url;

  const ChartWebView({required this.url});

  @override
  Widget build(BuildContext context) {
    return WebView(
      initialUrl: url,
      javascriptMode: JavascriptMode.unrestricted,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui/widgets/chart_webview.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 256: lib/core/persistence/persistent_state_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/persistence/persistent_state_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 511.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class PersistentStateManager {
  static Future<void> save(String key, Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }
  static Future<Map<String, dynamic>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/persistence/persistent_state_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 257: lib/core/compute/backtest_save_isolate.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/compute/backtest_save_isolate.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 115.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

import 'dart:isolate';

Future<void> saveBacktestInIsolate(Function saveFn) async {
  await Isolate.run(saveFn);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/compute/backtest_save_isolate.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 258: lib/core/compute/async_loader_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/compute/async_loader_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 109.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

import 'dart:isolate';

Future<T> runInIsolate<T>(T Function() fn) async {
  return await Isolate.run(fn);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/compute/async_loader_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 259: lib/core/compute/history_fetch_isolate.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/compute/history_fetch_isolate.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 137.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import 'dart:isolate';

class HistoryFetchIsolate {
  static Future<List<dynamic>> run(fetchFn) =>
      Isolate.run(() => fetchFn());
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/compute/history_fetch_isolate.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 260: lib/core/compute/isolate_task_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/compute/isolate_task_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 367.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'dart:isolate';

class IsolateTaskManager {
  final List<Isolate> _isolates = [];

  Future<Isolate> spawn(Function entry) async {
    final iso = await Isolate.spawn(entry, null);
    _isolates.add(iso);
    return iso;
  }

  void killAll() {
    for (final iso in _isolates) {
      iso.kill(priority: Isolate.immediate);
    }
    _isolates.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/compute/isolate_task_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 261: lib/core/compute/backtest_chunked_runner.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/compute/backtest_chunked_runner.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 252.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'dart:isolate';

class BacktestChunkedRunner {
  static Future<void> run(List dataset, void Function(dynamic) onResult) async {
    await Isolate.run(() async {
      for (final chunk in dataset) {
        onResult(chunk);
      }
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/compute/backtest_chunked_runner.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 262: lib/core/permissions/permission_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/permissions/permission_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 372.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:permission_handler/permission_handler.dart';

class PermissionManager {
  static Future<bool> requestStorage() async {
    final status = await Permission.storage.request();
    return status.isGranted;
  }

  static Future<bool> requestNotifications() async {
    final status = await Permission.notification.request();
    return status.isGranted;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/permissions/permission_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 263: lib/core/chart_sync_manager/multi_tf_sync.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart_sync_manager/multi_tf_sync.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 3.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 120
================================================================================

import 'dart:async';
import 'package:flutter/foundation.dart';
import '../../core/timeframes/timeframe_utils.dart';
import '../../features/market/domain/entities/candle.dart';
import '../../features/market/domain/repositories/market_repository.dart';
import '../../core/di/dependency_injection.dart';
import '../../features/market/domain/stream/stream_repository.dart';

/// Manager to handle multi timeframes + history paging + live streaming
class MultiTimeframeSync {
  final MarketRepository _marketRepo = di<MarketRepository>();
  final StreamRepository _streamRepo = di<StreamRepository>();

  /// buffers for each timeframe
  final Map<String, List<Candle>> _historyBuffers = {};
  final Map<String, StreamSubscription> _liveSubs = {};

  /// load historical candles with paging
  Future<List<Candle>> loadHistoryPage({
    required String accountId,
    required String symbol,
    required String timeframe,
    int page = 0,
    int pageSize = 200,
  }) async {
    final total = await _marketRepo.fetchHistoricalCandles(
      accountId,
      symbol,
      timeframe,
    );
    // Simple paging â€” only returns slice
    final start = page * pageSize;
    final end = (start + pageSize).clamp(0, total.length);
    return total.sublist(start, end);
  }

  /// start live streaming for timeframe
  Future<void> startLive({
    required String accountId,
    required String symbol,
    required String timeframe,
    required void Function(List<Candle>) onUpdate,
  }) async {
    final key = "\$symbol|\$timeframe";

    // load history once first
    final history = await loadHistoryPage(
        accountId: accountId, symbol: symbol, timeframe: timeframe);
    _historyBuffers[key] = history;

    // call once after history loaded
    onUpdate(List.unmodifiable(history));

    // now stream
    await _streamRepo.start(
      accountId: accountId,
      instruments: symbol,
      headers: {"Authorization": "Bearer \${await _getToken()}"},
    );

    // cancel existing subscription if exists
    await _liveSubs[key]?.cancel();

    // subscribe
    _liveSubs[key] = _streamRepo.ticks().listen((raw) {
      try {
        final liveCandle = Candle(
          time: DateTime.parse(raw["time"] as String),
          open: (raw["open"] as num).toDouble(),
          high: (raw["high"] as num).toDouble(),
          low: (raw["low"] as num).toDouble(),
          close: (raw["close"] as num).toDouble(),
        );

        final dur = tfToDuration(timeframe);

        final buff = _historyBuffers[key] ?? [];
        if (buff.isEmpty ||
            liveCandle.time.isAfter(buff.last.time)) {
          final filled = _fillGaps(buff, liveCandle, dur);
          _historyBuffers[key] = filled;
          onUpdate(List.unmodifiable(filled));
        }
      } catch (_) {}
    });
  }

  /// fill any gap between last history candle and next live candle
  List<Candle> _fillGaps(
      List<Candle> history, Candle live, Duration dur) {
    final List<Candle> result = List.of(history);
    DateTime nextExpected =
        history.isEmpty ? live.time : history.last.time.add(dur);

    while (nextExpected.isBefore(live.time)) {
      final c = Candle(
        time: nextExpected,
        open: history.last.close,
        high: history.last.close,
        low: history.last.close,
        close: history.last.close,
      );
      result.add(c);
      nextExpected = nextExpected.add(dur);
    }
    result.add(live);
    return result;
  }

  /// stop streaming for this timeframe
  Future<void> stopLive(String symbol, String timeframe) async {
    final key = "\$symbol|\$timeframe";
    await _liveSubs[key]?.cancel();
    _streamRepo.stop();
    _historyBuffers.remove(key);
  }

  /// simple token loader â€” replace with secure storage
  Future<String> _getToken() => TokenStorage.getToken();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart_sync_manager/multi_tf_sync.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 264: lib/core/execution/offline_alerts_backtest_settings.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/execution/offline_alerts_backtest_settings.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 5.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 216
================================================================================

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter/widgets.dart';
import 'package:hive/hive.dart';
import '../../features/market/domain/entities/candle.dart';
import '../../core/timeframes/timeframe_utils.dart';

/// =================================================================
/// 1) OFFLINE STORAGE + REPLAY MANAGER
/// =================================================================

class OfflineHistoryManager {
  static const String boxName = "offline_history";

  static Future<void> init() async {
    await Hive.openBox<List>(boxName);
  }

  static List<Candle>? load(String symbol, String timeframe) {
    final box = Hive.box<List>(boxName);
    final data = box.get("\$symbol|\$timeframe");
    if (data == null) return null;
    return data.cast<Candle>();
  }

  static Future<void> save(String symbol, String timeframe,
      List<Candle> data) async {
    final box = Hive.box<List>(boxName);
    await box.put("\$symbol|\$timeframe", data);
  }
}

/// Replay Engine

typedef ReplayCallback = void Function(Candle);

class ReplayEngine {
  bool _paused = false;
  Timer? _timer;

  void start(List<Candle> history,
      {required ReplayCallback onFrame,
      Duration interval = const Duration(milliseconds: 300)}) {
    int index = 0;
    _paused = false;

    _timer?.cancel();
    _timer = Timer.periodic(interval, (t) {
      if (_paused || index >= history.length) {
        t.cancel();
        return;
      }
      onFrame(history[index]);
      index++;
    });
  }

  void pause() => _paused = true;
  void resume() => _paused = false;
  void stop() {
    _timer?.cancel();
    _paused = false;
  }
}

/// =================================================================
/// 2) ALERTS ENGINE
/// =================================================================

class Alert {
  final String id;
  final String symbol;
  final String condition; // e.g. "RSI<30"
  final bool active;

  Alert({
    required this.id,
    required this.symbol,
    required this.condition,
    this.active = true,
  });
}

class AlertEngine {
  final List<Alert> _alerts = [];
  final StreamController<Alert> _triggered =
      StreamController<Alert>.broadcast();

  Stream<Alert> get triggered => _triggered.stream;

  void add(Alert alert) {
    _alerts.add(alert);
  }

  void remove(String id) {
    _alerts.removeWhere((a) => a.id == id);
  }

  void evaluate(Candle candle) {
    for (var a in _alerts) {
      if (!a.active) continue;
      // Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ·: RSI<30
      if (a.condition.startsWith("RSI<")) {
        final threshold =
            int.parse(a.condition.split("<")[1].trim());
        if (candle.close < threshold) {
          _triggered.add(a);
        }
      }
    }
  }

  void dispose() {
    _triggered.close();
  }
}

/// =================================================================
/// 3) BACKTEST VISUALIZATION
/// =================================================================

class BacktestResult {
  final double netProfit;
  final double maxDrawdown;
  final int totalTrades;
  final List<double> equityCurve;

  BacktestResult({
    required this.netProfit,
    required this.maxDrawdown,
    required this.totalTrades,
    required this.equityCurve,
  });
}

class BacktestVisualizer {
  List<double> computeEquityCurve(List<double> returns) {
    List<double> curve = [];
    double total = 0;
    for (var r in returns) {
      total += r;
      curve.add(total);
    }
    return curve;
  }

  Widget equityCurveChart(List<double> curve) {
    return CustomPaint(
      size: Size.infinite,
      painter: _EquityCurvePainter(curve),
    );
  }
}

class _EquityCurvePainter extends CustomPainter {
  final List<double> curve;
  _EquityCurvePainter(this.curve);

  @override
  void paint(Canvas canvas, Size size) {
    if (curve.isEmpty) return;
    double maxY = curve.reduce((a, b) => a > b ? a : b);
    double minY = curve.reduce((a, b) => a < b ? a : b);

    var paint = Paint()
      ..color = Colors.green
      ..strokeWidth = 2.0
      ..style = PaintingStyle.stroke;

    var path = Path();
    for (int i = 0; i < curve.length; i++) {
      double x = (i / curve.length) * size.width;
      double y = size.height - ((curve[i] - minY) / (maxY - minY)) * size.height;
      if (i == 0) path.moveTo(x, y);
      else path.lineTo(x, y);
    }
    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant _EquityCurvePainter old) =>
      old.curve != curve;
}

/// =================================================================
/// 4) SETTINGS + THEME PERSISTENCE
/// =================================================================

class AppSettings {
  static const String boxName = "app_settings";

  static Future<void> init() async {
    await Hive.openBox(boxName);
  }

  static void saveThemeMode(ThemeMode mode) {
    final box = Hive.box(boxName);
    box.put("theme_mode", mode.index);
  }

  static ThemeMode loadThemeMode() {
    final box = Hive.box(boxName);
    final idx = box.get("theme_mode") ?? ThemeMode.system.index;
    return ThemeMode.values[idx];
  }

  static void saveIndicatorPrefs(List<String> prefs) {
    final box = Hive.box(boxName);
    box.put("indicator_prefs", prefs);
  }

  static List<String> loadIndicatorPrefs() {
    final box = Hive.box(boxName);
    return (box.get("indicator_prefs") ?? []).cast<String>();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/execution/offline_alerts_backtest_settings.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 265: lib/core/filters/candle_outlier_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/filters/candle_outlier_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 586.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import '../../core/models/candle_entity.dart';

class CandleOutlierFilter {
  final double maxAllowedRangePercentage;

  CandleOutlierFilter({this.maxAllowedRangePercentage = 50});

  /// Filters out candles whose range deviates too much compared to neighbors.
  bool isValid(CandleEntity candle) {
    if (candle.open == 0 || candle.high == 0 || candle.low == 0) {
      return false;
    }
    final range = candle.high - candle.low;
    final avgPrice = (candle.high + candle.low) / 2.0;
    final pct = (range / avgPrice) * 100.0;
    return pct <= maxAllowedRangePercentage;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/filters/candle_outlier_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 266: lib/core/filters/price_spike_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/filters/price_spike_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 210.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class PriceSpikeFilter {
  static bool isSpike(double prev, double curr, double thresholdPct) {
    final diff = (curr - prev).abs();
    final pct = (diff / prev) * 100.0;
    return pct > thresholdPct;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/filters/price_spike_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 267: lib/core/filters/range_filter_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/filters/range_filter_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 280.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import '../../core/models/candle_entity.dart';

class RangeFilterFix {
  List<CandleEntity> filterRange(
      List<CandleEntity> data, DateTime from, DateTime to) {
    return data.where((c) =>
        !c.timeUtc.isBefore(from) &&
        !c.timeUtc.isAfter(to)).toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/filters/range_filter_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 268: lib/core/telemetry/sentry_service.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/telemetry/sentry_service.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 213.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'package:sentry_flutter/sentry_flutter.dart';

class SentryService {
  static Future<void> init() async {
    await SentryFlutter.init(
      (options) => options.dsn = 'YOUR_SENTRY_DSN_HERE',
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/telemetry/sentry_service.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 269: lib/core/ui_helpers/app_init_and_replay_alert_ui.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/ui_helpers/app_init_and_replay_alert_ui.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.9 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 69
================================================================================

import 'package:flutter/material.dart';
import '../../core/execution/offline_alerts_backtest_settings.dart';

/// =======================================================
///   App Initialization (Offline + Settings + Hive)
/// =======================================================

Future<void> initApp() async {
  await OfflineHistoryManager.init();
  await AppSettings.init();
}

/// =======================================================
///   Simple Replay UI
/// =======================================================

Widget replayControls({
  required ReplayEngine engine,
  required VoidCallback onPause,
  required VoidCallback onResume,
  required VoidCallback onStop,
}) {
  return Row(
    mainAxisAlignment: MainAxisAlignment.center,
    children: [
      ElevatedButton(onPressed: onPause, child: Text("Pause")),
      SizedBox(width: 8),
      ElevatedButton(onPressed: onResume, child: Text("Resume")),
      SizedBox(width: 8),
      ElevatedButton(onPressed: onStop, child: Text("Stop")),
    ],
  );
}

/// =======================================================
///   Simple Alerts UI
/// =======================================================

Widget alertListView(List<Alert> alerts) {
  return ListView.builder(
    itemCount: alerts.length,
    itemBuilder: (ctx, idx) {
      final a = alerts[idx];
      return ListTile(
        title: Text("Alert: \${a.condition}"),
        subtitle: Text("Symbol: \${a.symbol}"),
      );
    },
  );
}

/// =======================================================
///   Backtest Report UI
/// =======================================================

Widget backtestReport({
  required BacktestResult result,
  required Widget equityChart,
}) {
  return Column(
    children: [
      Text("Net Profit: \${result.netProfit}"),
      Text("Drawdown: \${result.maxDrawdown}"),
      Text("Trades: \${result.totalTrades}"),
      SizedBox(height: 12),
      Expanded(child: equityChart),
    ],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/ui_helpers/app_init_and_replay_alert_ui.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 270: lib/core/timeframes/timeframe_utils.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/timeframes/timeframe_utils.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 462.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter/foundation.dart';

Duration tfToDuration(String tf) {
  switch (tf.toUpperCase()) {
    case "M1":
      return Duration(minutes: 1);
    case "M2":
      return Duration(minutes: 2);
    case "M3":
      return Duration(minutes: 3);
    case "M5":
      return Duration(minutes: 5);
    case "M15":
      return Duration(minutes: 15);
    case "H1":
      return Duration(hours: 1);
    default:
      return Duration(minutes: 1);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/timeframes/timeframe_utils.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 271: lib/core/queue/execution_queue.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/queue/execution_queue.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 532.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'dart:async';

/// A simple sequential queue for async tasks.
/// Ensures tasks run one at a time in order.
class ExecutionQueue {
  final _taskController = StreamController<Future Function()>();

  ExecutionQueue() {
    _taskController.stream.asyncMap((task) => task()).listen((_) {});
  }

  /// Add a function that returns a Future to the queue.
  void schedule(Future Function() task) {
    _taskController.add(task);
  }

  /// Close the queue.
  Future<void> dispose() async {
    await _taskController.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/queue/execution_queue.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 272: lib/core/widgets/keep_alive_chart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/keep_alive_chart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 483.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter/widgets.dart';

class KeepAliveChart extends StatefulWidget {
  final Widget child;

  KeepAliveChart({required this.child});

  @override
  _KeepAliveChartState createState() => _KeepAliveChartState();
}

class _KeepAliveChartState extends State<KeepAliveChart>
    with AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true;

  @override
  Widget build(BuildContext context) {
    super.build(context);
    return widget.child;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/keep_alive_chart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 273: lib/core/widgets/error_view.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/error_view.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 975.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'package:flutter/material.dart';

/// A reusable error widget.
/// Displays a message and a retry button.
class ErrorView extends StatelessWidget {
  final String message;
  final VoidCallback onRetry;

  const ErrorView({
    required this.message,
    required this.onRetry,
  });

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.error_outline, size: 60, color: Colors.red),
            SizedBox(height: 12),
            Text(
              message,
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 18),
            ),
            SizedBox(height: 16),
            ElevatedButton(
              onPressed: onRetry,
              child: Text("Try Again"),
            ),
          ],
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/error_view.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 274: lib/core/widgets/crosshair.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/crosshair.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 794.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter/material.dart';

class CrosshairPainter extends CustomPainter {
  final Offset position;
  final XAxisRange visibleRange;
  final double minPrice;
  final double maxPrice;

  CrosshairPainter({
    required this.position,
    required this.visibleRange,
    required this.minPrice,
    required this.maxPrice,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.white70
      ..strokeWidth = 1;

    // Vertical line
    canvas.drawLine(Offset(position.dx, 0), Offset(position.dx, size.height), paint);

    // Horizontal line
    canvas.drawLine(Offset(0, position.dy), Offset(size.width, position.dy), paint);
  }

  @override
  bool shouldRepaint(covariant CrosshairPainter old) => old.position != position;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/crosshair.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 275: lib/core/widgets/marker_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/marker_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 627.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter/material.dart';

class MarkerPainter extends CustomPainter {
  final List<Offset> buyPoints;
  final List<Offset> sellPoints;

  MarkerPainter({required this.buyPoints, required this.sellPoints});

  @override
  void paint(Canvas canvas, Size size) {
    final paintBuy = Paint()..color = Colors.greenAccent;
    final paintSell = Paint()..color = Colors.redAccent;

    for (var p in buyPoints) {
      canvas.drawCircle(p, 6, paintBuy);
    }
    for (var p in sellPoints) {
      canvas.drawCircle(p, 6, paintSell);
    }
  }

  @override
  bool shouldRepaint(covariant MarkerPainter old) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/marker_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 276: lib/core/widgets/notification_toast.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/notification_toast.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 241.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'package:fluttertoast/fluttertoast.dart';

class NotificationToast {
  static void show(String msg) {
    Fluttertoast.showToast(
      msg: msg,
      toastLength: Toast.LENGTH_SHORT,
      gravity: ToastGravity.BOTTOM,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/notification_toast.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 277: lib/core/widgets/shimmer_placeholder.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/shimmer_placeholder.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 531.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

class ShimmerPlaceholder extends StatelessWidget {
  final double height;
  final double width;

  ShimmerPlaceholder({this.height = 100, this.width = double.infinity});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey[300]!,
      highlightColor: Colors.grey[100]!,
      child: Container(
        height: height,
        width: width,
        color: Colors.white,
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/shimmer_placeholder.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 278: lib/core/widgets/error_display.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/error_display.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 768.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter/material.dart';

class ErrorDisplay extends StatelessWidget {
  final String message;
  final VoidCallback? onRetry;

  const ErrorDisplay({required this.message, this.onRetry});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.error_outline, size: 48, color: Colors.redAccent),
          SizedBox(height: 12),
          Text(message, textAlign: TextAlign.center),
          SizedBox(height: 12),
          if (onRetry != null)
            ElevatedButton.icon(
              icon: Icon(Icons.refresh),
              label: Text("Retry"),
              onPressed: onRetry,
            ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/error_display.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 279: lib/core/widgets/animation_controller_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/animation_controller_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 308.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:flutter/animation.dart';

class AnimationControllerGuard {
  final List<AnimationController> _controllers = [];

  void register(AnimationController c) => _controllers.add(c);

  void disposeAll() {
    for (final c in _controllers) {
      c.dispose();
    }
    _controllers.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/animation_controller_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 280: lib/core/widgets/keep_alive_responsive.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/keep_alive_responsive.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 512.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter/widgets.dart';

class KeepAliveResponsive extends StatefulWidget {
  final Widget child;
  KeepAliveResponsive({required this.child});

  @override
  _KeepAliveResponsiveState createState() => _KeepAliveResponsiveState();
}

class _KeepAliveResponsiveState extends State<KeepAliveResponsive>
    with AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true;

  @override
  Widget build(BuildContext context) {
    super.build(context);
    return widget.child;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/keep_alive_responsive.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 281: lib/core/widgets/loading/shimmer_loader.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/loading/shimmer_loader.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 531.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

class ShimmerLoader extends StatelessWidget {
  final double height;
  final double width;
  const ShimmerLoader({this.height = 80, this.width = double.infinity});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey.shade300,
      highlightColor: Colors.grey.shade100,
      child: Container(
        height: height,
        width: width,
        color: Colors.white,
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/loading/shimmer_loader.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 282: lib/core/widgets/mixins/safe_widget_dispose.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/mixins/safe_widget_dispose.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 590.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'dart:async';
import 'package:flutter/widgets.dart';

mixin SafeWidgetDispose<T extends StatefulWidget> on State<T> {
  final List<StreamSubscription> _subs = [];
  final List<AnimationController> _controllers = [];

  void trackSub(StreamSubscription sub) => _subs.add(sub);

  void trackController(AnimationController controller) =>
      _controllers.add(controller);

  @override
  void dispose() {
    for (final sub in _subs) sub.cancel();
    _subs.clear();
    for (final controller in _controllers) controller.dispose();
    _controllers.clear();
    super.dispose();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/mixins/safe_widget_dispose.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 283: lib/core/widgets/fix/disposable_stateful.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/fix/disposable_stateful.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 216.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:flutter/widgets.dart';

abstract class DisposableStateful<T extends StatefulWidget> extends State<T> {
  @override
  void dispose() {
    super.dispose();
  }

  void cleanUp() {
    dispose();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/fix/disposable_stateful.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 284: lib/core/widgets/fix/repaint_boundary_chart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/widgets/fix/repaint_boundary_chart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 263.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:flutter/widgets.dart';

class RepaintBoundaryChart extends StatelessWidget {
  final Widget child;

  RepaintBoundaryChart({required this.child});

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(child: child);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/widgets/fix/repaint_boundary_chart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 285: lib/core/async/batch_computer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/async/batch_computer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 343.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:async';

class BatchComputer {
  Future<void> processInBatches<T>(
      List<T> items,
      Future<void> Function(T) action,
      {int batchSize = 1000}) async {
    for (var i = 0; i < items.length; i += batchSize) {
      final batch = items.sublist(i, i + batchSize);
      await Future.wait(batch.map(action));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/async/batch_computer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 286: lib/core/async/dispatcher.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/async/dispatcher.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 241.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'dart:async';
import 'package:flutter/foundation.dart';

class Dispatcher {
  static Future<T> computeAsync<T>(FutureOr<T> Function() fn) {
    return compute(_wrap, fn);
  }

  static T _wrap<T>(FutureOr<T> Function() fn) => fn();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/async/dispatcher.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 287: lib/core/backtest/backtest_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/backtest/backtest_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 104
================================================================================

import 'dart:async';
import '../network/ws/ws_manager.dart';
import '../network/rest/rest_client.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';

/// BACKTEST RESULT data class
class BacktestResult {
  final double netProfit;
  final double maxDrawdown;
  final int totalTrades;
  final List<double> equityCurve;

  BacktestResult({
    required this.netProfit,
    required this.maxDrawdown,
    required this.totalTrades,
    required this.equityCurve,
  });
}

/// BacktestEngine: ÙŠØ´Ø±Ù‘Ø¹ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ù„ÙÙŠ
class BacktestEngine {
  final RestClient restClient;
  final WsManager? wsManager;
  final Duration timeframe;

  BacktestEngine({
    required this.restClient,
    this.wsManager,
    this.timeframe = const Duration(minutes: 1),
  });

  /// Perform full backtest
  Future<BacktestResult> run({
    required String symbol,
    required DateTime start,
    required DateTime end,
  }) async {
    // 1) Fetch history via REST
    final rawResponse = await restClient.get(
      "/v3/instruments/\$symbol/candles",
      query: {
        "from": start.toIso8601String(),
        "to": end.toIso8601String(),
        "granularity": "${timeframe.inMinutes}M",
      },
    );

    final List<dynamic> data = rawResponse.body.isNotEmpty
        ? (rawResponse.body as dynamic) ?? []
        : [];

    // 2) Parse history into candles
    final List<Candle> history = [];
    for (var item in data) {
      try {
        final o = item["open"] as num;
        final h = item["high"] as num;
        final l = item["low"] as num;
        final c = item["close"] as num;
        final t = DateTime.parse(item["time"] as String);
        history.add(
          Candle(openTime: t, open: o.toDouble(), high: h.toDouble(), low: l.toDouble(), close: c.toDouble()),
        );
      } catch (_) {}
    }

    if (history.isEmpty) {
      return BacktestResult(
        netProfit: 0,
        maxDrawdown: 0,
        totalTrades: 0,
        equityCurve: [],
      );
    }

    // 3) Equity Curve Simulation
    final List<double> curve = [];
    double equity = 0;
    double maxDD = 0;
    double peak = 0;
    int trades = 0;

    for (var c in history) {
      final change = (c.close - c.open);
      equity += change;
      curve.add(equity);

      if (equity > peak) peak = equity;
      final dd = peak - equity;
      if (dd > maxDD) maxDD = dd;
      trades++;
    }

    final netProfit = curve.isNotEmpty ? curve.last : 0;

    return BacktestResult(
      netProfit: netProfit,
      maxDrawdown: maxDD,
      totalTrades: trades,
      equityCurve: curve,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/backtest/backtest_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 288: lib/core/indicators/indicator_models.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/indicators/indicator_models.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 298.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../features/market/data/streaming/tick_aggregator.dart';

/// Indicator types enum
enum IndicatorType {
  ema,
  rsi,
}

/// Indicator configuration
class IndicatorConfig {
  final IndicatorType type;
  final int period;

  IndicatorConfig({required this.type, required this.period});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/indicators/indicator_models.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 289: lib/core/indicators/indicator_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/indicators/indicator_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.9 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 65
================================================================================

import 'dart:math';
import '../../features/market/data/streaming/tick_aggregator.dart';
import 'indicator_models.dart';

/// Core indicator calculator
class IndicatorEngine {

  /// Compute EMA on list of close prices
  static List<double> computeEMA(List<double> prices, int period) {
    if (prices.length < period) return [];

    List<double> ema = [];
    double multiplier = 2 / (period + 1);

    double prevEma = prices.take(period).reduce((a, b) => a + b) / period;
    ema.add(prevEma);

    for (int i = period; i < prices.length; i++) {
      prevEma = (prices[i] - prevEma) * multiplier + prevEma;
      ema.add(prevEma);
    }

    return ema;
  }

  /// Compute RSI on list of close prices
  static List<double> computeRSI(List<double> prices, int period) {
    if (prices.length <= period) return [];

    List<double> rsiValues = [];
    double gainSum = 0, lossSum = 0;

    for (int i = 1; i <= period; i++) {
      double diff = prices[i] - prices[i - 1];
      if (diff >= 0) gainSum += diff;
      else lossSum -= diff;
    }

    double avgGain = gainSum / period;
    double avgLoss = lossSum / period;
    double rs = avgLoss == 0 ? 0 : avgGain / avgLoss;
    rsiValues.add(100 - (100 / (1 + rs)));

    for (int i = period + 1; i < prices.length; i++) {
      double diff = prices[i] - prices[i - 1];
      avgGain = ((avgGain * (period - 1)) + (diff > 0 ? diff : 0)) / period;
      avgLoss = ((avgLoss * (period - 1)) + (diff < 0 ? -diff : 0)) / period;
      rs = avgLoss == 0 ? 0 : avgGain / avgLoss;
      rsiValues.add(100 - (100 / (1 + rs)));
    }

    return rsiValues;
  }

  /// Compute any indicator by config
  static List<double> compute(
      List<double> prices, IndicatorConfig config) {
    switch (config.type) {
      case IndicatorType.ema:
        return computeEMA(prices, config.period);
      case IndicatorType.rsi:
        return computeRSI(prices, config.period);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/indicators/indicator_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 290: lib/core/indicators/indicator_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/indicators/indicator_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 54
================================================================================

import 'package:flutter/material.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';
import 'indicator_models.dart';
import 'indicator_engine.dart';
import 'dart:math';

class IndicatorPainter extends CustomPainter {
  final List<Candle> candles;
  final List<IndicatorConfig> configs;

  IndicatorPainter({required this.candles, required this.configs});

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty || configs.isEmpty) return;

    final closes = candles.map((c) => c.close).toList();

    final maxPrice = candles.map((c) => c.high).reduce(max);
    final minPrice = candles.map((c) => c.low).reduce(min);
    final priceRange = maxPrice - minPrice;

    final barWidth = size.width / candles.length;

    for (var config in configs) {
      final values = IndicatorEngine.compute(closes, config);
      if (values.isEmpty) continue;

      final path = Path();
      final paint = Paint()
        ..strokeWidth = 1.5
        ..style = PaintingStyle.stroke
        ..color = config.type == IndicatorType.ema
            ? Colors.blue
            : Colors.orange;

      for (int i = 0; i < values.length; i++) {
        final x = i * barWidth;
        final y = size.height -
            ((values[i] - minPrice) / priceRange) * size.height;
        if (i == 0)
          path.moveTo(x, y);
        else
          path.lineTo(x, y);
      }

      canvas.drawPath(path, paint);
    }
  }

  @override
  bool shouldRepaint(covariant IndicatorPainter old) =>
      old.candles != candles || old.configs != configs;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/indicators/indicator_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 291: lib/core/drawing_tools/drawing_tools_integration.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/drawing_tools/drawing_tools_integration.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 4.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 211
================================================================================

import 'package:flutter/material.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';
import '../drawing/undo_redo_drawing_manager.dart';

/// =======================
/// Drawing Tool Types
/// =======================
enum DrawTool {
  none,
  trendline,
  horizontal,
  box,
}

/// =======================
/// Data Classes
/// =======================
abstract class DrawShape {
  void paint(Canvas canvas, Paint paint);
}

class TrendlineShape extends DrawShape {
  final Offset start;
  final Offset end;

  TrendlineShape(this.start, this.end);

  @override
  void paint(Canvas canvas, Paint paint) {
    canvas.drawLine(start, end, paint);
  }
}

class HorizontalShape extends DrawShape {
  final double y;

  HorizontalShape(this.y);

  @override
  void paint(Canvas canvas, Paint paint) {
    canvas.drawLine(Offset(0, y), Offset(canvasSize.width, y), paint);
  }

  static Size canvasSize = Size.zero;
}

class BoxShape extends DrawShape {
  final Offset start;
  final Offset end;

  BoxShape(this.start, this.end);

  @override
  void paint(Canvas canvas, Paint paint) {
    final rect = Rect.fromPoints(start, end);
    canvas.drawRect(rect, paint);
  }
}

/// =======================
/// Drawing Controller (Merged with UndoRedo)
/// =======================
class DrawingToolController {
  final UndoRedoManager _undoRedo = UndoRedoManager();
  final List<DrawShape> _shapes = [];

  DrawTool currentTool = DrawTool.none;
  Offset? startPoint;

  List<DrawShape> get shapes => List.unmodifiable(_shapes);

  void setTool(DrawTool tool) {
    currentTool = tool;
  }

  void onTapDown(Offset position) {
    if (currentTool == DrawTool.none) return;
    startPoint = position;
  }

  void onTapUp(Offset position) {
    if (startPoint == null || currentTool == DrawTool.none) return;

    DrawShape shape;
    switch (currentTool) {
      case DrawTool.trendline:
        shape = TrendlineShape(startPoint!, position);
        break;
      case DrawTool.horizontal:
        shape = HorizontalShape(position.dy);
        break;
      case DrawTool.box:
        shape = BoxShape(startPoint!, position);
        break;
      default:
        return;
    }

    _shapes.add(shape);
    _undoRedo.execute(DrawingCommand("shape", shape));
    startPoint = null;
  }

  void undo() {
    final cmd = _undoRedo.undo();
    if (cmd != null && cmd.data is DrawShape) {
      _shapes.remove(cmd.data);
    }
  }

  void redo() {
    final cmd = _undoRedo.redo();
    if (cmd != null && cmd.data is DrawShape) {
      _shapes.add(cmd.data);
    }
  }

  void clearAll() {
    _shapes.clear();
    _undoRedo.clear();
  }
}

/// =======================
/// Painter + Interaction
/// =======================
class DrawingToolsPainter extends CustomPainter {
  final List<DrawShape> shapes;

  DrawingToolsPainter(this.shapes);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.redAccent
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    for (var shape in shapes) {
      shape.paint(canvas, paint);
    }
  }

  @override
  bool shouldRepaint(covariant DrawingToolsPainter oldDelegate) =>
      oldDelegate.shapes != shapes;
}

/// =======================
/// Integrated Widget
/// =======================
class DrawingOverlay extends StatefulWidget {
  final Widget child;
  final DrawingToolController controller;

  const DrawingOverlay({
    required this.child,
    required this.controller,
  });

  @override
  _DrawingOverlayState createState() => _DrawingOverlayState();
}

class _DrawingOverlayState extends State<DrawingOverlay> {
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onPanStart: (details) =>
          widget.controller.onTapDown(details.localPosition),
      onPanUpdate: (details) => widget.controller.onTapUp(details.localPosition),
      child: Stack(
        children: [
          widget.child,
          CustomPaint(
            size: Size.infinite,
            painter: DrawingToolsPainter(widget.controller.shapes),
          ),
        ],
      ),
    );
  }
}

/// =======================
/// Repaint Boundary Helper
/// =======================
class ChartWithDrawing extends StatelessWidget {
  final List<Candle> candles;
  final DrawingToolController controller;
  final CustomPainter chartPainter;

  const ChartWithDrawing({
    required this.candles,
    required this.controller,
    required this.chartPainter,
  });

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(
      child: DrawingOverlay(
        controller: controller,
        child: CustomPaint(
          size: Size.infinite,
          painter: chartPainter,
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/drawing_tools/drawing_tools_integration.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 292: lib/core/chart_interaction/zoom_pan_crosshair.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/core/chart_interaction/zoom_pan_crosshair.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 3.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 143
================================================================================

import 'package:flutter/material.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';

/// Zoom & Pan Controller
class ChartViewportController extends ChangeNotifier {
  double scale = 1.0;
  double offsetX = 0.0;

  void zoom(double delta) {
    scale = (scale * delta).clamp(0.5, 5.0);
    notifyListeners();
  }

  void pan(double delta) {
    offsetX += delta;
    notifyListeners();
  }
}

/// Crosshair Data
class CrosshairData {
  final Offset position;
  final Candle candle;

  CrosshairData(this.position, this.candle);
}

/// Chart Interaction Widget
class ZoomPanCrosshairWidget extends StatefulWidget {
  final Widget child;
  final List<Candle> candles;
  final Function(CrosshairData?) onCrosshairUpdate;
  final ChartViewportController controller;

  ZoomPanCrosshairWidget({
    required this.child,
    required this.candles,
    required this.onCrosshairUpdate,
    required this.controller,
  });

  @override
  _ZoomPanCrosshairWidgetState createState() => _ZoomPanCrosshairWidgetState();
}

class _ZoomPanCrosshairWidgetState extends State<ZoomPanCrosshairWidget> {
  Offset? _crosshairPos;
  Candle? _currentCandle;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onScaleUpdate: (details) {
        widget.controller.zoom(details.scale);
      },
      onHorizontalDragUpdate: (details) {
        widget.controller.pan(details.delta.dx);
      },
      onLongPressStart: (details) {
        _updateCrosshair(details.localPosition);
      },
      onLongPressMoveUpdate: (details) {
        _updateCrosshair(details.localPosition);
      },
      onLongPressEnd: (_) {
        _updateCrosshair(null);
      },
      child: Stack(
        children: [
          widget.child,
          if (_crosshairPos != null && _currentCandle != null)
            Positioned(
              left: _crosshairPos!.dx,
              top: _crosshairPos!.dy,
              child: _CrosshairOverlay(candle: _currentCandle!),
            ),
        ],
      ),
    );
  }

  void _updateCrosshair(Offset? pos) {
    if (pos == null) {
      setState(() {
        _crosshairPos = null;
        _currentCandle = null;
      });
      widget.onCrosshairUpdate(null);
      return;
    }
    final list = widget.candles;
    if (list.isEmpty) return;

    // Snap to nearest candle
    double minDist = double.infinity;
    Candle? nearest;
    for (var c in list) {
      // assume equal spacing horizontally
      final idx = list.indexOf(c);
      final x = idx * (MediaQuery.of(context).size.width / list.length) * widget.controller.scale - widget.controller.offsetX;
      final dist = (x - pos.dx).abs();
      if (dist < minDist) {
        minDist = dist;
        nearest = c;
      }
    }

    setState(() {
      _crosshairPos = pos;
      _currentCandle = nearest;
    });
    if (nearest != null) {
      widget.onCrosshairUpdate(CrosshairData(pos, nearest));
    }
  }
}

/// Crosshair Overlay Painter
class _CrosshairOverlay extends StatelessWidget {
  final Candle candle;

  const _CrosshairOverlay({required this.candle});

  @override
  Widget build(BuildContext context) {
    return Card(
      color: Colors.black.withOpacity(0.7),
      child: Padding(
        padding: const EdgeInsets.all(6),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text("T: \${candle.openTime}", style: TextStyle(color: Colors.white, fontSize: 12)),
            Text("O: \${candle.open}", style: TextStyle(color: Colors.white, fontSize: 12)),
            Text("H: \${candle.high}", style: TextStyle(color: Colors.white, fontSize: 12)),
            Text("L: \${candle.low}", style: TextStyle(color: Colors.white, fontSize: 12)),
            Text("C: \${candle.close}", style: TextStyle(color: Colors.white, fontSize: 12)),
          ],
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/core/chart_interaction/zoom_pan_crosshair.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 293: lib/features/strategy/domain/strategy_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/strategy_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 320.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'strategy_model.dart';

class StrategyEngine {
  final List<StrategyModel> strategies;

  StrategyEngine(this.strategies);

  String? evaluate(List<String> activeSignals) {
    for (final strategy in strategies) {
      if (strategy.canTrigger(activeSignals)) return strategy.action;
    }
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/strategy_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 294: lib/features/strategy/domain/strategy_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/strategy_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 310.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

class StrategyModel {
  final List<String> requiredSignals;
  final String action; // BUY / SELL

  StrategyModel({
    required this.requiredSignals,
    required this.action,
  });

  bool canTrigger(List<String> activeSignals) {
    return requiredSignals.every((sig) => activeSignals.contains(sig));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/strategy_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 295: lib/features/strategy/domain/strategy_safe_eval_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/strategy_safe_eval_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 108.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

bool canEvaluate(Map<String, double> indicators) {
  if (indicators.isEmpty) return false;
  return true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/strategy_safe_eval_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 296: lib/features/strategy/domain/strategy_engine_cleanup_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/strategy_engine_cleanup_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 98.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 3
================================================================================

class StrategyEngineCleanupFix {
  void clearCache(Map<String, double> cache) => cache.clear();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/strategy_engine_cleanup_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 297: lib/features/strategy/domain/signal_evaluator_sync_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/signal_evaluator_sync_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 381.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../../core/sync/signal_sync_controller.dart';

class StrategyEvaluatorSyncFix {
  final SignalSyncController _sync = SignalSyncController();

  void evaluate(Map<String, double> indicators, Function applySignal) {
    _sync.addTask(() {
      if (!_sync.isClosed) {
        applySignal(indicators);
      }
    });
  }

  Future<void> dispose() => _sync.dispose();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/signal_evaluator_sync_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 298: lib/features/strategy/domain/undo_redo_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/undo_redo_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 329.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

class UndoRedoManager<T> {
  final List<T> _stack = [];
  int _pointer = -1;

  void add(T state) {
    _stack.removeRange(_pointer + 1, _stack.length);
    _stack.add(state);
    _pointer++;
  }

  T? undo() => _pointer > 0 ? _stack[--_pointer] : null;
  T? redo() => _pointer < _stack.length - 1 ? _stack[++_pointer] : null;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/undo_redo_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 299: lib/features/strategy/domain/fsm/strategy_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/fsm/strategy_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 89.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

enum StrategyState {
  idle,
  initializing,
  active,
  paused,
  error,
  completed,
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/fsm/strategy_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 300: lib/features/strategy/domain/fsm/strategy_fsm.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/fsm/strategy_fsm.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 371.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'strategy_state.dart';

class StrategyFSM {
  StrategyState _state = StrategyState.idle;
  StrategyState get state => _state;

  void transitionTo(StrategyState next) {
    // Ù…Ù†Ø·Ù‚ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¢Ù…Ù†
    if (_state == StrategyState.error && next != StrategyState.idle) return;
    _state = next;
  }

  bool get isRunning => _state == StrategyState.active;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/fsm/strategy_fsm.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 301: lib/features/strategy/domain/signal/signal.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/signal/signal.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 135.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

enum SignalType { buy, sell, hold }

class Signal {
  final SignalType type;
  final DateTime time;

  Signal(this.type, this.time);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/signal/signal.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 302: lib/features/strategy/domain/ast/greater_than_node.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/ast/greater_than_node.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 374.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'expr_node.dart';
import '../indicators/indicator.dart';
import '../../../core/models/candle_entity.dart';

class GreaterThanNode extends ExprNode {
  final Indicator<double> left;
  final Indicator<double> right;

  GreaterThanNode(this.left, this.right);

  @override
  bool evaluate(CandleEntity candle, int index) {
    return left.current > right.current;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/ast/greater_than_node.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 303: lib/features/strategy/domain/ast/and_node.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/ast/and_node.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 313.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'expr_node.dart';
import '../../../core/models/candle_entity.dart';

class AndNode extends ExprNode {
  final ExprNode a;
  final ExprNode b;

  AndNode(this.a, this.b);

  @override
  bool evaluate(CandleEntity candle, int index) {
    return a.evaluate(candle, index) && b.evaluate(candle, index);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/ast/and_node.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 304: lib/features/strategy/domain/ast/expr_node.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/ast/expr_node.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 185.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import '../../../core/models/candle_entity.dart';

abstract class ExprNode {
  /// ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø¹Ù†Ø¯ Ø´Ù…Ø¹Ø© Ù…Ø¹ÙŠÙ†Ø©
  bool evaluate(CandleEntity candle, int index);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/ast/expr_node.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 305: lib/features/strategy/domain/ast/cross_up_node.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/ast/cross_up_node.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 662.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'expr_node.dart';
import '../indicators/indicator.dart';
import '../../../core/models/candle_entity.dart';

class CrossUpNode extends ExprNode {
  final Indicator<double> fast;
  final Indicator<double> slow;
  double? _prevFast;
  double? _prevSlow;

  CrossUpNode(this.fast, this.slow);

  @override
  bool evaluate(CandleEntity candle, int index) {
    final currFast = fast.current;
    final currSlow = slow.current;

    bool crossed = false;

    if (_prevFast != null && _prevSlow != null) {
      crossed = (_prevFast! <= _prevSlow!) && (currFast > currSlow);
    }

    _prevFast = currFast;
    _prevSlow = currSlow;

    return crossed;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/ast/cross_up_node.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 306: lib/features/strategy/domain/ast/expr.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/ast/expr.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 637.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 35
================================================================================

abstract class Expr {
  bool eval(Map<String, double> ctx);
}

class GreaterThan extends Expr {
  final String left;
  final String right;

  GreaterThan(this.left, this.right);

  @override
  bool eval(Map<String, double> ctx) {
    return ctx[left]! > ctx[right]!;
  }
}

class LessThan extends Expr {
  final String left;
  final String right;

  LessThan(this.left, this.right);

  @override
  bool eval(Map<String, double> ctx) {
    return ctx[left]! < ctx[right]!;
  }
}

class AndExpr extends Expr {
  final Expr a, b;
  AndExpr(this.a, this.b);

  @override
  bool eval(Map<String, double> ctx) => a.eval(ctx) && b.eval(ctx);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/ast/expr.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 307: lib/features/strategy/domain/indicators/ema_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/indicators/ema_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 22.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class EMAIndicator {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/indicators/ema_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 308: lib/features/strategy/domain/indicators/rsi_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/indicators/rsi_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 22.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class RSIIndicator {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/indicators/rsi_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 309: lib/features/strategy/domain/indicators/bollinger_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/indicators/bollinger_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'indicator.dart';
import '../../../core/models/candle_entity.dart';
import 'dart:math';

class BollingerBand {
  final double upper;
  final double middle;
  final double lower;

  BollingerBand(this.upper, this.middle, this.lower);
}

class BollingerIndicator implements Indicator<BollingerBand> {
  final int period;
  final List<double> _closes = [];
  final List<BollingerBand> _series = [];

  BollingerIndicator(this.period);

  @override
  void addCandle(CandleEntity candle) {
    _closes.add(candle.close);
    if (_closes.length > period) _closes.removeAt(0);

    if (_closes.length == period) {
      final mean = _closes.reduce((a, b) => a + b) / period;
      final std = sqrt(_closes.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b) / period);
      final upper = mean + 2 * std;
      final lower = mean - 2 * std;
      _series.add(BollingerBand(upper, mean, lower));
    }
  }

  @override
  BollingerBand get current => _series.isEmpty ? BollingerBand(0,0,0) : _series.last;

  @override
  List<BollingerBand> get series => List.unmodifiable(_series);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/indicators/bollinger_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 310: lib/features/strategy/domain/indicators/ema.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/indicators/ema.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 699.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

import '../../../core/models/candle_entity.dart';
import 'indicator.dart';
import 'dart:math';

class EMAIndicator implements Indicator<double> {
  final int period;
  double? _prevEma;
  final List<double> _series = [];

  EMAIndicator(this.period);

  double get _multiplier => 2.0 / (period + 1);

  @override
  void addCandle(CandleEntity candle) {
    final price = candle.close;

    if (_prevEma == null) {
      _prevEma = price; // Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø©
    } else {
      _prevEma = (price - _prevEma!) * _multiplier + _prevEma!;
    }

    _series.add(_prevEma!);
  }

  @override
  double get current => _prevEma ?? 0.0;

  @override
  List<double> get series => List.unmodifiable(_series);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/indicators/ema.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 311: lib/features/strategy/domain/indicators/indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/indicators/indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 318.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import '../../../core/models/candle_entity.dart';

abstract class Indicator<T> {
  void addCandle(CandleEntity candle); // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  T get current;                        // Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø©
  List<T> get series;                  // Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/indicators/indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 312: lib/features/strategy/domain/evaluator/example_strategy.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/evaluator/example_strategy.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 40.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

dynamic buildExampleStrategy() => null;

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/evaluator/example_strategy.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 313: lib/features/strategy/domain/evaluator/sequential_evaluator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/evaluator/sequential_evaluator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 945.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 41
================================================================================

import '../../../core/models/candle_entity.dart';
import '../ast/expr_node.dart';
import '../indicators/ema.dart';

enum Signal { BUY, SELL, NONE }

class SequentialEvaluator {
  final EMAIndicator emaFast;
  final EMAIndicator emaSlow;
  final ExprNode root;

  SequentialEvaluator({
    required this.emaFast,
    required this.emaSlow,
    required this.root,
  });

  /// ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ø´Ù…ÙˆØ¹
  List<Signal> evaluateSeries(List<CandleEntity> history) {
    List<Signal> signals = [];

    for (int i = 0; i < history.length; i++) {
      final candle = history[i];

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø£ÙˆÙ„Ù‹Ø§
      emaFast.addCandle(candle);
      emaSlow.addCandle(candle);

      // ØªÙ‚ÙŠÙŠÙ… AST
      bool condition = root.evaluate(candle, i);

      if (condition) {
        signals.add(Signal.BUY);
      } else {
        signals.add(Signal.NONE);
      }
    }

    return signals;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/evaluator/sequential_evaluator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 314: lib/features/strategy/domain/dsl/strategy_dsl.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/dsl/strategy_dsl.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 166.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class StrategyDSLParser {
  /// Ù…Ø«Ø§Ù„: "EMA50 > EMA150 AND RSI14 < 30"
  static List<String> tokenize(String expr) =>
      expr.split(RegExp(r"\s+")).toList();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/dsl/strategy_dsl.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 315: lib/features/strategy/domain/dsl/strategy_dsl_safe_eval.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/dsl/strategy_dsl_safe_eval.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 288.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'strategy_dsl_validator.dart';
import 'strategy_dsl_safety.dart';

bool safeEval(String expr) {
  final tokens = expr.split(RegExp(r"\s+"));
  if (!StrategyDslValidator.isValid(tokens)) return false;
  if (!StrategyDslSafety.hasEnoughTokens(tokens)) return false;
  return true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/dsl/strategy_dsl_safe_eval.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 316: lib/features/strategy/domain/dsl/strategy_dsl_safety.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/dsl/strategy_dsl_safety.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 116.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class StrategyDslSafety {
  static bool hasEnoughTokens(List<String> tokens) {
    return tokens.length >= 3;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/dsl/strategy_dsl_safety.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 317: lib/features/strategy/domain/dsl/strategy_dsl_validator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/domain/dsl/strategy_dsl_validator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 356.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class StrategyDslValidator {
  static bool isValid(List<String> tokens) {
    if (tokens.isEmpty) return false;
    final ops = ['>', '<', '>=', '<=', 'AND', 'OR'];
    // Ø¨Ø³ÙŠØ· Ø¬Ø¯Ù‹Ø§: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ Operator Ø£Ùˆ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù‡
    if (ops.contains(tokens.first) || ops.contains(tokens.last)) return false;
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/domain/dsl/strategy_dsl_validator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 318: lib/features/strategy/presentation/widgets/strategy_dsl_editor.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/presentation/widgets/strategy_dsl_editor.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 749.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 30
================================================================================

import 'package:flutter/material.dart';

class StrategyDslEditor extends StatefulWidget {
  final String initial;
  final ValueChanged<String> onChanged;

  StrategyDslEditor({required this.initial, required this.onChanged});

  @override
  _StrategyDslEditorState createState() => _StrategyDslEditorState();
}

class _StrategyDslEditorState extends State<StrategyDslEditor> {
  late TextEditingController _ctrl;

  @override
  void initState() {
    super.initState();
    _ctrl = TextEditingController(text: widget.initial);
  }

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: _ctrl,
      decoration: InputDecoration(labelText: "Strategy Expression"),
      onSubmitted: widget.onChanged,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/presentation/widgets/strategy_dsl_editor.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 319: lib/features/strategy/presentation/bloc/strategy_builder_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/presentation/bloc/strategy_builder_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 924.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 42
================================================================================

abstract class StrategyBuilderEvent {}

class AddBlock extends StrategyBuilderEvent {
  final String id;
  final String type;
  final Map<String, dynamic> params;

  AddBlock({
    required this.id,
    required this.type,
    required this.params,
  });
}

class RemoveBlock extends StrategyBuilderEvent {
  final String id;
  RemoveBlock(this.id);
}

class ConnectBlocks extends StrategyBuilderEvent {
  final String fromId;
  final String toId;

  ConnectBlocks({required this.fromId, required this.toId});
}

class UpdateBlockParams extends StrategyBuilderEvent {
  final String id;
  final Map<String, dynamic> params;

  UpdateBlockParams({required this.id, required this.params});
}

class LoadStrategyGraph extends StrategyBuilderEvent {
  final String graphId;
  LoadStrategyGraph(this.graphId);
}

class SaveStrategyGraph extends StrategyBuilderEvent {
  final String graphId;
  SaveStrategyGraph(this.graphId);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/presentation/bloc/strategy_builder_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 320: lib/features/strategy/presentation/bloc/strategy_builder_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/presentation/bloc/strategy_builder_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 367.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../../core/models/strategy_graph.dart';

abstract class StrategyBuilderState {}

class BuilderInitial extends StrategyBuilderState {}

class BuilderLoaded extends StrategyBuilderState {
  final StrategyGraph graph;
  BuilderLoaded(this.graph);
}

class BuilderError extends StrategyBuilderState {
  final String message;
  BuilderError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/presentation/bloc/strategy_builder_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 321: lib/features/strategy/presentation/bloc/strategy_builder_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/presentation/bloc/strategy_builder_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 65
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'strategy_builder_event.dart';
import 'strategy_builder_state.dart';
import '../../../../core/storage/strategy/strategy_storage.dart';
import '../../../../core/models/strategy_graph.dart';

class StrategyBuilderBloc extends Bloc<StrategyBuilderEvent, StrategyBuilderState> {
  final StrategyStorage storage;

  StrategyBuilderBloc(this.storage) : super(BuilderInitial()) {
    on<AddBlock>(_onAddBlock);
    on<RemoveBlock>(_onRemoveBlock);
    on<ConnectBlocks>(_onConnect);
    on<UpdateBlockParams>(_onUpdateParams);
    on<LoadStrategyGraph>(_onLoad);
    on<SaveStrategyGraph>(_onSave);
  }

  StrategyGraph _current = StrategyGraph(blocks: [], connections: []);

  void _onAddBlock(AddBlock event, Emitter<StrategyBuilderState> emit) {
    _current.blocks.add(
      Block(id: event.id, type: event.type, params: event.params),
    );
    emit(BuilderLoaded(_current));
  }

  void _onRemoveBlock(RemoveBlock event, Emitter<StrategyBuilderState> emit) {
    _current.blocks.removeWhere((b) => b.id == event.id);
    _current.connections.removeWhere((c) => c.fromBlockId == event.id || c.toBlockId == event.id);
    emit(BuilderLoaded(_current));
  }

  void _onConnect(ConnectBlocks event, Emitter<StrategyBuilderState> emit) {
    _current.connections.add(Connection(fromBlockId: event.fromId, toBlockId: event.toId));
    emit(BuilderLoaded(_current));
  }

  void _onUpdateParams(UpdateBlockParams event, Emitter<StrategyBuilderState> emit) {
    final block = _current.blocks.firstWhere((b) => b.id == event.id);
    if (block != null) {
      block.params.addAll(event.params);
    }
    emit(BuilderLoaded(_current));
  }

  Future<void> _onLoad(LoadStrategyGraph event, Emitter<StrategyBuilderState> emit) async {
    try {
      final graph = await storage.load(event.graphId);
      _current = graph;
      emit(BuilderLoaded(graph));
    } catch (e) {
      emit(BuilderError(e.toString()));
    }
  }

  Future<void> _onSave(SaveStrategyGraph event, Emitter<StrategyBuilderState> emit) async {
    try {
      await storage.save(event.graphId, _current);
      emit(BuilderLoaded(_current));
    } catch (e) {
      emit(BuilderError(e.toString()));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/presentation/bloc/strategy_builder_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 322: lib/features/strategy/presentation/bloc/strategy_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy/presentation/bloc/strategy_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 329.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../domain/fsm/strategy_fsm.dart';

class StrategyBloc {
  final StrategyFSM fsm = StrategyFSM();

  void start() {
    fsm.transitionTo(StrategyState.initializing);
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    fsm.transitionTo(StrategyState.active);
  }

  void stop() {
    fsm.transitionTo(StrategyState.paused);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy/presentation/bloc/strategy_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 323: lib/features/market_depth/data/order_book_ws.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/data/order_book_ws.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 556.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import '../../../core/network/ws_manager.dart';
import '../domain/order_book.dart';

class OrderBookWs {
  final WSManager ws;
  OrderBookWs(this.ws);

  void listen(void Function(OrderBook) onUpdate) {
    ws.stream.listen((data) {
      final bids = <OrderBookLevel>[];
      final asks = <OrderBookLevel>[];
      for (var b in data['bids']) {
        bids.add(OrderBookLevel(b[0], b[1]));
      }
      for (var a in data['asks']) {
        asks.add(OrderBookLevel(a[0], a[1]));
      }
      onUpdate(OrderBook(bids: bids, asks: asks));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/data/order_book_ws.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 324: lib/features/market_depth/presentation/widgets/order_book_view.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/presentation/widgets/order_book_view.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 554.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter/material.dart';
import '../../domain/order_book.dart';

class OrderBookView extends StatelessWidget {
  final OrderBook book;
  OrderBookView(this.book);

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Expanded(child: ListView(
          children: book.bids.map((l) => Text("Bid ${l.price}: ${l.volume}")).toList(),
        )),
        Expanded(child: ListView(
          children: book.asks.map((l) => Text("Ask ${l.price}: ${l.volume}")).toList(),
        )),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/presentation/widgets/order_book_view.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 325: lib/features/market_depth/presentation/bloc/order_book_state_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/presentation/bloc/order_book_state_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 128.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class OrderBookState {
  final List bids;
  final List asks;

  OrderBookState({this.bids = const [], this.asks = const []});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/presentation/bloc/order_book_state_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 326: lib/features/market_depth/presentation/bloc/order_book_reset_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/presentation/bloc/order_book_reset_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 475.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

class OrderBookReset extends OrderBookEvent {}

class OrderBookBlocResetFix extends Bloc<OrderBookEvent, OrderBookState> {
  OrderBookBlocResetFix(): super(OrderBookInitial()) {
    on<OrderBookReset>((_, emit) {
      emit(OrderBookInitial(bids: [], asks: []));
    });

    on<SubscribeUpdates>((event, emit) {
      add(OrderBookReset()); // ØªÙ†Ø¸ÙŠÙ
      // Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Stream Ø¬Ø¯ÙŠØ¯
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/presentation/bloc/order_book_reset_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 327: lib/features/market_depth/presentation/bloc/order_book_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/presentation/bloc/order_book_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 605.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../domain/order_book.dart';

abstract class OrderBookEvent {}
class OrderBookUpdate extends OrderBookEvent {
  final OrderBook book;
  OrderBookUpdate(this.book);
}

abstract class OrderBookState {}
class OrderBookInitial extends OrderBookState {}
class OrderBookLoaded extends OrderBookState {
  final OrderBook book;
  OrderBookLoaded(this.book);
}

class OrderBookBloc extends Bloc<OrderBookEvent, OrderBookState> {
  OrderBookBloc(): super(OrderBookInitial()) {
    on<OrderBookUpdate>((evt, emit) => emit(OrderBookLoaded(evt.book)));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/presentation/bloc/order_book_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 328: lib/features/market_depth/domain/order_book_safe.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/domain/order_book_safe.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 130.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import 'order_book.dart';

class OrderBookSafe {
  static OrderBook empty() =>
      OrderBook(bids: const [], asks: const []);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/domain/order_book_safe.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 329: lib/features/market_depth/domain/order_book_sync.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/domain/order_book_sync.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 308.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:async';

class OrderBookSync {
  final _queue = StreamController<Function()>();

  OrderBookSync() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  void process(Function() updateFn) => _queue.add(updateFn);

  Future<void> dispose() async => _queue.close();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/domain/order_book_sync.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 330: lib/features/market_depth/domain/order_book.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market_depth/domain/order_book.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 260.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

class OrderBookLevel {
  final double price;
  final double volume;
  OrderBookLevel(this.price, this.volume);
}

class OrderBook {
  final List<OrderBookLevel> bids;
  final List<OrderBookLevel> asks;

  OrderBook({required this.bids, required this.asks});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market_depth/domain/order_book.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 331: lib/features/settings/presentation/settings_screen.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/settings_screen.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 604.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:flutter/material.dart';

class SettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")),
      body: ListView(
        children: [
          SwitchListTile(
            title: Text("Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"),
            value: true,
            onChanged: (val) {},
          ),
          ListTile(
            title: Text("Ù„ÙˆÙ† Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„ØµØ§Ø¹Ø¯Ø©"),
            trailing: CircleAvatar(backgroundColor: Colors.green),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/settings_screen.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 332: lib/features/settings/presentation/pages/settings_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/pages/settings_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 53
================================================================================

import 'package:flutter/material.dart';
import '../../../../core/security/secure_storage_manager.dart';

class SettingsPage extends StatefulWidget {
  @override
  _SettingsPageState createState() => _SettingsPageState();
}

class _SettingsPageState extends State<SettingsPage> {
  final _tokenCtrl = TextEditingController();
  final _accCtrl = TextEditingController();

  @override
  void initState() {
    super.initState();
    SecureStorageManager.readOandaToken().then((t) {
      if (t != null) _tokenCtrl.text = t;
    });
    SecureStorageManager.readOandaAccount().then((a) {
      if (a != null) _accCtrl.text = a;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("OANDA Settings")),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(children: [
          TextField(
            controller: _tokenCtrl,
            decoration: InputDecoration(labelText: "API Token"),
          ),
          TextField(
            controller: _accCtrl,
            decoration: InputDecoration(labelText: "Account ID"),
          ),
          SizedBox(height: 20),
          ElevatedButton(
            onPressed: () async {
              await SecureStorageManager.saveOandaToken(_tokenCtrl.text);
              await SecureStorageManager.saveOandaAccount(_accCtrl.text);
              ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(content: Text("Saved OANDA Credentials")));
            },
            child: Text("Save"),
          ),
        ]),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/pages/settings_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 333: lib/features/settings/presentation/pages/theme_switch.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/pages/theme_switch.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 696.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter/material.dart';
import '../../../../core/storage/app_preferences.dart';

class ThemeSwitch extends StatefulWidget {
  @override
  _ThemeSwitchState createState() => _ThemeSwitchState();
}

class _ThemeSwitchState extends State<ThemeSwitch> {
  bool _isDark = false;

  @override
  void initState() {
    super.initState();
    AppPreferences.loadThemeMode().then((d) {
      setState(() => _isDark = d);
    });
  }

  @override
  Widget build(BuildContext context) {
    return SwitchListTile(
      title: Text("Dark Mode"),
      value: _isDark,
      onChanged: (v) {
        AppPreferences.saveThemeMode(v);
        setState(() => _isDark = v);
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/pages/theme_switch.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 334: lib/features/settings/presentation/pages/theme/theme_settings_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/pages/theme/theme_settings_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 78
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/theme/theme_bloc.dart';
import '../../bloc/theme/theme_event.dart';
import '../../../domain/theme/app_theme.dart';

class ThemeSettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final theme = context.watch<ThemeBloc>().state.theme;

    return Scaffold(
      appBar: AppBar(title: Text("Theme Settings")),
      body: ListView(
        padding: EdgeInsets.all(12),
        children: [
          Text("Theme Mode"),
          DropdownButton<AppThemeMode>(
            value: theme.mode,
            items: AppThemeMode.values
                .map((m) => DropdownMenuItem(value: m, child: Text(m.name)))
                .toList(),
            onChanged: (m) {
              context.read<ThemeBloc>().add(ChangeThemeMode(m!));
            },
          ),
          Divider(),
          Text("Candle Colors"),
          ListTile(
            title: Text("Bull Candle"),
            trailing: CircleAvatar(backgroundColor: theme.bullCandle),
            onTap: () {},
          ),
          ListTile(
            title: Text("Bear Candle"),
            trailing: CircleAvatar(backgroundColor: theme.bearCandle),
            onTap: () {},
          ),
        ],
      ),
    );
  }
}

void _pickColor(BuildContext context, Color currentColor, Function(Color) onColorChanged) {
  showDialog(
    context: context,
    builder: (_) => AlertDialog(
      title: Text("Pick a Color"),
      content: SingleChildScrollView(
        child: ColorPicker(
          pickerColor: currentColor,
          onColorChanged: onColorChanged,
        ),
      ),
      actions: [
        ElevatedButton(
          child: Text("Done"),
          onPressed: () => Navigator.of(context).pop(),
        )
      ],
    ),
  );
}

void _updateIndicatorColor(BuildContext context, String id, Color color) {
  final theme = context.read<ThemeBloc>().state.theme;
  final updatedTheme = AppTheme(
    mode: theme.mode,
    bullCandle: theme.bullCandle,
    bearCandle: theme.bearCandle,
    emaColor: id == "ema" ? color : theme.emaColor,
    stochColor: id == "stoch" ? color : theme.stochColor,
    rsiColor: id == "rsi" ? color : theme.rsiColor,
    bollingerColor: id == "bollinger" ? color : theme.bollingerColor,
  );
  context.read<ThemeBloc>().add(UpdateThemeColors(updatedTheme));
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/pages/theme/theme_settings_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 335: lib/features/settings/presentation/widgets/color_picker_tile.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/widgets/color_picker_tile.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 805.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_colorpicker/flutter_colorpicker.dart';

class ColorPickerTile extends StatelessWidget {
  final String title;
  final Color current;
  final ValueChanged<Color> onColorChanged;

  ColorPickerTile({
    required this.title,
    required this.current,
    required this.onColorChanged,
  });

  @override
  Widget build(BuildContext context) {
    return ListTile(
      title: Text(title),
      trailing: CircleAvatar(backgroundColor: current),
      onTap: () => showDialog(
        context: context,
        builder: (_) => AlertDialog(
          title: Text("Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†"),
          content: BlockPicker(
            pickerColor: current,
            onColorChanged: onColorChanged,
          ),
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/widgets/color_picker_tile.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 336: lib/features/settings/presentation/bloc/theme/theme_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/bloc/theme/theme_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:hydrated_bloc/hydrated_bloc.dart';
import '../../../data/theme/theme_repository.dart';
import '../../../domain/theme/app_theme.dart';
import 'theme_event.dart';
import 'theme_state.dart';

class ThemeBloc extends HydratedBloc<ThemeEvent, ThemeState> {
  final ThemeRepository repo;

  ThemeBloc(this.repo)
      : super(ThemeState(repo.loadTheme())) {
    on<ChangeThemeMode>((event, emit) {
      final updated = AppTheme(
        mode: event.mode,
        bullCandle: state.theme.bullCandle,
        bearCandle: state.theme.bearCandle,
        emaColor: state.theme.emaColor,
        rsiColor: state.theme.rsiColor,
        macdColor: state.theme.macdColor,
        bollingerColor: state.theme.bollingerColor,
      );
      repo.saveTheme(updated);
      emit(ThemeState(updated));
    });

    on<UpdateThemeColors>((event, emit) {
      repo.saveTheme(event.theme);
      emit(ThemeState(event.theme));
    });
  }

  @override
  ThemeState? fromJson(Map<String, dynamic> json) =>
      ThemeState.fromJson(json);

  @override
  Map<String, dynamic>? toJson(ThemeState state) => state.toJson();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/bloc/theme/theme_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 337: lib/features/settings/presentation/bloc/theme/theme_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/bloc/theme/theme_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 285.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import '../../../domain/theme/app_theme.dart';

abstract class ThemeEvent {}

class ChangeThemeMode extends ThemeEvent {
  final AppThemeMode mode;
  ChangeThemeMode(this.mode);
}

class UpdateThemeColors extends ThemeEvent {
  final AppTheme theme;
  UpdateThemeColors(this.theme);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/bloc/theme/theme_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 338: lib/features/settings/presentation/bloc/theme/theme_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/presentation/bloc/theme/theme_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 289.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../domain/theme/app_theme.dart';

class ThemeState {
  final AppTheme theme;
  const ThemeState(this.theme);

  Map<String, dynamic> toJson() => theme.toJson();

  factory ThemeState.fromJson(Map<String, dynamic> json) {
    return ThemeState(AppTheme.fromJson(json));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/presentation/bloc/theme/theme_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 339: lib/features/settings/domain/chart_settings_lock_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/domain/chart_settings_lock_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 209.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class ChartSettingsLockFix {
  bool _updating = false;

  Future<void> runSafe(Future<void> Function() fn) async {
    if (_updating) return;
    _updating = true;
    await fn();
    _updating = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/domain/chart_settings_lock_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 340: lib/features/settings/domain/chart_style_settings.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/domain/chart_style_settings.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 134.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class ChartStyleSettings {
  String candleUpColor = "#00ff00";
  String candleDownColor = "#ff0000";
  String emaColor = "#00bcd4";
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/domain/chart_style_settings.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 341: lib/features/settings/domain/trading_profile.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/domain/trading_profile.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 206.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

class TradingProfile {
  final String name;
  final double riskPercent;
  final double lotSize;

  TradingProfile({
    required this.name,
    required this.riskPercent,
    required this.lotSize,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/domain/trading_profile.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 342: lib/features/settings/domain/theme/app_theme.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/domain/theme/app_theme.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 58
================================================================================

import 'package:flutter/material.dart';

enum AppThemeMode { light, dark, system }

class AppTheme {
  final AppThemeMode mode;
  final Color bullCandle;
  final Color bearCandle;
  final Color emaColor;
  final Color rsiColor;
  final Color macdColor;
  final Color bollingerColor;

  const AppTheme({
    required this.mode,
    required this.bullCandle,
    required this.bearCandle,
    required this.emaColor,
    required this.rsiColor,
    required this.macdColor,
    required this.bollingerColor,
  });

  Map<String, dynamic> toJson() => {
        "mode": mode.name,
        "bullCandle": bullCandle.value,
        "bearCandle": bearCandle.value,
        "emaColor": emaColor.value,
        "rsiColor": rsiColor.value,
        "macdColor": macdColor.value,
        "bollingerColor": bollingerColor.value,
      };

  factory AppTheme.fromJson(Map<String, dynamic> json) {
    return AppTheme(
      mode: AppThemeMode.values.firstWhere(
        (e) => e.name == json["mode"],
        orElse: () => AppThemeMode.system,
      ),
      bullCandle: Color(json["bullCandle"]),
      bearCandle: Color(json["bearCandle"]),
      emaColor: Color(json["emaColor"]),
      rsiColor: Color(json["rsiColor"]),
      macdColor: Color(json["macdColor"]),
      bollingerColor: Color(json["bollingerColor"]),
    );
  }

  static AppTheme defaultLight() => AppTheme(
        mode: AppThemeMode.system,
        bullCandle: Colors.green,
        bearCandle: Colors.red,
        emaColor: Colors.blue,
        rsiColor: Colors.purple,
        macdColor: Colors.cyan,
        bollingerColor: Colors.teal,
      );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/domain/theme/app_theme.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 343: lib/features/settings/domain/controllers/chart_settings_controller_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/domain/controllers/chart_settings_controller_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 36
================================================================================

import 'dart:async';
import 'package:shared_preferences/shared_preferences.dart';

class ChartSettingsControllerFix {
  final List<Map<String, dynamic>> _undoStack = [];
  final List<Map<String, dynamic>> _redoStack = [];

  Future<void> save(Map<String, dynamic> cfg) async {
    final prefs = await SharedPreferences.getInstance();
    final backup = await load();
    if (backup != null) _undoStack.add(backup);

    await prefs.setString('chart_settings', cfg.toString());
  }

  Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString('chart_settings');
    if (str == null) return null;
    return Map<String, dynamic>.from({});
  }

  Future<void> undo() async {
    if (_undoStack.isEmpty) return;
    final last = _undoStack.removeLast();
    _redoStack.add(last);
    await save(last);
  }

  Future<void> redo() async {
    if (_redoStack.isEmpty) return;
    final last = _redoStack.removeLast();
    _undoStack.add(last);
    await save(last);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/domain/controllers/chart_settings_controller_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 344: lib/features/settings/data/undo_redo_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/data/undo_redo_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 570.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class UndoRedoStorage {
  static Future<void> save(String key, List<Map<String, dynamic>> states) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(states));
  }
  static Future<List<Map<String, dynamic>>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    if (str == null) return null;
    return (jsonDecode(str) as List).cast<Map<String, dynamic>>();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/data/undo_redo_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 345: lib/features/settings/data/chart_settings_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/data/chart_settings_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 524.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ChartSettingsStorage {
  static const key = "chart_settings";

  static Future<void> save(Map<String, dynamic> cfg) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(cfg));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/data/chart_settings_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 346: lib/features/settings/data/theme/theme_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/settings/data/theme/theme_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 590.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:hive/hive.dart';
import '../../domain/theme/app_theme.dart';

class ThemeRepository {
  static const String _boxName = "app_theme";

  Future<void> init() async {
    await Hive.openBox<Map>(_boxName);
  }

  Future<void> saveTheme(AppTheme theme) async {
    final box = Hive.box<Map>(_boxName);
    await box.put("current", theme.toJson());
  }

  AppTheme loadTheme() {
    final box = Hive.box<Map>(_boxName);
    final data = box.get("current");
    if (data == null) return AppTheme.defaultLight();
    return AppTheme.fromJson(Map<String, dynamic>.from(data));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/settings/data/theme/theme_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 347: lib/features/common/data/cache/bloc_state_cache.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/common/data/cache/bloc_state_cache.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 211.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:hive/hive.dart';

class BlocStateCache {
  final Box box;

  BlocStateCache(this.box);

  void save(String key, dynamic data) => box.put(key, data);
  dynamic load(String key) => box.get(key);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/common/data/cache/bloc_state_cache.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 348: lib/features/watchlist/domain/watchlist_clean_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/watchlist/domain/watchlist_clean_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 108.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class WatchlistCleanGuard {
  static void clean(String symbol, Map cache) {
    cache.remove(symbol);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/watchlist/domain/watchlist_clean_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 349: lib/features/chart/presentation/widgets/chart_webview.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_webview.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 51
================================================================================

import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class ChartWebView extends StatefulWidget {
  final List<Map<String, dynamic>> candles;
  final List<Map<String, dynamic>> emaShort;
  final List<Map<String, dynamic>> emaLong;
  final List<Map<String, dynamic>> rsi;

  ChartWebView({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });

  @override
  _ChartWebViewState createState() => _ChartWebViewState();
}

class _ChartWebViewState extends State<ChartWebView> {
  late WebViewController _ctrl;

  @override
  Widget build(BuildContext context) {
    return WebView(
      initialUrl: 'about:blank',
      javascriptMode: JavascriptMode.unrestricted,
      onWebViewCreated: (controller) async {
        _ctrl = controller;
        await controller.loadFlutterAsset("assets/lightweight_charts/chart.html");
        _setInitialData();
      },
    );
  }

  void _setInitialData() {
    _runJs("setCandles(${widget.candles});");
    _runJs("setEmaShort(${widget.emaShort});");
    _runJs("setEmaLong(${widget.emaLong});");
    _runJs("setRsi(${widget.rsi});");
  }

  void updateLastCandle(Map<String, dynamic> candle) {
    _runJs("updateLastCandle($candle);");
  }

  void _runJs(String script) {
    _ctrl.runJavascript(script);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_webview.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 350: lib/features/chart/presentation/widgets/indicator_selector.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/indicator_selector.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 35
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/indicators/indicator_manager.dart';
import '../../../domain/indicators/ema_indicator.dart';
import '../../../domain/indicators/rsi_indicator.dart';
import '../../../domain/indicators/macd_indicator.dart';

class IndicatorSelector extends StatelessWidget {
  final IndicatorManager manager;
  const IndicatorSelector({required this.manager});

  @override
  Widget build(BuildContext context) {
    return Wrap(
      spacing: 8,
      children: [
        ElevatedButton(
          child: Text("EMA(14)"),
          onPressed: () => manager.add(EMAIndicator(14)),
        ),
        ElevatedButton(
          child: Text("RSI(14)"),
          onPressed: () => manager.add(RSIIndicator(14)),
        ),
        ElevatedButton(
          child: Text("MACD"),
          onPressed: () => manager.add(MACDIndicator()),
        ),
        ElevatedButton(
          child: Text("Clear All"),
          onPressed: () => manager.clear(),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/indicator_selector.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 351: lib/features/chart/presentation/widgets/real_time_price_chart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/real_time_price_chart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 0.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 0
================================================================================


================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/real_time_price_chart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 352: lib/features/chart/presentation/widgets/chart_interactions/interaction_toolkit.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_interactions/interaction_toolkit.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 101
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/entities/candle.dart';
import '../../widgets/chart_core/candlestick_chart_canvas.dart';

typedef OnTapCallback = void Function(Candle? hitCandle);

/// ===============================
/// Gesture Interaction Toolkit
/// ===============================

class ChartTouchOverlay extends StatefulWidget {
  final List<Candle> candles;
  final Widget child;
  final OnTapCallback onTap;
  const ChartTouchOverlay({
    required this.candles,
    required this.child,
    required this.onTap,
  });

  @override
  _ChartTouchOverlayState createState() => _ChartTouchOverlayState();
}

class _ChartTouchOverlayState extends State<ChartTouchOverlay> {
  Offset? _position;
  Candle? _hitCandle;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onDoubleTap: () {
        // Reset zoom/scroll
        // (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Event Ù„Ù„Ù€Bloc Ù„ÙƒÙŠ ÙŠØ¹ÙŠØ¯ Ù…Ø­Ø§ÙˆØ± Ø§Ù„Ø´Ø§Ø´Ø©)
      },
      onLongPressStart: (details) {
        _updateHit(details.localPosition);
      },
      onLongPressMoveUpdate: (details) {
        _updateHit(details.localPosition);
      },
      onTapUp: (details) {
        _updateHit(details.localPosition);
      },
      child: Stack(
        children: [
          widget.child,
          if (_position != null && _hitCandle != null)
            Positioned(
              left: _position!.dx,
              top: _position!.dy - 40,
              child: _TooltipBox(candle: _hitCandle!),
            ),
        ],
      ),
    );
  }

  void _updateHit(Offset pos) {
    Candle? found;
    if (widget.candles.isNotEmpty) {
      double barWidth = MediaQuery.of(context).size.width /
          widget.candles.length;
      int index = (pos.dx / barWidth).floor();
      if (index >= 0 && index < widget.candles.length) {
        found = widget.candles[index];
      }
    }
    setState(() {
      _position = pos;
      _hitCandle = found;
    });
    widget.onTap(found);
  }
}

class _TooltipBox extends StatelessWidget {
  final Candle candle;
  const _TooltipBox({required this.candle});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: EdgeInsets.all(6),
      decoration: BoxDecoration(
        color: Colors.black87,
        borderRadius: BorderRadius.circular(4),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text("Time: \${candle.time}", style: TextStyle(color: Colors.white)),
          Text("O: \${candle.open}", style: TextStyle(color: Colors.white)),
          Text("H: \${candle.high}", style: TextStyle(color: Colors.white)),
          Text("L: \${candle.low}", style: TextStyle(color: Colors.white)),
          Text("C: \${candle.close}", style: TextStyle(color: Colors.white)),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_interactions/interaction_toolkit.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 353: lib/features/chart/presentation/widgets/chart_draw_tools/drawing_tools_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_draw_tools/drawing_tools_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 543.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:flutter/material.dart';

class DrawingToolsPainter extends CustomPainter {
  final List<Offset> trendPoints;

  DrawingToolsPainter({required this.trendPoints});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.yellow
      ..strokeWidth = 2.0;

    if (trendPoints.length >= 2) {
      canvas.drawLine(trendPoints[0], trendPoints[1], paint);
    }
  }

  @override
  bool shouldRepaint(covariant DrawingToolsPainter old) {
    return old.trendPoints != trendPoints;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_draw_tools/drawing_tools_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 354: lib/features/chart/presentation/widgets/chart_indicators/indicator_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_indicators/indicator_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 48
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/entities/candle.dart';
import '../../../../../features/chart/domain/indicators/indicator_base.dart';
import 'dart:math';

class IndicatorPainter extends CustomPainter {
  final List<Candle> candles;
  final List<Indicator> indicators;

  IndicatorPainter(this.candles, this.indicators);

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty || indicators.isEmpty) return;

    List<double> closes = candles.map((e) => e.close).toList();
    final maxPrice = candles.map((c) => c.high).reduce(max);
    final minPrice = candles.map((c) => c.low).reduce(min);
    final yRange = maxPrice - minPrice;

    double barWidth = size.width / candles.length;

    for (var indicator in indicators) {
      final vals = indicator.compute(closes);
      if (vals.isEmpty) continue;

      final paint = Paint()
        ..color = indicator.color
        ..strokeWidth = 1.4
        ..style = PaintingStyle.stroke;

      final path = Path();

      for (int j = 0; j < vals.length; j++) {
        double vx = j * barWidth;
        double vy = (maxPrice - vals[j]) / yRange * size.height;
        if (j == 0) path.moveTo(vx, vy);
        else path.lineTo(vx, vy);
      }

      canvas.drawPath(path, paint);
    }
  }

  @override
  bool shouldRepaint(covariant IndicatorPainter old) =>
      old.candles != candles || old.indicators != indicators;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_indicators/indicator_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 355: lib/features/chart/presentation/widgets/chart_indicators/ema_indicator_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_indicators/ema_indicator_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 656.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter/material.dart';

class EMAIndicatorPainter extends CustomPainter {
  final List<Offset> points;
  final Color color;

  EMAIndicatorPainter(this.points, this.color);

  @override
  void paint(Canvas canvas, Size size) {
    if (points.isEmpty) return;
    final paint = Paint()
      ..color = color
      ..strokeWidth = 1.8
      ..style = PaintingStyle.stroke;

    final path = Path()..moveTo(points.first.dx, points.first.dy);
    for (var p in points.skip(1)) path.lineTo(p.dx, p.dy);

    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant EMAIndicatorPainter old) =>
      old.points != points;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_indicators/ema_indicator_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 356: lib/features/chart/presentation/widgets/chart_indicators/integrated_indicators.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_indicators/integrated_indicators.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 5.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 214
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/entities/candle.dart';
import 'dart:math';

/// ===============================
/// 1) BASE INDICATOR
/// ===============================
abstract class Indicator {
  final String name;
  Indicator(this.name);

  List<double> compute(List<double> prices);
  Color get color;
}

/// ===============================
/// 2) EMA INDICATOR
/// ===============================
class EMAIndicator extends Indicator {
  final int period;
  EMAIndicator(this.period) : super("EMA_$period");

  @override
  List<double> compute(List<double> prices) {
    if (prices.length < period) return [];

    final List<double> result = [];
    double k = 2 / (period + 1);

    double ema = prices.take(period).reduce((a, b) => a + b) / period;
    result.add(ema);

    for (int i = period; i < prices.length; i++) {
      ema = prices[i] * k + ema * (1 - k);
      result.add(ema);
    }
    return result;
  }

  @override
  Color get color => Colors.blue;
}

/// ===============================
/// 3) RSI INDICATOR
/// ===============================
class RSIIndicator extends Indicator {
  final int period;
  RSIIndicator(this.period) : super("RSI_$period");

  @override
  List<double> compute(List<double> prices) {
    if (prices.length < period + 1) return [];

    List<double> result = [];

    double gainSum = 0;
    double lossSum = 0;

    for (int i = 1; i <= period; i++) {
      double diff = prices[i] - prices[i - 1];
      if (diff >= 0) gainSum += diff;
      else lossSum -= diff;
    }

    double avgGain = gainSum / period;
    double avgLoss = lossSum / period;
    double rs = avgLoss == 0 ? 100 : avgGain / avgLoss;
    result.add(100 - (100 / (1 + rs)));

    for (int i = period + 1; i < prices.length; i++) {
      double diff = prices[i] - prices[i - 1];
      avgGain = ((avgGain * (period - 1)) + (diff > 0 ? diff : 0)) / period;
      avgLoss = ((avgLoss * (period - 1)) + (diff < 0 ? -diff : 0)) / period;
      rs = avgLoss == 0 ? 100 : avgGain / avgLoss;
      result.add(100 - (100 / (1 + rs)));
    }

    return result;
  }

  @override
  Color get color => Colors.orange;
}

/// ===============================
/// 4) MACD INDICATOR
/// ===============================
class MACDIndicator extends Indicator {
  final int shortPeriod;
  final int longPeriod;
  final int signalPeriod;

  MACDIndicator({
    this.shortPeriod = 12,
    this.longPeriod = 26,
    this.signalPeriod = 9,
  }) : super("MACD");

  List<double> _ema(List<double> prices, int period) {
    if (prices.length < period) return [];

    List<double> result = [];
    double k = 2 / (period + 1);

    double ema = prices.take(period).reduce((a, b) => a + b) / period;
    result.add(ema);

    for (int i = period; i < prices.length; i++) {
      ema = prices[i] * k + ema * (1 - k);
      result.add(ema);
    }
    return result;
  }

  @override
  List<double> compute(List<double> prices) {
    final emaShort = _ema(prices, shortPeriod);
    final emaLong = _ema(prices, longPeriod);

    int length = min(emaShort.length, emaLong.length);
    List<double> macd = [];

    for (int i = 0; i < length; i++) {
      macd.add(emaShort[i] - emaLong[i]);
    }

    final signal = _ema(macd, signalPeriod);

    int finalLen = min(macd.length, signal.length);
    List<double> histogram = [];

    for (int i = 0; i < finalLen; i++) {
      histogram.add(macd[i] - signal[i]);
    }

    return histogram;
  }

  @override
  Color get color => Colors.purple;
}

/// ===============================
/// 5) INDICATOR MANAGER (Ù…ÙØ¯Ù…Ø¬)
/// ===============================
class IndicatorManager {
  final List<Indicator> _active = [];

  void add(Indicator i) {
    if (!_active.any((e) => e.name == i.name)) {
      _active.add(i);
    }
  }

  void remove(String name) {
    _active.removeWhere((e) => e.name == name);
  }

  void clear() {
    _active.clear();
  }

  List<Indicator> get all => List.unmodifiable(_active);
}

/// ===============================
/// 6) INDICATOR PAINTER (Ù…ÙØ¯Ù…Ø¬)
/// ===============================
class IndicatorPainter extends CustomPainter {
  final List<Candle> candles;
  final List<Indicator> indicators;

  IndicatorPainter(this.candles, this.indicators);

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty || indicators.isEmpty) return;

    List<double> closes = candles.map((e) => e.close).toList();

    final maxPrice = candles.map((c) => c.high).reduce(max);
    final minPrice = candles.map((c) => c.low).reduce(min);
    final yRange = maxPrice - minPrice;

    double barWidth = size.width / candles.length;

    for (var indicator in indicators) {
      final values = indicator.compute(closes);
      if (values.isEmpty) continue;

      final paint = Paint()
        ..color = indicator.color
        ..strokeWidth = 1.4
        ..style = PaintingStyle.stroke;

      final path = Path();

      for (int i = 0; i < values.length; i++) {
        double x = i * barWidth;
        double y = (maxPrice - values[i]) / yRange * size.height;

        if (i == 0) path.moveTo(x, y);
        else path.lineTo(x, y);
      }

      canvas.drawPath(path, paint);
    }
  }

  @override
  bool shouldRepaint(covariant IndicatorPainter old) =>
      old.candles != candles || old.indicators != indicators;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_indicators/integrated_indicators.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 357: lib/features/chart/presentation/widgets/chart_indicators/ema_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_indicators/ema_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 849.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter/material.dart';
import 'package:flato/features/chart/domain/indicators/ema_indicator.dart';

class EMAIndicatorPainter extends CustomPainter {
  final List<double> emaValues;
  final double candleWidth;

  EMAIndicatorPainter({required this.emaValues, required this.candleWidth});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.orange
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    for (int i = 1; i < emaValues.length; i++) {
      final x1 = (i - 1) * candleWidth;
      final y1 = size.height - emaValues[i - 1];
      final x2 = i * candleWidth;
      final y2 = size.height - emaValues[i];
      canvas.drawLine(Offset(x1, y1), Offset(x2, y2), paint);
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_indicators/ema_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 358: lib/features/chart/presentation/widgets/chart_indicators/rsi_subchart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_indicators/rsi_subchart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1008.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

import 'package:flutter/material.dart';

class RSISubChart extends StatelessWidget {
  final List<double> rsiValues;

  const RSISubChart({super.key, required this.rsiValues});

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      size: const Size(double.infinity, 100),
      painter: _RSIPainter(rsiValues: rsiValues),
    );
  }
}

class _RSIPainter extends CustomPainter {
  final List<double> rsiValues;

  _RSIPainter({required this.rsiValues});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.purple
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    for (int i = 1; i < rsiValues.length; i++) {
      final x1 = (i - 1) * 5.0;
      final y1 = size.height - rsiValues[i - 1];
      final x2 = i * 5.0;
      final y2 = size.height - rsiValues[i];
      canvas.drawLine(Offset(x1, y1), Offset(x2, y2), paint);
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_indicators/rsi_subchart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 359: lib/features/chart/presentation/widgets/chart_core/chart_gesture_detector.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_core/chart_gesture_detector.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 41
================================================================================

import 'package:flutter/material.dart';

class ChartGestureDetector extends StatefulWidget {
  final Widget child;
  final void Function(double scale, double dx) onInteraction;

  const ChartGestureDetector({
    required this.child,
    required this.onInteraction,
    Key? key,
  }) : super(key: key);

  @override
  _ChartGestureDetectorState createState() => _ChartGestureDetectorState();
}

class _ChartGestureDetectorState extends State<ChartGestureDetector> {
  double _lastScale = 1.0;
  Offset _lastFocal = Offset.zero;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      behavior: HitTestBehavior.translucent,
      onScaleStart: (details) {
        _lastScale = 1.0;
        _lastFocal = details.focalPoint;
      },
      onScaleUpdate: (details) {
        final newScale = details.scale;
        final dx = details.focalPoint.dx - _lastFocal.dx;

        widget.onInteraction(newScale / _lastScale, dx);

        _lastScale = newScale;
        _lastFocal = details.focalPoint;
      },
      child: widget.child,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_core/chart_gesture_detector.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 360: lib/features/chart/presentation/widgets/chart_core/candlestick_chart_canvas.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_core/candlestick_chart_canvas.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.9 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 78
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/entities/candle.dart';

class CandlestickChartCanvas extends StatelessWidget {
  final List<Candle> candles;
  final double barSpacing;

  const CandlestickChartCanvas({
    required this.candles,
    this.barSpacing = 6.0,
    Key? key,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      size: Size.infinite,
      painter: _CandlePainter(candles: candles, barSpacing: barSpacing),
    );
  }
}

class _CandlePainter extends CustomPainter {
  final List<Candle> candles;
  final double barSpacing;

  _CandlePainter({
    required this.candles,
    required this.barSpacing,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty) return;

    final paint = Paint()..strokeWidth = 1.2;
    final maxPrice = candles.map((c) => c.high).reduce((a, b) => a > b ? a : b);
    final minPrice = candles.map((c) => c.low).reduce((a, b) => a < b ? a : b);

    final yRange = maxPrice - minPrice;
    if (yRange == 0) return;

    final barWidth = barSpacing;

    for (int i = 0; i < candles.length; i++) {
      final c = candles[i];
      final dx = i * barWidth;

      final openY = (maxPrice - c.open) / yRange * size.height;
      final closeY = (maxPrice - c.close) / yRange * size.height;
      final highY = (maxPrice - c.high) / yRange * size.height;
      final lowY = (maxPrice - c.low) / yRange * size.height;

      paint.color = c.close >= c.open ? Colors.green : Colors.red;

      // wick
      canvas.drawLine(
        Offset(dx + barWidth / 2, highY),
        Offset(dx + barWidth / 2, lowY),
        paint,
      );

      // body
      final rect = Rect.fromLTRB(
        dx,
        openY,
        dx + barWidth,
        closeY,
      );
      canvas.drawRect(rect, paint);
    }
  }

  @override
  bool shouldRepaint(covariant _CandlePainter old) {
    return old.candles != candles;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_core/candlestick_chart_canvas.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 361: lib/features/chart/presentation/widgets/chart_core/crosshair_overlay.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/widgets/chart_core/crosshair_overlay.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 964.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 48
================================================================================

import 'package:flutter/material.dart';

class CrosshairOverlay extends StatelessWidget {
  final Offset? position;

  const CrosshairOverlay({required this.position});

  @override
  Widget build(BuildContext context) {
    if (position == null) return SizedBox.shrink();
    return CustomPaint(
      painter: _CrosshairPainter(position!),
      size: Size.infinite,
    );
  }
}

class _CrosshairPainter extends CustomPainter {
  final Offset pos;

  _CrosshairPainter(this.pos);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.white70
      ..strokeWidth = 1.2;

    // vertical
    canvas.drawLine(
      Offset(pos.dx, 0),
      Offset(pos.dx, size.height),
      paint,
    );

    // horizontal
    canvas.drawLine(
      Offset(0, pos.dy),
      Offset(size.width, pos.dy),
      paint,
    );
  }

  @override
  bool shouldRepaint(covariant _CrosshairPainter old) {
    return old.pos != pos;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/widgets/chart_core/crosshair_overlay.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 362: lib/features/chart/presentation/pages/chart_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/pages/chart_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 52
================================================================================

import 'package:flutter/material.dart';
import '../bloc/candles_bloc.dart';
import '../bloc/indicators/indicators_bloc.dart';
import '../widgets/chart_core/candlestick_chart_canvas.dart';
import '../widgets/chart_core/crosshair_overlay.dart';
import '../widgets/chart_indicators/ema_indicator_painter.dart';
import '../widgets/chart_indicators/rsi_indicator_painter.dart';

class ChartPage extends StatelessWidget {
  const ChartPage({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Live Chart')),
      body: Stack(
        children: [
          const CandlestickChartCanvas(),
          const CrosshairOverlay(),
          const EMAIndicatorPainter(),
          const RSIIndicatorPainter(),
        ],
      ),
    );
  }
}

cat > lib/features/chart/presentation/widgets/chart_core/candlestick_chart_canvas.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/models/candle_model.dart';

class CandlestickChartCanvas extends StatelessWidget {
  const CandlestickChartCanvas({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _CandlePainter(),
      size: Size.infinite,
    );
  }
}

class _CandlePainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    // TODO: Fetch and draw candles from bloc state
  }

  @override
  bool shouldRepaint(CustomPainter oldDelegate) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/pages/chart_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 363: lib/features/chart/presentation/pages/interactive_chart_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/pages/interactive_chart_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 78
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../widgets/chart_indicators/integrated_indicators.dart';
import '../../../domain/entities/candle.dart';
import '../../bloc/live_chart/live_chart_bloc.dart';
import '../../bloc/live_chart/live_chart_state.dart';

class InteractiveChartPage extends StatefulWidget {
  final String symbol;
  const InteractiveChartPage({required this.symbol});

  @override
  _InteractiveChartPageState createState() => _InteractiveChartPageState();
}

class _InteractiveChartPageState extends State<InteractiveChartPage> {
  final IndicatorManager _indicatorManager = IndicatorManager();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(widget.symbol)),
      body: Column(
        children: [
          // Ø²Ø±Ù‘ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
          SingleChildScrollView(
            scrollDirection: Axis.horizontal,
            child: Row(
              children: [
                ElevatedButton(
                  onPressed: () =>
                      setState(() => _indicatorManager.add(EMAIndicator(14))),
                  child: Text("EMA(14)"),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  onPressed: () =>
                      setState(() => _indicatorManager.add(RSIIndicator(14))),
                  child: Text("RSI(14)"),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  onPressed: () =>
                      setState(() => _indicatorManager.add(MACDIndicator())),
                  child: Text("MACD"),
                ),
                SizedBox(width: 8),
                ElevatedButton(
                  onPressed: () => setState(() => _indicatorManager.clear()),
                  child: Text("Clear All"),
                ),
              ],
            ),
          ),

          Expanded(
            child: BlocBuilder<LiveChartBloc, LiveChartState>(
              builder: (context, state) {
                List<Candle> candles = [];
                if (state is LiveChartLoaded) {
                  candles = state.candles;
                }

                return CustomPaint(
                  size: Size.infinite,
                  painter: IndicatorPainter(
                    candles,
                    _indicatorManager.all,
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/pages/interactive_chart_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 364: lib/features/chart/presentation/bloc/chart_bloc_with_subscription_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/chart_bloc_with_subscription_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 664.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/bloc/subscription_manager/subscription_manager.dart';

class ChartBloc extends Bloc<ChartEvent, ChartState> {
  final SubscriptionManager _subsManager = SubscriptionManager();

  ChartBloc() : super(ChartInitial()) {
    on<StartLiveFeed>((event, emit) {
      final sub = event.stream.listen((data) {
        add(LiveDataArrived(data));
      });
      _subsManager.replace(sub);
    });

    on<LiveDataArrived>((event, emit) {
      emit(ChartUpdated(event.data));
    });
  }

  @override
  Future<void> close() async {
    await _subsManager.dispose();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/chart_bloc_with_subscription_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 365: lib/features/chart/presentation/bloc/candles_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/candles_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 187.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import 'package:equatable/equatable.dart';

abstract class CandlesEvent extends Equatable {
  @override
  List<Object?> get props => [];
}

class LoadCandlesEvent extends CandlesEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/candles_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 366: lib/features/chart/presentation/bloc/candles_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/candles_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 394.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'candles_event.dart';
import 'candles_state.dart';

class CandlesBloc extends Bloc<CandlesEvent, CandlesState> {
  CandlesBloc() : super(CandlesInitial()) {
    on<LoadCandlesEvent>((event, emit) async {
      emit(CandlesLoading());
      await Future.delayed(Duration(seconds: 1));
      emit(CandlesLoaded(candles: []));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/candles_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 367: lib/features/chart/presentation/bloc/candles_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/candles_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 401.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:equatable/equatable.dart';

abstract class CandlesState extends Equatable {
  @override
  List<Object?> get props => [];
}

class CandlesInitial extends CandlesState {}
class CandlesLoading extends CandlesState {}
class CandlesLoaded extends CandlesState {
  final List<dynamic> candles;
  CandlesLoaded({required this.candles});

  @override
  List<Object?> get props => [candles];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/candles_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 368: lib/features/chart/presentation/bloc/live_chart/live_chart_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/live_chart/live_chart_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 409.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../../../../market/domain/entities/candle.dart';

abstract class LiveChartState {}

class LiveChartInitial extends LiveChartState {}

class LiveChartLoading extends LiveChartState {}

class LiveChartLoaded extends LiveChartState {
  final List<Candle> candles;
  LiveChartLoaded(this.candles);
}

class LiveChartError extends LiveChartState {
  final String message;
  LiveChartError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/live_chart/live_chart_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 369: lib/features/chart/presentation/bloc/live_chart/live_chart_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/live_chart/live_chart_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/chart_sync_manager/multi_tf_sync.dart';
import '../../../market/domain/entities/candle.dart';
import 'live_chart_event.dart';
import 'live_chart_state.dart';

class LiveChartBloc extends Bloc<LiveChartEvent, LiveChartState> {
  final MultiTimeframeSync _syncManager = MultiTimeframeSync();

  LiveChartBloc() : super(LiveChartInitial()) {
    on<LiveChartStart>(_onStart);
    on<LiveChartStop>(_onStop);
  }

  Future<void> _onStart(
      LiveChartStart e, Emitter<LiveChartState> emit) async {
    emit(LiveChartLoading());

    await _syncManager.startLive(
      accountId: e.accountId,
      symbol: e.symbol,
      timeframe: e.timeframe,
      onUpdate: (candles) {
        emit(LiveChartLoaded(candles));
      },
    );
  }

  Future<void> _onStop(
      LiveChartStop e, Emitter<LiveChartState> emit) async {
    await _syncManager.stopLive(e.symbol, e.timeframe);
    emit(LiveChartInitial());
  }

  @override
  Future<void> close() async {
    super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/live_chart/live_chart_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 370: lib/features/chart/presentation/bloc/live_chart/live_chart_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/live_chart/live_chart_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 245.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

abstract class LiveChartEvent {}

class LiveChartStart extends LiveChartEvent {
  final String accountId;
  final String symbol;
  LiveChartStart({required this.accountId, required this.symbol});
}

class LiveChartStop extends LiveChartEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/live_chart/live_chart_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 371: lib/features/chart/presentation/bloc/indicators/indicators_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/indicators/indicators_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 145.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

abstract class IndicatorsEvent {}

class LoadIndicators extends IndicatorsEvent {
  final List<double> prices;

  LoadIndicators(this.prices);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/indicators/indicators_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 372: lib/features/chart/presentation/bloc/indicators/indicators_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/indicators/indicators_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 213.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class IndicatorsState {
  final List<double> ema;
  final List<double> rsi;

  IndicatorsState({required this.ema, required this.rsi});

  factory IndicatorsState.initial() => IndicatorsState(ema: [], rsi: []);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/indicators/indicators_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 373: lib/features/chart/presentation/bloc/indicators/indicators_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/presentation/bloc/indicators/indicators_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 630.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'indicators_event.dart';
import 'indicators_state.dart';
import 'package:flato/features/chart/domain/indicators/ema_indicator.dart';
import 'package:flato/features/chart/domain/indicators/rsi_indicator.dart';

class IndicatorsBloc extends Bloc<IndicatorsEvent, IndicatorsState> {
  IndicatorsBloc() : super(IndicatorsState.initial()) {
    on<LoadIndicators>((event, emit) {
      final ema = EMAIndicator.calculate(event.prices, period: 14);
      final rsi = RSIIndicator.calculate(event.prices, period: 14);
      emit(IndicatorsState(ema: ema, rsi: rsi));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/presentation/bloc/indicators/indicators_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 374: lib/features/chart/data/orientation_state_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/data/orientation_state_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 536.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class OrientationStateFix {
  static const key = "chart_orientation_state";

  static Future<void> save(Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/data/orientation_state_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 375: lib/features/chart/data/view_state_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/data/view_state_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 526.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ViewStateStorage {
  static const key = "chart_view_state";

  static Future<void> save(Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/data/view_state_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 376: lib/features/chart/data/storage/chart_view_state_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/data/storage/chart_view_state_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 534.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ChartViewStateStorage {
  static const _key = "chart_view_state";

  static Future<void> save(Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(_key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(_key);
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/data/storage/chart_view_state_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 377: lib/features/chart/data/sync/history_stream_sync_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/data/sync/history_stream_sync_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 45
================================================================================

import '../../../domain/entities/candle.dart';
import '../../stream/live_stream_adapter.dart';

class HistoryStreamSyncManager {
  final LiveStreamAdapter _stream;
  List<Candle> _history = [];

  HistoryStreamSyncManager(this._stream);

  void addHistory(List<Candle> hist) {
    _history = hist;
  }

  void startStreaming({
    required String accountId,
    required String instruments,
    required Map<String, String> headers,
    required void Function(Candle) onCandle,
  }) async {
    await _stream.connect(
      accountId: accountId,
      instruments: instruments,
      headers: headers,
    );

    _stream.stream?.listen((raw) {
      final candle = Candle(
        time: DateTime.parse(raw["time"]),
        open: (raw["open"] as num).toDouble(),
        high: (raw["high"] as num).toDouble(),
        low: (raw["low"] as num).toDouble(),
        close: (raw["close"] as num).toDouble(),
      );

      // Ø¥Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙØ§Ø±Øº Ø£Ùˆ Ø¢Ø®Ø± Ø´Ù…Ø¹Ø© Ù…ØªØ³Ø§ÙˆÙŠØ© Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØª
      if (_history.isEmpty || candle.time.isAfter(_history.last.time)) {
        onCandle(candle);
      }
    });
  }

  void stop() {
    _stream.disconnect();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/data/sync/history_stream_sync_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 378: lib/features/chart/domain/chart_zones_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/chart_zones_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 404.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:hive/hive.dart';

class ChartZonesRepository {
  static Future<void> saveZone(int fromTs, int toTs, String color) async {
    final box = await Hive.openBox('chartZones');
    await box.add({'from': fromTs, 'to': toTs, 'color': color});
  }

  static Future<List<Map>> getZones() async {
    final box = await Hive.openBox('chartZones');
    return box.values.cast<Map>().toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/chart_zones_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 379: lib/features/chart/domain/touch_event_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/touch_event_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 164.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class TouchEventFilter {
  bool drawingMode = false;

  bool shouldHandleTouch(double x, double y) {
    return drawingMode; // ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø³Ù…
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/touch_event_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 380: lib/features/chart/domain/touch_mode_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/touch_mode_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 92.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class TouchModeGuard {
  bool drawing = false;

  bool allowWebViewGesture() => !drawing;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/touch_mode_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 381: lib/features/chart/domain/draw_mode_flag.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/draw_mode_flag.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 151.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class DrawModeFlag {
  bool _active = false;
  void enable() => _active = true;
  void disable() => _active = false;
  bool get isActive => _active;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/draw_mode_flag.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 382: lib/features/chart/domain/drawing_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/drawing_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 433.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:hive/hive.dart';

class DrawingStorage {
  static Box? _box;

  static Future<Box> _getBox() async =>
      _box ??= await Hive.openBox('drawings');

  static Future<void> saveDrawing(String key, Map data) async {
    final b = await _getBox();
    await b.put(key, data);
  }

  static Future<Map?> loadDrawing(String key) async {
    final b = await _getBox();
    return b.get(key)?.cast<String, dynamic>();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/drawing_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 383: lib/features/chart/domain/drawing/trendline_mapping_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/drawing/trendline_mapping_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 610.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

class TrendlineMappingFix {
  static double mapPriceToY({
    required double price,
    required double minPrice,
    required double maxPrice,
    required double height,
  }) {
    final range = maxPrice - minPrice;
    return (maxPrice - price) / (range == 0 ? 1 : range) * height;
  }

  static double mapTimeToX({
    required DateTime time,
    required DateTime start,
    required DateTime end,
    required double width,
  }) {
    final total = end.difference(start).inMilliseconds;
    final delta = time.difference(start).inMilliseconds;
    return width * (total == 0 ? 0 : delta / total);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/drawing/trendline_mapping_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 384: lib/features/chart/domain/drawing/draw_tool_mapping_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/drawing/draw_tool_mapping_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter/material.dart';

class DrawToolMappingFix {
  static Offset toScreen(
      {required DateTime time,
      required double price,
      required DateTime start,
      required DateTime end,
      required double minPrice,
      required double maxPrice,
      required Size size}) {
    final px = (time.millisecondsSinceEpoch - start.millisecondsSinceEpoch) /
        (end.millisecondsSinceEpoch - start.millisecondsSinceEpoch);
    final py = (price - minPrice) / (maxPrice - minPrice);

    return Offset(px * size.width, (1 - py) * size.height);
  }

  static Map<String, dynamic> fromScreen(Offset point, Size size,
      DateTime start, DateTime end, double minPrice, double maxPrice) {
    final px = point.dx / size.width;
    final py = 1 - (point.dy / size.height);

    final time = DateTime.fromMillisecondsSinceEpoch(
        start.millisecondsSinceEpoch +
            (end.millisecondsSinceEpoch - start.millisecondsSinceEpoch) *
                px.toInt());
    final price = minPrice + (maxPrice - minPrice) * py;
    return {"time": time, "price": price};
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/drawing/draw_tool_mapping_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 385: lib/features/chart/domain/tools/drawing_tool_sync.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/tools/drawing_tool_sync.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 555.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

class DrawingToolSync {
  double mapPriceToY({
    required double price,
    required double minPrice,
    required double maxPrice,
    required double height,
  }) {
    return height * (maxPrice - price) / (maxPrice - minPrice);
  }

  double mapTimeToX({
    required DateTime time,
    required DateTime start,
    required DateTime end,
    required double width,
  }) {
    final total = end.difference(start).inMilliseconds.toDouble();
    final delta = time.difference(start).inMilliseconds.toDouble();
    return width * (delta / total);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/tools/drawing_tool_sync.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 386: lib/features/chart/domain/usecases/load_historical_candles.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/usecases/load_historical_candles.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 471.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import '../../../../core/di/dependency_injection.dart';
import '../../../market/domain/repositories/market_repository.dart';
import '../../../market/domain/entities/candle.dart';

class LoadHistoricalCandles {
  final MarketRepository _repo = di<MarketRepository>();

  Future<List<Candle>> execute(
    String accountId,
    String symbol,
    String timeframe,
  ) {
    return _repo.fetchHistoricalCandles(
      accountId,
      symbol,
      timeframe,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/usecases/load_historical_candles.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 387: lib/features/chart/domain/indicators/macd_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/indicators/macd_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 868.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

import 'indicator_base.dart';
import 'ema_indicator.dart';

class MACDIndicator extends Indicator {
  final int shortPeriod;
  final int longPeriod;
  final int signalPeriod;

  MACDIndicator({
    this.shortPeriod = 12,
    this.longPeriod = 26,
    this.signalPeriod = 9,
  }) : super("MACD");

  @override
  List<double> compute(List<double> prices) {
    final emaShort = EMAIndicator(shortPeriod).compute(prices);
    final emaLong = EMAIndicator(longPeriod).compute(prices);
    final List<double> macd = [];

    int length = emaShort.length < emaLong.length ? emaShort.length : emaLong.length;
    for (int i = 0; i < length; i++) {
      macd.add(emaShort[i] - emaLong[i]);
    }

    final signal = EMAIndicator(signalPeriod).compute(macd);
    return macd.mapIndexed((i, v) => v - signal[i]).toList();
  }

  @override
  Color get color => Colors.purple;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/indicators/macd_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 388: lib/features/chart/domain/indicators/ema_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/indicators/ema_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 604.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'indicator_base.dart';

class EMAIndicator extends Indicator {
  final int period;
  EMAIndicator(this.period) : super("EMA\$period");

  @override
  List<double> compute(List<double> prices) {
    final List<double> result = [];
    if (prices.length < period) return result;
    double k = 2 / (period + 1);
    double ema = prices.take(period).reduce((a, b) => a + b) / period;
    result.add(ema);
    for (int i = period; i < prices.length; i++) {
      ema = prices[i] * k + ema * (1 - k);
      result.add(ema);
    }
    return result;
  }

  @override
  Color get color => Colors.blue;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/indicators/ema_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 389: lib/features/chart/domain/indicators/rsi_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/indicators/rsi_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 38
================================================================================

import 'indicator_base.dart';

class RSIIndicator extends Indicator {
  final int period;
  RSIIndicator(this.period) : super("RSI\$period");

  @override
  List<double> compute(List<double> prices) {
    final List<double> result = [];
    if (prices.length < period + 1) return result;

    double gainSum = 0;
    double lossSum = 0;
    for (int i = 1; i <= period; i++) {
      double diff = prices[i] - prices[i - 1];
      if (diff >= 0) gainSum += diff;
      else lossSum -= diff;
    }

    double avgGain = gainSum / period;
    double avgLoss = lossSum / period;
    double rs = avgLoss == 0 ? 100 : avgGain / avgLoss;
    result.add(100 - (100 / (1 + rs)));

    for (int i = period + 1; i < prices.length; i++) {
      double diff = prices[i] - prices[i - 1];
      avgGain = ((avgGain * (period - 1)) + (diff > 0 ? diff : 0)) / period;
      avgLoss = ((avgLoss * (period - 1)) + (diff < 0 ? -diff : 0)) / period;
      rs = avgLoss == 0 ? 100 : avgGain / avgLoss;
      result.add(100 - (100 / (1 + rs)));
    }

    return result;
  }

  @override
  Color get color => Colors.orange;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/indicators/rsi_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 390: lib/features/chart/domain/indicators/indicator_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/indicators/indicator_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 454.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'indicator_base.dart';
import 'ema_indicator.dart';
import 'rsi_indicator.dart';
import 'macd_indicator.dart';

class IndicatorManager {
  final List<Indicator> _active = [];

  void add(Indicator i) {
    if (!_active.any((e) => e.name == i.name)) _active.add(i);
  }

  void remove(String name) {
    _active.removeWhere((e) => e.name == name);
  }

  List<Indicator> get all => List.unmodifiable(_active);

  void clear() => _active.clear();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/indicators/indicator_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 391: lib/features/chart/domain/indicators/indicator_base.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/chart/domain/indicators/indicator_base.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 239.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:flutter/material.dart';

abstract class Indicator {
  final String name;
  Indicator(this.name);

  /// Accept candles and return list of values for drawing
  List<double> compute(List<double> prices);
  Color get color;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/chart/domain/indicators/indicator_base.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 392: lib/features/replay/presentation/widgets/replay_controls.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/presentation/widgets/replay_controls.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 586.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter/material.dart';

class ReplayControls extends StatelessWidget {
  final VoidCallback onPlay;
  final VoidCallback onPause;
  final VoidCallback onStop;

  ReplayControls({
    required this.onPlay,
    required this.onPause,
    required this.onStop,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        IconButton(icon: Icon(Icons.play_arrow), onPressed: onPlay),
        IconButton(icon: Icon(Icons.pause), onPressed: onPause),
        IconButton(icon: Icon(Icons.stop), onPressed: onStop),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/presentation/widgets/replay_controls.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 393: lib/features/replay/presentation/bloc/replay_bloc_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/presentation/bloc/replay_bloc_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 590.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/controller/replay_controller.dart';

class ReplayBlocFix extends Bloc<ReplayEvent, ReplayState> {
  final ReplayController _ctrl = ReplayController();

  ReplayBlocFix(): super(ReplayIdle()) {
    on<StartReplay>((evt, emit) {
      _ctrl.play(evt.stream, (data) => add(ReplayTick(data)));
      emit(ReplayPlaying());
    });

    on<StopReplay>((_, emit) {
      _ctrl.stop();
      emit(ReplayStopped());
    });
  }

  @override
  Future<void> close() async {
    _ctrl.dispose();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/presentation/bloc/replay_bloc_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 394: lib/features/replay/presentation/bloc/replay_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/presentation/bloc/replay_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 246.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import '../../../domain/replay_state.dart';

abstract class ReplayStatus {}
class ReplayIdle extends ReplayStatus {}
class ReplayPlaying extends ReplayStatus {}
class ReplayPaused extends ReplayStatus {}
class ReplayEnded extends ReplayStatus {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/presentation/bloc/replay_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 395: lib/features/replay/presentation/bloc/replay_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/presentation/bloc/replay_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 785.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'replay_event.dart';
import 'replay_state.dart';
import '../../../domain/replay_engine.dart';
import '../../../domain/replay_state.dart';

class ReplayBloc extends Bloc<ReplayEvent, ReplayStatus> {
  ReplayEngine? engine;

  ReplayBloc() : super(ReplayIdle()) {
    on<StartReplay>(_onStart);
    on<PauseReplay>((_, emit) => emit(ReplayPaused()));
    on<ResumeReplay>((_, emit) => emit(ReplayPlaying()));
    on<StopReplay>((_, emit) => emit(ReplayEnded()));
  }

  void _onStart(StartReplay event, Emitter<ReplayStatus> emit) async {
    // load history from repo
    engine = ReplayEngine([]);
    engine!.setSpeed(event.speed);
    emit(ReplayPlaying());
    engine!.play((c) {
      // dispatch to chart Bloc
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/presentation/bloc/replay_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 396: lib/features/replay/presentation/bloc/replay_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/presentation/bloc/replay_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 333.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

abstract class ReplayEvent {}
class StartReplay extends ReplayEvent {
  final DateTime from;
  final DateTime to;
  final double speed;

  StartReplay({required this.from, required this.to, this.speed = 1});
}
class PauseReplay extends ReplayEvent {}
class ResumeReplay extends ReplayEvent {}
class StopReplay extends ReplayEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/presentation/bloc/replay_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 397: lib/features/replay/presentation/pages/replay_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/presentation/pages/replay_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 64
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../market/domain/entities/candle.dart';
import '../../presentation/bloc/replay_bloc.dart';
import '../../presentation/bloc/replay_event.dart';
import '../../presentation/bloc/replay_state.dart';
import '../../../replay/domain/entities/speed.dart';

class ReplayPage extends StatelessWidget {
  final String symbol;
  final String timeframe;

  ReplayPage({required this.symbol, required this.timeframe});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Market Replay (\$symbol)")),
      body: Column(
        children: [
          BlocBuilder<ReplayBloc, ReplayState>(
            builder: (context, state) {
              if (state is ReplayLoading) return CircularProgressIndicator();
              if (state is ReplayError) return Text(state.message);
              if (state is ReplayReady || state is ReplayPaused || state is ReplayRunning) {
                final total = (state as dynamic).total;
                final speed = (state as dynamic).speed;
                int index = (state is ReplayRunning) ? state.index : ((state is ReplayPaused) ? state.index : 0);

                return Column(
                  children: [
                    Text("Progress: \$index / \$total"),
                    SizedBox(height: 10),
                    Row(
                      children: [
                        ElevatedButton(onPressed: () => context.read<ReplayBloc>().add(StartReplay()), child: Text("Start")),
                        ElevatedButton(onPressed: () => context.read<ReplayBloc>().add(PauseReplay()), child: Text("Pause")),
                        ElevatedButton(onPressed: () => context.read<ReplayBloc>().add(StopReplay()), child: Text("Stop")),
                      ],
                    ),
                    Row(
                      children: [
                        Text("Speed:"),
                        DropdownButton<ReplaySpeed>(
                          value: speed,
                          items: ReplaySpeed.values.map((s) => DropdownMenuItem(value: s, child: Text(s.name))).toList(),
                          onChanged: (s) => context.read<ReplayBloc>().add(ChangeReplaySpeed(s!)),
                        ),
                      ],
                    ),
                  ],
                );
              }
              return ElevatedButton(
                onPressed: () => context.read<ReplayBloc>().add(LoadReplayData(symbol: symbol, timeframe: timeframe)),
                child: Text("Load Data"),
              );
            },
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/presentation/pages/replay_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 398: lib/features/replay/domain/replay_volume_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_volume_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 175.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import '../../../core/models/candle_entity.dart';

class ReplayVolumeFix {
  double lastVolume = 0;

  void track(CandleEntity candle) {
    lastVolume = candle.volume;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_volume_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 399: lib/features/replay/domain/replay_execution_lock.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_execution_lock.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 192.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class ReplayExecutionLock {
  bool _busy = false;

  Future<void> runSafe(Future<void> Function() fn) async {
    if (_busy) return;
    _busy = true;
    await fn();
    _busy = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_execution_lock.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 400: lib/features/replay/domain/replay_engine_reset_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_engine_reset_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 80.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class ReplayEngineResetFix {
  int _index = 0;

  void reset() => _index = 0;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_engine_reset_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 401: lib/features/replay/domain/replay_strategy_sync_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_strategy_sync_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 123.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class ReplayStrategySyncFix {
  bool _ready = false;

  void markReady() => _ready = true;
  bool get isReady => _ready;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_strategy_sync_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 402: lib/features/replay/domain/replay_engine_cleanup_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_engine_cleanup_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 136.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class ReplayEngineCleanupFix {
  bool _playing = false;

  void stop() {
    _playing = false;
  }

  bool get isPlaying => _playing;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_engine_cleanup_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 403: lib/features/replay/domain/replay_scheduler_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_scheduler_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 253.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class ReplaySchedulerFix {
  Timer? _timer;

  void start(void Function() cb, Duration interval) {
    stop();
    _timer = Timer.periodic(interval, (_) => cb());
  }

  void stop() {
    _timer?.cancel();
    _timer = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_scheduler_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 404: lib/features/replay/domain/replay_scheduler.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_scheduler.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 282.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class ReplayScheduler {
  Timer? _replayTimer;

  void start(void Function() onTick, Duration interval) {
    stop();
    _replayTimer = Timer.periodic(interval, (_) => onTick());
  }

  void stop() {
    _replayTimer?.cancel();
    _replayTimer = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_scheduler.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 405: lib/features/replay/domain/replay_engine2.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_engine2.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 882.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import '../../../core/models/tick_entity.dart';
import '../../../core/models/candle_entity.dart';

typedef ReplayTickCb = void Function(TickEntity);
typedef ReplayCandleCb = void Function(CandleEntity);

class ReplayEngine2 {
  final List<TickEntity> ticks;
  final List<CandleEntity> candles;
  int _tickIdx = 0;
  int _candleIdx = 0;
  bool _playing = false;

  ReplayEngine2(this.ticks, this.candles);

  void play({required ReplayTickCb onTick, required ReplayCandleCb onCandle}) async {
    _playing = true;
    while (_playing &&
           (_tickIdx < ticks.length || _candleIdx < candles.length)) {
      if (_tickIdx < ticks.length) {
        onTick(ticks[_tickIdx++]);
      }
      if (_candleIdx < candles.length) {
        onCandle(candles[_candleIdx++]);
      }
      await Future.delayed(Duration(milliseconds: 200));
    }
  }

  void stop() => _playing = false;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_engine2.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 406: lib/features/replay/domain/replay_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 798.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 34
================================================================================

import '../../../core/models/candle_entity.dart';

typedef ReplayTickCallback = void Function(CandleEntity);

class ReplayEngine {
  final List<CandleEntity> history;
  int _index = 0;
  bool _isPlaying = false;
  Duration _speedFactor = Duration(milliseconds: 500); // 2x real

  ReplayEngine(this.history);

  void play(ReplayTickCallback onTick) async {
    _isPlaying = true;
    while (_isPlaying && _index < history.length) {
      onTick(history[_index]);
      await Future.delayed(_speedFactor);
      _index++;
    }
  }

  void pause() => _isPlaying = false;

  void resume(ReplayTickCallback onTick) => play(onTick);

  void stop() {
    _isPlaying = false;
    _index = 0;
  }

  void setSpeed(double factor) {
    _speedFactor = Duration(milliseconds: (1000 / factor).round());
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 407: lib/features/replay/domain/replay_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/replay_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 67.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

enum ReplayPlaybackState {
  idle,
  playing,
  paused,
  ended,
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/replay_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 408: lib/features/replay/domain/entities/replay_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/entities/replay_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 299.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import '../../../market/domain/entities/candle.dart';

/// Replicate an event in the replay (e.g., new candle)
class ReplayEvent {
  final CandleEntity candle;
  final DateTime timestamp; // time at which this should fire in replay

  ReplayEvent({required this.candle, required this.timestamp});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/entities/replay_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 409: lib/features/replay/domain/entities/speed.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/entities/speed.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 353.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

enum ReplaySpeed {
  x1,
  x2,
  x5,
  x10,
}

extension SpeedMultiplier on ReplaySpeed {
  double get multiplier {
    switch (this) {
      case ReplaySpeed.x2:
        return 2.0;
      case ReplaySpeed.x5:
        return 5.0;
      case ReplaySpeed.x10:
        return 10.0;
      case ReplaySpeed.x1:
      default:
        return 1.0;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/entities/speed.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 410: lib/features/replay/domain/controller/replay_controller.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/controller/replay_controller.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 527.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'dart:async';

class ReplayController {
  final List<StreamSubscription> _subs = [];
  bool _isPlaying = false;

  void play(Stream stream, void Function(dynamic) onData) {
    stop();      // ØªÙˆÙ‚Ù Ø£ÙŠ ØªØ´ØºÙŠÙ„ Ø³Ø§Ø¨Ù‚
    _isPlaying = true;
    final sub = stream.listen((data) {
      if (!_isPlaying) return;
      onData(data);
    });
    _subs.add(sub);
  }

  void stop() {
    _isPlaying = false;
    for (final s in _subs) {
      s.cancel();
    }
    _subs.clear();
  }

  void dispose() => stop();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/controller/replay_controller.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 411: lib/features/replay/domain/engine/replay_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/domain/engine/replay_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 972.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 47
================================================================================

import 'dart:async';
import '../../../market/domain/entities/candle.dart';
import '../entities/speed.dart';

typedef OnCandleCallback = void Function(CandleEntity);

class ReplayEngine {
  final List<CandleEntity> candles;
  final OnCandleCallback onCandle;
  final ReplaySpeed speed;

  Timer? _timer;
  int _index = 0;

  ReplayEngine({
    required this.candles,
    required this.onCandle,
    this.speed = ReplaySpeed.x1,
  });

  void start() {
    stop();
    _index = 0;
    if (candles.isEmpty) return;

    final baseDelay = Duration(seconds: 1);
    final intervalMs = baseDelay.inMilliseconds ~/ speed.multiplier;

    _timer = Timer.periodic(Duration(milliseconds: intervalMs), (timer) {
      if (_index >= candles.length) {
        stop();
        return;
      }
      onCandle(candles[_index]);
      _index++;
    });
  }

  void stop() {
    _timer?.cancel();
    _timer = null;
  }

  void pause() => stop();

  bool get isRunning => _timer != null;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/domain/engine/replay_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 412: lib/features/replay/data/datasources/replay_data_source.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/replay/data/datasources/replay_data_source.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 630.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import '../../../../market/domain/entities/candle.dart';
import '../../../../market/domain/repositories/market_repository.dart';

class ReplayDataSource {
  final MarketRepository repository;

  ReplayDataSource(this.repository);

  /// Fetch huge range for replay (Ù…Ø«Ù„Ø§Ù‹ 5000 Ø´Ù…Ø¹Ø©)
  Future<List<CandleEntity>> fetchForReplay({
    required String symbol,
    required String timeframe,
    int count = 5000,
  }) async {
    final models = await repository.getHistoricalCandlesPage(
      symbol: symbol,
      timeframe: timeframe,
      count: count,
    );
    return models.map((m) => m.toEntity()).toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/replay/data/datasources/replay_data_source.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 413: lib/features/alerts/domain/alert_condition.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/domain/alert_condition.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 335.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

class AlertCondition {
  final String indicator;
  final String operator; // ex: <, >, <=
  final double threshold;
  final Duration duration; // e.g., trigger if condition holds for 2 minutes

  AlertCondition({
    required this.indicator,
    required this.operator,
    required this.threshold,
    required this.duration,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/domain/alert_condition.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 414: lib/features/alerts/domain/alert_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/domain/alert_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 41
================================================================================

import 'alert_condition.dart';

class AlertEngine {
  final List<AlertCondition> conditions;
  final Map<String, DateTime> _startMap = {};

  AlertEngine(this.conditions);

  List<String> evaluate(Map<String, double> indicatorValues) {
    final now = DateTime.now();
    final triggered = <String>[];

    for (final cond in conditions) {
      final value = indicatorValues[cond.indicator] ?? 0;
      final satisfied = _compare(value, cond.operator, cond.threshold);

      final key = cond.indicator + cond.operator + cond.threshold.toString();
      if (satisfied) {
        _startMap.putIfAbsent(key, () => now);
        if (now.difference(_startMap[key]!) >= cond.duration) {
          triggered.add('${cond.indicator} ${cond.operator} ${cond.threshold}');
        }
      } else {
        _startMap.remove(key);
      }
    }

    return triggered;
  }

  bool _compare(double v, String op, double t) {
    switch (op) {
      case '>': return v > t;
      case '<': return v < t;
      case '>=': return v >= t;
      case '<=': return v <= t;
      case '==': return v == t;
      default: return false;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/domain/alert_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 415: lib/features/alerts/domain/alert_rate_limit_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/domain/alert_rate_limit_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 283.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

class AlertRateLimiter {
  DateTime? lastTriggered;

  bool canTrigger(Duration minGap) {
    final now = DateTime.now();
    if (lastTriggered == null ||
        now.difference(lastTriggered!) >= minGap) {
      lastTriggered = now;
      return true;
    }
    return false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/domain/alert_rate_limit_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 416: lib/features/alerts/domain/alert_rate_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/domain/alert_rate_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 289.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

class AlertRateManager {
  DateTime? _lastTime;

  bool canNotify(Duration gap) {
    final now = DateTime.now();
    if (_lastTime == null || now.difference(_lastTime!) >= gap) {
      _lastTime = now;
      return true;
    }
    return false;
  }

  void reset() => _lastTime = null;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/domain/alert_rate_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 417: lib/features/alerts/presentation/alert_log_screen.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/presentation/alert_log_screen.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 793.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter/material.dart';
import '../data/alert_log_repository.dart';

class AlertLogScreen extends StatefulWidget {
  @override
  _AlertLogScreenState createState() => _AlertLogScreenState();
}

class _AlertLogScreenState extends State<AlertLogScreen> {
  List<Map> logs = [];

  @override
  void initState() {
    super.initState();
    AlertLogRepository.getLogs().then((value) => setState(() => logs = value));
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª")),
      body: ListView.builder(
        itemCount: logs.length,
        itemBuilder: (_, i) => ListTile(
          title: Text(logs[i]['msg']),
          subtitle: Text(logs[i]['timestamp']),
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/presentation/alert_log_screen.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 418: lib/features/alerts/presentation/alert_notifier.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/presentation/alert_notifier.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 285.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import '../../../core/widgets/notification_toast.dart';
import '../../../core/audio/alert_sound.dart';

class AlertNotifier {
  final _sound = AlertSound();

  void trigger(String message) {
    NotificationToast.show(message);
    _sound.playBuy(); // Ù…Ø«Ø§Ù„: ØµÙˆØª Ù…ÙˆØ­Ø¯
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/presentation/alert_notifier.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 419: lib/features/alerts/presentation/bloc/alert_bloc_cleanup.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/presentation/bloc/alert_bloc_cleanup.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 302.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:async';
mixin AlertBlocCleanup {
  final List<StreamController> _controllers = [];

  void addController(StreamController c) => _controllers.add(c);

  @override
  Future<void> close() async {
    for (final c in _controllers) {
      await c.close();
    }
    await super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/presentation/bloc/alert_bloc_cleanup.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 420: lib/features/alerts/data/alert_preferences.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/data/alert_preferences.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 516.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class AlertPreferences {
  static Future<void> save(String id, Map<String, dynamic> cfg) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("alert_$id", jsonEncode(cfg));
  }

  static Future<Map<String, dynamic>?> load(String id) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString("alert_$id");
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/data/alert_preferences.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 421: lib/features/alerts/data/alert_log_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/data/alert_log_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 385.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:hive/hive.dart';

class AlertLogRepository {
  static Future<void> log(String msg) async {
    final box = await Hive.openBox('alertLogs');
    await box.add({'msg': msg, 'timestamp': DateTime.now().toIso8601String()});
  }

  static Future<List<Map>> getLogs() async {
    final box = await Hive.openBox('alertLogs');
    return box.values.cast<Map>().toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/data/alert_log_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 422: lib/features/alerts/data/alert_persistence_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alerts/data/alert_persistence_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 497.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class AlertPersistenceFix {
  static Future<void> save(String key, Map cfg) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("alert_cfg_$key", jsonEncode(cfg));
  }

  static Future<Map?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString("alert_cfg_$key");
    return str == null ? null : jsonDecode(str);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alerts/data/alert_persistence_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 423: lib/features/backtest/domain/backtest_network_bounce_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_network_bounce_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 299.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import '../../../core/network/retry/retry_with_backoff.dart';

class BacktestNetworkBounceGuard {
  final int maxRetries;

  BacktestNetworkBounceGuard({this.maxRetries = 5});

  Future<T> safeFetch<T>(Future<T> Function() fetchFn) {
    return retryWithBackoff(fetchFn, retries: maxRetries);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_network_bounce_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 424: lib/features/backtest/domain/signal_eval_buffer_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/signal_eval_buffer_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 216.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class SignalEvalBufferFix {
  bool _processing = false;

  Future<void> process(Future<void> Function() fn) async {
    if (_processing) return;
    _processing = true;
    await fn();
    _processing = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/signal_eval_buffer_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 425: lib/features/backtest/domain/backtest_equity_update_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_equity_update_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 242.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

void safelyUpdateEquity(List signals, double Function() equityCalc) {
  for (final s in signals) {
    executeSignal(s);
  }
  final newEquity = equityCalc();
  // ØªØ­Ø¯ÙŠØ« Equity Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_equity_update_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 426: lib/features/backtest/domain/backtest_sync_signals_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_sync_signals_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 105.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

void executeSignalsSafely() {
  updateEquity();
  for (final s in signals) {
    executeSignal(s);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_sync_signals_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 427: lib/features/backtest/domain/backtest_cancel_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_cancel_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 123.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class BacktestCancelGuard {
  bool _cancel = false;

  void cancel() => _cancel = true;
  bool get cancelled => _cancel;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_cancel_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 428: lib/features/backtest/domain/backtest_controller.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_controller.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 163.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'dart:async';

class BacktestController {
  bool _cancelled = false;

  bool get isCancelled => _cancelled;

  void cancel() {
    _cancelled = true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_controller.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 429: lib/features/backtest/domain/backtest_cancel_token.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_cancel_token.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 133.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class BacktestCancelToken {
  bool _cancelled = false;
  void cancel() => _cancelled = true;
  bool get isCancelled => _cancelled;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_cancel_token.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 430: lib/features/backtest/domain/backtest_engine2.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/backtest_engine2.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 703.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import '../../../core/models/candle_entity.dart';

class BacktestEngine2 {
  final List<CandleEntity> history;
  final StrategyEngine strategy;

  BacktestEngine2(this.history, this.strategy);

  void run() {
    Map<String, double> lastIndicators = {};

    for (int i = 0; i < history.length; i++) {
      final candle = history[i];
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø£ÙˆÙ„Ø§
      lastIndicators = calculateIndicators(history.sublist(0, i + 1));
      final signals = strategy.evaluateSignals(lastIndicators);

      // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
      for (final s in signals) {
        executeSignal(s, candle);
      }
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/backtest_engine2.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 431: lib/features/backtest/domain/check/preflight_check.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/check/preflight_check.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 284.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import '../../../core/models/candle_entity.dart';

class BacktestPreflightCheck {
  bool validate(List<CandleEntity> history, int minCandles) {
    if (history.length < minCandles) return false;
    // Ø£ÙŠ Ø´Ø±ÙˆØ· Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/check/preflight_check.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 432: lib/features/backtest/domain/engine/backtest_engine_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/engine/backtest_engine_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 777.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 36
================================================================================

import 'dart:async';

class BacktestEngineFix {
  bool _cancel = false;
  final StreamController<double> equityStream = StreamController.broadcast();

  void cancel() => _cancel = true;

  Future<void> run(List dataset) async {
    double equity = 0.0;

    for (final data in dataset) {
      if (_cancel) break;

      // update indicators safely
      final signals = computeSignals(data);

      // execute trades
      for (final sig in signals) {
        equity += executeTrade(sig);
      }

      equityStream.add(equity);

      // yield control to avoid blocking
      await Future.delayed(Duration(milliseconds: 1));
    }
  }

  void dispose() {
    equityStream.close();
  }

  List computeSignals(dynamic data) => [];
  double executeTrade(dynamic sig) => 0.0;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/engine/backtest_engine_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 433: lib/features/backtest/domain/engine/backtest_completion_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/engine/backtest_completion_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 154.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class BacktestCompletionGuard {
  bool _done = false;

  void markDone() => _done = true;
  bool get isDone => _done;

  void reset() => _done = false;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/engine/backtest_completion_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 434: lib/features/backtest/domain/cancel/backtest_cancel_guard2.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/cancel/backtest_cancel_guard2.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 135.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class BacktestCancelGuard2 {
  bool _cancelled = false;

  void cancel() => _cancelled = true;
  bool get isCancelled => _cancelled;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/cancel/backtest_cancel_guard2.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 435: lib/features/backtest/domain/strategy/strategy_freeze_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/domain/strategy/strategy_freeze_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 161.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class StrategyFreezeGuard {
  bool _frozen = false;

  void freeze() => _frozen = true;
  void unfreeze() => _frozen = false;

  bool get isFrozen => _frozen;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/domain/strategy/strategy_freeze_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 436: lib/features/backtest/presentation/bloc/backtest_control_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/presentation/bloc/backtest_control_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 233.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

class BacktestControlFix {
  bool _isRunning = false;

  bool startIfNotRunning(Function startFn) {
    if (_isRunning) return false;
    _isRunning = true;
    startFn();
    return true;
  }

  void done() => _isRunning = false;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/presentation/bloc/backtest_control_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 437: lib/features/backtest/presentation/bloc/backtest_mode_guard_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/presentation/bloc/backtest_mode_guard_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 504.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/mode/app_mode_guard.dart';

class BacktestModeBloc extends Bloc<BacktestEvent, BacktestState> {
  final AppModeGuard _guard;

  BacktestModeBloc(this._guard) : super(BacktestIdle());

  void startBacktest(...) {
    if (!_guard.canEnterBacktest()) return; // Ù„Ø§ Ø¥Ø¹Ø§Ø¯Ø© Backtest Ø£Ø«Ù†Ø§Ø¡ live
    _guard.enterBacktest();
    // start backtest
  }

  void stopBacktest() {
    _guard.enterLive();
    // stop backtest
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/presentation/bloc/backtest_mode_guard_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 438: lib/features/backtest/presentation/bloc/backtest_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/presentation/bloc/backtest_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 590.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

abstract class BacktestEvent {}
class RunBacktestEvent extends BacktestEvent {}

abstract class BacktestState {}
class BacktestInitial extends BacktestState {}
class BacktestRunning extends BacktestState {}
class BacktestComplete extends BacktestState {}

class BacktestBloc extends Bloc<BacktestEvent, BacktestState> {
  BacktestBloc() : super(BacktestInitial()) {
    on<RunBacktestEvent>((event, emit) async {
      emit(BacktestRunning());
      await Future.delayed(Duration(seconds: 2));
      emit(BacktestComplete());
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/presentation/bloc/backtest_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 439: lib/features/backtest/presentation/pages/backtest_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/backtest/presentation/pages/backtest_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 292.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/material.dart';

class BacktestPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Backtest"),
      ),
      body: Center(child: Text("Backtest Placeholder")),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/backtest/presentation/pages/backtest_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 440: lib/features/tape/domain/tape_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/tape/domain/tape_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 182.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class TapeEvent {
  final double price;
  final double volume;
  final DateTime time;
  final String side; // buy/sell

  TapeEvent(this.price, this.volume, this.time, this.side);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/tape/domain/tape_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 441: lib/features/tape/presentation/widgets/tape_view.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/tape/presentation/widgets/tape_view.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 484.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter/material.dart';
import '../../domain/tape_event.dart';

class TapeView extends StatelessWidget {
  final List<TapeEvent> events;
  TapeView(this.events);

  @override
  Widget build(BuildContext context) {
    return ListView(
      children: events.map((e) =>
        ListTile(
          title: Text("${e.price} (${e.side})"),
          trailing: Text("${e.volume}"),
          subtitle: Text("${e.time.toIso8601String()}"),
        )).toList(),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/tape/presentation/widgets/tape_view.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 442: lib/features/strategy_builder/presentation/canvas/strategy_canvas.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/presentation/canvas/strategy_canvas.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 50
================================================================================

import 'package:flutter/material.dart';
import '../../domain/entities/block.dart';
import '../../domain/entities/block_type.dart';
import '../../domain/entities/connection.dart';
import 'node_widget.dart';

class StrategyCanvas extends StatefulWidget {
  final List<Block> blocks;
  final List<Connection> connections;
  final Function(Block, Offset) onDrop;

  const StrategyCanvas({
    required this.blocks,
    required this.connections,
    required this.onDrop,
  });

  @override
  State<StrategyCanvas> createState() => _StrategyCanvasState();
}

class _StrategyCanvasState extends State<StrategyCanvas> {
  final Map<String, Offset> nodePositions = {};

  @override
  Widget build(BuildContext context) {
    return DragTarget<BlockType>(
      onAcceptWithDetails: (details) {
        final position = details.offset;
        final newBlock = Block(
          id: DateTime.now().millisecondsSinceEpoch.toString(),
          type: details.data,
        );
        widget.onDrop(newBlock, position);
        nodePositions[newBlock.id] = position;
      },
      builder: (context, candidateData, rejectedData) {
        return Stack(
          children: [
            Container(color: Colors.grey.shade800),
            ...widget.blocks.map((b) {
              final pos = nodePositions[b.id] ?? Offset(100, 100);
              return StrategyNode(block: b, position: pos);
            }).toList(),
          ],
        );
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/presentation/canvas/strategy_canvas.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 443: lib/features/strategy_builder/presentation/canvas/connection_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/presentation/canvas/connection_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 820.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

import 'package:flutter/material.dart';

class ConnectionPainter extends CustomPainter {
  final List<Offset> points;

  ConnectionPainter(this.points);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.blueAccent
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    if (points.length < 2) return;

    final path = Path();
    path.moveTo(points.first.dx, points.first.dy);

    for (int i = 1; i < points.length; i++) {
      final prev = points[i - 1];
      final curr = points[i];
      final control = Offset((prev.dx + curr.dx) / 2, prev.dy);
      path.quadraticBezierTo(control.dx, control.dy, curr.dx, curr.dy);
    }

    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant ConnectionPainter oldDelegate) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/presentation/canvas/connection_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 444: lib/features/strategy_builder/presentation/canvas/node_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/presentation/canvas/node_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 62
================================================================================

import 'package:flutter/material.dart';
import '../../domain/entities/block.dart';
import '../../domain/entities/block_type.dart';

class StrategyNode extends StatelessWidget {
  final Block block;
  final Offset position;

  const StrategyNode({required this.block, required this.position});

  @override
  Widget build(BuildContext context) {
    return Positioned(
      left: position.dx,
      top: position.dy,
      child: Container(
        width: 180,
        padding: EdgeInsets.all(10),
        decoration: BoxDecoration(
          color: Colors.black87,
          border: Border.all(color: Colors.blueAccent),
          borderRadius: BorderRadius.circular(10),
          boxShadow: [
            BoxShadow(color: Colors.black26, blurRadius: 6, spreadRadius: 1)
          ],
        ),
        child: Column(
          children: [
            Text(
              block.type.toString().split('.').last,
              style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 8),
            _buildPorts(),
          ],
        ),
      ),
    );
  }

  Widget _buildPorts() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        _port(Icons.input, Colors.green),  // input port
        _port(Icons.output, Colors.red),   // output port
      ],
    );
  }

  Widget _port(IconData icon, Color color) {
    return Container(
      padding: EdgeInsets.all(6),
      decoration: BoxDecoration(
        color: color.withOpacity(0.2),
        shape: BoxShape.circle,
        border: Border.all(color: color),
      ),
      child: Icon(icon, size: 14, color: color),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/presentation/canvas/node_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 445: lib/features/strategy_builder/presentation/widgets/block_palette.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/presentation/widgets/block_palette.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 52
================================================================================

import 'package:flutter/material.dart';
import '../../domain/entities/block_type.dart';

class BlockPalette extends StatelessWidget {
  final Function(BlockType) onDragStart;

  const BlockPalette({required this.onDragStart});

  @override
  Widget build(BuildContext context) {
    final blocks = {
      "Price Above": BlockType.priceAbove,
      "Price Below": BlockType.priceBelow,
      "EMA Cross Up": BlockType.emaCrossUp,
      "EMA Cross Down": BlockType.emaCrossDown,
      "RSI Below": BlockType.rsiBelow,
      "RSI Above": BlockType.rsiAbove,
      "AND": BlockType.and,
      "OR": BlockType.or,
      "BUY": BlockType.buy,
      "SELL": BlockType.sell,
    };

    return Container(
      width: 180,
      color: Colors.grey.shade900,
      child: ListView(
        children: blocks.entries.map((e) {
          return Draggable<BlockType>(
            data: e.value,
            feedback: _buildBlock(e.key, Colors.blueAccent),
            child: _buildBlock(e.key, Colors.white),
            onDragStarted: () => onDragStart(e.value),
          );
        }).toList(),
      ),
    );
  }

  Widget _buildBlock(String label, Color color) {
    return Container(
      margin: EdgeInsets.all(8),
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        border: Border.all(color: color),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Center(child: Text(label, style: TextStyle(color: color))),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/presentation/widgets/block_palette.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 446: lib/features/strategy_builder/domain/entities/block.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/domain/entities/block.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 274.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'block_type.dart';

class Block {
  final String id; // unique
  final BlockType type;
  final Map<String, dynamic> params; // e.g., period, threshold
  Block({required this.id, required this.type, Map<String, dynamic>? params})
      : this.params = params ?? {};
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/domain/entities/block.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 447: lib/features/strategy_builder/domain/entities/block_type.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/domain/entities/block_type.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 184.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

enum BlockType {
  // Conditions
  priceAbove,
  priceBelow,
  emaCrossUp,
  emaCrossDown,
  rsiBelow,
  rsiAbove,

  // Logical connectors
  and,
  or,

  // Actions
  buy,
  sell,
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/domain/entities/block_type.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 448: lib/features/strategy_builder/domain/entities/connection.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/domain/entities/connection.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 144.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class Connection {
  final String fromBlockId;
  final String toBlockId;

  Connection({required this.fromBlockId, required this.toBlockId});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/domain/entities/connection.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 449: lib/features/strategy_builder/domain/models/strategy_graph.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/domain/models/strategy_graph.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

import '../entities/block.dart';
import '../entities/connection.dart';

class StrategyGraph {
  final List<Block> blocks;
  final List<Connection> connections;

  StrategyGraph({required this.blocks, required this.connections});

  Map<String, dynamic> toJson() {
    return {
      "blocks": blocks.map((b) => {
            "id": b.id,
            "type": b.type.toString(),
            "params": b.params,
          }).toList(),
      "connections": connections
          .map((c) => {"from": c.fromBlockId, "to": c.toBlockId})
          .toList(),
    };
  }

  factory StrategyGraph.fromJson(Map<String, dynamic> json) {
    final blocks = (json["blocks"] as List<dynamic>)
        .map((b) => Block(
              id: b["id"],
              type: BlockType.values.firstWhere(
                  (e) => e.toString() == b["type"]),
              params: Map<String, dynamic>.from(b["params"] ?? {}),
            ))
        .toList();
    final connections = (json["connections"] as List<dynamic>)
        .map((c) => Connection(
              fromBlockId: c["from"],
              toBlockId: c["to"],
            ))
        .toList();
    return StrategyGraph(blocks: blocks, connections: connections);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/domain/models/strategy_graph.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 450: lib/features/strategy_builder/domain/interpreter/strategy_interpreter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/domain/interpreter/strategy_interpreter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 62
================================================================================

import '../entities/block.dart';
import '../entities/block_type.dart';
import '../models/strategy_graph.dart';
import '../../../market/domain/entities/candle.dart';

class StrategyInterpreter {
  final StrategyGraph graph;

  StrategyInterpreter(this.graph);

  bool evaluate(List<CandleEntity> history) {
    final Map<String, bool> results = {};

    for (var block in graph.blocks) {
      results[block.id] = _evalBlock(block, history, results);
    }

    // Find final BUY/SELL blocks
    final buyBlocks =
        graph.blocks.where((b) => b.type == BlockType.buy).toList();
    for (var b in buyBlocks) {
      final incoming = graph.connections
          .where((c) => c.toBlockId == b.id)
          .map((c) => results[c.fromBlockId] ?? false)
          .toList();

      if (incoming.every((v) => v == true)) return true;
    }

    return false;
  }

  bool _evalBlock(Block b, List<CandleEntity> history, Map<String, bool> results) {
    switch (b.type) {
      case BlockType.priceAbove:
        return history.last.close >
            history[history.length - 2].close;

      case BlockType.rsiBelow:
        return b.params["value"] != null
            ? history.last.close < b.params["value"]
            : true;

      case BlockType.and:
        final inputs = graph.connections
            .where((c) => c.toBlockId == b.id)
            .map((c) => results[c.fromBlockId] ?? false)
            .toList();
        return inputs.every((v) => v);

      case BlockType.or:
        final inputs = graph.connections
            .where((c) => c.toBlockId == b.id)
            .map((c) => results[c.fromBlockId] ?? false)
            .toList();
        return inputs.any((v) => v);

      default:
        return false;
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/domain/interpreter/strategy_interpreter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 451: lib/features/strategy_builder/data/strategy_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_builder/data/strategy_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 600.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../domain/models/strategy_graph.dart';

class StrategyStorage {
  static const _key = "saved_strategy";

  Future<void> save(StrategyGraph graph) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_key, jsonEncode(graph.toJson()));
  }

  Future<StrategyGraph?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final data = prefs.getString(_key);
    if (data == null) return null;
    return StrategyGraph.fromJson(jsonDecode(data));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_builder/data/strategy_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 452: lib/features/account/domain/account_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/account/domain/account_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 754.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 30
================================================================================

class AccountModel {
  double balance;
  double equity;
  double marginUsed = 0;
  double leverage = 100;

  AccountModel({
    required this.balance,
    required this.equity,
    this.leverage = 100,
  });

  double get availableMargin => equity - marginUsed;

  bool canOpen(double lotSize, double price) {
    final required = (lotSize * price) / leverage;
    return required <= availableMargin;
  }

  void openPosition(double lotSize, double price) {
    final required = (lotSize * price) / leverage;
    if (!canOpen(lotSize, price)) throw Exception("Insufficient margin");
    marginUsed += required;
  }

  void closePosition(double lotSize, double price) {
    final released = (lotSize * price) / leverage;
    marginUsed -= released;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/account/domain/account_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 453: lib/features/trading/presentation/pages/trading_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/pages/trading_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 303.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/material.dart';

class TradingPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Trading"),
      ),
      body: Center(child: Text("Trading Functionality Placeholder")),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/pages/trading_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 454: lib/features/trading/presentation/widgets/trade_action_button.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/widgets/trade_action_button.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 509.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter/material.dart';

class TradeActionButton extends StatelessWidget {
  final String action;
  final VoidCallback onTap;

  TradeActionButton({required this.action, required this.onTap});

  @override
  Widget build(BuildContext context) {
    final isBuy = action.toUpperCase() == "BUY";
    return ElevatedButton(
      style: ElevatedButton.styleFrom(
        backgroundColor: isBuy ? Colors.green : Colors.red,
      ),
      child: Text(action),
      onPressed: onTap,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/widgets/trade_action_button.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 455: lib/features/trading/presentation/widgets/stop_take_input.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/widgets/stop_take_input.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 724.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter/material.dart';

class StopTakeInput extends StatelessWidget {
  final Function(double, double) onApply;

  StopTakeInput({required this.onApply});

  @override
  Widget build(BuildContext context) {
    double sl = 0, tp = 0;
    return Column(
      children: [
        TextField(
          decoration: InputDecoration(labelText: "Stop Loss"),
          onChanged: (v) => sl = double.tryParse(v) ?? 0,
        ),
        TextField(
          decoration: InputDecoration(labelText: "Take Profit"),
          onChanged: (v) => tp = double.tryParse(v) ?? 0,
        ),
        ElevatedButton(
          child: Text("Apply"),
          onPressed: () => onApply(sl, tp),
        )
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/widgets/stop_take_input.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 456: lib/features/trading/presentation/widgets/signals_panel.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/widgets/signals_panel.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 369.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter/material.dart';

class SignalsPanel extends StatelessWidget {
  final List<String> signals;

  SignalsPanel(this.signals);

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: signals.map((s) => Text(s, style: TextStyle(fontSize: 14))).toList(),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/widgets/signals_panel.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 457: lib/features/trading/presentation/widgets/market_order_dialog.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/widgets/market_order_dialog.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 45
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/trading_bloc.dart';

class MarketOrderDialog extends StatefulWidget {
  final String symbol;
  MarketOrderDialog({required this.symbol});

  @override
  _MarketOrderDialogState createState() => _MarketOrderDialogState();
}

class _MarketOrderDialogState extends State<MarketOrderDialog> {
  final _unitsCtrl = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Market Order: \${widget.symbol}"),
      content: Column(mainAxisSize: MainAxisSize.min, children: [
        TextField(
          controller: _unitsCtrl,
          decoration: InputDecoration(labelText: "Units"),
          keyboardType: TextInputType.number,
        ),
      ]),
      actions: [
        TextButton(
          child: Text("Cancel"),
          onPressed: () => Navigator.pop(context),
        ),
        ElevatedButton(
          child: Text("Place"),
          onPressed: () {
            final units = int.tryParse(_unitsCtrl.text) ?? 0;
            context.read<TradingBloc>().add(
                  PlaceMarketOrder(symbol: widget.symbol, units: units),
                );
            Navigator.pop(context);
          },
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/widgets/market_order_dialog.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 458: lib/features/trading/presentation/bloc/orders_update_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/bloc/orders_update_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 304.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

class OrdersUpdateGuardBloc extends Bloc<OrdersEvent, OrdersState> {
  OrdersUpdateGuardBloc(): super(OrdersIdle()) {
    on<OrderExecuted>((evt, emit) {
      // immediate update after execution
      emit(OrdersUpdated(evt.updatedList));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/bloc/orders_update_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 459: lib/features/trading/presentation/bloc/trading_extension.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/bloc/trading_extension.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 233.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

extension TradingBlocStreamLink on TradingBloc {
  void bindMarketStream(Stream<Map<String, dynamic>> stream) {
    stream.listen((candle) {
      add(CheckStrategySignal(candle)); // Ø­Ø¯Ø« ÙØ­Øµ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/bloc/trading_extension.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 460: lib/features/trading/presentation/bloc/trading_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/bloc/trading_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 540.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

part of 'trading_bloc.dart';

abstract class TradingEvent {}

class PlaceMarketOrder extends TradingEvent {
  final String symbol;
  final int units;
  final double? stopLoss;
  final double? takeProfit;

  PlaceMarketOrder({
    required this.symbol,
    required this.units,
    this.stopLoss,
    this.takeProfit,
  });
}

class PlaceLimitOrder extends TradingEvent {
  final String symbol;
  final int units;
  final double price;

  PlaceLimitOrder({
    required this.symbol,
    required this.units,
    required this.price,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/bloc/trading_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 461: lib/features/trading/presentation/bloc/trading_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/bloc/trading_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 921.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../data/oanda_trade_client.dart';

part 'trading_event.dart';
part 'trading_state.dart';

class TradingBloc extends Bloc<TradingEvent, TradingState> {
  final OandaTradeClient _client = OandaTradeClient();

  TradingBloc() : super(TradingInitial()) {
    on<PlaceMarketOrder>((event, emit) async {
      emit(TradingLoading());
      final success = await _client.marketOrder(
        instrument: event.symbol,
        units: event.units,
        stopLoss: event.stopLoss,
        takeProfit: event.takeProfit,
      );
      emit(success ? TradingSuccess() : TradingFailure());
    });

    on<PlaceLimitOrder>((event, emit) async {
      emit(TradingLoading());
      final success =
          await _client.limitOrder(instrument: event.symbol, units: event.units, price: event.price);
      emit(success ? TradingSuccess() : TradingFailure());
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/bloc/trading_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 462: lib/features/trading/presentation/bloc/trading_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/presentation/bloc/trading_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 245.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

part of 'trading_bloc.dart';

abstract class TradingState {}

class TradingInitial extends TradingState {}

class TradingLoading extends TradingState {}

class TradingSuccess extends TradingState {}

class TradingFailure extends TradingState {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/presentation/bloc/trading_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 463: lib/features/trading/domain/order_submit_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order_submit_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 100.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 3
================================================================================

class OrderSubmitGuard {
  bool canSubmit(String? symbol) => symbol != null && symbol.isNotEmpty;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order_submit_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 464: lib/features/trading/domain/slipped_execution.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/slipped_execution.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 214.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'slippage_model.dart';

class SlippedExecution {
  final SlippageModel slippage;

  SlippedExecution(this.slippage);

  double execute(double intendedPrice) {
    return slippage.apply(intendedPrice);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/slipped_execution.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 465: lib/features/trading/domain/lot_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/lot_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 188.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class LotManager {
  double lotSize = 1.0;

  void setLot(double l) {
    if (l <= 0) throw ArgumentError("Lot size must be > 0");
    lotSize = l;
  }

  double get current => lotSize;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/lot_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 466: lib/features/trading/domain/slippage_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/slippage_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 207.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'dart:math';

class SlippageModel {
  double maxSlippage = 0.0005;

  double apply(double intendedPrice) {
    final slip = Random().nextDouble() * maxSlippage;
    return intendedPrice + slip;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/slippage_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 467: lib/features/trading/domain/execution_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/execution_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 282.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'lot_manager.dart';

class ExecutionEngine {
  final LotManager lotManager;

  ExecutionEngine(this.lotManager);

  void executeBuy(String symbol) {
    final lot = lotManager.current;
    print("Executing BUY $symbol @ lot $lot");
    // TODO: ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/execution_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 468: lib/features/trading/domain/order_safe_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order_safe_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 226.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'order.dart';

class OrderSafeGuard {
  static bool isValid(Order? order) {
    if (order == null) return false;
    if (order.symbol.isEmpty) return false;
    if (order.lots <= 0) return false;
    return true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order_safe_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 469: lib/features/trading/domain/sl_tp_settings.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/sl_tp_settings.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 154.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class SLTPSettings {
  double stopLoss = 0;
  double takeProfit = 0;

  void update(double sl, double tp) {
    stopLoss = sl;
    takeProfit = tp;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/sl_tp_settings.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 470: lib/features/trading/domain/hedging/hedge_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/hedging/hedge_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 122.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class HedgeManager {
  bool shouldHedge(double exposure, double threshold) {
    return exposure.abs() > threshold;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/hedging/hedge_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 471: lib/features/trading/domain/usecases/place_order_usecase.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/usecases/place_order_usecase.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 230.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import '../interface/trading_engine.dart';
import '../order/order.dart';

class PlaceOrderUseCase {
  final TradingEngine engine;

  PlaceOrderUseCase(this.engine);

  Future<Order> call(Order order) => engine.sendOrder(order);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/usecases/place_order_usecase.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 472: lib/features/trading/domain/interface/trading_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/interface/trading_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 170.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import '../order/order.dart';

abstract class TradingEngine {
  Future<Order> sendOrder(Order order);
  void cancelOrder(String orderId);
  List<Order> activeOrders();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/interface/trading_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 473: lib/features/trading/domain/history/trade_history.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/history/trade_history.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 161.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class TradeHistory {
  final List<String> events = [];

  void log(String event) {
    events.add("${DateTime.now().toUtc().toIso8601String()} | $event");
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/history/trade_history.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 474: lib/features/trading/domain/history/trade_history_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/history/trade_history_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 250.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import '../order/order.dart';
import '../../../../../core/storage/audit/event_audit_manager3.dart';

class TradeHistoryFix {
  static void recordUpdate(Order order, String note) {
    EventAuditManager3.log("TradeUpdate: ${order.id} | $note");
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/history/trade_history_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 475: lib/features/trading/domain/models/order.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/models/order.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 47
================================================================================

import 'package:equatable/equatable.dart';

enum OrderType { market, limit, stop }

class Order extends Equatable {
  final String instrument;
  final OrderType type;
  final int units;
  final double? price;
  final double? stopLoss;
  final double? takeProfit;

  const Order({
    required this.instrument,
    required this.type,
    required this.units,
    this.price,
    this.stopLoss,
    this.takeProfit,
  });

  Map<String, dynamic> toOandaPayload() {
    final base = {
      "instrument": instrument,
      "units": units.toString(),
      "type": type.name.toUpperCase(),
    };

    if (type == OrderType.limit && price != null) {
      base["price"] = price.toString();
    }

    if (stopLoss != null) {
      base["stopLossOnFill"] = {"price": stopLoss.toString()};
    }

    if (takeProfit != null) {
      base["takeProfitOnFill"] = {"price": takeProfit.toString()};
    }

    return {"order": base};
  }

  @override
  List<Object?> get props =>
      [instrument, type, units, price, stopLoss, takeProfit];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/models/order.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 476: lib/features/trading/domain/errors/execution_error.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/errors/execution_error.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 240.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

enum ExecutionErrorType {
  network,
  insufficientMargin,
  rejectedByBroker,
  timeout,
}

class ExecutionError implements Exception {
  final ExecutionErrorType type;
  final String message;

  ExecutionError(this.type, this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/errors/execution_error.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 477: lib/features/trading/domain/simulation/sim_order_ring_buffer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/simulation/sim_order_ring_buffer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 345.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

class SimOrderRingBuffer<T> {
  final int capacity;
  final List<T> _vals = [];
  int _idx = 0;

  SimOrderRingBuffer(this.capacity);

  void add(T val) {
    if (_vals.length < capacity) {
      _vals.add(val);
    } else {
      _vals[_idx] = val;
      _idx = (_idx + 1) % capacity;
    }
  }

  List<T> list() => List.unmodifiable(_vals);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/simulation/sim_order_ring_buffer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 478: lib/features/trading/domain/risk/position_sizing.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/risk/position_sizing.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 260.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

double calculateLotSize({
  required double riskPercent,
  required double accountBalance,
  required double stopLossPips,
  required double pipValue,
}) {
  final riskAmt = accountBalance * (riskPercent / 100);
  return riskAmt / (stopLossPips * pipValue);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/risk/position_sizing.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 479: lib/features/trading/domain/execution/execution_snapshot_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/execution/execution_snapshot_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 318.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import '../../../../../core/state/shared/price_volume_state.dart';

class ExecutionSnapshotGuard {
  final PriceVolumeState _stateHolder;

  ExecutionSnapshotGuard(this._stateHolder);

  Map<String, double> snapshot() {
    return {
      "price": _stateHolder.price,
      "volume": _stateHolder.volume,
    };
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/execution/execution_snapshot_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 480: lib/features/trading/domain/execution/execution_queue.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/execution/execution_queue.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 297.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:async';

class ExecutionQueue {
  final _queue = StreamController<Function()>();

  ExecutionQueue() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  void schedule(Function() exec) => _queue.add(exec);

  Future<void> dispose() => _queue.close();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/execution/execution_queue.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 481: lib/features/trading/domain/execution/slippage_guard.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/execution/slippage_guard.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 253.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class SlippageGuard {
  final double maxSlippage; 

  SlippageGuard(this.maxSlippage);

  double apply(double price, double slippagePct) {
    final change = price * (slippagePct / 100);
    return price + change.clamp(-maxSlippage, maxSlippage);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/execution/slippage_guard.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 482: lib/features/trading/domain/audit/reject_logger.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/audit/reject_logger.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 194.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class RejectLogger {
  final List<String> rejected = [];

  void log(String orderId, String reason) {
    rejected.add("${DateTime.now().toUtc().toIso8601String()} | $orderId | $reason");
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/audit/reject_logger.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 483: lib/features/trading/domain/order/order.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/order.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 720.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 30
================================================================================

enum OrderStatus { pending, partiallyFilled, filled, rejected }

class Order {
  final String id;
  final String symbol;
  final double requestedLots;
  double filledLots;
  final double price;
  final DateTime createdAt;
  DateTime? executedAt;
  OrderStatus status;

  Order({
    required this.id,
    required this.symbol,
    required this.requestedLots,
    required this.filledLots,
    required this.price,
    DateTime? createdAt,
    this.executedAt,
    this.status = OrderStatus.pending,
  }) : createdAt = createdAt ?? DateTime.now().toUtc();

  double get remainingLots => requestedLots - filledLots;

  void markExecuted() {
    executedAt = DateTime.now().toUtc();
    status = OrderStatus.filled;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/order.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 484: lib/features/trading/domain/order/partial_execution_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/partial_execution_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 296.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:math';
import 'order.dart';

class PartialExecutionEngine {
  final Random _rng = Random();

  Order execute(Order order) {
    // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ†ÙÙŠØ° Ø¬Ø²Ø¦ÙŠ
    final fill = order.requestedLots * (0.5 + _rng.nextDouble() * 0.5);

    order.fill(fill);
    return order;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/partial_execution_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 485: lib/features/trading/domain/order/retriable_execution_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/retriable_execution_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 752.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import 'dart:async';
import '../errors/execution_error.dart';
import 'order.dart';

class RetriableExecutionEngine {
  Future<Order> executeWithRetry(
    Order order, {
    int maxRetries = 3,
  }) async {
    int attempt = 0;

    while (attempt < maxRetries) {
      try {
        // Ù‡Ù†Ø§ Ù…ÙƒØ§Ù† Ø±Ø¨Ø· Ø§Ù„Ù€ API Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
        if (attempt == 0) throw ExecutionError(ExecutionErrorType.network, "Timeout");

        order.status = OrderStatus.filled;
        return order;
      } catch (e) {
        attempt++;
        if (attempt >= maxRetries) rethrow;
        await Future.delayed(Duration(milliseconds: 500 * attempt));
      }
    }
    throw ExecutionError(ExecutionErrorType.timeout, "Max retries exceeded");
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/retriable_execution_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 486: lib/features/trading/domain/order/oco_execution_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/oco_execution_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 133.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

import 'oco_order.dart';

class OCOExecutionEngine {
  void submit(OCOOrder oco) {
    // if primary fills -> cancel secondary
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/oco_execution_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 487: lib/features/trading/domain/order/oco_order.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/oco_order.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 126.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

class OCOOrder {
  final AdvancedOrder primary;
  final AdvancedOrder secondary;

  OCOOrder(this.primary, this.secondary);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/oco_order.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 488: lib/features/trading/domain/order/advanced_order.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/advanced_order.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 385.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

enum OrderType { market, limit, stop, stopLimit }

class AdvancedOrder {
  final String id;
  final String symbol;
  final OrderType type;
  final double price;
  final double stopPrice;
  final double lots;

  AdvancedOrder({
    required this.id,
    required this.symbol,
    this.type = OrderType.market,
    this.price = 0,
    this.stopPrice = 0,
    required this.lots,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/advanced_order.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 489: lib/features/trading/domain/order/fee_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/fee_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 219.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

class FeeModel {
  final double commissionPerLot;
  final double spreadCost;

  FeeModel(this.commissionPerLot, this.spreadCost);

  double totalCost(double lots) =>
      commissionPerLot * lots + spreadCost * lots;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/fee_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 490: lib/features/trading/domain/order/execution_with_fees.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/domain/order/execution_with_fees.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 263.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'fee_model.dart';
import 'order.dart';

class ExecutionWithFees {
  final FeeModel feeModel;

  ExecutionWithFees(this.feeModel);

  double netPnL(double grossPnL, double lots) {
    final cost = feeModel.totalCost(lots);
    return grossPnL - cost;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/domain/order/execution_with_fees.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 491: lib/features/trading/data/sl_tp_storage_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/data/sl_tp_storage_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 709.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class SLTPStorageFix {
  static Future<void> save(String symbol, double sl, double tp) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(
      'sl_tp_$symbol',
      jsonEncode({'sl': sl, 'tp': tp}),
    );
  }

  static Future<Map<String, double>?> load(String symbol) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString('sl_tp_$symbol');
    if (str == null) return null;
    final map = jsonDecode(str) as Map<String, dynamic>;
    return {
      'sl': (map['sl'] as num).toDouble(),
      'tp': (map['tp'] as num).toDouble(),
    };
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/data/sl_tp_storage_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 492: lib/features/trading/data/oanda_trade_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/data/oanda_trade_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 61
================================================================================

import 'dart:convert';
import 'package:http/http.dart' as http;
import '../../../core/network/oanda/oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaTradeClient {
  Future<http.Response> _post(String url, dynamic body) async {
    final token = await SecureStorageManager.readOandaToken();
    final headers = {
      "Authorization": "Bearer \$token",
      "Content-Type": "application/json",
    };
    return http.post(Uri.parse(url), headers: headers, body: jsonEncode(body));
  }

  Future<bool> marketOrder({
    required String instrument,
    required int units,
    double? stopLoss,
    double? takeProfit,
  }) async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/accounts/\$accountId/orders";
    final order = {
      "order": {
        "instrument": instrument,
        "units": units.toString(),
        "type": "MARKET",
        if (stopLoss != null)
          "stopLossOnFill": {"price": stopLoss.toString()},
        if (takeProfit != null)
          "takeProfitOnFill": {"price": takeProfit.toString()},
      }
    };

    final res = await _post(url, order);
    return res.statusCode == 201;
  }

  Future<bool> limitOrder({
    required String instrument,
    required int units,
    required double price,
  }) async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/accounts/\$accountId/orders";
    final order = {
      "order": {
        "instrument": instrument,
        "units": units.toString(),
        "price": price.toString(),
        "type": "LIMIT",
      }
    };

    final res = await _post(url, order);
    return res.statusCode == 201;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/data/oanda_trade_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 493: lib/features/trading/data/exchanges/crypto/crypto_api.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/data/exchanges/crypto/crypto_api.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 278.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../core/network/rest_client.dart';

class CryptoApi {
  final RestClient client;

  CryptoApi(this.client);

  Future<double> fetchPrice(String symbol) async {
    final res = await client.get("/crypto/$symbol/price");
    return double.parse(res['price']);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/data/exchanges/crypto/crypto_api.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 494: lib/features/trading/data/exchanges/stock/stock_api.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/trading/data/exchanges/stock/stock_api.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 276.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../core/network/rest_client.dart';

class StockApi {
  final RestClient client;

  StockApi(this.client);

  Future<double> fetchQuote(String symbol) async {
    final res = await client.get("/stocks/$symbol/quote");
    return double.parse(res['quote']);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/trading/data/exchanges/stock/stock_api.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 495: lib/features/market/data/candle_normalizer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/candle_normalizer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 790.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import '../../../market/domain/entities/candle.dart';

class CandleNormalizer {
  static List<CandleEntity> fillGaps(List<CandleEntity> input, Duration interval) {
    if (input.isEmpty) return [];
    List<CandleEntity> output = [];
    DateTime curr = input.first.time;

    final end = input.last.time;

    int idx = 0;
    while (curr.isBefore(end)) {
      if (idx < input.length && input[idx].time == curr) {
        output.add(input[idx]);
        idx++;
      } else {
        final prev = output.isNotEmpty ? output.last.close : 0;
        output.add(CandleEntity(
          time: curr,
          open: prev,
          high: prev,
          low: prev,
          close: prev,
          volume: 0,
        ));
      }
      curr = curr.add(interval);
    }
    return output;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/candle_normalizer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 496: lib/features/market/data/tick_aggregator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/tick_aggregator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 61
================================================================================

import '../../../market/domain/entities/candle.dart';
import '../../../market/domain/entities/tick.dart';

class CandleAggregator {
  final Duration interval;
  final List<CandleEntity> result = [];
  DateTime? currentStart;
  CandleEntity? current;

  List<Tick> buffer = [];

  CandleAggregator(this.interval);

  void processTick(Tick tick) {
    buffer.add(tick);
    buffer.sort((a, b) => a.time.compareTo(b.time));

    final start = _alignToInterval(buffer.first.time);

    if (currentStart == null) {
      currentStart = start;
      current = CandleEntity(
        time: start,
        open: buffer.first.price,
        high: buffer.first.price,
        low: buffer.first.price,
        close: buffer.first.price,
        volume: 0,
      );
    }

    while (buffer.isNotEmpty) {
      final t = buffer.removeAt(0);

      if (t.time.isBefore(currentStart!.add(interval))) {
        current!.high = max(current!.high, t.price);
        current!.low = min(current!.low, t.price);
        current!.close = t.price;
        current!.volume += 1;
      } else {
        result.add(current!);
        currentStart = _alignToInterval(t.time);
        current = CandleEntity(
          time: currentStart!,
          open: t.price,
          high: t.price,
          low: t.price,
          close: t.price,
          volume: 1,
        );
      }
    }
  }

  DateTime _alignToInterval(DateTime t) {
    final millis = t.millisecondsSinceEpoch;
    final intInterval = interval.inMilliseconds;
    final startMillis = (millis ~/ intInterval) * intInterval;
    return DateTime.fromMillisecondsSinceEpoch(startMillis);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/tick_aggregator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 497: lib/features/market/data/oanda_market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/oanda_market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 640.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import '../../../../core/network/oanda/client/oanda_rest_client.dart';
import '../../../../core/network/oanda/stream/oanda_ws_client.dart';

class OandaMarketRepository {
  final OandaRestClient _rest = OandaRestClient();
  final OandaWSClient _ws = OandaWSClient();

  Future<List<String>> getInstruments() => _rest.fetchInstruments();

  Future<List<Map<String, dynamic>>> getCandles(
          String symbol, String timeframe) =>
      _rest.fetchCandles(symbol, timeframe);

  void subscribePricing(String symbol, void Function(dynamic) onData) {
    _ws.connect(symbol, onData);
  }

  void unsubscribe() {
    _ws.disconnect();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/oanda_market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 498: lib/features/market/data/market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 45
================================================================================

import '../../domain/models/candle.dart';
import '../../domain/models/instrument.dart';
import '../../../core/network/rest/rest_client.dart';
import '../../../core/storage/cache/cache_manager.dart';

class MarketRepository {
  final RestClient _client = RestClient();
  final CacheManager _cache = CacheManager.instance;

  Future<List<Instrument>> getInstrumentsCached(
      String accountId) async {
    final key = "instruments_\$accountId";
    final fromCache = await _cache.getInstruments(key);
    if (fromCache != null) {
      return fromCache.cast<Instrument>();
    }

    final data =
        await _client.get("/accounts/\$accountId/instruments");
    final list = (data["instruments"] as List)
        .map((e) => Instrument.fromRest(e))
        .toList();

    await _cache.setInstruments(key, list);
    return list;
  }

  Future<List<Candle>> getCandlesCached(
      String accountId, String instrument, String granularity) async {
    final key = "candles_\$accountId_\$instrument_\$granularity";
    final fromCache = await _cache.getSymbols(key);
    if (fromCache != null) {
      return fromCache.cast<Candle>();
    }

    final raw = await _client.get(
        "/accounts/\$accountId/instruments/\$instrument/candles?granularity=\$granularity&count=500");
    final list = (raw["candles"] as List)
        .map((e) => Candle.fromRestJson(e))
        .toList();

    await _cache.setSymbols(key, list);
    return list;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 499: lib/features/market/data/stream/live_stream_adapter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/stream/live_stream_adapter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 51
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../../../../core/network/ws/transport/ws_transport.dart';
import '../dtos/ws_tick_dto.dart';
import 'mappers/ws_tick_mapper.dart';
import '../../../../core/network/ws/pipeline/ws_pipeline.dart';

class LiveStreamAdapter {
  final WsTransport _transport;
  final WsPipeline<Map<String, dynamic>> _pipeline;

  Stream<Map<String, dynamic>> get stream => _pipeline.stream!;

  LiveStreamAdapter(this._transport)
      : _pipeline = WsPipeline<Map<String, dynamic>>();

  Future<void> connect({
    required String accountId,
    required String instruments,
    required Map<String, String> headers,
  }) async {
    await _transport.connect(
      accountId: accountId,
      instruments: instruments,
      headers: headers,
      onData: (raw) {
        try {
          final json = raw as Map<String, dynamic>;
          final dto = WsTickDTO.fromJson(json);
          if (dto.type == "PRICE") {
            final candle = WsTickMapper.toCandle(dto);
            _pipeline.push({
              "time": candle.time.toIso8601String(),
              "open": candle.open,
              "high": candle.high,
              "low": candle.low,
              "close": candle.close,
            });
          }
        } catch (_) {
          // ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ Parsing
        }
      },
    );
  }

  void disconnect() {
    _transport.disconnect();
    _pipeline.dispose();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/stream/live_stream_adapter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 500: lib/features/market/data/stream/repositories/oanda_stream_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/stream/repositories/oanda_stream_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 693.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import '../../../../core/settings/token_storage.dart';
import '../../domain/stream/stream_repository.dart';
import '../live_stream_adapter.dart';

class OandaStreamRepository implements StreamRepository {
  final LiveStreamAdapter _adapter;
  OandaStreamRepository(this._adapter);

  @override
  Stream<Map<String, dynamic>> ticks() => _adapter.stream;

  @override
  Future<void> start({
    required String accountId,
    required String instruments,
    required Map<String, String> headers,
  }) async {
    await _adapter.connect(
      accountId: accountId,
      instruments: instruments,
      headers: headers,
    );
  }

  @override
  void stop() {
    _adapter.disconnect();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/stream/repositories/oanda_stream_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 501: lib/features/market/data/stream/mappers/ws_tick_mapper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/stream/mappers/ws_tick_mapper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 599.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import '../../domain/entities/candle.dart';
import '../dtos/ws_tick_dto.dart';

class WsTickMapper {
  /// ØªØ­ÙˆÙŠÙ„ Tick Ø¥Ù„Ù‰ Candle Ù„Ø­Ø¸ÙŠ
  static Candle toCandle(WsTickDTO dto) {
    final bidPrice = dto.bids?.first["price"] ?? 0;
    final askPrice = dto.asks?.first["price"] ?? 0;

    final mid = ((double.parse(bidPrice.toString()) +
                double.parse(askPrice.toString())) /
            2);

    final date = DateTime.parse(dto.time);

    return Candle(
      time: date,
      open: mid,
      high: mid,
      low: mid,
      close: mid,
      volume: null,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/stream/mappers/ws_tick_mapper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 502: lib/features/market/data/stream/dtos/ws_tick_dto.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/stream/dtos/ws_tick_dto.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 471.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

class WsTickDTO {
  final String type;
  final String time;
  final List<dynamic>? bids;
  final List<dynamic>? asks;

  WsTickDTO({
    required this.type,
    required this.time,
    this.bids,
    this.asks,
  });

  factory WsTickDTO.fromJson(Map<String, dynamic> json) {
    return WsTickDTO(
      type: json["type"] as String,
      time: json["time"] as String,
      bids: json["bids"] as List<dynamic>?,
      asks: json["asks"] as List<dynamic>?,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/stream/dtos/ws_tick_dto.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 503: lib/features/market/data/repositories/oanda_market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repositories/oanda_market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

import '../../../../core/network/http/rest_client.dart';
import '../../domain/entities/candle.dart';
import '../../domain/entities/instrument.dart';
import '../../domain/repositories/market_repository.dart';
import '../dtos/candle_dto.dart';
import '../dtos/instrument_dto.dart';
import '../mappers/candle_mapper.dart';
import '../mappers/instrument_mapper.dart';

class OandaMarketRepository implements MarketRepository {
  final RestClient _client;

  OandaMarketRepository(this._client);

  @override
  Future<List<Candle>> fetchHistoricalCandles(
      String accountId, String instrument, String timeframe) async {
    final path =
        "/accounts/\$accountId/instruments/\$instrument/candles?granularity=\$timeframe&count=500";
    final res = await _client.get(path);

    final List list = res["candles"] as List;
    return list
        .map((e) => CandleMapper.fromDto(
            CandleDTO.fromJson(e as Map<String, dynamic>)))
        .toList();
  }

  @override
  Future<List<Instrument>> fetchInstruments(String accountId) async {
    final path = "/accounts/\$accountId/instruments";
    final res = await _client.get(path);

    final List list = res["instruments"] as List;
    return list
        .map((e) => InstrumentMapper.fromDto(
            InstrumentDTO.fromJson(e as Map<String, dynamic>)))
        .toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repositories/oanda_market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 504: lib/features/market/data/repositories/market_repository_impl.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repositories/market_repository_impl.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 4.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 152
================================================================================

import 'dart:async';

import '../../domain/entities/candle.dart';
import '../../domain/entities/tick.dart';
import '../../domain/repositories/market_repository.dart';

import '../datasources/oanda_rest_client.dart';
import '../datasources/oanda_ws_client.dart';
import '../datasources/local_storage.dart';
import '../models/candle_model.dart';
import '../models/candle_entity_mapper.dart';
import '../models/tick_model.dart';

class MarketRepositoryImpl implements MarketRepository {
  final LocalStorage localStorage;

  OandaRestClient? _restClient;
  OandaWebSocketClient? _wsClient;

  MarketRepositoryImpl({required this.localStorage});

  Future<void> _initClients() async {
    final token = localStorage.getOandaToken();
    final account = localStorage.getOandaAccountId();

    if (token == null || account == null) {
      throw Exception("OANDA credentials not found");
    }

    _restClient = OandaRestClient(token);
  }

  @override
  Future<void> saveOandaCredentials({required String token, required String accountId}) async {
    await localStorage.saveOandaToken(token);
    await localStorage.saveOandaAccountId(accountId);
  }

  @override
  Future<Map<String, String>> getOandaCredentials() async {
    final token = localStorage.getOandaToken();
    final account = localStorage.getOandaAccountId();
    if (token == null || account == null) throw Exception("Credentials missing");
    return {"token": token, "accountId": account};
  }

  @override
  Future<Map<String, dynamic>> fetchAccountDetails() async {
    await _initClients();
    final account = localStorage.getOandaAccountId()!;
    final response = await _restClient!.dio.get("/accounts/$account");
    return response.data;
  }

  @override
  Future<List<CandleEntity>> fetchHistoricalCandles(
      String instrument, String granularity, int count) async {
    await _initClients();
    final resp = await _restClient!.getCandles(
      instrument: instrument,
      granularity: granularity,
      count: count,
    );

    final List<CandleEntity> list = [];
    final data = resp.data["candles"] as List;

    for (var item in data) {
      if (item["complete"] == true) {
        final candle = CandleModel(
          time: DateTime.parse(item["time"]),
          open: double.parse(item["mid"]["o"]),
          high: double.parse(item["mid"]["h"]),
          low: double.parse(item["mid"]["l"]),
          close: double.parse(item["mid"]["c"]),
          volume: item["volume"],
        );
        list.add(candle.toEntity());
      }
    }
    return list;
  }

  @override
  Future<List<String>> fetchAvailableInstruments() async {
    await _initClients();
    final account = localStorage.getOandaAccountId()!;
    final resp = await _restClient!.getInstruments(account);

    final data = resp.data["instruments"] as List;
    return data.map((item) => item["name"].toString()).toList();
  }

  @override
  Stream<TickEntity> streamTicks(String instrument) {
    final token = localStorage.getOandaToken()!;
    final account = localStorage.getOandaAccountId()!;
    _wsClient = OandaWebSocketClient(
      token: token,
      accountId: account,
      instrument: instrument,
    );

    return _wsClient!.stream
      .where((json) => json.containsKey("bids") && json.containsKey("asks"))
      .map((json) {
        final model = TickModel.fromJson(json);
        return model.toEntity();
      });
  }
}

  @override
  Future<List<CandleModel>> getHistoricalCandlesPage({
    required String symbol,
    required String timeframe,
    required int count,
    DateTime? to,
  }) async {
    final params = {
      "instrument": symbol,
      "granularity": timeframe,
      "count": count.toString(),
      if (to != null) "to": to.toUtc().toIso8601String(),
    };

    final response = await _restClient!.getCandles(params);

    return response;
  }

  @override
  Future<Map<String, dynamic>> executeOrder(OrderRequest request) async {
    final body = request.toJson();
    final res = await _restClient!.placeOrder(body);
    return res;
  }

  @override
  Future<Map<String, dynamic>> getOpenPositions() async {
    return await _restClient!.fetchOpenPositions();
  }

  @override
  Future<Map<String, dynamic>> closePosition(String instrument) async {
    return await _restClient!.closePosition(instrument);
  }

  @override
  Future<Map<String, dynamic>> modifyPosition(String instrument, Map<String, dynamic> body) async {
    return await _restClient!.modifyPosition(instrument, body);
  }

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repositories/market_repository_impl.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 505: lib/features/market/data/repositories/market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repositories/market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 211.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import '../../domain/repositories/market_repository.dart';

class MarketRepositoryImpl extends MarketRepository {
  @override
  Future<List<String>> getMarkets() async {
    return ['EUR/USD', 'BTC/USD'];
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repositories/market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 506: lib/features/market/data/repositories/audit/audit_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repositories/audit/audit_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 576.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:hive/hive.dart';
import '../../../domain/audit/audit_log.dart';

class AuditRepository {
  static const String _boxName = "audit_logs";

  Future<void> init() async {
    await Hive.openBox<AuditLog>(_boxName);
  }

  Future<void> addLog(AuditLog log) async {
    final box = Hive.box<AuditLog>(_boxName);
    await box.add(log);
  }

  List<AuditLog> getAllLogs() {
    final box = Hive.box<AuditLog>(_boxName);
    return box.values.toList();
  }

  Future<void> clearLogs() async {
    final box = Hive.box<AuditLog>(_boxName);
    await box.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repositories/audit/audit_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 507: lib/features/market/data/datasources/timeframe_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/datasources/timeframe_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 407.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class TimeframeStorage {
  static final _storage = FlutterSecureStorage();
  static const _key = "last_selected_timeframe";

  static Future<void> save(String tf) async {
    await _storage.write(key: _key, value: tf);
  }

  static Future<String> load() async {
    final v = await _storage.read(key: _key);
    return v ?? "M1";
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/datasources/timeframe_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 508: lib/features/market/data/datasources/oanda_ws_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/datasources/oanda_ws_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 77
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class OandaWebSocketManager {
  final String token;
  final String accountId;
  final String instrument;

  WebSocketChannel? _channel;
  StreamController<Map<String, dynamic>> _controller =
      StreamController.broadcast();

  Timer? _heartbeat;

  OandaWebSocketManager({
    required this.token,
    required this.accountId,
    required this.instrument,
  });

  Stream<Map<String, dynamic>> get stream => _controller.stream;

  void connect() {
    final uri = Uri(
      scheme: "wss",
      host: "stream-fxpractice.oanda.com",
      path: "/v3/pricing/stream",
      queryParameters: {"instruments": instrument},
    );

    _channel = WebSocketChannel.connect(uri, headers: {
      "Authorization": "Bearer $token",
    });

    _channel?.stream.listen(
      (msg) {
        try {
          final json = msg is String ? jsonDecode(msg) : {};
          _controller.add(json);
        } catch (_) {}
      },
      onError: _onError,
      onDone: _onDone,
    );

    _startHeartbeat();
  }

  void _startHeartbeat() {
    _heartbeat?.cancel();
    _heartbeat = Timer.periodic(Duration(seconds: 15), (_) {
      _channel?.sink.add("ping");
    });
  }

  void _onError(error) {
    disconnect();
    Future.delayed(Duration(seconds: 5), connect);
  }

  void _onDone() {
    disconnect();
    Future.delayed(Duration(seconds: 5), connect);
  }

  void disconnect() {
    _heartbeat?.cancel();
    _channel?.sink.close();
    _channel = null;
  }
}

  Future<void> connectWithTimeframe(String tf) async {
    currentTimeframe = tf;
    disconnect();
    connect();
  }

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/datasources/oanda_ws_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 509: lib/features/market/data/datasources/candles_cache.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/datasources/candles_cache.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 554.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:hive/hive.dart';
import '../models/candle_model.dart';

class CandlesCache {
  final Box<CandleModel> _box = Hive.box<CandleModel>('candles');

  Future<void> cacheCandles(String key, List<CandleModel> candles) async {
    await _box.put(key, candles.map((c) => c.toJson()).toList());
  }

  List<CandleModel>? getCachedCandles(String key) {
    final list = _box.get(key);
    if (list == null) return null;
    return (list as List)
        .map((json) => CandleModel.fromJson(Map<String, dynamic>.from(json)))
        .toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/datasources/candles_cache.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 510: lib/features/market/data/datasources/local_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/datasources/local_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 504.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import '../../../core/utils/secure_storage.dart';

class LocalStorage {
  Future<void> saveOandaCredentials({
    required String apiToken,
    required String accountId,
  }) async {
    await SecureStorage.saveCredentials(
      apiToken: apiToken,
      accountId: accountId,
    );
  }

  Future<Map<String, String>?> getOandaCredentials() async {
    return await SecureStorage.readCredentials();
  }

  Future<void> clearOandaCredentials() async {
    await SecureStorage.clearCredentials();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/datasources/local_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 511: lib/features/market/data/datasources/oanda_ws_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/datasources/oanda_ws_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 858.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import 'dart:convert';
import 'package:web_socket_channel/web_socket_channel.dart';

class OandaWebSocketClient {
  final WebSocketChannel _channel;

  OandaWebSocketClient._(this._channel);

  factory OandaWebSocketClient({
    required String token,
    required String accountId,
    required String instrument,
  }) {
    final streamEndpoint = Uri(
      scheme: "wss",
      host: "stream-fxpractice.oanda.com",
      path: "/v3/pricing/stream",
      queryParameters: {
        "instruments": instrument,
      },
    );

    final ws = WebSocketChannel.connect(
      streamEndpoint,
      headers: {
        "Authorization": "Bearer $token",
      },
    );

    return OandaWebSocketClient._(ws);
  }

  Stream<Map<String, dynamic>> get stream =>
      _channel.stream.map((event) => jsonDecode(event));

  void close() => _channel.sink.close();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/datasources/oanda_ws_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 512: lib/features/market/data/datasources/oanda_rest_client.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/datasources/oanda_rest_client.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 746.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 34
================================================================================

import 'package:dio/dio.dart';

class OandaRestClient {
  Dio dio;

  OandaRestClient(String token) : dio = Dio(
    BaseOptions(
      baseUrl: "https://api-fxpractice.oanda.com/v3",
      headers: {
        "Authorization": "Bearer $token",
        "Content-Type": "application/json"
      }
    ),
  );

  Future<Response> getInstruments(String accountId) async {
    return dio.get("/accounts/$accountId/instruments");
  }

  Future<Response> getCandles({
    required String instrument,
    required String granularity,
    required int count,
  }) {
    return dio.get(
      "/instruments/$instrument/candles",
      queryParameters: {
        "granularity": granularity,
        "count": count,
        "price": "M",
      }
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/datasources/oanda_rest_client.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 513: lib/features/market/data/cache/history_cache_by_tf.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/cache/history_cache_by_tf.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 461.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../../../../core/models/candle_entity.dart';

class HistoryCacheByTimeframe {
  final Map<String, List<CandleEntity>> _cache = {};

  void save(String symbol, String timeframe, List<CandleEntity> data) {
    _cache["$symbol-$timeframe"] = data;
  }

  List<CandleEntity>? load(String symbol, String timeframe) {
    return _cache["$symbol-$timeframe"];
  }

  void clear(String symbol, String timeframe) {
    _cache.remove("$symbol-$timeframe");
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/cache/history_cache_by_tf.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 514: lib/features/market/data/cache/candle_cache_cleaner.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/cache/candle_cache_cleaner.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 314.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../core/models/candle_entity.dart';

class CandleCacheCleaner {
  final int maxSize;

  CandleCacheCleaner({this.maxSize = 1000});

  List<CandleEntity> clean(List<CandleEntity> candles) {
    if (candles.length <= maxSize) return candles;
    return candles.sublist(candles.length - maxSize);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/cache/candle_cache_cleaner.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 515: lib/features/market/data/cache/tick_buffer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/cache/tick_buffer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 271.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import '../../../core/models/tick_entity.dart';

class TickBuffer {
  final List<TickEntity> buffer = [];

  void add(TickEntity t) => buffer.add(t);

  List<TickEntity> flush() {
    final copy = List<TickEntity>.from(buffer);
    buffer.clear();
    return copy;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/cache/tick_buffer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 516: lib/features/market/data/storage/export_utils.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/storage/export_utils.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 34
================================================================================

import 'dart:io';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import '../../domain/backtest/backtest_result.dart';

class ExportUtils {
  // Ø­ÙØ¸ ÙƒÙ€ JSON
  static Future<String> exportBacktestJSON(BacktestResult result) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File("${dir.path}/backtest_result.json");
    await file.writeAsString(result.toJson());
    return file.path;
  }

  // Ø­ÙØ¸ ÙƒÙ€ CSV
  static Future<String> exportBacktestCSV(BacktestResult result) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File("${dir.path}/backtest_result.csv");
    final buffer = StringBuffer();

    buffer.writeln("Time,Equity");
    for (int i = 0; i < result.timestamps.length; i++) {
      buffer.writeln(
          "${result.timestamps[i].toIso8601String()},${result.equityCurve[i]}");
    }

    await file.writeAsString(buffer.toString());
    return file.path;
  }

  static Future<void> shareFile(String path) async {
    await Share.shareFiles([path]);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/storage/export_utils.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 517: lib/features/market/data/storage/strategy_settings.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/storage/strategy_settings.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 41
================================================================================

class StrategySettings {
  int emaShort;
  int emaLong;
  int stochKPeriod;
  int stochSmoothK;
  int stochSmoothD;
  double stopLossPercent;
  double takeProfitPercent;

  StrategySettings({
    required this.emaShort,
    required this.emaLong,
    required this.stochKPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
    required this.stopLossPercent,
    required this.takeProfitPercent,
  });

  Map<String, dynamic> toJson() => {
        "emaShort": emaShort,
        "emaLong": emaLong,
        "stochKPeriod": stochKPeriod,
        "stochSmoothK": stochSmoothK,
        "stochSmoothD": stochSmoothD,
        "stopLossPercent": stopLossPercent,
        "takeProfitPercent": takeProfitPercent,
      };

  factory StrategySettings.fromJson(Map<String, dynamic> json) {
    return StrategySettings(
      emaShort: json["emaShort"],
      emaLong: json["emaLong"],
      stochKPeriod: json["stochKPeriod"],
      stochSmoothK: json["stochSmoothK"],
      stochSmoothD: json["stochSmoothD"],
      stopLossPercent: json["stopLossPercent"],
      takeProfitPercent: json["takeProfitPercent"],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/storage/strategy_settings.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 518: lib/features/market/data/storage/settings_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/storage/settings_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 473.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:hive/hive.dart';
import 'strategy_settings.dart';

class SettingsStorage {
  final Box _box = Hive.box('settings');

  Future<void> saveStrategySettings(StrategySettings settings) async {
    await _box.put('strategy_settings', settings.toJson());
  }

  StrategySettings? getStrategySettings() {
    final json = _box.get('strategy_settings');
    if (json == null) return null;
    return StrategySettings.fromJson(Map<String, dynamic>.from(json));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/storage/settings_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 519: lib/features/market/data/models/tick_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/models/tick_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 732.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 35
================================================================================

import '../../domain/entities/tick.dart';

class TickModel {
  final DateTime time;
  final double bid;
  final double ask;

  TickModel({
    required this.time,
    required this.bid,
    required this.ask,
  });

  factory TickModel.fromJson(Map<String, dynamic> json) {
    // OANDA stream sends "tick" messages with bid/ask
    final time = DateTime.parse(json["time"]);
    final bids = json["bids"];
    final asks = json["asks"];

    double bidPrice = double.parse(bids[0]["price"]);
    double askPrice = double.parse(asks[0]["price"]);

    return TickModel(
      time: time,
      bid: bidPrice,
      ask: askPrice,
    );
  }

  TickEntity toEntity() => TickEntity(
    time: time,
    bid: bid,
    ask: ask,
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/models/tick_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 520: lib/features/market/data/models/candle_entity_mapper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/models/candle_entity_mapper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 287.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../domain/entities/candle.dart';
import 'candle_model.dart';

extension ToEntity on CandleModel {
  CandleEntity toEntity() {
    return CandleEntity(
      time: time,
      open: open,
      high: high,
      low: low,
      close: close,
      volume: volume,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/models/candle_entity_mapper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 521: lib/features/market/data/models/candle_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/models/candle_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 739.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 38
================================================================================

import 'package:hive/hive.dart';
import 'package:json_annotation/json_annotation.dart';

part 'candle_model.g.dart';

@HiveType(typeId: 1)
@JsonSerializable()
class CandleModel {
  @HiveField(0)
  final DateTime time;

  @HiveField(1)
  final double open;
  
  @HiveField(2)
  final double high;
  
  @HiveField(3)
  final double low;
  
  @HiveField(4)
  final double close;
  
  @HiveField(5)
  final int volume;

  CandleModel({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });

  factory CandleModel.fromJson(Map<String, dynamic> json) => _$CandleModelFromJson(json);
  Map<String, dynamic> toJson() => _$CandleModelToJson(this);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/models/candle_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 522: lib/features/market/data/models/position/position_model.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/models/position/position_model.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 886.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

class PositionModel {
  final String instrument;
  final double units;
  final double unrealizedPL;
  final double averagePrice;
  final double? stopLoss;
  final double? takeProfit;

  PositionModel({
    required this.instrument,
    required this.units,
    required this.unrealizedPL,
    required this.averagePrice,
    this.stopLoss,
    this.takeProfit,
  });

  factory PositionModel.fromJson(Map<String, dynamic> json) {
    return PositionModel(
      instrument: json["instrument"],
      units: double.parse(json["units"].toString()),
      unrealizedPL: double.parse(json["unrealizedPL"].toString()),
      averagePrice: double.parse(json["averagePrice"].toString()),
      stopLoss: json["stopLoss"] != null ? double.parse(json["stopLoss"].toString()) : null,
      takeProfit: json["takeProfit"] != null ? double.parse(json["takeProfit"].toString()) : null,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/models/position/position_model.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 523: lib/features/market/data/streaming/tick_aggregator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/streaming/tick_aggregator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 68
================================================================================

import 'dart:async';

class Tick {
  final double price;
  final DateTime time;

  Tick(this.price, this.time);
}

class Candle {
  final DateTime openTime;
  double open;
  double high;
  double low;
  double close;

  Candle({
    required this.openTime,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });
}

class TickAggregator {
  final Duration timeframe;
  Candle? _currentCandle;
  final _controller = StreamController<Candle>.broadcast();

  TickAggregator(this.timeframe);

  Stream<Candle> get stream => _controller.stream;

  void addTick(Tick tick) {
    final bucket = DateTime(
      tick.time.year,
      tick.time.month,
      tick.time.day,
      tick.time.hour,
      tick.time.minute ~/ timeframe.inMinutes * timeframe.inMinutes,
    );

    if (_currentCandle == null || _currentCandle!.openTime != bucket) {
      if (_currentCandle != null) {
        _controller.add(_currentCandle!);
      }

      _currentCandle = Candle(
        openTime: bucket,
        open: tick.price,
        high: tick.price,
        low: tick.price,
        close: tick.price,
      );
    } else {
      _currentCandle!.high =
          tick.price > _currentCandle!.high ? tick.price : _currentCandle!.high;
      _currentCandle!.low =
          tick.price < _currentCandle!.low ? tick.price : _currentCandle!.low;
      _currentCandle!.close = tick.price;
    }
  }

  void dispose() {
    _controller.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/streaming/tick_aggregator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 524: lib/features/market/data/repository/candle_repository_with_filter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/candle_repository_with_filter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 644.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import '../../../../core/filters/candle_outlier_filter.dart';
import '../../../../core/models/candle_entity.dart';

class CandleRepositoryWithFilter {
  final CandleOutlierFilter filter = CandleOutlierFilter();

  Future<List<CandleEntity>> fetchCandles(String symbol, String timeframe) async {
    // Ù…Ø«Ø§Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† API
    final raw = await getRawCandlesFromApi(symbol, timeframe);

    // Ø§Ù„ØªØµÙÙŠØ©
    final cleaned = raw.where((c) => filter.isValid(c)).toList();

    return cleaned;
  }

  Future<List<CandleEntity>> getRawCandlesFromApi(String symbol, String timeframe) async {
    // Placeholder
    return [];
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/candle_repository_with_filter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 525: lib/features/market/data/repository/timeframe_transition_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/timeframe_transition_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 255.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

Future<void> transitionTF(
    String symbol, String fromTF, String toTF) async {
  await manager.dispose(); // close WS
  final hist = await repo.getCandles(symbol, toTF); // load history
  manager.connectForSymbol(symbol, wsUrl(toTF)); // open new WS
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/timeframe_transition_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 526: lib/features/market/data/repository/history_refresh_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/history_refresh_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 203.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

Future<List<CandleEntity>> refreshHistory(
    String symbol, String timeframe) async {
  await cache.clear();  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  return await repo.getCandles(symbol, timeframe);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/history_refresh_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 527: lib/features/market/data/repository/market_repository_impl.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/market_repository_impl.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 496.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import '../../../domain/repository/market_repository.dart';
import '../../../../core/models/candle_entity.dart';

class MarketRepositoryImpl implements MarketRepository {
  @override
  Future<List<CandleEntity>> getCandles(String symbol, String timeframe) async {
    // Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ø¨Ø± REST
    throw UnimplementedError();
  }

  @override
  Stream<CandleEntity> streamCandles(String symbol, String timeframe) {
    // Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ø¨Ø± WebSocket
    throw UnimplementedError();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/market_repository_impl.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 528: lib/features/market/data/repository/boot_history_restore_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/boot_history_restore_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 351.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../../core/models/candle_entity.dart';
import '../local/candle_dao.dart';

class BootHistoryRestoreFix {
  final CandleDao dao;
  BootHistoryRestoreFix(this.dao);

  Future<List<CandleEntity>> restoreOnBoot(String symbol, String tf) async {
    final cached = await dao.getAll(symbol, tf);
    return cached.isEmpty ? [] : cached;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/boot_history_restore_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 529: lib/features/market/data/repository/market_repository_error_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/market_repository_error_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 379.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../../core/network/error/network_error_handler.dart';
import '../../../../core/network/rest_error.dart';

Future<List<CandleEntity>> safeFetchHistory(...) async {
  try {
    return await _fetchHistory(...);
  } catch (e) {
    final type = NetworkErrorHandler.classify(e);
    final message = NetworkErrorHandler.message(type);
    throw RestError(message);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/market_repository_error_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 530: lib/features/market/data/repository/history_paging.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/history_paging.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 514.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import '../../../../core/models/candle_entity.dart';
import '../../../domain/repository/market_repository.dart';

class HistoryPaging {
  final MarketRepository repo;

  HistoryPaging(this.repo);

  Future<List<CandleEntity>> fetchAll(
      String symbol, String timeframe) async {
    List<CandleEntity> all = [];
    int page = 0;
    while (true) {
      final chunk = await repo.fetchHistoryPage(symbol, timeframe, page++);
      if (chunk.isEmpty) break;
      all.addAll(chunk);
    }
    return all;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/history_paging.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 531: lib/features/market/data/repository/instant_first_candle_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/repository/instant_first_candle_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 303.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import '../../../../core/models/candle_entity.dart';
import '../local/candle_dao.dart';

class InstantFirstCandleFix {
  final CandleDao dao;
  InstantFirstCandleFix(this.dao);

  Future<CandleEntity?> getLastKnown(String symbol, String tf) async {
    return await dao.getLastCandle(symbol, tf);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/repository/instant_first_candle_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 532: lib/features/market/data/trading/virtual_exchange.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/trading/virtual_exchange.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 52
================================================================================

import '../../domain/trading/trade_position.dart';
import '../../domain/entities/candle.dart';
import '../../domain/trading/trade_result.dart';

class VirtualExchange {
  final List<TradePosition> openPositions = [];
  final List<TradeResult> tradeHistory = [];

  void openPosition(TradePosition position) {
    openPositions.add(position);
  }

  void updateWithNewCandle(CandleEntity candle) {
    for (var position in List.of(openPositions)) {
      final currentPrice = candle.close;

      if (position.type == TradeType.BUY) {
        if (currentPrice >= position.takeProfit ||
            currentPrice <= position.stopLoss) {
          _closePosition(position, currentPrice, candle.time);
        }
      }
      if (position.type == TradeType.SELL) {
        if (currentPrice <= position.takeProfit ||
            currentPrice >= position.stopLoss) {
          _closePosition(position, currentPrice, candle.time);
        }
      }
    }
  }

  void _closePosition(
    TradePosition position,
    double exitPrice,
    DateTime exitTime,
  ) {
    double profit = (position.type == TradeType.BUY)
        ? exitPrice - position.entryPrice
        : position.entryPrice - exitPrice;

    final result = TradeResult(
      profit: profit,
      entryPrice: position.entryPrice,
      exitPrice: exitPrice,
      entryTime: position.entryTime,
      exitTime: exitTime,
    );

    openPositions.remove(position);
    tradeHistory.add(result);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/trading/virtual_exchange.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 533: lib/features/market/data/dtos/instrument_dto.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/dtos/instrument_dto.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 665.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

class InstrumentDTO {
  final String name;
  final int displayPrecision;
  final int tradeUnitsPrecision;

  InstrumentDTO({
    required this.name,
    required this.displayPrecision,
    required this.tradeUnitsPrecision,
  });

  factory InstrumentDTO.fromJson(Map<String, dynamic> json) {
    return InstrumentDTO(
      name: json["name"] as String,
      displayPrecision: json["displayPrecision"] as int,
      tradeUnitsPrecision:
          json["tradeUnitsPrecision"] as int,
    );
  }

  Map<String, dynamic> toJson() => {
        "name": name,
        "displayPrecision": displayPrecision,
        "tradeUnitsPrecision": tradeUnitsPrecision,
      };
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/dtos/instrument_dto.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 534: lib/features/market/data/dtos/candle_dto.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/dtos/candle_dto.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 869.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import 'package:meta/meta.dart';

class CandleDTO {
  final String time;
  final Map<String, dynamic>? mid;
  final Map<String, dynamic>? bid;
  final Map<String, dynamic>? ask;
  final int? volume;

  CandleDTO({
    required this.time,
    this.mid,
    this.bid,
    this.ask,
    this.volume,
  });

  factory CandleDTO.fromJson(Map<String, dynamic> json) {
    return CandleDTO(
      time: json["time"] as String,
      mid: json["mid"] as Map<String, dynamic>?,
      bid: json["bid"] as Map<String, dynamic>?,
      ask: json["ask"] as Map<String, dynamic>?,
      volume: json["volume"] is int ? json["volume"] : null,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      "time": time,
      if (mid != null) "mid": mid,
      if (bid != null) "bid": bid,
      if (ask != null) "ask": ask,
      if (volume != null) "volume": volume,
    };
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/dtos/candle_dto.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 535: lib/features/market/data/adapters/audit_log_adapter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/adapters/audit_log_adapter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 455.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:hive/hive.dart';
import '../../../domain/audit/audit_log.dart';

class AuditLogAdapter extends TypeAdapter<AuditLog> {
  @override
  final typeId = 1;

  @override
  AuditLog read(BinaryReader reader) {
    final json = reader.readString();
    return AuditLog.fromJson(Map<String, dynamic>.from(jsonDecode(json)));
  }

  @override
  void write(BinaryWriter writer, AuditLog obj) {
    writer.writeString(jsonEncode(obj.toJson()));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/adapters/audit_log_adapter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 536: lib/features/market/data/mappers/candle_mapper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/mappers/candle_mapper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 710.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import '../../domain/entities/candle.dart';
import '../dtos/candle_dto.dart';

class CandleMapper {
  static Candle fromDto(CandleDTO dto) {
    final priceSource = dto.mid ?? dto.bid ?? dto.ask;
    if (priceSource == null) {
      throw FormatException("Invalid CandleDTO: no price fields");
    }

    final open = double.parse(priceSource["o"].toString());
    final high = double.parse(priceSource["h"].toString());
    final low = double.parse(priceSource["l"].toString());
    final close = double.parse(priceSource["c"].toString());

    return Candle(
      time: DateTime.parse(dto.time),
      open: open,
      high: high,
      low: low,
      close: close,
      volume: dto.volume,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/mappers/candle_mapper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 537: lib/features/market/data/mappers/instrument_mapper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/data/mappers/instrument_mapper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 362.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import '../../domain/entities/instrument.dart';
import '../dtos/instrument_dto.dart';

class InstrumentMapper {
  static Instrument fromDto(InstrumentDTO dto) {
    return Instrument(
      name: dto.name,
      display: dto.name.replaceAll("_", ""),
      displayPrecision: dto.displayPrecision,
      tradeUnitsPrecision: dto.tradeUnitsPrecision,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/data/mappers/instrument_mapper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 538: lib/features/market/presentation/pages/interactive_chart_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/interactive_chart_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 89
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:candlesticks/candlesticks.dart';

import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_event.dart';
import '../bloc/chart/chart_state.dart';

class InteractiveChartPage extends StatelessWidget {
  final String symbol;

  InteractiveChartPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => ChartBloc(
        repository: RepositoryProvider.of(context),
        symbol: symbol,
        timeframe: "M1",
      )..add(LoadChartHistory(symbol: symbol, timeframe: "M1")),
      child: _InteractiveChartView(symbol: symbol),
    );
  }
}

class _InteractiveChartView extends StatefulWidget {
  final String symbol;
  _InteractiveChartView({required this.symbol});

  @override
  __InteractiveChartViewState createState() => __InteractiveChartViewState();
}

class __InteractiveChartViewState extends State<_InteractiveChartView> {
  List<Candle> _candleItems = [];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Chart â€” ${widget.symbol}")),
      body: BlocBuilder<ChartBloc, ChartState>(
        builder: (context, state) {
          if (state is ChartLoading) {
            return Center(child: CircularProgressIndicator());
          }
          if (state is ChartLoaded) {
            _candleItems = state.candles.map((c) => Candle(
              date: c.time,
              open: c.open,
              high: c.high,
              low: c.low,
              close: c.close,
              volume: c.volume.toDouble(),
            )).toList();

            return Column(
              children: [
                Expanded(
                  child: Candlesticks(
                    candles: _candleItems,
                    showVolume: true,
                    onIndicatorChange: (i) {},
                  ),
                ),
              ],
            );
          }
          if (state is ChartError) {
            return Center(child: Text("Error: ${state.message}"));
          }
          return Container();
        },
      ),
    );
  }
}

// Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ AppBar:
actions: [
  IconButton(
    icon: Icon(Icons.show_chart),
    onPressed: () => context.read<DrawingBloc>().add(StartTrendline()),
  ),
  IconButton(
    icon: Icon(Icons.horizontal_rule),
    onPressed: () => context.read<DrawingBloc>().add(AddHorizontalLine(priceY: 0)),
  ),
],

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/interactive_chart_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 539: lib/features/market/presentation/pages/oanda_settings_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/oanda_settings_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 93
================================================================================

import 'package:flutter/material.dart';
import '../../domain/usecases/save_oanda_credentials.dart';
import '../../domain/usecases/get_available_instruments.dart';
import '../../domain/usecases/get_saved_credentials.dart';
import '../../domain/repositories/market_repository.dart';
import '../widgets/instrument_list_widget.dart';

class OandaSettingsPage extends StatefulWidget {
  final MarketRepository repository;

  OandaSettingsPage({required this.repository});

  @override
  _OandaSettingsPageState createState() => _OandaSettingsPageState();
}

class _OandaSettingsPageState extends State<OandaSettingsPage> {
  final _tokenController = TextEditingController();
  final _accountIdController = TextEditingController();

  bool _isLoading = false;
  List<String> _instruments = [];

  @override
  void initState() {
    super.initState();
    _loadSavedCredentials();
  }

  void _loadSavedCredentials() async {
    try {
      final credentials = await GetSavedCredentials(widget.repository)();
      _tokenController.text = credentials['token']!;
      _accountIdController.text = credentials['accountId']!;
      _fetchInstruments(); // Ø¬Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    } catch (_) {}
  }

  void _saveCredentials() async {
    setState(() => _isLoading = true);
    await SaveOandaCredentials(widget.repository)(
      token: _tokenController.text.trim(),
      accountId: _accountIdController.text.trim(),
    );
    await _fetchInstruments();
    setState(() => _isLoading = false);
  }

  void _fetchInstruments() async {
    setState(() => _isLoading = true);
    final list = await GetAvailableInstruments(widget.repository)();
    setState(() => _instruments = list);
    setState(() => _isLoading = false);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OANDA")),
      body: Padding(
        padding: const EdgeInsets.all(12.0),
        child: Column(
          children: [
            TextField(
              controller: _tokenController,
              decoration: InputDecoration(
                labelText: "API Token",
                border: OutlineInputBorder(),
              ),
            ),
            SizedBox(height: 8),
            TextField(
              controller: _accountIdController,
              decoration: InputDecoration(
                labelText: "Account ID",
                border: OutlineInputBorder(),
              ),
            ),
            SizedBox(height: 12),
            ElevatedButton(
              onPressed: _saveCredentials,
              child: Text("Ø­ÙØ¸ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚"),
            ),
            SizedBox(height: 16),
            if (_isLoading) CircularProgressIndicator(),
            if (!_isLoading && _instruments.isNotEmpty)
              Expanded(child: InstrumentListWidget(instruments: _instruments)),
          ],
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/oanda_settings_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 540: lib/features/market/presentation/pages/market_chart_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/market_chart_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 223.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:flutter/material.dart';

class MarketChartPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(child: Text('Market Chart')),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/market_chart_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 541: lib/features/market/presentation/pages/home_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/home_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 54
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

import '../../presentation/bloc/oanda/oanda_setup_bloc.dart';
import '../../presentation/bloc/oanda/oanda_setup_state.dart';
import '../../presentation/bloc/markets/markets_bloc.dart';
import '../../presentation/bloc/markets/markets_event.dart';
import '../../presentation/bloc/markets/markets_state.dart';
import '../../data/repositories/market_repository_impl.dart';
import '../../data/datasources/local_storage.dart';
import '../widgets/market_list_widget.dart';
import '../pages/oanda_settings_page.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {

    final localStorage = LocalStorage();
    final repository = MarketRepositoryImpl(localStorage: localStorage);

    return Scaffold(
      appBar: AppBar(title: Text("Trading App")),
      body: MultiBlocProvider(
        providers: [
          BlocProvider(
            create: (_) => MarketsBloc(
              repository: repository,
              storage: localStorage,
            )..add(LoadMarkets()),
          ),
        ],
        child: SafeArea(
          child: BlocBuilder<MarketsBloc, MarketsState>(
            builder: (context, state) {
              if (state is MarketsLoading) {
                return Center(child: CircularProgressIndicator());
              }
              if (state is MarketsLoaded) {
                return MarketListWidget(instruments: state.instruments);
              }
              if (state is MarketsEmpty) {
                return Center(child: Text("No markets available"));
              }
              if (state is MarketsError) {
                return Center(child: Text("Error: ${state.message}"));
              }
              return Center(child: Text("Welcome"));
            },
          ),
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/home_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 542: lib/features/market/presentation/pages/alerts/alerts_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/alerts/alerts_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 3.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 120
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/alerts/alert_bloc.dart';
import '../../bloc/alerts/alert_state.dart';
import '../../bloc/alerts/alert_event.dart';
import '../../../domain/alerts/price_alert.dart';

class AlertsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Manage Alerts"),
        actions: [
          IconButton(
            icon: Icon(Icons.delete_sweep),
            onPressed: () {
              context.read<AlertBloc>().add(RemovePriceAlert(-1));
            },
          ),
        ],
      ),
      body: BlocBuilder<AlertBloc, AlertState>(
        builder: (context, state) {
          if (state is AlertUpdated) {
            final alerts = state.alerts;
            if (alerts.isEmpty) {
              return Center(child: Text("No alerts set"));
            }
            return ListView.builder(
              itemCount: alerts.length,
              itemBuilder: (ctx, i) {
                final PriceAlert a = alerts[i];
                return ListTile(
                  title: Text("${a.symbol} @ ${a.price.toStringAsFixed(4)}"),
                  subtitle: Text(a.triggerAbove ? "Above" : "Below"),
                  trailing: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      IconButton(
                        icon: Icon(Icons.edit),
                        onPressed: () {
                          _showEditDialog(context, a, i);
                        },
                      ),
                      IconButton(
                        icon: Icon(Icons.delete),
                        onPressed: () {
                          context.read<AlertBloc>().add(RemovePriceAlert(i));
                        },
                      ),
                    ],
                  ),
                );
              },
            );
          }
          return Center(child: Text("Loading alerts..."));
        },
      ),
    );
  }

  void _showEditDialog(BuildContext context, PriceAlert alert, int index) {
    final TextEditingController _priceCtrl =
        TextEditingController(text: alert.price.toString());
    bool triggerAbove = alert.triggerAbove;

    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text("Edit Alert"),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: _priceCtrl,
              keyboardType: TextInputType.number,
              decoration: InputDecoration(labelText: "Target Price"),
            ),
            Row(
              children: [
                Text("Trigger when:"),
                Switch(
                  value: triggerAbove,
                  onChanged: (v) => triggerAbove = v,
                ),
                Text(triggerAbove ? "Above" : "Below"),
              ],
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text("Cancel"),
          ),
          ElevatedButton(
            onPressed: () {
              final double? newPrice = double.tryParse(_priceCtrl.text);
              if (newPrice != null) {
                // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
                context.read<AlertBloc>().add(RemovePriceAlert(index));
                context.read<AlertBloc>().add(AddPriceAlert(
                      PriceAlert(
                        price: newPrice,
                        triggerAbove: triggerAbove,
                        symbol: alert.symbol,
                      ),
                    ));
              }
              Navigator.pop(context);
            },
            child: Text("Save"),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/alerts/alerts_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 543: lib/features/market/presentation/pages/positions/positions_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/positions/positions_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 4.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 115
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/positions/positions_bloc.dart';
import '../../bloc/positions/positions_event.dart';
import '../../bloc/positions/positions_state.dart';
import '../../../data/models/position/position_model.dart';

class PositionsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Open Positions")),
      body: Column(
        children: [
          ElevatedButton(
            onPressed: () => context.read<PositionsBloc>().add(LoadPositions()),
            child: Text("Refresh"),
          ),
          Expanded(
            child: BlocBuilder<PositionsBloc, PositionsState>(
              builder: (context, state) {
                if (state is PositionsLoading) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is PositionsLoaded) {
                  final positions = state.positionList;
                  if (positions.isEmpty) {
                    return Center(child: Text("No open positions"));
                  }
                  return ListView.builder(
                    itemCount: positions.length,
                    itemBuilder: (ctx, i) {
                      final PositionModel p = positions[i];
                      return ListTile(
                        title: Text("${p.instrument} - Units: ${p.units.toString()}"),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text("Avg Price: ${p.averagePrice.toStringAsFixed(4)}"),
                            Text("Unrealized P/L: ${p.unrealizedPL.toStringAsFixed(2)}"),
                            Text("SL: ${p.stopLoss?.toStringAsFixed(4) ?? '-'}"),
                            Text("TP: ${p.takeProfit?.toStringAsFixed(4) ?? '-'}"),
                          ],
                        ),
                        trailing: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            IconButton(
                              icon: Icon(Icons.edit),
                              onPressed: () => _showModifyDialog(context, p),
                            ),
                            IconButton(
                              icon: Icon(Icons.close),
                              onPressed: () => context.read<PositionsBloc>().add(ClosePositionEvent(p.instrument)),
                            ),
                          ],
                        ),
                      );
                    },
                  );
                }
                if (state is PositionsError) {
                  return Center(child: Text("Error: ${state.message}"));
                }
                return Container();
              },
            ),
          ),
        ],
      ),
    );
  }

  void _showModifyDialog(BuildContext context, PositionModel p) {
    final stopCtrl = TextEditingController(text: p.stopLoss?.toStringAsFixed(4) ?? '');
    final tpCtrl = TextEditingController(text: p.takeProfit?.toStringAsFixed(4) ?? '');

    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text("Modify Position"),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: stopCtrl,
              decoration: InputDecoration(labelText: "Stop Loss"),
              keyboardType: TextInputType.numberWithOptions(decimal: true),
            ),
            TextField(
              controller: tpCtrl,
              decoration: InputDecoration(labelText: "Take Profit"),
              keyboardType: TextInputType.numberWithOptions(decimal: true),
            ),
          ],
        ),
        actions: [
          ElevatedButton(
            onPressed: () {
              final sl = double.tryParse(stopCtrl.text) ?? 0.0;
              final tp = double.tryParse(tpCtrl.text) ?? 0.0;
              context.read<PositionsBloc>().add(ModifyPositionEvent(
                instrument: p.instrument,
                stopLoss: sl,
                takeProfit: tp,
              ));
              Navigator.pop(context);
            },
            child: Text("Save"),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/positions/positions_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 544: lib/features/market/presentation/pages/audit/audit_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/audit/audit_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 45
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/audit/audit_bloc.dart';
import '../../bloc/audit/audit_event.dart';
import '../../bloc/audit/audit_state.dart';

class AuditPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Audit Trail")),
      body: Column(
        children: [
          ElevatedButton(
            onPressed: () => context.read<AuditBloc>().add(LoadAuditLogs()),
            child: Text("Refresh Logs"),
          ),
          Expanded(
            child: BlocBuilder<AuditBloc, AuditState>(
              builder: (context, state) {
                if (state is AuditLoading) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is AuditLoaded) {
                  if (state.logs.isEmpty) return Center(child: Text("No logs"));
                  return ListView.builder(
                    itemCount: state.logs.length,
                    itemBuilder: (ctx, i) {
                      final log = state.logs[i];
                      return ListTile(
                        title: Text(log.message),
                        subtitle: Text(log.timestamp.toString()),
                      );
                    },
                  );
                }
                return Container();
              },
            ),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/audit/audit_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 545: lib/features/market/presentation/pages/backtest/backtest_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/backtest/backtest_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 73
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/backtest/backtest_bloc.dart';
import '../../bloc/backtest/backtest_event.dart';
import '../../bloc/backtest/backtest_state.dart';

class BacktestPage extends StatelessWidget {
  final String symbol;

  BacktestPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Backtest â€” $symbol")),
      body: Column(
        children: [
          SizedBox(height: 8),
          ElevatedButton(
            onPressed: () {
              context.read<BacktestBloc>().add(
                    RunBacktestEvent(
                      symbol: symbol,
                      timeframe: "M1",
                      start: null,
                      end: null,
                    ),
                  );
            },
            child: Text("Start Backtest"),
          ),
          SizedBox(height: 8),
          Expanded(
            child: BlocBuilder<BacktestBloc, BacktestState>(
              builder: (context, state) {
                if (state is BacktestRunning) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is BacktestSuccess) {
                  final result = state.result;
                  return Column(
                    children: [
                      Text("Net Profit: ${result.netProfit.toStringAsFixed(2)}"),
                      Text("Win Rate: ${result.winRate.toStringAsFixed(2)}%"),
                      Text("Max Drawdown: ${result.maxDrawdown.toStringAsFixed(2)}"),
                      Expanded(
                        child: ListView.builder(
                          itemCount: result.equityCurve.length,
                          itemBuilder: (ctx, i) {
                            return ListTile(
                              title: Text(result.timestamps[i].toIso8601String()),
                              trailing: Text(result.equityCurve[i].toStringAsFixed(2)),
                            );
                          },
                        ),
                      ),
                    ],
                  );
                }
                if (state is BacktestError) {
                  return Center(
                    child: Text("Error: ${state.message}"),
                  );
                }
                return Center(child: Text("Press Start to Run Backtest"));
              },
            ),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/backtest/backtest_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 546: lib/features/market/presentation/pages/strategy_comparison/strategy_comparison_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/strategy_comparison/strategy_comparison_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 62
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/strategy_comparison/strategy_comparison_bloc.dart';
import '../../bloc/strategy_comparison/strategy_comparison_event.dart';
import '../../bloc/strategy_comparison/strategy_comparison_state.dart';

class StrategyComparisonPage extends StatelessWidget {
  final List history;
  final List configs;

  StrategyComparisonPage({
    required this.history,
    required this.configs,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Strategy Comparison")),
      body: BlocProvider(
        create: (_) => StrategyComparisonBloc(),
        child: BlocBuilder<StrategyComparisonBloc, ComparisonState>(
          builder: (context, state) {
            if (state is ComparisonRunning)
              return Center(child: CircularProgressIndicator());

            if (state is ComparisonSuccess) {
              final results = state.results;
              return ListView(
                children: results.entries.map((e) {
                  final key = e.key;
                  final res = e.value;
                  return ListTile(
                    title: Text("Strategy: \$key"),
                    subtitle: Text("Net: \${res.netProfit} | WinRate: \${res.winRate}"),
                  );
                }).toList(),
              );
            }

            if (state is ComparisonError)
              return Center(child: Text(state.message));

            return Center(
              child: ElevatedButton(
                child: Text("Start Comparison"),
                onPressed: () {
                  final set = StrategySet(
                    strategies: configs.map((c) => StrategyInstance(id: c.id, config: c)).toList(),
                  );
                  context.read<StrategyComparisonBloc>().add(
                        RunComparison(set: set, history: history),
                      );
                },
              ),
            );
          },
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/strategy_comparison/strategy_comparison_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 547: lib/features/market/presentation/pages/analytics/analytics_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/analytics/analytics_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 46
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/analytics/analytics_bloc.dart';
import '../../bloc/analytics/analytics_event.dart';
import '../../bloc/analytics/analytics_state.dart';

class AnalyticsPage extends StatelessWidget {
  final List<double> profits;
  AnalyticsPage({required this.profits});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Advanced Analytics")),
      body: BlocProvider(
        create: (_) => AnalyticsBloc()..add(ComputeAnalytics(profits)),
        child: BlocBuilder<AnalyticsBloc, AnalyticsState>(
          builder: (context, state) {
            if (state is AnalyticsLoading) {
              return Center(child: CircularProgressIndicator());
            }
            if (state is AnalyticsLoaded) {
              final r = state.result;
              return ListView(
                padding: EdgeInsets.all(12),
                children: [
                  Text("Net Profit: ${r.netProfit.toStringAsFixed(2)}"),
                  Text("Win Rate: ${r.winRate.toStringAsFixed(2)}%"),
                  Text("Sharp Ratio: ${r.sharpRatio.toStringAsFixed(2)}"),
                  Text("Expectancy: ${r.expectancy.toStringAsFixed(2)}"),
                  Text("Total Trades: ${r.totalTrades}"),
                  Text("Wins: ${r.wins}"),
                  Text("Losses: ${r.losses}"),
                ],
              );
            }
            if (state is AnalyticsError) {
              return Center(child: Text(state.message));
            }
            return Container();
          },
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/analytics/analytics_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 548: lib/features/market/presentation/pages/settings/strategy_settings_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/pages/settings/strategy_settings_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 4.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 108
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/settings/settings_bloc.dart';
import '../../bloc/settings/settings_event.dart';
import '../../bloc/settings/settings_state.dart';

class StrategySettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Strategy Settings")),
      body: Padding(
        padding: const EdgeInsets.all(12),
        child: BlocConsumer<SettingsBloc, SettingsState>(
          listener: (context, state) {
            if (state is SettingsError) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(state.message)),
              );
            }
          },
          builder: (context, state) {
            if (state is SettingsLoading) {
              return Center(child: CircularProgressIndicator());
            }
            if (state is SettingsLoaded) {
              final config = state.config;
              final emaShortCtrl =
                  TextEditingController(text: config.emaShort.toString());
              final emaLongCtrl =
                  TextEditingController(text: config.emaLong.toString());
              final stochPeriodCtrl =
                  TextEditingController(text: config.stochPeriod.toString());
              final stochSmoothKCtrl =
                  TextEditingController(text: config.stochSmoothK.toString());
              final stochSmoothDCtrl =
                  TextEditingController(text: config.stochSmoothD.toString());
              final slCtrl =
                  TextEditingController(text: config.stopLossPct.toString());
              final tpCtrl =
                  TextEditingController(text: config.takeProfitPct.toString());

              return ListView(
                children: [
                  TextField(
                    controller: emaShortCtrl,
                    decoration: InputDecoration(labelText: "EMA Short"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: emaLongCtrl,
                    decoration: InputDecoration(labelText: "EMA Long"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: stochPeriodCtrl,
                    decoration: InputDecoration(labelText: "Stoch Period"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: stochSmoothKCtrl,
                    decoration: InputDecoration(labelText: "Stoch Smooth K"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: stochSmoothDCtrl,
                    decoration: InputDecoration(labelText: "Stoch Smooth D"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: slCtrl,
                    decoration: InputDecoration(labelText: "Stop Loss %"),
                    keyboardType:
                        TextInputType.numberWithOptions(decimal: true),
                  ),
                  TextField(
                    controller: tpCtrl,
                    decoration: InputDecoration(labelText: "Take Profit %"),
                    keyboardType:
                        TextInputType.numberWithOptions(decimal: true),
                  ),
                  SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: () {
                      context.read<SettingsBloc>().add(
                            UpdateStrategySettings(
                              emaShort: int.parse(emaShortCtrl.text),
                              emaLong: int.parse(emaLongCtrl.text),
                              stochPeriod: int.parse(stochPeriodCtrl.text),
                              stochSmoothK: int.parse(stochSmoothKCtrl.text),
                              stochSmoothD: int.parse(stochSmoothDCtrl.text),
                              stopLossPct: double.parse(slCtrl.text),
                              takeProfitPct: double.parse(tpCtrl.text),
                            ),
                          );
                    },
                    child: Text("Save Settings"),
                  ),
                ],
              );
            }
            return SizedBox();
          },
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/pages/settings/strategy_settings_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 549: lib/features/market/presentation/bloc/chart_bloc_sync_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart_bloc_sync_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 703.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/sync/event_sync_controller.dart';

class ChartBlocSyncFix extends Bloc<ChartEvent, ChartState> {
  final EventSyncController _sync = EventSyncController();

  ChartBlocSyncFix() : super(ChartInitial()) {
    on<NewLiveCandle>((event, emit) {
      _sync.addToQueue(() {
        // process candle update
        emit(ChartUpdated(event.candle));
      });
    });

    on<ZoomPanChanged>((event, emit) {
      _sync.addToQueue(() {
        // process zoom/pan update
        emit(ChartZoomed(event.range));
      });
    });
  }

  @override
  Future<void> close() async {
    await _sync.close();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart_bloc_sync_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 550: lib/features/market/presentation/bloc/auto_fetch_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/auto_fetch_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 400.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../core/network/markets_api.dart';
import '../../../core/models/dto/instrument_dto.dart';

class AutoFetchBloc extends Bloc<void, List<InstrumentDto>> {
  final MarketsApi marketsApi;

  AutoFetchBloc(this.marketsApi) : super([]) {
    on((_, emit) async {
      final list = await marketsApi.fetchAll();
      emit(list);
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/auto_fetch_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 551: lib/features/market/presentation/bloc/timeframe_loading_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/timeframe_loading_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 221.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

class TimeframeLoadingFix {
  bool _loading = false;

  Future<void> loadIfNotLoading(Future<void> Function() loadFn) async {
    if (_loading) return;
    _loading = true;
    await loadFn();
    _loading = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/timeframe_loading_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 552: lib/features/market/presentation/bloc/zoom_debounce_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/zoom_debounce_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 377.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/utils/debounce.dart';

class ZoomBloc extends Bloc<ZoomEvent, ZoomState> {
  final Debouncer _debouncer = Debouncer(Duration(milliseconds: 200));

  ZoomBloc(): super(ZoomIdle()) {
    on<ZoomChanged>((event, emit) {
      _debouncer(() {
        emit(ZoomUpdated(event.range));
      });
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/zoom_debounce_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 553: lib/features/market/presentation/bloc/market_sync_bloc_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/market_sync_bloc_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 378.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../repository/market_repository.dart';

class MarketSyncBloc extends Cubit<bool> {
  final MarketRepository repo;

  MarketSyncBloc(this.repo) : super(false);

  Future<void> init(String symbol, String timeframe) async {
    await repo.getCandles(symbol, timeframe);
    emit(true); // Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø« Ø§Ù„Ù„Ø­Ø¸ÙŠ
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/market_sync_bloc_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 554: lib/features/market/presentation/bloc/analytics/analytics_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/analytics/analytics_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 148.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

abstract class AnalyticsEvent {}

class ComputeAnalytics extends AnalyticsEvent {
  final List<double> profits;
  ComputeAnalytics(this.profits);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/analytics/analytics_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 555: lib/features/market/presentation/bloc/analytics/analytics_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/analytics/analytics_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 633.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/analytics/analytics_calculator.dart';
import 'analytics_event.dart';
import 'analytics_state.dart';

class AnalyticsBloc extends Bloc<AnalyticsEvent, AnalyticsState> {
  AnalyticsBloc() : super(AnalyticsIdle()) {
    on<ComputeAnalytics>(_onCompute);
  }

  void _onCompute(ComputeAnalytics event, Emitter<AnalyticsState> emit) {
    emit(AnalyticsLoading());
    try {
      final result = AnalyticsCalculator.calculate(event.profits);
      emit(AnalyticsLoaded(result));
    } catch (e) {
      emit(AnalyticsError("Analytics compute failed"));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/analytics/analytics_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 556: lib/features/market/presentation/bloc/analytics/analytics_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/analytics/analytics_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 341.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class AnalyticsState {}

class AnalyticsIdle extends AnalyticsState {}

class AnalyticsLoading extends AnalyticsState {}

class AnalyticsLoaded extends AnalyticsState {
  final dynamic result;
  AnalyticsLoaded(this.result);
}

class AnalyticsError extends AnalyticsState {
  final String message;
  AnalyticsError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/analytics/analytics_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 557: lib/features/market/presentation/bloc/trading/trading_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/trading/trading_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 460.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

abstract class TradingEvent {}

class PlaceOrder extends TradingEvent {
  final String instrument;
  final OrderSide side;
  final double price;
  final double size;

  PlaceOrder({
    required this.instrument,
    required this.side,
    required this.price,
    required this.size,
  });
}

class ClosePosition extends TradingEvent {
  final String positionId;

  ClosePosition({required this.positionId});
}

class RefreshPositions extends TradingEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/trading/trading_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 558: lib/features/market/presentation/bloc/trading/trading_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/trading/trading_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 56
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'trading_event.dart';
import 'trading_state.dart';
import '../../../../market/data/repositories/trading_repository.dart';
import '../../../../market/domain/backtest/backtest_models.dart';

class TradingBloc extends Bloc<TradingEvent, TradingState> {
  final TradingRepository repository;

  TradingBloc(this.repository) : super(TradingInitial()) {
    on<PlaceOrder>(_onPlaceOrder);
    on<ClosePosition>(_onClosePosition);
    on<RefreshPositions>(_onRefreshPositions);
  }

  Future<void> _onPlaceOrder(PlaceOrder event, Emitter<TradingState> emit) async {
    emit(TradingLoading());

    try {
      final updatedPositions = await repository.placeOrder(
        instrument: event.instrument,
        side: event.side,
        price: event.price,
        size: event.size,
      );

      emit(TradingOrderSuccess("Order placed successfully"));
      emit(TradingPositionsLoaded(updatedPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }

  Future<void> _onClosePosition(ClosePosition event, Emitter<TradingState> emit) async {
    emit(TradingLoading());

    try {
      final updatedPositions = await repository.closePosition(event.positionId);
      emit(TradingOrderSuccess("Position closed successfully"));
      emit(TradingPositionsLoaded(updatedPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }

  Future<void> _onRefreshPositions(RefreshPositions event, Emitter<TradingState> emit) async {
    emit(TradingLoading());

    try {
      final positions = await repository.getOpenPositions();
      emit(TradingPositionsLoaded(positions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/trading/trading_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 559: lib/features/market/presentation/bloc/trading/trading_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/trading/trading_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 533.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import '../../../../market/domain/backtest/backtest_models.dart';

abstract class TradingState {}

class TradingInitial extends TradingState {}

class TradingLoading extends TradingState {}

class TradingPositionsLoaded extends TradingState {
  final List<Position> positions;
  TradingPositionsLoaded(this.positions);
}

class TradingOrderSuccess extends TradingState {
  final String message;
  TradingOrderSuccess(this.message);
}

class TradingFailure extends TradingState {
  final String error;
  TradingFailure(this.error);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/trading/trading_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 560: lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 251.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import '../../../domain/strategy/multi/strategy_set.dart';

abstract class ComparisonEvent {}

class RunComparison extends ComparisonEvent {
  final StrategySet set;
  final List history;
  RunComparison({required this.set, required this.history});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 561: lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 369.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class ComparisonState {}

class ComparisonIdle extends ComparisonState {}

class ComparisonRunning extends ComparisonState {}

class ComparisonSuccess extends ComparisonState {
  final Map<String, dynamic> results;
  ComparisonSuccess(this.results);
}

class ComparisonError extends ComparisonState {
  final String message;
  ComparisonError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 562: lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 736.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/strategy/multi/multi_strategy_runner.dart';
import 'strategy_comparison_event.dart';
import 'strategy_comparison_state.dart';

class StrategyComparisonBloc extends Bloc<ComparisonEvent, ComparisonState> {
  StrategyComparisonBloc() : super(ComparisonIdle()) {
    on<RunComparison>(_onRun);
  }

  void _onRun(RunComparison event, Emitter<ComparisonState> emit) async {
    emit(ComparisonRunning());
    try {
      final runner = MultiStrategyRunner(event.set);
      final results = await runner.runBacktestAll(event.history);
      emit(ComparisonSuccess(results.results));
    } catch (e) {
      emit(ComparisonError("Comparison failed: \$e"));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 563: lib/features/market/presentation/bloc/chart/chart_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 60
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'chart_event.dart';
import 'chart_state.dart';
import '../../../../core/models/candle_entity.dart';
import '../../../../market/data/repositories/market_repository.dart';

class ChartBloc extends Bloc<ChartEvent, ChartState> {
  final MarketRepository repository;

  ChartBloc(this.repository) : super(ChartInitial()) {
    on<LoadChartData>(_onLoad);
    on<UpdateVisibleRange>(_onUpdateRange);
    on<RefreshChart>(_onRefresh);
  }

  Future<void> _onLoad(LoadChartData event, Emitter<ChartState> emit) async {
    emit(ChartLoading());
    try {
      final candles = await repository.getHistoricalCandles(
        symbol: event.symbol,
        timeframe: event.timeframe,
      );

      if (candles.isEmpty) {
        return emit(ChartError("No candles returned"));
      }

      emit(ChartLoaded(
        candles: candles,
        visibleMin: candles.first.timeUtc,
        visibleMax: candles.last.timeUtc,
      ));
    } catch (e) {
      emit(ChartError(e.toString()));
    }
  }

  void _onUpdateRange(UpdateVisibleRange event, Emitter<ChartState> emit) {
    final stateNow = state;
    if (stateNow is ChartLoaded) {
      emit(ChartLoaded(
        candles: stateNow.candles,
        visibleMin: event.min,
        visibleMax: event.max,
      ));
    }
  }

  void _onRefresh(RefreshChart event, Emitter<ChartState> emit) {
    final stateNow = state;
    if (stateNow is ChartLoaded) {
      add(LoadChartData(
        symbol: stateNow.candles.first.instrument,
        timeframe: (stateNow.visibleMax.difference(stateNow.visibleMin).inMinutes == 1)
            ? "M1"
            : "Unknown",
      ));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 564: lib/features/market/presentation/bloc/chart/chart_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 538.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import '../../../../core/models/candle_entity.dart';

abstract class ChartState {}

class ChartIdle extends ChartState {}

class ChartLoading extends ChartState {}

class ChartLoaded extends ChartState {
  final List<CandleEntity> candles;
  final DateTime from;
  final DateTime to;

  ChartLoaded(this.candles, this.from, this.to);
}

class ChartLiveUpdated extends ChartState {
  final CandleEntity latest;
  ChartLiveUpdated(this.latest);
}

class ChartError extends ChartState {
  final String message;
  ChartError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 565: lib/features/market/presentation/bloc/chart/chart_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 354.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class ChartEvent {}

class LoadChartHistory extends ChartEvent {
  final String symbol;
  final String timeframe;
  final DateTime from;
  final DateTime to;

  LoadChartHistory(this.symbol, this.timeframe, this.from, this.to);
}

class AppendLiveCandle extends ChartEvent {
  final CandleEntity newCandle;
  AppendLiveCandle(this.newCandle);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 566: lib/features/market/presentation/bloc/chart/chart_bloc_order_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_bloc_order_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 247.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

void _onLoadChartHistory(...) async {
  final history = await repo.getCandles(...);
  emit(ChartLoaded(history, ...));
  // Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙ‚Ø·
  _streamSubscription = stream.listen((candle) {
    add(AppendLiveCandle(candle));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_bloc_order_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 567: lib/features/market/presentation/bloc/chart/chart_bloc_error_handling.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_bloc_error_handling.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 310.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

on<LoadChartHistory>((evt, emit) async {
  try {
    final candles = await repo.getCandles(...);
    emit(ChartLoaded(candles, evt.from, evt.to));
  } catch (e) {
    if (e is RestError) {
      emit(ChartError(e.message));
    } else {
      emit(ChartError("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹"));
    }
  }
});

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_bloc_error_handling.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 568: lib/features/market/presentation/bloc/chart/chart_state_reset.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_state_reset.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 314.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

class ChartStateReset extends ChartEvent {}

class ChartBlocStateResetFix extends Bloc<ChartEvent, ChartState> {
  ChartBlocStateResetFix(): super(ChartIdle()) {
    on<ChartStateReset>((_, emit) {
      emit(ChartIdle()); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_state_reset.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 569: lib/features/market/presentation/bloc/chart/history_cache_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/history_cache_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 275.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../../core/models/candle_entity.dart';

class HistoryCacheFix {
  List<CandleEntity>? _lastCache;

  List<CandleEntity>? get cached => _lastCache;

  void save(List<CandleEntity> data) {
    _lastCache = data;
  }

  void clear() {
    _lastCache = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/history_cache_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 570: lib/features/market/presentation/bloc/chart/chart_bloc_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/chart_bloc_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 410.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

class ChartBlocFix extends Bloc<ChartEvent, ChartState> {
  List<CandleEntity> _candles = [];

  ChartBlocFix() : super(ChartIdle()) {
    on<LoadChartHistory>((evt, emit) {
      _candles = evt.candles;
      emit(ChartLoaded(_candles, evt.from, evt.to));
    });

    on<ClearChart>((_, emit) {
      _candles.clear();
      emit(ChartIdle());
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/chart_bloc_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 571: lib/features/market/presentation/bloc/chart/timeframe_stream_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/chart/timeframe_stream_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 304.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'dart:async';

class TimeframeStreamFix {
  StreamSubscription? _sub;

  void subscribe(Stream stream, Function onData) {
    _sub?.cancel(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
    _sub = stream.listen((data) => onData(data));
  }

  void dispose() {
    _sub?.cancel();
    _sub = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/chart/timeframe_stream_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 572: lib/features/market/presentation/bloc/positions/positions_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/positions/positions_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 450.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

abstract class PositionsEvent {}

class LoadPositions extends PositionsEvent {}

class ClosePositionEvent extends PositionsEvent {
  final String instrument;
  ClosePositionEvent(this.instrument);
}

class ModifyPositionEvent extends PositionsEvent {
  final String instrument;
  final double stopLoss;
  final double takeProfit;
  ModifyPositionEvent({
    required this.instrument,
    required this.stopLoss,
    required this.takeProfit,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/positions/positions_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 573: lib/features/market/presentation/bloc/positions/positions_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/positions/positions_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 350.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class PositionsState {}

class PositionsIdle extends PositionsState {}

class PositionsLoading extends PositionsState {}

class PositionsLoaded extends PositionsState {
  final List positionList;
  PositionsLoaded(this.positionList);
}

class PositionsError extends PositionsState {
  final String message;
  PositionsError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/positions/positions_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 574: lib/features/market/presentation/bloc/positions/positions_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/positions/positions_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 53
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/repositories/market_repository.dart';
import '../../../data/models/position/position_model.dart';
import 'positions_event.dart';
import 'positions_state.dart';

class PositionsBloc extends Bloc<PositionsEvent, PositionsState> {
  final MarketRepository repository;

  PositionsBloc(this.repository) : super(PositionsIdle()) {
    on<LoadPositions>(_onLoad);
    on<ClosePositionEvent>(_onClose);
    on<ModifyPositionEvent>(_onModify);
  }

  Future<void> _onLoad(LoadPositions event, Emitter<PositionsState> emit) async {
    emit(PositionsLoading());
    try {
      final res = await repository.getOpenPositions();
      final positionsJson = res["positions"] as List<dynamic>;
      final list = positionsJson
          .map((e) => PositionModel.fromJson(Map<String, dynamic>.from(e)))
          .toList();
      emit(PositionsLoaded(list));
    } catch (e) {
      emit(PositionsError("Failed to load positions"));
    }
  }

  Future<void> _onClose(ClosePositionEvent event, Emitter<PositionsState> emit) async {
    emit(PositionsLoading());
    try {
      await repository.closePosition(event.instrument);
      add(LoadPositions());
    } catch (e) {
      emit(PositionsError("Failed to close position"));
    }
  }

  Future<void> _onModify(ModifyPositionEvent event, Emitter<PositionsState> emit) async {
    emit(PositionsLoading());
    try {
      final body = {
        "stopLoss": {"price": event.stopLoss.toString()},
        "takeProfit": {"price": event.takeProfit.toString()},
      };
      await repository.modifyPosition(event.instrument, body);
      add(LoadPositions());
    } catch (e) {
      emit(PositionsError("Failed to modify position"));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/positions/positions_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 575: lib/features/market/presentation/bloc/drawing_tools/drawing_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/drawing_tools/drawing_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 439.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

abstract class DrawingEvent {}

class StartTrendline extends DrawingEvent {}

class AddPointToTrendline extends DrawingEvent {
  final double x;
  final double y;
  AddPointToTrendline({required this.x, required this.y});
}

class CompleteTrendline extends DrawingEvent {}

class ClearAllDrawings extends DrawingEvent {}

class AddHorizontalLine extends DrawingEvent {
  final double priceY;
  AddHorizontalLine({required this.priceY});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/drawing_tools/drawing_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 576: lib/features/market/presentation/bloc/drawing_tools/drawing_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/drawing_tools/drawing_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 50
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'drawing_event.dart';
import 'drawing_state.dart';

class DrawingBloc extends Bloc<DrawingEvent, DrawingState> {
  List<List<Offset>> _trendlines = [];
  List<double> _horizontalLines = [];

  List<Offset> _currentPoints = [];

  DrawingBloc() : super(NoDrawing()) {
    on<StartTrendline>((event, emit) {
      _currentPoints = [];
      emit(DrawingTrendline(points: _currentPoints));
    });

    on<AddPointToTrendline>((event, emit) {
      _currentPoints.add(Offset(event.x, event.y));
      emit(DrawingTrendline(points: _currentPoints));
    });

    on<CompleteTrendline>((event, emit) {
      if (_currentPoints.length >= 2) {
        _trendlines.add(List<Offset>.from(_currentPoints));
      }
      _currentPoints = [];
      emit(DrawingComplete(
        trendlines: _trendlines,
        horizontalLines: _horizontalLines,
      ));
    });

    on<AddHorizontalLine>((event, emit) {
      _horizontalLines.add(event.priceY);
      emit(DrawingComplete(
        trendlines: _trendlines,
        horizontalLines: _horizontalLines,
      ));
    });

    on<ClearAllDrawings>((event, emit) {
      _trendlines.clear();
      _horizontalLines.clear();
      emit(DrawingComplete(
        trendlines: _trendlines,
        horizontalLines: _horizontalLines,
      ));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/drawing_tools/drawing_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 577: lib/features/market/presentation/bloc/drawing_tools/drawing_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/drawing_tools/drawing_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 451.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter/material.dart';

abstract class DrawingState {}

class NoDrawing extends DrawingState {}

class DrawingTrendline extends DrawingState {
  final List<Offset> points;
  DrawingTrendline({required this.points});
}

class DrawingComplete extends DrawingState {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;
  DrawingComplete({
    required this.trendlines,
    required this.horizontalLines,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/drawing_tools/drawing_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 578: lib/features/market/presentation/bloc/oanda/oanda_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/oanda/oanda_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 339.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

part of 'oanda_bloc.dart';

abstract class OandaState {}
class OandaInitial extends OandaState {}
class OandaLoading extends OandaState {}
class OandaLoaded extends OandaState {
  final List<String> instruments;
  OandaLoaded(this.instruments);
}
class OandaError extends OandaState {
  final String message;
  OandaError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/oanda/oanda_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 579: lib/features/market/presentation/bloc/oanda/oanda_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/oanda/oanda_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 101.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

part of 'oanda_bloc.dart';

abstract class OandaEvent {}
class LoadInstruments extends OandaEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/oanda/oanda_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 580: lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 376.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

abstract class OandaSetupState {}

class OandaInitial extends OandaSetupState {}

class OandaLoading extends OandaSetupState {}

class OandaConnected extends OandaSetupState {}

class OandaTokenExpired extends OandaSetupState {}

class OandaError extends OandaSetupState {
  final String message;
  OandaError(this.message);
}

class OandaLoggedOut extends OandaSetupState {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 581: lib/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 58
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'oanda_setup_event.dart';
import 'oanda_setup_state.dart';
import '../../../../core/storage/oanda/secure_storage.dart';
import '../../../../core/network/rest_client.dart';

class OandaSetupBloc extends Bloc<OandaSetupEvent, OandaSetupState> {
  final OandaSecureStorage storage;
  final String baseUrl;

  OandaSetupBloc({
    required this.storage,
    required this.baseUrl,
  }) : super(OandaInitial()) {
    on<SubmitOandaCredentials>(_onSubmit);
    on<RetryConnection>(_onRetry);
    on<LogoutOanda>(_onLogout);
  }

  Future<void> _onSubmit(SubmitOandaCredentials event, Emitter<OandaSetupState> emit) async {
    emit(OandaLoading());

    try {
      // store securely
      await storage.saveToken(event.token);
      await storage.saveAccountId(event.accountId);

      // test connection
      final rest = RestClient(event.token, baseUrl);
      final res = await rest.get('/v3/accounts/${event.accountId}');
      if (res.statusCode == 200) {
        emit(OandaConnected());
      } else if (res.statusCode == 401) {
        emit(OandaTokenExpired());
      } else {
        emit(OandaError('HTTP ${res.statusCode}'));
      }
    } catch (e) {
      emit(OandaError(e.toString()));
    }
  }

  Future<void> _onRetry(RetryConnection event, Emitter<OandaSetupState> emit) async {
    final token = await storage.loadToken();
    final accountId = await storage.loadAccountId();

    if (token == null || accountId == null) {
      return emit(OandaError('No credentials stored'));
    }

    add(SubmitOandaCredentials(token: token, accountId: accountId));
  }

  Future<void> _onLogout(LogoutOanda event, Emitter<OandaSetupState> emit) async {
    await storage.clearAll();
    emit(OandaLoggedOut());
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 582: lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 324.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class OandaSetupEvent {}

class SubmitOandaCredentials extends OandaSetupEvent {
  final String token;
  final String accountId;

  SubmitOandaCredentials({
    required this.token,
    required this.accountId,
  });
}

class RetryConnection extends OandaSetupEvent {}

class LogoutOanda extends OandaSetupEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 583: lib/features/market/presentation/bloc/oanda/oanda_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/oanda/oanda_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 542.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../data/oanda_market_repository.dart';

part 'oanda_event.dart';
part 'oanda_state.dart';

class OandaBloc extends Bloc<OandaEvent, OandaState> {
  final OandaMarketRepository repo;

  OandaBloc(this.repo) : super(OandaInitial()) {
    on<LoadInstruments>((_, emit) async {
      emit(OandaLoading());
      try {
        final list = await repo.getInstruments();
        emit(OandaLoaded(list));
      } catch (e) {
        emit(OandaError(e.toString()));
      }
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/oanda/oanda_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 584: lib/features/market/presentation/bloc/settings/settings_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/settings/settings_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 394.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../../../domain/strategy/strategy_config.dart';

abstract class SettingsState {}

class SettingsIdle extends SettingsState {}

class SettingsLoading extends SettingsState {}

class SettingsLoaded extends SettingsState {
  final StrategyConfig config;
  SettingsLoaded(this.config);
}

class SettingsError extends SettingsState {
  final String message;
  SettingsError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/settings/settings_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 585: lib/features/market/presentation/bloc/settings/settings_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/settings/settings_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 81
================================================================================

import 'package:hydrated_bloc/hydrated_bloc.dart';
import '../../../domain/strategy/strategy_config.dart';
import '../../data/storage/settings_storage.dart';
import 'settings_event.dart';
import 'settings_state.dart';

class SettingsBloc extends HydratedBloc<SettingsEvent, SettingsState> {
  final SettingsStorage _storage = SettingsStorage();

  SettingsBloc() : super(SettingsIdle()) {
    on<LoadSettingsEvent>(_onLoad);
    on<UpdateStrategySettings>(_onUpdate);
  }

  Future<void> _onLoad(
    LoadSettingsEvent event,
    Emitter<SettingsState> emit,
  ) async {
    emit(SettingsLoading());
    try {
      final settings = _storage.getStrategySettings() ??
          StrategyConfig(
            emaShort: 50,
            emaLong: 200,
            stochPeriod: 14,
            stochSmoothK: 3,
            stochSmoothD: 3,
            stopLossPct: 0.002,
            takeProfitPct: 0.005,
            minSignalIntervalSeconds: 60,
          );

      emit(SettingsLoaded(settings));
    } catch (e) {
      emit(SettingsError("Failed to load settings"));
    }
  }

  Future<void> _onUpdate(
    UpdateStrategySettings event,
    Emitter<SettingsState> emit,
  ) async {
    emit(SettingsLoading());
    try {
      final config = StrategyConfig(
        emaShort: event.emaShort,
        emaLong: event.emaLong,
        stochPeriod: event.stochPeriod,
        stochSmoothK: event.stochSmoothK,
        stochSmoothD: event.stochSmoothD,
        stopLossPct: event.stopLossPct,
        takeProfitPct: event.takeProfitPct,
        minSignalIntervalSeconds: 60,
      );

      await _storage.saveStrategySettings(config);
      emit(SettingsLoaded(config));
    } catch (e) {
      emit(SettingsError("Failed to update settings"));
    }
  }

  @override
  SettingsState? fromJson(Map<String, dynamic> json) {
    try {
      final config = StrategyConfig.fromJson(
        Map<String, dynamic>.from(json['config']),
      );
      return SettingsLoaded(config);
    } catch (_) {}
    return SettingsIdle();
  }

  @override
  Map<String, dynamic>? toJson(SettingsState state) {
    if (state is SettingsLoaded) {
      return {'config': state.config.toJson()};
    }
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/settings/settings_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 586: lib/features/market/presentation/bloc/settings/settings_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/settings/settings_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 668.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

abstract class SettingsEvent {}

/// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
class LoadSettingsEvent extends SettingsEvent {}

/// ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
class UpdateStrategySettings extends SettingsEvent {
  final int emaShort;
  final int emaLong;
  final int stochPeriod;
  final int stochSmoothK;
  final int stochSmoothD;
  final double stopLossPct;
  final double takeProfitPct;

  UpdateStrategySettings({
    required this.emaShort,
    required this.emaLong,
    required this.stochPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
    required this.stopLossPct,
    required this.takeProfitPct,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/settings/settings_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 587: lib/features/market/presentation/bloc/alerts/alert_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/alerts/alert_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 224.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import '../../../domain/alerts/price_alert.dart';

abstract class AlertState {}

class AlertIdle extends AlertState {}

class AlertUpdated extends AlertState {
  final List<PriceAlert> alerts;
  AlertUpdated(this.alerts);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/alerts/alert_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 588: lib/features/market/presentation/bloc/alerts/alert_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/alerts/alert_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 46
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/alerts/price_alert.dart';
import 'alert_event.dart';
import 'alert_state.dart';
import '../../../../core/notifications/notification_service.dart';

class AlertBloc extends Bloc<AlertEvent, AlertState> {
  final List<PriceAlert> _alerts = [];

  AlertBloc() : super(AlertIdle()) {
    on<AddPriceAlert>((event, emit) {
      _alerts.add(event.alert);
      emit(AlertUpdated(List.from(_alerts)));
    });

    on<RemovePriceAlert>((event, emit) {
      if (event.index >= 0 && event.index < _alerts.length) {
        _alerts.removeAt(event.index);
      }
      emit(AlertUpdated(List.from(_alerts)));
    });

    on<CheckPriceAlerts>((event, emit) {
      final price = event.currentPrice;

      for (var alert in List.from(_alerts)) {
        bool shouldTrigger =
            (alert.triggerAbove && price >= alert.price) ||
            (!alert.triggerAbove && price <= alert.price);

        if (shouldTrigger) {
          NotificationService().showInstantNotification(
            id: DateTime.now().millisecond,
            title: "Price Alert: ${alert.symbol}",
            body:
                "Price reached ${alert.price} (current: ${price.toStringAsFixed(4)})",
          );

          _alerts.remove(alert);
        }
      }

      emit(AlertUpdated(List.from(_alerts)));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/alerts/alert_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 589: lib/features/market/presentation/bloc/alerts/alert_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/alerts/alert_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 392.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import '../../../domain/alerts/price_alert.dart';

abstract class AlertEvent {}

class AddPriceAlert extends AlertEvent {
  final PriceAlert alert;
  AddPriceAlert(this.alert);
}

class RemovePriceAlert extends AlertEvent {
  final int index;
  RemovePriceAlert(this.index);
}

class CheckPriceAlerts extends AlertEvent {
  final double currentPrice;
  CheckPriceAlerts(this.currentPrice);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/alerts/alert_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 590: lib/features/market/presentation/bloc/audit/audit_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/audit/audit_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 816.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../data/repositories/audit/audit_repository.dart';
import 'audit_event.dart';
import 'audit_state.dart';

class AuditBloc extends Bloc<AuditEvent, AuditState> {
  final AuditRepository auditRepository;

  AuditBloc(this.auditRepository) : super(AuditIdle()) {
    on<LoadAuditLogs>(_onLoad);
    on<ClearAuditLogs>(_onClear);
  }

  Future<void> _onLoad(LoadAuditLogs event, Emitter<AuditState> emit) async {
    emit(AuditLoading());
    try {
      final logs = auditRepository.getAllLogs();
      emit(AuditLoaded(logs));
    } catch (e) {
      emit(AuditError("Failed to load logs"));
    }
  }

  Future<void> _onClear(ClearAuditLogs event, Emitter<AuditState> emit) async {
    await auditRepository.clearLogs();
    emit(AuditLoaded([]));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/audit/audit_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 591: lib/features/market/presentation/bloc/audit/audit_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/audit/audit_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 290.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class AuditState {}

class AuditIdle extends AuditState {}

class AuditLoading extends AuditState {}

class AuditLoaded extends AuditState {
  final List logs;
  AuditLoaded(this.logs);
}

class AuditError extends AuditState {
  final String message;
  AuditError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/audit/audit_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 592: lib/features/market/presentation/bloc/audit/audit_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/audit/audit_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 116.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

abstract class AuditEvent {}

class LoadAuditLogs extends AuditEvent {}

class ClearAuditLogs extends AuditEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/audit/audit_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 593: lib/features/market/presentation/bloc/market/market_effect.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/market/market_effect.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 281.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

abstract class MarketEffect {}

class ShowToast extends MarketEffect {
  final String message;
  ShowToast(this.message);
}

class NavigateToSettings extends MarketEffect {}

class NotifyTradeOpened extends MarketEffect {
  final String symbol;
  NotifyTradeOpened(this.symbol);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/market/market_effect.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 594: lib/features/market/presentation/bloc/market/market_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/market/market_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 68
================================================================================

import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'market_event.dart';
import 'market_state.dart';
import 'market_effect.dart';
import '../../../domain/models/candle.dart';
import '../../../data/market_repository.dart';
import '../../../domain/streaming/live_stream_adapter.dart';
import '../../../../core/bloc/subscriptions/subscription_manager.dart';

class MarketBloc extends Bloc<MarketEvent, MarketState> {
  final MarketRepository _repo;
  final LiveStreamAdapter _stream;
  final SubscriptionManager _subs = SubscriptionManager();

  MarketBloc(this._repo, this._stream) : super(MarketIdle()) {
    on<LoadHistory>(_onLoadHistory);
    on<StartStreaming>(_onStartStreaming);
    on<StopStreaming>(_onStopStreaming);
  }

  Future<void> _onLoadHistory(
      LoadHistory e, Emitter<MarketState> emit) async {
    emit(MarketLoadingHistory());

    try {
      final candles = await _repo.getCandlesCached(
        e.accountId,
        e.symbol,
        e.timeframe,
      );

      emit(MarketHistoryReady(candles));
    } catch (err) {
      emit(MarketError("Failed to load history"));
    }
  }

  void _onStartStreaming(
      StartStreaming e, Emitter<MarketState> emit) {
    emit(MarketStreaming());

    final sub = _stream.candleStream.listen((candleMap) {
      final candle = Candle(
        time: candleMap["time"],
        open: candleMap["open"],
        high: candleMap["high"],
        low: candleMap["low"],
        close: candleMap["close"],
      );

      add(_MarketTick(candle));
    });

    _subs.add(sub);
  }

  void _onStopStreaming(
      StopStreaming e, Emitter<MarketState> emit) async {
    await _subs.cancelAll();
    emit(MarketIdle());
  }
}

class _MarketTick extends MarketEvent {
  final Candle candle;
  _MarketTick(this.candle);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/market/market_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 595: lib/features/market/presentation/bloc/market/market_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/market/market_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 639.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:equatable/equatable.dart';
import '../../../domain/models/candle.dart';

abstract class MarketState extends Equatable {
  @override
  List<Object?> get props => [];
}

class MarketIdle extends MarketState {}

class MarketLoadingHistory extends MarketState {}

class MarketHistoryReady extends MarketState {
  final List<Candle> candles;
  MarketHistoryReady(this.candles);

  @override
  List<Object?> get props => [candles];
}

class MarketStreaming extends MarketState {}

class MarketError extends MarketState {
  final String message;
  MarketError(this.message);

  @override
  List<Object?> get props => [message];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/market/market_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 596: lib/features/market/presentation/bloc/market/market_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/market/market_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 298.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

abstract class MarketEvent {}

class LoadHistory extends MarketEvent {
  final String accountId;
  final String symbol;
  final String timeframe;

  LoadHistory(this.accountId, this.symbol, this.timeframe);
}

class StartStreaming extends MarketEvent {}

class StopStreaming extends MarketEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/market/market_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 597: lib/features/market/presentation/bloc/ws/ws_manager_bloc_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/ws/ws_manager_bloc_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 506.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/network/ws/smart/ws_smart_manager.dart';
import '../../../../core/network/network_observer.dart';

class WSBloc extends Cubit<void> {
  final WSSmartManager manager;

  WSBloc(this.manager) : super(null);

  void start(String symbol) {
    manager.connect((data) {
      // dispatch into ChartBloc/OrderBookBloc
    });
  }

  @override
  Future<void> close() async {
    manager.dispose(); // clean
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/ws/ws_manager_bloc_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 598: lib/features/market/presentation/bloc/backtest/backtest_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/backtest/backtest_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 468.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import '../../../../features/market/domain/backtest/backtest_result.dart';

abstract class BacktestState {}

class BacktestInitial extends BacktestState {}

class BacktestRunning extends BacktestState {}

class BacktestSuccess extends BacktestState {
  final BacktestResult result;
  BacktestSuccess(this.result);
}

class BacktestError extends BacktestState {
  final String message;
  BacktestError(this.message);
}

class BacktestCancelled extends BacktestState {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/backtest/backtest_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 599: lib/features/market/presentation/bloc/backtest/backtest_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/backtest/backtest_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 463.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

abstract class BacktestEvent {}

class RunBacktest extends BacktestEvent {
  final List<dynamic> history; // List<CandleEntity>
  final String strategyId;      // Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ø³ÙŠØªÙ… ØªØ±Ø¬Ù…ØªÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
  final double takeProfit;
  final double stopLoss;

  RunBacktest({
    required this.history,
    required this.strategyId,
    this.takeProfit = 0,
    this.stopLoss = 0,
  });
}

class CancelBacktest extends BacktestEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/backtest/backtest_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 600: lib/features/market/presentation/bloc/backtest/backtest_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/backtest/backtest_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 48
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'backtest_event.dart';
import 'backtest_state.dart';
import '../../../../features/market/domain/backtest/backtest_engine.dart';
import '../../../../features/strategy/domain/evaluator/example_strategy.dart';
import '../../../../core/models/candle_entity.dart';

class BacktestBloc extends Bloc<BacktestEvent, BacktestState> {
  BacktestBloc() : super(BacktestInitial()) {
    on<RunBacktest>(_onRunBacktest);
    on<CancelBacktest>(_onCancelBacktest);
  }

  bool _cancelRequested = false;

  Future<void> _onRunBacktest(RunBacktest event, Emitter<BacktestState> emit) async {
    emit(BacktestRunning());
    _cancelRequested = false;

    try {
      // ØªØ±Ø¬Ù…Ø© strategyId Ø¥Ù„Ù‰ StrategyEvaluator
      // Ù‡Ù†Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø«Ø§Ù„
      final evaluator = buildExampleStrategy();

      final engine = BacktestEngine(
        history: event.history.cast<CandleEntity>(),
        evaluator: evaluator,
        takeProfit: event.takeProfit,
        stopLoss: event.stopLoss,
      );

      final result = engine.run();

      if (_cancelRequested) {
        emit(BacktestCancelled());
      } else {
        emit(BacktestSuccess(result));
      }
    } catch (e) {
      emit(BacktestError(e.toString()));
    }
  }

  void _onCancelBacktest(CancelBacktest event, Emitter<BacktestState> emit) {
    _cancelRequested = true;
    emit(BacktestCancelled());
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/backtest/backtest_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 601: lib/features/market/presentation/bloc/markets/markets_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/markets/markets_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 378.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

abstract class MarketsState {}

class MarketsIdle extends MarketsState {}

class MarketsLoading extends MarketsState {}

class MarketsLoaded extends MarketsState {
  final List<String> instruments;
  MarketsLoaded(this.instruments);
}

class MarketsEmpty extends MarketsState {}

class MarketsError extends MarketsState {
  final String message;
  MarketsError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/markets/markets_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 602: lib/features/market/presentation/bloc/markets/markets_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/markets/markets_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 64
================================================================================

import 'package:hydrated_bloc/hydrated_bloc.dart';

import 'markets_event.dart';
import 'markets_state.dart';
import '../../../data/repositories/market_repository_impl.dart';
import '../../../data/datasources/local_storage.dart';

class MarketsBloc extends HydratedBloc<MarketsEvent, MarketsState> {
  final MarketRepositoryImpl repository;
  final LocalStorage storage;

  MarketsBloc({
    required this.repository,
    required this.storage,
  }) : super(MarketsIdle()) {
    on<LoadMarkets>(_onLoadMarkets);
  }

  Future<void> _onLoadMarkets(
    LoadMarkets event,
    Emitter<MarketsState> emit,
  ) async {
    emit(MarketsLoading());

    try {
      final list = await repository.fetchAvailableInstruments();

      // Autoâ€‘filter to FX + Metals
      final filtered = list.where((symbol) {
        final s = symbol.toLowerCase();
        return s.contains("usd") || s.contains("xau") || s.contains("xag");
      }).toList();

      if (filtered.isEmpty) {
        emit(MarketsEmpty());
      } else {
        emit(MarketsLoaded(filtered));
      }
    } catch (e) {
      emit(MarketsError("Failed to load markets"));
    }
  }

  @override
  MarketsState? fromJson(Map<String, dynamic> json) {
    final list = (json['instruments'] as List<dynamic>?)
        ?.map((e) => e.toString())
        .toList();
    if (list != null && list.isNotEmpty) {
      return MarketsLoaded(list);
    }
    return MarketsIdle();
  }

  @override
  Map<String, dynamic>? toJson(MarketsState state) {
    if (state is MarketsLoaded) {
      return {
        "instruments": state.instruments,
      };
    }
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/markets/markets_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 603: lib/features/market/presentation/bloc/markets/markets_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/markets/markets_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 114.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

abstract class MarketsEvent {}

/// Trigger loading markets from OANDA
class LoadMarkets extends MarketsEvent {}


================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/markets/markets_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 604: lib/features/market/presentation/bloc/stream/stream_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/stream/stream_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 56
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/streaming/live_stream_adapter.dart';
import '../../../../core/bloc/subscriptions/subscription_manager.dart';

abstract class StreamEvent {}

class ConnectStream extends StreamEvent {
  final String accountId;
  final String symbol;
  ConnectStream(this.accountId, this.symbol);
}

class DisconnectStream extends StreamEvent {}

abstract class StreamState {}

class StreamIdle extends StreamState {}

class StreamConnecting extends StreamState {}

class StreamConnected extends StreamState {}

class StreamError extends StreamState {
  final String message;
  StreamError(this.message);
}

class StreamBloc extends Bloc<StreamEvent, StreamState> {
  final LiveStreamAdapter _adapter;
  final SubscriptionManager _subs = SubscriptionManager();

  StreamBloc(this._adapter) : super(StreamIdle()) {
    on<ConnectStream>(_onConnect);
    on<DisconnectStream>(_onDisconnect);
  }

  void _onConnect(
      ConnectStream e, Emitter<StreamState> emit) {
    emit(StreamConnecting());

    _adapter.start(
      accountId: e.accountId,
      symbol: e.symbol,
      timeframe: Timeframe.m1,
    );

    emit(StreamConnected());
  }

  void _onDisconnect(
      DisconnectStream e, Emitter<StreamState> emit) async {
    _adapter.stop();
    await _subs.cancelAll();
    emit(StreamIdle());
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/stream/stream_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 605: lib/features/market/presentation/bloc/stream/stream_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/stream/stream_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 350.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

part of 'stream_bloc.dart';

abstract class StreamState {}

class StreamInitial extends StreamState {}

class StreamConnecting extends StreamState {}

class StreamConnected extends StreamState {}

class StreamCandle extends StreamState {
  final Map<String, dynamic> candle;
  StreamCandle(this.candle);
}

class StreamStopped extends StreamState {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/stream/stream_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 606: lib/features/market/presentation/bloc/stream/stream_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/stream/stream_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 450.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

part of 'stream_bloc.dart';

abstract class StreamEvent {}

class StartStream extends StreamEvent {
  final String accountId;
  final String symbol;
  final Timeframe timeframe;

  StartStream({
    required this.accountId,
    required this.symbol,
    required this.timeframe,
  });
}

class StreamTickReceived extends StreamEvent {
  final Map<String, dynamic> candle;
  StreamTickReceived(this.candle);
}

class StopStream extends StreamEvent {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/stream/stream_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 607: lib/features/market/presentation/bloc/smart_alert/smart_alert_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/smart_alert/smart_alert_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 413.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import '../../../domain/alerts/smart/smart_alert.dart';

abstract class SmartAlertEvent {}

class AddSmartAlert extends SmartAlertEvent {
  final SmartAlert alert;
  AddSmartAlert(this.alert);
}

class RemoveSmartAlert extends SmartAlertEvent {
  final int index;
  RemoveSmartAlert(this.index);
}

class CheckSmartAlerts extends SmartAlertEvent {
  final dynamic newCandle;
  CheckSmartAlerts(this.newCandle);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/smart_alert/smart_alert_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 608: lib/features/market/presentation/bloc/smart_alert/smart_alert_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/smart_alert/smart_alert_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 944.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/alerts/smart/smart_alert.dart';
import '../../../domain/alerts/smart/engine/smart_alert_engine.dart';
import 'smart_alert_event.dart';
import 'smart_alert_state.dart';

class SmartAlertBloc extends Bloc<SmartAlertEvent, SmartAlertState> {
  final List<CandleEntity> _history = [];
  final List<SmartAlert> _alerts = [];

  SmartAlertBloc() : super(SmartAlertIdle()) {
    on<AddSmartAlert>((event, emit) {
      _alerts.add(event.alert);
      emit(SmartAlertUpdated(List.from(_alerts)));
    });

    on<RemoveSmartAlert>((event, emit) {
      _alerts.removeAt(event.index);
      emit(SmartAlertUpdated(List.from(_alerts)));
    });

    on<CheckSmartAlerts>((event, emit) {
      final engine = SmartAlertEngine(history: _history, activeAlerts: _alerts);
      engine.processNewCandle(event.newCandle);
      emit(SmartAlertUpdated(List.from(_alerts)));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/smart_alert/smart_alert_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 609: lib/features/market/presentation/bloc/smart_alert/smart_alert_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/smart_alert/smart_alert_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 191.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

abstract class SmartAlertState {}

class SmartAlertIdle extends SmartAlertState {}

class SmartAlertUpdated extends SmartAlertState {
  final List alerts;
  SmartAlertUpdated(this.alerts);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/smart_alert/smart_alert_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 610: lib/features/market/presentation/bloc/trading_real/trading_real_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/trading_real/trading_real_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 207.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

import '../../../domain/trading/orders/order_request.dart';

abstract class TradingRealEvent {}

class SubmitRealOrder extends TradingRealEvent {
  final OrderRequest order;
  SubmitRealOrder(this.order);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/trading_real/trading_real_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 611: lib/features/market/presentation/bloc/trading_real/trading_real_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/trading_real/trading_real_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 808.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/repositories/market_repository.dart';
import '../../../domain/trading/orders/order_request.dart';
import 'trading_real_event.dart';
import 'trading_real_state.dart';

class TradingRealBloc extends Bloc<TradingRealEvent, TradingRealState> {
  final MarketRepository repository;

  TradingRealBloc(this.repository) : super(RealTradingIdle()) {
    on<SubmitRealOrder>(_onSubmitOrder);
  }

  Future<void> _onSubmitOrder(
    SubmitRealOrder event,
    Emitter<TradingRealState> emit,
  ) async {
    emit(RealTradingInProgress());
    try {
      final res = await repository.executeOrder(event.order);
      emit(RealTradingSuccess(res));
    } catch (e) {
      emit(RealTradingError("Failed to execute real order: \$e"));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/trading_real/trading_real_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 612: lib/features/market/presentation/bloc/trading_real/trading_real_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/bloc/trading_real/trading_real_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 381.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

abstract class TradingRealState {}

class RealTradingIdle extends TradingRealState {}

class RealTradingInProgress extends TradingRealState {}

class RealTradingSuccess extends TradingRealState {
  final Map<String, dynamic> result;
  RealTradingSuccess(this.result);
}

class RealTradingError extends TradingRealState {
  final String message;
  RealTradingError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/bloc/trading_real/trading_real_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 613: lib/features/market/presentation/screens/market_info_screen.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/screens/market_info_screen.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 458.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter/material.dart';

class MarketInfoScreen extends StatelessWidget {
  final String symbol;
  final String description;

  MarketInfoScreen(this.symbol, this.description);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(symbol)),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Text("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø³ÙˆÙ‚: $description"),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/screens/market_info_screen.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 614: lib/features/market/presentation/widgets/timeframe_selector.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/timeframe_selector.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 53
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_event.dart';

class TimeframeSelector extends StatefulWidget {
  final List<String> frames;

  const TimeframeSelector({required this.frames});

  @override
  _TimeframeSelectorState createState() => _TimeframeSelectorState();
}

class _TimeframeSelectorState extends State<TimeframeSelector> {
  String selected = "M1";

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 50,
      child: ListView(
        scrollDirection: Axis.horizontal,
        children: widget.frames.map((f) {
          final isSelected = f == selected;
          return GestureDetector(
            onTap: () {
              setState(() => selected = f);
              context.read<ChartBloc>().add(ChangeTimeframe(f));
            },
            child: Container(
              margin: EdgeInsets.symmetric(horizontal: 6),
              padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: isSelected ? Colors.blue : Colors.grey.shade800,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Center(
                child: Text(
                  f,
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                  ),
                ),
              ),
            ),
          );
        }).toList(),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/timeframe_selector.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 615: lib/features/market/presentation/widgets/crosshair_overlay.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/crosshair_overlay.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 585.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter/material.dart';

class CrosshairOverlay extends StatelessWidget {
  final Offset position;
  CrosshairOverlay({required this.position});

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Positioned(
          left: position.dx,
          top: 0,
          bottom: 0,
          child: Container(width: 1, color: Colors.grey),
        ),
        Positioned(
          top: position.dy,
          left: 0,
          right: 0,
          child: Container(height: 1, color: Colors.grey),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/crosshair_overlay.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 616: lib/features/market/presentation/widgets/smart_alert_dialog.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/smart_alert_dialog.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 61
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/alerts/smart/smart_alert.dart';

class SmartAlertDialog extends StatefulWidget {
  final String symbol;
  SmartAlertDialog({required this.symbol});

  @override
  _SmartAlertDialogState createState() => _SmartAlertDialogState();
}

class _SmartAlertDialogState extends State<SmartAlertDialog> {
  SmartAlertType _selectedType = SmartAlertType.rsiBelow;
  final TextEditingController _threshold = TextEditingController();
  final TextEditingController _duration = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Add Smart Alert"),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          DropdownButton<SmartAlertType>(
            value: _selectedType,
            items: SmartAlertType.values
                .map((t) => DropdownMenuItem(value: t, child: Text(t.toString())))
                .toList(),
            onChanged: (v) => setState(() => _selectedType = v!),
          ),
          TextField(
            controller: _threshold,
            decoration: InputDecoration(labelText: "Threshold"),
            keyboardType: TextInputType.numberWithOptions(decimal: true),
          ),
          TextField(
            controller: _duration,
            decoration: InputDecoration(labelText: "Duration (seconds)"),
            keyboardType: TextInputType.number,
          ),
        ],
      ),
      actions: [
        ElevatedButton(
          onPressed: () {
            final th = double.tryParse(_threshold.text) ?? 0;
            final dur = int.tryParse(_duration.text) ?? 0;
            final condition = SmartAlertCondition(
              type: _selectedType,
              durationSeconds: dur,
              threshold: th,
            );
            final alert = SmartAlert(instrument: widget.symbol, condition: condition);
            Navigator.pop(context, alert);
          },
          child: Text("Add"),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/smart_alert_dialog.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 617: lib/features/market/presentation/widgets/trading_positions_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/trading_positions_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 922.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/trading/trading_bloc.dart';
import '../bloc/trading/trading_state.dart';

class TradingPositionsWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<TradingBloc, TradingState>(
      builder: (context, state) {
        if (state is TradingUpdated) {
          return ListView(
            children: [
              ...state.openPositions.map((p) => ListTile(
                title: Text("${p.instrument}: ${p.type}"),
                subtitle: Text("Entry: ${p.entryPrice}"),
              )),
              Divider(),
              ...state.tradeHistory.map((h) => ListTile(
                title: Text("Closed: ${h.profit.toStringAsFixed(2)}"),
              )),
            ],
          );
        }
        return Text("No trades yet");
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/trading_positions_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 618: lib/features/market/presentation/widgets/webview_chart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/webview_chart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 667.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class WebViewChart extends StatefulWidget {
  final Function(String) onCreated;
  WebViewChart({required this.onCreated});

  @override
  _WebViewChartState createState() => _WebViewChartState();
}

class _WebViewChartState extends State<WebViewChart> {
  late WebViewController webController;

  @override
  Widget build(BuildContext context) {
    return WebView(
      initialUrl: 'assets/chart.html',
      javascriptMode: JavascriptMode.unrestricted,
      onWebViewCreated: (ctrl) {
        webController = ctrl;
        widget.onCreated("");
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/webview_chart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 619: lib/features/market/presentation/widgets/market_list_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/market_list_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 501.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter/material.dart';

class MarketListWidget extends StatelessWidget {
  final List<String> instruments;

  MarketListWidget({required this.instruments});

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: instruments.length,
      itemBuilder: (ctx, i) {
        final symbol = instruments[i];
        return ListTile(
          title: Text(symbol),
          trailing: Icon(Icons.arrow_forward_ios),
        );
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/market_list_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 620: lib/features/market/presentation/widgets/candlestick_chart_real.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/candlestick_chart_real.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 583.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:flutter/material.dart';
import 'package:candlesticks/candlesticks.dart';
import '../../domain/entities/candle.dart';

class RealCandleStickChart extends StatelessWidget {
  final List<CandleEntity> candles;

  RealCandleStickChart({required this.candles});

  @override
  Widget build(BuildContext context) {
    final items = candles.map((c) => Candle(
      date: c.time,
      open: c.open,
      high: c.high,
      low: c.low,
      close: c.close,
      volume: c.volume.toDouble(),
    )).toList();

    return Candlesticks(
      candles: items,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/candlestick_chart_real.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 621: lib/features/market/presentation/widgets/signal_marker.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/signal_marker.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 650.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter/material.dart';

class SignalMarker extends StatelessWidget {
  final bool isBuy;
  final Offset position;
  final String label;

  SignalMarker({
    required this.isBuy,
    required this.position,
    required this.label,
  });

  @override
  Widget build(BuildContext context) {
    return Positioned(
      left: position.dx,
      top: position.dy,
      child: Column(
        children: [
          Icon(
            isBuy ? Icons.arrow_circle_up : Icons.arrow_circle_down,
            color: isBuy ? Colors.green : Colors.red,
            size: 28,
          ),
          Text(label),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/signal_marker.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 622: lib/features/market/presentation/widgets/subchart_rsi_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/subchart_rsi_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

import 'package:flutter/material.dart';
import '../../../market/domain/chart/x_axis_range.dart';
import 'chart_utils/chart_mapper.dart';

class RSIChartPainter extends CustomPainter {
  final List<DateTime> times;
  final List<double> values;
  final XAxisRange visibleRange;

  RSIChartPainter({required this.times, required this.values, required this.visibleRange});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()..color = Colors.purple..strokeWidth = 1.5;

    double maxVal = values.reduce((a, b) => a > b ? a : b);
    double minVal = values.reduce((a, b) => a < b ? a : b);

    Path path = Path();
    bool started = false;

    for (int i = 0; i < times.length; i++) {
      if (!visibleRange.contains(times[i])) continue;

      final x = timeToPx(times[i], visibleRange, size.width);
      final y = priceToPx(values[i], minVal, maxVal, size.height);

      if (!started) {
        path.moveTo(x, y);
        started = true;
      } else {
        path.lineTo(x, y);
      }
    }
    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant RSIChartPainter old) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/subchart_rsi_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 623: lib/features/market/presentation/widgets/overlay_indicators_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/overlay_indicators_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 51
================================================================================

import 'package:flutter/material.dart';
import '../../../market/domain/indicators/types/indicator_series.dart';
import 'chart_utils/chart_mapper.dart';
import '../../../market/domain/chart/x_axis_range.dart';

class OverlayIndicatorsPainter extends CustomPainter {
  final List<IndicatorSeries> seriesList;
  final List<DateTime> times;
  final XAxisRange visibleRange;
  final double minPrice;
  final double maxPrice;

  OverlayIndicatorsPainter({
    required this.seriesList,
    required this.times,
    required this.visibleRange,
    required this.minPrice,
    required this.maxPrice,
  });

  @override
  void paint(Canvas canvas, Size size) {
    for (var series in seriesList) {
      final paint = Paint()
        ..color = series.color
        ..strokeWidth = 2
        ..style = PaintingStyle.stroke;

      Path path = Path();
      bool started = false;

      for (int i = 0; i < times.length; i++) {
        if (!visibleRange.contains(times[i])) continue;

        final x = timeToPx(times[i], visibleRange, size.width);
        final y = priceToPx(series.values[i], minPrice, maxPrice, size.height);

        if (!started) {
          path.moveTo(x, y);
          started = true;
        } else {
          path.lineTo(x, y);
        }
      }
      canvas.drawPath(path, paint);
    }
  }

  @override
  bool shouldRepaint(covariant OverlayIndicatorsPainter old) => true;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/overlay_indicators_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 624: lib/features/market/presentation/widgets/candles_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/candles_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 48
================================================================================

import 'package:flutter/material.dart';
import '../../../market/domain/entities/candle.dart';
import 'chart_utils/chart_mapper.dart';
import '../../../market/domain/chart/x_axis_range.dart';

class CandlesPainter extends CustomPainter {
  final List<CandleEntity> candles;
  final XAxisRange visibleRange;

  CandlesPainter({required this.candles, required this.visibleRange});

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty) return;

    double minPrice = candles.map((c) => c.low).reduce((a, b) => a < b ? a : b);
    double maxPrice = candles.map((c) => c.high).reduce((a, b) => a > b ? a : b);

    final paintBull = Paint()..color = Colors.green;
    final paintBear = Paint()..color = Colors.red;

    for (var c in candles) {
      if (!visibleRange.contains(c.time)) continue;

      final x = timeToPx(c.time, visibleRange, size.width);
      final yHigh = priceToPx(c.high, minPrice, maxPrice, size.height);
      final yLow = priceToPx(c.low, minPrice, maxPrice, size.height);
      final yOpen = priceToPx(c.open, minPrice, maxPrice, size.height);
      final yClose = priceToPx(c.close, minPrice, maxPrice, size.height);

      final isBull = c.close >= c.open;
      final paint = isBull ? paintBull : paintBear;

      // Wick
      canvas.drawLine(Offset(x, yHigh), Offset(x, yLow), paint);

      // Body
      final bodyTop = isBull ? yClose : yOpen;
      final bodyBottom = isBull ? yOpen : yClose;
      canvas.drawRect(Rect.fromLTRB(x - 2, bodyTop, x + 2, bodyBottom), paint);
    }
  }

  @override
  bool shouldRepaint(covariant CandlesPainter old) {
    return old.visibleRange != visibleRange || old.candles != candles;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/candles_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 625: lib/features/market/presentation/widgets/candlestick_chart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/candlestick_chart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 847.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';

class CandleStick {
  final double x, open, high, low, close;
  CandleStick({
    required this.x,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });
}

class CandleStickChart extends StatelessWidget {
  final List<CandleStick> data;

  CandleStickChart({required this.data});

  @override
  Widget build(BuildContext context) {
    return BarChart(
      BarChartData(
        barGroups: data.map((c) {
          return BarChartGroupData(x: c.x.toInt(), barRods: [
            BarChartRodData(
              toY: c.high,
              fromY: c.low,
              color: c.close >= c.open ? Colors.green : Colors.red,
              width: 5,
            ),
          ]);
        }).toList(),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/candlestick_chart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 626: lib/features/market/presentation/widgets/instrument_list_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/instrument_list_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 60
================================================================================

import 'package:flutter/material.dart';
import '../pages/market_chart_page.dart';
import '../pages/backtest/backtest_page.dart';
import '../../data/repositories/market_repository_impl.dart';
import '../../data/datasources/local_storage.dart';

class InstrumentListWidget extends StatelessWidget {
  final List<String> instruments;

  InstrumentListWidget({required this.instruments});

  @override
  Widget build(BuildContext context) {
    final localStorage = LocalStorage();
    final repo = MarketRepositoryImpl(localStorage: localStorage);

    return ListView.builder(
      itemCount: instruments.length,
      itemBuilder: (ctx, i) {
        final symbol = instruments[i];
        return ListTile(
          title: Text(symbol),
          subtitle: Row(
            children: [
              ElevatedButton(
                child: Text("Chart"),
                onPressed: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => MarketChartPage(
                        repository: repo,
                        instrument: symbol,
                      ),
                    ),
                  );
                },
              ),
              SizedBox(width: 8),
              ElevatedButton(
                child: Text("Backtest"),
                onPressed: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => BacktestPage(
                        repository: repo,
                        instrument: symbol,
                      ),
                    ),
                  );
                },
              ),
            ],
          ),
        );
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/instrument_list_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 627: lib/features/market/presentation/widgets/real_trade_dialog.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/real_trade_dialog.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 68
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/trading_real/trading_real_bloc.dart';
import '../../bloc/trading_real/trading_real_event.dart';
import '../../../domain/trading/orders/order_request.dart';

class RealTradeDialog extends StatefulWidget {
  final String symbol;
  RealTradeDialog({required this.symbol});

  @override
  _RealTradeDialogState createState() => _RealTradeDialogState();
}

class _RealTradeDialogState extends State<RealTradeDialog> {
  final TextEditingController _unitsCtrl = TextEditingController();
  String _type = "MARKET";
  final priceCtrl = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Place Real Order"),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(
            controller: _unitsCtrl,
            decoration: InputDecoration(labelText: "Units (+ buy, - sell)"),
            keyboardType: TextInputType.number,
          ),
          DropdownButton<String>(
            value: _type,
            items: ["MARKET", "LIMIT", "STOP"]
                .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                .toList(),
            onChanged: (v) => setState(() => _type = v!),
          ),
          if (_type != "MARKET")
            TextField(
              controller: priceCtrl,
              decoration: InputDecoration(labelText: "Price"),
              keyboardType: TextInputType.numberWithOptions(decimal: true),
            ),
        ],
      ),
      actions: [
        ElevatedButton(
          onPressed: () {
            final units = int.tryParse(_unitsCtrl.text) ?? 0;
            final price = _type == "MARKET"
                ? null
                : double.tryParse(priceCtrl.text);
            final request = OrderRequest(
              instrument: widget.symbol,
              units: units,
              type: _type,
              price: price,
            );
            context.read<TradingRealBloc>().add(SubmitRealOrder(request));
            Navigator.pop(context);
          },
          child: Text("Submit"),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/real_trade_dialog.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 628: lib/features/market/presentation/widgets/price_alert_dialog.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/price_alert_dialog.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 69
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/alerts/alert_bloc.dart';
import '../bloc/alerts/alert_event.dart';
import '../../domain/alerts/price_alert.dart';

class PriceAlertDialog extends StatefulWidget {
  final String symbol;
  PriceAlertDialog({required this.symbol});

  @override
  _PriceAlertDialogState createState() => _PriceAlertDialogState();
}

class _PriceAlertDialogState extends State<PriceAlertDialog> {
  final TextEditingController _priceCtrl = TextEditingController();
  bool triggerAbove = true;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Add Price Alert"),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(
            controller: _priceCtrl,
            keyboardType: TextInputType.number,
            decoration: InputDecoration(labelText: "Target Price"),
          ),
          Row(
            children: [
              Text("Trigger when:"),
              Switch(
                value: triggerAbove,
                onChanged: (v) => setState(() => triggerAbove = v),
              ),
              Text(triggerAbove ? "Above" : "Below"),
            ],
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text("Cancel"),
        ),
        ElevatedButton(
          onPressed: () {
            final price = double.tryParse(_priceCtrl.text);
            if (price != null) {
              context.read<AlertBloc>().add(
                    AddPriceAlert(
                      PriceAlert(
                        price: price,
                        triggerAbove: triggerAbove,
                        symbol: widget.symbol,
                      ),
                    ),
                  );
              Navigator.pop(context);
            }
          },
          child: Text("Add"),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/price_alert_dialog.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 629: lib/features/market/presentation/widgets/chart_screen_lifecycle_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/chart_screen_lifecycle_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 624.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter/material.dart';
import 'chart_widget.dart';
import 'package:webview_flutter/webview_flutter.dart';

class ChartScreen extends StatefulWidget {
  @override
  _ChartScreenState createState() => _ChartScreenState();
}

class _ChartScreenState extends State<ChartScreen> {
  WebViewController? _controller;

  @override
  void dispose() {
    _controller = null; // ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù€GC Ø¨Ø¥Ù†Ù‡Ø§Ø¡ WebView
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return WebView(
      onWebViewCreated: (ctrl) => _controller = ctrl,
      initialUrl: "about:blank",
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/chart_screen_lifecycle_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 630: lib/features/market/presentation/widgets/indicator_overlay.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/indicator_overlay.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 891.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import 'package:flutter/material.dart';

class IndicatorOverlay extends StatelessWidget {
  final List<List<Offset>> indicatorLines;

  IndicatorOverlay({required this.indicatorLines});

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _IndicatorPainter(indicatorLines),
      child: Container(),
    );
  }
}

class _IndicatorPainter extends CustomPainter {
  final List<List<Offset>> indicatorLines;

  _IndicatorPainter(this.indicatorLines);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..strokeWidth = 1.5
      ..style = PaintingStyle.stroke;

    for (var series in indicatorLines) {
      paint.color = Colors.green;
      canvas.drawPoints(PointMode.polygon, series, paint);
    }
  }

  @override
  bool shouldRepaint(covariant _IndicatorPainter old) =>
      old.indicatorLines != indicatorLines;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/indicator_overlay.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 631: lib/features/market/presentation/widgets/chart_utils/chart_mapper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/chart_utils/chart_mapper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 681.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'dart:ui';
import '../../../market/domain/chart/x_axis_range.dart';

/// Convert a timestamp (DateTime) to an X pixel
double timeToPx(DateTime t, XAxisRange range, double width) {
  final total = range.max.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  if (total == 0) return 0.0;
  final delta = t.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  return (delta / total) * width;
}

/// Convert a price to a Y pixel (inverted coordinate system)
double priceToPx(double price, double minPrice, double maxPrice, double height) {
  if (maxPrice - minPrice == 0) return height / 2;
  return height * (1 - (price - minPrice) / (maxPrice - minPrice));
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/chart_utils/chart_mapper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 632: lib/features/market/presentation/widgets/custom_chart/drawing_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/drawing_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 978.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 44
================================================================================

import 'package:flutter/material.dart';

class DrawingPainter extends CustomPainter {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  DrawingPainter({
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paintTrend = Paint()
      ..color = Colors.yellow
      ..strokeWidth = 2.0;

    final paintHLine = Paint()
      ..color = Colors.orange
      ..strokeWidth = 1.0;

    // Trendlines
    for (var line in trendlines) {
      if (line.length >= 2) {
        canvas.drawLine(line[0], line[1], paintTrend);
      }
    }

    // Horizontal lines
    for (var y in horizontalLines) {
      canvas.drawLine(
        Offset(0, y),
        Offset(size.width, y),
        paintHLine,
      );
    }
  }

  @override
  bool shouldRepaint(covariant DrawingPainter old) {
    return old.trendlines != trendlines ||
        old.horizontalLines != horizontalLines;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/drawing_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 633: lib/features/market/presentation/widgets/custom_chart/candles_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/candles_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.9 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 67
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/entities/candle.dart';

class CandlesPainter extends CustomPainter {
  final List<CandleEntity> candles;
  final double candleWidth;

  CandlesPainter({
    required this.candles,
    this.candleWidth = 6.0,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty) return;

    final paintRise = Paint()..color = Colors.green;
    final paintFall = Paint()..color = Colors.red;
    final paintLine = Paint()..color = Colors.black;

    // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ§Ù„Ø¯Ù†ÙŠØ§ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø±Ø³Ù…
    final highs = candles.map((c) => c.high).toList();
    final lows = candles.map((c) => c.low).toList();

    final maxPrice = highs.reduce((a, b) => a > b ? a : b);
    final minPrice = lows.reduce((a, b) => a < b ? a : b);

    final priceRange = maxPrice - minPrice;

    final count = candles.length;
    final spacing = candleWidth + 2.0;
    final chartWidth = count * spacing;

    for (int i = 0; i < count; i++) {
      final c = candles[i];

      final x = i * spacing;
      final highY = size.height - ((c.high - minPrice) / priceRange) * size.height;
      final lowY = size.height - ((c.low - minPrice) / priceRange) * size.height;
      final openY = size.height - ((c.open - minPrice) / priceRange) * size.height;
      final closeY = size.height - ((c.close - minPrice) / priceRange) * size.height;

      final isRise = c.close >= c.open;
      final paint = isRise ? paintRise : paintFall;

      // Ø®Ø·ÙˆØ· High-Low
      canvas.drawLine(
        Offset(x + candleWidth / 2, highY),
        Offset(x + candleWidth / 2, lowY),
        paintLine,
      );

      // Ù…Ø³ØªØ·ÙŠÙ„ Open-Close
      final rect = Rect.fromLTRB(
        x,
        openY,
        x + candleWidth,
        closeY,
      );
      canvas.drawRect(rect, paint);
    }
  }

  @override
  bool shouldRepaint(covariant CandlesPainter old) =>
      old.candles != candles;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/candles_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 634: lib/features/market/presentation/widgets/custom_chart/custom_chart_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/custom_chart_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 59
================================================================================

import 'package:flutter/material.dart';
import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_state.dart';
import 'candles_painter.dart';
import 'indicator_painter.dart';
import 'drawing_painter.dart';

class CustomChartWidget extends StatelessWidget {
  final ChartState state;
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  CustomChartWidget({
    required this.state,
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  Widget build(BuildContext context) {
    if (state is ChartLoaded) {
      final candles = (state as ChartLoaded).candles;

      // Ø¨Ù†Ø§Ø¡ Ù†Ù‚Ø§Ø· Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
      final ema50 = List<Offset>.generate(
        candles.length,
        (i) => Offset(i.toDouble(), (state as ChartLoaded).indicators[0].values[i]),
      );
      final ema200 = List<Offset>.generate(
        candles.length,
        (i) => Offset(i.toDouble(), (state as ChartLoaded).indicators[1].values[i]),
      );

      return LayoutBuilder(builder: (context, constraints) {
        return CustomPaint(
          size: Size(constraints.maxWidth, constraints.maxHeight),
          painter: CandlesPainter(candles: candles),
          foregroundPainter: DrawingPainter(
            trendlines: trendlines,
            horizontalLines: horizontalLines,
          ),
          child: Stack(
            children: [
              CustomPaint(
                size: Size(constraints.maxWidth, constraints.maxHeight),
                painter: IndicatorPainter(linePoints: ema50, color: Colors.blue),
              ),
              CustomPaint(
                size: Size(constraints.maxWidth, constraints.maxHeight),
                painter: IndicatorPainter(linePoints: ema200, color: Colors.orange),
              ),
            ],
          ),
        );
      });
    }
    return Container();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/custom_chart_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 635: lib/features/market/presentation/widgets/custom_chart/indicator_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/indicator_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 588.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter/material.dart';

class IndicatorPainter extends CustomPainter {
  final List<Offset> linePoints;
  final Color color;

  IndicatorPainter({required this.linePoints, required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    if (linePoints.isEmpty) return;

    final paint = Paint()
      ..color = color
      ..strokeWidth = 1.5
      ..style = PaintingStyle.stroke;

    canvas.drawPoints(PointMode.polygon, linePoints, paint);
  }

  @override
  bool shouldRepaint(covariant IndicatorPainter old) =>
      old.linePoints != linePoints;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/indicator_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 636: lib/features/market/presentation/widgets/custom_chart/subchart_rsi_painter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/subchart_rsi_painter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 33
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/chart/x_axis_range.dart';
import '../utils/chart_mapping.dart';

class RSIChartPainter extends CustomPainter {
  final List<DateTime> times;
  final List<double> values;
  final XAxisRange visibleRange;

  RSIChartPainter({required this.times, required this.values, required this.visibleRange});

  @override
  void paint(Canvas canvas, Size size) {
    final paintRsi = Paint()..color = Colors.purple..strokeWidth = 1.5;

    double maxVal = values.reduce((a, b) => a > b ? a : b);
    double minVal = values.reduce((a, b) => a < b ? a : b);

    for (int i = 0; i < times.length; i++) {
      if (!visibleRange.contains(times[i])) continue;
      final x = mapTimeToX(times[i], visibleRange, size.width);
      final y = mapPriceToY(values[i], minVal, maxVal, size.height);
      if (i > 0 && visibleRange.contains(times[i-1])) {
        final prevX = mapTimeToX(times[i-1], visibleRange, size.width);
        final prevY = mapPriceToY(values[i-1], minVal, maxVal, size.height);
        canvas.drawLine(Offset(prevX, prevY), Offset(x, y), paintRsi);
      }
    }
  }

  @override
  bool shouldRepaint(covariant RSIChartPainter old) => old.times != times || old.visibleRange != visibleRange;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/subchart_rsi_painter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 637: lib/features/market/presentation/widgets/custom_chart/multi_indicator_chart.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/multi_indicator_chart.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 48
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/indicators/types/indicator_series.dart';

class MultiIndicatorChart extends StatelessWidget {
  final List<double> prices;
  final List<IndicatorSeries> indicators;

  MultiIndicatorChart({
    required this.prices,
    required this.indicators,
  });

  @override
  Widget build(BuildContext context) {
    final overlaySeries =
        indicators.where((i) => i.displayMode == IndicatorDisplayMode.overlay);
    final subCharts =
        indicators.where((i) => i.displayMode == IndicatorDisplayMode.subChart);

    return Column(
      children: [
        // Main Chart with overlay
        Expanded(
          flex: 3,
          child: Stack(
            children: [
              CandlesPainter(candles: prices), // Ø§ÙØªØ±Ø¶Ù†Ø§ Ø£Ù†Ù‡ ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù€ OHLC Ø®Ø·ÙˆØ·
              ...overlaySeries.map((ind) => IndicatorPainter(values: ind.values)),
            ],
          ),
        ),

        // Subâ€‘chart indicators
        Expanded(
          flex: 1,
          child: ListView(
            children: subCharts.map((ind) {
              return SizedBox(
                height: 120,
                child: IndicatorSubChartPainter(values: ind.values, label: ind.label),
              );
            }).toList(),
          ),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/multi_indicator_chart.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 638: lib/features/market/presentation/widgets/custom_chart/utils/chart_mapping.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/custom_chart/utils/chart_mapping.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 563.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/chart/x_axis_range.dart';
import '../../../domain/entities/candle.dart';

double mapTimeToX(DateTime time, XAxisRange range, double width) {
  final total = range.max.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  final delta = time.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  return (delta / total) * width;
}

double mapPriceToY(double price, double minPrice, double maxPrice, double height) {
  return height * (1 - ((price - minPrice) / (maxPrice - minPrice)));
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/custom_chart/utils/chart_mapping.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 639: lib/features/market/presentation/widgets/backtest/backtest_report_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/backtest/backtest_report_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 599.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter/material.dart';
import '../../../domain/backtest/backtest_result.dart';

class BacktestReportWidget extends StatelessWidget {
  final BacktestResult result;

  BacktestReportWidget({required this.result});

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text("Net Profit: ${result.netProfit.toStringAsFixed(2)}"),
        Text("Win Rate: ${result.winRate.toStringAsFixed(2)}%"),
        Text("Max Drawdown: ${result.maxDrawdown.toStringAsFixed(2)}%"),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/backtest/backtest_report_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 640: lib/features/market/presentation/widgets/backtest/equity_curve_widget.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/backtest/equity_curve_widget.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 639.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import '../../../domain/backtest/backtest_result.dart';

class EquityCurveWidget extends StatelessWidget {
  final BacktestResult result;

  EquityCurveWidget({required this.result});

  @override
  Widget build(BuildContext context) {
    final spots = result.equityCurve.asMap().entries.map((entry) {
      return FlSpot(entry.key.toDouble(), entry.value);
    }).toList();

    return LineChart(
      LineChartData(
        lineBarsData: [
          LineChartBarData(spots: spots, isCurved: true, colors: [Colors.blue]),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/backtest/equity_curve_widget.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 641: lib/features/market/presentation/widgets/drawing_tools/drawing_overlay.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/presentation/widgets/drawing_tools/drawing_overlay.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 65
================================================================================

import 'package:flutter/material.dart';

class DrawingOverlay extends StatelessWidget {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  DrawingOverlay({
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _OverlayPainter(
        trendlines: trendlines,
        horizontalLines: horizontalLines,
      ),
      child: Container(),
    );
  }
}

class _OverlayPainter extends CustomPainter {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  _OverlayPainter({
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paintLine = Paint()
      ..color = Colors.yellow
      ..strokeWidth = 2;

    final paintHLine = Paint()
      ..color = Colors.orange
      ..strokeWidth = 1;

    // Trendlines
    for (var line in trendlines) {
      if (line.length >= 2) {
        canvas.drawLine(line[0], line[1], paintLine);
      }
    }

    // Horizontal lines
    for (var y in horizontalLines) {
      canvas.drawLine(
        Offset(0, y),
        Offset(size.width, y),
        paintHLine,
      );
    }
  }

  @override
  bool shouldRepaint(covariant _OverlayPainter old) {
    return old.trendlines != trendlines ||
        old.horizontalLines != horizontalLines;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/presentation/widgets/drawing_tools/drawing_overlay.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 642: lib/features/market/domain/candle_deduper.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/candle_deduper.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 313.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../core/models/candle_entity.dart';

class CandleDeduper {
  final Set<int> _seenTimestamps = {};

  bool isDuplicate(CandleEntity candle) {
    final ts = candle.timeUtc.millisecondsSinceEpoch;
    if (_seenTimestamps.contains(ts)) return true;
    _seenTimestamps.add(ts);
    return false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/candle_deduper.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 643: lib/features/market/domain/strategy/strategy_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/strategy/strategy_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 76
================================================================================

import '../entities/candle.dart';
import '../indicators/ema_calculator.dart';
import '../indicators/stochastic_calculator.dart';
import 'strategy_config.dart';

enum TradeSignal { BUY, SELL, NONE }

class StrategyManager {
  final List<CandleEntity> data;
  final StrategyConfig config;

  DateTime? _lastSignalTime;
  TradeSignal _lastSignal = TradeSignal.NONE;

  StrategyManager(this.data, this.config);

  TradeSignal evaluate() {
    if (data.length < config.emaLong) return TradeSignal.NONE;

    final emaShortVals = EmaCalculator.calculate(
      data: data,
      period: config.emaShort,
    ).values;

    final emaLongVals = EmaCalculator.calculate(
      data: data,
      period: config.emaLong,
    ).values;

    final stoch = StochasticCalculator.calculate(
      data: data,
      period: config.stochPeriod,
      smoothK: config.stochSmoothK,
      smoothD: config.stochSmoothD,
    );

    final int idx = data.length - 1;

    final bool bullCond = emaShortVals[idx] > emaLongVals[idx] &&
        stoch.kValues[idx] > stoch.dValues[idx] &&
        stoch.kValues[idx] < 80;

    final bool bearCond = emaShortVals[idx] < emaLongVals[idx] &&
        stoch.kValues[idx] < stoch.dValues[idx] &&
        stoch.kValues[idx] > 20;

    final now = data[idx].time;

    if (bullCond && _canSignal(now, TradeSignal.BUY)) {
      _updateLastSignal(now, TradeSignal.BUY);
      return TradeSignal.BUY;
    }

    if (bearCond && _canSignal(now, TradeSignal.SELL)) {
      _updateLastSignal(now, TradeSignal.SELL);
      return TradeSignal.SELL;
    }

    return TradeSignal.NONE;
  }

  bool _canSignal(DateTime now, TradeSignal signal) {
    if (_lastSignal == signal && _lastSignalTime != null) {
      final diff = now.difference(_lastSignalTime!).inSeconds;
      if (diff < config.minSignalIntervalSeconds) {
        return false;
      }
    }
    return true;
  }

  void _updateLastSignal(DateTime now, TradeSignal signal) {
    _lastSignalTime = now;
    _lastSignal = signal;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/strategy/strategy_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 644: lib/features/market/domain/strategy/strategy_config.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/strategy/strategy_config.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 528.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

class StrategyConfig {
  final int emaShort;
  final int emaLong;
  final int stochPeriod;
  final int stochSmoothK;
  final int stochSmoothD;
  final double stopLossPct;
  final double takeProfitPct;
  final double minSignalIntervalSeconds;

  StrategyConfig({
    required this.emaShort,
    required this.emaLong,
    required this.stochPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
    required this.stopLossPct,
    required this.takeProfitPct,
    required this.minSignalIntervalSeconds,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/strategy/strategy_config.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 645: lib/features/market/domain/strategy/multi/strategy_set.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/strategy/multi/strategy_set.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 297.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import '../../strategy/strategy_config.dart';

class StrategyInstance {
  final String id;
  final StrategyConfig config;

  StrategyInstance({required this.id, required this.config});
}

class StrategySet {
  final List<StrategyInstance> strategies;

  StrategySet({required this.strategies});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/strategy/multi/strategy_set.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 646: lib/features/market/domain/strategy/multi/multi_strategy_runner.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/strategy/multi/multi_strategy_runner.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 679.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import '../strategy_config.dart';
import '../../backtest/backtest_engine.dart';
import 'strategy_set.dart';

class MultiStrategyResult {
  final Map<String, dynamic> results;
  MultiStrategyResult({required this.results});
}

class MultiStrategyRunner {
  final StrategySet strategySet;

  MultiStrategyRunner(this.strategySet);

  Future<MultiStrategyResult> runBacktestAll(List<dynamic> history) async {
    final Map<String, dynamic> out = {};

    for (var inst in strategySet.strategies) {
      final engine = BacktestEngine(history, config: inst.config);
      final res = engine.run();
      out[inst.id] = res;
    }

    return MultiStrategyResult(results: out);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/strategy/multi/multi_strategy_runner.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 647: lib/features/market/domain/entities/tick.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/entities/tick.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 176.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

class TickEntity {
  final DateTime time;
  final double bid;
  final double ask;

  TickEntity({
    required this.time,
    required this.bid,
    required this.ask,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/entities/tick.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 648: lib/features/market/domain/entities/candle.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/entities/candle.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 456.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:equatable/equatable.dart';

class Candle extends Equatable {
  final DateTime time;
  final double open;
  final double high;
  final double low;
  final double close;
  final int? volume;

  const Candle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    this.volume,
  });

  @override
  List<Object?> get props =>
      [time, open, high, low, close, volume];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/entities/candle.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 649: lib/features/market/domain/entities/instrument.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/entities/instrument.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 449.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:equatable/equatable.dart';

class Instrument extends Equatable {
  final String name;
  final String display;
  final int displayPrecision;
  final int tradeUnitsPrecision;

  const Instrument({
    required this.name,
    required this.display,
    required this.displayPrecision,
    required this.tradeUnitsPrecision,
  });

  @override
  List<Object?> get props =>
      [name, display, displayPrecision, tradeUnitsPrecision];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/entities/instrument.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 650: lib/features/market/domain/timeframes/timeframe.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/timeframes/timeframe.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 631.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 34
================================================================================

enum Timeframe {
  m1,
  m5,
  m15,
  h1,
}

extension TimeframeExt on Timeframe {
  Duration get duration {
    switch (this) {
      case Timeframe.m1:
        return Duration(minutes: 1);
      case Timeframe.m5:
        return Duration(minutes: 5);
      case Timeframe.m15:
        return Duration(minutes: 15);
      case Timeframe.h1:
        return Duration(hours: 1);
    }
  }

  String get oandaName {
    switch (this) {
      case Timeframe.m1:
        return "M1";
      case Timeframe.m5:
        return "M5";
      case Timeframe.m15:
        return "M15";
      case Timeframe.h1:
        return "H1";
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/timeframes/timeframe.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 651: lib/features/market/domain/analytics/analytics_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/analytics/analytics_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 29.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

class AnalyticsCalculator {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/analytics/analytics_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 652: lib/features/market/domain/usecases/evaluate_strategy.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/evaluate_strategy.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 89.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

import '../entities/candle_entity.dart';

List<CandleEntity> evaluate() {
  return [];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/evaluate_strategy.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 653: lib/features/market/domain/usecases/run_backtest.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/run_backtest.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 521.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'package:flutter_trading_app/features/market/domain/backtest/backtest_result.dart' as result;
import 'package:flutter_trading_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:flutter_trading_app/features/market/domain/repositories/market_repository.dart';

class RunBacktest {
  final MarketRepository marketRepository;

  RunBacktest(this.marketRepository);

  Future<result.BacktestResult> execute() async {
    final engine = BacktestEngine();
    return await engine.execute();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/run_backtest.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 654: lib/features/market/domain/usecases/get_saved_credentials.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/get_saved_credentials.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 259.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import '../repositories/market_repository.dart';

class GetSavedCredentials {
  final MarketRepository repository;

  GetSavedCredentials(this.repository);

  Future<Map<String, String>> call() async {
    return await repository.getOandaCredentials();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/get_saved_credentials.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 655: lib/features/market/domain/usecases/save_oanda_credentials.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/save_oanda_credentials.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 357.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../repositories/market_repository.dart';

class SaveOandaCredentials {
  final MarketRepository repository;

  SaveOandaCredentials(this.repository);

  Future<void> call({
    required String token,
    required String accountId,
  }) async {
    return repository.saveOandaCredentials(
      token: token,
      accountId: accountId,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/save_oanda_credentials.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 656: lib/features/market/domain/usecases/get_historical_candles.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/get_historical_candles.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 428.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import '../entities/candle.dart';
import '../repositories/market_repository.dart';

class GetHistoricalCandles {
  final MarketRepository repository;

  GetHistoricalCandles(this.repository);

  Future<List<CandleEntity>> call({
    required String instrument,
    required String granularity,
    required int count,
  }) async {
    return await repository.fetchHistoricalCandles(
      instrument, granularity, count);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/get_historical_candles.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 657: lib/features/market/domain/usecases/stream_ticks.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/stream_ticks.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 273.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../entities/tick.dart';
import '../repositories/market_repository.dart';

class StreamTicks {
  final MarketRepository repository;

  StreamTicks(this.repository);

  Stream<TickEntity> call(String instrument) {
    return repository.streamTicks(instrument);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/stream_ticks.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 658: lib/features/market/domain/usecases/get_available_instruments.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/usecases/get_available_instruments.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 266.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import '../repositories/market_repository.dart';

class GetAvailableInstruments {
  final MarketRepository repository;

  GetAvailableInstruments(this.repository);

  Future<List<String>> call() async {
    return await repository.fetchAvailableInstruments();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/usecases/get_available_instruments.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 659: lib/features/market/domain/streaming/live_stream_adapter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/streaming/live_stream_adapter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 49
================================================================================

import 'dart:convert';
import '../../../core/network/ws/transport/ws_transport.dart';
import '../../../core/network/ws/pipeline/ws_pipeline.dart';
import '../aggregator/candle_aggregator.dart';
import '../timeframes/timeframe.dart';

class LiveStreamAdapter {
  final WsTransport _transport = WsTransport();
  final WsPipeline _pipeline = WsPipeline();
  late CandleAggregator _aggregator;

  Stream<Map<String, dynamic>> get candleStream =>
      _pipeline.stream.map((e) => e as Map<String, dynamic>);

  void start({
    required String accountId,
    required String symbol,
    required Timeframe timeframe,
  }) {
    _aggregator = CandleAggregator(timeframe.duration);

    _transport.connect(
      accountId: accountId,
      instrument: symbol,
      onData: (raw) {
        final decoded = jsonDecode(raw);

        if (decoded["type"] == "PRICE") {
          final tick = {
            "time": decoded["time"] is String
                ? DateTime.parse(decoded["time"])
                        .millisecondsSinceEpoch ~/
                    1000
                : decoded["time"],
            "price": double.parse(decoded["bids"][0]["price"]),
          };

          final candle = _aggregator.processTick(tick);
          _pipeline.push(candle.toMap());
        }
      },
    );
  }

  void stop() {
    _transport.disconnect();
    _pipeline.dispose();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/streaming/live_stream_adapter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 660: lib/features/market/domain/indicators/stochastic_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/stochastic_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 78
================================================================================

import '../../domain/entities/candle.dart';
import 'dart:math';

class StochasticResult {
  final List<double> kValues;
  final List<double> dValues;
  final int period;
  final int smoothK;
  final int smoothD;

  StochasticResult({
    required this.kValues,
    required this.dValues,
    required this.period,
    required this.smoothK,
    required this.smoothD,
  });
}

class StochasticCalculator {
  static StochasticResult calculate({
    required List<CandleEntity> data,
    required int period,
    required int smoothK,
    required int smoothD,
  }) {
    List<double> k = [];
    List<double> d = [];

    for (int i = 0; i < data.length; i++) {
      if (i < period) {
        k.add(0);
        d.add(0);
        continue;
      }

      double highestHigh = data
          .sublist(i - period + 1, i + 1)
          .map((c) => c.high)
          .reduce(max);

      double lowestLow = data
          .sublist(i - period + 1, i + 1)
          .map((c) => c.low)
          .reduce(min);

      double currentClose = data[i].close;

      double rawK = ((currentClose - lowestLow) / (highestHigh - lowestLow)) *
          100;

      k.add(rawK);

      if (i >= period + smoothK - 1) {
        double avgK = k.sublist(i - smoothK + 1, i + 1).reduce((a, b) => a + b) /
            smoothK;
        if (d.length >= smoothD) {
          double avgD =
              d.sublist(i - smoothD + 1, i + 1).reduce((a, b) => a + b) /
                  smoothD;
          d.add(avgD);
        } else {
          d.add(avgK);
        }
      } else {
        d.add(0);
      }
    }

    return StochasticResult(
      kValues: k,
      dValues: d,
      period: period,
      smoothK: smoothK,
      smoothD: smoothD,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/stochastic_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 661: lib/features/market/domain/indicators/bollinger_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/bollinger_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 38
================================================================================

import '../../../market/domain/entities/candle.dart';
import 'dart:math';

class BollingerResult {
  final List<double> middle;
  final List<double> upper;
  final List<double> lower;

  BollingerResult({required this.middle, required this.upper, required this.lower});
}

class BollingerCalculator {
  static BollingerResult calculate(List<CandleEntity> data, int period, double mult) {
    final closes = data.map((c) => c.close).toList();
    final middle = <double>[];
    final upper = <double>[];
    final lower = <double>[];

    for (int i = 0; i < closes.length; i++) {
      if (i + 1 >= period) {
        final window = closes.sublist(i + 1 - period, i + 1);
        final mean = window.reduce((a, b) => a + b) / period;
        final variance = window.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b) / period;
        final stdDev = sqrt(variance);

        middle.add(mean);
        upper.add(mean + (stdDev * mult));
        lower.add(mean - (stdDev * mult));
      } else {
        middle.add(0.0);
        upper.add(0.0);
        lower.add(0.0);
      }
    }

    return BollingerResult(middle: middle, upper: upper, lower: lower);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/bollinger_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 662: lib/features/market/domain/indicators/macd_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/macd_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 44
================================================================================

import '../../../market/domain/entities/candle.dart';
import 'ema_calculator.dart';

class MACDResult {
  final List<double> macd;
  final List<double> signal;
  final List<double> histogram;

  MACDResult({required this.macd, required this.signal, required this.histogram});
}

class MACDCalculator {
  static MACDResult calculate(List<CandleEntity> data, {int fast = 12, int slow = 26, int signalPeriod = 9}) {
    final close = data.map((c) => c.close).toList();
    final fastEma = EMACalculator.calculate(data, fast).values;
    final slowEma = EMACalculator.calculate(data, slow).values;

    final macdLine = List<double>.generate(close.length, (i) {
      if (i < slow - 1) return 0.0;
      return fastEma[i] - slowEma[i];
    });

    final signalLine = <double>[];
    double? prevSignal;

    for (int i = 0; i < macdLine.length; i++) {
      if (i < slow - 1 + signalPeriod - 1) {
        signalLine.add(0.0);
      } else if (i == slow - 1 + signalPeriod - 1) {
        final sum = macdLine.sublist(slow - 1, slow - 1 + signalPeriod).fold(0.0, (a, b) => a + b);
        prevSignal = sum / signalPeriod;
        signalLine.add(prevSignal);
      } else {
        final next = ((macdLine[i] - prevSignal!) * (2 / (signalPeriod + 1))) + prevSignal;
        prevSignal = next;
        signalLine.add(next);
      }
    }

    final hist = List<double>.generate(close.length, (i) => macdLine[i] - signalLine[i]);

    return MACDResult(macd: macdLine, signal: signalLine, histogram: hist);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/macd_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 663: lib/features/market/domain/indicators/rsi_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/rsi_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

import '../../../market/domain/entities/candle.dart';

class RSIResult {
  final List<double> values;
  RSIResult(this.values);
}

class RSICalculator {
  static RSIResult calculate(List<CandleEntity> data, int period) {
    final values = <double>[];
    if (data.length <= period) return RSIResult(values);

    List<double> gains = [];
    List<double> losses = [];

    for (int i = 1; i < data.length; i++) {
      final change = data[i].close - data[i - 1].close;
      gains.add(change > 0 ? change : 0);
      losses.add(change < 0 ? -change : 0);
    }

    double avgGain = gains.take(period).reduce((a, b) => a + b) / period;
    double avgLoss = losses.take(period).reduce((a, b) => a + b) / period;
    values.add(100 - (100 / (1 + (avgGain / avgLoss))));

    for (int i = period; i < gains.length; i++) {
      avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
      avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;

      final rs = avgGain / (avgLoss == 0 ? 1 : avgLoss);
      final rsi = 100 - (100 / (1 + rs));
      values.add(rsi);
    }

    return RSIResult(values);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/rsi_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 664: lib/features/market/domain/indicators/ema_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/ema_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 933.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 35
================================================================================

import '../../../market/domain/entities/candle.dart';

class EMAResult {
  final List<double> values;
  EMAResult(this.values);
}

class EMACalculator {
  static EMAResult calculate(List<CandleEntity> data, int period) {
    final values = <double>[];
    if (data.isEmpty || period <= 0) return EMAResult(values);

    final k = 2 / (period + 1);
    double? prevEma;

    for (int i = 0; i < data.length; i++) {
      final price = data[i].close;
      if (i + 1 < period) {
        // Not enough data yet â€” push 0 or null
        values.add(0.0);
      } else if (i + 1 == period) {
        // First EMA = simple average
        final sum = data.sublist(0, period).fold(0.0, (p, c) => p + c.close);
        prevEma = sum / period;
        values.add(prevEma);
      } else {
        final ema = (price - prevEma!) * k + prevEma;
        prevEma = ema;
        values.add(ema);
      }
    }

    return EMAResult(values);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/ema_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 665: lib/features/market/domain/indicators/indicator_series.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/indicator_series.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 201.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

class IndicatorSeries {
  final List<double> values;
  final String label;
  final Color color;

  IndicatorSeries({
    required this.values,
    required this.label,
    required this.color,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/indicator_series.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 666: lib/features/market/domain/indicators/advanced/macd_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/advanced/macd_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 58
================================================================================

import '../entities/candle.dart';
import 'package:collection/collection.dart';

class MacdResult {
  final List<double> macdLine;
  final List<double> signalLine;
  final List<double> histogram;

  MacdResult({
    required this.macdLine,
    required this.signalLine,
    required this.histogram,
  });
}

class MacdCalculator {
  static MacdResult calculate(
    List<CandleEntity> data, {
    int fastPeriod = 12,
    int slowPeriod = 26,
    int signalPeriod = 9,
  }) {
    List<double> closePrices = data.map((c) => c.close).toList();

    List<double> emaFast = _ema(closePrices, fastPeriod);
    List<double> emaSlow = _ema(closePrices, slowPeriod);

    List<double> macdLine = List.generate(closePrices.length, (i) {
      return emaFast[i] - emaSlow[i];
    });

    List<double> signalLine = _ema(macdLine, signalPeriod);

    List<double> histogram = List.generate(closePrices.length, (i) {
      return macdLine[i] - signalLine[i];
    });

    return MacdResult(
      macdLine: macdLine,
      signalLine: signalLine,
      histogram: histogram,
    );
  }

  static List<double> _ema(List<double> data, int period) {
    List<double> kList = [];
    double multiplier = 2 / (period + 1);

    List<double> ema = [];
    ema.add(data.take(period).reduce((a, b) => a + b) / period);

    for (int i = period; i < data.length; i++) {
      ema.add((data[i] - ema.last) * multiplier + ema.last);
    }

    return ema;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/advanced/macd_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 667: lib/features/market/domain/indicators/advanced/rsi_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/advanced/rsi_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 48
================================================================================

import '../entities/candle.dart';

class RsiResult {
  final List<double> values;
  RsiResult(this.values);
}

class RsiCalculator {
  static RsiResult calculate(List<CandleEntity> data, {int period = 14}) {
    final List<double> deltas = [];
    for (int i = 1; i < data.length; i++) {
      deltas.add(data[i].close - data[i - 1].close);
    }

    List<double> gains = [];
    List<double> losses = [];

    for (var d in deltas) {
      gains.add(d > 0 ? d : 0);
      losses.add(d < 0 ? -d : 0);
    }

    List<double> avgGain = [];
    List<double> avgLoss = [];

    double sumGain = gains.take(period).reduce((a, b) => a + b);
    double sumLoss = losses.take(period).reduce((a, b) => a + b);

    avgGain.add(sumGain / period);
    avgLoss.add(sumLoss / period);

    for (int i = period; i < gains.length; i++) {
      double gain = gains[i];
      double loss = losses[i];

      avgGain.add((avgGain.last * (period - 1) + gain) / period);
      avgLoss.add((avgLoss.last * (period - 1) + loss) / period);
    }

    List<double> rsi = List.filled(data.length, 0.0);
    for (int i = period; i < avgGain.length + period; i++) {
      double rs = avgGain[i - period] / (avgLoss[i - period] == 0 ? 1 : avgLoss[i - period]);
      rsi[i] = 100 - (100 / (1 + rs));
    }

    return RsiResult(rsi);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/advanced/rsi_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 668: lib/features/market/domain/indicators/advanced/bollinger_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/advanced/bollinger_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 50
================================================================================

import '../entities/candle.dart';
import 'dart:math';

class BollingerResult {
  final List<double> middleBand;
  final List<double> upperBand;
  final List<double> lowerBand;

  BollingerResult({
    required this.middleBand,
    required this.upperBand,
    required this.lowerBand,
  });
}

class BollingerCalculator {
  static BollingerResult calculate(
    List<CandleEntity> data, {
    int period = 20,
    double stdDevMultiplier = 2.0,
  }) {
    List<double> closes = data.map((c) => c.close).toList();

    List<double> middle = [];
    List<double> upper = [];
    List<double> lower = [];

    for (int i = 0; i < closes.length; i++) {
      if (i + 1 >= period) {
        List<double> window = closes.sublist(i + 1 - period, i + 1);
        double mean = window.reduce((a, b) => a + b) / period;
        double sumSq = window.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b);
        double stdDev = sqrt(sumSq / period);

        middle.add(mean);
        upper.add(mean + stdDevMultiplier * stdDev);
        lower.add(mean - stdDevMultiplier * stdDev);
      } else {
        middle.add(0);
        upper.add(0);
        lower.add(0);
      }
    }
    return BollingerResult(
      middleBand: middle,
      upperBand: upper,
      lowerBand: lower,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/advanced/bollinger_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 669: lib/features/market/domain/indicators/types/indicator_series.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/types/indicator_series.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 259.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'indicator_type.dart';

class IndicatorSeries {
  final List<double> values;
  final String label;
  final IndicatorDisplayMode displayMode;

  IndicatorSeries({
    required this.values,
    required this.label,
    required this.displayMode,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/types/indicator_series.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 670: lib/features/market/domain/indicators/types/indicator_type.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/indicators/types/indicator_type.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 800.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

enum IndicatorDisplayMode {
  overlay,     // Ø±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„Ø´Ø§Ø±Øª
  subChart,    // Ø±Ø³Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø±Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ø³ØªÙ‚Ù„Ø©
}

class IndicatorType {
  final String id;
  final String label;
  final IndicatorDisplayMode mode;

  const IndicatorType({
    required this.id,
    required this.label,
    required this.mode,
  });
}

const IndicatorType EMA = IndicatorType(id: "ema", label: "EMA", mode: IndicatorDisplayMode.overlay);
const IndicatorType BOLLINGER = IndicatorType(id: "bollinger", label: "Bollinger Bands", mode: IndicatorDisplayMode.overlay);
const IndicatorType STOCH = IndicatorType(id: "stoch", label: "Stochastic", mode: IndicatorDisplayMode.subChart);
const IndicatorType RSI = IndicatorType(id: "rsi", label: "RSI", mode: IndicatorDisplayMode.subChart);

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/indicators/types/indicator_type.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 671: lib/features/market/domain/chart/x_axis_range.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/chart/x_axis_range.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 193.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

class XAxisRange {
  final DateTime min;
  final DateTime max;

  const XAxisRange({required this.min, required this.max});

  bool contains(DateTime t) => t.isAfter(min) && t.isBefore(max);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/chart/x_axis_range.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 672: lib/features/market/domain/repositories/market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/repositories/market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 73.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 3
================================================================================

abstract class MarketRepository {
  Future<List<String>> getMarkets();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/repositories/market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 673: lib/features/market/domain/repository/market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/repository/market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 235.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import '../../../../core/models/candle_entity.dart';

abstract class MarketRepository {
  Future<List<CandleEntity>> getCandles(String symbol, String timeframe);
  Stream<CandleEntity> streamCandles(String symbol, String timeframe);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/repository/market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 674: lib/features/market/domain/stream/stream_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/stream/stream_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 226.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

abstract class StreamRepository {
  Stream<Map<String, dynamic>> ticks();
  Future<void> start({
    required String accountId,
    required String instruments,
    required Map<String, String> headers,
  });
  void stop();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/stream/stream_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 675: lib/features/market/domain/audit/audit_log.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/audit/audit_log.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1003.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 47
================================================================================

enum AuditType {
  tradeExecuted,
  tradeClosed,
  apiError,
  strategyChanged,
  settingsChanged,
  websocketConnected,
  websocketDisconnected,
  general,
}

class AuditLog {
  final DateTime timestamp;
  final AuditType type;
  final String message;
  final Map<String, dynamic>? data;

  AuditLog({
    required this.timestamp,
    required this.type,
    required this.message,
    this.data,
  });

  Map<String, dynamic> toJson() {
    return {
      "timestamp": timestamp.toIso8601String(),
      "type": type.toString(),
      "message": message,
      "data": data,
    };
  }

  factory AuditLog.fromJson(Map<String, dynamic> json) {
    return AuditLog(
      timestamp: DateTime.parse(json["timestamp"]),
      type: AuditType.values.firstWhere(
        (e) => e.toString() == json["type"],
        orElse: () => AuditType.general,
      ),
      message: json["message"],
      data: json["data"] != null
          ? Map<String, dynamic>.from(json["data"])
          : null,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/audit/audit_log.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 676: lib/features/market/domain/trading/trade_position.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/trading/trade_position.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 486.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import '../entities/candle.dart';

enum TradeType { BUY, SELL }

class TradePosition {
  final String instrument;
  final TradeType type;
  final DateTime entryTime;
  final double entryPrice;
  final double stopLoss;
  final double takeProfit;
  double? exitPrice;
  DateTime? exitTime;

  TradePosition({
    required this.instrument,
    required this.type,
    required this.entryTime,
    required this.entryPrice,
    required this.stopLoss,
    required this.takeProfit,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/trading/trade_position.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 677: lib/features/market/domain/trading/strategy_manager.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/trading/strategy_manager.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 58
================================================================================

import '../entities/candle.dart';
import '../indicators/ema_calculator.dart';
import '../indicators/stochastic_calculator.dart';
import 'trade_position.dart';

class StrategyManager {
  final List<CandleEntity> candles;

  StrategyManager(this.candles);

  TradePosition? checkForSignal({
    required String instrument,
    required double currentPrice,
  }) {
    // EMA Cross Strategy
    final ema50 = EmaCalculator.calculate(data: candles, period: 50).values;
    final ema200 = EmaCalculator.calculate(data: candles, period: 200).values;

    final stoch = StochasticCalculator.calculate(
      data: candles,
      period: 14,
      smoothK: 3,
      smoothD: 3,
    );

    final int lastIndex = candles.length - 1;
    if (lastIndex < 200) return null;

    final crossBuy = (ema50[lastIndex] > ema200[lastIndex]) &&
        (stoch.kValues[lastIndex] > stoch.dValues[lastIndex]);

    final crossSell = (ema50[lastIndex] < ema200[lastIndex]) &&
        (stoch.kValues[lastIndex] < stoch.dValues[lastIndex]);

    if (crossBuy) {
      return TradePosition(
        instrument: instrument,
        type: TradeType.BUY,
        entryTime: candles[lastIndex].time,
        entryPrice: currentPrice,
        stopLoss: currentPrice * 0.998,
        takeProfit: currentPrice * 1.005,
      );
    }

    if (crossSell) {
      return TradePosition(
        instrument: instrument,
        type: TradeType.SELL,
        entryTime: candles[lastIndex].time,
        entryPrice: currentPrice,
        stopLoss: currentPrice * 1.002,
        takeProfit: currentPrice * 0.995,
      );
    }
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/trading/strategy_manager.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 678: lib/features/market/domain/trading/trade_result.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/trading/trade_result.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 318.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

class TradeResult {
  final double profit;
  final double entryPrice;
  final double exitPrice;
  final DateTime entryTime;
  final DateTime exitTime;

  TradeResult({
    required this.profit,
    required this.entryPrice,
    required this.exitPrice,
    required this.entryTime,
    required this.exitTime,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/trading/trade_result.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 679: lib/features/market/domain/trading/orders/order_request.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/trading/orders/order_request.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 689.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

class OrderRequest {
  final String instrument;
  final int units; // >0 for buy, <0 for sell
  final String type; // MARKET / LIMIT / STOP
  final String timeInForce; // GTC / FOK / IOC
  final double? price; // Only for LIMIT/STOP

  OrderRequest({
    required this.instrument,
    required this.units,
    required this.type,
    this.timeInForce = "FOK",
    this.price,
  });

  Map<String, dynamic> toJson() {
    final order = {
      "instrument": instrument,
      "units": units.toString(),
      "type": type,
      "timeInForce": timeInForce,
      "positionFill": "DEFAULT",
    };
    if (price != null) order["price"] = price.toString();
    return {"order": order};
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/trading/orders/order_request.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 680: lib/features/market/domain/alerts/price_alert.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/alerts/price_alert.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 198.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

class PriceAlert {
  final double price;
  final bool triggerAbove;
  final String symbol;

  PriceAlert({
    required this.price,
    required this.triggerAbove,
    required this.symbol,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/alerts/price_alert.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 681: lib/features/market/domain/alerts/smart/smart_alert.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/alerts/smart/smart_alert.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 495.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

enum SmartAlertType {
  rsiBelow,
  macdCrossUp,
  bollingerBreakoutUpper,
}

class SmartAlertCondition {
  final SmartAlertType type;
  final int durationSeconds;
  final double threshold;

  SmartAlertCondition({
    required this.type,
    required this.durationSeconds,
    required this.threshold,
  });
}

class SmartAlert {
  final SmartAlertCondition condition;
  final String instrument;
  bool isTriggered = false;

  SmartAlert({required this.condition, required this.instrument});
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/alerts/smart/smart_alert.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 682: lib/features/market/domain/alerts/smart/engine/smart_alert_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/alerts/smart/engine/smart_alert_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 66
================================================================================

import 'dart:collection';
import '../../entities/candle.dart';
import '../smart/smart_alert.dart';
import '../../../indicators/advanced/rsi_calculator.dart';
import '../../../indicators/advanced/macd_calculator.dart';
import '../../../indicators/advanced/bollinger_calculator.dart';

class SmartAlertEngine {
  final List<CandleEntity> history;
  final List<SmartAlert> activeAlerts;
  final int checkIntervalSeconds;

  SmartAlertEngine({
    required this.history,
    required this.activeAlerts,
    this.checkIntervalSeconds = 60,
  });

  void processNewCandle(CandleEntity candle) {
    history.add(candle);

    for (var alert in activeAlerts) {
      if (alert.isTriggered) continue;

      switch (alert.condition.type) {
        case SmartAlertType.rsiBelow:
          _checkRsiBelow(alert);
          break;
        case SmartAlertType.macdCrossUp:
          _checkMacdCross(alert);
          break;
        case SmartAlertType.bollingerBreakoutUpper:
          _checkBollingerUpper(alert);
          break;
      }
    }
  }

  void _checkRsiBelow(SmartAlert alert) {
    final rsi = RsiCalculator.calculate(history, period: alert.condition.threshold.toInt()).values;
    int countBelow = 0;
    for (int i = rsi.length - alert.condition.durationSeconds; i < rsi.length; i++) {
      if (rsi[i] < alert.condition.threshold) countBelow++;
    }
    if (countBelow >= alert.condition.durationSeconds) {
      alert.isTriggered = true;
    }
  }

  void _checkMacdCross(SmartAlert alert) {
    final macd = MacdCalculator.calculate(history).macdLine;
    final signal = MacdCalculator.calculate(history).signalLine;
    if (macd.isNotEmpty && signal.isNotEmpty) {
      int n = macd.length;
      if (n > 1 && macd[n - 2] < signal[n - 2] && macd[n - 1] > signal[n - 1]) {
        alert.isTriggered = true;
      }
    }
  }

  void _checkBollingerUpper(SmartAlert alert) {
    final bb = BollingerCalculator.calculate(history);
    double lastPrice = history.last.close;
    if (lastPrice > bb.upperBand.last) alert.isTriggered = true;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/alerts/smart/engine/smart_alert_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 683: lib/features/market/domain/models/instrument.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/models/instrument.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 815.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:equatable/equatable.dart';

class Instrument extends Equatable {
  final String name;      // Ù…Ø«Ø§Ù„: "XAU_USD"
  final String display;   // Ù…Ø«Ø§Ù„: "XAUUSD"
  final int displayPrecision;
  final int tradeUnitsPrecision;

  const Instrument({
    required this.name,
    required this.display,
    required this.displayPrecision,
    required this.tradeUnitsPrecision,
  });

  factory Instrument.fromRest(Map<String, dynamic> json) {
    final name = json["name"] as String;
    return Instrument(
      name: name,
      display: name.replaceAll("_", ""),
      displayPrecision: json["displayPrecision"] as int,
      tradeUnitsPrecision: json["tradeUnitsPrecision"] as int,
    );
  }

  @override
  List<Object?> get props =>
      [name, display, displayPrecision, tradeUnitsPrecision];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/models/instrument.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 684: lib/features/market/domain/models/tick.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/models/tick.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 51
================================================================================

import 'package:equatable/equatable.dart';

class Tick extends Equatable {
  final int time; // Unix seconds
  final double bid;
  final double ask;

  const Tick({
    required this.time,
    required this.bid,
    required this.ask,
  });

  factory Tick.fromOandaWs(Map<String, dynamic> json) {
    if (json["type"] != "PRICE") {
      throw FormatException("Not a PRICE message");
    }

    final time = _toUnix(json["time"]);
    final bid = _toDouble(json["bids"][0]["price"]);
    final ask = _toDouble(json["asks"][0]["price"]);

    return Tick(time: time, bid: bid, ask: ask);
  }

  Map<String, dynamic> toMap() {
    return {
      "time": time,
      "bid": bid,
      "ask": ask,
    };
  }

  static int _toUnix(dynamic v) {
    if (v is int) return v;
    if (v is String) {
      return DateTime.parse(v).millisecondsSinceEpoch ~/ 1000;
    }
    throw FormatException("Invalid time: \$v");
  }

  static double _toDouble(dynamic v) {
    if (v is double) return v;
    if (v is int) return v.toDouble();
    if (v is String) return double.parse(v);
    throw FormatException("Invalid price: \$v");
  }

  @override
  List<Object?> get props => [time, bid, ask];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/models/tick.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 685: lib/features/market/domain/models/candle.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/models/candle.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 95
================================================================================

import 'package:equatable/equatable.dart';

class Candle extends Equatable {
  final int time; // Unix seconds (Ù…ÙˆØ­Ø¯ ÙÙŠ ÙƒÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
  final double open;
  final double high;
  final double low;
  final double close;
  final double? volume;

  const Candle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    this.volume,
  });

  /// Factory Ø¢Ù…Ù† Ù…Ù† JSON (REST)
  factory Candle.fromRestJson(Map<String, dynamic> json) {
    final candle = json["mid"] ?? json["bid"] ?? json;

    return Candle(
      time: _toUnixSeconds(candle["time"]),
      open: _toDouble(candle["o"]),
      high: _toDouble(candle["h"]),
      low: _toDouble(candle["l"]),
      close: _toDouble(candle["c"]),
      volume: candle["volume"] != null ? _toDouble(candle["volume"]) : null,
    );
  }

  /// Factory Ø¢Ù…Ù† Ù…Ù† Tick (WebSocket)
  factory Candle.fromTick({
    required int time,
    required double price,
  }) {
    return Candle(
      time: time,
      open: price,
      high: price,
      low: price,
      close: price,
      volume: null,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      "time": time,
      "open": open,
      "high": high,
      "low": low,
      "close": close,
      if (volume != null) "volume": volume,
    };
  }

  Candle copyWith({
    int? time,
    double? open,
    double? high,
    double? low,
    double? close,
    double? volume,
  }) {
    return Candle(
      time: time ?? this.time,
      open: open ?? this.open,
      high: high ?? this.high,
      low: low ?? this.low,
      close: close ?? this.close,
      volume: volume ?? this.volume,
    );
  }

  static int _toUnixSeconds(dynamic v) {
    if (v is int) return v;
    if (v is String) {
      return DateTime.parse(v).millisecondsSinceEpoch ~/ 1000;
    }
    throw FormatException("Invalid time format: \$v");
  }

  static double _toDouble(dynamic v) {
    if (v is double) return v;
    if (v is int) return v.toDouble();
    if (v is String) return double.parse(v);
    throw FormatException("Invalid price format: \$v");
  }

  @override
  List<Object?> get props => [time, open, high, low, close, volume];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/models/candle.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 686: lib/features/market/domain/backtest/backtest_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/backtest/backtest_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 48.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

class BacktestEngine {}
class BacktestResult {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/backtest/backtest_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 687: lib/features/market/domain/backtest/backtest_models.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/backtest/backtest_models.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 767.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

enum OrderSide { buy, sell }

class Order {
  final OrderSide side;
  final DateTime time;
  final double price;
  final double size;

  Order({
    required this.side,
    required this.time,
    required this.price,
    required this.size,
  });
}

class Position {
  final OrderSide side;
  final DateTime entryTime;
  final double entryPrice;
  final double size;
  DateTime? exitTime;
  double? exitPrice;

  Position({
    required this.side,
    required this.entryTime,
    required this.entryPrice,
    required this.size,
    this.exitPrice,
    this.exitTime,
  });

  double get profit {
    if (exitPrice == null) return 0.0;
    return (side == OrderSide.buy)
        ? (exitPrice! - entryPrice) * size
        : (entryPrice - exitPrice!) * size;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/backtest/backtest_models.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 688: lib/features/market/domain/backtest/backtest_result.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/backtest/backtest_result.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 451.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

class BacktestResult {
  final List<double> equityCurve;
  final List<double> balanceCurve;
  final List<dynamic> trades; // ÙŠÙ…ÙƒÙ† ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù†ÙˆØ¹ Ù„Ø§Ø­Ù‚Ù‹Ø§
  final double netProfit;
  final double winRate;
  final double maxDrawdown;

  BacktestResult({
    required this.equityCurve,
    required this.balanceCurve,
    required this.trades,
    required this.netProfit,
    required this.winRate,
    required this.maxDrawdown,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/backtest/backtest_result.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 689: lib/features/market/domain/sync/market_sync_coordinator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/sync/market_sync_coordinator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 729.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import '../../../core/models/candle_entity.dart';
import '../../../core/models/tick_entity.dart';

typedef TickListener = void Function(TickEntity tick);
typedef CandleListener = void Function(CandleEntity candle);

class MarketSyncCoordinator {
  final _tickListeners = <TickListener>[];
  final _candleListeners = <CandleListener>[];

  void registerTickListener(TickListener listener) => _tickListeners.add(listener);
  void registerCandleListener(CandleListener listener) => _candleListeners.add(listener);

  void dispatchTick(TickEntity tick) {
    for (final l in _tickListeners) {
      l(tick);
    }
  }

  void dispatchCandle(CandleEntity candle) {
    for (final l in _candleListeners) {
      l(candle);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/sync/market_sync_coordinator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 690: lib/features/market/domain/aggregator/candle_aggregator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/market/domain/aggregator/candle_aggregator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 96
================================================================================

import 'dart:collection';

class LiveCandle {
  final int time; // unix seconds
  double open;
  double high;
  double low;
  double close;

  LiveCandle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });

  Map<String, dynamic> toMap() {
    return {
      "time": time,
      "open": open,
      "high": high,
      "low": low,
      "close": close,
    };
  }
}

class CandleAggregator {
  LiveCandle? _currentCandle;
  final Duration timeframe;
  final Queue<Map<String, dynamic>> _pendingTicks = Queue();

  CandleAggregator(this.timeframe);

  /// ÙŠØ­ÙˆÙ‘Ù„ Timestamp Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
  int _alignTime(int unixSeconds) {
    final bucket = timeframe.inSeconds;
    return (unixSeconds ~/ bucket) * bucket;
  }

  /// ÙŠØ³ØªÙ‚Ø¨Ù„ Tick ÙˆÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø´Ù…Ø¹Ø© Ø£Ùˆ ÙŠÙ†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
  LiveCandle processTick(Map<String, dynamic> tick) {
    final int ts = tick["time"] as int;
    final double price = tick["price"] as double;
    final alignedTime = _alignTime(ts);

    // Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù…Ø¹Ø© Ø­Ø§Ù„ÙŠØ© -> Ø£Ù†Ø´Ø¦Ù‡Ø§
    if (_currentCandle == null) {
      _currentCandle = LiveCandle(
        time: alignedTime,
        open: price,
        high: price,
        low: price,
        close: price,
      );
      return _currentCandle!;
    }

    // Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø± Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù† -> Ø£ØºÙ„Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø¬Ø¯ÙŠØ¯Ø©
    if (_currentCandle!.time != alignedTime) {
      final closed = _currentCandle!;
      _currentCandle = LiveCandle(
        time: alignedTime,
        open: price,
        high: price,
        low: price,
        close: price,
      );
      return closed; // Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ù…ØºÙ„Ù‚Ø© Ø£ÙˆÙ„Ù‹Ø§
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    _currentCandle!.high =
        price > _currentCandle!.high ? price : _currentCandle!.high;
    _currentCandle!.low =
        price < _currentCandle!.low ? price : _currentCandle!.low;
    _currentCandle!.close = price;

    return _currentCandle!;
  }

  /// Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø«Ù… Ø¹ÙˆØ¯ØªÙ‡: Ù†Ø®Ø²Ù† Ticks Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
  void bufferTick(Map<String, dynamic> tick) {
    _pendingTicks.add(tick);
  }

  /// Ù…Ù„Ø¡ Ø§Ù„ÙØ¬ÙˆØ§Øª Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  List<LiveCandle> flushBufferedTicks() {
    final List<LiveCandle> candles = [];
    while (_pendingTicks.isNotEmpty) {
      candles.add(processTick(_pendingTicks.removeFirst()));
    }
    return candles;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/market/domain/aggregator/candle_aggregator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 691: lib/features/dashboard/presentation/dashboard_screen.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/dashboard/presentation/dashboard_screen.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 363.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter/material.dart';

class DashboardScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          Text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­"),
          Text("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª"),
          Text("Ø£Ø¹Ù„Ù‰ Drawdown"),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/dashboard/presentation/dashboard_screen.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 692: lib/features/alert/presentation/bloc/smart_alert_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alert/presentation/bloc/smart_alert_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 39
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'smart_alert_event.dart';
import 'smart_alert_state.dart';

class SmartAlertBloc extends Bloc<SmartAlertEvent, SmartAlertState> {
  final Map<String, String> _rules = {};

  SmartAlertBloc() : super(AlertInitial()) {
    on<AddAlertRule>(_onAddRule);
    on<RemoveAlertRule>(_onRemoveRule);
    on<CheckAlerts>(_onCheck);
  }

  void _onAddRule(AddAlertRule event, Emitter<SmartAlertState> emit) {
    _rules[event.id] = event.condition;
    emit(AlertRuleAdded());
  }

  void _onRemoveRule(RemoveAlertRule event, Emitter<SmartAlertState> emit) {
    _rules.remove(event.id);
    emit(AlertRuleRemoved());
  }

  void _onCheck(CheckAlerts event, Emitter<SmartAlertState> emit) {
    try {
      // simple evaluator placeholder
      final triggered = _rules.entries
          .where((e) => event.candle.toString().contains(e.value))
          .map((e) => e.key)
          .toList();

      for (final id in triggered) {
        emit(AlertTriggered(id));
      }
    } catch (e) {
      emit(AlertError(e.toString()));
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alert/presentation/bloc/smart_alert_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 693: lib/features/alert/presentation/bloc/smart_alert_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alert/presentation/bloc/smart_alert_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 375.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

abstract class SmartAlertState {}

class AlertInitial extends SmartAlertState {}

class AlertRuleAdded extends SmartAlertState {}

class AlertRuleRemoved extends SmartAlertState {}

class AlertTriggered extends SmartAlertState {
  final String id;
  AlertTriggered(this.id);
}

class AlertError extends SmartAlertState {
  final String message;
  AlertError(this.message);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alert/presentation/bloc/smart_alert_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 694: lib/features/alert/presentation/bloc/smart_alert_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/alert/presentation/bloc/smart_alert_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 427.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

abstract class SmartAlertEvent {}

class AddAlertRule extends SmartAlertEvent {
  final String id;
  final String condition; // expression like "RSI < 30"
  AddAlertRule(this.id, this.condition);
}

class RemoveAlertRule extends SmartAlertEvent {
  final String id;
  RemoveAlertRule(this.id);
}

class CheckAlerts extends SmartAlertEvent {
  final dynamic candle; // can be CandleEntity or other
  CheckAlerts(this.candle);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/alert/presentation/bloc/smart_alert_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 695: lib/features/home/presentation/pages/home_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/home/presentation/pages/home_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 213.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'package:flutter/material.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(child: Text('Home Page')),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/home/presentation/pages/home_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 696: lib/features/strategy_script/domain/ast.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/domain/ast.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 768.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

abstract class ASTNode {}

class IfStatement extends ASTNode {
  final Expression condition;
  final Action action;
  IfStatement(this.condition, this.action);
}

abstract class Expression extends ASTNode {}

class BinaryExpression extends Expression {
  final Expression left;
  final String op;
  final Expression right;
  BinaryExpression(this.left, this.op, this.right);
}

class FunctionCall extends Expression {
  final String name;
  final List<Expression> args;
  FunctionCall(this.name, this.args);
}

class NumberLiteral extends Expression {
  final double value;
  NumberLiteral(this.value);
}

class Identifier extends Expression {
  final String name;
  Identifier(this.name);
}

class Action extends ASTNode {
  final String type;
  Action(this.type);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/domain/ast.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 697: lib/features/strategy_script/domain/token.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/domain/token.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

enum TokenType {
  identifier,
  number,
  comparison,
  comma,
  leftParen,
  rightParen,
  keywordIf,
  keywordThen,
  semicolon,
  eof,
}

class Token {
  final TokenType type;
  final String lexeme;
  Token(this.type, this.lexeme);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/domain/token.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 698: lib/features/strategy_script/domain/tokenizer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/domain/tokenizer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 66
================================================================================

import 'token.dart';

class Tokenizer {
  final String _input;
  int _pos = 0;

  Tokenizer(this._input);

  List<Token> tokenize() {
    final tokens = <Token>[];

    while (_pos < _input.length) {
      final c = _input[_pos];

      if (c.trim().isEmpty) { _pos++; continue; }

      if (isLetter(c)) {
        final word = readWhile(isLetter);
        if (word.toUpperCase() == 'IF') tokens.add(Token(TokenType.keywordIf, word));
        else if (word.toUpperCase() == 'THEN') tokens.add(Token(TokenType.keywordThen, word));
        else tokens.add(Token(TokenType.identifier, word));
        continue;
      }

      if (isDigit(c)) {
        final numStr = readWhile((ch) => isDigit(ch) || ch == '.');
        tokens.add(Token(TokenType.number, numStr));
        continue;
      }

      switch (c) {
        case '>':
        case '<':
        case '=':
          tokens.add(Token(TokenType.comparison, c));
          break;
        case ',':
          tokens.add(Token(TokenType.comma, c));
          break;
        case '(':
          tokens.add(Token(TokenType.leftParen, c));
          break;
        case ')':
          tokens.add(Token(TokenType.rightParen, c));
          break;
        case ';':
          tokens.add(Token(TokenType.semicolon, c));
          break;
      }

      _pos++;
    }

    tokens.add(Token(TokenType.eof, ''));
    return tokens;
  }

  bool isLetter(String c) => RegExp(r'[A-Za-z_]').hasMatch(c);
  bool isDigit(String c) => RegExp(r'[0-9]').hasMatch(c);

  String readWhile(bool Function(String) test) {
    final start = _pos;
    while (_pos < _input.length && test(_input[_pos])) _pos++;
    return _input.substring(start, _pos);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/domain/tokenizer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 699: lib/features/strategy_script/domain/interpreter.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/domain/interpreter.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 36
================================================================================

import 'ast.dart';
import '../../../market/domain/entities/candle.dart';
import '../../strategy_script/domain/ast.dart';

typedef IndicatorFunc = List<double> Function(List<CandleEntity>, int);

class ScriptInterpreter {
  final List<ASTNode> ast;
  final Map<String, IndicatorFunc> indicatorLibrary;

  ScriptInterpreter(this.ast, this.indicatorLibrary);

  bool evaluate(List<CandleEntity> history) {
    for (var node in ast) {
      if (node is IfStatement) {
        final cond = _evalExpression(node.condition, history);
        if (cond) {
          if (node.action.type.toUpperCase() == 'BUY') return true;
        }
      }
    }
    return false;
  }

  dynamic _evalExpression(Expression expr, List<CandleEntity> history) {
    if (expr is FunctionCall) {
      final name = expr.name.toUpperCase();
      final args = expr.args.map((e) => _evalExpression(e, history)).toList();

      if (indicatorLibrary.containsKey(name)) {
        return indicatorLibrary[name]!(history, args[1].toInt());
      }
    }
    return null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/domain/interpreter.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 700: lib/features/strategy_script/domain/parser.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/domain/parser.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 64
================================================================================

import 'token.dart';
import 'tokenizer.dart';
import 'ast.dart';

class Parser {
  final List<Token> tokens;
  int _pos = 0;

  Parser(this.tokens);

  Token get current => tokens[_pos];

  void advance() => _pos++;

  bool accept(TokenType type) {
    if (current.type == type) { advance(); return true; }
    return false;
  }

  ASTNode? parse() {
    if (accept(TokenType.keywordIf)) {
      final cond = parseExpression();
      expect(TokenType.keywordThen);
      final act = parseAction();
      expect(TokenType.semicolon);
      return IfStatement(cond!, act);
    }
    return null;
  }

  Expression? parseExpression() {
    if (current.type == TokenType.identifier) {
      final name = current.lexeme;
      advance();
      if (accept(TokenType.leftParen)) {
        final args = <Expression>[];
        while (!accept(TokenType.rightParen)) {
          final expr = parseExpression();
          if (expr != null) args.add(expr);
          accept(TokenType.comma);
        }
        return FunctionCall(name, args);
      }
      return Identifier(name);
    }
    if (current.type == TokenType.number) {
      final val = double.parse(current.lexeme);
      advance();
      return NumberLiteral(val);
    }
    return null;
  }

  Action parseAction() {
    final name = current.lexeme;
    advance();
    return Action(name);
  }

  void expect(TokenType type) {
    if (current.type != type) throw Exception("Expected $type");
    advance();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/domain/parser.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 701: lib/features/strategy_script/presentation/pages/script_editor_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/presentation/pages/script_editor_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 45
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../strategy_script/data/script_storage.dart';

class ScriptEditorPage extends StatefulWidget {
  @override
  _ScriptEditorPageState createState() => _ScriptEditorPageState();
}

class _ScriptEditorPageState extends State<ScriptEditorPage> {
  final controller = TextEditingController();

  @override
  void initState() {
    super.initState();
    ScriptStorage().load().then((value) {
      if (value != null) setState(() => controller.text = value);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Edit Strategy Script")),
      body: Column(
        children: [
          Expanded(
            child: TextField(
              controller: controller,
              maxLines: null,
              decoration: InputDecoration(border: OutlineInputBorder()),
            ),
          ),
          ElevatedButton(
            onPressed: () {
              ScriptStorage().save(controller.text);
              Navigator.pop(context);
            },
            child: Text("Save Script"),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/presentation/pages/script_editor_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 702: lib/features/strategy_script/data/script_storage.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/strategy_script/data/script_storage.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 402.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:shared_preferences/shared_preferences.dart';

class ScriptStorage {
  static const _key = 'strategy_script';

  Future<void> save(String script) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_key, script);
  }

  Future<String?> load() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_key);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/strategy_script/data/script_storage.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 703: lib/features/analytics/domain/risk_analyzer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/analytics/domain/risk_analyzer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 338.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../features/trading/domain/order/order.dart';

class RiskAnalyzer {
  final double accountSize;

  RiskAnalyzer(this.accountSize);

  double riskPerTrade(double stopLossPips) {
    return accountSize * (stopLossPips / 100);
  }

  double lotSize(double riskAmount, double pipValue) {
    return riskAmount / pipValue;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/analytics/domain/risk_analyzer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 704: lib/features/analytics/domain/liquidity_analyzer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/analytics/domain/liquidity_analyzer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 333.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../core/models/candle_entity.dart';

class LiquidityAnalyzer {
  final List<CandleEntity> candles;

  LiquidityAnalyzer(this.candles);

  double averageRange() {
    return candles.fold(0, (sum, c) => sum + (c.high - c.low)) / candles.length;
  }

  double volatility() {
    return averageRange(); // ØªØ¨Ø³ÙŠØ·
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/analytics/domain/liquidity_analyzer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 705: lib/features/analytics/domain/strategy_comparer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/analytics/domain/strategy_comparer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 304.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'trade_statistics.dart';

class StrategyComparer {
  final TradeStatistics a, b;

  StrategyComparer(this.a, this.b);

  String compare() {
    if (a.totalProfit > b.totalProfit) return "A Ø£ÙØ¶Ù„";
    if (b.totalProfit > a.totalProfit) return "B Ø£ÙØ¶Ù„";
    return "Ù…ØªØ¹Ø§Ø¯Ù„Ø§Ù†";
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/analytics/domain/strategy_comparer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 706: lib/features/analytics/domain/trade_statistics.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/analytics/domain/trade_statistics.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 661.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import '../../../features/trading/domain/order/order.dart';

class TradeStatistics {
  final List<Order> orders;

  TradeStatistics(this.orders);

  double get totalProfit => orders.fold(0.0, (sum, o) => sum + (o.filledLots * o.price));

  double get winRate {
    final wins = orders.where((o) => o.price > 0).length;
    return orders.isEmpty ? 0 : wins / orders.length;
  }

  double get maxDrawdown {
    // Ù…Ø«Ø§Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ
    double peak = 0;
    double drawdown = 0;
    double equity = 0;
    for (var o in orders) {
      equity += o.price;
      if (equity > peak) peak = equity;
      drawdown = peak - equity;
    }
    return drawdown;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/analytics/domain/trade_statistics.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 707: lib/features/indicators/domain/ema_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/ema_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 405.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

class EmaCalculator {
  final int period;
  late double _multiplier;
  double? _prevEma;

  EmaCalculator(this.period) {
    _multiplier = 2.0 / (period + 1);
  }

  double calculate(double price) {
    if (_prevEma == null) {
      _prevEma = price;
    } else {
      _prevEma = (price - _prevEma!) * _multiplier + _prevEma!;
    }
    return _prevEma!;
  }

  void reset() {
    _prevEma = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/ema_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 708: lib/features/indicators/domain/rsi_calculator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/rsi_calculator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 811.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 36
================================================================================

class RsiCalculator {
  final int period;
  final List<double> _gains = [];
  final List<double> _losses = [];

  RsiCalculator(this.period);

  double? calculate(double prevClose, double close) {
    final diff = close - prevClose;
    final gain = diff > 0 ? diff : 0;
    final loss = diff < 0 ? -diff : 0;

    _gains.add(gain);
    _losses.add(loss);

    if (_gains.length > period) {
      _gains.removeAt(0);
      _losses.removeAt(0);
    }

    if (_gains.length < period) return null;

    final avgGain =
        _gains.reduce((a, b) => a + b) / _gains.length;
    final avgLoss =
        _losses.reduce((a, b) => a + b) / _losses.length;

    final rs = avgLoss == 0 ? 100 : avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  }

  void reset() {
    _gains.clear();
    _losses.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/rsi_calculator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 709: lib/features/indicators/domain/compute_lock.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/compute_lock.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 239.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'dart:async';

class ComputeLock {
  bool _busy = false;

  Future<T?> run<T>(Future<T> Function() fn) async {
    if (_busy) return null;
    _busy = true;
    final result = await fn();
    _busy = false;
    return result;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/compute_lock.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 710: lib/features/indicators/domain/visible_synchronizer_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/visible_synchronizer_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 274.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import '../../../core/models/candle_entity.dart';

class VisibleSynchronizerFix {
  List<CandleEntity> sync(
      List<CandleEntity> all, DateTime from, DateTime to) {
    return all.where((c) =>
        !c.timeUtc.isBefore(from) && !c.timeUtc.isAfter(to)).toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/visible_synchronizer_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 711: lib/features/indicators/domain/indicator_cache_cleanup.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/indicator_cache_cleanup.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 109.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

class IndicatorCacheCleanup {
  static void clearCache(Map<String, double> cache) {
    cache.clear();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/indicator_cache_cleanup.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 712: lib/features/indicators/domain/sync_aligner.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/sync_aligner.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 157.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

class SyncAligner {
  final Duration bufferDelay = Duration(milliseconds: 500);

  DateTime align(DateTime input) {
    return input.add(bufferDelay);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/sync_aligner.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 713: lib/features/indicators/domain/live_indicator_updater.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/live_indicator_updater.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 697.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import '../../../core/models/tick_entity.dart';
import '../../../core/models/candle_entity.dart';

class LiveIndicatorUpdater {
  CandleEntity _current = CandleEntity(...); // ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø¢Ø®Ø± Ø´Ù…Ø¹Ø©

  void onTick(TickEntity tick) {
    // ØªØ­Ø¯ÙŠØ« High/Low/Close Ù„Ø­Ø¸ÙŠÙ‹Ø§
    final mid = (tick.price.ask + tick.price.bid) / 2;
    _current = CandleEntity(
      instrument: _current.instrument,
      timeUtc: _current.timeUtc,
      open: _current.open,
      high: mid > _current.high ? mid : _current.high,
      low: mid < _current.low ? mid : _current.low,
      close: mid,
      volume: _current.volume + 1,
    );

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/live_indicator_updater.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 714: lib/features/indicators/domain/visible_range_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/visible_range_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 291.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import '../../../core/models/candle_entity.dart';

class VisibleRangeEngine {
  List<CandleEntity> applyVisibleRange(
    List<CandleEntity> candles,
    DateTime from,
    DateTime to,
  ) {
    return candles.where((c) => c.timeUtc.isAfter(from) && c.timeUtc.isBefore(to)).toList();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/visible_range_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 715: lib/features/indicators/domain/indicator_queue_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/indicator_queue_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 215.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

import 'dart:async';

class IndicatorQueueFix {
  final _queue = StreamController<void>();

  void enqueue(void Function() task) {
    _queue.add(null);
    task();
  }

  void dispose() {
    _queue.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/indicator_queue_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 716: lib/features/indicators/domain/indicator_engine_compute_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/indicator_engine_compute_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 487.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import '../../../../core/sync/compute_guard.dart';
import '../../../core/models/candle_entity.dart';

class IndicatorEngineComputeFix {
  final ComputeGuard _guard = ComputeGuard();

  Future<Map<String, double>> computeSafe(
      List<CandleEntity> snapshot,
      Future<Map<String, double>> Function(List<CandleEntity>) computeFn) async {
    Map<String, double> result = {};
    await _guard.run(() async {
      result = await computeFn(snapshot);
    });
    return result;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/indicator_engine_compute_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 717: lib/features/indicators/domain/indicator_update_lock.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/indicator_update_lock.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 218.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'dart:async';

class IndicatorUpdateLock {
  bool _busy = false;

  Future<void> run(Future<void> Function() action) async {
    if (_busy) return;
    _busy = true;
    await action();
    _busy = false;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/indicator_update_lock.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 718: lib/features/indicators/domain/gap/gap_aware_indicator.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/domain/gap/gap_aware_indicator.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 996.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

import '../../../../core/models/candle_entity.dart';

class GapAwareIndicator {
  static List<CandleEntity> fillGaps(
      List<CandleEntity> data, Duration interval) {
    if (data.isEmpty) return data;
    final List<CandleEntity> filled = [];
    for (int i = 0; i < data.length - 1; i++) {
      filled.add(data[i]);
      final diff = data[i + 1].timeUtc
          .difference(data[i].timeUtc)
          .inMilliseconds;
      if (diff > interval.inMilliseconds) {
        // Gap exists
        final count = (diff / interval.inMilliseconds).floor() - 1;
        for (int j = 1; j <= count; j++) {
          filled.add(CandleEntity(
            timeUtc: data[i].timeUtc
                .add(Duration(milliseconds: interval.inMilliseconds * j)),
            open: data[i].close,
            high: data[i].close,
            low: data[i].close,
            close: data[i].close,
            volume: 0,
          ));
        }
      }
    }
    filled.add(data.last);
    return filled;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/domain/gap/gap_aware_indicator.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 719: lib/features/indicators/data/cache/indicator_results_cache_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/data/cache/indicator_results_cache_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 245.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'dart:collection';

class IndicatorResultsCacheFix {
  final _cache = HashMap<String, double>();

  void put(String key, double value) => _cache[key] = value;
  double? get(String key) => _cache[key];

  void clear() => _cache.clear();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/data/cache/indicator_results_cache_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 720: lib/features/indicators/plugins/ema_plugin.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/plugins/ema_plugin.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 575.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import '../../engine/indicator_engine.dart';
import '../../../../core/models/candle_entity.dart';

class EMAPlugin implements IndicatorPlugin {
  final int period;
  double? prevEma;

  EMAPlugin(this.period);

  @override
  Map<String, double> compute(List<CandleEntity> candles) {
    final prices = candles.map((e) => e.close).toList();
    final multiplier = 2 / (period + 1);
    double? ema = prevEma ?? prices.first;

    for (final price in prices) {
      ema = (price - ema!) * multiplier + ema;
    }

    prevEma = ema;
    return {'EMA$period': ema ?? 0};
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/plugins/ema_plugin.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 721: lib/features/indicators/plugins/vwap_plugin_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/plugins/vwap_plugin_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 308.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

Map<String, double> compute(List candles) {
  double cumulPV = 0, cumulVol = 0;
  for (var c in candles) {
    final typical = (c.high + c.low + c.close) / 3;
    cumulPV += typical * c.volume;
    cumulVol += c.volume;
  }
  final vwap = cumulVol == 0 ? 0.0 : cumulPV / cumulVol;
  return {'VWAP': vwap};
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/plugins/vwap_plugin_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 722: lib/features/indicators/plugins/rsi_plugin_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/plugins/rsi_plugin_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 137.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

Map<String, double> compute(...) {
  if (candles.length < period) {
    return {"RSI$period": 0.0};
  }
  // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/plugins/rsi_plugin_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 723: lib/features/indicators/plugins/vwap_plugin.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/plugins/vwap_plugin.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 499.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import '../../engine/indicator_engine.dart';
import '../../../../core/models/candle_entity.dart';

class VWAPPlugin implements IndicatorPlugin {
  @override
  Map<String, double> compute(List<CandleEntity> candles) {
    double cumulPV = 0, cumulVol = 0;
    for (var c in candles) {
      final typical = (c.high + c.low + c.close) / 3;
      cumulPV += typical * c.volume;
      cumulVol += c.volume;
    }
    final vwap = cumulVol == 0 ? 0 : cumulPV / cumulVol;
    return {'VWAP': vwap};
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/plugins/vwap_plugin.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 724: lib/features/indicators/presentation/indicator_selector.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/presentation/indicator_selector.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 531.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter/material.dart';

class IndicatorSelector extends StatelessWidget {
  final Function(String) onSelect;

  IndicatorSelector({required this.onSelect});

  @override
  Widget build(BuildContext context) {
    final indicators = ["EMA", "RSI", "Stochastic", "MACD"];

    return BottomSheet(
      onClosing: () {},
      builder: (ctx) => ListView(
        children: indicators.map((ind) => ListTile(
          title: Text(ind),
          onTap: () => onSelect(ind),
        )).toList(),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/presentation/indicator_selector.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 725: lib/features/indicators/presentation/bloc/indicators_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/presentation/bloc/indicators_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 318.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

part of 'indicators_bloc.dart';

abstract class IndicatorsEvent {}

class CalculateIndicators extends IndicatorsEvent {
  final List<double> emaShort;
  final List<double> emaLong;
  final List<double> rsi;

  CalculateIndicators({
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/presentation/bloc/indicators_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 726: lib/features/indicators/presentation/bloc/indicators_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/presentation/bloc/indicators_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 546.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';

part 'indicators_event.dart';
part 'indicators_state.dart';

class IndicatorsBloc
    extends Bloc<IndicatorsEvent, IndicatorsState> {
  IndicatorsBloc() : super(IndicatorsInitial()) {
    on<CalculateIndicators>((event, emit) {
      emit(IndicatorsCalculating());
      final emaShort = event.emaShort;
      final emaLong = event.emaLong;
      final rsi = event.rsi;
      emit(IndicatorsLoaded(
        emaShort: emaShort,
        emaLong: emaLong,
        rsi: rsi,
      ));
    });
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/presentation/bloc/indicators_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 727: lib/features/indicators/presentation/bloc/indicators_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/presentation/bloc/indicators_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 420.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

part of 'indicators_bloc.dart';

abstract class IndicatorsState {}

class IndicatorsInitial extends IndicatorsState {}

class IndicatorsCalculating extends IndicatorsState {}

class IndicatorsLoaded extends IndicatorsState {
  final List<double> emaShort;
  final List<double> emaLong;
  final List<double> rsi;

  IndicatorsLoaded({
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/presentation/bloc/indicators_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 728: lib/features/indicators/engine/zoom_sensitive_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/engine/zoom_sensitive_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 415.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import '../../../core/models/candle_entity.dart';
import 'indicator_engine.dart';

class ZoomSensitiveEngine extends IndicatorEngine {
  ZoomSensitiveEngine(super.plugins);

  Map<String, double> calculateInRange(
      List<CandleEntity> all, DateTime from, DateTime to) {
    final visible = all.where((c) => c.timeUtc.isAfter(from) && c.timeUtc.isBefore(to)).toList();
    return super.calculate(visible);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/engine/zoom_sensitive_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 729: lib/features/indicators/engine/plugin_manager_cleanup_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/engine/plugin_manager_cleanup_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 350.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'indicator_engine.dart';

class PluginManagerCleanupFix {
  final List<IndicatorPlugin> _active = [];

  void add(IndicatorPlugin p) {
    _active.add(p);
  }

  void remove(IndicatorPlugin p) {
    _active.removeWhere((x) => x == p);
    // ØªØ­Ø±Ù‘Ø± Ø£ÙŠ Ù…ÙˆØ±Ø¯ Ø¯Ø§Ø®Ù„ÙŠ Ø¯Ø§Ø®Ù„ p Ø¥Ù† ÙˆØ¬Ø¯
  }

  void clear() => _active.clear();
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/engine/plugin_manager_cleanup_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 730: lib/features/indicators/engine/indicator_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/engine/indicator_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 458.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import '../../../core/models/candle_entity.dart';

abstract class IndicatorPlugin {
  Map<String, double> compute(List<CandleEntity> candles);
}

class IndicatorEngine {
  final List<IndicatorPlugin> plugins;

  IndicatorEngine(this.plugins);

  Map<String, double> calculate(List<CandleEntity> candles) {
    final result = <String, double>{};
    for (final plugin in plugins) {
      result.addAll(plugin.compute(candles));
    }
    return result;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/engine/indicator_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 731: lib/features/indicators/engine/plugin_manager_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/engine/plugin_manager_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 318.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import 'indicator_engine.dart';

class PluginManagerFix {
  final List<IndicatorPlugin> _plugins = [];

  void add(IndicatorPlugin p) => _plugins.add(p);

  void remove(IndicatorPlugin p) => _plugins.remove(p);

  void clear() => _plugins.clear();

  List<IndicatorPlugin> get active => List.unmodifiable(_plugins);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/engine/plugin_manager_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 732: lib/features/indicators/engine/zoom_sensitive_engine_fix.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/engine/zoom_sensitive_engine_fix.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 461.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../core/models/candle_entity.dart';
import 'indicator_engine.dart';

class ZoomSensitiveEngineFix extends IndicatorEngine {
  ZoomSensitiveEngineFix(super.plugins);

  Map<String, double> calculateInRange(
      List<CandleEntity> all, DateTime from, DateTime to) {
    final visible = all.where((c) =>
      !c.timeUtc.isBefore(from) && !c.timeUtc.isAfter(to)
    ).toList();
    final result = super.calculate(visible);
    return result;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/engine/zoom_sensitive_engine_fix.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 733: lib/features/indicators/engine/windowed_engine.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/engine/windowed_engine.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 477.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import '../../../core/models/candle_entity.dart';
import 'indicator_engine.dart';

class WindowedIndicatorEngine extends IndicatorEngine {
  WindowedIndicatorEngine(super.plugins);

  @override
  Map<String, double> calculate(List<CandleEntity> candles) {
    final windowSize = 500; // Ø¢Ø®Ø± 500 Ø´Ù…Ø¹Ø© ÙÙ‚Ø·
    final subset = candles.length > windowSize
        ? candles.sublist(candles.length - windowSize)
        : candles;
    return super.calculate(subset);
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/engine/windowed_engine.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 734: lib/features/indicators/render/batch_indicator_renderer.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/indicators/render/batch_indicator_renderer.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 200.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

import 'dart:ui';

class BatchIndicatorRenderer {
  void draw(Canvas canvas, Size size, List<Function(Canvas, Size)> draws) {
    for (final drawFn in draws) {
      drawFn(canvas, size);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/indicators/render/batch_indicator_renderer.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 735: lib/features/portrait/presentation/pages/alerts_portrait_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/portrait/presentation/pages/alerts_portrait_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 903.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../market/presentation/bloc/smart_alert/smart_alert_bloc.dart';
import '../../../market/presentation/bloc/smart_alert/smart_alert_state.dart';

class AlertsPortraitPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<SmartAlertBloc, SmartAlertState>(
      builder: (context, state) {
        if (state is SmartAlertUpdated) {
          return ListView.builder(
            itemCount: state.alerts.length,
            itemBuilder: (ctx, i) {
              final alert = state.alerts[i];
              return ListTile(
                title: Text(alert.condition.type.toString()),
                subtitle: Text("Active"),
              );
            },
          );
        }
        return Center(child: Text("No Alerts"));
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/portrait/presentation/pages/alerts_portrait_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 736: lib/features/portrait/presentation/pages/indicators_portrait_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/portrait/presentation/pages/indicators_portrait_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1018.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter/material.dart';
import '../../../market/presentation/bloc/chart/chart_bloc.dart';
import '../../../market/presentation/bloc/chart/chart_state.dart';
import '../../../market/presentation/widgets/custom_chart/multi_indicator_chart.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class IndicatorsPortraitPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text("Indicators", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
        Expanded(
          child: BlocBuilder<ChartBloc, ChartState>(
            builder: (context, state) {
              if (state is ChartLoaded) {
                return MultiIndicatorChart(
                  prices: state.candles.map((c) => c.close).toList(),
                  indicators: state.indicators,
                );
              }
              return Center(child: CircularProgressIndicator());
            },
          ),
        ),
      ],
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/portrait/presentation/pages/indicators_portrait_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 737: lib/features/portrait/presentation/pages/portrait_home_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/portrait/presentation/pages/portrait_home_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 42
================================================================================

import 'package:flutter/material.dart';
import '../../../market/presentation/pages/interactive_chart_page.dart';
import '../widgets/portrait_tabs.dart';

class PortraitHomePage extends StatefulWidget {
  final String symbol;
  PortraitHomePage({required this.symbol});

  @override
  _PortraitHomePageState createState() => _PortraitHomePageState();
}

class _PortraitHomePageState extends State<PortraitHomePage> {
  int _currentTab = 0;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: IndexedStack(
                index: _currentTab,
                children: [
                  InteractiveChartPage(symbol: widget.symbol),
                  IndicatorsPortraitPage(), // Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                  OrdersPortraitPage(),     // Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                  AlertsPortraitPage(),     // Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                ],
              ),
            ),
            PortraitTabBar(
              currentIndex: _currentTab,
              onTap: (idx) => setState(() => _currentTab = idx),
            ),
          ],
        ),
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/portrait/presentation/pages/portrait_home_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 738: lib/features/portrait/presentation/pages/orders_portrait_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/portrait/presentation/pages/orders_portrait_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 896.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter/material.dart';
import '../../../market/presentation/bloc/trading/trading_bloc.dart';
import '../../../market/presentation/bloc/trading/trading_state.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class OrdersPortraitPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<TradingBloc, TradingState>(
      builder: (context, state) {
        if (state is TradingUpdated) {
          return ListView(
            padding: EdgeInsets.all(12),
            children: state.openPositions.map((p) {
              return ListTile(
                title: Text("${p.instrument} â€” ${p.units.toString()}"),
                subtitle: Text("P/L: ${p.floatingPL.toStringAsFixed(2)}"),
              );
            }).toList(),
          );
        }
        return Center(child: Text("No Positions"));
      },
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/portrait/presentation/pages/orders_portrait_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 739: lib/features/portrait/presentation/widgets/portrait_tabs.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/portrait/presentation/widgets/portrait_tabs.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 756.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:flutter/material.dart';

class PortraitTabBar extends StatelessWidget {
  final int currentIndex;
  final Function(int) onTap;

  const PortraitTabBar({required this.currentIndex, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return BottomNavigationBar(
      currentIndex: currentIndex,
      onTap: onTap,
      items: [
        BottomNavigationBarItem(icon: Icon(Icons.show_chart), label: "Chart"),
        BottomNavigationBarItem(icon: Icon(Icons.bar_chart), label: "Indicators"),
        BottomNavigationBarItem(icon: Icon(Icons.list), label: "Orders"),
        BottomNavigationBarItem(icon: Icon(Icons.notifications), label: "Alerts"),
      ],
      type: BottomNavigationBarType.fixed,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/portrait/presentation/widgets/portrait_tabs.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 740: lib/features/portrait/presentation/widgets/portrait_floating_controls.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/portrait/presentation/widgets/portrait_floating_controls.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 47
================================================================================

import 'package:flutter/material.dart';
import '../../../replay/domain/entities/speed.dart';

class PortraitFloatingControls extends StatelessWidget {
  final Function() onZoomIn;
  final Function() onZoomOut;
  final Function(ReplaySpeed) onSpeedChange;

  const PortraitFloatingControls({
    required this.onZoomIn,
    required this.onZoomOut,
    required this.onSpeedChange,
  });

  @override
  Widget build(BuildContext context) {
    return Positioned(
      right: 16,
      bottom: 16,
      child: Column(
        children: [
          FloatingActionButton(
            heroTag: "zoomIn",
            mini: true,
            child: Icon(Icons.zoom_in),
            onPressed: onZoomIn,
          ),
          SizedBox(height: 8),
          FloatingActionButton(
            heroTag: "zoomOut",
            mini: true,
            child: Icon(Icons.zoom_out),
            onPressed: onZoomOut,
          ),
          SizedBox(height: 8),
          PopupMenuButton<ReplaySpeed>(
            icon: Icon(Icons.speed),
            itemBuilder: (_) => ReplaySpeed.values
                .map((s) => PopupMenuItem(value: s, child: Text(s.name)))
                .toList(),
            onSelected: (speed) => onSpeedChange(speed),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/portrait/presentation/widgets/portrait_floating_controls.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 741: lib/features/stream/presentation/bloc/price_stream_bloc.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/stream/presentation/bloc/price_stream_bloc.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 949.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 36
================================================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:equatable/equatable.dart';
import '../../data/price_stream.dart';

part 'price_stream_event.dart';
part 'price_stream_state.dart';

class PriceStreamBloc extends Bloc<PriceStreamEvent, PriceStreamState> {
  final PriceStream streamService;

  StreamSubscription<double>? _subscription;

  PriceStreamBloc({required this.streamService}) : super(PriceStreamInitial()) {
    on<StartPriceStream>((event, emit) {
      emit(PriceStreamLoading());
      _subscription = streamService.getPrices().listen(
        (price) => add(NewPriceReceived(price)),
      );
    });

    on<NewPriceReceived>((event, emit) {
      emit(PriceStreamUpdated(price: event.price));
    });

    on<StopPriceStream>((event, emit) {
      _subscription?.cancel();
      emit(PriceStreamStopped());
    });
  }

  @override
  Future<void> close() {
    _subscription?.cancel();
    return super.close();
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/stream/presentation/bloc/price_stream_bloc.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 742: lib/features/stream/presentation/bloc/price_stream_event.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/stream/presentation/bloc/price_stream_event.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 427.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

part of 'price_stream_bloc.dart';

abstract class PriceStreamEvent extends Equatable {
  const PriceStreamEvent();
  @override
  List<Object?> get props => [];
}

class StartPriceStream extends PriceStreamEvent {}
class StopPriceStream extends PriceStreamEvent {}
class NewPriceReceived extends PriceStreamEvent {
  final double price;
  const NewPriceReceived(this.price);

  @override
  List<Object?> get props => [price];
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/stream/presentation/bloc/price_stream_event.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 743: lib/features/stream/presentation/bloc/price_stream_state.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/stream/presentation/bloc/price_stream_state.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 499.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

part of 'price_stream_bloc.dart';

abstract class PriceStreamState extends Equatable {
  const PriceStreamState();
  @override
  List<Object?> get props => [];
}

class PriceStreamInitial extends PriceStreamState {}
class PriceStreamLoading extends PriceStreamState {}
class PriceStreamUpdated extends PriceStreamState {
  final double price;
  const PriceStreamUpdated({required this.price});
  @override
  List<Object?> get props => [price];
}
class PriceStreamStopped extends PriceStreamState {}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/stream/presentation/bloc/price_stream_state.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 744: lib/features/stream/data/price_stream.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/features/stream/data/price_stream.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 193.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 10
================================================================================

import 'dart:async';

class PriceStream {
  Stream<double> getPrices() {
    return Stream.periodic(
      Duration(seconds: 1),
      (count) => 1000 + count + (count % 5) * 0.3,
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/features/stream/data/price_stream.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 745: lib/market/data/repositories/market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/market/data/repositories/market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 42
================================================================================

import '../../../core/storage/chart_cache/chart_cache_storage.dart';
import '../../../core/network/rest_client.dart';
import '../../../core/models/candle_entity.dart';

class MarketRepository {
  final RestClient rest;
  final ChartCacheStorage cache;

  MarketRepository({required this.rest, required this.cache});

  Future<List<CandleEntity>> getHistoricalCandles({
    required String symbol,
    required String timeframe,
  }) async {
    final cached = await cache.get(symbol, timeframe);
    if (cached.isNotEmpty) {
      // return cache while fetching remote update
      _refreshRemote(symbol, timeframe);
      return cached;
    }
    final remote = await _fetchRemote(symbol, timeframe);
    await cache.save(symbol, timeframe, remote);
    return remote;
  }

  Future<void> _refreshRemote(String symbol, String timeframe) async {
    try {
      final remote = await _fetchRemote(symbol, timeframe);
      await cache.save(symbol, timeframe, remote);
    } catch (e) {
      // ignore
    }
  }

  Future<List<CandleEntity>> _fetchRemote(
      String symbol, String timeframe) async {
    final resp = await rest.get("/history/$symbol/$timeframe");
    // parse JSON â†’ List<CandleEntity>
    // implementation depends on API shape
    return [];
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/market/data/repositories/market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 746: lib/flavors/flavors.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/flavors/flavors.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 35.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

enum Flavor { dev, staging, prod }

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/flavors/flavors.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 747: lib/repositories/market/market_repository.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/repositories/market/market_repository.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 85
================================================================================

import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../../core/network/rest/rest_client.dart';
import '../../core/network/ws/ws_manager.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';

/// MarketRepository: ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ù…Ù† REST Ùˆ WS
class MarketRepository {
  final RestClient rest;
  final WsManager ws;
  final Duration timeframe;

  final _agg;
  Stream<Candle>? _candleStream;

  MarketRepository({
    required RestClient restClient,
    required WsManager wsManager,
    this.timeframe = const Duration(minutes: 1),
  })  : rest = restClient,
        ws = wsManager,
        _agg = TickAggregator(const Duration(minutes: 1));

  /// Fetch historical candles via REST
  Future<List<Candle>> fetchHistoricalCandles({
    required String symbol,
    required DateTime from,
    required DateTime to,
  }) async {
    final response = await rest.get(
      "/v3/instruments/\$symbol/candles",
      query: {
        "from": from.toIso8601String(),
        "to": to.toIso8601String(),
        "granularity": "\${timeframe.inMinutes}M",
      },
    );

    final List<Candle> result = [];
    try {
      final List<dynamic> raw = (response.body is List)
          ? (response.body as List<dynamic>)
          : [];

      for (var item in raw) {
        final t = DateTime.parse(item["time"] as String);
        final o = item["open"] as num;
        final h = item["high"] as num;
        final l = item["low"] as num;
        final c = item["close"] as num;

        result.add(
          Candle(openTime: t, open: o.toDouble(), high: h.toDouble(), low: l.toDouble(), close: c.toDouble()),
        );
      }
    } catch (_) {}

    return result;
  }

  /// Start streaming and build candle stream
  Stream<Candle> startLiveStream({required String wsUrl}) {
    ws.connect();
    _candleStream = ws.stream.map((msg) {
      final price = msg["price"] as num;
      final time = DateTime.parse(msg["time"] as String);
      final tick = Tick(price.toDouble(), time);
      _agg.addTick(tick);
      return _agg.stream;
    }).transform(
      StreamTransformer.fromHandlers(
        handleData: (stream, sink) {
          stream.listen(sink.add);
        },
      ),
    ).expand((x) => x);
    return _candleStream!;
  }

  /// Stop stream
  Future<void> stopLive() async {
    await ws.disconnect();
    _candleStream = null;
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/repositories/market/market_repository.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 748: lib/ui/pages/live_chart_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/ui/pages/live_chart_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 73
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../core/bloc/live_chart/live_chart_bloc.dart';
import '../../core/bloc/live_chart/live_chart_event.dart';
import '../../core/bloc/live_chart/live_chart_state.dart';
import '../../features/chart/presentation/widgets/chart_core/candlestick_chart_canvas.dart';
import '../../core/indicators/indicator_models.dart';
import '../../core/indicators/indicator_painter.dart';
import '../../ui/widgets/indicator_selector.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';

class LiveChartPage extends StatefulWidget {
  final String wsUrl;
  LiveChartPage({required this.wsUrl});

  @override
  _LiveChartPageState createState() => _LiveChartPageState();
}

class _LiveChartPageState extends State<LiveChartPage> {
  final List<IndicatorConfig> _indicators = [];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Live Chart")),
      body: Column(
        children: [
          IndicatorSelector(
            selected: _indicators,
            onAdd: (cfg) {
              setState(() => _indicators.add(cfg));
            },
            onRemove: (type) {
              setState(() =>
                  _indicators.removeWhere((c) => c.type == type));
            },
          ),
          ElevatedButton(
            onPressed: () {
              context.read<LiveChartBloc>().add(
                    LiveChartStart(widget.wsUrl),
                  );
            },
            child: Text("Start Live"),
          ),
          Expanded(
            child: BlocBuilder<LiveChartBloc, LiveChartState>(
              builder: (context, state) {
                if (state is LiveChartLoading) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is LiveChartRunning) {
                  return CustomPaint(
                    size: Size.infinite,
                    painter: IndicatorPainter(
                      candles: state.candles,
                      configs: _indicators,
                    ),
                  );
                }
                if (state is LiveChartError) {
                  return Center(child: Text("Error: \${state.message}"));
                }
                return Center(child: Text("Press Start"));
              },
            ),
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/ui/pages/live_chart_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 749: lib/ui/pages/backtest_result_page.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/lib/ui/pages/backtest_result_page.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 71
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../core/bloc/backtest/backtest_bloc.dart';
import '../../core/bloc/backtest/backtest_event.dart';
import '../../core/bloc/backtest/backtest_state.dart';
import '../../core/backtest/backtest_engine.dart';

class BacktestResultPage extends StatelessWidget {
  final String symbol;
  final DateTime start;
  final DateTime end;

  BacktestResultPage({
    required this.symbol,
    required this.start,
    required this.end,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Backtest")),
      body: Column(
        children: [
          ElevatedButton(
            onPressed: () {
              context.read<BacktestBloc>().add(
                    BacktestStart(
                      symbol: symbol,
                      start: start,
                      end: end,
                    ),
                  );
            },
            child: Text("Run Backtest"),
          ),
          BlocBuilder<BacktestBloc, BacktestState>(
            builder: (context, state) {
              if (state is BacktestRunning) {
                return Center(child: CircularProgressIndicator());
              }
              if (state is BacktestSuccess) {
                final r = state.result;
                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("Net Profit: \${r.netProfit}"),
                    Text("Max Drawdown: \${r.maxDrawdown}"),
                    Text("Trades: \${r.totalTrades}"),
                    SizedBox(height: 12),
                    Expanded(
                      child: ListView.builder(
                        itemCount: r.equityCurve.length,
                        itemBuilder: (ctx, i) =>
                            Text("Point \$i: \${r.equityCurve[i]}"),
                      ),
                    ),
                  ],
                );
              }
              if (state is BacktestError) {
                return Text("Error: \${state.message}");
              }
              return Container();
            },
          ),
        ],
      ),
    );
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: lib/ui/pages/backtest_result_page.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 750: test/widget_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widget_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 30
================================================================================

// This is a basic Flutter widget test.
//
// To perform an interaction with a widget in your test, use the WidgetTester
// utility in the flutter_test package. For example, you can send tap and scroll
// gestures. You can also use WidgetTester to find child widgets in the widget
// tree, read text, and verify that the values of widget properties are correct.

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';

import 'package:flutter_trading_app/main.dart';

void main() {
  testWidgets('Counter increments smoke test', (WidgetTester tester) async {
    // Build our app and trigger a frame.
    await tester.pumpWidget(const MyApp());

    // Verify that our counter starts at 0.
    expect(find.text('0'), findsOneWidget);
    expect(find.text('1'), findsNothing);

    // Tap the '+' icon and trigger a frame.
    await tester.tap(find.byIcon(Icons.add));
    await tester.pump();

    // Verify that our counter has incremented.
    expect(find.text('0'), findsNothing);
    expect(find.text('1'), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widget_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 751: test/network/ws/ws_pipeline_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/network/ws/ws_pipeline_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 432.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/core/network/ws/pipeline/ws_pipeline.dart';

void main() {
  test("Pipeline buffers and emits in order", () {
    final pipeline = WsPipeline(maxBufferSize: 3);
    final events = [];

    pipeline.stream.listen((data) {
      events.add(data);
    });

    pipeline.push(1);
    pipeline.push(2);
    pipeline.push(3);

    expect(events, [1, 2, 3]);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/network/ws/ws_pipeline_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 752: test/sync/sync_manager_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/sync/sync_manager_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 824.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/sync/sync_manager.dart';
import 'package:your_app/core/network/ws_manager.dart';
import 'package:your_app/core/network/rest_client.dart';
import 'package:your_app/features/market/data/streaming/tick_aggregator.dart';

void main() {
  test('SyncManager processes ticks and builds candles', () async {
    final ws = WSManager('wss://echo.websocket.events');
    final rest = RestClient('','');
    final agg = TickAggregator("SYM", Duration(seconds: 60));
    bool called = false;

    final manager = SyncManager(
      ws: ws,
      rest: rest,
      aggregator: agg,
      onCandle: (c) => called = true,
    );

    manager.start();
    await Future.delayed(Duration(seconds: 1));
    await manager.stop();

    expect(called, true);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/sync/sync_manager_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 753: test/storage/script/script_storage_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/storage/script/script_storage_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 662.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'dart:io';
import 'package:your_app/core/storage/script/script_storage.dart';
import 'package:your_app/core/storage/script/script_hive.dart';

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(ScriptEntityAdapter());
  });

  test('save and load script', () async {
    final storage = ScriptStorage();
    final script = ScriptEntity(name: "Test1", script: "EMA(10)>EMA(20)");
    await storage.saveScript(script);

    final loaded = await storage.loadScript("Test1");
    expect(loaded?.script, "EMA(10)>EMA(20)");
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/storage/script/script_storage_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 754: test/storage/theme/theme_storage_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/storage/theme/theme_storage_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 989.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 30
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'package:path_provider_platform_interface/path_provider_platform_interface.dart';
import 'package:your_app/core/storage/theme/theme_storage.dart';
import 'package:your_app/core/storage/theme/theme_hive.dart';
import 'dart:io';

class FakePathProvider extends Fake implements PathProviderPlatform {
  @override
  Future<String?> getApplicationDocumentsPath() async {
    return Directory.systemTemp.path;
  }
}

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(ThemeEntityAdapter());
  });

  test('save and load theme', () async {
    final store = ThemeStorage();
    final theme = ThemeEntity(isDark: true, primaryColorValue: 0xFF0000, accentColorValue: 0x00FF00);
    await store.saveTheme(theme);

    final loaded = await store.loadTheme();
    expect(loaded?.isDark, true);
    expect(loaded?.primaryColorValue, theme.primaryColorValue);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/storage/theme/theme_storage_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 755: test/storage/indicator/indicator_storage_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/storage/indicator/indicator_storage_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 707.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'dart:io';
import 'package:your_app/core/storage/indicator/indicator_storage.dart';
import 'package:your_app/core/storage/indicator/indicator_hive.dart';

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(IndicatorSettingsEntityAdapter());
  });

  test('save and load indicator settings', () async {
    final store = IndicatorSettingsStorage();
    final e = IndicatorSettingsEntity(id: "EMA10", params: {"color": 0xFF0000});
    await store.saveSettings(e);

    final loaded = await store.loadSettings("EMA10");
    expect(loaded?.params["color"], 0xFF0000);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/storage/indicator/indicator_storage_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 756: test/storage/audit/audit_storage_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/storage/audit/audit_storage_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 655.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 21
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'dart:io';
import 'package:your_app/core/storage/audit/audit_storage.dart';
import 'package:your_app/core/storage/audit/audit_hive.dart';

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(AuditEntityAdapter());
  });

  test('log and retrieve audit event', () async {
    final storage = AuditStorage();
    final event = AuditEntity(time: DateTime.now(), type: "Test", message: "Hello");
    await storage.logEvent(event);

    final list = await storage.getEvents();
    expect(list.length, greaterThan(0));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/storage/audit/audit_storage_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 757: test/ws/ws_manager_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/ws/ws_manager_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 378.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/network/ws_manager.dart';

void main() {
  test('WSManager initializes and reconnects', () async {
    final ws = WSManager('wss://echo.websocket.events');
    ws.connect();

    await Future.delayed(Duration(seconds: 2));
    ws.send('ping');

    await ws.stream.first;

    ws.dispose();
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/ws/ws_manager_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 758: test/unit/analytics_calculator_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/analytics_calculator_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 541.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/analytics/analytics_calculator.dart';

void main() {
  group('AnalyticsCalculator', () {
    test('calculates correct metrics', () {
      final profits = [100.0, -50.0, 25.0];

      final result = AnalyticsCalculator.calculate(profits);

      expect(result.netProfit, 75.0);
      expect(result.totalTrades, 3);
      expect(result.wins, 2);
      expect(result.losses, 1);
      expect(result.winRate, closeTo(66.67, 0.1));
    });
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/analytics_calculator_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 759: test/unit/chart_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/chart_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 34
================================================================================

import 'package:bloc_test/bloc_test.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_state.dart';
import 'package:mocktail/mocktail.dart';

class MockChartRepository extends Mock implements ChartRepository {}

void main() {
  group('ChartBloc', () {
    late MockChartRepository mockRepo;
    late ChartBloc chartBloc;

    setUp(() {
      mockRepo = MockChartRepository();
      chartBloc = ChartBloc(mockRepo, symbol: 'TEST', timeframe: 'M1');
    });

    blocTest<ChartBloc, ChartState>(
      'emits [ChartLoading, ChartLoaded] when data is fetched',
      build: () {
        when(() => mockRepo.getHistoricalCandles(
              symbol: any(named: 'symbol'),
              timeframe: any(named: 'timeframe'),
              count: any(named: 'count'),
            )).thenAnswer((_) async => []);
        return chartBloc;
      },
      act: (bloc) => bloc.add(LoadChartHistory(symbol: 'TEST', timeframe: 'M1')),
      expect: () => [isA<ChartLoading>(), isA<ChartLoaded>()],
    );
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/chart_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 760: test/unit/indicator_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/indicator_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 672.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/features/indicators/domain/ema_calculator.dart';
import 'package:my_app/features/indicators/domain/rsi_calculator.dart';

void main() {
  test('EMA calculator works correctly', () {
    final ema = EmaCalculator(5);
    final values = [1, 2, 3, 4, 5];
    final result = values.map((v) => ema.calculate(v)).toList();
    expect(result.isNotEmpty, true);
  });

  test('RSI calculator returns a number between 0 and 100', () {
    final rsi = RsiCalculator(5);
    double prev = 1, curr = 2;
    final val = rsi.calculate(prev, curr);
    expect(val != null && val! >= 0 && val <= 100, true);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/indicator_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 761: test/unit/backtest/backtest_engine_profit_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/backtest/backtest_engine_profit_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('Backtest net profit should accumulate correctly', () {
    // Construct history where price moves up
    final history = [
      CandleEntity(instrument: "EUR_USD", timeUtc: DateTime.utc(2025,1,1), open: 1.0, high: 2.0, low: 1.0, close: 1.5, volume: 1),
      CandleEntity(instrument: "EUR_USD", timeUtc: DateTime.utc(2025,1,1,0,1), open: 1.5, high: 2.5, low: 1.5, close: 2.0, volume: 1),
    ];

    final engine = BacktestEngine(
      history: history,
      evaluator: buildExampleStrategy(),
      initialBalance: 1000,
      takeProfit: 0,
      stopLoss: 0,
    );

    final result = engine.run();

    expect(result.netProfit, greaterThan(0));
    expect(result.equityCurve.last, greaterThan(result.equityCurve.first));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/backtest/backtest_engine_profit_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 762: test/unit/indicators/rsi_no_loss_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/indicators/rsi_no_loss_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 658.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/indicators/rsi_indicator.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('RSI when there is no loss should be 100', () {
    final rsi = RSIIndicator(14);
    final candles = List.generate(20, (i) => CandleEntity(
      instrument: "EUR_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble()+1,
      low: i.toDouble(),
      close: i.toDouble()+2,
      volume: 1,
    ));

    for (var c in candles) {
      rsi.addCandle(c);
    }

    expect(rsi.current, 100.0);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/indicators/rsi_no_loss_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 763: test/unit/indicators/ema_indicator_edge_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/indicators/ema_indicator_edge_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 677.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/indicators/ema_indicator.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('EMA with constant values stabilizes', () {
    final ema = EMAIndicator(5);
    final candles = List.generate(100, (i) => CandleEntity(
      instrument: "XAU_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: 10.0,
      high: 10.0,
      low: 10.0,
      close: 10.0,
      volume: 1,
    ));

    for (var c in candles) {
      ema.addCandle(c);
    }

    // After many identical closes, current should equal 10
    expect(ema.current, 10.0);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/indicators/ema_indicator_edge_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 764: test/unit/streaming/tick_aggregator_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/streaming/tick_aggregator_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 710.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/data/streaming/tick_aggregator.dart';
import 'package:your_app/core/models/tick_entity.dart';

void main() {
  test('TickAggregator handles out of order ticks', () {
    final agg = TickAggregator("EUR_USD", Duration(seconds: 60));

    final t1 = TickEntity(instrument:"EUR_USD", timeUtc: DateTime.utc(2025,1,1,0,1), bid:2, ask:2);
    final t0 = TickEntity(instrument:"EUR_USD", timeUtc: DateTime.utc(2025,1,1,0,0), bid:1, ask:1);

    agg.addTick(t1);
    agg.addTick(t0);

    final candles = agg.buildCandles();
    expect(candles.length, 2);
    expect(candles[0].open, 1);
    expect(candles[1].open, 2);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/streaming/tick_aggregator_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 765: test/unit/network/rest_token_expired_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/network/rest_token_expired_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 485.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/network/rest_client.dart';
import 'package:http/http.dart' as http;
import 'package:http/testing.dart';

void main() {
  test('REST client handles token expired (401)', () async {
    final mockClient = MockClient((request) async {
      return http.Response('', 401);
    });

    final client = RestClient("token","base", client: mockClient);
    expect(() => client.get("/x"), throwsException);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/network/rest_token_expired_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 766: test/unit/network/rest_client_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/network/rest_client_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 778.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 27
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:http/http.dart' as http;
import 'package:http/testing.dart';
import 'dart:convert';

import 'package:my_app/core/network/rest/rest_client.dart';

void main() {
  test('REST GET success', () async {
    final mockClient = MockClient((request) async {
      return http.Response(jsonEncode({"result": "ok"}), 200);
    });

    final client = RestClient();
    final res = await client.get("/test", headers: {"x": "y"});
    expect(res["result"], "ok");
  });

  test('REST GET failure throws', () async {
    final mockClient = MockClient((request) async {
      return http.Response("Error", 500);
    });

    final client = RestClient();
    expect(() => client.get("/fail"), throwsA(isA<Exception>());
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/network/rest_client_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 767: test/unit/models/candle_tick_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/unit/models/candle_tick_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 903.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/features/market/domain/models/candle.dart';
import 'package:my_app/features/market/domain/models/tick.dart';

void main() {
  test('Candle from REST JSON parsing', () {
    final json = {
      "time": "2025-01-01T10:00:00Z",
      "o": "1.1",
      "h": "1.2",
      "l": "1.05",
      "c": "1.15",
      "volume": "100"
    };

    final c = Candle.fromRestJson(json);
    expect(c.open, 1.1);
    expect(c.high, 1.2);
    expect(c.low, 1.05);
    expect(c.close, 1.15);
    expect(c.volume, 100);
  });

  test('Tick from OANDA WS JSON', () {
    final json = {
      "type": "PRICE",
      "time": "2025-01-01T10:00:01Z",
      "bids": [
        {"price": "1.25"}
      ],
      "asks": [
        {"price": "1.26"}
      ]
    };

    final t = Tick.fromOandaWs(json);
    expect(t.bid, 1.25);
    expect(t.ask, 1.26);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/unit/models/candle_tick_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 768: test/strategy/sequential_evaluator_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/strategy/sequential_evaluator_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 681.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('SequentialEvaluator produces signals', () {
    final history = List.generate(30, (i) => CandleEntity(
      instrument: "EUR_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble() + 1,
      low: i.toDouble() - 1,
      close: i.toDouble(),
      volume: 1,
    ));

    final evaluator = buildExampleStrategy();
    final signals = evaluator.evaluateSeries(history);

    expect(signals.length, history.length);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/strategy/sequential_evaluator_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 769: test/features/market/presentation/widgets/backtest_report_widget_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/features/market/presentation/widgets/backtest_report_widget_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 691.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:your_app/features/market/presentation/widgets/backtest/backtest_report_widget.dart';
import 'package:your_app/features/market/domain/backtest/backtest_result.dart';

void main() {
  testWidgets('Backtest report displays numbers', (tester) async {
    final result = BacktestResult(
      timestamps: [DateTime.now()],
      equityCurve: [10000],
      netProfit: 100,
      maxDrawdown: 5,
      winRate: 50,
    );
    await tester.pumpWidget(MaterialApp(
      home: BacktestReportWidget(result: result),
    ));
    expect(find.textContaining("Net Profit"), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/features/market/presentation/widgets/backtest_report_widget_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 770: test/features/market/domain/indicators/ema_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/features/market/domain/indicators/ema_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 453.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/indicators/ema_calculator.dart';
import '../../../mock/candles_mock.dart';

void main() {
  test('EMA calculation basic', () {
    final candles = generateMockCandles(100);
    final result = EmaCalculator.calculate(data: candles, period: 10);
    expect(result.values.length, candles.length);
    expect(result.values.first, candles.first.close);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/features/market/domain/indicators/ema_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 771: test/backtest/backtest_engine_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/backtest/backtest_engine_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 966.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('Backtest basic run', () {
    final history = List.generate(50, (i) => CandleEntity(
      instrument: "EUR_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble()+1,
      low: i.toDouble()-1,
      close: i.toDouble(),
      volume: 1,
    ));

    final engine = BacktestEngine(
      history: history,
      evaluator: buildExampleStrategy(),
      initialBalance: 10000,
      takeProfit: 0.01,
      stopLoss: 0.005,
    );

    final result = engine.run();
    expect(result.equityCurve.length, history.length);
    expect(result.netProfit, isA<double>());
    expect(result.winRate, inInclusiveRange(0.0, 1.0));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/backtest/backtest_engine_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 772: test/bloc/chart_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/chart_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 33
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_state.dart';
import 'package:your_app/market/data/repositories/market_repository.dart';
import 'package:mocktail/mocktail.dart';

class MockMarketRepo extends Mock implements MarketRepository {}

void main() {
  group('ChartBloc', () {
    late ChartBloc bloc;
    late MockMarketRepo repo;

    setUp(() {
      repo = MockMarketRepo();
      bloc = ChartBloc(repo);
    });

    blocTest<ChartBloc, ChartState>(
      'emits ChartLoaded on successful LoadChart',
      build: () {
        when(() => repo.getHistoricalCandles(symbol: any(named: 'symbol'),
            timeframe: any(named: 'timeframe')))
            .thenAnswer((_) async => []);
        return bloc;
      },
      act: (b) => b.add(LoadChart(symbol: 'EU', timeframe: 'M1')),
      expect: () => [isA<ChartLoading>(), isA<ChartLoaded>()],
    );
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/chart_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 773: test/bloc/market_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/market_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1023.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:my_app/features/market/presentation/bloc/market/market_bloc.dart';
import 'package:my_app/features/market/presentation/bloc/market/market_state.dart';
import 'package:my_app/features/market/presentation/bloc/market/market_event.dart';
import 'package:my_app/features/market/data/market_repository.dart';
import 'package:my_app/core/network/rest/rest_client.dart';
import 'package:my_app/features/market/domain/streaming/live_stream_adapter.dart';

class FakeRepo extends MarketRepository {
  @override
  Future<List> getCandlesCached(
      String accountId, String instrument, String timeframe) async {
    return [];
  }
}

void main() {
  blocTest<MarketBloc, MarketState>(
    'MarketBloc load history',
    build: () => MarketBloc(FakeRepo(), LiveStreamAdapter()),
    act: (bloc) => bloc.add(LoadHistory("acc", "SYM", "M1")),
    expect: () => [isA<MarketLoadingHistory>(), isA<MarketHistoryReady>()],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/market_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 774: test/bloc/strategy_builder/strategy_builder_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/strategy_builder/strategy_builder_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 952.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 26
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/strategy/presentation/bloc/strategy_builder_bloc.dart';
import 'package:your_app/features/strategy/presentation/bloc/strategy_builder_event.dart';
import 'package:your_app/features/strategy/presentation/bloc/strategy_builder_state.dart';
import 'package:mocktail/mocktail.dart';
import '../../../../core/models/strategy_graph.dart';
import '../../../mocks.dart';

class MockStrategyStorage extends Mock implements StrategyStorage {}

void main() {
  late MockStrategyStorage mockStorage;

  setUp(() {
    mockStorage = MockStrategyStorage();
  });

  blocTest<StrategyBuilderBloc, StrategyBuilderState>(
    'emits BuilderLoaded on AddBlock',
    build: () => StrategyBuilderBloc(mockStorage),
    act: (bloc) =>
        bloc.add(AddBlock(id: 'b1', type: 'ema', params: {})),
    expect: () => [isA<BuilderLoaded>()],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/strategy_builder/strategy_builder_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 775: test/bloc/trading/trading_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/trading/trading_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 43
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/trading/trading_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/trading/trading_event.dart';
import 'package:your_app/features/market/presentation/bloc/trading/trading_state.dart';
import 'package:your_app/market/data/repositories/trading_repository.dart';
import 'package:mocktail/mocktail.dart';
import '../../../../market/domain/backtest/backtest_models.dart';

class MockTradingRepo extends Mock implements TradingRepository {}

void main() {
  late MockTradingRepo mockRepo;

  setUp(() {
    mockRepo = MockTradingRepo();
  });

  blocTest<TradingBloc, TradingState>(
    'emits OrderSuccess and PositionsLoaded on successful PlaceOrder',
    build: () {
      when(() => mockRepo.placeOrder(
          instrument: any(named: 'instrument'),
          side: any(named: 'side'),
          price: any(named: 'price'),
          size: any(named: 'size')))
          .thenAnswer((_) async => <Position>[]);

      return TradingBloc(mockRepo);
    },
    act: (bloc) => bloc.add(PlaceOrder(
      instrument: "EUR_USD",
      side: OrderSide.buy,
      price: 1.1,
      size: 1.0,
    )),
    expect: () => [
      isA<TradingLoading>(),
      isA<TradingOrderSuccess>(),
      isA<TradingPositionsLoaded>(),
    ],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/trading/trading_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 776: test/bloc/oanda_setup/oanda_setup_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/oanda_setup/oanda_setup_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/oanda/oanda_setup_event.dart';
import 'package:your_app/features/market/presentation/bloc/oanda/oanda_setup_state.dart';
import 'package:mocktail/mocktail.dart';
import '../../../mocks.dart';

class MockSecureStorage extends Mock implements OandaSecureStorage {}
class MockRestClient extends Mock implements RestClient {}

void main() {
  group('OandaSetupBloc', () {
    late MockSecureStorage mockStorage;

    setUp(() {
      mockStorage = MockSecureStorage();
    });

    blocTest<OandaSetupBloc, OandaSetupState>(
      'emits Connected when valid credentials',
      build: () {
        return OandaSetupBloc(storage: mockStorage, baseUrl: 'https://fake');
      },
      act: (bloc) => bloc.add(SubmitOandaCredentials(token: 't', accountId: 'id')),
      expect: () => [isA<OandaLoading>(), isA<OandaConnected>()],
    );
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/oanda_setup/oanda_setup_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 777: test/bloc/replay/replay_edge_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/replay/replay_edge_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 964.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/replay/presentation/bloc/replay_bloc.dart';
import 'package:your_app/features/replay/presentation/bloc/replay_event.dart';
import 'package:your_app/features/replay/presentation/bloc/replay_state.dart';

void main() {
  blocTest<ReplayBloc, ReplayState>(
    'SeekReplay updates index',
    build: () => ReplayBloc(),
    act: (bloc) => bloc.add(SeekReplay(5)),
    expect: () => [isA<ReplayRunning>()],
    verify: (bloc) {
      final state = bloc.state;
      expect((state as ReplayRunning).index, 5);
    },
  );

  blocTest<ReplayBloc, ReplayState>(
    'ChangeReplaySpeed updates speed',
    build: () => ReplayBloc(),
    act: (bloc) => bloc.add(ChangeReplaySpeed(2.0)),
    expect: () => [isA<ReplayRunning>()],
    verify: (bloc) {
      final state = bloc.state;
      expect((state as ReplayRunning).speed, 2.0);
    },
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/replay/replay_edge_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 778: test/bloc/backtest/backtest_cancel_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/backtest/backtest_cancel_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 722.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_event.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_state.dart';

void main() {
  blocTest<BacktestBloc, BacktestState>(
    'emits Cancelled when cancel event is added',
    build: () => BacktestBloc(),
    act: (bloc) {
      bloc.add(RunBacktest(history: [], strategyId: "", takeProfit: 0, stopLoss: 0));
      bloc.add(CancelBacktest());
    },
    expect: () => [isA<BacktestRunning>(), isA<BacktestCancelled>()],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/backtest/backtest_cancel_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 779: test/bloc/backtest/backtest_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/backtest/backtest_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1023.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 31
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_event.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_state.dart';
import '../../../mocks.dart';
import '../../../../core/models/candle_entity.dart';

void main() {
  blocTest<BacktestBloc, BacktestState>(
    'emits [Running, Success] when backtest runs without cancellation',
    build: () => BacktestBloc(),
    act: (bloc) => bloc.add(RunBacktest(
      history: [
        CandleEntity(
            instrument: "EUR_USD",
            timeUtc: DateTime.utc(2025, 1, 1),
            open: 1.0,
            high: 1.1,
            low: 0.9,
            close: 1.05,
            volume: 1)
      ],
      strategyId: "example",
    )),
    expect: () => [
      isA<BacktestRunning>(),
      isA<BacktestSuccess>(),
    ],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/backtest/backtest_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 780: test/bloc/chart/chart_bloc_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/bloc/chart/chart_bloc_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 1.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 42
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_state.dart';
import 'package:your_app/market/data/repositories/market_repository.dart';
import 'package:mocktail/mocktail.dart';
import '../../../mocks.dart';
import '../../../../core/models/candle_entity.dart';

class MockMarketRepo extends Mock implements MarketRepository {}

void main() {
  late MockMarketRepo mockRepo;

  setUp(() {
    mockRepo = MockMarketRepo();
  });

  blocTest<ChartBloc, ChartState>(
    'emits [ChartLoading, ChartLoaded] when candles returned',
    build: () {
      when(() => mockRepo.getHistoricalCandles(symbol: any(named: "symbol"), timeframe: any(named: "timeframe")))
          .thenAnswer((_) async => [
                CandleEntity(
                    instrument: "EUR_USD",
                    timeUtc: DateTime.utc(2025, 1, 1, 0, 0),
                    open: 1.0,
                    high: 2.0,
                    low: 0.9,
                    close: 1.5,
                    volume: 1),
              ]);
      return ChartBloc(mockRepo);
    },
    act: (bloc) => bloc.add(LoadChartData(symbol: "EUR_USD", timeframe: "M1")),
    expect: () => [
      isA<ChartLoading>(),
      isA<ChartLoaded>(),
    ],
  );
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/bloc/chart/chart_bloc_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 781: test/domain/candle_normalizer_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/domain/candle_normalizer_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 605.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/data/candle_normalizer.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('fillGaps should produce continuous candles', () {
    final input = [
      CandleEntity(time: DateTime(2025,1,1,10,0), open:1,high:1,low:1,close:1,volume:1),
      CandleEntity(time: DateTime(2025,1,1,10,2), open:2,high:2,low:2,close:2,volume:1),
    ];
    final output = CandleNormalizer.fillGaps(input, Duration(minutes:1));
    expect(output.length, 3);
    expect(output[1].volume, 0);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/domain/candle_normalizer_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 782: test/domain/backtest/backtest_engine_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/domain/backtest/backtest_engine_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 766.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('Backtest should return correct stats', () {
    final history = List.generate(30, (i) => CandleEntity(
      time: DateTime.now().add(Duration(minutes: i)),
      open: i.toDouble(),
      high: i.toDouble() + 1,
      low: i.toDouble() - 1,
      close: i.isEven ? i.toDouble() + 1 : i.toDouble() - 1,
      volume: 1,
    ));

    final engine = BacktestEngine(history: history, strategy: /* your test strategy */);
    final result = engine.run();

    expect(result.equityCurve.first, 10000);
    expect(result.totalTrades, isNonNegative);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/domain/backtest/backtest_engine_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 783: test/domain/indicators/rsi_calculator_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/domain/indicators/rsi_calculator_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 626.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 20
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/indicators/rsi_calculator.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('RSI simple test', () {
    final data = List.generate(20, (i) => CandleEntity(
      time: DateTime.now().add(Duration(minutes: i)),
      open: i.toDouble(),
      high: i.toDouble(),
      low: i.toDouble(),
      close: i.toDouble() + 1,
      volume: 1,
    ));

    final rsi = RSICalculator.calculate(data, 14).values;
    expect(rsi.length, greaterThan(0));
    expect(rsi.first, isNonNegative);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/domain/indicators/rsi_calculator_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 784: test/domain/indicators/ema_calculator_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/domain/indicators/ema_calculator_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 671.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/indicators/ema_calculator.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('EMA returns correct length and values', () {
    final data = List.generate(10, (i) => CandleEntity(
      time: DateTime.now().add(Duration(minutes: i)),
      open: i.toDouble(),
      high: i.toDouble() + 1,
      low: i.toDouble() - 1,
      close: i.toDouble(),
      volume: 1,
    ));

    final ema = EMACalculator.calculate(data, 5).values;

    expect(ema.length, 10);
    expect(ema.skip(4).first,
      greaterThan(ema.skip(3).first));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/domain/indicators/ema_calculator_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 785: test/indicators/ema_rsi_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/indicators/ema_rsi_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 972.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 30
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/indicators/ema_indicator.dart';
import 'package:your_app/features/strategy/domain/indicators/rsi_indicator.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  final candles = List.generate(20, (i) => CandleEntity(
    instrument: "XAU_USD",
    timeUtc: DateTime.utc(2025,1,1,0,i),
    open: i.toDouble(),
    high: i.toDouble(),
    low: i.toDouble(),
    close: i.toDouble(),
    volume: 1,
  ));

  test('EMA calculates correctly', () {
    final ema = EMAIndicator(10);
    for (final c in candles) ema.addCandle(c);
    expect(ema.series.length, candles.length);
    expect(ema.current, greaterThan(0));
  });

  test('RSI calculates correctly', () {
    final rsi = RSIIndicator(14);
    for (final c in candles) rsi.addCandle(c);
    expect(rsi.series.length, greaterThan(1));
    expect(rsi.current, inInclusiveRange(0, 100));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/indicators/ema_rsi_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 786: test/performance/indicator_perf_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/performance/indicator_perf_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 624.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:test/test.dart';
import '../../../lib/features/indicators/engine/indicator_engine.dart';
import '../../../lib/features/indicators/plugins/ema_plugin.dart';

void main() {
  test('EMA performance on 50k candles', () {
    final candles = List.generate(
      50000,
      (i) => CandleEntity(...), // mock data
    );

    final engine = IndicatorEngine([EMAPlugin(50)]);

    final sw = Stopwatch()..start();
    final result = engine.calculate(candles);
    sw.stop();

    print("Execution time: ${sw.elapsedMilliseconds} ms");

    expect(sw.elapsedMilliseconds < 300, true); // Ø£Ù‚Ù„ Ù…Ù† 300ms
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/performance/indicator_perf_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 787: test/models/candle_entity_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/models/candle_entity_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 592.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('CandleEntity UTC conversion & fields', () {
    final json = {
      "time": "2025-01-01T10:00:00Z",
      "open": "100",
      "high": "110",
      "low": "90",
      "close": "105",
      "volume": "1000"
    };

    final candle = CandleEntity.fromJson("EUR_USD", json);

    expect(candle.instrument, "EUR_USD");
    expect(candle.timeUtc.isUtc, true);
    expect(candle.open, 100.0);
    expect(candle.high, 110.0);
    expect(candle.close, 105.0);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/models/candle_entity_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 788: test/stress/backtest_stress_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/stress/backtest_stress_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 843.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 25
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('Backtest handles 10000 candles in <1 second', () {
    final history = List.generate(10000, (i) => CandleEntity(
      instrument: "XAU_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble()+1,
      low: i.toDouble(),
      close: i.toDouble(),
      volume: 1,
    ));

    final engine = BacktestEngine(history: history, evaluator: buildExampleStrategy());
    final stopwatch = Stopwatch()..start();
    engine.run();
    stopwatch.stop();

    expect(stopwatch.elapsed.inSeconds < 1, true);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/stress/backtest_stress_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 789: test/widget/home_page_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widget/home_page_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 593.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:my_app/features/home/presentation/pages/home_page.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:my_app/features/market/presentation/bloc/oanda/oanda_bloc.dart';

void main() {
  testWidgets("Home Page loads and shows buttons",
      (WidgetTester tester) async {
    await tester.pumpWidget(
      MaterialApp(home: HomePage()),
    );

    expect(find.text("Fetch OANDA Instruments"), findsOneWidget);
    expect(find.text("Settings"), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widget/home_page_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 790: test/widget/chart_page_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widget/chart_page_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 526.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/presentation/pages/interactive_chart_page.dart';

void main() {
  testWidgets('Chart Page loads and displays chart', (tester) async {
    await tester.pumpWidget(MaterialApp(home: InteractiveChartPage(symbol: 'XAU_USD')));

    expect(find.byType(CircularProgressIndicator), findsOneWidget);

    await tester.pumpAndSettle();

    expect(find.text('Chart â€” XAU_USD'), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widget/chart_page_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 791: test/widget/chart_widget_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widget/chart_widget_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 523.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/features/chart/presentation/widgets/chart_webview.dart';

void main() {
  testWidgets("ChartWebView widget builds", (tester) async {
    final mockData = [
      {"time": 1, "open": 1, "high": 1, "low": 1, "close": 1}
    ];
    await tester.pumpWidget(ChartWebView(
      candles: mockData,
      emaShort: [],
      emaLong: [],
      rsi: [],
    ));
    await tester.pumpAndSettle();
    expect(find.byType(ChartWebView), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widget/chart_widget_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 792: test/integration/backtest_analytics_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/integration/backtest_analytics_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 876.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/analytics/analytics_calculator.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';

void main() {
  test('Backtest integration yields expected analytics', () {
    final history = [
      // ØµÙŠØºØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
      CandleEntity(open: 100, high: 105, low: 95, close: 102, volume: 1000),
      CandleEntity(open: 102, high: 108, low: 99, close: 105, volume: 1200),
      CandleEntity(open: 105, high: 110, low: 102, close: 108, volume: 1100),
    ];

    final backtestEngine = BacktestEngine(history);
    final results = backtestEngine.run();

    final analytics = AnalyticsCalculator.calculate(results.tradeProfits);

    expect(analytics.totalTrades, greaterThan(0));
    expect(analytics.winRate, isA<double>());
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/integration/backtest_analytics_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 793: test/integration/navigation_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/integration/navigation_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 513.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/main.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets("Home -> Settings navigation", (tester) async {
    await tester.pumpWidget(MyApp());
    expect(find.text("Dashboard"), findsOneWidget);
    await tester.tap(find.text("Settings"));
    await tester.pumpAndSettle();
    expect(find.text("OANDA Settings"), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/integration/navigation_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 794: test/integration/ws/ws_reconnect_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/integration/ws/ws_reconnect_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 408.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/network/ws_manager.dart';

void main() {
  test('WSManager reconnect logic', () async {
    final ws = WSManager('wss://echo.websocket.events');
    ws.connect();
    await Future.delayed(Duration(seconds: 2));
    ws.send('test');

    final data = await ws.stream.first;
    expect(data, isNotNull);

    ws.dispose();
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/integration/ws/ws_reconnect_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 795: test/pinning/pin_fail_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/pinning/pin_fail_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 418.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'dart:io';
import 'package:my_app/core/network/security/pinning/pin_store.dart';

void main() {
  test("Cert pin lists not empty", () {
    expect(PinStore.sandboxRestPins.isNotEmpty, true);
    expect(PinStore.sandboxStreamPins.isNotEmpty, true);
    expect(PinStore.liveRestPins.isNotEmpty, true);
    expect(PinStore.liveStreamPins.isNotEmpty, true);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/pinning/pin_fail_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 796: test/widgets/strategy_builder_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widgets/strategy_builder_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 459.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy_builder/presentation/pages/strategy_builder_page.dart';
import 'package:flutter/material.dart';

void main() {
  testWidgets('Strategy builder shows nodes list', (tester) async {
    await tester.pumpWidget(MaterialApp(home: StrategyBuilderPage()));
    expect(find.text('Price Above'), findsOneWidget);
    expect(find.text('EMA Cross Up'), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widgets/strategy_builder_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 797: test/widgets/offline/offline_banner_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widgets/offline/offline_banner_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 342.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 11
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:your_app/main.dart';

void main() {
  testWidgets('Offline banner appears', (tester) async {
    await tester.pumpWidget(MyApp());
    // Simulate offline event
    // This part may require dependency injection of NetworkService
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widgets/offline/offline_banner_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 798: test/widgets/chart/interactive_chart_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/test/widgets/chart/interactive_chart_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 595.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:your_app/features/chart/presentation/widgets/interactive_chart.dart';

void main() {
  testWidgets('Pinch Zoom changes scale', (tester) async {
    await tester.pumpWidget(MaterialApp(
      home: InteractiveChart(candles: [], onRangeChanged: (_,__){}),
    ));

    final finder = find.byType(InteractiveChart);
    await tester.pinch(finder, 1.5);
    await tester.pump();

    // ØªØ£ÙƒØ¯ Ø£Ù† scale ØªØºÙŠØ±Øª
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ Ø¯Ø§Ø®Ù„ÙŠ Ù…Ù† Ø­Ø§Ù„Ø© widget
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: test/widgets/chart/interactive_chart_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 799: integration_test/chart_integration_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/integration_test/chart_integration_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 813.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

import 'package:integration_test/integration_test.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/market/data/repositories/market_repository.dart';
import 'package:your_app/core/network/rest_client.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets('ChartBloc integration test', (tester) async {
    final repo = MarketRepository(RestClient("fakeToken","https://fake.url"));
    final bloc = ChartBloc(repo);

    bloc.add(LoadChartData(symbol: "EUR_USD", timeframe: "M1"));
    await tester.pumpAndSettle();
    expect(bloc.state, isNot(isA<ChartError>()));
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: integration_test/chart_integration_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 800: integration_test/app_flow_test.dart
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/integration_test/app_flow_test.dart
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Dart
Ø§Ù„Ø­Ø¬Ù…: 557.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:my_app/main.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets("App Launch and Navigate", (WidgetTester tester) async {
    await tester.pumpWidget(MyApp());
    await tester.pumpAndSettle();
    expect(find.text("Dashboard"), findsOneWidget);

    await tester.tap(find.text("Settings"));
    await tester.pumpAndSettle();
    expect(find.text("OANDA Settings"), findsOneWidget);
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: integration_test/app_flow_test.dart
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 801: android/app/src/staging/res/values/strings.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/staging/res/values/strings.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 81.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 3
================================================================================

<resources>
    <string name="app_name">TradingApp Staging</string>
</resources>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/staging/res/values/strings.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 802: android/app/src/dev/res/values/strings.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/dev/res/values/strings.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 77.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 3
================================================================================

<resources>
    <string name="app_name">TradingApp Dev</string>
</resources>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/dev/res/values/strings.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 803: android/app/src/main/AndroidManifest.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/AndroidManifest.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 45
================================================================================

<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:label="flutter_trading_app"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <!-- Specifies an Android theme to apply to this Activity as soon as
                 the Android process has started. This theme is visible to the user
                 while the Flutter UI initializes. After that, this theme continues
                 to determine the Window background behind the Flutter UI. -->
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <!-- Don't delete the meta-data below.
             This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    <!-- Required to query activities that can process text, see:
         https://developer.android.com/training/package-visibility and
         https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

         In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
    </queries>
</manifest>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/AndroidManifest.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 804: android/app/src/main/java/io/flutter/plugins/GeneratedPluginRegistrant.java
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/java/io/flutter/plugins/GeneratedPluginRegistrant.java
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Java
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 34
================================================================================

package io.flutter.plugins;

import androidx.annotation.Keep;
import androidx.annotation.NonNull;
import io.flutter.Log;

import io.flutter.embedding.engine.FlutterEngine;

/**
 * Generated file. Do not edit.
 * This file is generated by the Flutter tool based on the
 * plugins that support the Android platform.
 */
@Keep
public final class GeneratedPluginRegistrant {
  private static final String TAG = "GeneratedPluginRegistrant";
  public static void registerWith(@NonNull FlutterEngine flutterEngine) {
    try {
      flutterEngine.getPlugins().add(new com.it_nomads.fluttersecurestorage.FlutterSecureStoragePlugin());
    } catch (Exception e) {
      Log.e(TAG, "Error registering plugin flutter_secure_storage, com.it_nomads.fluttersecurestorage.FlutterSecureStoragePlugin", e);
    }
    try {
      flutterEngine.getPlugins().add(new io.flutter.plugins.pathprovider.PathProviderPlugin());
    } catch (Exception e) {
      Log.e(TAG, "Error registering plugin path_provider_android, io.flutter.plugins.pathprovider.PathProviderPlugin", e);
    }
    try {
      flutterEngine.getPlugins().add(new io.flutter.plugins.webviewflutter.WebViewFlutterPlugin());
    } catch (Exception e) {
      Log.e(TAG, "Error registering plugin webview_flutter_android, io.flutter.plugins.webviewflutter.WebViewFlutterPlugin", e);
    }
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/java/io/flutter/plugins/GeneratedPluginRegistrant.java
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 805: android/app/src/main/kotlin/com/example/flutter_trading_app/MainActivity.kt
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/kotlin/com/example/flutter_trading_app/MainActivity.kt
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Kotlin
Ø§Ù„Ø­Ø¬Ù…: 133.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

package com.example.flutter_trading_app

import io.flutter.embedding.android.FlutterActivity

class MainActivity : FlutterActivity()

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/kotlin/com/example/flutter_trading_app/MainActivity.kt
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 806: android/app/src/main/res/drawable-v21/launch_background.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/res/drawable-v21/launch_background.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 438.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

<?xml version="1.0" encoding="utf-8"?>
<!-- Modify this file to customize your launch splash screen -->
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="?android:colorBackground" />

    <!-- You can insert your own image assets here -->
    <!-- <item>
        <bitmap
            android:gravity="center"
            android:src="@mipmap/launch_image" />
    </item> -->
</layer-list>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/res/drawable-v21/launch_background.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 807: android/app/src/main/res/drawable/launch_background.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/res/drawable/launch_background.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 434.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

<?xml version="1.0" encoding="utf-8"?>
<!-- Modify this file to customize your launch splash screen -->
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@android:color/white" />

    <!-- You can insert your own image assets here -->
    <!-- <item>
        <bitmap
            android:gravity="center"
            android:src="@mipmap/launch_image" />
    </item> -->
</layer-list>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/res/drawable/launch_background.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 808: android/app/src/main/res/values-night/styles.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/res/values-night/styles.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 995.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- Theme applied to the Android Window while the process is starting when the OS's Dark Mode setting is on -->
    <style name="LaunchTheme" parent="@android:style/Theme.Black.NoTitleBar">
        <!-- Show a splash screen on the activity. Automatically removed when
             the Flutter engine draws its first frame -->
        <item name="android:windowBackground">@drawable/launch_background</item>
    </style>
    <!-- Theme applied to the Android Window as soon as the process has started.
         This theme determines the color of the Android Window while your
         Flutter UI initializes, as well as behind your Flutter UI while its
         running.

         This Theme is only used starting with V2 of Flutter's Android embedding. -->
    <style name="NormalTheme" parent="@android:style/Theme.Black.NoTitleBar">
        <item name="android:windowBackground">?android:colorBackground</item>
    </style>
</resources>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/res/values-night/styles.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 809: android/app/src/main/res/values/styles.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/main/res/values/styles.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 996.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 18
================================================================================

<?xml version="1.0" encoding="utf-8"?>
<resources>
    <!-- Theme applied to the Android Window while the process is starting when the OS's Dark Mode setting is off -->
    <style name="LaunchTheme" parent="@android:style/Theme.Light.NoTitleBar">
        <!-- Show a splash screen on the activity. Automatically removed when
             the Flutter engine draws its first frame -->
        <item name="android:windowBackground">@drawable/launch_background</item>
    </style>
    <!-- Theme applied to the Android Window as soon as the process has started.
         This theme determines the color of the Android Window while your
         Flutter UI initializes, as well as behind your Flutter UI while its
         running.

         This Theme is only used starting with V2 of Flutter's Android embedding. -->
    <style name="NormalTheme" parent="@android:style/Theme.Light.NoTitleBar">
        <item name="android:windowBackground">?android:colorBackground</item>
    </style>
</resources>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/main/res/values/styles.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 810: android/app/src/debug/AndroidManifest.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/debug/AndroidManifest.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 378.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- The INTERNET permission is required for development. Specifically,
         the Flutter tool needs it to communicate with the running application
         to allow setting breakpoints, to provide hot reload, etc.
    -->
    <uses-permission android:name="android.permission.INTERNET"/>
</manifest>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/debug/AndroidManifest.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 811: android/app/src/profile/AndroidManifest.xml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/app/src/profile/AndroidManifest.xml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: XML
Ø§Ù„Ø­Ø¬Ù…: 378.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 7
================================================================================

<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- The INTERNET permission is required for development. Specifically,
         the Flutter tool needs it to communicate with the running application
         to allow setting breakpoints, to provide hot reload, etc.
    -->
    <uses-permission android:name="android.permission.INTERNET"/>
</manifest>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/app/src/profile/AndroidManifest.xml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 812: ios/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>IDEDidComputeMac32BitWarning</key>
	<true/>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 813: ios/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>IDEDidComputeMac32BitWarning</key>
	<true/>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 814: ios/Runner/AppDelegate.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/AppDelegate.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 539.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

import Flutter
import UIKit

@main
@objc class AppDelegate: FlutterAppDelegate, FlutterImplicitEngineDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }

  func didInitializeImplicitFlutterEngine(_ engineBridge: FlutterImplicitEngineBridge) {
    GeneratedPluginRegistrant.register(with: engineBridge.pluginRegistry)
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/AppDelegate.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 815: ios/Runner/Info.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/Info.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 2.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 70
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>CADisableMinimumFrameDurationOnPhone</key>
	<true/>
	<key>CFBundleDevelopmentRegion</key>
	<string>$(DEVELOPMENT_LANGUAGE)</string>
	<key>CFBundleDisplayName</key>
	<string>Flutter Trading App</string>
	<key>CFBundleExecutable</key>
	<string>$(EXECUTABLE_NAME)</string>
	<key>CFBundleIdentifier</key>
	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
	<key>CFBundleInfoDictionaryVersion</key>
	<string>6.0</string>
	<key>CFBundleName</key>
	<string>flutter_trading_app</string>
	<key>CFBundlePackageType</key>
	<string>APPL</string>
	<key>CFBundleShortVersionString</key>
	<string>$(FLUTTER_BUILD_NAME)</string>
	<key>CFBundleSignature</key>
	<string>????</string>
	<key>CFBundleVersion</key>
	<string>$(FLUTTER_BUILD_NUMBER)</string>
	<key>LSRequiresIPhoneOS</key>
	<true/>
	<key>UIApplicationSceneManifest</key>
	<dict>
		<key>UIApplicationSupportsMultipleScenes</key>
		<false/>
		<key>UISceneConfigurations</key>
		<dict>
			<key>UIWindowSceneSessionRoleApplication</key>
			<array>
				<dict>
					<key>UISceneClassName</key>
					<string>UIWindowScene</string>
					<key>UISceneConfigurationName</key>
					<string>flutter</string>
					<key>UISceneDelegateClassName</key>
					<string>$(PRODUCT_MODULE_NAME).SceneDelegate</string>
					<key>UISceneStoryboardFile</key>
					<string>Main</string>
				</dict>
			</array>
		</dict>
	</dict>
	<key>UIApplicationSupportsIndirectInputEvents</key>
	<true/>
	<key>UILaunchStoryboardName</key>
	<string>LaunchScreen</string>
	<key>UIMainStoryboardFile</key>
	<string>Main</string>
	<key>UISupportedInterfaceOrientations</key>
	<array>
		<string>UIInterfaceOrientationPortrait</string>
		<string>UIInterfaceOrientationLandscapeLeft</string>
		<string>UIInterfaceOrientationLandscapeRight</string>
	</array>
	<key>UISupportedInterfaceOrientations~ipad</key>
	<array>
		<string>UIInterfaceOrientationPortrait</string>
		<string>UIInterfaceOrientationPortraitUpsideDown</string>
		<string>UIInterfaceOrientationLandscapeLeft</string>
		<string>UIInterfaceOrientationLandscapeRight</string>
	</array>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/Info.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 816: ios/Runner/Runner-Bridging-Header.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/Runner-Bridging-Header.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 38.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

#import "GeneratedPluginRegistrant.h"

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/Runner-Bridging-Header.h
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 817: ios/Runner/SceneDelegate.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/SceneDelegate.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 76.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 6
================================================================================

import Flutter
import UIKit

class SceneDelegate: FlutterSceneDelegate {

}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/SceneDelegate.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 818: ios/Runner/GeneratedPluginRegistrant.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/GeneratedPluginRegistrant.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 378.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

//
//  Generated file. Do not edit.
//

// clang-format off

#ifndef GeneratedPluginRegistrant_h
#define GeneratedPluginRegistrant_h

#import <Flutter/Flutter.h>

NS_ASSUME_NONNULL_BEGIN

@interface GeneratedPluginRegistrant : NSObject
+ (void)registerWithRegistry:(NSObject<FlutterPluginRegistry>*)registry;
@end

NS_ASSUME_NONNULL_END
#endif /* GeneratedPluginRegistrant_h */

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/GeneratedPluginRegistrant.h
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 819: ios/Runner/GeneratedPluginRegistrant.m
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/GeneratedPluginRegistrant.m
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Objective-C
Ø§Ù„Ø­Ø¬Ù…: 845.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

//
//  Generated file. Do not edit.
//

// clang-format off

#import "GeneratedPluginRegistrant.h"

#if __has_include(<flutter_secure_storage_darwin/FlutterSecureStorageDarwinPlugin.h>)
#import <flutter_secure_storage_darwin/FlutterSecureStorageDarwinPlugin.h>
#else
@import flutter_secure_storage_darwin;
#endif

#if __has_include(<webview_flutter_wkwebview/WebViewFlutterPlugin.h>)
#import <webview_flutter_wkwebview/WebViewFlutterPlugin.h>
#else
@import webview_flutter_wkwebview;
#endif

@implementation GeneratedPluginRegistrant

+ (void)registerWithRegistry:(NSObject<FlutterPluginRegistry>*)registry {
  [FlutterSecureStorageDarwinPlugin registerWithRegistrar:[registry registrarForPlugin:@"FlutterSecureStorageDarwinPlugin"]];
  [WebViewFlutterPlugin registerWithRegistrar:[registry registrarForPlugin:@"WebViewFlutterPlugin"]];
}

@end

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/GeneratedPluginRegistrant.m
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 820: ios/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JSON
Ø§Ù„Ø­Ø¬Ù…: 2.5 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 122
================================================================================

{
  "images" : [
    {
      "size" : "20x20",
      "idiom" : "iphone",
      "filename" : "Icon-App-20x20@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "20x20",
      "idiom" : "iphone",
      "filename" : "Icon-App-20x20@3x.png",
      "scale" : "3x"
    },
    {
      "size" : "29x29",
      "idiom" : "iphone",
      "filename" : "Icon-App-29x29@1x.png",
      "scale" : "1x"
    },
    {
      "size" : "29x29",
      "idiom" : "iphone",
      "filename" : "Icon-App-29x29@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "29x29",
      "idiom" : "iphone",
      "filename" : "Icon-App-29x29@3x.png",
      "scale" : "3x"
    },
    {
      "size" : "40x40",
      "idiom" : "iphone",
      "filename" : "Icon-App-40x40@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "40x40",
      "idiom" : "iphone",
      "filename" : "Icon-App-40x40@3x.png",
      "scale" : "3x"
    },
    {
      "size" : "60x60",
      "idiom" : "iphone",
      "filename" : "Icon-App-60x60@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "60x60",
      "idiom" : "iphone",
      "filename" : "Icon-App-60x60@3x.png",
      "scale" : "3x"
    },
    {
      "size" : "20x20",
      "idiom" : "ipad",
      "filename" : "Icon-App-20x20@1x.png",
      "scale" : "1x"
    },
    {
      "size" : "20x20",
      "idiom" : "ipad",
      "filename" : "Icon-App-20x20@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "29x29",
      "idiom" : "ipad",
      "filename" : "Icon-App-29x29@1x.png",
      "scale" : "1x"
    },
    {
      "size" : "29x29",
      "idiom" : "ipad",
      "filename" : "Icon-App-29x29@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "40x40",
      "idiom" : "ipad",
      "filename" : "Icon-App-40x40@1x.png",
      "scale" : "1x"
    },
    {
      "size" : "40x40",
      "idiom" : "ipad",
      "filename" : "Icon-App-40x40@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "76x76",
      "idiom" : "ipad",
      "filename" : "Icon-App-76x76@1x.png",
      "scale" : "1x"
    },
    {
      "size" : "76x76",
      "idiom" : "ipad",
      "filename" : "Icon-App-76x76@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "83.5x83.5",
      "idiom" : "ipad",
      "filename" : "Icon-App-83.5x83.5@2x.png",
      "scale" : "2x"
    },
    {
      "size" : "1024x1024",
      "idiom" : "ios-marketing",
      "filename" : "Icon-App-1024x1024@1x.png",
      "scale" : "1x"
    }
  ],
  "info" : {
    "version" : 1,
    "author" : "xcode"
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 821: ios/Runner/Assets.xcassets/LaunchImage.imageset/Contents.json
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/Assets.xcassets/LaunchImage.imageset/Contents.json
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JSON
Ø§Ù„Ø­Ø¬Ù…: 391.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 23
================================================================================

{
  "images" : [
    {
      "idiom" : "universal",
      "filename" : "LaunchImage.png",
      "scale" : "1x"
    },
    {
      "idiom" : "universal",
      "filename" : "LaunchImage@2x.png",
      "scale" : "2x"
    },
    {
      "idiom" : "universal",
      "filename" : "LaunchImage@3x.png",
      "scale" : "3x"
    }
  ],
  "info" : {
    "version" : 1,
    "author" : "xcode"
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/Assets.xcassets/LaunchImage.imageset/Contents.json
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 822: ios/Runner/Assets.xcassets/LaunchImage.imageset/README.md
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Runner/Assets.xcassets/LaunchImage.imageset/README.md
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Markdown
Ø§Ù„Ø­Ø¬Ù…: 336.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

# Launch Screen Assets

You can customize the launch screen with your own desired assets by replacing the image files in this directory.

You can also do it by opening your Flutter project's Xcode project with `open ios/Runner.xcworkspace`, selecting `Runner/Assets.xcassets` in the Project Navigator and dropping in the desired images.

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Runner/Assets.xcassets/LaunchImage.imageset/README.md
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 823: ios/RunnerTests/RunnerTests.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/RunnerTests/RunnerTests.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 285.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import Flutter
import UIKit
import XCTest

class RunnerTests: XCTestCase {

  func testExample() {
    // If you add code to the Runner application, consider adding tests here.
    // See https://developer.apple.com/documentation/xctest for more information about using XCTest.
  }

}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/RunnerTests/RunnerTests.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 824: macos/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>IDEDidComputeMac32BitWarning</key>
	<true/>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Runner.xcodeproj/project.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 825: macos/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 238.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>IDEDidComputeMac32BitWarning</key>
	<true/>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 826: macos/Runner/AppDelegate.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Runner/AppDelegate.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 311.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

import Cocoa
import FlutterMacOS

@main
class AppDelegate: FlutterAppDelegate {
  override func applicationShouldTerminateAfterLastWindowClosed(_ sender: NSApplication) -> Bool {
    return true
  }

  override func applicationSupportsSecureRestorableState(_ app: NSApplication) -> Bool {
    return true
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Runner/AppDelegate.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 827: macos/Runner/Info.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Runner/Info.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 1.0 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>CFBundleDevelopmentRegion</key>
	<string>$(DEVELOPMENT_LANGUAGE)</string>
	<key>CFBundleExecutable</key>
	<string>$(EXECUTABLE_NAME)</string>
	<key>CFBundleIconFile</key>
	<string></string>
	<key>CFBundleIdentifier</key>
	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
	<key>CFBundleInfoDictionaryVersion</key>
	<string>6.0</string>
	<key>CFBundleName</key>
	<string>$(PRODUCT_NAME)</string>
	<key>CFBundlePackageType</key>
	<string>APPL</string>
	<key>CFBundleShortVersionString</key>
	<string>$(FLUTTER_BUILD_NAME)</string>
	<key>CFBundleVersion</key>
	<string>$(FLUTTER_BUILD_NUMBER)</string>
	<key>LSMinimumSystemVersion</key>
	<string>$(MACOSX_DEPLOYMENT_TARGET)</string>
	<key>NSHumanReadableCopyright</key>
	<string>$(PRODUCT_COPYRIGHT)</string>
	<key>NSMainNibFile</key>
	<string>MainMenu</string>
	<key>NSPrincipalClass</key>
	<string>NSApplication</string>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Runner/Info.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 828: macos/Runner/MainFlutterWindow.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Runner/MainFlutterWindow.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 388.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

import Cocoa
import FlutterMacOS

class MainFlutterWindow: NSWindow {
  override func awakeFromNib() {
    let flutterViewController = FlutterViewController()
    let windowFrame = self.frame
    self.contentViewController = flutterViewController
    self.setFrame(windowFrame, display: true)

    RegisterGeneratedPlugins(registry: flutterViewController)

    super.awakeFromNib()
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Runner/MainFlutterWindow.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 829: macos/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JSON
Ø§Ù„Ø­Ø¬Ù…: 1.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 68
================================================================================

{
  "images" : [
    {
      "size" : "16x16",
      "idiom" : "mac",
      "filename" : "app_icon_16.png",
      "scale" : "1x"
    },
    {
      "size" : "16x16",
      "idiom" : "mac",
      "filename" : "app_icon_32.png",
      "scale" : "2x"
    },
    {
      "size" : "32x32",
      "idiom" : "mac",
      "filename" : "app_icon_32.png",
      "scale" : "1x"
    },
    {
      "size" : "32x32",
      "idiom" : "mac",
      "filename" : "app_icon_64.png",
      "scale" : "2x"
    },
    {
      "size" : "128x128",
      "idiom" : "mac",
      "filename" : "app_icon_128.png",
      "scale" : "1x"
    },
    {
      "size" : "128x128",
      "idiom" : "mac",
      "filename" : "app_icon_256.png",
      "scale" : "2x"
    },
    {
      "size" : "256x256",
      "idiom" : "mac",
      "filename" : "app_icon_256.png",
      "scale" : "1x"
    },
    {
      "size" : "256x256",
      "idiom" : "mac",
      "filename" : "app_icon_512.png",
      "scale" : "2x"
    },
    {
      "size" : "512x512",
      "idiom" : "mac",
      "filename" : "app_icon_512.png",
      "scale" : "1x"
    },
    {
      "size" : "512x512",
      "idiom" : "mac",
      "filename" : "app_icon_1024.png",
      "scale" : "2x"
    }
  ],
  "info" : {
    "version" : 1,
    "author" : "xcode"
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Runner/Assets.xcassets/AppIcon.appiconset/Contents.json
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 830: macos/RunnerTests/RunnerTests.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/RunnerTests/RunnerTests.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 290.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

import Cocoa
import FlutterMacOS
import XCTest

class RunnerTests: XCTestCase {

  func testExample() {
    // If you add code to the Runner application, consider adding tests here.
    // See https://developer.apple.com/documentation/xctest for more information about using XCTest.
  }

}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/RunnerTests/RunnerTests.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 831: windows/runner/CMakeLists.txt
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/CMakeLists.txt
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Text
Ø§Ù„Ø­Ø¬Ù…: 1.8 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 40
================================================================================

cmake_minimum_required(VERSION 3.14)
project(runner LANGUAGES CXX)

# Define the application target. To change its name, change BINARY_NAME in the
# top-level CMakeLists.txt, not the value here, or `flutter run` will no longer
# work.
#
# Any new source files that you add to the application should be added here.
add_executable(${BINARY_NAME} WIN32
  "flutter_window.cpp"
  "main.cpp"
  "utils.cpp"
  "win32_window.cpp"
  "${FLUTTER_MANAGED_DIR}/generated_plugin_registrant.cc"
  "Runner.rc"
  "runner.exe.manifest"
)

# Apply the standard set of build settings. This can be removed for applications
# that need different build settings.
apply_standard_settings(${BINARY_NAME})

# Add preprocessor definitions for the build version.
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION=\"${FLUTTER_VERSION}\"")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MAJOR=${FLUTTER_VERSION_MAJOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_MINOR=${FLUTTER_VERSION_MINOR}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_PATCH=${FLUTTER_VERSION_PATCH}")
target_compile_definitions(${BINARY_NAME} PRIVATE "FLUTTER_VERSION_BUILD=${FLUTTER_VERSION_BUILD}")

# Disable Windows macros that collide with C++ standard library functions.
target_compile_definitions(${BINARY_NAME} PRIVATE "NOMINMAX")

# Add dependency libraries and include directories. Add any application-specific
# dependencies here.
target_link_libraries(${BINARY_NAME} PRIVATE flutter flutter_wrapper_app)
target_link_libraries(${BINARY_NAME} PRIVATE "dwmapi.lib")
target_include_directories(${BINARY_NAME} PRIVATE "${CMAKE_SOURCE_DIR}")

# Run the Flutter tool portions of the build. This must not be removed.
add_dependencies(${BINARY_NAME} flutter_assemble)

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/CMakeLists.txt
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 832: windows/runner/flutter_window.cpp
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/flutter_window.cpp
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: C++
Ø§Ù„Ø­Ø¬Ù…: 2.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 71
================================================================================

#include "flutter_window.h"

#include <optional>

#include "flutter/generated_plugin_registrant.h"

FlutterWindow::FlutterWindow(const flutter::DartProject& project)
    : project_(project) {}

FlutterWindow::~FlutterWindow() {}

bool FlutterWindow::OnCreate() {
  if (!Win32Window::OnCreate()) {
    return false;
  }

  RECT frame = GetClientArea();

  // The size here must match the window dimensions to avoid unnecessary surface
  // creation / destruction in the startup path.
  flutter_controller_ = std::make_unique<flutter::FlutterViewController>(
      frame.right - frame.left, frame.bottom - frame.top, project_);
  // Ensure that basic setup of the controller was successful.
  if (!flutter_controller_->engine() || !flutter_controller_->view()) {
    return false;
  }
  RegisterPlugins(flutter_controller_->engine());
  SetChildContent(flutter_controller_->view()->GetNativeWindow());

  flutter_controller_->engine()->SetNextFrameCallback([&]() {
    this->Show();
  });

  // Flutter can complete the first frame before the "show window" callback is
  // registered. The following call ensures a frame is pending to ensure the
  // window is shown. It is a no-op if the first frame hasn't completed yet.
  flutter_controller_->ForceRedraw();

  return true;
}

void FlutterWindow::OnDestroy() {
  if (flutter_controller_) {
    flutter_controller_ = nullptr;
  }

  Win32Window::OnDestroy();
}

LRESULT
FlutterWindow::MessageHandler(HWND hwnd, UINT const message,
                              WPARAM const wparam,
                              LPARAM const lparam) noexcept {
  // Give Flutter, including plugins, an opportunity to handle window messages.
  if (flutter_controller_) {
    std::optional<LRESULT> result =
        flutter_controller_->HandleTopLevelWindowProc(hwnd, message, wparam,
                                                      lparam);
    if (result) {
      return *result;
    }
  }

  switch (message) {
    case WM_FONTCHANGE:
      flutter_controller_->engine()->ReloadSystemFonts();
      break;
  }

  return Win32Window::MessageHandler(hwnd, message, wparam, lparam);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/flutter_window.cpp
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 833: windows/runner/flutter_window.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/flutter_window.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 928.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 33
================================================================================

#ifndef RUNNER_FLUTTER_WINDOW_H_
#define RUNNER_FLUTTER_WINDOW_H_

#include <flutter/dart_project.h>
#include <flutter/flutter_view_controller.h>

#include <memory>

#include "win32_window.h"

// A window that does nothing but host a Flutter view.
class FlutterWindow : public Win32Window {
 public:
  // Creates a new FlutterWindow hosting a Flutter view running |project|.
  explicit FlutterWindow(const flutter::DartProject& project);
  virtual ~FlutterWindow();

 protected:
  // Win32Window:
  bool OnCreate() override;
  void OnDestroy() override;
  LRESULT MessageHandler(HWND window, UINT const message, WPARAM const wparam,
                         LPARAM const lparam) noexcept override;

 private:
  // The project to run.
  flutter::DartProject project_;

  // The Flutter instance hosted by this window.
  std::unique_ptr<flutter::FlutterViewController> flutter_controller_;
};

#endif  // RUNNER_FLUTTER_WINDOW_H_

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/flutter_window.h
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 834: windows/runner/main.cpp
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/main.cpp
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: C++
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 43
================================================================================

#include <flutter/dart_project.h>
#include <flutter/flutter_view_controller.h>
#include <windows.h>

#include "flutter_window.h"
#include "utils.h"

int APIENTRY wWinMain(_In_ HINSTANCE instance, _In_opt_ HINSTANCE prev,
                      _In_ wchar_t *command_line, _In_ int show_command) {
  // Attach to console when present (e.g., 'flutter run') or create a
  // new console when running with a debugger.
  if (!::AttachConsole(ATTACH_PARENT_PROCESS) && ::IsDebuggerPresent()) {
    CreateAndAttachConsole();
  }

  // Initialize COM, so that it is available for use in the library and/or
  // plugins.
  ::CoInitializeEx(nullptr, COINIT_APARTMENTTHREADED);

  flutter::DartProject project(L"data");

  std::vector<std::string> command_line_arguments =
      GetCommandLineArguments();

  project.set_dart_entrypoint_arguments(std::move(command_line_arguments));

  FlutterWindow window(project);
  Win32Window::Point origin(10, 10);
  Win32Window::Size size(1280, 720);
  if (!window.Create(L"flutter_trading_app", origin, size)) {
    return EXIT_FAILURE;
  }
  window.SetQuitOnClose(true);

  ::MSG msg;
  while (::GetMessage(&msg, nullptr, 0, 0)) {
    ::TranslateMessage(&msg);
    ::DispatchMessage(&msg);
  }

  ::CoUninitialize();
  return EXIT_SUCCESS;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/main.cpp
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 835: windows/runner/resource.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/resource.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 432.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

//{{NO_DEPENDENCIES}}
// Microsoft Visual C++ generated include file.
// Used by Runner.rc
//
#define IDI_APP_ICON                    101

// Next default values for new objects
//
#ifdef APSTUDIO_INVOKED
#ifndef APSTUDIO_READONLY_SYMBOLS
#define _APS_NEXT_RESOURCE_VALUE        102
#define _APS_NEXT_COMMAND_VALUE         40001
#define _APS_NEXT_CONTROL_VALUE         1001
#define _APS_NEXT_SYMED_VALUE           101
#endif
#endif

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/resource.h
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 836: windows/runner/utils.cpp
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/utils.cpp
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: C++
Ø§Ù„Ø­Ø¬Ù…: 2.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 69
================================================================================

#include "utils.h"

#include <flutter_windows.h>
#include <io.h>
#include <stdio.h>
#include <windows.h>

#include <iostream>

void CreateAndAttachConsole() {
  if (::AllocConsole()) {
    FILE *unused;
    if (freopen_s(&unused, "CONOUT$", "w", stdout)) {
      _dup2(_fileno(stdout), 1);
    }
    if (freopen_s(&unused, "CONOUT$", "w", stderr)) {
      _dup2(_fileno(stdout), 2);
    }
    std::ios::sync_with_stdio();
    FlutterDesktopResyncOutputStreams();
  }
}

std::vector<std::string> GetCommandLineArguments() {
  // Convert the UTF-16 command line arguments to UTF-8 for the Engine to use.
  int argc;
  wchar_t** argv = ::CommandLineToArgvW(::GetCommandLineW(), &argc);
  if (argv == nullptr) {
    return std::vector<std::string>();
  }

  std::vector<std::string> command_line_arguments;

  // Skip the first argument as it's the binary name.
  for (int i = 1; i < argc; i++) {
    command_line_arguments.push_back(Utf8FromUtf16(argv[i]));
  }

  ::LocalFree(argv);

  return command_line_arguments;
}

std::string Utf8FromUtf16(const wchar_t* utf16_string) {
  if (utf16_string == nullptr) {
    return std::string();
  }
  // First, find the length of the string with a safe upper bound (CWE-126).
  // UNICODE_STRING_MAX_CHARS (32767) is the maximum length of a UNICODE_STRING.
  int input_length = static_cast<int>(wcsnlen(utf16_string, UNICODE_STRING_MAX_CHARS));
  // Now use that bounded length to determine the required buffer size.
  // When an explicit length is passed, WideCharToMultiByte does not include
  // the null terminator in its returned size.
  int target_length = ::WideCharToMultiByte(
      CP_UTF8, WC_ERR_INVALID_CHARS, utf16_string,
      input_length, nullptr, 0, nullptr, nullptr);
  std::string utf8_string;
  if (target_length == 0 || static_cast<size_t>(target_length) > utf8_string.max_size()) {
    return utf8_string;
  }
  utf8_string.resize(target_length);
  int converted_length = ::WideCharToMultiByte(
      CP_UTF8, WC_ERR_INVALID_CHARS, utf16_string,
      input_length, utf8_string.data(), target_length, nullptr, nullptr);
  if (converted_length == 0) {
    return std::string();
  }
  return utf8_string;
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/utils.cpp
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 837: windows/runner/utils.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/utils.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 672.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 19
================================================================================

#ifndef RUNNER_UTILS_H_
#define RUNNER_UTILS_H_

#include <string>
#include <vector>

// Creates a console for the process, and redirects stdout and stderr to
// it for both the runner and the Flutter library.
void CreateAndAttachConsole();

// Takes a null-terminated wchar_t* encoded in UTF-16 and returns a std::string
// encoded in UTF-8. Returns an empty std::string on failure.
std::string Utf8FromUtf16(const wchar_t* utf16_string);

// Gets the command line arguments passed in as a std::vector<std::string>,
// encoded in UTF-8. Returns an empty std::vector<std::string> on failure.
std::vector<std::string> GetCommandLineArguments();

#endif  // RUNNER_UTILS_H_

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/utils.h
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 838: windows/runner/win32_window.cpp
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/win32_window.cpp
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: C++
Ø§Ù„Ø­Ø¬Ù…: 8.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 288
================================================================================

#include "win32_window.h"

#include <dwmapi.h>
#include <flutter_windows.h>

#include "resource.h"

namespace {

/// Window attribute that enables dark mode window decorations.
///
/// Redefined in case the developer's machine has a Windows SDK older than
/// version 10.0.22000.0.
/// See: https://docs.microsoft.com/windows/win32/api/dwmapi/ne-dwmapi-dwmwindowattribute
#ifndef DWMWA_USE_IMMERSIVE_DARK_MODE
#define DWMWA_USE_IMMERSIVE_DARK_MODE 20
#endif

constexpr const wchar_t kWindowClassName[] = L"FLUTTER_RUNNER_WIN32_WINDOW";

/// Registry key for app theme preference.
///
/// A value of 0 indicates apps should use dark mode. A non-zero or missing
/// value indicates apps should use light mode.
constexpr const wchar_t kGetPreferredBrightnessRegKey[] =
  L"Software\\Microsoft\\Windows\\CurrentVersion\\Themes\\Personalize";
constexpr const wchar_t kGetPreferredBrightnessRegValue[] = L"AppsUseLightTheme";

// The number of Win32Window objects that currently exist.
static int g_active_window_count = 0;

using EnableNonClientDpiScaling = BOOL __stdcall(HWND hwnd);

// Scale helper to convert logical scaler values to physical using passed in
// scale factor
int Scale(int source, double scale_factor) {
  return static_cast<int>(source * scale_factor);
}

// Dynamically loads the |EnableNonClientDpiScaling| from the User32 module.
// This API is only needed for PerMonitor V1 awareness mode.
void EnableFullDpiSupportIfAvailable(HWND hwnd) {
  HMODULE user32_module = LoadLibraryA("User32.dll");
  if (!user32_module) {
    return;
  }
  auto enable_non_client_dpi_scaling =
      reinterpret_cast<EnableNonClientDpiScaling*>(
          GetProcAddress(user32_module, "EnableNonClientDpiScaling"));
  if (enable_non_client_dpi_scaling != nullptr) {
    enable_non_client_dpi_scaling(hwnd);
  }
  FreeLibrary(user32_module);
}

}  // namespace

// Manages the Win32Window's window class registration.
class WindowClassRegistrar {
 public:
  ~WindowClassRegistrar() = default;

  // Returns the singleton registrar instance.
  static WindowClassRegistrar* GetInstance() {
    if (!instance_) {
      instance_ = new WindowClassRegistrar();
    }
    return instance_;
  }

  // Returns the name of the window class, registering the class if it hasn't
  // previously been registered.
  const wchar_t* GetWindowClass();

  // Unregisters the window class. Should only be called if there are no
  // instances of the window.
  void UnregisterWindowClass();

 private:
  WindowClassRegistrar() = default;

  static WindowClassRegistrar* instance_;

  bool class_registered_ = false;
};

WindowClassRegistrar* WindowClassRegistrar::instance_ = nullptr;

const wchar_t* WindowClassRegistrar::GetWindowClass() {
  if (!class_registered_) {
    WNDCLASS window_class{};
    window_class.hCursor = LoadCursor(nullptr, IDC_ARROW);
    window_class.lpszClassName = kWindowClassName;
    window_class.style = CS_HREDRAW | CS_VREDRAW;
    window_class.cbClsExtra = 0;
    window_class.cbWndExtra = 0;
    window_class.hInstance = GetModuleHandle(nullptr);
    window_class.hIcon =
        LoadIcon(window_class.hInstance, MAKEINTRESOURCE(IDI_APP_ICON));
    window_class.hbrBackground = 0;
    window_class.lpszMenuName = nullptr;
    window_class.lpfnWndProc = Win32Window::WndProc;
    RegisterClass(&window_class);
    class_registered_ = true;
  }
  return kWindowClassName;
}

void WindowClassRegistrar::UnregisterWindowClass() {
  UnregisterClass(kWindowClassName, nullptr);
  class_registered_ = false;
}

Win32Window::Win32Window() {
  ++g_active_window_count;
}

Win32Window::~Win32Window() {
  --g_active_window_count;
  Destroy();
}

bool Win32Window::Create(const std::wstring& title,
                         const Point& origin,
                         const Size& size) {
  Destroy();

  const wchar_t* window_class =
      WindowClassRegistrar::GetInstance()->GetWindowClass();

  const POINT target_point = {static_cast<LONG>(origin.x),
                              static_cast<LONG>(origin.y)};
  HMONITOR monitor = MonitorFromPoint(target_point, MONITOR_DEFAULTTONEAREST);
  UINT dpi = FlutterDesktopGetDpiForMonitor(monitor);
  double scale_factor = dpi / 96.0;

  HWND window = CreateWindow(
      window_class, title.c_str(), WS_OVERLAPPEDWINDOW,
      Scale(origin.x, scale_factor), Scale(origin.y, scale_factor),
      Scale(size.width, scale_factor), Scale(size.height, scale_factor),
      nullptr, nullptr, GetModuleHandle(nullptr), this);

  if (!window) {
    return false;
  }

  UpdateTheme(window);

  return OnCreate();
}

bool Win32Window::Show() {
  return ShowWindow(window_handle_, SW_SHOWNORMAL);
}

// static
LRESULT CALLBACK Win32Window::WndProc(HWND const window,
                                      UINT const message,
                                      WPARAM const wparam,
                                      LPARAM const lparam) noexcept {
  if (message == WM_NCCREATE) {
    auto window_struct = reinterpret_cast<CREATESTRUCT*>(lparam);
    SetWindowLongPtr(window, GWLP_USERDATA,
                     reinterpret_cast<LONG_PTR>(window_struct->lpCreateParams));

    auto that = static_cast<Win32Window*>(window_struct->lpCreateParams);
    EnableFullDpiSupportIfAvailable(window);
    that->window_handle_ = window;
  } else if (Win32Window* that = GetThisFromHandle(window)) {
    return that->MessageHandler(window, message, wparam, lparam);
  }

  return DefWindowProc(window, message, wparam, lparam);
}

LRESULT
Win32Window::MessageHandler(HWND hwnd,
                            UINT const message,
                            WPARAM const wparam,
                            LPARAM const lparam) noexcept {
  switch (message) {
    case WM_DESTROY:
      window_handle_ = nullptr;
      Destroy();
      if (quit_on_close_) {
        PostQuitMessage(0);
      }
      return 0;

    case WM_DPICHANGED: {
      auto newRectSize = reinterpret_cast<RECT*>(lparam);
      LONG newWidth = newRectSize->right - newRectSize->left;
      LONG newHeight = newRectSize->bottom - newRectSize->top;

      SetWindowPos(hwnd, nullptr, newRectSize->left, newRectSize->top, newWidth,
                   newHeight, SWP_NOZORDER | SWP_NOACTIVATE);

      return 0;
    }
    case WM_SIZE: {
      RECT rect = GetClientArea();
      if (child_content_ != nullptr) {
        // Size and position the child window.
        MoveWindow(child_content_, rect.left, rect.top, rect.right - rect.left,
                   rect.bottom - rect.top, TRUE);
      }
      return 0;
    }

    case WM_ACTIVATE:
      if (child_content_ != nullptr) {
        SetFocus(child_content_);
      }
      return 0;

    case WM_DWMCOLORIZATIONCOLORCHANGED:
      UpdateTheme(hwnd);
      return 0;
  }

  return DefWindowProc(window_handle_, message, wparam, lparam);
}

void Win32Window::Destroy() {
  OnDestroy();

  if (window_handle_) {
    DestroyWindow(window_handle_);
    window_handle_ = nullptr;
  }
  if (g_active_window_count == 0) {
    WindowClassRegistrar::GetInstance()->UnregisterWindowClass();
  }
}

Win32Window* Win32Window::GetThisFromHandle(HWND const window) noexcept {
  return reinterpret_cast<Win32Window*>(
      GetWindowLongPtr(window, GWLP_USERDATA));
}

void Win32Window::SetChildContent(HWND content) {
  child_content_ = content;
  SetParent(content, window_handle_);
  RECT frame = GetClientArea();

  MoveWindow(content, frame.left, frame.top, frame.right - frame.left,
             frame.bottom - frame.top, true);

  SetFocus(child_content_);
}

RECT Win32Window::GetClientArea() {
  RECT frame;
  GetClientRect(window_handle_, &frame);
  return frame;
}

HWND Win32Window::GetHandle() {
  return window_handle_;
}

void Win32Window::SetQuitOnClose(bool quit_on_close) {
  quit_on_close_ = quit_on_close;
}

bool Win32Window::OnCreate() {
  // No-op; provided for subclasses.
  return true;
}

void Win32Window::OnDestroy() {
  // No-op; provided for subclasses.
}

void Win32Window::UpdateTheme(HWND const window) {
  DWORD light_mode;
  DWORD light_mode_size = sizeof(light_mode);
  LSTATUS result = RegGetValue(HKEY_CURRENT_USER, kGetPreferredBrightnessRegKey,
                               kGetPreferredBrightnessRegValue,
                               RRF_RT_REG_DWORD, nullptr, &light_mode,
                               &light_mode_size);

  if (result == ERROR_SUCCESS) {
    BOOL enable_dark_mode = light_mode == 0;
    DwmSetWindowAttribute(window, DWMWA_USE_IMMERSIVE_DARK_MODE,
                          &enable_dark_mode, sizeof(enable_dark_mode));
  }
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/win32_window.cpp
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 839: windows/runner/win32_window.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/runner/win32_window.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 3.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 102
================================================================================

#ifndef RUNNER_WIN32_WINDOW_H_
#define RUNNER_WIN32_WINDOW_H_

#include <windows.h>

#include <functional>
#include <memory>
#include <string>

// A class abstraction for a high DPI-aware Win32 Window. Intended to be
// inherited from by classes that wish to specialize with custom
// rendering and input handling
class Win32Window {
 public:
  struct Point {
    unsigned int x;
    unsigned int y;
    Point(unsigned int x, unsigned int y) : x(x), y(y) {}
  };

  struct Size {
    unsigned int width;
    unsigned int height;
    Size(unsigned int width, unsigned int height)
        : width(width), height(height) {}
  };

  Win32Window();
  virtual ~Win32Window();

  // Creates a win32 window with |title| that is positioned and sized using
  // |origin| and |size|. New windows are created on the default monitor. Window
  // sizes are specified to the OS in physical pixels, hence to ensure a
  // consistent size this function will scale the inputted width and height as
  // as appropriate for the default monitor. The window is invisible until
  // |Show| is called. Returns true if the window was created successfully.
  bool Create(const std::wstring& title, const Point& origin, const Size& size);

  // Show the current window. Returns true if the window was successfully shown.
  bool Show();

  // Release OS resources associated with window.
  void Destroy();

  // Inserts |content| into the window tree.
  void SetChildContent(HWND content);

  // Returns the backing Window handle to enable clients to set icon and other
  // window properties. Returns nullptr if the window has been destroyed.
  HWND GetHandle();

  // If true, closing this window will quit the application.
  void SetQuitOnClose(bool quit_on_close);

  // Return a RECT representing the bounds of the current client area.
  RECT GetClientArea();

 protected:
  // Processes and route salient window messages for mouse handling,
  // size change and DPI. Delegates handling of these to member overloads that
  // inheriting classes can handle.
  virtual LRESULT MessageHandler(HWND window,
                                 UINT const message,
                                 WPARAM const wparam,
                                 LPARAM const lparam) noexcept;

  // Called when CreateAndShow is called, allowing subclass window-related
  // setup. Subclasses should return false if setup fails.
  virtual bool OnCreate();

  // Called when Destroy is called.
  virtual void OnDestroy();

 private:
  friend class WindowClassRegistrar;

  // OS callback called by message pump. Handles the WM_NCCREATE message which
  // is passed when the non-client area is being created and enables automatic
  // non-client DPI scaling so that the non-client area automatically
  // responds to changes in DPI. All other messages are handled by
  // MessageHandler.
  static LRESULT CALLBACK WndProc(HWND const window,
                                  UINT const message,
                                  WPARAM const wparam,
                                  LPARAM const lparam) noexcept;

  // Retrieves a class instance pointer for |window|
  static Win32Window* GetThisFromHandle(HWND const window) noexcept;

  // Update the window frame's theme to match the system theme.
  static void UpdateTheme(HWND const window);

  bool quit_on_close_ = false;

  // window handle for top level window.
  HWND window_handle_ = nullptr;

  // window handle for hosted content.
  HWND child_content_ = nullptr;
};

#endif  // RUNNER_WIN32_WINDOW_H_

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/runner/win32_window.h
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 840: scripts/release_android.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/scripts/release_android.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 20.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 1
================================================================================

#!/usr/bin/env bash

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: scripts/release_android.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 841: scripts/ci_cd/ci_cd_and_deployment.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/scripts/ci_cd/ci_cd_and_deployment.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 943.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 37
================================================================================

#!/bin/bash
set -e

echo "=========================================="
echo " Flutter CI / CD & Deployment Script"
echo "=========================================="

# 1) Install dependencies
flutter pub get

# 2) Clean previous builds
flutter clean

# 3) Run tests
echo "Running all tests..."
flutter test

# 4) Build APK (Staging & Production)
echo "Building Staging APK..."
flutter build apk --flavor staging -t lib/main.dart --debug

echo "Building Production APK..."
flutter build apk --flavor prod -t lib/main.dart --release

# 5) Build App Bundle (AAB)
echo "Building Android App Bundle..."
flutter build appbundle --release --flavor prod -t lib/main.dart

# 6) iOS Integration (if macOS runner)
if [[ "$OSTYPE" == "darwin"* ]]; then
  echo "Building iOS..."
  flutter build ios --release
fi

echo "=========================================="
echo " CI/CD Script Completed Successfully"
echo "=========================================="

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: scripts/ci_cd/ci_cd_and_deployment.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 842: assets/chart.html
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/assets/chart.html
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: HTML
Ø§Ù„Ø­Ø¬Ù…: 742.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 29
================================================================================

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Chart</title>
  <script src="lightweight-charts.standalone.production.js"></script>
  <style>
    html, body { margin: 0; padding: 0; }
    #chart { height: 100%; width: 100%; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    const chart = LightweightCharts.createChart(document.body, {
      layout: { textColor: '#d1d4dc', backgroundColor: '#000' },
      grid: { vertLines: { color: 'rgba(197, 203, 206, 0.5)' }},
    });
    const candleSeries = chart.addCandlestickSeries();

    function setHistory(data) {
      candleSeries.setData(data);
    }
    function updateCandle(candle) {
      candleSeries.update(candle);
    }
  </script>
</body>
</html>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: assets/chart.html
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 843: assets/js/sl_tp_overlay.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/assets/js/sl_tp_overlay.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 285.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

function drawSLTP(slTime, slPrice, tpTime, tpPrice) {
  chart.createPriceLine({
    price: slPrice,
    color: 'red',
    lineWidth: 1,
    lineStyle: LightweightCharts.LineStyle.Dashed,
  });
  chart.createPriceLine({
    price: tpPrice,
    color: 'green',
    lineWidth: 1,
  });
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: assets/js/sl_tp_overlay.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 844: assets/js/equity_curve.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/assets/js/equity_curve.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 123.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

function drawEquityCurve(points) {
  const series = chart.addLineSeries({ color: '#2196f3' });
  series.setData(points);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: assets/js/equity_curve.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 845: assets/js/zone_overlay.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/assets/js/zone_overlay.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 317.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 12
================================================================================

// ÙŠØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ Flutter Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ­ØµÙ„ ØªÙ†Ø¨ÙŠÙ‡
function highlightZone(fromTs, toTs, color = '#ffc107') {
  chart.addAreaSeries({
    topColor: color,
    bottomColor: color + "33",
    lineColor: color,
    lineWidth: 1,
  }).setData([
    { time: fromTs, value: 1 },
    { time: toTs, value: 1 }
  ]);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: assets/js/zone_overlay.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 846: assets/js/chart_extension.js
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/assets/js/chart_extension.js
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: JavaScript
Ø§Ù„Ø­Ø¬Ù…: 171.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

// ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Flutter
function addIndicatorSeries(name, dataPoints) {
  const series = chart.addLineSeries({ color: '#00bcd4' });
  series.setData(dataPoints);
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: assets/js/chart_extension.js
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 847: assets/lightweight_charts/chart.html
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/assets/lightweight_charts/chart.html
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: HTML
Ø§Ù„Ø­Ø¬Ù…: 1.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 66
================================================================================

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="lightweight-charts.standalone.production.js"></script>
  <style>
    html, body, #chart {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="chart"></div>

  <script>
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout: { backgroundColor: '#ffffff', textColor: '#000000' },
      rightPriceScale: { borderColor: '#ccc' },
      timeScale: { borderColor: '#ccc' },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#26a69a', downColor: '#ef5350',
      wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    });

    const emaShortSeries = chart.addLineSeries({
      color: '#2962FF', lineWidth: 2
    });

    const emaLongSeries = chart.addLineSeries({
      color: '#FF6D00', lineWidth: 2
    });

    const rsiChart = LightweightCharts.createChart(document.body, {
      width: document.body.clientWidth,
      height: 150,
    });
    const rsiSeries = rsiChart.addLineSeries({ color: '#8E24AA', lineWidth: 2 });

    window.setCandles = function(data) {
      candleSeries.setData(data);
    }

    window.updateLastCandle = function(candle) {
      candleSeries.update(candle);
    }

    window.setEmaShort = function(data) {
      emaShortSeries.setData(data);
    }

    window.setEmaLong = function(data) {
      emaLongSeries.setData(data);
    }

    window.setRsi = function(data) {
      rsiSeries.setData(data);
    }
  </script>
</body>
</html>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: assets/lightweight_charts/chart.html
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 848: docs/PRODUCTION_SETUP.md
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/docs/PRODUCTION_SETUP.md
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Markdown
Ø§Ù„Ø­Ø¬Ù…: 420.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 16
================================================================================

# Production Setup

This document explains how to configure the application for production:

1. **API Keys**
   - Store OANDA API token in a secure vault.
   - Set environment variable `OANDA_API_KEY`.

2. **Certificate Pinning**
   - Update certificate SHA256 pins in certificate_pinning.dart.

3. **Flavors**
   - Build using `--flavor prod` for production builds.

4. **Security**
   - Ensure SSL pinning is enabled.

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: docs/PRODUCTION_SETUP.md
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 849: build.yaml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/build.yaml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: YAML
Ø§Ù„Ø­Ø¬Ù…: 147.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 8
================================================================================

targets:
  $default:
    builders:
      dart2js:
        options:
          dart2js_args:
            - --minify
            - --trust-primitives

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: build.yaml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 850: pubspec.yaml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/pubspec.yaml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: YAML
Ø§Ù„Ø­Ø¬Ù…: 783.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 43
================================================================================

name: flutter_trading_app
description: ØªØ·Ø¨ÙŠÙ‚ ØªØ¯Ø§ÙˆÙ„ Ù…Ø§Ù„ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¨Ù†ÙŠ Ø¨Ù€Ù€ Flutter + Dart
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: ">=2.20.0 <3.0.0"

dependencies:
  flutter:
    sdk: flutter

  # State Management
  flutter_bloc: ^8.1.0
  equatable: ^2.0.5

  # HTTP & WebSocket
  dio: ^5.0.0
  web_socket_channel: ^2.2.0

  # Local Storage
  hive: ^2.2.3
  hive_flutter: ^1.1.0

  # JSON serialization
  json_annotation: ^4.8.0

  # Charts
  fl_chart: ^0.60.0
  get_it: ^8.3.0
  go_router: ^17.0.1
  flutter_secure_storage: ^10.0.0
  webview_flutter: ^4.13.1
  http: ^1.6.0
  bloc_test: ^9.1.7
  mocktail: ^1.0.4
  path_provider: ^2.1.5

dev_dependencies:
  flutter_test:
    sdk: flutter
  build_runner: ^2.4.4
  json_serializable: ^6.6.1

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: pubspec.yaml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 851: 90.py
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/90.py
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Python
Ø§Ù„Ø­Ø¬Ù…: 23.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 619
================================================================================

#!/usr/bin/env python3
"""
massive_file_runner_fixed.py
Fixed version for massive files (68,000+ lines)
Handles EOT/EOF properly and checks directory structure
Now also skips Flutter commands
"""

import os
import sys
import re
import time
import subprocess
from pathlib import Path

class FixedMassiveFileRunner:
    def __init__(self, input_file, batch_size=1000):
        self.input_file = input_file
        self.batch_size = batch_size
        self.total_lines = 0
        self.total_commands = 0
        self.bash_commands = []
        
        # Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆØ§Ù…Ø± Flutter Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ ØªØ®Ø·ÙŠÙ‡Ø§
        self.flutter_commands_to_skip = [
            'flutter run',
            'flutter get pub',
            'flutter clean',
            'flutter pub get',
            'flutter pub upgrade',
            'flutter build',
            'flutter test'
        ]
        
    def count_lines(self):
        """Count file lines quickly"""
        print("ğŸ“Š Counting file lines...")
        with open(self.input_file, 'r', encoding='utf-8') as f:
            for i, _ in enumerate(f, 1):
                pass
        self.total_lines = i
        print(f"  Total lines: {self.total_lines:,}")
        return self.total_lines
    
    def is_flutter_command(self, line):
        """Check if line contains Flutter commands to skip"""
        line_lower = line.lower()
        for flutter_cmd in self.flutter_commands_to_skip:
            if flutter_cmd in line_lower:
                return True
        return False
    
    def extract_bash_commands_fixed(self):
        """Extract ONLY valid bash commands - FIXED VERSION"""
        print("ğŸ” Extracting bash commands (fixed version)...")
        print(f"ğŸš« Skipping Flutter commands: {', '.join(self.flutter_commands_to_skip[:3])}...")
        
        self.bash_commands = []
        in_heredoc = False
        heredoc_marker = ""
        current_command = []
        command_count = 0
        skipped_commands = 0
        
        with open(self.input_file, 'r', encoding='utf-8') as f:
            for line_num, line in enumerate(f, 1):
                line = line.rstrip('\n')
                
                # Check for Flutter commands (skip them)
                if self.is_flutter_command(line):
                    skipped_commands += 1
                    if skipped_commands <= 5:  # Show first 5 skipped commands
                        print(f"  â­ï¸ Skipping Flutter command at line {line_num}: {line[:80]}...")
                    continue
                
                # Skip comments outside heredoc
                if line.strip().startswith('//') and not in_heredoc:
                    continue
                
                # Skip Gradle/Kotlin code outside heredoc
                if (re.match(r'^\s*implementation\(', line) or
                    re.match(r'^\s*class\s', line) or
                    re.match(r'^\s*package\s', line)) and not in_heredoc:
                    continue
                
                # Start of heredoc block (cat > file << 'EOT')
                if not in_heredoc and 'cat >' in line and '<<' in line:
                    match = re.search(r'<<\s*[\'"]?(EOT|EOF)[\'"]?', line)
                    if match:
                        in_heredoc = True
                        heredoc_marker = match.group(1)
                        # Start new command group
                        current_command = [line]
                    continue
                
                # Inside heredoc
                if in_heredoc:
                    current_command.append(line)
                    # Check for end marker
                    if line.strip() == heredoc_marker:
                        in_heredoc = False
                        full_command = '\n'.join(current_command)
                        
                        # Check if heredoc contains Flutter commands
                        if not self.is_flutter_command(full_command):
                            self.bash_commands.append(full_command)
                            command_count += 1
                        else:
                            skipped_commands += 1
                            if skipped_commands <= 5:
                                print(f"  â­ï¸ Skipping heredoc with Flutter at line {line_num}")
                        
                        current_command = []
                    continue
                
                # mkdir commands - only add if not Flutter related
                if line.strip().startswith('mkdir '):
                    if not self.is_flutter_command(line):
                        self.bash_commands.append(line)
                        command_count += 1
                    else:
                        skipped_commands += 1
                        if skipped_commands <= 5:
                            print(f"  â­ï¸ Skipping mkdir Flutter at line {line_num}: {line[:80]}...")
                
                # IMPORTANT: Do NOT add standalone EOT/EOF - they should only appear inside heredoc blocks
                # Skip these lines
        
        self.total_commands = command_count
        print(f"âœ… Extracted {self.total_commands:,} bash commands")
        print(f"â­ï¸ Skipped {skipped_commands:,} Flutter-related commands")
        
        # Debug: Show first few commands
        if self.bash_commands:
            print("\nğŸ“‹ First 5 commands preview:")
            for i, cmd in enumerate(self.bash_commands[:5], 1):
                print(f"{i}: {cmd[:100]}..." if len(cmd) > 100 else f"{i}: {cmd}")
        else:
            print("âš ï¸ No bash commands found after filtering")
        
        return self.bash_commands
    
    def filter_commands_by_type(self, required_types=None):
        """
        Filter commands by required types (mkdir, cat, etc.)
        Args:
            required_types: List of command types to keep (e.g., ['mkdir', 'cat'])
        """
        if not required_types:
            return self.bash_commands
        
        filtered_commands = []
        for cmd in self.bash_commands:
            cmd_lower = cmd.lower()
            keep = False
            
            # Check if command contains any required type
            for req_type in required_types:
                if req_type in cmd_lower:
                    keep = True
                    break
            
            # Special handling for mkdir commands
            if 'mkdir' in required_types and cmd.strip().startswith('mkdir '):
                keep = True
            
            if keep:
                filtered_commands.append(cmd)
        
        print(f"ğŸ” Filtered to {len(filtered_commands)} commands containing: {required_types}")
        return filtered_commands
    
    def extract_terminal_commands_only(self):
        """
        Extract ONLY terminal commands (mkdir, cat, eqf, sed, sid)
        and exclude Flutter commands
        """
        terminal_commands = ['mkdir', 'cat', 'eqf', 'sed', 'sid']
        print(f"ğŸ” Extracting terminal commands only: {terminal_commands}")
        
        terminal_only = []
        skipped_not_terminal = 0
        
        for cmd in self.bash_commands:
            cmd_lower = cmd.lower()
            is_terminal = False
            
            # Check if contains terminal command
            for term_cmd in terminal_commands:
                if term_cmd in cmd_lower:
                    is_terminal = True
                    break
            
            if is_terminal:
                terminal_only.append(cmd)
            else:
                skipped_not_terminal += 1
        
        print(f"âœ… Found {len(terminal_only)} terminal commands")
        print(f"â­ï¸ Skipped {skipped_not_terminal} non-terminal commands")
        
        # Update the commands list
        self.bash_commands = terminal_only
        self.total_commands = len(terminal_only)
        
        return terminal_only
    
    def create_batches_fixed(self):
        """Create batches with directory creation first"""
        if not self.bash_commands:
            print("âš ï¸ No commands to batch")
            return []
        
        # Separate mkdir commands from file creation commands
        mkdir_commands = []
        other_commands = []
        
        for cmd in self.bash_commands:
            if cmd.strip().startswith('mkdir '):
                mkdir_commands.append(cmd)
            else:
                other_commands.append(cmd)
        
        print(f"ğŸ“Š Command types after filtering:")
        print(f"  - mkdir commands: {len(mkdir_commands)}")
        print(f"  - file commands: {len(other_commands)}")
        
        # Create batches: all mkdir first, then others
        batches = []
        
        # Batch 1: All mkdir commands
        if mkdir_commands:
            batches.append(mkdir_commands)
        
        # Other commands in batches
        for i in range(0, len(other_commands), self.batch_size):
            batch = other_commands[i:i + self.batch_size]
            batches.append(batch)
        
        print(f"ğŸ“¦ Created {len(batches)} batches")
        return batches
    
    def create_batch_scripts_fixed(self, batches):
        """Create batch scripts with error handling"""
        os.makedirs('batch_scripts_fixed', exist_ok=True)
        script_paths = []
        
        for i, batch in enumerate(batches, 1):
            script_name = f'batch_scripts_fixed/batch_{i:03d}.sh'
            
            with open(script_name, 'w', encoding='utf-8') as f:
                f.write("#!/bin/bash\n")
                f.write(f"# Batch {i} of {len(batches)}\n")
                f.write(f"# Commands: {len(batch)} (Flutter commands filtered out)\n")
                f.write("set -e  # Stop on error\n")
                f.write("\n")
                f.write(f'echo "ğŸš€ Batch {i}/{len(batches)} - {len(batch)} commands (No Flutter)"\n')
                f.write("date\n")
                f.write("\n")
                
                # Add mkdir -p for all directories first
                if i == 1 and batch and batch[0].startswith('mkdir '):
                    f.write("# Create all directories first\n")
                    for cmd in batch:
                        # Convert mkdir to mkdir -p for safety
                        if cmd.startswith('mkdir '):
                            f.write(cmd.replace('mkdir ', 'mkdir -p ') + '\n')
                    f.write("\necho 'âœ… All directories created'\n")
                    f.write("\n")
                else:
                    # For file creation batches
                    f.write("# Create files (Flutter-free)\n")
                    for cmd in batch:
                        f.write(cmd + '\n')
                
                f.write("\n")
                f.write(f'echo "âœ… Batch {i} completed (No Flutter commands)"\n')
                f.write("date\n")
            
            os.chmod(script_name, 0o755)
            script_paths.append(script_name)
        
        print(f"âœ… Created {len(script_paths)} batch scripts (Flutter filtered)")
        return script_paths
    
    def check_directories_exist(self):
        """Check if required parent directories exist before running"""
        print("\nğŸ” Checking directory structure...")
        
        missing_dirs = []
        
        for cmd in self.bash_commands:
            if cmd.startswith('cat >'):
                # Extract filename from cat command
                match = re.match(r'cat\s+>\s*([^\s<]+)', cmd)
                if match:
                    filename = match.group(1)
                    # Get directory part
                    dir_path = os.path.dirname(filename)
                    if dir_path and not os.path.exists(dir_path):
                        missing_dirs.append(dir_path)
        
        if missing_dirs:
            print("âš ï¸ Missing directories detected:")
            unique_dirs = list(set(missing_dirs))[:10]  # Show first 10
            for d in unique_dirs:
                print(f"  - {d}")
            
            if len(missing_dirs) > 10:
                print(f"  ... and {len(missing_dirs) - 10} more")
            
            # Create missing directories
            response = input("\nCreate missing directories? (y/n): ")
            if response.lower() == 'y':
                for d in set(missing_dirs):
                    os.makedirs(d, exist_ok=True)
                    print(f"  Created: {d}")
        
        return len(missing_dirs) == 0
    
    def create_optimized_single_script(self):
        """Create a single optimized script that handles everything"""
        script_name = "optimized_run_all_no_flutter.sh"
        
        print(f"\nğŸ”¨ Creating optimized single script (No Flutter)...")
        
        with open(script_name, 'w', encoding='utf-8') as f:
            f.write("#!/bin/bash\n")
            f.write("# Optimized script for massive file execution - NO FLUTTER\n")
            f.write("# Auto-generated with error handling\n")
            f.write("\n")
            f.write("set -e  # Stop on error\n")
            f.write("set -x  # Print commands\n")
            f.write("\n")
            f.write('echo "=========================================="\n')
            f.write('echo "ğŸš€ STARTING OPTIMIZED EXECUTION (NO FLUTTER)"\n')
            f.write('echo "=========================================="\n')
            f.write("date\n")
            f.write("\n")
            
            # Phase 1: Extract and create all directories first
            f.write("# PHASE 1: Create all directories\n")
            f.write('echo "--- Phase 1: Creating directories ---"\n')
            f.write("\n")
            
            dirs_created = set()
            for cmd in self.bash_commands:
                if cmd.startswith('mkdir '):
                    # Extract directory path
                    match = re.match(r'mkdir\s+(?:-p\s+)?["\']?([^"\'\s]+)["\']?', cmd)
                    if match:
                        dir_path = match.group(1)
                        if dir_path not in dirs_created:
                            f.write(f"mkdir -p '{dir_path}'\n")
                            dirs_created.add(dir_path)
            
            f.write('echo "âœ… Phase 1 complete: Directories created"\n')
            f.write("\n")
            
            # Phase 2: Create all files (Flutter-free)
            f.write("# PHASE 2: Create all files (NO FLUTTER)\n")
            f.write('echo "--- Phase 2: Creating files ---"\n')
            f.write("\n")
            
            file_count = 0
            for cmd in self.bash_commands:
                if not cmd.startswith('mkdir '):
                    f.write(cmd + '\n')
                    file_count += 1
            
            f.write("\n")
            f.write(f'echo "âœ… Phase 2 complete: {file_count} files created (No Flutter)"\n')
            f.write("\n")
            f.write('echo "=========================================="\n')
            f.write('echo "ğŸ‰ ALL COMMANDS EXECUTED SUCCESSFULLY"\n')
            f.write(f'echo "Total commands: {self.total_commands:,}"\n')
            f.write(f'echo "Flutter commands: Filtered out"\n')
            f.write('echo "=========================================="\n')
            f.write("date\n")
        
        os.chmod(script_name, 0o755)
        
        print(f"âœ… Created: {script_name}")
        print(f"ğŸ“ Lines in script: {sum(1 for line in open(script_name))}")
        
        return script_name
    
    def run_script_with_error_handling(self, script_path):
        """Run script with better error handling"""
        print(f"\nğŸš€ Running: {os.path.basename(script_path)}")
        print("-" * 60)
        
        start_time = time.time()
        
        try:
            # Run with bash -x to see commands
            process = subprocess.Popen(
                ['bash', '-x', script_path],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                bufsize=1,
                universal_newlines=True
            )
            
            # Read output in real-time
            output_lines = []
            while True:
                stdout_line = process.stdout.readline()
                stderr_line = process.stderr.readline()
                
                if not stdout_line and not stderr_line and process.poll() is not None:
                    break
                
                if stdout_line:
                    line = stdout_line.strip()
                    if line and not line.startswith('+ echo'):
                        print(f"  {line}")
                    output_lines.append(line)
                
                if stderr_line:
                    line = stderr_line.strip()
                    if line:
                        print(f"  âŒ {line}")
            
            process.wait()
            elapsed = time.time() - start_time
            
            if process.returncode == 0:
                print(f"\nâœ… Success in {elapsed:.1f} seconds (No Flutter commands)")
                return True
            else:
                print(f"\nâŒ Failed with exit code {process.returncode}")
                print(f"   Time: {elapsed:.1f} seconds")
                return False
                
        except Exception as e:
            print(f"\nâš ï¸ Error: {e}")
            return False
    
    def run_step_by_step(self):
        """Run commands step by step with user confirmation"""
        print("\nğŸ”§ STEP-BY-STEP EXECUTION (Flutter filtered)")
        print("=" * 60)
        
        successful = 0
        failed = 0
        
        for i, cmd in enumerate(self.bash_commands, 1):
            print(f"\nCommand {i}/{len(self.bash_commands)} (No Flutter):")
            print(f"  {cmd[:100]}..." if len(cmd) > 100 else f"  {cmd}")
            
            # Skip if just EOT/EOF
            if cmd.strip() in ['EOT', 'EOF']:
                print("  â­ï¸ Skipping (marker only)")
                continue
            
            response = input("Run this command? (y/n/s=skip all): ")
            
            if response.lower() == 's':
                print("â¹ï¸ Skipping all remaining commands")
                break
            elif response.lower() != 'y':
                print("â­ï¸ Skipped")
                continue
            
            # Run the command
            try:
                if cmd.startswith('mkdir '):
                    # Handle mkdir
                    dir_path = cmd.replace('mkdir ', '').strip().strip("'\"")
                    os.makedirs(dir_path, exist_ok=True)
                    print(f"  âœ… Created directory: {dir_path}")
                    successful += 1
                elif 'cat >' in cmd:
                    # This is complex - save to script and run
                    temp_script = f"temp_cmd_{i}.sh"
                    with open(temp_script, 'w') as f:
                        f.write("#!/bin/bash\n")
                        f.write(cmd + '\n')
                    os.chmod(temp_script, 0o755)
                    
                    result = subprocess.run(['bash', temp_script], 
                                          capture_output=True, text=True)
                    
                    if result.returncode == 0:
                        print(f"  âœ… File created")
                        successful += 1
                    else:
                        print(f"  âŒ Failed: {result.stderr[:100]}")
                        failed += 1
                    
                    os.remove(temp_script)
                else:
                    print(f"  âš ï¸ Unknown command type")
                    failed += 1
                    
            except Exception as e:
                print(f"  âŒ Error: {e}")
                failed += 1
        
        print(f"\n{'='*60}")
        print("ğŸ“Š FINAL RESULTS (No Flutter):")
        print(f"  âœ… Successful: {successful}")
        print(f"  âŒ Failed: {failed}")
        print(f"  ğŸ“ Total: {len(self.bash_commands)}")
        print(f"  ğŸš« Flutter commands: Filtered out")
        print(f"{'='*60}")

def main():
    if len(sys.argv) < 2:
        print("Usage: python massive_file_runner_fixed.py <code_file> [options]")
        print("\nOptions:")
        print("  --optimized    : Create optimized single script")
        print("  --step-by-step : Run commands one by one")
        print("  --check-only   : Only check, don't run")
        print("  --batch-size N : Commands per batch (default: 1000)")
        print("  --terminal-only: Extract only terminal commands (mkdir, cat, eqf, sed, sid)")
        print("  --filter-type T1,T2: Filter by command types (e.g., mkdir,cat)")
        print("\nExamples:")
        print("  python massive_file_runner_fixed.py codes.txt --terminal-only")
        print("  python massive_file_runner_fixed.py codes.txt --filter-type mkdir,cat")
        print("  python massive_file_runner_fixed.py codes.txt --optimized --batch-size 500")
        sys.exit(1)
    
    input_file = sys.argv[1]
    
    # Parse options
    optimized = False
    step_by_step = False
    check_only = False
    terminal_only = False
    filter_types = None
    batch_size = 1000
    
    for i in range(2, len(sys.argv)):
        if sys.argv[i] == '--optimized':
            optimized = True
        elif sys.argv[i] == '--step-by-step':
            step_by_step = True
        elif sys.argv[i] == '--check-only':
            check_only = True
        elif sys.argv[i] == '--terminal-only':
            terminal_only = True
        elif sys.argv[i] == '--filter-type' and i + 1 < len(sys.argv):
            filter_types = sys.argv[i + 1].split(',')
        elif sys.argv[i] == '--batch-size' and i + 1 < len(sys.argv):
            batch_size = int(sys.argv[i + 1])
    
    if not os.path.exists(input_file):
        print(f"âŒ File not found: {input_file}")
        sys.exit(1)
    
    # Create runner
    runner = FixedMassiveFileRunner(input_file, batch_size)
    
    # 1. Count lines
    runner.count_lines()
    
    # 2. Extract commands (FIXED VERSION) - automatically skips Flutter
    runner.extract_bash_commands_fixed()
    
    # 3. Apply additional filters if requested
    if terminal_only:
        runner.extract_terminal_commands_only()
    elif filter_types:
        filtered = runner.filter_commands_by_type(filter_types)
        runner.bash_commands = filtered
        runner.total_commands = len(filtered)
    
    if not runner.bash_commands:
        print("âš ï¸ No bash commands found after filtering")
        sys.exit(1)
    
    # 4. Check directories
    runner.check_directories_exist()
    
    if check_only:
        print("\nâœ… Check complete - no errors found")
        return
    
    if step_by_step:
        runner.run_step_by_step()
        return
    
    if optimized:
        # Create and run optimized single script
        script = runner.create_optimized_single_script()
        
        print(f"\nâš ï¸ Ready to run {runner.total_commands:,} commands (Flutter filtered)")
        response = input("Run optimized script? (y/n): ")
        
        if response.lower() == 'y':
            runner.run_script_with_error_handling(script)
        else:
            print(f"\nğŸ“‹ You can run it manually:")
            print(f"  bash {script}")
    else:
        # Use batch method
        batches = runner.create_batches_fixed()
        scripts = runner.create_batch_scripts_fixed(batches)
        
        print(f"\nâš ï¸ Ready to run {len(scripts)} batches (Flutter filtered)")
        response = input("Run all batches? (y/n): ")
        
        if response.lower() == 'y':
            for i, script in enumerate(scripts, 1):
                print(f"\nâ–¶ï¸ Batch {i}/{len(scripts)} (No Flutter)")
                success = runner.run_script_with_error_handling(script)
                if not success:
                    response = input("Continue? (y/n): ")
                    if response.lower() != 'y':
                        break
        else:
            print(f"\nğŸ“‹ Scripts are in 'batch_scripts_fixed/' directory")

if __name__ == "__main__":
    main()


================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: 90.py
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 852: README.md
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/README.md
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Markdown
Ø§Ù„Ø­Ø¬Ù…: 641.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 17
================================================================================

# flutter_trading_app

A new Flutter project.

## Getting Started

This project is a starting point for a Flutter application.

A few resources to get you started if this is your first Flutter project:

- [Learn Flutter](https://docs.flutter.dev/get-started/learn-flutter)
- [Write your first Flutter app](https://docs.flutter.dev/get-started/codelab)
- [Flutter learning resources](https://docs.flutter.dev/reference/learning-resources)

For help getting started with Flutter development, view the
[online documentation](https://docs.flutter.dev/), which offers tutorials,
samples, guidance on mobile development, and a full API reference.

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: README.md
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 853: analysis_options.yaml
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/analysis_options.yaml
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: YAML
Ø§Ù„Ø­Ø¬Ù…: 1.4 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 28
================================================================================

# This file configures the analyzer, which statically analyzes Dart code to
# check for errors, warnings, and lints.
#
# The issues identified by the analyzer are surfaced in the UI of Dart-enabled
# IDEs (https://dart.dev/tools#ides-and-editors). The analyzer can also be
# invoked from the command line by running `flutter analyze`.

# The following line activates a set of recommended lints for Flutter apps,
# packages, and plugins designed to encourage good coding practices.
include: package:flutter_lints/flutter.yaml

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: analysis_options.yaml
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 854: opl.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/opl.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 10.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 322
================================================================================

#!/data/data/com.termux/files/usr/bin/bash

# Ø³ÙƒØ±Ø¨Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Flutter Ù„Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø®Ø§Øµ
# ===========================================

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
PROJECT_NAME="flutter_trading_app"
OUTPUT_FILE="${PROJECT_NAME}_codes_$(date +%Y%m%d_%H%M%S).txt"
TEMP_FILE="temp_codes.txt"

# Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ Ù…Ø´Ø±ÙˆØ¹Ùƒ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø§ Ø±Ø£ÙŠØªÙ‡)
IMPORTANT_DIRS="lib scripts integration_test test android ios macos windows assets docs"

# Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©
IMPORTANT_FILES="pubspec.yaml pubspec.lock analysis_options.yaml build.yaml README.md flutter_trading_app.iml"

# Ù…Ø¬Ù„Ø¯Ø§Øª ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ø§
EXCLUDE_DIRS="build .dart_tool .git .idea __pycache__ node_modules tmp*"

# Ù…Ù„ÙØ§Øª ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ø§
EXCLUDE_FILES="*.apk *.ipa *.img *.so *.o *.a *.pyc *.lock *.patch"

# Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
print_progress() {
    echo "â–¶ $1"
}

# Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
print_error() {
    echo "âŒ $1"
}

# Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¬Ø§Ø­
print_success() {
    echo "âœ… $1"
}

# Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
print_info() {
    echo "â„¹ï¸ $1"
}

# ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
clear
echo "=========================================="
echo "   Ø³ÙƒØ±Ø¨Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Flutter"
echo "   Ù„Ù…Ø´Ø±ÙˆØ¹: $PROJECT_NAME"
echo "=========================================="
echo ""

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø´Ø±ÙˆØ¹ Flutter
if [ ! -f "pubspec.yaml" ]; then
    print_error "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù pubspec.yaml ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ!"
    print_info "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ÙÙŠ Ù…Ø¬Ù„Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter Ø§Ù„ØµØ­ÙŠØ­"
    exit 1
fi

# Ø¹Ø±Ø¶ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
print_info "Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯:"
echo "------------------------------------------"
for dir in $IMPORTANT_DIRS; do
    if [ -d "$dir" ]; then
        count=$(find "$dir" -type f -name "*.dart" 2>/dev/null | wc -l)
        if [ $count -gt 0 ]; then
            echo "ğŸ“ $dir/ ($count Ù…Ù„Ù Dart)"
        else
            echo "ğŸ“ $dir/"
        fi
    fi
done
echo "------------------------------------------"

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
print_progress "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬: $OUTPUT_FILE"
> "$OUTPUT_FILE"

# ÙƒØªØ§Ø¨Ø© Ø±Ø£Ø³ Ø§Ù„Ù…Ù„Ù
{
    echo "# =========================================="
    echo "# Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter"
    echo "# Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: $PROJECT_NAME"
    echo "# ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬: $(date)"
    echo "# Ø§Ù„Ù…Ø³Ø§Ø±: $(pwd)"
    echo "# =========================================="
    echo ""
    echo "# Ø§Ù„ÙÙ‡Ø±Ø³:"
    echo ""
} >> "$OUTPUT_FILE"

# Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª
total_files=0
dart_files=0
other_files=0

# Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
extract_file() {
    local file_path="$1"
    local relative_path="${file_path#./}"
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
    local file_name=$(basename "$file_path")
    local file_dir=$(dirname "$relative_path")
    local file_size=$(du -h "$file_path" 2>/dev/null | cut -f1 || echo "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")
    local file_lines=$(wc -l < "$file_path" 2>/dev/null || echo "0")
    
    # ÙƒØªØ§Ø¨Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
    {
        echo ""
        echo "# =========================================="
        echo "# Ù…Ù„Ù: $relative_path"
        echo "# Ø§Ù„Ù…Ø¬Ù„Ø¯: $file_dir"
        echo "# Ø§Ù„Ø§Ø³Ù…: $file_name"
        echo "# Ø§Ù„Ø­Ø¬Ù…: $file_size"
        echo "# Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: $file_lines"
        echo "# =========================================="
        echo ""
    } >> "$OUTPUT_FILE"
    
    # Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
    cat "$file_path" >> "$OUTPUT_FILE" 2>/dev/null
    
    # Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„
    echo "" >> "$OUTPUT_FILE"
    echo "# --- Ù†Ù‡Ø§ÙŠØ© Ù…Ù„Ù: $file_name ---" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    
    # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
    ((total_files++))
    
    # Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
    echo "  â†³ ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø©: $relative_path"
}

# 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Dart ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
print_progress "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª Dart..."
for dir in $IMPORTANT_DIRS; do
    if [ -d "$dir" ]; then
        count=$(find "$dir" -type f -name "*.dart" 2>/dev/null | wc -l)
        if [ $count -gt 0 ]; then
            print_info "Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¬Ù„Ø¯: $dir (ÙŠÙˆØ¬Ø¯ $count Ù…Ù„Ù Dart)"
            
            # Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¥Ù„Ù‰ Ø§Ù„ÙÙ‡Ø±Ø³
            echo "# ğŸ“ $dir/" >> "$OUTPUT_FILE"
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Dart ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯
            while IFS= read -r file; do
                # ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
                skip=0
                for exclude in $EXCLUDE_DIRS; do
                    if [[ "$file" == *"/$exclude/"* ]]; then
                        skip=1
                        break
                    fi
                done
                
                if [ $skip -eq 0 ]; then
                    extract_file "$file"
                    ((dart_files++))
                    
                    # Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ÙÙ‡Ø±Ø³
                    echo "#   ğŸ“„ ${file#./}" >> "$TEMP_FILE" 2>/dev/null
                fi
            done < <(find "$dir" -type f -name "*.dart" 2>/dev/null | sort)
        fi
    fi
done

# 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©
print_progress "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©..."
{
    echo ""
    echo "# =========================================="
    echo "# Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ù‡Ù…Ø©"
    echo "# =========================================="
    echo ""
} >> "$OUTPUT_FILE"

for file in $IMPORTANT_FILES; do
    if [ -f "$file" ]; then
        print_info "Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù: $file"
        extract_file "$file"
        ((other_files++))
    fi
done

# 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª YAML ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
print_progress "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø©..."
yaml_files=$(find . -type f \( -name "*.yaml" -o -name "*.yml" \) ! -path "./$OUTPUT_FILE" 2>/dev/null | grep -vE "$(echo $EXCLUDE_DIRS | sed 's/ /|/g')")
if [ -n "$yaml_files" ]; then
    {
        echo ""
        echo "# =========================================="
        echo "# Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (YAML/YML)"
        echo "# =========================================="
        echo ""
    } >> "$OUTPUT_FILE"
    
    while IFS= read -r file; do
        # ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
        if [[ "$file" == "./$OUTPUT_FILE" ]]; then
            continue
        fi
        
        # ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
        skip=0
        for exclude in $EXCLUDE_DIRS; do
            if [[ "$file" == *"/$exclude/"* ]]; then
                skip=1
                break
            fi
        done
        
        if [ $skip -eq 0 ]; then
            extract_file "$file"
            ((other_files++))
        fi
    done <<< "$yaml_files"
fi

# 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
print_progress "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø®Ø±Ù‰..."
{
    echo ""
    echo "# =========================================="
    echo "# Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø£Ø®Ø±Ù‰"
    echo "# =========================================="
    echo ""
} >> "$OUTPUT_FILE"

# Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø¨Ø±Ù…Ø¬Ø© Ø´Ø§Ø¦Ø¹Ø©
code_extensions="*.py *.sh *.bash *.js *.ts *.java *.kt *.swift *.cpp *.c *.h"
for ext in $code_extensions; do
    files=$(find . -type f -name "$ext" ! -path "./$OUTPUT_FILE" 2>/dev/null | head -20)
    if [ -n "$files" ]; then
        while IFS= read -r file; do
            # ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©
            skip=0
            for exclude in $EXCLUDE_DIRS; do
                if [[ "$file" == *"/$exclude/"* ]]; then
                    skip=1
                    break
                fi
            done
            
            if [ $skip -eq 0 ]; then
                extract_file "$file"
                ((other_files++))
            fi
        done <<< "$files"
    fi
done

# 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø±Ø³ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
print_progress "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø±Ø³..."
if [ -f "$TEMP_FILE" ]; then
    cat "$TEMP_FILE" >> "$OUTPUT_FILE".tmp
    mv "$OUTPUT_FILE".tmp "$OUTPUT_FILE"
    rm -f "$TEMP_FILE"
fi

# 6. Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø®Øµ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
{
    echo ""
    echo "# =========================================="
    echo "# Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬"
    echo "# =========================================="
    echo "#"
    echo "# Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:"
    echo "#   â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: $total_files"
    echo "#   â€¢ Ù…Ù„ÙØ§Øª Dart: $dart_files"
    echo "#   â€¢ Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰: $other_files"
    echo "#"
    echo "# Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:"
} >> "$OUTPUT_FILE"

for dir in $IMPORTANT_DIRS; do
    if [ -d "$dir" ]; then
        count=$(find "$dir" -type f ! -name "*.DS_Store" 2>/dev/null | wc -l)
        dart_count=$(find "$dir" -type f -name "*.dart" 2>/dev/null | wc -l)
        if [ $count -gt 0 ]; then
            echo "#   â€¢ $dir/: $count Ù…Ù„Ù (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ $dart_count Dart)" >> "$OUTPUT_FILE"
        fi
    fi
done

{
    echo "#"
    echo "# ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¨ÙˆØ§Ø³Ø·Ø© Ø³ÙƒØ±Ø¨Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Flutter"
    echo "# =========================================="
} >> "$OUTPUT_FILE"

# Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
file_size=$(du -h "$OUTPUT_FILE" 2>/dev/null | cut -f1 || echo "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")
line_count=$(wc -l < "$OUTPUT_FILE" 2>/dev/null || echo "0")

# Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
echo ""
echo "=========================================="
print_success "Ø§ÙƒØªÙ…Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!"
echo "=========================================="
echo ""
print_info "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬:"
echo "  â€¢ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: $OUTPUT_FILE"
echo "  â€¢ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: $file_size"
echo "  â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: $line_count"
echo "  â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: $total_files"
echo ""
print_info "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:"
echo "  â€¢ Ù…Ù„ÙØ§Øª Dart: $dart_files"
echo "  â€¢ Ù…Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰: $other_files"
echo ""
print_info "Ø£ÙˆØ§Ù…Ø± Ù…ÙÙŠØ¯Ø©:"
echo "  â€¢ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù: less $OUTPUT_FILE"
echo "  â€¢ Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„Ù: grep -n 'ÙƒÙ„Ù…Ø©' $OUTPUT_FILE"
echo "  â€¢ Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù: cp $OUTPUT_FILE ~/storage/downloads/"
echo "  â€¢ Ù„Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: du -sh ."
echo ""
print_info "Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:"
echo "  â€¢ Ù…Ù„ÙØ§Øª Dart: find . -name '*.dart' | wc -l"
echo "  â€¢ Ù…Ù„ÙØ§Øª YAML: find . -name '*.yaml' -o -name '*.yml' | wc -l"
echo ""
echo "=========================================="

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: opl.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 855: flutter_trading_app_codes_20260118_200203.txt
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/flutter_trading_app_codes_20260118_200203.txt
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Text
Ø§Ù„Ø­Ø¬Ù…: 293.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 9
================================================================================

# ==========================================
# Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter
# Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: flutter_trading_app
# ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬: Sun Jan 18 08:02:04 PM UTC 2026
# Ø§Ù„Ù…Ø³Ø§Ø±: /root/falto
# ==========================================

# Ø§Ù„ÙÙ‡Ø±Ø³:


================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: flutter_trading_app_codes_20260118_200203.txt
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 856: oppp.py
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/oppp.py
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Python
Ø§Ù„Ø­Ø¬Ù…: 18.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 453
================================================================================

#!/data/data/com.termux/files/usr/bin/python3
# -*- coding: utf-8 -*-

"""
Ø³ÙƒØ±Ø¨Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter
Ø¥ØµØ¯Ø§Ø±: 1.0
ØªØ§Ø±ÙŠØ®: 2024
"""

import os
import sys
import datetime
import pathlib
import mimetypes
from typing import List, Dict, Set

class FlutterCodeExtractor:
    def __init__(self, project_path: str = "."):
        """ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯"""
        self.project_path = os.path.abspath(project_path)
        self.project_name = os.path.basename(self.project_path)
        self.timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
        self.output_file = f"flutter_codes_{self.timestamp}.txt"
        
        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù…Ø´Ø±ÙˆØ¹ Flutter
        self.code_extensions = {
            '.dart': 'Dart',
            '.yaml': 'YAML',
            '.yml': 'YAML',
            '.json': 'JSON',
            '.xml': 'XML',
            '.html': 'HTML',
            '.css': 'CSS',
            '.md': 'Markdown',
            '.txt': 'Text',
            '.gradle': 'Gradle',
            '.java': 'Java',
            '.kt': 'Kotlin',
            '.swift': 'Swift',
            '.m': 'Objective-C',
            '.h': 'Header',
            '.cpp': 'C++',
            '.c': 'C',
            '.plist': 'Plist',
            '.sh': 'Shell',
            '.bash': 'Bash',
            '.py': 'Python',
            '.js': 'JavaScript',
            '.ts': 'TypeScript',
            '.jsx': 'React JS',
            '.tsx': 'React TS',
            '.sql': 'SQL',
            '.php': 'PHP',
            '.rb': 'Ruby',
            '.go': 'Go',
            '.rs': 'Rust',
            '.lua': 'Lua',
            '.ini': 'INI',
            '.conf': 'Config',
            '.cfg': 'Config',
            '.toml': 'TOML',
            '.properties': 'Properties',
        }
        
        # Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ø§
        self.exclude_dirs = {
            'build', '.dart_tool', '.git', '.github', '.vscode', '.idea',
            '__pycache__', 'node_modules', '.gradle', '.android', '.ios',
            'Pods', 'DerivedData', '.pub-cache', 'target', 'dist', 'out',
            'tmp', 'temp', 'logs', 'coverage', '.flutter-plugins',
            '.flutter-plugins-dependencies'
        }
        
        # Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡Ø§
        self.exclude_files = {
            '*.apk', '*.ipa', '*.app', '*.jar', '*.class', '*.so', '*.o',
            '*.a', '*.pyc', '*.pyo', '*.pyd', '*.dll', '*.exe', '*.bin',
            '*.dat', '*.db', '*.sqlite', '*.jpg', '*.jpeg', '*.png',
            '*.gif', '*.bmp', '*.ico', '*.pdf', '*.doc', '*.docx',
            '*.xls', '*.xlsx', '*.ppt', '*.pptx', '*.zip', '*.tar',
            '*.gz', '*.rar', '*.7z', '*.mp3', '*.mp4', '*.avi', '*.mov',
            '*.wmv', '*.flv', '*.mkv', '.DS_Store', 'Thumbs.db',
            'flutter_trading_app.iml'
        }
        
        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        self.stats = {
            'total_files': 0,
            'total_lines': 0,
            'total_size': 0,
            'files_by_type': {},
            'files_by_folder': {}
        }
        
        # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©
        self.priority_folders = [
            'lib',
            'src',
            'test',
            'integration_test',
            'android/app/src',
            'ios/Runner',
            'macos/Runner',
            'windows/runner',
            'scripts',
            'assets',
            'docs',
            'web',
            'linux',
        ]
    
    def should_exclude(self, path: str) -> bool:
        """ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯Ù‡"""
        # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¬Ù„Ø¯ Ù…Ø³ØªØ¨Ø¹Ø¯
        for part in path.split(os.sep):
            if part in self.exclude_dirs:
                return True
        
        # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ù…Ø· Ù…Ø¹ÙŠÙ†
        filename = os.path.basename(path)
        for pattern in self.exclude_files:
            if pattern.startswith('*.'):
                ext = pattern[1:]
                if filename.endswith(ext):
                    return True
            elif filename == pattern:
                return True
        
        return False
    
    def get_file_type(self, filename: str) -> str:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯"""
        ext = pathlib.Path(filename).suffix.lower()
        return self.code_extensions.get(ext, 'Unknown')
    
    def format_size(self, size_bytes: int) -> str:
        """ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ Ù…Ù‚Ø±ÙˆØ¡"""
        for unit in ['B', 'KB', 'MB', 'GB']:
            if size_bytes < 1024.0:
                return f"{size_bytes:.1f} {unit}"
            size_bytes /= 1024.0
        return f"{size_bytes:.1f} TB"
    
    def read_file_safely(self, filepath: str) -> str:
        """Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
        try:
            with open(filepath, 'r', encoding='utf-8') as f:
                return f.read()
        except UnicodeDecodeError:
            try:
                with open(filepath, 'r', encoding='latin-1') as f:
                    return f.read()
            except:
                return "# [Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù†ØµÙŠ]\n"
        except Exception as e:
            return f"# [Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: {str(e)}]\n"
    
    def scan_project(self) -> List[Dict]:
        """Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ¬Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª"""
        print("ğŸ” Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ù…Ø´Ø±ÙˆØ¹ Flutter...")
        
        all_files = []
        
        for root, dirs, files in os.walk(self.project_path):
            # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨Ø­Ø«
            dirs[:] = [d for d in dirs if d not in self.exclude_dirs]
            
            for file in files:
                filepath = os.path.join(root, file)
                rel_path = os.path.relpath(filepath, self.project_path)
                
                # Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø±ØºÙˆØ¨Ø©
                if self.should_exclude(filepath):
                    continue
                
                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù
                ext = pathlib.Path(file).suffix.lower()
                
                # ØªØ¶Ù…ÙŠÙ† ÙÙ‚Ø· Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
                if ext in self.code_extensions:
                    try:
                        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
                        stat = os.stat(filepath)
                        file_size = stat.st_size
                        file_type = self.get_file_type(file)
                        
                        file_info = {
                            'path': filepath,
                            'rel_path': rel_path,
                            'name': file,
                            'size': file_size,
                            'type': file_type,
                            'extension': ext,
                            'folder': os.path.dirname(rel_path),
                            'lines': 0,
                            'content': None
                        }
                        
                        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±
                        try:
                            with open(filepath, 'r', encoding='utf-8') as f:
                                file_info['lines'] = sum(1 for _ in f)
                        except:
                            try:
                                with open(filepath, 'r', encoding='latin-1') as f:
                                    file_info['lines'] = sum(1 for _ in f)
                            except:
                                file_info['lines'] = 0
                        
                        all_files.append(file_info)
                        
                        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                        self.stats['total_files'] += 1
                        self.stats['total_lines'] += file_info['lines']
                        self.stats['total_size'] += file_size
                        
                        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                        file_type_name = self.code_extensions.get(ext, 'Other')
                        self.stats['files_by_type'][file_type_name] = \
                            self.stats['files_by_type'].get(file_type_name, 0) + 1
                        
                        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù„Ø¯
                        folder = os.path.dirname(rel_path)
                        if folder:
                            self.stats['files_by_folder'][folder] = \
                                self.stats['files_by_folder'].get(folder, 0) + 1
                        
                    except Exception as e:
                        print(f"âš ï¸  Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© {rel_path}: {e}")
        
        # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
        all_files.sort(key=lambda x: self.get_file_priority(x['rel_path']))
        
        return all_files
    
    def get_file_priority(self, rel_path: str) -> int:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ±ØªÙŠØ¨"""
        # Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
        for i, folder in enumerate(self.priority_folders):
            if rel_path.startswith(folder):
                return i
        
        # Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© Ù„Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¬Ø°Ø±
        if os.path.dirname(rel_path) == '':
            return 100
        
        # Ø£ÙˆÙ„ÙˆÙŠØ© Ù…ØªÙˆØ³Ø·Ø© Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
        return 200
    
    def extract_files_content(self, files: List[Dict]) -> None:
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ­ÙØ¸Ù‡Ø§"""
        print(f"ğŸ“ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ {len(files)} Ù…Ù„Ù...")
        
        with open(self.output_file, 'w', encoding='utf-8') as outfile:
            # ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
            outfile.write("=" * 80 + "\n")
            outfile.write("Ù…Ø³ØªØ®Ø±Ø¬ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter\n")
            outfile.write("=" * 80 + "\n\n")
            
            outfile.write(f"ğŸ“‹ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: {self.project_name}\n")
            outfile.write(f"ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: {self.project_path}\n")
            outfile.write(f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            outfile.write(f"ğŸ”¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: {self.stats['total_files']}\n")
            outfile.write(f"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·Ø±: {self.stats['total_lines']:,}\n")
            outfile.write(f"ğŸ’¾ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {self.format_size(self.stats['total_size'])}\n\n")
            
            # ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙÙ‡Ø±Ø³
            outfile.write("=" * 80 + "\n")
            outfile.write("ğŸ“‘ Ø§Ù„ÙÙ‡Ø±Ø³\n")
            outfile.write("=" * 80 + "\n\n")
            
            current_folder = None
            file_counter = 1
            
            for file_info in files:
                if file_info['folder'] != current_folder:
                    current_folder = file_info['folder']
                    folder_display = current_folder if current_folder else "[Ø§Ù„Ø¬Ø°Ø±]"
                    outfile.write(f"\nğŸ“‚ Ù…Ø¬Ù„Ø¯: {folder_display}\n")
                    outfile.write("-" * 60 + "\n")
                
                outfile.write(f"{file_counter:3d}. ğŸ“„ {file_info['rel_path']} ")
                outfile.write(f"({self.format_size(file_info['size'])}, ")
                outfile.write(f"{file_info['lines']:,} Ø³Ø·Ø±)\n")
                file_counter += 1
            
            # ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª
            outfile.write("\n" + "=" * 80 + "\n")
            outfile.write("ğŸ“„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª\n")
            outfile.write("=" * 80 + "\n\n")
            
            file_counter = 1
            for file_info in files:
                outfile.write("=" * 80 + "\n")
                outfile.write(f"Ø§Ù„Ù…Ù„Ù {file_counter}: {file_info['rel_path']}\n")
                outfile.write("-" * 80 + "\n")
                outfile.write(f"Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: {file_info['path']}\n")
                outfile.write(f"Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: {file_info['type']}\n")
                outfile.write(f"Ø§Ù„Ø­Ø¬Ù…: {self.format_size(file_info['size'])}\n")
                outfile.write(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: {file_info['lines']:,}\n")
                outfile.write("=" * 80 + "\n\n")
                
                # Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
                content = self.read_file_safely(file_info['path'])
                outfile.write(content)
                
                # Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø·Ø± ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                if content and not content.endswith('\n'):
                    outfile.write('\n')
                
                outfile.write("\n" + "=" * 80 + "\n")
                outfile.write(f"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: {file_info['rel_path']}\n")
                outfile.write("=" * 80 + "\n\n\n")
                
                file_counter += 1
                print(f"  âœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø©: {file_info['rel_path']}")
            
            # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            outfile.write("=" * 80 + "\n")
            outfile.write("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©\n")
            outfile.write("=" * 80 + "\n\n")
            
            outfile.write("ğŸ“ˆ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:\n")
            for file_type, count in sorted(self.stats['files_by_type'].items()):
                outfile.write(f"  â€¢ {file_type}: {count} Ù…Ù„Ù\n")
            
            outfile.write("\nğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù„Ø¯ (Ø£Ø¹Ù„Ù‰ 10):\n")
            sorted_folders = sorted(
                self.stats['files_by_folder'].items(),
                key=lambda x: x[1],
                reverse=True
            )[:10]
            
            for folder, count in sorted_folders:
                outfile.write(f"  â€¢ {folder}: {count} Ù…Ù„Ù\n")
            
            outfile.write("\n" + "=" * 80 + "\n")
            outfile.write("ğŸ‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ù†Ø¬Ø§Ø­!\n")
            outfile.write("=" * 80 + "\n")
    
    def print_summary(self) -> None:
        """Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"""
        print("\n" + "=" * 60)
        print("ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬")
        print("=" * 60)
        
        print(f"ğŸ“‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: {self.project_name}")
        print(f"ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø±: {self.project_path}")
        print(f"ğŸ’¾ Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬: {self.output_file}")
        print(f"ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: {self.format_size(os.path.getsize(self.output_file))}")
        print(f"ğŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©: {self.stats['total_files']:,}")
        print(f"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·Ø±: {self.stats['total_lines']:,}")
        
        print("\nğŸ“ˆ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:")
        for file_type, count in sorted(self.stats['files_by_type'].items()):
            print(f"  â€¢ {file_type}: {count} Ù…Ù„Ù")
        
        print("\nğŸ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯:")
        extensions_count = {}
        for file_type, count in self.stats['files_by_type'].items():
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
            for ext, name in self.code_extensions.items():
                if name == file_type:
                    extensions_count[ext] = count
                    break
        
        for ext, count in sorted(extensions_count.items()):
            print(f"  â€¢ {ext}: {count} Ù…Ù„Ù")
        
        print("\n" + "=" * 60)
        print("ğŸš€ Ø£ÙˆØ§Ù…Ø± Ù…ÙÙŠØ¯Ø©:")
        print("=" * 60)
        print(f"  ğŸ“– Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù: less {self.output_file}")
        print(f"  ğŸ” Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„Ù: grep -n 'ÙƒÙ„Ù…Ø©' {self.output_file}")
        print(f"  ğŸ“Š Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: wc -l {self.output_file}")
        print(f"  ğŸ“‹ Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù: cp {self.output_file} ~/storage/downloads/")
        print(f"  ğŸ“ Ù„Ø¹Ø±Ø¶ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: find . -name '*.dart' | wc -l")
        print("=" * 60)
    
    def run(self) -> bool:
        """ØªØ´ØºÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬"""
        print("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙƒÙˆØ§Ø¯ Flutter...")
        print("=" * 60)
        
        try:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            if not os.path.exists(self.project_path):
                print(f"âŒ Ø§Ù„Ù…Ø³Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: {self.project_path}")
                return False
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ pubspec.yaml (Ù…Ø´Ø±ÙˆØ¹ Flutter)
            pubspec_path = os.path.join(self.project_path, 'pubspec.yaml')
            if not os.path.exists(pubspec_path):
                print("âš ï¸  ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ pubspec.yaml")
                print("Ù‡Ù„ Ø£Ù†Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ Ù…Ø´Ø±ÙˆØ¹ Flutter Ø§Ù„ØµØ­ÙŠØ­ØŸ")
                response = input("Ø§Ù„Ù…ØªØ§Ø¨Ø±Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ (y/n): ")
                if response.lower() != 'y':
                    return False
            
            # Ù…Ø³Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
            files = self.scan_project()
            
            if not files:
                print("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡Ø§")
                return False
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            self.extract_files_content(files)
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
            self.print_summary()
            
            return True
            
        except KeyboardInterrupt:
            print("\n\nâ¹ï¸  ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            return False
        except Exception as e:
            print(f"\nâŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
            import traceback
            traceback.print_exc()
            return False

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    # Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
    print("\n" + "=" * 60)
    print("ğŸ“± Ù…Ø³ØªØ®Ø±Ø¬ Ø£ÙƒÙˆØ§Ø¯ Flutter - Ø¥ØµØ¯Ø§Ø± Python")
    print("=" * 60)
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    if len(sys.argv) > 1:
        project_path = sys.argv[1]
    else:
        project_path = input("Ø£Ø¯Ø®Ù„ Ù…Ø³Ø§Ø± Ù…Ø´Ø±ÙˆØ¹ Flutter (Ø§Ø¶ØºØ· Enter Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ): ").strip()
        if not project_path:
            project_path = "."
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ ÙˆØªØ´ØºÙŠÙ„Ù‡
    extractor = FlutterCodeExtractor(project_path)
    success = extractor.run()
    
    if success:
        print("\nâœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!")
        sys.exit(0)
    else:
        print("\nâŒ ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬")
        sys.exit(1)

if __name__ == "__main__":
    main()

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: oppp.py
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 857: android/key.properties
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/key.properties
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Properties
Ø§Ù„Ø­Ø¬Ù…: 118.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 4
================================================================================

storePassword=YOUR_PASSWORD
keyPassword=YOUR_KEY_PASSWORD
keyAlias=tradingappkey
storeFile=/full/path/to/keystore.jks

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/key.properties
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 858: android/local.properties
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/local.properties
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Properties
Ø§Ù„Ø­Ø¬Ù…: 125.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

sdk.dir=/root/android-sdk
flutter.sdk=/root/flutter
flutter.buildMode=release
flutter.versionName=1.0.0
flutter.versionCode=1

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/local.properties
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 859: android/gradle.properties
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/gradle.properties
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Properties
Ø§Ù„Ø­Ø¬Ù…: 138.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 2
================================================================================

org.gradle.jvmargs=-Xmx8G -XX:MaxMetaspaceSize=4G -XX:ReservedCodeCacheSize=512m -XX:+HeapDumpOnOutOfMemoryError
android.useAndroidX=true

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/gradle.properties
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 860: android/gradle/wrapper/gradle-wrapper.properties
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/android/gradle/wrapper/gradle-wrapper.properties
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Properties
Ø§Ù„Ø­Ø¬Ù…: 200.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 5
================================================================================

distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-all.zip

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: android/gradle/wrapper/gradle-wrapper.properties
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 861: batch_scripts_fixed/batch_002.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/batch_scripts_fixed/batch_002.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 602.3 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 22,289
================================================================================

#!/bin/bash
# Batch 2 of 2
# Commands: 873 (Flutter commands filtered out)
set -e  # Stop on error

echo "ğŸš€ Batch 2/2 - 873 commands (No Flutter)"
date

# Create files (Flutter-free)
cat > pubspec.yaml << 'EOF'
name: flutter_trading_app
description: ØªØ·Ø¨ÙŠÙ‚ ØªØ¯Ø§ÙˆÙ„ Ù…Ø§Ù„ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¨Ù†ÙŠ Ø¨Ù€Ù€ Flutter + Dart
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: ">=2.20.0 <3.0.0"

dependencies:
  flutter:
    sdk: flutter

  # State Management
  flutter_bloc: ^8.1.0
  equatable: ^2.0.5

  # HTTP & WebSocket
  dio: ^5.0.0
  web_socket_channel: ^2.2.0

  # Local Storage
  hive: ^2.2.3
  hive_flutter: ^1.1.0

  # JSON serialization
  json_annotation: ^4.8.0

  # Charts
  fl_chart: ^0.60.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  build_runner: ^2.4.4
  json_serializable: ^6.6.1
EOF
cat > lib/features/market/data/models/candle_model.dart << 'EOF'
import 'package:hive/hive.dart';
import 'package:json_annotation/json_annotation.dart';

part 'candle_model.g.dart';

@HiveType(typeId: 1)
@JsonSerializable()
class CandleModel {
  @HiveField(0)
  final DateTime time;

  @HiveField(1)
  final double open;
  
  @HiveField(2)
  final double high;
  
  @HiveField(3)
  final double low;
  
  @HiveField(4)
  final double close;
  
  @HiveField(5)
  final int volume;

  CandleModel({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });

  factory CandleModel.fromJson(Map<String, dynamic> json) => _$CandleModelFromJson(json);
  Map<String, dynamic> toJson() => _$CandleModelToJson(this);
}
EOF
cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'features/market/data/models/candle_model.dart';
import 'app.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Hive.initFlutter();
  Hive.registerAdapter(CandleModelAdapter());

  await Hive.openBox<CandleModel>('candles');

  runApp(MyApp());
}
EOF
cat > lib/app.dart << 'EOF'
import 'package:flutter/material.dart';
import 'features/market/presentation/pages/home_page.dart';

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Trading App',
      debugShowCheckedModeBanner: false,
      home: HomePage(),
    );
  }
}
EOF
cat > lib/features/market/presentation/pages/home_page.dart << 'EOF'
import 'package:flutter/material.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Trading App")),
      body: Center(child: Text("Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¯Ø§ÙˆÙ„")),
    );
  }
}
EOF
cat > lib/features/market/domain/entities/candle.dart << 'EOF'
class CandleEntity {
  final DateTime time;
  final double open;
  final double high;
  final double low;
  final double close;
  final int volume;

  CandleEntity({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });
}
EOF
cat > lib/features/market/domain/entities/tick.dart << 'EOF'
class TickEntity {
  final DateTime time;
  final double bid;
  final double ask;

  TickEntity({
    required this.time,
    required this.bid,
    required this.ask,
  });
}
EOF
cat > lib/features/market/domain/repositories/market_repository.dart << 'EOF'
import '../entities/candle.dart';
import '../entities/tick.dart';

abstract class MarketRepository {
  /// REST: Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©
  Future<List<CandleEntity>> fetchHistoricalCandles(
      String instrument, String granularity, int count);

  /// REST: Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù…Ù† Ø§Ù„Ù€ OANDA
  Future<List<String>> fetchAvailableInstruments();

  /// WebSocket: Ø¨Ø« Live Ticks
  Stream<TickEntity> streamTicks(String instrument);

  /// REST: Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨ OANDA
  Future<Map<String, dynamic>> fetchAccountDetails();

  /// Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ØªØµØ§Ù„ OANDA (Token + Account ID)
  Future<void> saveOandaCredentials({
    required String token,
    required String accountId,
  });

  /// Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª OANDA Ø§Ù„Ù…Ø®Ø²Ù†Ø©
  Future<Map<String, String>> getOandaCredentials();
}
EOF
cat > lib/features/market/domain/usecases/get_historical_candles.dart << 'EOF'
import '../entities/candle.dart';
import '../repositories/market_repository.dart';

class GetHistoricalCandles {
  final MarketRepository repository;

  GetHistoricalCandles(this.repository);

  Future<List<CandleEntity>> call({
    required String instrument,
    required String granularity,
    required int count,
  }) async {
    return await repository.fetchHistoricalCandles(
      instrument, granularity, count);
  }
}
EOF
cat > lib/features/market/domain/usecases/get_available_instruments.dart << 'EOF'
import '../repositories/market_repository.dart';

class GetAvailableInstruments {
  final MarketRepository repository;

  GetAvailableInstruments(this.repository);

  Future<List<String>> call() async {
    return await repository.fetchAvailableInstruments();
  }
}
EOF
cat > lib/features/market/domain/usecases/stream_ticks.dart << 'EOF'
import '../entities/tick.dart';
import '../repositories/market_repository.dart';

class StreamTicks {
  final MarketRepository repository;

  StreamTicks(this.repository);

  Stream<TickEntity> call(String instrument) {
    return repository.streamTicks(instrument);
  }
}
EOF
cat > lib/features/market/domain/usecases/save_oanda_credentials.dart << 'EOF'
import '../repositories/market_repository.dart';

class SaveOandaCredentials {
  final MarketRepository repository;

  SaveOandaCredentials(this.repository);

  Future<void> call({
    required String token,
    required String accountId,
  }) async {
    return repository.saveOandaCredentials(
      token: token,
      accountId: accountId,
    );
  }
}
EOF
cat > lib/features/market/domain/usecases/get_saved_credentials.dart << 'EOF'
import '../repositories/market_repository.dart';

class GetSavedCredentials {
  final MarketRepository repository;

  GetSavedCredentials(this.repository);

  Future<Map<String, String>> call() async {
    return await repository.getOandaCredentials();
  }
}
EOF
cat > lib/features/market/data/datasources/oanda_rest_client.dart << 'EOF'
import 'package:dio/dio.dart';

class OandaRestClient {
  Dio dio;

  OandaRestClient(String token) : dio = Dio(
    BaseOptions(
      baseUrl: "https://api-fxpractice.oanda.com/v3",
      headers: {
        "Authorization": "Bearer $token",
        "Content-Type": "application/json"
      }
    ),
  );

  Future<Response> getInstruments(String accountId) async {
    return dio.get("/accounts/$accountId/instruments");
  }

  Future<Response> getCandles({
    required String instrument,
    required String granularity,
    required int count,
  }) {
    return dio.get(
      "/instruments/$instrument/candles",
      queryParameters: {
        "granularity": granularity,
        "count": count,
        "price": "M",
      }
    );
  }
}
EOF
cat > lib/features/market/data/datasources/oanda_ws_client.dart << 'EOF'
import 'dart:convert';
import 'package:web_socket_channel/web_socket_channel.dart';

class OandaWebSocketClient {
  final WebSocketChannel _channel;

  OandaWebSocketClient._(this._channel);

  factory OandaWebSocketClient({
    required String token,
    required String accountId,
    required String instrument,
  }) {
    final streamEndpoint = Uri(
      scheme: "wss",
      host: "stream-fxpractice.oanda.com",
      path: "/v3/pricing/stream",
      queryParameters: {
        "instruments": instrument,
      },
    );

    final ws = WebSocketChannel.connect(
      streamEndpoint,
      headers: {
        "Authorization": "Bearer $token",
      },
    );

    return OandaWebSocketClient._(ws);
  }

  Stream<Map<String, dynamic>> get stream =>
      _channel.stream.map((event) => jsonDecode(event));

  void close() => _channel.sink.close();
}
EOF
cat > lib/features/market/data/models/candle_entity_mapper.dart << 'EOF'
import '../../domain/entities/candle.dart';
import 'candle_model.dart';

extension ToEntity on CandleModel {
  CandleEntity toEntity() {
    return CandleEntity(
      time: time,
      open: open,
      high: high,
      low: low,
      close: close,
      volume: volume,
    );
  }
}
EOF
cat > lib/features/market/data/models/tick_model.dart << 'EOF'
import '../../domain/entities/tick.dart';

class TickModel {
  final DateTime time;
  final double bid;
  final double ask;

  TickModel({
    required this.time,
    required this.bid,
    required this.ask,
  });

  factory TickModel.fromJson(Map<String, dynamic> json) {
    // OANDA stream sends "tick" messages with bid/ask
    final time = DateTime.parse(json["time"]);
    final bids = json["bids"];
    final asks = json["asks"];

    double bidPrice = double.parse(bids[0]["price"]);
    double askPrice = double.parse(asks[0]["price"]);

    return TickModel(
      time: time,
      bid: bidPrice,
      ask: askPrice,
    );
  }

  TickEntity toEntity() => TickEntity(
    time: time,
    bid: bid,
    ask: ask,
  );
}
EOF
cat > lib/features/market/data/datasources/local_storage.dart << 'EOF'
import 'package:hive/hive.dart';

class LocalStorage {
  final Box _box = Hive.box('settings');

  Future<void> saveOandaToken(String token) async {
    await _box.put('oanda_token', token);
  }

  Future<void> saveOandaAccountId(String id) async {
    await _box.put('oanda_account', id);
  }

  String? getOandaToken() => _box.get('oanda_token');

  String? getOandaAccountId() => _box.get('oanda_account');
}
EOF
cat > lib/features/market/data/repositories/market_repository_impl.dart << 'EOF'
import 'dart:async';

import '../../domain/entities/candle.dart';
import '../../domain/entities/tick.dart';
import '../../domain/repositories/market_repository.dart';

import '../datasources/oanda_rest_client.dart';
import '../datasources/oanda_ws_client.dart';
import '../datasources/local_storage.dart';
import '../models/candle_model.dart';
import '../models/candle_entity_mapper.dart';
import '../models/tick_model.dart';

class MarketRepositoryImpl implements MarketRepository {
  final LocalStorage localStorage;

  OandaRestClient? _restClient;
  OandaWebSocketClient? _wsClient;

  MarketRepositoryImpl({required this.localStorage});

  Future<void> _initClients() async {
    final token = localStorage.getOandaToken();
    final account = localStorage.getOandaAccountId();

    if (token == null || account == null) {
      throw Exception("OANDA credentials not found");
    }

    _restClient = OandaRestClient(token);
  }

  @override
  Future<void> saveOandaCredentials({required String token, required String accountId}) async {
    await localStorage.saveOandaToken(token);
    await localStorage.saveOandaAccountId(accountId);
  }

  @override
  Future<Map<String, String>> getOandaCredentials() async {
    final token = localStorage.getOandaToken();
    final account = localStorage.getOandaAccountId();
    if (token == null || account == null) throw Exception("Credentials missing");
    return {"token": token, "accountId": account};
  }

  @override
  Future<Map<String, dynamic>> fetchAccountDetails() async {
    await _initClients();
    final account = localStorage.getOandaAccountId()!;
    final response = await _restClient!.dio.get("/accounts/$account");
    return response.data;
  }

  @override
  Future<List<CandleEntity>> fetchHistoricalCandles(
      String instrument, String granularity, int count) async {
    await _initClients();
    final resp = await _restClient!.getCandles(
      instrument: instrument,
      granularity: granularity,
      count: count,
    );

    final List<CandleEntity> list = [];
    final data = resp.data["candles"] as List;

    for (var item in data) {
      if (item["complete"] == true) {
        final candle = CandleModel(
          time: DateTime.parse(item["time"]),
          open: double.parse(item["mid"]["o"]),
          high: double.parse(item["mid"]["h"]),
          low: double.parse(item["mid"]["l"]),
          close: double.parse(item["mid"]["c"]),
          volume: item["volume"],
        );
        list.add(candle.toEntity());
      }
    }
    return list;
  }

  @override
  Future<List<String>> fetchAvailableInstruments() async {
    await _initClients();
    final account = localStorage.getOandaAccountId()!;
    final resp = await _restClient!.getInstruments(account);

    final data = resp.data["instruments"] as List;
    return data.map((item) => item["name"].toString()).toList();
  }

  @override
  Stream<TickEntity> streamTicks(String instrument) {
    final token = localStorage.getOandaToken()!;
    final account = localStorage.getOandaAccountId()!;
    _wsClient = OandaWebSocketClient(
      token: token,
      accountId: account,
      instrument: instrument,
    );

    return _wsClient!.stream
      .where((json) => json.containsKey("bids") && json.containsKey("asks"))
      .map((json) {
        final model = TickModel.fromJson(json);
        return model.toEntity();
      });
  }
}
EOF
cat > lib/features/market/presentation/pages/oanda_settings_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../domain/usecases/save_oanda_credentials.dart';
import '../../domain/usecases/get_available_instruments.dart';
import '../../domain/usecases/get_saved_credentials.dart';
import '../../domain/repositories/market_repository.dart';
import '../widgets/instrument_list_widget.dart';

class OandaSettingsPage extends StatefulWidget {
  final MarketRepository repository;

  OandaSettingsPage({required this.repository});

  @override
  _OandaSettingsPageState createState() => _OandaSettingsPageState();
}

class _OandaSettingsPageState extends State<OandaSettingsPage> {
  final _tokenController = TextEditingController();
  final _accountIdController = TextEditingController();

  bool _isLoading = false;
  List<String> _instruments = [];

  @override
  void initState() {
    super.initState();
    _loadSavedCredentials();
  }

  void _loadSavedCredentials() async {
    try {
      final credentials = await GetSavedCredentials(widget.repository)();
      _tokenController.text = credentials['token']!;
      _accountIdController.text = credentials['accountId']!;
      _fetchInstruments(); // Ø¬Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    } catch (_) {}
  }

  void _saveCredentials() async {
    setState(() => _isLoading = true);
    await SaveOandaCredentials(widget.repository)(
      token: _tokenController.text.trim(),
      accountId: _accountIdController.text.trim(),
    );
    await _fetchInstruments();
    setState(() => _isLoading = false);
  }

  void _fetchInstruments() async {
    setState(() => _isLoading = true);
    final list = await GetAvailableInstruments(widget.repository)();
    setState(() => _instruments = list);
    setState(() => _isLoading = false);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OANDA")),
      body: Padding(
        padding: const EdgeInsets.all(12.0),
        child: Column(
          children: [
            TextField(
              controller: _tokenController,
              decoration: InputDecoration(
                labelText: "API Token",
                border: OutlineInputBorder(),
              ),
            ),
            SizedBox(height: 8),
            TextField(
              controller: _accountIdController,
              decoration: InputDecoration(
                labelText: "Account ID",
                border: OutlineInputBorder(),
              ),
            ),
            SizedBox(height: 12),
            ElevatedButton(
              onPressed: _saveCredentials,
              child: Text("Ø­ÙØ¸ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚"),
            ),
            SizedBox(height: 16),
            if (_isLoading) CircularProgressIndicator(),
            if (!_isLoading && _instruments.isNotEmpty)
              Expanded(child: InstrumentListWidget(instruments: _instruments)),
          ],
        ),
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/instrument_list_widget.dart << 'EOF'
import 'package:flutter/material.dart';

class InstrumentListWidget extends StatelessWidget {
  final List<String> instruments;

  InstrumentListWidget({required this.instruments});

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: instruments.length,
      itemBuilder: (context, index) {
        final symbol = instruments[index];
        return ListTile(
          title: Text(symbol),
          trailing: Icon(Icons.show_chart),
        );
      },
    );
  }
}
EOF
cat > lib/features/market/presentation/pages/home_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../pages/oanda_settings_page.dart';
import '../../data/repositories/market_repository_impl.dart';
import '../../data/datasources/local_storage.dart';
import '../../domain/repositories/market_repository.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {

    final LocalStorage localStorage = LocalStorage();
    final MarketRepository repository =
        MarketRepositoryImpl(localStorage: localStorage);

    return Scaffold(
      appBar: AppBar(title: Text("Trading App")),
      body: Center(
        child: ElevatedButton(
          child: Text("Ø¥Ø¹Ø¯Ø§Ø¯ OANDA"),
          onPressed: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (_) => OandaSettingsPage(repository: repository),
              ),
            );
          },
        ),
      ),
    );
  }
}
EOF
cat > lib/app.dart << 'EOF'
import 'package:flutter/material.dart';
import 'features/market/presentation/pages/home_page.dart';

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Trading App',
      debugShowCheckedModeBanner: false,
      home: HomePage(),
    );
  }
}
EOF
cat > lib/features/market/presentation/pages/market_chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';
import '../../domain/entities/candle.dart';
import '../../domain/entities/tick.dart';
import '../../domain/usecases/get_historical_candles.dart';
import '../../domain/usecases/stream_ticks.dart';
import '../../domain/repositories/market_repository.dart';

class MarketChartPage extends StatefulWidget {
  final MarketRepository repository;
  final String instrument;

  MarketChartPage({
    required this.repository,
    required this.instrument,
  });

  @override
  _MarketChartPageState createState() => _MarketChartPageState();
}

class _MarketChartPageState extends State<MarketChartPage> {
  bool _isLoading = true;
  List<CandleEntity> _candles = [];
  Stream<TickEntity>? _tickStream;

  @override
  void initState() {
    super.initState();
    _fetchHistorical();
    _initLiveStream();
  }

  void _fetchHistorical() async {
    try {
      final list = await GetHistoricalCandles(widget.repository)(
        instrument: widget.instrument,
        granularity: "M1",
        count: 200,
      );
      setState(() {
        _candles = list;
        _isLoading = false;
      });
    } catch (ex) {
      print("Error fetching candles: $ex");
      setState(() => _isLoading = false);
    }
  }

  void _initLiveStream() {
    try {
      _tickStream = StreamTicks(widget.repository)(widget.instrument);
      _tickStream!.listen((tick) {
        setState(() {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± â€¦
          // (Ø³Ù†ÙƒÙ…Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ø¨Ø¹Ø¯ Ø±Ø³Ù… Ø§Ù„Ø´Ø§Ø±Øª)
        });
      });
    } catch (ex) {
      print("WebSocket error: $ex");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Chart â€” ${widget.instrument}"),
      ),
      body: _isLoading
          ? Center(child: CircularProgressIndicator())
          : Padding(
              padding: const EdgeInsets.all(12.0),
              child: Column(
                children: [
                  Expanded(child: _buildCandlestickChart()),
                ],
              ),
            ),
    );
  }

  Widget _buildCandlestickChart() {

    // Ø£Ø³Ù„ÙˆØ¨ Ø¨Ø³ÙŠØ· Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª CandleEntity Ø¥Ù„Ù‰ FlSpot
    List<CandleStick> _data = _candles.map((c) {
      return CandleStick(
        x: c.time.millisecondsSinceEpoch.toDouble(),
        open: c.open,
        high: c.high,
        low: c.low,
        close: c.close,
      );
    }).toList();

    return CandleStickChart(
      data: _data,
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/candlestick_chart.dart << 'EOF'
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';

class CandleStick {
  final double x, open, high, low, close;
  CandleStick({
    required this.x,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });
}

class CandleStickChart extends StatelessWidget {
  final List<CandleStick> data;

  CandleStickChart({required this.data});

  @override
  Widget build(BuildContext context) {
    return BarChart(
      BarChartData(
        barGroups: data.map((c) {
          return BarChartGroupData(x: c.x.toInt(), barRods: [
            BarChartRodData(
              toY: c.high,
              fromY: c.low,
              color: c.close >= c.open ? Colors.green : Colors.red,
              width: 5,
            ),
          ]);
        }).toList(),
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/instrument_list_widget.dart << 'EOF'
import 'package:flutter/material.dart';
import '../pages/market_chart_page.dart';
import '../../data/repositories/market_repository_impl.dart';
import '../../data/datasources/local_storage.dart';

class InstrumentListWidget extends StatelessWidget {
  final List<String> instruments;

  InstrumentListWidget({required this.instruments});

  @override
  Widget build(BuildContext context) {

    final LocalStorage localStorage = LocalStorage();
    final repository = MarketRepositoryImpl(localStorage: localStorage);

    return ListView.builder(
      itemCount: instruments.length,
      itemBuilder: (ctx, i) {
        final symbol = instruments[i];
        return ListTile(
          title: Text(symbol),
          trailing: Icon(Icons.show_chart),
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (_) => MarketChartPage(
                  repository: repository,
                  instrument: symbol,
                ),
              ),
            );
          },
        );
      },
    );
  }
}
EOF
cat > lib/features/market/domain/indicators/ema_calculator.dart << 'EOF'
import '../../domain/entities/candle.dart';

class EmaResult {
  final List<double> values;
  final int period;

  EmaResult({required this.values, required this.period});
}

class EmaCalculator {
  /// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ EMA
  /// data = Ù‚ÙŠÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ
  static EmaResult calculate({
    required List<CandleEntity> data,
    required int period,
  }) {
    final List<double> ema = [];

    double multiplier = 2 / (period + 1);
    double prevEma = data.first.close;

    for (int i = 0; i < data.length; i++) {
      final price = data[i].close;
      if (i == 0) {
        // Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø© EMA = Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø£ÙˆÙ„
        prevEma = price;
      } else {
        prevEma = ((price - prevEma) * multiplier) + prevEma;
      }
      ema.add(prevEma);
    }

    return EmaResult(values: ema, period: period);
  }
}
EOF
cat > lib/features/market/domain/indicators/stochastic_calculator.dart << 'EOF'
import '../../domain/entities/candle.dart';
import 'dart:math';

class StochasticResult {
  final List<double> kValues;
  final List<double> dValues;
  final int period;
  final int smoothK;
  final int smoothD;

  StochasticResult({
    required this.kValues,
    required this.dValues,
    required this.period,
    required this.smoothK,
    required this.smoothD,
  });
}

class StochasticCalculator {
  static StochasticResult calculate({
    required List<CandleEntity> data,
    required int period,
    required int smoothK,
    required int smoothD,
  }) {
    List<double> k = [];
    List<double> d = [];

    for (int i = 0; i < data.length; i++) {
      if (i < period) {
        k.add(0);
        d.add(0);
        continue;
      }

      double highestHigh = data
          .sublist(i - period + 1, i + 1)
          .map((c) => c.high)
          .reduce(max);

      double lowestLow = data
          .sublist(i - period + 1, i + 1)
          .map((c) => c.low)
          .reduce(min);

      double currentClose = data[i].close;

      double rawK = ((currentClose - lowestLow) / (highestHigh - lowestLow)) *
          100;

      k.add(rawK);

      if (i >= period + smoothK - 1) {
        double avgK = k.sublist(i - smoothK + 1, i + 1).reduce((a, b) => a + b) /
            smoothK;
        if (d.length >= smoothD) {
          double avgD =
              d.sublist(i - smoothD + 1, i + 1).reduce((a, b) => a + b) /
                  smoothD;
          d.add(avgD);
        } else {
          d.add(avgK);
        }
      } else {
        d.add(0);
      }
    }

    return StochasticResult(
      kValues: k,
      dValues: d,
      period: period,
      smoothK: smoothK,
      smoothD: smoothD,
    );
  }
}
EOF
cat > lib/features/market/presentation/pages/market_chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';
import 'dart:math';

import '../../domain/entities/candle.dart';
import '../../domain/entities/tick.dart';
import '../../domain/usecases/get_historical_candles.dart';
import '../../domain/usecases/stream_ticks.dart';
import '../../domain/repositories/market_repository.dart';
import '../../domain/indicators/ema_calculator.dart';
import '../../domain/indicators/stochastic_calculator.dart';

class MarketChartPage extends StatefulWidget {
  final MarketRepository repository;
  final String instrument;

  MarketChartPage({
    required this.repository,
    required this.instrument,
  });

  @override
  _MarketChartPageState createState() => _MarketChartPageState();
}

class _MarketChartPageState extends State<MarketChartPage> {
  bool _isLoading = true;
  List<CandleEntity> _candles = [];

  List<double> _ema50 = [];
  List<double> _ema200 = [];

  List<double> _stochK = [];
  List<double> _stochD = [];

  Stream<TickEntity>? _tickStream;

  @override
  void initState() {
    super.initState();
    _fetchHistorical();
  }

  void _fetchHistorical() async {
    try {
      final list = await GetHistoricalCandles(widget.repository)(
        instrument: widget.instrument,
        granularity: "M1",
        count: 500,
      );

      setState(() {
        _candles = list;
      });

      _calculateIndicators();

      _initLiveStream();

      setState(() => _isLoading = false);
    } catch (e) {
      print("Error fetch historical: $e");
      setState(() => _isLoading = false);
    }
  }

  void _calculateIndicators() {

    final ema50Result = EmaCalculator.calculate(
        data: _candles, period: 50);
    final ema200Result = EmaCalculator.calculate(
        data: _candles, period: 200);

    setState(() {
      _ema50 = ema50Result.values;
      _ema200 = ema200Result.values;
    });

    final stoch = StochasticCalculator.calculate(
      data: _candles,
      period: 14,
      smoothK: 3,
      smoothD: 3,
    );

    setState(() {
      _stochK = stoch.kValues;
      _stochD = stoch.dValues;
    });
  }

  void _initLiveStream() {
    _tickStream = StreamTicks(widget.repository)(widget.instrument);

    _tickStream!.listen((tick) {
      setState(() {

        final last = _candles.isNotEmpty ? _candles.last : null;
        if (last != null &&
            DateTime.now().difference(last.time).inMinutes == 0) {

          final updated = CandleEntity(
            time: last.time,
            open: last.open,
            high: max(last.high, tick.bid),
            low: min(last.low, tick.bid),
            close: tick.bid,
            volume: last.volume + 1,
          );

          _candles[_candles.length - 1] = updated;

        } else {
          _candles.add(
            CandleEntity(
              time: DateTime.now(),
              open: tick.bid,
              high: tick.bid,
              low: tick.bid,
              close: tick.bid,
              volume: 1,
            ),
          );
        }

        _calculateIndicators();
      });
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Chart â€” ${widget.instrument}"),
      ),
      body: _isLoading
          ? Center(child: CircularProgressIndicator())
          : Column(
              children: [
                Expanded(child: _buildIndicatorChart()),
              ],
            ),
    );
  }

  Widget _buildIndicatorChart() {
    return Container(
      height: 400,
      child: LineChart(
        LineChartData(
          lineBarsData: [
            LineChartBarData(
              spots: _ema50.asMap().entries.map((e) =>
                  FlSpot(e.key.toDouble(), e.value)).toList(),
              isCurved: true,
              colors: [Colors.blue],
            ),
            LineChartBarData(
              spots: _ema200.asMap().entries.map((e) =>
                  FlSpot(e.key.toDouble(), e.value)).toList(),
              isCurved: true,
              colors: [Colors.orange],
            ),
          ],
        ),
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/trading/trade_position.dart << 'EOF'
import '../entities/candle.dart';

enum TradeType { BUY, SELL }

class TradePosition {
  final String instrument;
  final TradeType type;
  final DateTime entryTime;
  final double entryPrice;
  final double stopLoss;
  final double takeProfit;
  double? exitPrice;
  DateTime? exitTime;

  TradePosition({
    required this.instrument,
    required this.type,
    required this.entryTime,
    required this.entryPrice,
    required this.stopLoss,
    required this.takeProfit,
  });
}
EOF
cat > lib/features/market/domain/trading/trade_result.dart << 'EOF'
class TradeResult {
  final double profit;
  final double entryPrice;
  final double exitPrice;
  final DateTime entryTime;
  final DateTime exitTime;

  TradeResult({
    required this.profit,
    required this.entryPrice,
    required this.exitPrice,
    required this.entryTime,
    required this.exitTime,
  });
}
EOF
cat > lib/features/market/domain/trading/strategy_manager.dart << 'EOF'
import '../entities/candle.dart';
import '../indicators/ema_calculator.dart';
import '../indicators/stochastic_calculator.dart';
import 'trade_position.dart';

class StrategyManager {
  final List<CandleEntity> candles;

  StrategyManager(this.candles);

  TradePosition? checkForSignal({
    required String instrument,
    required double currentPrice,
  }) {
    // EMA Cross Strategy
    final ema50 = EmaCalculator.calculate(data: candles, period: 50).values;
    final ema200 = EmaCalculator.calculate(data: candles, period: 200).values;

    final stoch = StochasticCalculator.calculate(
      data: candles,
      period: 14,
      smoothK: 3,
      smoothD: 3,
    );

    final int lastIndex = candles.length - 1;
    if (lastIndex < 200) return null;

    final crossBuy = (ema50[lastIndex] > ema200[lastIndex]) &&
        (stoch.kValues[lastIndex] > stoch.dValues[lastIndex]);

    final crossSell = (ema50[lastIndex] < ema200[lastIndex]) &&
        (stoch.kValues[lastIndex] < stoch.dValues[lastIndex]);

    if (crossBuy) {
      return TradePosition(
        instrument: instrument,
        type: TradeType.BUY,
        entryTime: candles[lastIndex].time,
        entryPrice: currentPrice,
        stopLoss: currentPrice * 0.998,
        takeProfit: currentPrice * 1.005,
      );
    }

    if (crossSell) {
      return TradePosition(
        instrument: instrument,
        type: TradeType.SELL,
        entryTime: candles[lastIndex].time,
        entryPrice: currentPrice,
        stopLoss: currentPrice * 1.002,
        takeProfit: currentPrice * 0.995,
      );
    }
    return null;
  }
}
EOF
cat > lib/features/market/data/trading/virtual_exchange.dart << 'EOF'
import '../../domain/trading/trade_position.dart';
import '../../domain/entities/candle.dart';
import '../../domain/trading/trade_result.dart';

class VirtualExchange {
  final List<TradePosition> openPositions = [];
  final List<TradeResult> tradeHistory = [];

  void openPosition(TradePosition position) {
    openPositions.add(position);
  }

  void updateWithNewCandle(CandleEntity candle) {
    for (var position in List.of(openPositions)) {
      final currentPrice = candle.close;

      if (position.type == TradeType.BUY) {
        if (currentPrice >= position.takeProfit ||
            currentPrice <= position.stopLoss) {
          _closePosition(position, currentPrice, candle.time);
        }
      }
      if (position.type == TradeType.SELL) {
        if (currentPrice <= position.takeProfit ||
            currentPrice >= position.stopLoss) {
          _closePosition(position, currentPrice, candle.time);
        }
      }
    }
  }

  void _closePosition(
    TradePosition position,
    double exitPrice,
    DateTime exitTime,
  ) {
    double profit = (position.type == TradeType.BUY)
        ? exitPrice - position.entryPrice
        : position.entryPrice - exitPrice;

    final result = TradeResult(
      profit: profit,
      entryPrice: position.entryPrice,
      exitPrice: exitPrice,
      entryTime: position.entryTime,
      exitTime: exitTime,
    );

    openPositions.remove(position);
    tradeHistory.add(result);
  }
}
EOF
cat > lib/features/market/presentation/pages/market_chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';
import 'dart:math';

import '../../domain/entities/candle.dart';
import '../../domain/entities/tick.dart';
import '../../domain/usecases/get_historical_candles.dart';
import '../../domain/usecases/stream_ticks.dart';
import '../../domain/repositories/market_repository.dart';
import '../../domain/trading/strategy_manager.dart';
import '../../data/trading/virtual_exchange.dart';
import '../../domain/trading/trade_position.dart';

class MarketChartPage extends StatefulWidget {
  final MarketRepository repository;
  final String instrument;

  MarketChartPage({
    required this.repository,
    required this.instrument,
  });

  @override
  _MarketChartPageState createState() => _MarketChartPageState();
}

class _MarketChartPageState extends State<MarketChartPage> {
  bool _isLoading = true;
  List<CandleEntity> _candles = [];

  final VirtualExchange _virtualExchange = VirtualExchange();

  Stream<TickEntity>? _tickStream;

  @override
  void initState() {
    super.initState();
    _fetchHistorical();
  }

  void _fetchHistorical() async {
    setState(() => _isLoading = true);

    final list = await GetHistoricalCandles(widget.repository)(
      instrument: widget.instrument,
      granularity: "M1",
      count: 500,
    );

    setState(() => _candles = list);

    _initLiveStream();
    setState(() => _isLoading = false);
  }

  void _initLiveStream() {
    _tickStream = StreamTicks(widget.repository)(widget.instrument);
    _tickStream!.listen((tick) {
      setState(() {
        final last = _candles.isNotEmpty ? _candles.last : null;
        if (last != null &&
            DateTime.now().difference(last.time).inMinutes == 0) {
          final updated = CandleEntity(
            time: last.time,
            open: last.open,
            high: max(last.high, tick.bid),
            low: min(last.low, tick.bid),
            close: tick.bid,
            volume: last.volume + 1,
          );
          _candles[_candles.length - 1] = updated;
          _virtualExchange.updateWithNewCandle(updated);
        } else {
          final newCandle = CandleEntity(
            time: DateTime.now(),
            open: tick.bid,
            high: tick.bid,
            low: tick.bid,
            close: tick.bid,
            volume: 1,
          );
          _candles.add(newCandle);
        }

        final strategyManager = StrategyManager(_candles);
        final signal = strategyManager.checkForSignal(
          instrument: widget.instrument,
          currentPrice: _candles.last.close,
        );

        if (signal != null) {
          _virtualExchange.openPosition(signal);
        }
      });
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Chart â€” ${widget.instrument}"),
      ),
      body: Column(
        children: [
          if (_isLoading) CircularProgressIndicator(),
          if (!_isLoading) Expanded(child: Container()),

          Padding(
            padding: const EdgeInsets.all(8.0),
            child: Text(
              "Open Trades: ${_virtualExchange.openPositions.length}, "
              "Closed: ${_virtualExchange.tradeHistory.length}",
            ),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/signal_marker.dart << 'EOF'
import 'package:flutter/material.dart';

class SignalMarker extends StatelessWidget {
  final bool isBuy;
  final double x;
  final double y;

  SignalMarker({
    required this.isBuy,
    required this.x,
    required this.y,
  });

  @override
  Widget build(BuildContext context) {
    return Positioned(
      left: x,
      top: y,
      child: Icon(
        isBuy ? Icons.arrow_circle_up : Icons.arrow_circle_down,
        color: isBuy ? Colors.green : Colors.red,
        size: 24,
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/backtest/backtest_result.dart << 'EOF'
class BacktestResult {
  final List<DateTime> timestamps;
  final List<double> equityCurve;
  final double netProfit;
  final double maxDrawdown;
  final double winRate;

  BacktestResult({
    required this.timestamps,
    required this.equityCurve,
    required this.netProfit,
    required this.maxDrawdown,
    required this.winRate,
  });
}
EOF
cat > lib/features/market/domain/backtest/backtest_engine.dart << 'EOF'
import '../trading/trade_position.dart';
import '../trading/trade_result.dart';
import '../trading/strategy_manager.dart';
import '../entities/candle.dart';
import 'backtest_result.dart';

class BacktestEngine {
  final List<CandleEntity> historicalData;

  BacktestEngine(this.historicalData);

  BacktestResult run() {
    List<double> equityCurve = [];
    List<DateTime> timestamps = [];

    double balance = 10000;
    double peak = balance;
    double maxDrawdown = 0;
    int wins = 0;
    int tradesCount = 0;

    final List<TradePosition> openPositions = [];

    for (var candle in historicalData) {
      final strategy = StrategyManager(historicalData);
      final signal = strategy.checkForSignal(
        instrument: "",
        currentPrice: candle.close,
      );

      if (signal != null) {
        openPositions.add(signal);
        tradesCount++;
      }

      for (var pos in List.of(openPositions)) {
        if (pos.type == TradeType.BUY) {
          if (candle.close >= pos.takeProfit ||
              candle.close <= pos.stopLoss) {
            final profit =
                (candle.close - pos.entryPrice) * 10000; // Scale
            balance += profit;
            if (profit > 0) wins++;
            openPositions.remove(pos);
          }
        } else {
          if (candle.close <= pos.takeProfit ||
              candle.close >= pos.stopLoss) {
            final profit =
                (pos.entryPrice - candle.close) * 10000; // Scale
            balance += profit;
            if (profit > 0) wins++;
            openPositions.remove(pos);
          }
        }
      }

      timestamps.add(candle.time);
      equityCurve.add(balance);

      if (balance > peak) peak = balance;
      final drawdown = (peak - balance) / peak * 100;
      if (drawdown > maxDrawdown) maxDrawdown = drawdown;
    }

    final winRate = tradesCount > 0 ? wins / tradesCount * 100 : 0;

    final netProfit = balance - 10000;

    return BacktestResult(
      timestamps: timestamps,
      equityCurve: equityCurve,
      netProfit: netProfit,
      maxDrawdown: maxDrawdown,
      winRate: winRate,
    );
  }
}
EOF
cat > lib/features/market/domain/usecases/run_backtest.dart << 'EOF'
import '../backtest/backtest_engine.dart';
import '../backtest/backtest_result.dart';
import '../entities/candle.dart';

class RunBacktest {
  Future<BacktestResult> call(List<CandleEntity> history) async {
    final engine = BacktestEngine(history);
    return engine.run();
  }
}
EOF
cat > lib/features/market/presentation/pages/backtest/backtest_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/usecases/run_backtest.dart';
import '../../widgets/backtest_report_widget.dart';
import '../../widgets/equity_curve_widget.dart';
import '../../../domain/entities/candle.dart';
import '../../../domain/repositories/market_repository.dart';
import '../../../domain/usecases/get_historical_candles.dart';

class BacktestPage extends StatefulWidget {
  final MarketRepository repository;
  final String instrument;

  BacktestPage({
    required this.repository,
    required this.instrument,
  });

  @override
  _BacktestPageState createState() => _BacktestPageState();
}

class _BacktestPageState extends State<BacktestPage> {
  bool _isRunning = false;
  dynamic _result;

  void _startBacktest() async {
    setState(() => _isRunning = true);

    final data = await GetHistoricalCandles(widget.repository)(
      instrument: widget.instrument,
      granularity: "M1",
      count: 1000,
    );

    final result = await RunBacktest().call(data);
    setState(() => _result = result);
    setState(() => _isRunning = false);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Backtest â€” ${widget.instrument}"),
      ),
      body: Padding(
        padding: const EdgeInsets.all(8.0),
        child: _isRunning
            ? Center(child: CircularProgressIndicator())
            : (_result == null
                ? ElevatedButton(
                    onPressed: _startBacktest,
                    child: Text("ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø§Ùƒâ€‘ØªØ³Øª"),
                  )
                : Column(
                    children: [
                      BacktestReportWidget(result: _result),
                      SizedBox(height: 16),
                      Expanded(child: EquityCurveWidget(result: _result)),
                    ],
                  )),
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/backtest/backtest_report_widget.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/backtest/backtest_result.dart';

class BacktestReportWidget extends StatelessWidget {
  final BacktestResult result;

  BacktestReportWidget({required this.result});

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text("Net Profit: ${result.netProfit.toStringAsFixed(2)}"),
        Text("Win Rate: ${result.winRate.toStringAsFixed(2)}%"),
        Text("Max Drawdown: ${result.maxDrawdown.toStringAsFixed(2)}%"),
      ],
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/backtest/equity_curve_widget.dart << 'EOF'
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';
import '../../../domain/backtest/backtest_result.dart';

class EquityCurveWidget extends StatelessWidget {
  final BacktestResult result;

  EquityCurveWidget({required this.result});

  @override
  Widget build(BuildContext context) {
    final spots = result.equityCurve.asMap().entries.map((entry) {
      return FlSpot(entry.key.toDouble(), entry.value);
    }).toList();

    return LineChart(
      LineChartData(
        lineBarsData: [
          LineChartBarData(spots: spots, isCurved: true, colors: [Colors.blue]),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/instrument_list_widget.dart << 'EOF'
import 'package:flutter/material.dart';
import '../pages/market_chart_page.dart';
import '../pages/backtest/backtest_page.dart';
import '../../data/repositories/market_repository_impl.dart';
import '../../data/datasources/local_storage.dart';

class InstrumentListWidget extends StatelessWidget {
  final List<String> instruments;

  InstrumentListWidget({required this.instruments});

  @override
  Widget build(BuildContext context) {
    final localStorage = LocalStorage();
    final repo = MarketRepositoryImpl(localStorage: localStorage);

    return ListView.builder(
      itemCount: instruments.length,
      itemBuilder: (ctx, i) {
        final symbol = instruments[i];
        return ListTile(
          title: Text(symbol),
          subtitle: Row(
            children: [
              ElevatedButton(
                child: Text("Chart"),
                onPressed: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => MarketChartPage(
                        repository: repo,
                        instrument: symbol,
                      ),
                    ),
                  );
                },
              ),
              SizedBox(width: 8),
              ElevatedButton(
                child: Text("Backtest"),
                onPressed: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (_) => BacktestPage(
                        repository: repo,
                        instrument: symbol,
                      ),
                    ),
                  );
                },
              ),
            ],
          ),
        );
      },
    );
  }
}
EOF
cat > lib/features/market/data/storage/strategy_settings.dart << 'EOF'
class StrategySettings {
  int emaShort;
  int emaLong;
  int stochKPeriod;
  int stochSmoothK;
  int stochSmoothD;
  double stopLossPercent;
  double takeProfitPercent;

  StrategySettings({
    required this.emaShort,
    required this.emaLong,
    required this.stochKPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
    required this.stopLossPercent,
    required this.takeProfitPercent,
  });

  Map<String, dynamic> toJson() => {
        "emaShort": emaShort,
        "emaLong": emaLong,
        "stochKPeriod": stochKPeriod,
        "stochSmoothK": stochSmoothK,
        "stochSmoothD": stochSmoothD,
        "stopLossPercent": stopLossPercent,
        "takeProfitPercent": takeProfitPercent,
      };

  factory StrategySettings.fromJson(Map<String, dynamic> json) {
    return StrategySettings(
      emaShort: json["emaShort"],
      emaLong: json["emaLong"],
      stochKPeriod: json["stochKPeriod"],
      stochSmoothK: json["stochSmoothK"],
      stochSmoothD: json["stochSmoothD"],
      stopLossPercent: json["stopLossPercent"],
      takeProfitPercent: json["takeProfitPercent"],
    );
  }
}
EOF
cat > lib/features/market/data/storage/settings_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'strategy_settings.dart';

class SettingsStorage {
  final Box _box = Hive.box('settings');

  Future<void> saveStrategySettings(StrategySettings settings) async {
    await _box.put('strategy_settings', settings.toJson());
  }

  StrategySettings? getStrategySettings() {
    final json = _box.get('strategy_settings');
    if (json == null) return null;
    return StrategySettings.fromJson(Map<String, dynamic>.from(json));
  }
}
EOF
cat > lib/features/market/presentation/pages/settings/strategy_settings_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../data/storage/settings_storage.dart';
import '../../../data/storage/strategy_settings.dart';

class StrategySettingsPage extends StatefulWidget {
  @override
  _StrategySettingsPageState createState() => _StrategySettingsPageState();
}

class _StrategySettingsPageState extends State<StrategySettingsPage> {
  final SettingsStorage _storage = SettingsStorage();
  late StrategySettings _settings;

  @override
  void initState() {
    super.initState();
    _settings = _storage.getStrategySettings() ??
        StrategySettings(
          emaShort: 50,
          emaLong: 200,
          stochKPeriod: 14,
          stochSmoothK: 3,
          stochSmoothD: 3,
          stopLossPercent: 0.2,
          takeProfitPercent: 0.5,
        );
  }

  _save() {
    _storage.saveStrategySettings(_settings);
    Navigator.pop(context);
  }

  Widget _numberInput(String label, int value, Function(int) onChanged) {
    return Row(
      children: [
        Expanded(child: Text(label)),
        Expanded(
          child: TextField(
            keyboardType: TextInputType.number,
            decoration: InputDecoration(border: OutlineInputBorder()),
            controller: TextEditingController(text: value.toString()),
            onChanged: (v) => onChanged(int.parse(v)),
          ),
        ),
      ],
    );
  }

  Widget _doubleInput(String label, double value, Function(double) onChanged) {
    return Row(
      children: [
        Expanded(child: Text(label)),
        Expanded(
          child: TextField(
            keyboardType: TextInputType.numberWithOptions(decimal: true),
            decoration: InputDecoration(border: OutlineInputBorder()),
            controller: TextEditingController(text: value.toString()),
            onChanged: (v) => onChanged(double.parse(v)),
          ),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©")),
      body: Padding(
        padding: const EdgeInsets.all(12),
        child: Column(
          children: [
            _numberInput("EMA Short", _settings.emaShort,
                (v) => _settings.emaShort = v),
            SizedBox(height: 8),
            _numberInput("EMA Long", _settings.emaLong,
                (v) => _settings.emaLong = v),
            SizedBox(height: 8),
            _numberInput("Stoch K Period", _settings.stochKPeriod,
                (v) => _settings.stochKPeriod = v),
            SizedBox(height: 8),
            _numberInput(
                "Stoch Smooth K", _settings.stochSmoothK,
                (v) => _settings.stochSmoothK = v),
            SizedBox(height: 8),
            _numberInput(
                "Stoch Smooth D", _settings.stochSmoothD,
                (v) => _settings.stochSmoothD = v),
            SizedBox(height: 8),
            _doubleInput("Stop Loss %", _settings.stopLossPercent,
                (v) => _settings.stopLossPercent = v),
            SizedBox(height: 8),
            _doubleInput("Take Profit %", _settings.takeProfitPercent,
                (v) => _settings.takeProfitPercent = v),
            SizedBox(height: 16),
            ElevatedButton(onPressed: _save, child: Text("Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")),
          ],
        ),
      ),
    );
  }
}
EOF
cat >> lib/features/market/presentation/pages/home_page.dart << 'EOF'

ElevatedButton(
  child: Text("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©"),
  onPressed: () {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (_) => StrategySettingsPage()),
    );
  },
),
EOF
cat > lib/features/market/data/storage/export_utils.dart << 'EOF'
import 'dart:io';
import 'package:path_provider/path_provider.dart';
import 'package:share_plus/share_plus.dart';
import '../../domain/backtest/backtest_result.dart';

class ExportUtils {
  // Ø­ÙØ¸ ÙƒÙ€ JSON
  static Future<String> exportBacktestJSON(BacktestResult result) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File("${dir.path}/backtest_result.json");
    await file.writeAsString(result.toJson());
    return file.path;
  }

  // Ø­ÙØ¸ ÙƒÙ€ CSV
  static Future<String> exportBacktestCSV(BacktestResult result) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File("${dir.path}/backtest_result.csv");
    final buffer = StringBuffer();

    buffer.writeln("Time,Equity");
    for (int i = 0; i < result.timestamps.length; i++) {
      buffer.writeln(
          "${result.timestamps[i].toIso8601String()},${result.equityCurve[i]}");
    }

    await file.writeAsString(buffer.toString());
    return file.path;
  }

  static Future<void> shareFile(String path) async {
    await Share.shareFiles([path]);
  }
}
EOF
cat > lib/features/market/presentation/pages/backtest/backtest_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../data/storage/export_utils.dart';
import '../../../domain/backtest/backtest_result.dart';
import '../widgets/backtest_report_widget.dart';
import '../widgets/equity_curve_widget.dart';
import '../../../domain/entities/candle.dart';
import '../../../domain/repositories/market_repository.dart';
import '../../../domain/usecases/get_historical_candles.dart';
import '../../../domain/usecases/run_backtest.dart';

class BacktestPage extends StatefulWidget {
  final MarketRepository repository;
  final String instrument;

  BacktestPage({
    required this.repository,
    required this.instrument,
  });

  @override
  _BacktestPageState createState() => _BacktestPageState();
}

class _BacktestPageState extends State<BacktestPage> {
  bool _isRunning = false;
  BacktestResult? _result;

  void _startBacktest() async {
    setState(() => _isRunning = true);

    final data = await GetHistoricalCandles(widget.repository)(
      instrument: widget.instrument,
      granularity: "M1",
      count: 1000,
    );

    final result = await RunBacktest().call(data);
    setState(() => _result = result);
    setState(() => _isRunning = false);
  }

  void _exportJSON() async {
    final path = await ExportUtils.exportBacktestJSON(_result!);
    await ExportUtils.shareFile(path);
  }

  void _exportCSV() async {
    final path = await ExportUtils.exportBacktestCSV(_result!);
    await ExportUtils.shareFile(path);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Backtest â€” ${widget.instrument}"),
      ),
      body: Padding(
        padding: const EdgeInsets.all(8.0),
        child: _isRunning
            ? Center(child: CircularProgressIndicator())
            : (_result == null
                ? ElevatedButton(
                    onPressed: _startBacktest,
                    child: Text("ØªØ´ØºÙŠÙ„ Backtest"),
                  )
                : Column(
                    children: [
                      BacktestReportWidget(result: _result!),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                        children: [
                          ElevatedButton(
                              onPressed: _exportJSON,
                              child: Text("Export JSON")),
                          ElevatedButton(
                              onPressed: _exportCSV,
                              child: Text("Export CSV")),
                        ],
                      ),
                      SizedBox(height: 16),
                      Expanded(child: EquityCurveWidget(result: _result!)),
                    ],
                  )),
      ),
    );
  }
}
EOF
cat > lib/app.dart << 'EOF'
import 'package:flutter/material.dart';
import 'features/market/presentation/pages/home_page.dart';

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Trading App',
      debugShowCheckedModeBanner: false,
      theme: ThemeData.light().copyWith(
        primaryColor: Colors.blue,
        colorScheme: ColorScheme.light(
          primary: Colors.blue,
          secondary: Colors.blueAccent,
        ),
      ),
      darkTheme: ThemeData.dark().copyWith(
        primaryColor: Colors.teal,
        colorScheme: ColorScheme.dark(
          primary: Colors.teal,
          secondary: Colors.tealAccent,
        ),
      ),
      themeMode: ThemeMode.system,
      home: HomePage(),
    );
  }
}
EOF
cat > lib/core/errors/failures.dart << 'EOF'
abstract class Failure {
  final String message;
  Failure(this.message);
}

class ServerFailure extends Failure {
  ServerFailure(String message): super(message);
}

class CacheFailure extends Failure {
  CacheFailure(String message): super(message);
}

class UnknownFailure extends Failure {
  UnknownFailure(): super("Unknown Error");
}
EOF
cat >> lib/features/market/data/datasources/candles_cache.dart << 'EOF'
import 'package:hive/hive.dart';
import '../models/candle_model.dart';

class CandlesCache {
  final Box<CandleModel> _box = Hive.box<CandleModel>('candles');

  Future<void> cacheCandles(String key, List<CandleModel> candles) async {
    await _box.put(key, candles.map((c) => c.toJson()).toList());
  }

  List<CandleModel>? getCachedCandles(String key) {
    final list = _box.get(key);
    if (list == null) return null;
    return (list as List)
        .map((json) => CandleModel.fromJson(Map<String, dynamic>.from(json)))
        .toList();
  }
}
EOF
cat > test/features/market/domain/indicators/ema_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/indicators/ema_calculator.dart';
import '../../../mock/candles_mock.dart';

void main() {
  test('EMA calculation basic', () {
    final candles = generateMockCandles(100);
    final result = EmaCalculator.calculate(data: candles, period: 10);
    expect(result.values.length, candles.length);
    expect(result.values.first, candles.first.close);
  });
}
EOF
cat > test/features/market/presentation/widgets/backtest_report_widget_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:your_app/features/market/presentation/widgets/backtest/backtest_report_widget.dart';
import 'package:your_app/features/market/domain/backtest/backtest_result.dart';

void main() {
  testWidgets('Backtest report displays numbers', (tester) async {
    final result = BacktestResult(
      timestamps: [DateTime.now()],
      equityCurve: [10000],
      netProfit: 100,
      maxDrawdown: 5,
      winRate: 50,
    );
    await tester.pumpWidget(MaterialApp(
      home: BacktestReportWidget(result: result),
    ));
    expect(find.textContaining("Net Profit"), findsOneWidget);
  });
}
EOF
cat > lib/core/utils/logger.dart << 'EOF'
import 'package:logger/logger.dart';

var appLogger = Logger(
  printer: PrettyPrinter(
    methodCount: 0,
    errorMethodCount: 5,
  ),
);
EOF
cat > .github/workflows/flutter.yml << 'EOF'
name: Flutter CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
EOF
cat > lib/core/utils/notification_service.dart << 'EOF'
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  static final _notifier = FlutterLocalNotificationsPlugin();

  static Future<void> init() async {
    const initSettingsAndroid =
        AndroidInitializationSettings('@mipmap/ic_launcher');

    const initSettings = InitializationSettings(
      android: initSettingsAndroid,
    );

    await _notifier.initialize(initSettings);
  }

  static Future<void> showNotification({
    required int id,
    required String title,
    required String body,
  }) async {
    const androidDetails = AndroidNotificationDetails(
      'trade_channel',
      'Trade Notifications',
      channelDescription: 'Notifications for trading signals',
      importance: Importance.high,
      priority: Priority.high,
    );

    const notifDetails = NotificationDetails(android: androidDetails);

    await _notifier.show(id, title, body, notifDetails);
  }
}
EOF
cat > lib/core/utils/notification_service.dart << 'EOF'
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  static final _notifier = FlutterLocalNotificationsPlugin();

  static Future<void> init() async {
    final androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');

    final initSettings = InitializationSettings(
      android: androidSettings,
    );

    await _notifier.initialize(
      initSettings,
      onDidReceiveNotificationResponse: (response) {
        // handle notification tapped logic if needed
      },
    );
  }

  static Future<void> showNotification({
    required int id,
    required String title,
    required String body,
  }) async {
    const androidDetails = AndroidNotificationDetails(
      'trade_channel',
      'Trade Notifications',
      channelDescription: 'Notifications for trade signals and events',
      importance: Importance.high,
      priority: Priority.high,
      ticker: 'ticker',
    );

    const details = NotificationDetails(android: androidDetails);

    await _notifier.show(id, title, body, details);
  }
}
EOF
cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:hive_flutter/hive_flutter.dart';

import 'core/utils/notification_service.dart';
import 'features/market/data/models/candle_model.dart';
import 'app.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await NotificationService.init();  // ğŸ”” ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª

  await Hive.initFlutter();
  Hive.registerAdapter(CandleModelAdapter());
  await Hive.openBox('settings');
  await Hive.openBox<CandleModel>('candles');

  runApp(MyApp());
}
EOF
cat > lib/features/market/presentation/widgets/candlestick_chart_real.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:candlesticks/candlesticks.dart';
import '../../domain/entities/candle.dart';

class RealCandleStickChart extends StatelessWidget {
  final List<CandleEntity> candles;

  RealCandleStickChart({required this.candles});

  @override
  Widget build(BuildContext context) {
    final items = candles.map((c) => Candle(
      date: c.time,
      open: c.open,
      high: c.high,
      low: c.low,
      close: c.close,
      volume: c.volume.toDouble(),
    )).toList();

    return Candlesticks(
      candles: items,
    );
  }
}
EOF
cat > lib/core/widgets/error_view.dart << 'EOF'
import 'package:flutter/material.dart';

class ErrorView extends StatelessWidget {
  final String message;
  final VoidCallback onRetry;

  ErrorView({required this.message, required this.onRetry});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        children: [
          Text(message),
          SizedBox(height: 8),
          ElevatedButton(onPressed: onRetry, child: Text("Retry")),
        ],
      ),
    );
  }
}
EOF
cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:hydrated_bloc/hydrated_bloc.dart';
import 'package:path_provider/path_provider.dart';
import 'package:hive_flutter/hive_flutter.dart';

import 'app.dart';
import 'features/market/data/models/candle_model.dart';
import 'core/utils/notification_service.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // ğŸ”” ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  await NotificationService.init();

  // ğŸ“¦ ØªÙ‡ÙŠØ¦Ø© Hive
  await Hive.initFlutter();
  Hive.registerAdapter(CandleModelAdapter());
  await Hive.openBox('settings');
  await Hive.openBox<CandleModel>('candles');

  // ğŸ§  ØªÙ‡ÙŠØ¦Ø© HydratedBloc
  final storage = await HydratedStorage.build(
    storageDirectory: await getApplicationDocumentsDirectory(),
  );

  HydratedBloc.storage = storage;

  runApp(MyApp());
}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart << 'EOF'
abstract class OandaSetupEvent {}

class SaveCredentials extends OandaSetupEvent {
  final String apiToken;
  final String accountId;

  SaveCredentials({
    required this.apiToken,
    required this.accountId,
  });
}

class LoadCredentials extends OandaSetupEvent {}

class ValidateCredentials extends OandaSetupEvent {}

class ClearCredentials extends OandaSetupEvent {}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart << 'EOF'
abstract class OandaSetupState {}

class OandaIdle extends OandaSetupState {}

class OandaLoading extends OandaSetupState {}

class OandaCredentialsSaved extends OandaSetupState {
  final String apiToken;
  final String accountId;

  OandaCredentialsSaved(this.apiToken, this.accountId);
}

class OandaCredentialsLoaded extends OandaSetupState {
  final String apiToken;
  final String accountId;

  OandaCredentialsLoaded(this.apiToken, this.accountId);
}

class OandaValidationSuccess extends OandaSetupState {}

class OandaValidationError extends OandaSetupState {
  final String message;
  OandaValidationError(this.message);
}

class OandaCredentialsCleared extends OandaSetupState {}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:hydrated_bloc/hydrated_bloc.dart';

import 'oanda_setup_event.dart';
import 'oanda_setup_state.dart';
import '../../../data/repositories/market_repository_impl.dart';
import '../../../data/datasources/local_storage.dart';

class OandaSetupBloc extends HydratedBloc<OandaSetupEvent, OandaSetupState> {
  final MarketRepositoryImpl repository;
  final LocalStorage storage;

  OandaSetupBloc({
    required this.repository,
    required this.storage,
  }) : super(OandaIdle()) {
    on<SaveCredentials>(_onSaveCredentials);
    on<LoadCredentials>(_onLoadCredentials);
    on<ValidateCredentials>(_onValidateCredentials);
    on<ClearCredentials>(_onClearCredentials);
  }

  Future<void> _onSaveCredentials(
    SaveCredentials event,
    Emitter<OandaSetupState> emit,
  ) async {
    emit(OandaLoading());

    try {
      await storage.saveOandaCredentials(
        apiToken: event.apiToken,
        accountId: event.accountId,
      );

      emit(OandaCredentialsSaved(event.apiToken, event.accountId));
    } catch (e) {
      emit(OandaValidationError("Failed to save credentials"));
    }
  }

  Future<void> _onLoadCredentials(
    LoadCredentials event,
    Emitter<OandaSetupState> emit,
  ) async {
    emit(OandaLoading());

    final creds = storage.getOandaCredentials();

    if (creds == null) {
      emit(OandaIdle());
    } else {
      emit(OandaCredentialsLoaded(creds['apiToken']!, creds['accountId']!));
    }
  }

  Future<void> _onValidateCredentials(
    ValidateCredentials event,
    Emitter<OandaSetupState> emit,
  ) async {
    emit(OandaLoading());

    final creds = storage.getOandaCredentials();

    if (creds == null) {
      emit(OandaValidationError("No credentials found"));
      return;
    }

    try {
      final isValid = await repository.validateOandaCredentials(
        apiToken: creds['apiToken']!,
        accountId: creds['accountId']!,
      );

      if (isValid) {
        emit(OandaValidationSuccess());
      } else {
        emit(OandaValidationError("Invalid API Token or Account ID"));
      }
    } catch (e) {
      emit(OandaValidationError("Network error while validating credentials"));
    }
  }

  Future<void> _onClearCredentials(
    ClearCredentials event,
    Emitter<OandaSetupState> emit,
  ) async {
    await storage.clearOandaCredentials();
    emit(OandaCredentialsCleared());
  }

  @override
  OandaSetupState? fromJson(Map<String, dynamic> json) {
    final api = json['apiToken'] as String?;
    final acc = json['accountId'] as String?;

    if (api != null && acc != null) {
      return OandaCredentialsLoaded(api, acc);
    }
    return OandaIdle();
  }

  @override
  Map<String, dynamic>? toJson(OandaSetupState state) {
    if (state is OandaCredentialsSaved) {
      return {
        "apiToken": state.apiToken,
        "accountId": state.accountId,
      };
    }
    return null;
  }
}
EOF
cat > lib/features/market/data/datasources/local_storage.dart << 'EOF'
import 'package:hive/hive.dart';

class LocalStorage {
  final Box _settings = Hive.box('settings');

  Future<void> saveOandaCredentials({
    required String apiToken,
    required String accountId,
  }) async {
    await _settings.put('oanda_api_token', apiToken);
    await _settings.put('oanda_account_id', accountId);
  }

  Map<String, String>? getOandaCredentials() {
    final api = _settings.get('oanda_api_token');
    final acc = _settings.get('oanda_account_id');

    if (api == null || acc == null) return null;

    return {
      "apiToken": api,
      "accountId": acc,
    };
  }

  Future<void> clearOandaCredentials() async {
    await _settings.delete('oanda_api_token');
    await _settings.delete('oanda_account_id');
  }
}
EOF
cat > lib/features/market/presentation/bloc/markets/markets_event.dart << 'EOF'
abstract class MarketsEvent {}

/// Trigger loading markets from OANDA
class LoadMarkets extends MarketsEvent {}

EOF
cat > lib/features/market/presentation/bloc/markets/markets_state.dart << 'EOF'
abstract class MarketsState {}

class MarketsIdle extends MarketsState {}

class MarketsLoading extends MarketsState {}

class MarketsLoaded extends MarketsState {
  final List<String> instruments;
  MarketsLoaded(this.instruments);
}

class MarketsEmpty extends MarketsState {}

class MarketsError extends MarketsState {
  final String message;
  MarketsError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/markets/markets_bloc.dart << 'EOF'
import 'package:hydrated_bloc/hydrated_bloc.dart';

import 'markets_event.dart';
import 'markets_state.dart';
import '../../../data/repositories/market_repository_impl.dart';
import '../../../data/datasources/local_storage.dart';

class MarketsBloc extends HydratedBloc<MarketsEvent, MarketsState> {
  final MarketRepositoryImpl repository;
  final LocalStorage storage;

  MarketsBloc({
    required this.repository,
    required this.storage,
  }) : super(MarketsIdle()) {
    on<LoadMarkets>(_onLoadMarkets);
  }

  Future<void> _onLoadMarkets(
    LoadMarkets event,
    Emitter<MarketsState> emit,
  ) async {
    emit(MarketsLoading());

    try {
      final list = await repository.fetchAvailableInstruments();

      // Autoâ€‘filter to FX + Metals
      final filtered = list.where((symbol) {
        final s = symbol.toLowerCase();
        return s.contains("usd") || s.contains("xau") || s.contains("xag");
      }).toList();

      if (filtered.isEmpty) {
        emit(MarketsEmpty());
      } else {
        emit(MarketsLoaded(filtered));
      }
    } catch (e) {
      emit(MarketsError("Failed to load markets"));
    }
  }

  @override
  MarketsState? fromJson(Map<String, dynamic> json) {
    final list = (json['instruments'] as List<dynamic>?)
        ?.map((e) => e.toString())
        .toList();
    if (list != null && list.isNotEmpty) {
      return MarketsLoaded(list);
    }
    return MarketsIdle();
  }

  @override
  Map<String, dynamic>? toJson(MarketsState state) {
    if (state is MarketsLoaded) {
      return {
        "instruments": state.instruments,
      };
    }
    return null;
  }
}
EOF
cat > lib/features/market/presentation/pages/home_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

import '../../presentation/bloc/oanda/oanda_setup_bloc.dart';
import '../../presentation/bloc/oanda/oanda_setup_state.dart';
import '../../presentation/bloc/markets/markets_bloc.dart';
import '../../presentation/bloc/markets/markets_event.dart';
import '../../presentation/bloc/markets/markets_state.dart';
import '../../data/repositories/market_repository_impl.dart';
import '../../data/datasources/local_storage.dart';
import '../widgets/market_list_widget.dart';
import '../pages/oanda_settings_page.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {

    final localStorage = LocalStorage();
    final repository = MarketRepositoryImpl(localStorage: localStorage);

    return Scaffold(
      appBar: AppBar(title: Text("Trading App")),
      body: MultiBlocProvider(
        providers: [
          BlocProvider(
            create: (_) => MarketsBloc(
              repository: repository,
              storage: localStorage,
            )..add(LoadMarkets()),
          ),
        ],
        child: SafeArea(
          child: BlocBuilder<MarketsBloc, MarketsState>(
            builder: (context, state) {
              if (state is MarketsLoading) {
                return Center(child: CircularProgressIndicator());
              }
              if (state is MarketsLoaded) {
                return MarketListWidget(instruments: state.instruments);
              }
              if (state is MarketsEmpty) {
                return Center(child: Text("No markets available"));
              }
              if (state is MarketsError) {
                return Center(child: Text("Error: ${state.message}"));
              }
              return Center(child: Text("Welcome"));
            },
          ),
        ),
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/market_list_widget.dart << 'EOF'
import 'package:flutter/material.dart';

class MarketListWidget extends StatelessWidget {
  final List<String> instruments;

  MarketListWidget({required this.instruments});

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: instruments.length,
      itemBuilder: (ctx, i) {
        final symbol = instruments[i];
        return ListTile(
          title: Text(symbol),
          trailing: Icon(Icons.arrow_forward_ios),
        );
      },
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_event.dart << 'EOF'
abstract class ChartEvent {}

/// ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
class LoadChartHistory extends ChartEvent {
  final String symbol;
  final String timeframe;
  LoadChartHistory({required this.symbol, required this.timeframe});
}

/// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
class LoadMoreCandles extends ChartEvent {}

/// Ø¥Ø¶Ø§ÙØ© Tick Ù„Ø­Ø¸ÙŠ Ø¬Ø¯ÙŠØ¯ Ù…Ù† WebSocket
class UpdateLiveTick extends ChartEvent {
  final double price;
  final DateTime time;
  UpdateLiveTick({required this.price, required this.time});
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_state.dart << 'EOF'
import '../../../data/models/candle_model.dart';

abstract class ChartState {}

class ChartIdle extends ChartState {}

class ChartLoading extends ChartState {}

class ChartLoaded extends ChartState {
  final List<CandleModel> candles;
  final bool canLoadMore;
  ChartLoaded({required this.candles, this.canLoadMore = true});
}

class ChartError extends ChartState {
  final String message;
  ChartError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'chart_event.dart';
import 'chart_state.dart';
import '../../../data/models/candle_model.dart';
import '../../../data/repositories/market_repository_impl.dart';

class ChartBloc extends Bloc<ChartEvent, ChartState> {
  final MarketRepositoryImpl repository;
  final String symbol;
  final String timeframe;

  List<CandleModel> _candles = [];
  bool _isLoadingMore = false;
  int _loadCount = 100;

  ChartBloc({
    required this.repository,
    required this.symbol,
    required this.timeframe,
  }) : super(ChartIdle()) {
    on<LoadChartHistory>(_onInitialLoad);
    on<LoadMoreCandles>(_onLoadMore);
    on<UpdateLiveTick>(_onLiveTick);
  }

  Future<void> _onInitialLoad(
    LoadChartHistory event,
    Emitter<ChartState> emit,
  ) async {
    emit(ChartLoading());
    try {
      _candles = await repository.getHistoricalCandles(
        symbol: event.symbol,
        timeframe: event.timeframe,
        count: _loadCount,
      );
      emit(ChartLoaded(candles: _candles));
    } catch (e) {
      emit(ChartError("Failed to load chart data"));
    }
  }

  Future<void> _onLoadMore(
    LoadMoreCandles event,
    Emitter<ChartState> emit,
  ) async {
    if (_isLoadingMore || _candles.isEmpty) return;
    _isLoadingMore = true;

    try {
      final oldest = _candles.first.time;

      final more = await repository.getHistoricalCandles(
        symbol: symbol,
        timeframe: timeframe,
        count: _loadCount,
        to: oldest.subtract(Duration(seconds: 1)),
      );

      if (more.isNotEmpty) {
        _candles = [...more, ..._candles];
        emit(ChartLoaded(candles: _candles));
      } else {
        emit(ChartLoaded(candles: _candles, canLoadMore: false));
      }
    } catch (_) {
      emit(ChartError("Failed to load more candles"));
    }

    _isLoadingMore = false;
  }

  void _onLiveTick(
    UpdateLiveTick event,
    Emitter<ChartState> emit,
  ) {
    if (_candles.isEmpty) return;

    final last = _candles.last;
    final now = event.time;

    if (_isSameCandle(now, last.time)) {
      last.updateClose(event.price);
      emit(ChartLoaded(candles: [..._candles]));
    } else {
      final newCandle = CandleModel.fromTick(event.price, now);
      _candles.add(newCandle);
      emit(ChartLoaded(candles: [..._candles]));
    }
  }

  bool _isSameCandle(DateTime a, DateTime b) {
    return a.difference(b).inMinutes == 0;
  }
}
EOF
cat > lib/features/market/data/datasources/oanda_ws_manager.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class OandaWebSocketManager {
  final String token;
  final String accountId;
  final String instrument;

  WebSocketChannel? _channel;
  StreamController<Map<String, dynamic>> _controller =
      StreamController.broadcast();

  Timer? _heartbeat;

  OandaWebSocketManager({
    required this.token,
    required this.accountId,
    required this.instrument,
  });

  Stream<Map<String, dynamic>> get stream => _controller.stream;

  void connect() {
    final uri = Uri(
      scheme: "wss",
      host: "stream-fxpractice.oanda.com",
      path: "/v3/pricing/stream",
      queryParameters: {"instruments": instrument},
    );

    _channel = WebSocketChannel.connect(uri, headers: {
      "Authorization": "Bearer $token",
    });

    _channel?.stream.listen(
      (msg) {
        try {
          final json = msg is String ? jsonDecode(msg) : {};
          _controller.add(json);
        } catch (_) {}
      },
      onError: _onError,
      onDone: _onDone,
    );

    _startHeartbeat();
  }

  void _startHeartbeat() {
    _heartbeat?.cancel();
    _heartbeat = Timer.periodic(Duration(seconds: 15), (_) {
      _channel?.sink.add("ping");
    });
  }

  void _onError(error) {
    disconnect();
    Future.delayed(Duration(seconds: 5), connect);
  }

  void _onDone() {
    disconnect();
    Future.delayed(Duration(seconds: 5), connect);
  }

  void disconnect() {
    _heartbeat?.cancel();
    _channel?.sink.close();
    _channel = null;
  }
}
EOF
cat > assets/chart.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Chart</title>
  <script src="lightweight-charts.standalone.production.js"></script>
  <style>
    html, body { margin: 0; padding: 0; }
    #chart { height: 100%; width: 100%; }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    const chart = LightweightCharts.createChart(document.body, {
      layout: { textColor: '#d1d4dc', backgroundColor: '#000' },
      grid: { vertLines: { color: 'rgba(197, 203, 206, 0.5)' }},
    });
    const candleSeries = chart.addCandlestickSeries();

    function setHistory(data) {
      candleSeries.setData(data);
    }
    function updateCandle(candle) {
      candleSeries.update(candle);
    }
  </script>
</body>
</html>
EOF
cat > lib/features/market/presentation/widgets/webview_chart.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class WebViewChart extends StatefulWidget {
  final Function(String) onCreated;
  WebViewChart({required this.onCreated});

  @override
  _WebViewChartState createState() => _WebViewChartState();
}

class _WebViewChartState extends State<WebViewChart> {
  late WebViewController webController;

  @override
  Widget build(BuildContext context) {
    return WebView(
      initialUrl: 'assets/chart.html',
      javascriptMode: JavascriptMode.unrestricted,
      onWebViewCreated: (ctrl) {
        webController = ctrl;
        widget.onCreated("");
      },
    );
  }
}
EOF
cat > lib/features/market/presentation/pages/market_chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_event.dart';
import '../bloc/chart/chart_state.dart';
import '../widgets/candlestick_chart_real.dart';

class MarketChartPage extends StatelessWidget {
  final String symbol;

  MarketChartPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => ChartBloc(
        repository: RepositoryProvider.of(context),
        symbol: symbol,
        timeframe: "M1",
      )..add(LoadChartHistory(symbol: symbol, timeframe: "M1")),
      child: Scaffold(
        appBar: AppBar(title: Text("Chart â€” $symbol")),
        body: BlocBuilder<ChartBloc, ChartState>(
          builder: (context, state) {
            if (state is ChartLoading) {
              return Center(child: CircularProgressIndicator());
            }
            if (state is ChartLoaded) {
              return ListView(
                children: [
                  RealCandleStickChart(candles: state.candles),
                ],
              );
            }
            if (state is ChartError) {
              return Center(child: Text("Error: ${state.message}"));
            }
            return Container();
          },
        ),
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_event.dart << 'EOF'
abstract class TradingEvent {}

/// Signals from Strategy to open a position
class NewSignal extends TradingEvent {
  final String instrument;
  final double price;
  NewSignal({required this.instrument, required this.price});
}

/// Called each time candle updates (History or Live)
class UpdateWithCandle extends TradingEvent {
  final candle;
  UpdateWithCandle(this.candle);
}

/// Manually close a position
class ClosePosition extends TradingEvent {
  final int index;
  ClosePosition(this.index);
}

/// Clear all positions/trade history
class ResetTrading extends TradingEvent {}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_state.dart << 'EOF'
import '../../../domain/trading/trade_position.dart';
import '../../../domain/trading/trade_result.dart';

abstract class TradingState {}

class TradingIdle extends TradingState {}

class TradingUpdated extends TradingState {
  final List<TradePosition> openPositions;
  final List<TradeResult> tradeHistory;

  TradingUpdated({
    required this.openPositions,
    required this.tradeHistory,
  });
}

class TradingError extends TradingState {
  final String message;
  TradingError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_bloc.dart << 'EOF'
import 'package:hydrated_bloc/hydrated_bloc.dart';
import '../../../data/trading/virtual_exchange.dart';
import 'trading_event.dart';
import 'trading_state.dart';

class TradingBloc extends HydratedBloc<TradingEvent, TradingState> {
  final VirtualExchange _exchange = VirtualExchange();

  TradingBloc() : super(TradingIdle()) {
    on<NewSignal>(_onSignal);
    on<UpdateWithCandle>(_onUpdateCandle);
    on<ClosePosition>(_onClose);
    on<ResetTrading>(_onReset);
  }

  void _onSignal(NewSignal event, Emitter<TradingState> emit) {
    try {
      final pos = _exchange.createPosition(
        instrument: event.instrument,
        entryPrice: event.price,
      );

      if (pos != null) {
        emit(TradingUpdated(
          openPositions: _exchange.openPositions,
          tradeHistory: _exchange.tradeHistory,
        ));
      }
    } catch (e) {
      emit(TradingError("Error creating trade"));
    }
  }

  void _onUpdateCandle(UpdateWithCandle event, Emitter<TradingState> emit) {
    try {
      _exchange.updateWithNewCandle(event.candle);
      emit(TradingUpdated(
        openPositions: _exchange.openPositions,
        tradeHistory: _exchange.tradeHistory,
      ));
    } catch (e) {
      emit(TradingError("Error updating trades"));
    }
  }

  void _onClose(ClosePosition event, Emitter<TradingState> emit) {
    try {
      _exchange.manualClose(event.index);
      emit(TradingUpdated(
        openPositions: _exchange.openPositions,
        tradeHistory: _exchange.tradeHistory,
      ));
    } catch (e) {
      emit(TradingError("Close position failed"));
    }
  }

  void _onReset(ResetTrading event, Emitter<TradingState> emit) {
    _exchange.clearAll();
    emit(TradingUpdated(
      openPositions: _exchange.openPositions,
      tradeHistory: _exchange.tradeHistory,
    ));
  }

  @override
  TradingState? fromJson(Map<String, dynamic> json) {
    try {
      final openJson = json['open'] as List<dynamic>?;
      final histJson = json['history'] as List<dynamic>?;

      if (openJson != null && histJson != null) {
        _exchange.openPositions = openJson
            .map((e) => TradePosition.fromJson(Map<String, dynamic>.from(e)))
            .toList();

        _exchange.tradeHistory = histJson
            .map((e) => TradeResult.fromJson(Map<String, dynamic>.from(e)))
            .toList();

        return TradingUpdated(
          openPositions: _exchange.openPositions,
          tradeHistory: _exchange.tradeHistory,
        );
      }
    } catch (_) {}
    return TradingIdle();
  }

  @override
  Map<String, dynamic>? toJson(TradingState state) {
    if (state is TradingUpdated) {
      return {
        'open': state.openPositions
            .map((p) => p.toJson())
            .toList(),
        'history': state.tradeHistory
            .map((r) => r.toJson())
            .toList(),
      };
    }
    return null;
  }
}
EOF
cat > lib/features/market/presentation/widgets/trading_positions_widget.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/trading/trading_bloc.dart';
import '../bloc/trading/trading_state.dart';

class TradingPositionsWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<TradingBloc, TradingState>(
      builder: (context, state) {
        if (state is TradingUpdated) {
          return ListView(
            children: [
              ...state.openPositions.map((p) => ListTile(
                title: Text("${p.instrument}: ${p.type}"),
                subtitle: Text("Entry: ${p.entryPrice}"),
              )),
              Divider(),
              ...state.tradeHistory.map((h) => ListTile(
                title: Text("Closed: ${h.profit.toStringAsFixed(2)}"),
              )),
            ],
          );
        }
        return Text("No trades yet");
      },
    );
  }
}
EOF
cat > lib/core/widgets/error_view.dart << 'EOF'
import 'package:flutter/material.dart';

/// A reusable error widget.
/// Displays a message and a retry button.
class ErrorView extends StatelessWidget {
  final String message;
  final VoidCallback onRetry;

  const ErrorView({
    required this.message,
    required this.onRetry,
  });

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.error_outline, size: 60, color: Colors.red),
            SizedBox(height: 12),
            Text(
              message,
              textAlign: TextAlign.center,
              style: TextStyle(fontSize: 18),
            ),
            SizedBox(height: 16),
            ElevatedButton(
              onPressed: onRetry,
              child: Text("Try Again"),
            ),
          ],
        ),
      ),
    );
  }
}
EOF
cat > lib/core/errors/app_error.dart << 'EOF'
abstract class AppError {
  String get message;
}

class NetworkError implements AppError {
  @override
  String get message => "No internet connection";
}

class ServerError implements AppError {
  final String details;
  ServerError(this.details);

  @override
  String get message => "Server error: $details";
}

class TimeoutError implements AppError {
  @override
  String get message => "Request timed out. Please try again.";
}

class InvalidCredentialsError implements AppError {
  @override
  String get message => "Invalid credentials. Please check your API Token and Account ID.";
}

class UnknownError implements AppError {
  @override
  String get message => "Something went wrong. Please retry.";
}
EOF
cat > lib/core/utils/network_checker.dart << 'EOF'
import 'dart:io';

class NetworkChecker {
  static Future<bool> isConnected() async {
    try {
      final result = await InternetAddress.lookup('example.com');
      return result.isNotEmpty && result[0].rawAddress.isNotEmpty;
    } catch (_) {
      return false;
    }
  }
}
EOF
cat > lib/features/market/domain/strategy/strategy_config.dart << 'EOF'
class StrategyConfig {
  final int emaShort;
  final int emaLong;
  final int stochPeriod;
  final int stochSmoothK;
  final int stochSmoothD;
  final double stopLossPct;
  final double takeProfitPct;
  final double minSignalIntervalSeconds;

  StrategyConfig({
    required this.emaShort,
    required this.emaLong,
    required this.stochPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
    required this.stopLossPct,
    required this.takeProfitPct,
    required this.minSignalIntervalSeconds,
  });
}
EOF
cat > lib/features/market/domain/strategy/strategy_manager.dart << 'EOF'
import '../entities/candle.dart';
import '../indicators/ema_calculator.dart';
import '../indicators/stochastic_calculator.dart';
import 'strategy_config.dart';

enum TradeSignal { BUY, SELL, NONE }

class StrategyManager {
  final List<CandleEntity> data;
  final StrategyConfig config;

  DateTime? _lastSignalTime;
  TradeSignal _lastSignal = TradeSignal.NONE;

  StrategyManager(this.data, this.config);

  TradeSignal evaluate() {
    if (data.length < config.emaLong) return TradeSignal.NONE;

    final emaShortVals = EmaCalculator.calculate(
      data: data,
      period: config.emaShort,
    ).values;

    final emaLongVals = EmaCalculator.calculate(
      data: data,
      period: config.emaLong,
    ).values;

    final stoch = StochasticCalculator.calculate(
      data: data,
      period: config.stochPeriod,
      smoothK: config.stochSmoothK,
      smoothD: config.stochSmoothD,
    );

    final int idx = data.length - 1;

    final bool bullCond = emaShortVals[idx] > emaLongVals[idx] &&
        stoch.kValues[idx] > stoch.dValues[idx] &&
        stoch.kValues[idx] < 80;

    final bool bearCond = emaShortVals[idx] < emaLongVals[idx] &&
        stoch.kValues[idx] < stoch.dValues[idx] &&
        stoch.kValues[idx] > 20;

    final now = data[idx].time;

    if (bullCond && _canSignal(now, TradeSignal.BUY)) {
      _updateLastSignal(now, TradeSignal.BUY);
      return TradeSignal.BUY;
    }

    if (bearCond && _canSignal(now, TradeSignal.SELL)) {
      _updateLastSignal(now, TradeSignal.SELL);
      return TradeSignal.SELL;
    }

    return TradeSignal.NONE;
  }

  bool _canSignal(DateTime now, TradeSignal signal) {
    if (_lastSignal == signal && _lastSignalTime != null) {
      final diff = now.difference(_lastSignalTime!).inSeconds;
      if (diff < config.minSignalIntervalSeconds) {
        return false;
      }
    }
    return true;
  }

  void _updateLastSignal(DateTime now, TradeSignal signal) {
    _lastSignalTime = now;
    _lastSignal = signal;
  }
}
EOF
cat > lib/features/market/domain/usecases/evaluate_strategy.dart << 'EOF'
import '../strategy/strategy_config.dart';
import '../strategy/strategy_manager.dart';
import '../entities/candle.dart';

class EvaluateStrategy {
  TradeSignal call({
    required List<CandleEntity> candles,
    required StrategyConfig config,
  }) {
    final mgr = StrategyManager(candles, config);
    return mgr.evaluate();
  }
}
EOF
cat > tmp_strategy_integration.patch << 'EOF'
--- a/lib/features/market/presentation/bloc/chart/chart_bloc.dart
+++ b/lib/features/market/presentation/bloc/chart/chart_bloc.dart
@@ -1,6 +1,7 @@
 import 'package:flutter_bloc/flutter_bloc.dart';
 import 'chart_event.dart';
 import 'chart_state.dart';
+import '../../../domain/usecases/evaluate_strategy.dart';
+import '../../../domain/strategy/strategy_config.dart';
 import '../../../data/models/candle_model.dart';
 import '../../../data/repositories/market_repository_impl.dart';

@@ -50,10 +51,20 @@ class ChartBloc extends Bloc<ChartEvent, ChartState> {
       add(UpdateLiveTick(price: price, time: DateTime.parse(json["time"])));
     });
 
-    on<UpdateLiveTick>(_onLiveTick);
+    on<UpdateLiveTick>((event, emit) {
+      _onLiveTick(event, emit);
+
+      // SIGNAL LOGIC
+      final config = StrategyConfig(
+        emaShort: 50,
+        emaLong: 200,
+        stochPeriod: 14,
+        stochSmoothK: 3,
+        stochSmoothD: 3,
+        stopLossPct: 0.002,
+        takeProfitPct: 0.005,
+        minSignalIntervalSeconds: 60,
+      );
+      final signal = EvaluateStrategy().call(
+        candles: _candles.map((c) => c.toEntity()).toList(),
+        config: config,
+      );
+      if (signal != TradeSignal.NONE) {
+        tradingBloc.add(NewSignal(
+          instrument: symbol,
+          price: event.price,
+          signalType: signal,
+        ));
+      }
+    });
EOF
cat > lib/features/market/presentation/widgets/signal_marker.dart << 'EOF'
import 'package:flutter/material.dart';

class SignalMarker extends StatelessWidget {
  final bool isBuy;
  final Offset position;
  final String label;

  SignalMarker({
    required this.isBuy,
    required this.position,
    required this.label,
  });

  @override
  Widget build(BuildContext context) {
    return Positioned(
      left: position.dx,
      top: position.dy,
      child: Column(
        children: [
          Icon(
            isBuy ? Icons.arrow_circle_up : Icons.arrow_circle_down,
            color: isBuy ? Colors.green : Colors.red,
            size: 28,
          ),
          Text(label),
        ],
      ),
    );
  }
}
EOF
cat > lib/core/utils/secure_storage.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class SecureStorage {
  // Singleton
  static final _storage = FlutterSecureStorage();

  static const _keyApiToken = "secure_oanda_api_token";
  static const _keyAccountId = "secure_oanda_account_id";

  /// Save credentials securely
  static Future<void> saveCredentials({
    required String apiToken,
    required String accountId,
  }) async {
    await _storage.write(key: _keyApiToken, value: apiToken);
    await _storage.write(key: _keyAccountId, value: accountId);
  }

  /// Read secure keys
  static Future<Map<String, String>?> readCredentials() async {
    final token = await _storage.read(key: _keyApiToken);
    final accId = await _storage.read(key: _keyAccountId);

    if (token == null || accId == null) return null;

    return {
      "apiToken": token,
      "accountId": accId,
    };
  }

  /// Delete secure keys
  static Future<void> clearCredentials() async {
    await _storage.delete(key: _keyApiToken);
    await _storage.delete(key: _keyAccountId);
  }
}
EOF
cat > lib/features/market/data/datasources/local_storage.dart << 'EOF'
import '../../../core/utils/secure_storage.dart';

class LocalStorage {
  Future<void> saveOandaCredentials({
    required String apiToken,
    required String accountId,
  }) async {
    await SecureStorage.saveCredentials(
      apiToken: apiToken,
      accountId: accountId,
    );
  }

  Future<Map<String, String>?> getOandaCredentials() async {
    return await SecureStorage.readCredentials();
  }

  Future<void> clearOandaCredentials() async {
    await SecureStorage.clearCredentials();
  }
}
EOF
cat > build.yaml << 'EOF'
targets:
  $default:
    builders:
      dart2js:
        options:
          dart2js_args:
            - --minify
            - --trust-primitives
EOF
cat > .github/workflows/flutter_ci_cd.yml << 'EOF'
name: Flutter CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test_build:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'

      - name: Install dependencies

      - name: Run Flutter format check
        run: flutter format --set-exit-if-changed .

      - name: Run unit & widget tests

      - name: Build APK (debug)

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage

  release_build:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: test_build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'

      - name: Install dependencies

      - name: Build Release APK (with obfuscation)

      - name: Upload release artifact
        uses: actions/upload-artifact@v3
        with:
          name: Android-Release-APK
          path: build/app/outputs/flutter-apk/app-release.apk
EOF
cat > lib/features/market/presentation/pages/interactive_chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:candlesticks/candlesticks.dart';

import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_event.dart';
import '../bloc/chart/chart_state.dart';

class InteractiveChartPage extends StatelessWidget {
  final String symbol;

  InteractiveChartPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (_) => ChartBloc(
        repository: RepositoryProvider.of(context),
        symbol: symbol,
        timeframe: "M1",
      )..add(LoadChartHistory(symbol: symbol, timeframe: "M1")),
      child: _InteractiveChartView(symbol: symbol),
    );
  }
}

class _InteractiveChartView extends StatefulWidget {
  final String symbol;
  _InteractiveChartView({required this.symbol});

  @override
  __InteractiveChartViewState createState() => __InteractiveChartViewState();
}

class __InteractiveChartViewState extends State<_InteractiveChartView> {
  List<Candle> _candleItems = [];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Chart â€” ${widget.symbol}")),
      body: BlocBuilder<ChartBloc, ChartState>(
        builder: (context, state) {
          if (state is ChartLoading) {
            return Center(child: CircularProgressIndicator());
          }
          if (state is ChartLoaded) {
            _candleItems = state.candles.map((c) => Candle(
              date: c.time,
              open: c.open,
              high: c.high,
              low: c.low,
              close: c.close,
              volume: c.volume.toDouble(),
            )).toList();

            return Column(
              children: [
                Expanded(
                  child: Candlesticks(
                    candles: _candleItems,
                    showVolume: true,
                    onIndicatorChange: (i) {},
                  ),
                ),
              ],
            );
          }
          if (state is ChartError) {
            return Center(child: Text("Error: ${state.message}"));
          }
          return Container();
        },
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/widgets/crosshair_overlay.dart << 'EOF'
import 'package:flutter/material.dart';

class CrosshairOverlay extends StatelessWidget {
  final Offset position;
  CrosshairOverlay({required this.position});

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        Positioned(
          left: position.dx,
          top: 0,
          bottom: 0,
          child: Container(width: 1, color: Colors.grey),
        ),
        Positioned(
          top: position.dy,
          left: 0,
          right: 0,
          child: Container(height: 1, color: Colors.grey),
        ),
      ],
    );
  }
}
EOF
cat > lib/features/market/data/datasources/timeframe_storage.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class TimeframeStorage {
  static final _storage = FlutterSecureStorage();
  static const _key = "last_selected_timeframe";

  static Future<void> save(String tf) async {
    await _storage.write(key: _key, value: tf);
  }

  static Future<String> load() async {
    final v = await _storage.read(key: _key);
    return v ?? "M1";
  }
}
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'

  Future<void> _onChangeTimeframe(
    ChangeTimeframe event,
    Emitter<ChartState> emit,
  ) async {
    emit(ChartLoading());

    // Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    await TimeframeStorage.save(event.timeframe);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
    this.timeframe = event.timeframe;

    try {
      _candles = await repository.getHistoricalCandles(
        symbol: symbol,
        timeframe: event.timeframe,
        count: _loadCount,
      );

      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© WebSocket Ø¨Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ…
      await wsManager.disconnect();
      await wsManager.connectWithTimeframe(event.timeframe);

      emit(ChartLoaded(candles: _candles));
    } catch (e) {
      emit(ChartError("Failed to change timeframe"));
    }
  }
EOF
cat >> lib/features/market/data/datasources/oanda_ws_manager.dart << 'EOF'

  Future<void> connectWithTimeframe(String tf) async {
    currentTimeframe = tf;
    disconnect();
    connect();
  }
EOF
cat > lib/features/market/presentation/widgets/timeframe_selector.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_event.dart';

class TimeframeSelector extends StatefulWidget {
  final List<String> frames;

  const TimeframeSelector({required this.frames});

  @override
  _TimeframeSelectorState createState() => _TimeframeSelectorState();
}

class _TimeframeSelectorState extends State<TimeframeSelector> {
  String selected = "M1";

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 50,
      child: ListView(
        scrollDirection: Axis.horizontal,
        children: widget.frames.map((f) {
          final isSelected = f == selected;
          return GestureDetector(
            onTap: () {
              setState(() => selected = f);
              context.read<ChartBloc>().add(ChangeTimeframe(f));
            },
            child: Container(
              margin: EdgeInsets.symmetric(horizontal: 6),
              padding: EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: isSelected ? Colors.blue : Colors.grey.shade800,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Center(
                child: Text(
                  f,
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                  ),
                ),
              ),
            ),
          );
        }).toList(),
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/drawing_tools/drawing_event.dart << 'EOF'
abstract class DrawingEvent {}

class StartTrendline extends DrawingEvent {}

class AddPointToTrendline extends DrawingEvent {
  final double x;
  final double y;
  AddPointToTrendline({required this.x, required this.y});
}

class CompleteTrendline extends DrawingEvent {}

class ClearAllDrawings extends DrawingEvent {}

class AddHorizontalLine extends DrawingEvent {
  final double priceY;
  AddHorizontalLine({required this.priceY});
}
EOF
cat > lib/features/market/presentation/bloc/drawing_tools/drawing_state.dart << 'EOF'
import 'package:flutter/material.dart';

abstract class DrawingState {}

class NoDrawing extends DrawingState {}

class DrawingTrendline extends DrawingState {
  final List<Offset> points;
  DrawingTrendline({required this.points});
}

class DrawingComplete extends DrawingState {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;
  DrawingComplete({
    required this.trendlines,
    required this.horizontalLines,
  });
}
EOF
cat > lib/features/market/presentation/bloc/drawing_tools/drawing_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'drawing_event.dart';
import 'drawing_state.dart';

class DrawingBloc extends Bloc<DrawingEvent, DrawingState> {
  List<List<Offset>> _trendlines = [];
  List<double> _horizontalLines = [];

  List<Offset> _currentPoints = [];

  DrawingBloc() : super(NoDrawing()) {
    on<StartTrendline>((event, emit) {
      _currentPoints = [];
      emit(DrawingTrendline(points: _currentPoints));
    });

    on<AddPointToTrendline>((event, emit) {
      _currentPoints.add(Offset(event.x, event.y));
      emit(DrawingTrendline(points: _currentPoints));
    });

    on<CompleteTrendline>((event, emit) {
      if (_currentPoints.length >= 2) {
        _trendlines.add(List<Offset>.from(_currentPoints));
      }
      _currentPoints = [];
      emit(DrawingComplete(
        trendlines: _trendlines,
        horizontalLines: _horizontalLines,
      ));
    });

    on<AddHorizontalLine>((event, emit) {
      _horizontalLines.add(event.priceY);
      emit(DrawingComplete(
        trendlines: _trendlines,
        horizontalLines: _horizontalLines,
      ));
    });

    on<ClearAllDrawings>((event, emit) {
      _trendlines.clear();
      _horizontalLines.clear();
      emit(DrawingComplete(
        trendlines: _trendlines,
        horizontalLines: _horizontalLines,
      ));
    });
  }
}
EOF
cat > lib/features/market/presentation/widgets/drawing_tools/drawing_overlay.dart << 'EOF'
import 'package:flutter/material.dart';

class DrawingOverlay extends StatelessWidget {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  DrawingOverlay({
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _OverlayPainter(
        trendlines: trendlines,
        horizontalLines: horizontalLines,
      ),
      child: Container(),
    );
  }
}

class _OverlayPainter extends CustomPainter {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  _OverlayPainter({
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paintLine = Paint()
      ..color = Colors.yellow
      ..strokeWidth = 2;

    final paintHLine = Paint()
      ..color = Colors.orange
      ..strokeWidth = 1;

    // Trendlines
    for (var line in trendlines) {
      if (line.length >= 2) {
        canvas.drawLine(line[0], line[1], paintLine);
      }
    }

    // Horizontal lines
    for (var y in horizontalLines) {
      canvas.drawLine(
        Offset(0, y),
        Offset(size.width, y),
        paintHLine,
      );
    }
  }

  @override
  bool shouldRepaint(covariant _OverlayPainter old) {
    return old.trendlines != trendlines ||
        old.horizontalLines != horizontalLines;
  }
}
EOF
cat >> lib/features/market/presentation/pages/interactive_chart_page.dart << 'EOF'

// Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ AppBar:
actions: [
  IconButton(
    icon: Icon(Icons.show_chart),
    onPressed: () => context.read<DrawingBloc>().add(StartTrendline()),
  ),
  IconButton(
    icon: Icon(Icons.horizontal_rule),
    onPressed: () => context.read<DrawingBloc>().add(AddHorizontalLine(priceY: 0)),
  ),
],
EOF
cat > lib/features/market/domain/indicators/indicator_series.dart << 'EOF'
class IndicatorSeries {
  final List<double> values;
  final String label;
  final Color color;

  IndicatorSeries({
    required this.values,
    required this.label,
    required this.color,
  });
}
EOF
cat > lib/features/market/presentation/widgets/indicator_overlay.dart << 'EOF'
import 'package:flutter/material.dart';

class IndicatorOverlay extends StatelessWidget {
  final List<List<Offset>> indicatorLines;

  IndicatorOverlay({required this.indicatorLines});

  @override
  Widget build(BuildContext context) {
    return CustomPaint(
      painter: _IndicatorPainter(indicatorLines),
      child: Container(),
    );
  }
}

class _IndicatorPainter extends CustomPainter {
  final List<List<Offset>> indicatorLines;

  _IndicatorPainter(this.indicatorLines);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..strokeWidth = 1.5
      ..style = PaintingStyle.stroke;

    for (var series in indicatorLines) {
      paint.color = Colors.green;
      canvas.drawPoints(PointMode.polygon, series, paint);
    }
  }

  @override
  bool shouldRepaint(covariant _IndicatorPainter old) =>
      old.indicatorLines != indicatorLines;
}
EOF
cat > lib/core/notifications/notification_service.dart << 'EOF'
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:timezone/timezone.dart' as tz;

class NotificationService {
  static final NotificationService _instance = NotificationService._internal();
  factory NotificationService() => _instance;
  NotificationService._internal();

  final FlutterLocalNotificationsPlugin _plugin =
      FlutterLocalNotificationsPlugin();

  Future<void> init() async {
    const androidSettings =
        AndroidInitializationSettings('@mipmap/ic_launcher');

    const initSettings =
        InitializationSettings(android: androidSettings);

    await _plugin.initialize(initSettings);
  }

  Future<void> showInstantNotification({
    required int id,
    required String title,
    required String body,
  }) async {
    const details = NotificationDetails(
      android: AndroidNotificationDetails(
        'trading_alerts',
        'Trading Alerts',
        channelDescription: 'Smart alerts for trading signals and prices',
        importance: Importance.max,
        priority: Priority.high,
        playSound: true,
      ),
    );

    await _plugin.show(id, title, body, details);
  }

  Future<void> scheduleNotification({
    required int id,
    required String title,
    required String body,
    required DateTime time,
  }) async {
    const details = NotificationDetails(
      android: AndroidNotificationDetails(
        'trading_alerts',
        'Trading Alerts',
        channelDescription: 'Smart alerts for trading signals and prices',
      ),
    );

    await _plugin.zonedSchedule(
      id,
      title,
      body,
      tz.TZDateTime.from(time, tz.local),
      details,
      androidScheduleMode: AndroidScheduleMode.exact,
      uiLocalNotificationDateInterpretation:
          UILocalNotificationDateInterpretation.absoluteTime,
    );
  }
}
EOF
cat > lib/features/market/domain/alerts/price_alert.dart << 'EOF'
class PriceAlert {
  final double price;
  final bool triggerAbove;
  final String symbol;

  PriceAlert({
    required this.price,
    required this.triggerAbove,
    required this.symbol,
  });
}
EOF
cat > lib/features/market/presentation/bloc/alerts/alert_event.dart << 'EOF'
import '../../../domain/alerts/price_alert.dart';

abstract class AlertEvent {}

class AddPriceAlert extends AlertEvent {
  final PriceAlert alert;
  AddPriceAlert(this.alert);
}

class RemovePriceAlert extends AlertEvent {
  final int index;
  RemovePriceAlert(this.index);
}

class CheckPriceAlerts extends AlertEvent {
  final double currentPrice;
  CheckPriceAlerts(this.currentPrice);
}
EOF
cat > lib/features/market/presentation/bloc/alerts/alert_state.dart << 'EOF'
import '../../../domain/alerts/price_alert.dart';

abstract class AlertState {}

class AlertIdle extends AlertState {}

class AlertUpdated extends AlertState {
  final List<PriceAlert> alerts;
  AlertUpdated(this.alerts);
}
EOF
cat > lib/features/market/presentation/bloc/alerts/alert_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/alerts/price_alert.dart';
import 'alert_event.dart';
import 'alert_state.dart';
import '../../../../core/notifications/notification_service.dart';

class AlertBloc extends Bloc<AlertEvent, AlertState> {
  final List<PriceAlert> _alerts = [];

  AlertBloc() : super(AlertIdle()) {
    on<AddPriceAlert>((event, emit) {
      _alerts.add(event.alert);
      emit(AlertUpdated(List.from(_alerts)));
    });

    on<RemovePriceAlert>((event, emit) {
      if (event.index >= 0 && event.index < _alerts.length) {
        _alerts.removeAt(event.index);
      }
      emit(AlertUpdated(List.from(_alerts)));
    });

    on<CheckPriceAlerts>((event, emit) {
      final price = event.currentPrice;

      for (var alert in List.from(_alerts)) {
        bool shouldTrigger =
            (alert.triggerAbove && price >= alert.price) ||
            (!alert.triggerAbove && price <= alert.price);

        if (shouldTrigger) {
          NotificationService().showInstantNotification(
            id: DateTime.now().millisecond,
            title: "Price Alert: ${alert.symbol}",
            body:
                "Price reached ${alert.price} (current: ${price.toStringAsFixed(4)})",
          );

          _alerts.remove(alert);
        }
      }

      emit(AlertUpdated(List.from(_alerts)));
    });
  }
}
EOF
cat > lib/features/market/presentation/widgets/price_alert_dialog.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/alerts/alert_bloc.dart';
import '../bloc/alerts/alert_event.dart';
import '../../domain/alerts/price_alert.dart';

class PriceAlertDialog extends StatefulWidget {
  final String symbol;
  PriceAlertDialog({required this.symbol});

  @override
  _PriceAlertDialogState createState() => _PriceAlertDialogState();
}

class _PriceAlertDialogState extends State<PriceAlertDialog> {
  final TextEditingController _priceCtrl = TextEditingController();
  bool triggerAbove = true;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Add Price Alert"),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(
            controller: _priceCtrl,
            keyboardType: TextInputType.number,
            decoration: InputDecoration(labelText: "Target Price"),
          ),
          Row(
            children: [
              Text("Trigger when:"),
              Switch(
                value: triggerAbove,
                onChanged: (v) => setState(() => triggerAbove = v),
              ),
              Text(triggerAbove ? "Above" : "Below"),
            ],
          ),
        ],
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text("Cancel"),
        ),
        ElevatedButton(
          onPressed: () {
            final price = double.tryParse(_priceCtrl.text);
            if (price != null) {
              context.read<AlertBloc>().add(
                    AddPriceAlert(
                      PriceAlert(
                        price: price,
                        triggerAbove: triggerAbove,
                        symbol: widget.symbol,
                      ),
                    ),
                  );
              Navigator.pop(context);
            }
          },
          child: Text("Add"),
        ),
      ],
    );
  }
}
EOF
cat > lib/features/market/presentation/pages/alerts/alerts_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/alerts/alert_bloc.dart';
import '../../bloc/alerts/alert_state.dart';
import '../../bloc/alerts/alert_event.dart';
import '../../../domain/alerts/price_alert.dart';

class AlertsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Manage Alerts"),
        actions: [
          IconButton(
            icon: Icon(Icons.delete_sweep),
            onPressed: () {
              context.read<AlertBloc>().add(RemovePriceAlert(-1));
            },
          ),
        ],
      ),
      body: BlocBuilder<AlertBloc, AlertState>(
        builder: (context, state) {
          if (state is AlertUpdated) {
            final alerts = state.alerts;
            if (alerts.isEmpty) {
              return Center(child: Text("No alerts set"));
            }
            return ListView.builder(
              itemCount: alerts.length,
              itemBuilder: (ctx, i) {
                final PriceAlert a = alerts[i];
                return ListTile(
                  title: Text("${a.symbol} @ ${a.price.toStringAsFixed(4)}"),
                  subtitle: Text(a.triggerAbove ? "Above" : "Below"),
                  trailing: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      IconButton(
                        icon: Icon(Icons.edit),
                        onPressed: () {
                          _showEditDialog(context, a, i);
                        },
                      ),
                      IconButton(
                        icon: Icon(Icons.delete),
                        onPressed: () {
                          context.read<AlertBloc>().add(RemovePriceAlert(i));
                        },
                      ),
                    ],
                  ),
                );
              },
            );
          }
          return Center(child: Text("Loading alerts..."));
        },
      ),
    );
  }

  void _showEditDialog(BuildContext context, PriceAlert alert, int index) {
    final TextEditingController _priceCtrl =
        TextEditingController(text: alert.price.toString());
    bool triggerAbove = alert.triggerAbove;

    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text("Edit Alert"),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: _priceCtrl,
              keyboardType: TextInputType.number,
              decoration: InputDecoration(labelText: "Target Price"),
            ),
            Row(
              children: [
                Text("Trigger when:"),
                Switch(
                  value: triggerAbove,
                  onChanged: (v) => triggerAbove = v,
                ),
                Text(triggerAbove ? "Above" : "Below"),
              ],
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text("Cancel"),
          ),
          ElevatedButton(
            onPressed: () {
              final double? newPrice = double.tryParse(_priceCtrl.text);
              if (newPrice != null) {
                // Ø­Ø°Ù Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ§Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
                context.read<AlertBloc>().add(RemovePriceAlert(index));
                context.read<AlertBloc>().add(AddPriceAlert(
                      PriceAlert(
                        price: newPrice,
                        triggerAbove: triggerAbove,
                        symbol: alert.symbol,
                      ),
                    ));
              }
              Navigator.pop(context);
            },
            child: Text("Save"),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_event.dart << 'EOF'
abstract class BacktestEvent {}

/// Run a backtest with specific start/end dates (optional)
class RunBacktestEvent extends BacktestEvent {
  final String symbol;
  final String timeframe;
  final DateTime? start;
  final DateTime? end;

  RunBacktestEvent({
    required this.symbol,
    required this.timeframe,
    this.start,
    this.end,
  });
}

/// Clear last results
class ClearBacktestEvent extends BacktestEvent {}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_state.dart << 'EOF'
import '../../../domain/backtest/backtest_result.dart';

abstract class BacktestState {}

class BacktestIdle extends BacktestState {}

class BacktestRunning extends BacktestState {}

class BacktestSuccess extends BacktestState {
  final BacktestResult result;
  BacktestSuccess(this.result);
}

class BacktestError extends BacktestState {
  final String message;
  BacktestError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_bloc.dart << 'EOF'
import 'package:hydrated_bloc/hydrated_bloc.dart';
import '../../../domain/usecases/run_backtest.dart';
import 'backtest_event.dart';
import 'backtest_state.dart';

class BacktestBloc extends HydratedBloc<BacktestEvent, BacktestState> {
  final RunBacktest _runBacktest;

  BacktestBloc(this._runBacktest) : super(BacktestIdle()) {
    on<RunBacktestEvent>(_onRunBacktest);
    on<ClearBacktestEvent>(_onClear);
  }

  Future<void> _onRunBacktest(
    RunBacktestEvent event,
    Emitter<BacktestState> emit,
  ) async {
    emit(BacktestRunning());
    try {
      final result = await _runBacktest.call(
        event.symbol,
        event.timeframe,
        event.start,
        event.end,
      );

      emit(BacktestSuccess(result));
    } catch (e) {
      emit(BacktestError("Backtest failed: ${e.toString()}"));
    }
  }

  void _onClear(
    ClearBacktestEvent event,
    Emitter<BacktestState> emit,
  ) {
    emit(BacktestIdle());
  }

  @override
  BacktestState? fromJson(Map<String, dynamic> json) {
    try {
      // Deserialize BacktestResult if present
      if (json.containsKey('result')) {
        final result = BacktestResult.fromJson(
          Map<String, dynamic>.from(json['result']),
        );
        return BacktestSuccess(result);
      }
    } catch (_) {}
    return BacktestIdle();
  }

  @override
  Map<String, dynamic>? toJson(BacktestState state) {
    if (state is BacktestSuccess) {
      return {'result': state.result.toJson()};
    }
    return null;
  }
}
EOF
cat > lib/features/market/domain/usecases/run_backtest.dart << 'EOF'
import '../backtest/backtest_engine.dart';
import '../backtest/backtest_result.dart';
import '../entities/candle.dart';

class RunBacktest {
  Future<BacktestResult> call(
    String symbol,
    String timeframe,
    DateTime? start,
    DateTime? end,
  ) async {
    // Ø¬Ù„Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù† Repo)
    final history = await repository.getHistoricalCandles(
      symbol: symbol,
      timeframe: timeframe,
      start: start,
      end: end,
    );

    final engine = BacktestEngine(history);
    return engine.run();
  }
}
EOF
cat > lib/features/market/presentation/pages/backtest/backtest_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/backtest/backtest_bloc.dart';
import '../../bloc/backtest/backtest_event.dart';
import '../../bloc/backtest/backtest_state.dart';

class BacktestPage extends StatelessWidget {
  final String symbol;

  BacktestPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Backtest â€” $symbol")),
      body: Column(
        children: [
          SizedBox(height: 8),
          ElevatedButton(
            onPressed: () {
              context.read<BacktestBloc>().add(
                    RunBacktestEvent(
                      symbol: symbol,
                      timeframe: "M1",
                      start: null,
                      end: null,
                    ),
                  );
            },
            child: Text("Start Backtest"),
          ),
          SizedBox(height: 8),
          Expanded(
            child: BlocBuilder<BacktestBloc, BacktestState>(
              builder: (context, state) {
                if (state is BacktestRunning) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is BacktestSuccess) {
                  final result = state.result;
                  return Column(
                    children: [
                      Text("Net Profit: ${result.netProfit.toStringAsFixed(2)}"),
                      Text("Win Rate: ${result.winRate.toStringAsFixed(2)}%"),
                      Text("Max Drawdown: ${result.maxDrawdown.toStringAsFixed(2)}"),
                      Expanded(
                        child: ListView.builder(
                          itemCount: result.equityCurve.length,
                          itemBuilder: (ctx, i) {
                            return ListTile(
                              title: Text(result.timestamps[i].toIso8601String()),
                              trailing: Text(result.equityCurve[i].toStringAsFixed(2)),
                            );
                          },
                        ),
                      ),
                    ],
                  );
                }
                if (state is BacktestError) {
                  return Center(
                    child: Text("Error: ${state.message}"),
                  );
                }
                return Center(child: Text("Press Start to Run Backtest"));
              },
            ),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/settings/settings_event.dart << 'EOF'
abstract class SettingsEvent {}

/// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
class LoadSettingsEvent extends SettingsEvent {}

/// ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
class UpdateStrategySettings extends SettingsEvent {
  final int emaShort;
  final int emaLong;
  final int stochPeriod;
  final int stochSmoothK;
  final int stochSmoothD;
  final double stopLossPct;
  final double takeProfitPct;

  UpdateStrategySettings({
    required this.emaShort,
    required this.emaLong,
    required this.stochPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
    required this.stopLossPct,
    required this.takeProfitPct,
  });
}
EOF
cat > lib/features/market/presentation/bloc/settings/settings_state.dart << 'EOF'
import '../../../domain/strategy/strategy_config.dart';

abstract class SettingsState {}

class SettingsIdle extends SettingsState {}

class SettingsLoading extends SettingsState {}

class SettingsLoaded extends SettingsState {
  final StrategyConfig config;
  SettingsLoaded(this.config);
}

class SettingsError extends SettingsState {
  final String message;
  SettingsError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/settings/settings_bloc.dart << 'EOF'
import 'package:hydrated_bloc/hydrated_bloc.dart';
import '../../../domain/strategy/strategy_config.dart';
import '../../data/storage/settings_storage.dart';
import 'settings_event.dart';
import 'settings_state.dart';

class SettingsBloc extends HydratedBloc<SettingsEvent, SettingsState> {
  final SettingsStorage _storage = SettingsStorage();

  SettingsBloc() : super(SettingsIdle()) {
    on<LoadSettingsEvent>(_onLoad);
    on<UpdateStrategySettings>(_onUpdate);
  }

  Future<void> _onLoad(
    LoadSettingsEvent event,
    Emitter<SettingsState> emit,
  ) async {
    emit(SettingsLoading());
    try {
      final settings = _storage.getStrategySettings() ??
          StrategyConfig(
            emaShort: 50,
            emaLong: 200,
            stochPeriod: 14,
            stochSmoothK: 3,
            stochSmoothD: 3,
            stopLossPct: 0.002,
            takeProfitPct: 0.005,
            minSignalIntervalSeconds: 60,
          );

      emit(SettingsLoaded(settings));
    } catch (e) {
      emit(SettingsError("Failed to load settings"));
    }
  }

  Future<void> _onUpdate(
    UpdateStrategySettings event,
    Emitter<SettingsState> emit,
  ) async {
    emit(SettingsLoading());
    try {
      final config = StrategyConfig(
        emaShort: event.emaShort,
        emaLong: event.emaLong,
        stochPeriod: event.stochPeriod,
        stochSmoothK: event.stochSmoothK,
        stochSmoothD: event.stochSmoothD,
        stopLossPct: event.stopLossPct,
        takeProfitPct: event.takeProfitPct,
        minSignalIntervalSeconds: 60,
      );

      await _storage.saveStrategySettings(config);
      emit(SettingsLoaded(config));
    } catch (e) {
      emit(SettingsError("Failed to update settings"));
    }
  }

  @override
  SettingsState? fromJson(Map<String, dynamic> json) {
    try {
      final config = StrategyConfig.fromJson(
        Map<String, dynamic>.from(json['config']),
      );
      return SettingsLoaded(config);
    } catch (_) {}
    return SettingsIdle();
  }

  @override
  Map<String, dynamic>? toJson(SettingsState state) {
    if (state is SettingsLoaded) {
      return {'config': state.config.toJson()};
    }
    return null;
  }
}
EOF
cat > lib/features/market/presentation/pages/settings/strategy_settings_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/settings/settings_bloc.dart';
import '../../bloc/settings/settings_event.dart';
import '../../bloc/settings/settings_state.dart';

class StrategySettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Strategy Settings")),
      body: Padding(
        padding: const EdgeInsets.all(12),
        child: BlocConsumer<SettingsBloc, SettingsState>(
          listener: (context, state) {
            if (state is SettingsError) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text(state.message)),
              );
            }
          },
          builder: (context, state) {
            if (state is SettingsLoading) {
              return Center(child: CircularProgressIndicator());
            }
            if (state is SettingsLoaded) {
              final config = state.config;
              final emaShortCtrl =
                  TextEditingController(text: config.emaShort.toString());
              final emaLongCtrl =
                  TextEditingController(text: config.emaLong.toString());
              final stochPeriodCtrl =
                  TextEditingController(text: config.stochPeriod.toString());
              final stochSmoothKCtrl =
                  TextEditingController(text: config.stochSmoothK.toString());
              final stochSmoothDCtrl =
                  TextEditingController(text: config.stochSmoothD.toString());
              final slCtrl =
                  TextEditingController(text: config.stopLossPct.toString());
              final tpCtrl =
                  TextEditingController(text: config.takeProfitPct.toString());

              return ListView(
                children: [
                  TextField(
                    controller: emaShortCtrl,
                    decoration: InputDecoration(labelText: "EMA Short"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: emaLongCtrl,
                    decoration: InputDecoration(labelText: "EMA Long"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: stochPeriodCtrl,
                    decoration: InputDecoration(labelText: "Stoch Period"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: stochSmoothKCtrl,
                    decoration: InputDecoration(labelText: "Stoch Smooth K"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: stochSmoothDCtrl,
                    decoration: InputDecoration(labelText: "Stoch Smooth D"),
                    keyboardType: TextInputType.number,
                  ),
                  TextField(
                    controller: slCtrl,
                    decoration: InputDecoration(labelText: "Stop Loss %"),
                    keyboardType:
                        TextInputType.numberWithOptions(decimal: true),
                  ),
                  TextField(
                    controller: tpCtrl,
                    decoration: InputDecoration(labelText: "Take Profit %"),
                    keyboardType:
                        TextInputType.numberWithOptions(decimal: true),
                  ),
                  SizedBox(height: 16),
                  ElevatedButton(
                    onPressed: () {
                      context.read<SettingsBloc>().add(
                            UpdateStrategySettings(
                              emaShort: int.parse(emaShortCtrl.text),
                              emaLong: int.parse(emaLongCtrl.text),
                              stochPeriod: int.parse(stochPeriodCtrl.text),
                              stochSmoothK: int.parse(stochSmoothKCtrl.text),
                              stochSmoothD: int.parse(stochSmoothDCtrl.text),
                              stopLossPct: double.parse(slCtrl.text),
                              takeProfitPct: double.parse(tpCtrl.text),
                            ),
                          );
                    },
                    child: Text("Save Settings"),
                  ),
                ],
              );
            }
            return SizedBox();
          },
        ),
      ),
    );
  }
}
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'

    // Listen to settings changes
    settingsBloc.stream.listen((state) {
      if (state is SettingsLoaded) {
        _applyNewSettings(state.config);
      }
    });
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'

  void _applyNewSettings(StrategyConfig config) {
    // Logic to update strategy with new params
    _strategyConfig = config;

    // Optionally reâ€‘evaluate current chart
    add(LoadChartHistory(symbol: symbol, timeframe: timeframe));
  }
EOF
cat >> lib/features/market/presentation/bloc/trading/trading_bloc.dart << 'EOF'

    // Listen for settings updates
    settingsBloc.stream.listen((state) {
      if (state is SettingsLoaded) {
        _strategyConfig = state.config;
      }
    });
EOF
cat >> lib/features/market/presentation/bloc/backtest/backtest_bloc.dart << 'EOF'

    settingsBloc.stream.listen((state) {
      if (state is SettingsLoaded) {
        _strategyConfig = state.config;
      }
    });
EOF
cat > lib/core/isolate/isolate_helpers.dart << 'EOF'
import 'dart:developer';
import 'package:flutter/foundation.dart';
import '../../features/market/domain/indicators/ema.dart';
import '../../features/market/domain/indicators/stochastic.dart';
import '../../features/market/domain/entities/candle.dart';

class IndicatorParams {
  final List<Candle> candles;
  final int emaShort;
  final int emaLong;
  final int stochPeriod;
  final int stochSmoothK;
  final int stochSmoothD;

  IndicatorParams({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.stochPeriod,
    required this.stochSmoothK,
    required this.stochSmoothD,
  });
}

class IndicatorResult {
  final List<double> emaShort;
  final List<double> emaLong;
  final List<double> stochK;
  final List<double> stochD;

  IndicatorResult({
    required this.emaShort,
    required this.emaLong,
    required this.stochK,
    required this.stochD,
  });
}

Future<IndicatorResult> computeIndicatorsInBackground(IndicatorParams params) async {
  return await compute(_calculateIndicators, params);
}

IndicatorResult _calculateIndicators(IndicatorParams params) {
  try {
    final emaShort = calculateEMA(params.candles, params.emaShort);
    final emaLong = calculateEMA(params.candles, params.emaLong);
    final stochK = calculateStochK(params.candles, params.stochPeriod, params.stochSmoothK);
    final stochD = smoothStochD(stochK, params.stochSmoothD);

    return IndicatorResult(
      emaShort: emaShort,
      emaLong: emaLong,
      stochK: stochK,
      stochD: stochD,
    );
  } catch (e) {
    log("Indicator isolate error: $e");
    rethrow;
  }
}
EOF
cat > lib/features/market/presentation/widgets/custom_chart/candles_painter.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/entities/candle.dart';

class CandlesPainter extends CustomPainter {
  final List<CandleEntity> candles;
  final double candleWidth;

  CandlesPainter({
    required this.candles,
    this.candleWidth = 6.0,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty) return;

    final paintRise = Paint()..color = Colors.green;
    final paintFall = Paint()..color = Colors.red;
    final paintLine = Paint()..color = Colors.black;

    // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù„ÙŠØ§ ÙˆØ§Ù„Ø¯Ù†ÙŠØ§ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø±Ø³Ù…
    final highs = candles.map((c) => c.high).toList();
    final lows = candles.map((c) => c.low).toList();

    final maxPrice = highs.reduce((a, b) => a > b ? a : b);
    final minPrice = lows.reduce((a, b) => a < b ? a : b);

    final priceRange = maxPrice - minPrice;

    final count = candles.length;
    final spacing = candleWidth + 2.0;
    final chartWidth = count * spacing;

    for (int i = 0; i < count; i++) {
      final c = candles[i];

      final x = i * spacing;
      final highY = size.height - ((c.high - minPrice) / priceRange) * size.height;
      final lowY = size.height - ((c.low - minPrice) / priceRange) * size.height;
      final openY = size.height - ((c.open - minPrice) / priceRange) * size.height;
      final closeY = size.height - ((c.close - minPrice) / priceRange) * size.height;

      final isRise = c.close >= c.open;
      final paint = isRise ? paintRise : paintFall;

      // Ø®Ø·ÙˆØ· High-Low
      canvas.drawLine(
        Offset(x + candleWidth / 2, highY),
        Offset(x + candleWidth / 2, lowY),
        paintLine,
      );

      // Ù…Ø³ØªØ·ÙŠÙ„ Open-Close
      final rect = Rect.fromLTRB(
        x,
        openY,
        x + candleWidth,
        closeY,
      );
      canvas.drawRect(rect, paint);
    }
  }

  @override
  bool shouldRepaint(covariant CandlesPainter old) =>
      old.candles != candles;
}
EOF
cat > lib/features/market/presentation/widgets/custom_chart/indicator_painter.dart << 'EOF'
import 'package:flutter/material.dart';

class IndicatorPainter extends CustomPainter {
  final List<Offset> linePoints;
  final Color color;

  IndicatorPainter({required this.linePoints, required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    if (linePoints.isEmpty) return;

    final paint = Paint()
      ..color = color
      ..strokeWidth = 1.5
      ..style = PaintingStyle.stroke;

    canvas.drawPoints(PointMode.polygon, linePoints, paint);
  }

  @override
  bool shouldRepaint(covariant IndicatorPainter old) =>
      old.linePoints != linePoints;
}
EOF
cat > lib/features/market/presentation/widgets/custom_chart/drawing_painter.dart << 'EOF'
import 'package:flutter/material.dart';

class DrawingPainter extends CustomPainter {
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  DrawingPainter({
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paintTrend = Paint()
      ..color = Colors.yellow
      ..strokeWidth = 2.0;

    final paintHLine = Paint()
      ..color = Colors.orange
      ..strokeWidth = 1.0;

    // Trendlines
    for (var line in trendlines) {
      if (line.length >= 2) {
        canvas.drawLine(line[0], line[1], paintTrend);
      }
    }

    // Horizontal lines
    for (var y in horizontalLines) {
      canvas.drawLine(
        Offset(0, y),
        Offset(size.width, y),
        paintHLine,
      );
    }
  }

  @override
  bool shouldRepaint(covariant DrawingPainter old) {
    return old.trendlines != trendlines ||
        old.horizontalLines != horizontalLines;
  }
}
EOF
cat > lib/features/market/presentation/widgets/custom_chart/custom_chart_widget.dart << 'EOF'
import 'package:flutter/material.dart';
import '../bloc/chart/chart_bloc.dart';
import '../bloc/chart/chart_state.dart';
import 'candles_painter.dart';
import 'indicator_painter.dart';
import 'drawing_painter.dart';

class CustomChartWidget extends StatelessWidget {
  final ChartState state;
  final List<List<Offset>> trendlines;
  final List<double> horizontalLines;

  CustomChartWidget({
    required this.state,
    required this.trendlines,
    required this.horizontalLines,
  });

  @override
  Widget build(BuildContext context) {
    if (state is ChartLoaded) {
      final candles = (state as ChartLoaded).candles;

      // Ø¨Ù†Ø§Ø¡ Ù†Ù‚Ø§Ø· Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
      final ema50 = List<Offset>.generate(
        candles.length,
        (i) => Offset(i.toDouble(), (state as ChartLoaded).indicators[0].values[i]),
      );
      final ema200 = List<Offset>.generate(
        candles.length,
        (i) => Offset(i.toDouble(), (state as ChartLoaded).indicators[1].values[i]),
      );

      return LayoutBuilder(builder: (context, constraints) {
        return CustomPaint(
          size: Size(constraints.maxWidth, constraints.maxHeight),
          painter: CandlesPainter(candles: candles),
          foregroundPainter: DrawingPainter(
            trendlines: trendlines,
            horizontalLines: horizontalLines,
          ),
          child: Stack(
            children: [
              CustomPaint(
                size: Size(constraints.maxWidth, constraints.maxHeight),
                painter: IndicatorPainter(linePoints: ema50, color: Colors.blue),
              ),
              CustomPaint(
                size: Size(constraints.maxWidth, constraints.maxHeight),
                painter: IndicatorPainter(linePoints: ema200, color: Colors.orange),
              ),
            ],
          ),
        );
      });
    }
    return Container();
  }
}
EOF
cat >> lib/features/market/data/repositories/market_repository_impl.dart << 'EOF'

  @override
  Future<List<CandleModel>> getHistoricalCandlesPage({
    required String symbol,
    required String timeframe,
    required int count,
    DateTime? to,
  }) async {
    final params = {
      "instrument": symbol,
      "granularity": timeframe,
      "count": count.toString(),
      if (to != null) "to": to.toUtc().toIso8601String(),
    };

    final response = await _restClient!.getCandles(params);

    return response;
  }
EOF
cat > tmp_pagination.patch << 'EOF'
--- a/lib/features/market/presentation/bloc/chart/chart_bloc.dart
+++ b/lib/features/market/presentation/bloc/chart/chart_bloc.dart
@@
   Future<void> _onLoadMore(
     LoadMoreCandles event,
     Emitter<ChartState> emit,
   ) async {
     if (_isLoadingMore || _candles.isEmpty) return;
     _isLoadingMore = true;
 
     try {
-      final oldest = _candles.first.time;
-
-      final more = await repository.getHistoricalCandles(
-        symbol: symbol,
-        timeframe: timeframe,
-        count: _loadCount,
-        to: oldest.subtract(Duration(seconds: 1)),
-      );
+      final oldest = _candles.first.time;
+      final more = await repository.getHistoricalCandlesPage(
+        symbol: symbol,
+        timeframe: timeframe,
+        count: _loadCount,
+        to: oldest.subtract(Duration(seconds: 1)),
+      );
 
       if (more.isNotEmpty) {
         _candles = [...more, ..._candles];
         emit(ChartLoaded(candles: _candles));
       } else {
         emit(ChartLoaded(candles: _candles, canLoadMore: false));
       }
@@
     _isLoadingMore = false;
   }
EOF
cat > lib/features/market/domain/trading/orders/order_request.dart << 'EOF'
class OrderRequest {
  final String instrument;
  final int units; // >0 for buy, <0 for sell
  final String type; // MARKET / LIMIT / STOP
  final String timeInForce; // GTC / FOK / IOC
  final double? price; // Only for LIMIT/STOP

  OrderRequest({
    required this.instrument,
    required this.units,
    required this.type,
    this.timeInForce = "FOK",
    this.price,
  });

  Map<String, dynamic> toJson() {
    final order = {
      "instrument": instrument,
      "units": units.toString(),
      "type": type,
      "timeInForce": timeInForce,
      "positionFill": "DEFAULT",
    };
    if (price != null) order["price"] = price.toString();
    return {"order": order};
  }
}
EOF
cat >> lib/features/market/data/repositories/market_repository_impl.dart << 'EOF'

  @override
  Future<Map<String, dynamic>> executeOrder(OrderRequest request) async {
    final body = request.toJson();
    final res = await _restClient!.placeOrder(body);
    return res;
  }
EOF
cat > lib/features/market/presentation/bloc/trading_real/trading_real_event.dart << 'EOF'
import '../../../domain/trading/orders/order_request.dart';

abstract class TradingRealEvent {}

class SubmitRealOrder extends TradingRealEvent {
  final OrderRequest order;
  SubmitRealOrder(this.order);
}
EOF
cat > lib/features/market/presentation/bloc/trading_real/trading_real_state.dart << 'EOF'
abstract class TradingRealState {}

class RealTradingIdle extends TradingRealState {}

class RealTradingInProgress extends TradingRealState {}

class RealTradingSuccess extends TradingRealState {
  final Map<String, dynamic> result;
  RealTradingSuccess(this.result);
}

class RealTradingError extends TradingRealState {
  final String message;
  RealTradingError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/trading_real/trading_real_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/repositories/market_repository.dart';
import '../../../domain/trading/orders/order_request.dart';
import 'trading_real_event.dart';
import 'trading_real_state.dart';

class TradingRealBloc extends Bloc<TradingRealEvent, TradingRealState> {
  final MarketRepository repository;

  TradingRealBloc(this.repository) : super(RealTradingIdle()) {
    on<SubmitRealOrder>(_onSubmitOrder);
  }

  Future<void> _onSubmitOrder(
    SubmitRealOrder event,
    Emitter<TradingRealState> emit,
  ) async {
    emit(RealTradingInProgress());
    try {
      final res = await repository.executeOrder(event.order);
      emit(RealTradingSuccess(res));
    } catch (e) {
      emit(RealTradingError("Failed to execute real order: \$e"));
    }
  }
}
EOF
cat > lib/features/market/presentation/widgets/real_trade_dialog.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/trading_real/trading_real_bloc.dart';
import '../../bloc/trading_real/trading_real_event.dart';
import '../../../domain/trading/orders/order_request.dart';

class RealTradeDialog extends StatefulWidget {
  final String symbol;
  RealTradeDialog({required this.symbol});

  @override
  _RealTradeDialogState createState() => _RealTradeDialogState();
}

class _RealTradeDialogState extends State<RealTradeDialog> {
  final TextEditingController _unitsCtrl = TextEditingController();
  String _type = "MARKET";
  final priceCtrl = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Place Real Order"),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(
            controller: _unitsCtrl,
            decoration: InputDecoration(labelText: "Units (+ buy, - sell)"),
            keyboardType: TextInputType.number,
          ),
          DropdownButton<String>(
            value: _type,
            items: ["MARKET", "LIMIT", "STOP"]
                .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                .toList(),
            onChanged: (v) => setState(() => _type = v!),
          ),
          if (_type != "MARKET")
            TextField(
              controller: priceCtrl,
              decoration: InputDecoration(labelText: "Price"),
              keyboardType: TextInputType.numberWithOptions(decimal: true),
            ),
        ],
      ),
      actions: [
        ElevatedButton(
          onPressed: () {
            final units = int.tryParse(_unitsCtrl.text) ?? 0;
            final price = _type == "MARKET"
                ? null
                : double.tryParse(priceCtrl.text);
            final request = OrderRequest(
              instrument: widget.symbol,
              units: units,
              type: _type,
              price: price,
            );
            context.read<TradingRealBloc>().add(SubmitRealOrder(request));
            Navigator.pop(context);
          },
          child: Text("Submit"),
        ),
      ],
    );
  }
}
EOF
cat > lib/core/network/oanda_rest_config.dart << 'EOF'
class OandaConfig {
  static const bool useLive = false; // false = practice, true = live
  static String get baseUrl => useLive
      ? "https://api-fxtrade.oanda.com/v3"
      : "https://api-fxpractice.oanda.com/v3";
}
EOF
cat >> lib/core/network/oanda_rest_client.dart << 'EOF'

  Future<Map<String, dynamic>> fetchOpenPositions() async {
    final endpoint = "/accounts/\$accountId/openPositions";
    final response = await _dio.get(endpoint);
    return response.data;
  }

  Future<Map<String, dynamic>> closePosition(String instrument) async {
    final endpoint = "/accounts/\$accountId/positions/\$instrument/close";
    final response = await _dio.put(endpoint);
    return response.data;
  }

  Future<Map<String, dynamic>> modifyPosition(String instrument, Map<String, dynamic> body) async {
    final endpoint = "/accounts/\$accountId/positions/\$instrument";
    final response = await _dio.put(endpoint, data: body);
    return response.data;
  }
EOF
cat >> lib/features/market/data/repositories/market_repository_impl.dart << 'EOF'

  @override
  Future<Map<String, dynamic>> getOpenPositions() async {
    return await _restClient!.fetchOpenPositions();
  }

  @override
  Future<Map<String, dynamic>> closePosition(String instrument) async {
    return await _restClient!.closePosition(instrument);
  }

  @override
  Future<Map<String, dynamic>> modifyPosition(String instrument, Map<String, dynamic> body) async {
    return await _restClient!.modifyPosition(instrument, body);
  }
EOF
cat > lib/features/market/data/models/position/position_model.dart << 'EOF'
class PositionModel {
  final String instrument;
  final double units;
  final double unrealizedPL;
  final double averagePrice;
  final double? stopLoss;
  final double? takeProfit;

  PositionModel({
    required this.instrument,
    required this.units,
    required this.unrealizedPL,
    required this.averagePrice,
    this.stopLoss,
    this.takeProfit,
  });

  factory PositionModel.fromJson(Map<String, dynamic> json) {
    return PositionModel(
      instrument: json["instrument"],
      units: double.parse(json["units"].toString()),
      unrealizedPL: double.parse(json["unrealizedPL"].toString()),
      averagePrice: double.parse(json["averagePrice"].toString()),
      stopLoss: json["stopLoss"] != null ? double.parse(json["stopLoss"].toString()) : null,
      takeProfit: json["takeProfit"] != null ? double.parse(json["takeProfit"].toString()) : null,
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/positions/positions_event.dart << 'EOF'
abstract class PositionsEvent {}

class LoadPositions extends PositionsEvent {}

class ClosePositionEvent extends PositionsEvent {
  final String instrument;
  ClosePositionEvent(this.instrument);
}

class ModifyPositionEvent extends PositionsEvent {
  final String instrument;
  final double stopLoss;
  final double takeProfit;
  ModifyPositionEvent({
    required this.instrument,
    required this.stopLoss,
    required this.takeProfit,
  });
}
EOF
cat > lib/features/market/presentation/bloc/positions/positions_state.dart << 'EOF'
abstract class PositionsState {}

class PositionsIdle extends PositionsState {}

class PositionsLoading extends PositionsState {}

class PositionsLoaded extends PositionsState {
  final List positionList;
  PositionsLoaded(this.positionList);
}

class PositionsError extends PositionsState {
  final String message;
  PositionsError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/positions/positions_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/repositories/market_repository.dart';
import '../../../data/models/position/position_model.dart';
import 'positions_event.dart';
import 'positions_state.dart';

class PositionsBloc extends Bloc<PositionsEvent, PositionsState> {
  final MarketRepository repository;

  PositionsBloc(this.repository) : super(PositionsIdle()) {
    on<LoadPositions>(_onLoad);
    on<ClosePositionEvent>(_onClose);
    on<ModifyPositionEvent>(_onModify);
  }

  Future<void> _onLoad(LoadPositions event, Emitter<PositionsState> emit) async {
    emit(PositionsLoading());
    try {
      final res = await repository.getOpenPositions();
      final positionsJson = res["positions"] as List<dynamic>;
      final list = positionsJson
          .map((e) => PositionModel.fromJson(Map<String, dynamic>.from(e)))
          .toList();
      emit(PositionsLoaded(list));
    } catch (e) {
      emit(PositionsError("Failed to load positions"));
    }
  }

  Future<void> _onClose(ClosePositionEvent event, Emitter<PositionsState> emit) async {
    emit(PositionsLoading());
    try {
      await repository.closePosition(event.instrument);
      add(LoadPositions());
    } catch (e) {
      emit(PositionsError("Failed to close position"));
    }
  }

  Future<void> _onModify(ModifyPositionEvent event, Emitter<PositionsState> emit) async {
    emit(PositionsLoading());
    try {
      final body = {
        "stopLoss": {"price": event.stopLoss.toString()},
        "takeProfit": {"price": event.takeProfit.toString()},
      };
      await repository.modifyPosition(event.instrument, body);
      add(LoadPositions());
    } catch (e) {
      emit(PositionsError("Failed to modify position"));
    }
  }
}
EOF
cat > lib/features/market/presentation/pages/positions/positions_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/positions/positions_bloc.dart';
import '../../bloc/positions/positions_event.dart';
import '../../bloc/positions/positions_state.dart';
import '../../../data/models/position/position_model.dart';

class PositionsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Open Positions")),
      body: Column(
        children: [
          ElevatedButton(
            onPressed: () => context.read<PositionsBloc>().add(LoadPositions()),
            child: Text("Refresh"),
          ),
          Expanded(
            child: BlocBuilder<PositionsBloc, PositionsState>(
              builder: (context, state) {
                if (state is PositionsLoading) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is PositionsLoaded) {
                  final positions = state.positionList;
                  if (positions.isEmpty) {
                    return Center(child: Text("No open positions"));
                  }
                  return ListView.builder(
                    itemCount: positions.length,
                    itemBuilder: (ctx, i) {
                      final PositionModel p = positions[i];
                      return ListTile(
                        title: Text("${p.instrument} - Units: ${p.units.toString()}"),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text("Avg Price: ${p.averagePrice.toStringAsFixed(4)}"),
                            Text("Unrealized P/L: ${p.unrealizedPL.toStringAsFixed(2)}"),
                            Text("SL: ${p.stopLoss?.toStringAsFixed(4) ?? '-'}"),
                            Text("TP: ${p.takeProfit?.toStringAsFixed(4) ?? '-'}"),
                          ],
                        ),
                        trailing: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            IconButton(
                              icon: Icon(Icons.edit),
                              onPressed: () => _showModifyDialog(context, p),
                            ),
                            IconButton(
                              icon: Icon(Icons.close),
                              onPressed: () => context.read<PositionsBloc>().add(ClosePositionEvent(p.instrument)),
                            ),
                          ],
                        ),
                      );
                    },
                  );
                }
                if (state is PositionsError) {
                  return Center(child: Text("Error: ${state.message}"));
                }
                return Container();
              },
            ),
          ),
        ],
      ),
    );
  }

  void _showModifyDialog(BuildContext context, PositionModel p) {
    final stopCtrl = TextEditingController(text: p.stopLoss?.toStringAsFixed(4) ?? '');
    final tpCtrl = TextEditingController(text: p.takeProfit?.toStringAsFixed(4) ?? '');

    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text("Modify Position"),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: stopCtrl,
              decoration: InputDecoration(labelText: "Stop Loss"),
              keyboardType: TextInputType.numberWithOptions(decimal: true),
            ),
            TextField(
              controller: tpCtrl,
              decoration: InputDecoration(labelText: "Take Profit"),
              keyboardType: TextInputType.numberWithOptions(decimal: true),
            ),
          ],
        ),
        actions: [
          ElevatedButton(
            onPressed: () {
              final sl = double.tryParse(stopCtrl.text) ?? 0.0;
              final tp = double.tryParse(tpCtrl.text) ?? 0.0;
              context.read<PositionsBloc>().add(ModifyPositionEvent(
                instrument: p.instrument,
                stopLoss: sl,
                takeProfit: tp,
              ));
              Navigator.pop(context);
            },
            child: Text("Save"),
          ),
        ],
      ),
    );
  }
}
EOF
cat >> lib/core/network/retry_interceptor.dart << 'EOF'
import 'package:dio/dio.dart';
import 'package:dio_retry/dio_retry.dart';
import 'package:dio_retry/strategies/exponential_retry_strategy.dart';

class RestRetryInterceptor {
  static void apply(Dio dio) {
    dio.interceptors.add(
      RetryInterceptor(
        dio: dio,
        logPrint: print,
        retryDelays: ExponentialRetryStrategy().delays,
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/audit/audit_log.dart << 'EOF'
enum AuditType {
  tradeExecuted,
  tradeClosed,
  apiError,
  strategyChanged,
  settingsChanged,
  websocketConnected,
  websocketDisconnected,
  general,
}

class AuditLog {
  final DateTime timestamp;
  final AuditType type;
  final String message;
  final Map<String, dynamic>? data;

  AuditLog({
    required this.timestamp,
    required this.type,
    required this.message,
    this.data,
  });

  Map<String, dynamic> toJson() {
    return {
      "timestamp": timestamp.toIso8601String(),
      "type": type.toString(),
      "message": message,
      "data": data,
    };
  }

  factory AuditLog.fromJson(Map<String, dynamic> json) {
    return AuditLog(
      timestamp: DateTime.parse(json["timestamp"]),
      type: AuditType.values.firstWhere(
        (e) => e.toString() == json["type"],
        orElse: () => AuditType.general,
      ),
      message: json["message"],
      data: json["data"] != null
          ? Map<String, dynamic>.from(json["data"])
          : null,
    );
  }
}
EOF
cat > lib/features/market/data/adapters/audit_log_adapter.dart << 'EOF'
import 'package:hive/hive.dart';
import '../../../domain/audit/audit_log.dart';

class AuditLogAdapter extends TypeAdapter<AuditLog> {
  @override
  final typeId = 1;

  @override
  AuditLog read(BinaryReader reader) {
    final json = reader.readString();
    return AuditLog.fromJson(Map<String, dynamic>.from(jsonDecode(json)));
  }

  @override
  void write(BinaryWriter writer, AuditLog obj) {
    writer.writeString(jsonEncode(obj.toJson()));
  }
}
EOF
cat > lib/features/market/data/repositories/audit/audit_repository.dart << 'EOF'
import 'package:hive/hive.dart';
import '../../../domain/audit/audit_log.dart';

class AuditRepository {
  static const String _boxName = "audit_logs";

  Future<void> init() async {
    await Hive.openBox<AuditLog>(_boxName);
  }

  Future<void> addLog(AuditLog log) async {
    final box = Hive.box<AuditLog>(_boxName);
    await box.add(log);
  }

  List<AuditLog> getAllLogs() {
    final box = Hive.box<AuditLog>(_boxName);
    return box.values.toList();
  }

  Future<void> clearLogs() async {
    final box = Hive.box<AuditLog>(_boxName);
    await box.clear();
  }
}
EOF
cat > lib/features/market/presentation/bloc/audit/audit_event.dart << 'EOF'
abstract class AuditEvent {}

class LoadAuditLogs extends AuditEvent {}

class ClearAuditLogs extends AuditEvent {}
EOF
cat > lib/features/market/presentation/bloc/audit/audit_state.dart << 'EOF'
abstract class AuditState {}

class AuditIdle extends AuditState {}

class AuditLoading extends AuditState {}

class AuditLoaded extends AuditState {
  final List logs;
  AuditLoaded(this.logs);
}

class AuditError extends AuditState {
  final String message;
  AuditError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/audit/audit_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../data/repositories/audit/audit_repository.dart';
import 'audit_event.dart';
import 'audit_state.dart';

class AuditBloc extends Bloc<AuditEvent, AuditState> {
  final AuditRepository auditRepository;

  AuditBloc(this.auditRepository) : super(AuditIdle()) {
    on<LoadAuditLogs>(_onLoad);
    on<ClearAuditLogs>(_onClear);
  }

  Future<void> _onLoad(LoadAuditLogs event, Emitter<AuditState> emit) async {
    emit(AuditLoading());
    try {
      final logs = auditRepository.getAllLogs();
      emit(AuditLoaded(logs));
    } catch (e) {
      emit(AuditError("Failed to load logs"));
    }
  }

  Future<void> _onClear(ClearAuditLogs event, Emitter<AuditState> emit) async {
    await auditRepository.clearLogs();
    emit(AuditLoaded([]));
  }
}
EOF
cat > lib/features/market/presentation/pages/audit/audit_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/audit/audit_bloc.dart';
import '../../bloc/audit/audit_event.dart';
import '../../bloc/audit/audit_state.dart';

class AuditPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Audit Trail")),
      body: Column(
        children: [
          ElevatedButton(
            onPressed: () => context.read<AuditBloc>().add(LoadAuditLogs()),
            child: Text("Refresh Logs"),
          ),
          Expanded(
            child: BlocBuilder<AuditBloc, AuditState>(
              builder: (context, state) {
                if (state is AuditLoading) {
                  return Center(child: CircularProgressIndicator());
                }
                if (state is AuditLoaded) {
                  if (state.logs.isEmpty) return Center(child: Text("No logs"));
                  return ListView.builder(
                    itemCount: state.logs.length,
                    itemBuilder: (ctx, i) {
                      final log = state.logs[i];
                      return ListTile(
                        title: Text(log.message),
                        subtitle: Text(log.timestamp.toString()),
                      );
                    },
                  );
                }
                return Container();
              },
            ),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/indicators/advanced/rsi_calculator.dart << 'EOF'
import '../entities/candle.dart';

class RsiResult {
  final List<double> values;
  RsiResult(this.values);
}

class RsiCalculator {
  static RsiResult calculate(List<CandleEntity> data, {int period = 14}) {
    final List<double> deltas = [];
    for (int i = 1; i < data.length; i++) {
      deltas.add(data[i].close - data[i - 1].close);
    }

    List<double> gains = [];
    List<double> losses = [];

    for (var d in deltas) {
      gains.add(d > 0 ? d : 0);
      losses.add(d < 0 ? -d : 0);
    }

    List<double> avgGain = [];
    List<double> avgLoss = [];

    double sumGain = gains.take(period).reduce((a, b) => a + b);
    double sumLoss = losses.take(period).reduce((a, b) => a + b);

    avgGain.add(sumGain / period);
    avgLoss.add(sumLoss / period);

    for (int i = period; i < gains.length; i++) {
      double gain = gains[i];
      double loss = losses[i];

      avgGain.add((avgGain.last * (period - 1) + gain) / period);
      avgLoss.add((avgLoss.last * (period - 1) + loss) / period);
    }

    List<double> rsi = List.filled(data.length, 0.0);
    for (int i = period; i < avgGain.length + period; i++) {
      double rs = avgGain[i - period] / (avgLoss[i - period] == 0 ? 1 : avgLoss[i - period]);
      rsi[i] = 100 - (100 / (1 + rs));
    }

    return RsiResult(rsi);
  }
}
EOF
cat > lib/features/market/domain/indicators/advanced/macd_calculator.dart << 'EOF'
import '../entities/candle.dart';
import 'package:collection/collection.dart';

class MacdResult {
  final List<double> macdLine;
  final List<double> signalLine;
  final List<double> histogram;

  MacdResult({
    required this.macdLine,
    required this.signalLine,
    required this.histogram,
  });
}

class MacdCalculator {
  static MacdResult calculate(
    List<CandleEntity> data, {
    int fastPeriod = 12,
    int slowPeriod = 26,
    int signalPeriod = 9,
  }) {
    List<double> closePrices = data.map((c) => c.close).toList();

    List<double> emaFast = _ema(closePrices, fastPeriod);
    List<double> emaSlow = _ema(closePrices, slowPeriod);

    List<double> macdLine = List.generate(closePrices.length, (i) {
      return emaFast[i] - emaSlow[i];
    });

    List<double> signalLine = _ema(macdLine, signalPeriod);

    List<double> histogram = List.generate(closePrices.length, (i) {
      return macdLine[i] - signalLine[i];
    });

    return MacdResult(
      macdLine: macdLine,
      signalLine: signalLine,
      histogram: histogram,
    );
  }

  static List<double> _ema(List<double> data, int period) {
    List<double> kList = [];
    double multiplier = 2 / (period + 1);

    List<double> ema = [];
    ema.add(data.take(period).reduce((a, b) => a + b) / period);

    for (int i = period; i < data.length; i++) {
      ema.add((data[i] - ema.last) * multiplier + ema.last);
    }

    return ema;
  }
}
EOF
cat > lib/features/market/domain/indicators/advanced/bollinger_calculator.dart << 'EOF'
import '../entities/candle.dart';
import 'dart:math';

class BollingerResult {
  final List<double> middleBand;
  final List<double> upperBand;
  final List<double> lowerBand;

  BollingerResult({
    required this.middleBand,
    required this.upperBand,
    required this.lowerBand,
  });
}

class BollingerCalculator {
  static BollingerResult calculate(
    List<CandleEntity> data, {
    int period = 20,
    double stdDevMultiplier = 2.0,
  }) {
    List<double> closes = data.map((c) => c.close).toList();

    List<double> middle = [];
    List<double> upper = [];
    List<double> lower = [];

    for (int i = 0; i < closes.length; i++) {
      if (i + 1 >= period) {
        List<double> window = closes.sublist(i + 1 - period, i + 1);
        double mean = window.reduce((a, b) => a + b) / period;
        double sumSq = window.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b);
        double stdDev = sqrt(sumSq / period);

        middle.add(mean);
        upper.add(mean + stdDevMultiplier * stdDev);
        lower.add(mean - stdDevMultiplier * stdDev);
      } else {
        middle.add(0);
        upper.add(0);
        lower.add(0);
      }
    }
    return BollingerResult(
      middleBand: middle,
      upperBand: upper,
      lowerBand: lower,
    );
  }
}
EOF
cat > lib/features/market/domain/alerts/smart/smart_alert.dart << 'EOF'
enum SmartAlertType {
  rsiBelow,
  macdCrossUp,
  bollingerBreakoutUpper,
}

class SmartAlertCondition {
  final SmartAlertType type;
  final int durationSeconds;
  final double threshold;

  SmartAlertCondition({
    required this.type,
    required this.durationSeconds,
    required this.threshold,
  });
}

class SmartAlert {
  final SmartAlertCondition condition;
  final String instrument;
  bool isTriggered = false;

  SmartAlert({required this.condition, required this.instrument});
}
EOF
cat > lib/features/market/domain/alerts/smart/engine/smart_alert_engine.dart << 'EOF'
import 'dart:collection';
import '../../entities/candle.dart';
import '../smart/smart_alert.dart';
import '../../../indicators/advanced/rsi_calculator.dart';
import '../../../indicators/advanced/macd_calculator.dart';
import '../../../indicators/advanced/bollinger_calculator.dart';

class SmartAlertEngine {
  final List<CandleEntity> history;
  final List<SmartAlert> activeAlerts;
  final int checkIntervalSeconds;

  SmartAlertEngine({
    required this.history,
    required this.activeAlerts,
    this.checkIntervalSeconds = 60,
  });

  void processNewCandle(CandleEntity candle) {
    history.add(candle);

    for (var alert in activeAlerts) {
      if (alert.isTriggered) continue;

      switch (alert.condition.type) {
        case SmartAlertType.rsiBelow:
          _checkRsiBelow(alert);
          break;
        case SmartAlertType.macdCrossUp:
          _checkMacdCross(alert);
          break;
        case SmartAlertType.bollingerBreakoutUpper:
          _checkBollingerUpper(alert);
          break;
      }
    }
  }

  void _checkRsiBelow(SmartAlert alert) {
    final rsi = RsiCalculator.calculate(history, period: alert.condition.threshold.toInt()).values;
    int countBelow = 0;
    for (int i = rsi.length - alert.condition.durationSeconds; i < rsi.length; i++) {
      if (rsi[i] < alert.condition.threshold) countBelow++;
    }
    if (countBelow >= alert.condition.durationSeconds) {
      alert.isTriggered = true;
    }
  }

  void _checkMacdCross(SmartAlert alert) {
    final macd = MacdCalculator.calculate(history).macdLine;
    final signal = MacdCalculator.calculate(history).signalLine;
    if (macd.isNotEmpty && signal.isNotEmpty) {
      int n = macd.length;
      if (n > 1 && macd[n - 2] < signal[n - 2] && macd[n - 1] > signal[n - 1]) {
        alert.isTriggered = true;
      }
    }
  }

  void _checkBollingerUpper(SmartAlert alert) {
    final bb = BollingerCalculator.calculate(history);
    double lastPrice = history.last.close;
    if (lastPrice > bb.upperBand.last) alert.isTriggered = true;
  }
}
EOF
cat > lib/features/market/presentation/bloc/smart_alert/smart_alert_event.dart << 'EOF'
import '../../../domain/alerts/smart/smart_alert.dart';

abstract class SmartAlertEvent {}

class AddSmartAlert extends SmartAlertEvent {
  final SmartAlert alert;
  AddSmartAlert(this.alert);
}

class RemoveSmartAlert extends SmartAlertEvent {
  final int index;
  RemoveSmartAlert(this.index);
}

class CheckSmartAlerts extends SmartAlertEvent {
  final dynamic newCandle;
  CheckSmartAlerts(this.newCandle);
}
EOF
cat > lib/features/market/presentation/bloc/smart_alert/smart_alert_state.dart << 'EOF'
abstract class SmartAlertState {}

class SmartAlertIdle extends SmartAlertState {}

class SmartAlertUpdated extends SmartAlertState {
  final List alerts;
  SmartAlertUpdated(this.alerts);
}
EOF
cat > lib/features/market/presentation/bloc/smart_alert/smart_alert_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/alerts/smart/smart_alert.dart';
import '../../../domain/alerts/smart/engine/smart_alert_engine.dart';
import 'smart_alert_event.dart';
import 'smart_alert_state.dart';

class SmartAlertBloc extends Bloc<SmartAlertEvent, SmartAlertState> {
  final List<CandleEntity> _history = [];
  final List<SmartAlert> _alerts = [];

  SmartAlertBloc() : super(SmartAlertIdle()) {
    on<AddSmartAlert>((event, emit) {
      _alerts.add(event.alert);
      emit(SmartAlertUpdated(List.from(_alerts)));
    });

    on<RemoveSmartAlert>((event, emit) {
      _alerts.removeAt(event.index);
      emit(SmartAlertUpdated(List.from(_alerts)));
    });

    on<CheckSmartAlerts>((event, emit) {
      final engine = SmartAlertEngine(history: _history, activeAlerts: _alerts);
      engine.processNewCandle(event.newCandle);
      emit(SmartAlertUpdated(List.from(_alerts)));
    });
  }
}
EOF
cat > lib/features/market/presentation/widgets/smart_alert_dialog.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/alerts/smart/smart_alert.dart';

class SmartAlertDialog extends StatefulWidget {
  final String symbol;
  SmartAlertDialog({required this.symbol});

  @override
  _SmartAlertDialogState createState() => _SmartAlertDialogState();
}

class _SmartAlertDialogState extends State<SmartAlertDialog> {
  SmartAlertType _selectedType = SmartAlertType.rsiBelow;
  final TextEditingController _threshold = TextEditingController();
  final TextEditingController _duration = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Add Smart Alert"),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          DropdownButton<SmartAlertType>(
            value: _selectedType,
            items: SmartAlertType.values
                .map((t) => DropdownMenuItem(value: t, child: Text(t.toString())))
                .toList(),
            onChanged: (v) => setState(() => _selectedType = v!),
          ),
          TextField(
            controller: _threshold,
            decoration: InputDecoration(labelText: "Threshold"),
            keyboardType: TextInputType.numberWithOptions(decimal: true),
          ),
          TextField(
            controller: _duration,
            decoration: InputDecoration(labelText: "Duration (seconds)"),
            keyboardType: TextInputType.number,
          ),
        ],
      ),
      actions: [
        ElevatedButton(
          onPressed: () {
            final th = double.tryParse(_threshold.text) ?? 0;
            final dur = int.tryParse(_duration.text) ?? 0;
            final condition = SmartAlertCondition(
              type: _selectedType,
              durationSeconds: dur,
              threshold: th,
            );
            final alert = SmartAlert(instrument: widget.symbol, condition: condition);
            Navigator.pop(context, alert);
          },
          child: Text("Add"),
        ),
      ],
    );
  }
}
EOF
cat > lib/features/market/domain/analytics/analytics_calculator.dart << 'EOF'
class AnalyticsResult {
  final double netProfit;
  final double winRate;
  final double sharpRatio;
  final double expectancy;
  final int totalTrades;
  final int wins;
  final int losses;

  AnalyticsResult({
    required this.netProfit,
    required this.winRate,
    required this.sharpRatio,
    required this.expectancy,
    required this.totalTrades,
    required this.wins,
    required this.losses,
  });
}

class AnalyticsCalculator {
  static AnalyticsResult calculate(List<double> profits) {
    final n = profits.length;
    if (n == 0) {
      return AnalyticsResult(
        netProfit: 0,
        winRate: 0,
        sharpRatio: 0,
        expectancy: 0,
        totalTrades: 0,
        wins: 0,
        losses: 0,
      );
    }

    double netProfit = profits.reduce((a, b) => a + b);

    int wins = profits.where((p) => p > 0).length;
    int losses = profits.where((p) => p <= 0).length;

    double winRate = wins / n * 100;

    double avgProfit = netProfit / n;

    double variance = profits
        .map((p) => (p - avgProfit) * (p - avgProfit))
        .reduce((a, b) => a + b) / n;
    double stdDev = variance.sqrt();

    double sharpRatio = stdDev == 0 ? 0 : avgProfit / stdDev;

    double expectancy = ((wins / n) * (profits.where((p) => p > 0).reduce((a, b) => a + b) / wins)) -
        ((losses / n) * (profits.where((p) => p <= 0).reduce((a, b) => a + b) / (losses == 0 ? 1 : losses)));

    return AnalyticsResult(
      netProfit: netProfit,
      winRate: winRate,
      sharpRatio: sharpRatio,
      expectancy: expectancy,
      totalTrades: n,
      wins: wins,
      losses: losses,
    );
  }
}
EOF
cat > lib/features/market/presentation/bloc/analytics/analytics_event.dart << 'EOF'
abstract class AnalyticsEvent {}

class ComputeAnalytics extends AnalyticsEvent {
  final List<double> profits;
  ComputeAnalytics(this.profits);
}
EOF
cat > lib/features/market/presentation/bloc/analytics/analytics_state.dart << 'EOF'
abstract class AnalyticsState {}

class AnalyticsIdle extends AnalyticsState {}

class AnalyticsLoading extends AnalyticsState {}

class AnalyticsLoaded extends AnalyticsState {
  final dynamic result;
  AnalyticsLoaded(this.result);
}

class AnalyticsError extends AnalyticsState {
  final String message;
  AnalyticsError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/analytics/analytics_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/analytics/analytics_calculator.dart';
import 'analytics_event.dart';
import 'analytics_state.dart';

class AnalyticsBloc extends Bloc<AnalyticsEvent, AnalyticsState> {
  AnalyticsBloc() : super(AnalyticsIdle()) {
    on<ComputeAnalytics>(_onCompute);
  }

  void _onCompute(ComputeAnalytics event, Emitter<AnalyticsState> emit) {
    emit(AnalyticsLoading());
    try {
      final result = AnalyticsCalculator.calculate(event.profits);
      emit(AnalyticsLoaded(result));
    } catch (e) {
      emit(AnalyticsError("Analytics compute failed"));
    }
  }
}
EOF
cat > lib/features/market/presentation/pages/analytics/analytics_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/analytics/analytics_bloc.dart';
import '../../bloc/analytics/analytics_event.dart';
import '../../bloc/analytics/analytics_state.dart';

class AnalyticsPage extends StatelessWidget {
  final List<double> profits;
  AnalyticsPage({required this.profits});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Advanced Analytics")),
      body: BlocProvider(
        create: (_) => AnalyticsBloc()..add(ComputeAnalytics(profits)),
        child: BlocBuilder<AnalyticsBloc, AnalyticsState>(
          builder: (context, state) {
            if (state is AnalyticsLoading) {
              return Center(child: CircularProgressIndicator());
            }
            if (state is AnalyticsLoaded) {
              final r = state.result;
              return ListView(
                padding: EdgeInsets.all(12),
                children: [
                  Text("Net Profit: ${r.netProfit.toStringAsFixed(2)}"),
                  Text("Win Rate: ${r.winRate.toStringAsFixed(2)}%"),
                  Text("Sharp Ratio: ${r.sharpRatio.toStringAsFixed(2)}"),
                  Text("Expectancy: ${r.expectancy.toStringAsFixed(2)}"),
                  Text("Total Trades: ${r.totalTrades}"),
                  Text("Wins: ${r.wins}"),
                  Text("Losses: ${r.losses}"),
                ],
              );
            }
            if (state is AnalyticsError) {
              return Center(child: Text(state.message));
            }
            return Container();
          },
        ),
      ),
    );
  }
}
EOF
cat > lib/features/settings/domain/theme/app_theme.dart << 'EOF'
import 'package:flutter/material.dart';

enum AppThemeMode { light, dark, system }

class AppTheme {
  final AppThemeMode mode;
  final Color bullCandle;
  final Color bearCandle;
  final Color emaColor;
  final Color rsiColor;
  final Color macdColor;
  final Color bollingerColor;

  const AppTheme({
    required this.mode,
    required this.bullCandle,
    required this.bearCandle,
    required this.emaColor,
    required this.rsiColor,
    required this.macdColor,
    required this.bollingerColor,
  });

  Map<String, dynamic> toJson() => {
        "mode": mode.name,
        "bullCandle": bullCandle.value,
        "bearCandle": bearCandle.value,
        "emaColor": emaColor.value,
        "rsiColor": rsiColor.value,
        "macdColor": macdColor.value,
        "bollingerColor": bollingerColor.value,
      };

  factory AppTheme.fromJson(Map<String, dynamic> json) {
    return AppTheme(
      mode: AppThemeMode.values.firstWhere(
        (e) => e.name == json["mode"],
        orElse: () => AppThemeMode.system,
      ),
      bullCandle: Color(json["bullCandle"]),
      bearCandle: Color(json["bearCandle"]),
      emaColor: Color(json["emaColor"]),
      rsiColor: Color(json["rsiColor"]),
      macdColor: Color(json["macdColor"]),
      bollingerColor: Color(json["bollingerColor"]),
    );
  }

  static AppTheme defaultLight() => AppTheme(
        mode: AppThemeMode.system,
        bullCandle: Colors.green,
        bearCandle: Colors.red,
        emaColor: Colors.blue,
        rsiColor: Colors.purple,
        macdColor: Colors.cyan,
        bollingerColor: Colors.teal,
      );
}
EOF
cat > lib/features/settings/data/theme/theme_repository.dart << 'EOF'
import 'package:hive/hive.dart';
import '../../domain/theme/app_theme.dart';

class ThemeRepository {
  static const String _boxName = "app_theme";

  Future<void> init() async {
    await Hive.openBox<Map>(_boxName);
  }

  Future<void> saveTheme(AppTheme theme) async {
    final box = Hive.box<Map>(_boxName);
    await box.put("current", theme.toJson());
  }

  AppTheme loadTheme() {
    final box = Hive.box<Map>(_boxName);
    final data = box.get("current");
    if (data == null) return AppTheme.defaultLight();
    return AppTheme.fromJson(Map<String, dynamic>.from(data));
  }
}
EOF
cat > lib/features/settings/presentation/bloc/theme/theme_event.dart << 'EOF'
import '../../../domain/theme/app_theme.dart';

abstract class ThemeEvent {}

class ChangeThemeMode extends ThemeEvent {
  final AppThemeMode mode;
  ChangeThemeMode(this.mode);
}

class UpdateThemeColors extends ThemeEvent {
  final AppTheme theme;
  UpdateThemeColors(this.theme);
}
EOF
cat > lib/features/settings/presentation/bloc/theme/theme_state.dart << 'EOF'
import '../../../domain/theme/app_theme.dart';

class ThemeState {
  final AppTheme theme;
  const ThemeState(this.theme);

  Map<String, dynamic> toJson() => theme.toJson();

  factory ThemeState.fromJson(Map<String, dynamic> json) {
    return ThemeState(AppTheme.fromJson(json));
  }
}
EOF
cat > lib/features/settings/presentation/bloc/theme/theme_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:hydrated_bloc/hydrated_bloc.dart';
import '../../../data/theme/theme_repository.dart';
import '../../../domain/theme/app_theme.dart';
import 'theme_event.dart';
import 'theme_state.dart';

class ThemeBloc extends HydratedBloc<ThemeEvent, ThemeState> {
  final ThemeRepository repo;

  ThemeBloc(this.repo)
      : super(ThemeState(repo.loadTheme())) {
    on<ChangeThemeMode>((event, emit) {
      final updated = AppTheme(
        mode: event.mode,
        bullCandle: state.theme.bullCandle,
        bearCandle: state.theme.bearCandle,
        emaColor: state.theme.emaColor,
        rsiColor: state.theme.rsiColor,
        macdColor: state.theme.macdColor,
        bollingerColor: state.theme.bollingerColor,
      );
      repo.saveTheme(updated);
      emit(ThemeState(updated));
    });

    on<UpdateThemeColors>((event, emit) {
      repo.saveTheme(event.theme);
      emit(ThemeState(event.theme));
    });
  }

  @override
  ThemeState? fromJson(Map<String, dynamic> json) =>
      ThemeState.fromJson(json);

  @override
  Map<String, dynamic>? toJson(ThemeState state) => state.toJson();
}
EOF
cat > lib/features/settings/presentation/pages/theme/theme_settings_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/theme/theme_bloc.dart';
import '../../bloc/theme/theme_event.dart';
import '../../../domain/theme/app_theme.dart';

class ThemeSettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final theme = context.watch<ThemeBloc>().state.theme;

    return Scaffold(
      appBar: AppBar(title: Text("Theme Settings")),
      body: ListView(
        padding: EdgeInsets.all(12),
        children: [
          Text("Theme Mode"),
          DropdownButton<AppThemeMode>(
            value: theme.mode,
            items: AppThemeMode.values
                .map((m) => DropdownMenuItem(value: m, child: Text(m.name)))
                .toList(),
            onChanged: (m) {
              context.read<ThemeBloc>().add(ChangeThemeMode(m!));
            },
          ),
          Divider(),
          Text("Candle Colors"),
          ListTile(
            title: Text("Bull Candle"),
            trailing: CircleAvatar(backgroundColor: theme.bullCandle),
            onTap: () {},
          ),
          ListTile(
            title: Text("Bear Candle"),
            trailing: CircleAvatar(backgroundColor: theme.bearCandle),
            onTap: () {},
          ),
        ],
      ),
    );
  }
}
EOF
cat > test/unit/analytics_calculator_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/analytics/analytics_calculator.dart';

void main() {
  group('AnalyticsCalculator', () {
    test('calculates correct metrics', () {
      final profits = [100.0, -50.0, 25.0];

      final result = AnalyticsCalculator.calculate(profits);

      expect(result.netProfit, 75.0);
      expect(result.totalTrades, 3);
      expect(result.wins, 2);
      expect(result.losses, 1);
      expect(result.winRate, closeTo(66.67, 0.1));
    });
  });
}
EOF
cat > test/unit/chart_bloc_test.dart << 'EOF'
import 'package:bloc_test/bloc_test.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_state.dart';
import 'package:mocktail/mocktail.dart';

class MockChartRepository extends Mock implements ChartRepository {}

void main() {
  group('ChartBloc', () {
    late MockChartRepository mockRepo;
    late ChartBloc chartBloc;

    setUp(() {
      mockRepo = MockChartRepository();
      chartBloc = ChartBloc(mockRepo, symbol: 'TEST', timeframe: 'M1');
    });

    blocTest<ChartBloc, ChartState>(
      'emits [ChartLoading, ChartLoaded] when data is fetched',
      build: () {
        when(() => mockRepo.getHistoricalCandles(
              symbol: any(named: 'symbol'),
              timeframe: any(named: 'timeframe'),
              count: any(named: 'count'),
            )).thenAnswer((_) async => []);
        return chartBloc;
      },
      act: (bloc) => bloc.add(LoadChartHistory(symbol: 'TEST', timeframe: 'M1')),
      expect: () => [isA<ChartLoading>(), isA<ChartLoaded>()],
    );
  });
}
EOF
cat > test/integration/backtest_analytics_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/analytics/analytics_calculator.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';

void main() {
  test('Backtest integration yields expected analytics', () {
    final history = [
      // ØµÙŠØºØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
      CandleEntity(open: 100, high: 105, low: 95, close: 102, volume: 1000),
      CandleEntity(open: 102, high: 108, low: 99, close: 105, volume: 1200),
      CandleEntity(open: 105, high: 110, low: 102, close: 108, volume: 1100),
    ];

    final backtestEngine = BacktestEngine(history);
    final results = backtestEngine.run();

    final analytics = AnalyticsCalculator.calculate(results.tradeProfits);

    expect(analytics.totalTrades, greaterThan(0));
    expect(analytics.winRate, isA<double>());
  });
}
EOF
cat > test/widget/chart_page_test.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/presentation/pages/interactive_chart_page.dart';

void main() {
  testWidgets('Chart Page loads and displays chart', (tester) async {
    await tester.pumpWidget(MaterialApp(home: InteractiveChartPage(symbol: 'XAU_USD')));

    expect(find.byType(CircularProgressIndicator), findsOneWidget);

    await tester.pumpAndSettle();

    expect(find.text('Chart â€” XAU_USD'), findsOneWidget);
  });
}
EOF
cat > android/app/src/dev/res/values/strings.xml << 'EOF'
<resources>
    <string name="app_name">TradingApp Dev</string>
</resources>
EOF
cat > android/app/src/staging/res/values/strings.xml << 'EOF'
<resources>
    <string name="app_name">TradingApp Staging</string>
</resources>
EOF
cat >> android/app/proguard-rules.pro << 'EOF'
# Flutter/Dart
-keep class io.flutter.app.** { *; }
-keep class io.flutter.plugin.** { *; }
-keep class io.flutter.util.** { *; }
-keep class io.flutter.view.** { *; }

# Firebase
-keep class com.google.firebase.** { *; }
-keep class com.google.android.gms.** { *; }

# OANDA Models
-keep class com.yourapp.** { *; }
EOF
cat > android/key.properties << 'EOF'
storePassword=YOUR_PASSWORD
keyPassword=YOUR_KEY_PASSWORD
keyAlias=tradingappkey
storeFile=/full/path/to/keystore.jks
EOF
cat > .env.dev << 'EOF'
OANDA_API_URL=https://api-fxpractice.oanda.com/v3
FIREBASE_ENV=dev
EOF
cat > lib/core/widgets/loading/shimmer_loader.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

class ShimmerLoader extends StatelessWidget {
  final double height;
  final double width;
  const ShimmerLoader({this.height = 80, this.width = double.infinity});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey.shade300,
      highlightColor: Colors.grey.shade100,
      child: Container(
        height: height,
        width: width,
        color: Colors.white,
      ),
    );
  }
}
EOF
cat > lib/core/widgets/error_display.dart << 'EOF'
import 'package:flutter/material.dart';

class ErrorDisplay extends StatelessWidget {
  final String message;
  final VoidCallback? onRetry;

  const ErrorDisplay({required this.message, this.onRetry});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.error_outline, size: 48, color: Colors.redAccent),
          SizedBox(height: 12),
          Text(message, textAlign: TextAlign.center),
          SizedBox(height: 12),
          if (onRetry != null)
            ElevatedButton.icon(
              icon: Icon(Icons.refresh),
              label: Text("Retry"),
              onPressed: onRetry,
            ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/strategy/multi/strategy_set.dart << 'EOF'
import '../../strategy/strategy_config.dart';

class StrategyInstance {
  final String id;
  final StrategyConfig config;

  StrategyInstance({required this.id, required this.config});
}

class StrategySet {
  final List<StrategyInstance> strategies;

  StrategySet({required this.strategies});
}
EOF
cat > lib/features/market/domain/strategy/multi/multi_strategy_runner.dart << 'EOF'
import '../strategy_config.dart';
import '../../backtest/backtest_engine.dart';
import 'strategy_set.dart';

class MultiStrategyResult {
  final Map<String, dynamic> results;
  MultiStrategyResult({required this.results});
}

class MultiStrategyRunner {
  final StrategySet strategySet;

  MultiStrategyRunner(this.strategySet);

  Future<MultiStrategyResult> runBacktestAll(List<dynamic> history) async {
    final Map<String, dynamic> out = {};

    for (var inst in strategySet.strategies) {
      final engine = BacktestEngine(history, config: inst.config);
      final res = engine.run();
      out[inst.id] = res;
    }

    return MultiStrategyResult(results: out);
  }
}
EOF
cat > lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_event.dart << 'EOF'
import '../../../domain/strategy/multi/strategy_set.dart';

abstract class ComparisonEvent {}

class RunComparison extends ComparisonEvent {
  final StrategySet set;
  final List history;
  RunComparison({required this.set, required this.history});
}
EOF
cat > lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_state.dart << 'EOF'
abstract class ComparisonState {}

class ComparisonIdle extends ComparisonState {}

class ComparisonRunning extends ComparisonState {}

class ComparisonSuccess extends ComparisonState {
  final Map<String, dynamic> results;
  ComparisonSuccess(this.results);
}

class ComparisonError extends ComparisonState {
  final String message;
  ComparisonError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/strategy_comparison/strategy_comparison_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/strategy/multi/multi_strategy_runner.dart';
import 'strategy_comparison_event.dart';
import 'strategy_comparison_state.dart';

class StrategyComparisonBloc extends Bloc<ComparisonEvent, ComparisonState> {
  StrategyComparisonBloc() : super(ComparisonIdle()) {
    on<RunComparison>(_onRun);
  }

  void _onRun(RunComparison event, Emitter<ComparisonState> emit) async {
    emit(ComparisonRunning());
    try {
      final runner = MultiStrategyRunner(event.set);
      final results = await runner.runBacktestAll(event.history);
      emit(ComparisonSuccess(results.results));
    } catch (e) {
      emit(ComparisonError("Comparison failed: \$e"));
    }
  }
}
EOF
cat > lib/features/market/presentation/pages/strategy_comparison/strategy_comparison_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../bloc/strategy_comparison/strategy_comparison_bloc.dart';
import '../../bloc/strategy_comparison/strategy_comparison_event.dart';
import '../../bloc/strategy_comparison/strategy_comparison_state.dart';

class StrategyComparisonPage extends StatelessWidget {
  final List history;
  final List configs;

  StrategyComparisonPage({
    required this.history,
    required this.configs,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Strategy Comparison")),
      body: BlocProvider(
        create: (_) => StrategyComparisonBloc(),
        child: BlocBuilder<StrategyComparisonBloc, ComparisonState>(
          builder: (context, state) {
            if (state is ComparisonRunning)
              return Center(child: CircularProgressIndicator());

            if (state is ComparisonSuccess) {
              final results = state.results;
              return ListView(
                children: results.entries.map((e) {
                  final key = e.key;
                  final res = e.value;
                  return ListTile(
                    title: Text("Strategy: \$key"),
                    subtitle: Text("Net: \${res.netProfit} | WinRate: \${res.winRate}"),
                  );
                }).toList(),
              );
            }

            if (state is ComparisonError)
              return Center(child: Text(state.message));

            return Center(
              child: ElevatedButton(
                child: Text("Start Comparison"),
                onPressed: () {
                  final set = StrategySet(
                    strategies: configs.map((c) => StrategyInstance(id: c.id, config: c)).toList(),
                  );
                  context.read<StrategyComparisonBloc>().add(
                        RunComparison(set: set, history: history),
                      );
                },
              ),
            );
          },
        ),
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/indicators/types/indicator_type.dart << 'EOF'
enum IndicatorDisplayMode {
  overlay,     // Ø±Ø³Ù… ÙÙˆÙ‚ Ø§Ù„Ø´Ø§Ø±Øª
  subChart,    // Ø±Ø³Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø±Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ø³ØªÙ‚Ù„Ø©
}

class IndicatorType {
  final String id;
  final String label;
  final IndicatorDisplayMode mode;

  const IndicatorType({
    required this.id,
    required this.label,
    required this.mode,
  });
}

const IndicatorType EMA = IndicatorType(id: "ema", label: "EMA", mode: IndicatorDisplayMode.overlay);
const IndicatorType BOLLINGER = IndicatorType(id: "bollinger", label: "Bollinger Bands", mode: IndicatorDisplayMode.overlay);
const IndicatorType STOCH = IndicatorType(id: "stoch", label: "Stochastic", mode: IndicatorDisplayMode.subChart);
const IndicatorType RSI = IndicatorType(id: "rsi", label: "RSI", mode: IndicatorDisplayMode.subChart);
EOF
cat >> lib/features/market/domain/indicators/types/indicator_series.dart << 'EOF'
import 'indicator_type.dart';

class IndicatorSeries {
  final List<double> values;
  final String label;
  final IndicatorDisplayMode displayMode;

  IndicatorSeries({
    required this.values,
    required this.label,
    required this.displayMode,
  });
}
EOF
cat > lib/features/market/presentation/widgets/custom_chart/multi_indicator_chart.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/indicators/types/indicator_series.dart';

class MultiIndicatorChart extends StatelessWidget {
  final List<double> prices;
  final List<IndicatorSeries> indicators;

  MultiIndicatorChart({
    required this.prices,
    required this.indicators,
  });

  @override
  Widget build(BuildContext context) {
    final overlaySeries =
        indicators.where((i) => i.displayMode == IndicatorDisplayMode.overlay);
    final subCharts =
        indicators.where((i) => i.displayMode == IndicatorDisplayMode.subChart);

    return Column(
      children: [
        // Main Chart with overlay
        Expanded(
          flex: 3,
          child: Stack(
            children: [
              CandlesPainter(candles: prices), // Ø§ÙØªØ±Ø¶Ù†Ø§ Ø£Ù†Ù‡ ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ù€ OHLC Ø®Ø·ÙˆØ·
              ...overlaySeries.map((ind) => IndicatorPainter(values: ind.values)),
            ],
          ),
        ),

        // Subâ€‘chart indicators
        Expanded(
          flex: 1,
          child: ListView(
            children: subCharts.map((ind) {
              return SizedBox(
                height: 120,
                child: IndicatorSubChartPainter(values: ind.values, label: ind.label),
              );
            }).toList(),
          ),
        ),
      ],
    );
  }
}
EOF
cat >> lib/features/settings/presentation/pages/theme/theme_settings_page.dart << 'EOF'

void _pickColor(BuildContext context, Color currentColor, Function(Color) onColorChanged) {
  showDialog(
    context: context,
    builder: (_) => AlertDialog(
      title: Text("Pick a Color"),
      content: SingleChildScrollView(
        child: ColorPicker(
          pickerColor: currentColor,
          onColorChanged: onColorChanged,
        ),
      ),
      actions: [
        ElevatedButton(
          child: Text("Done"),
          onPressed: () => Navigator.of(context).pop(),
        )
      ],
    ),
  );
}

void _updateIndicatorColor(BuildContext context, String id, Color color) {
  final theme = context.read<ThemeBloc>().state.theme;
  final updatedTheme = AppTheme(
    mode: theme.mode,
    bullCandle: theme.bullCandle,
    bearCandle: theme.bearCandle,
    emaColor: id == "ema" ? color : theme.emaColor,
    stochColor: id == "stoch" ? color : theme.stochColor,
    rsiColor: id == "rsi" ? color : theme.rsiColor,
    bollingerColor: id == "bollinger" ? color : theme.bollingerColor,
  );
  context.read<ThemeBloc>().add(UpdateThemeColors(updatedTheme));
}
EOF
cat > lib/features/market/domain/chart/x_axis_range.dart << 'EOF'
class XAxisRange {
  final DateTime min;
  final DateTime max;

  const XAxisRange({required this.min, required this.max});

  bool contains(DateTime t) => t.isAfter(min) && t.isBefore(max);
}
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_event.dart << 'EOF'
class VisibleRangeChanged extends ChartEvent {
  final DateTime min;
  final DateTime max;
  VisibleRangeChanged({required this.min, required this.max});
}
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'

    on<VisibleRangeChanged>((event, emit) {
      if (state is ChartLoaded) {
        final current = state as ChartLoaded;
        emit(ChartLoaded(candles: current.candles, visibleRange: XAxisRange(min: event.min, max: event.max)));
      }
    });
EOF
cat > lib/features/market/presentation/widgets/custom_chart/utils/chart_mapping.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/chart/x_axis_range.dart';
import '../../../domain/entities/candle.dart';

double mapTimeToX(DateTime time, XAxisRange range, double width) {
  final total = range.max.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  final delta = time.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  return (delta / total) * width;
}

double mapPriceToY(double price, double minPrice, double maxPrice, double height) {
  return height * (1 - ((price - minPrice) / (maxPrice - minPrice)));
}
EOF
cat > lib/features/market/presentation/widgets/custom_chart/subchart_rsi_painter.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../domain/chart/x_axis_range.dart';
import '../utils/chart_mapping.dart';

class RSIChartPainter extends CustomPainter {
  final List<DateTime> times;
  final List<double> values;
  final XAxisRange visibleRange;

  RSIChartPainter({required this.times, required this.values, required this.visibleRange});

  @override
  void paint(Canvas canvas, Size size) {
    final paintRsi = Paint()..color = Colors.purple..strokeWidth = 1.5;

    double maxVal = values.reduce((a, b) => a > b ? a : b);
    double minVal = values.reduce((a, b) => a < b ? a : b);

    for (int i = 0; i < times.length; i++) {
      if (!visibleRange.contains(times[i])) continue;
      final x = mapTimeToX(times[i], visibleRange, size.width);
      final y = mapPriceToY(values[i], minVal, maxVal, size.height);
      if (i > 0 && visibleRange.contains(times[i-1])) {
        final prevX = mapTimeToX(times[i-1], visibleRange, size.width);
        final prevY = mapPriceToY(values[i-1], minVal, maxVal, size.height);
        canvas.drawLine(Offset(prevX, prevY), Offset(x, y), paintRsi);
      }
    }
  }

  @override
  bool shouldRepaint(covariant RSIChartPainter old) => old.times != times || old.visibleRange != visibleRange;
}
EOF
cat > lib/features/replay/domain/entities/replay_event.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';

/// Replicate an event in the replay (e.g., new candle)
class ReplayEvent {
  final CandleEntity candle;
  final DateTime timestamp; // time at which this should fire in replay

  ReplayEvent({required this.candle, required this.timestamp});
}
EOF
cat > lib/features/replay/domain/entities/speed.dart << 'EOF'
enum ReplaySpeed {
  x1,
  x2,
  x5,
  x10,
}

extension SpeedMultiplier on ReplaySpeed {
  double get multiplier {
    switch (this) {
      case ReplaySpeed.x2:
        return 2.0;
      case ReplaySpeed.x5:
        return 5.0;
      case ReplaySpeed.x10:
        return 10.0;
      case ReplaySpeed.x1:
      default:
        return 1.0;
    }
  }
}
EOF
cat > lib/features/replay/data/datasources/replay_data_source.dart << 'EOF'
import '../../../../market/domain/entities/candle.dart';
import '../../../../market/domain/repositories/market_repository.dart';

class ReplayDataSource {
  final MarketRepository repository;

  ReplayDataSource(this.repository);

  /// Fetch huge range for replay (Ù…Ø«Ù„Ø§Ù‹ 5000 Ø´Ù…Ø¹Ø©)
  Future<List<CandleEntity>> fetchForReplay({
    required String symbol,
    required String timeframe,
    int count = 5000,
  }) async {
    final models = await repository.getHistoricalCandlesPage(
      symbol: symbol,
      timeframe: timeframe,
      count: count,
    );
    return models.map((m) => m.toEntity()).toList();
  }
}
EOF
cat > lib/features/replay/domain/engine/replay_engine.dart << 'EOF'
import 'dart:async';
import '../../../market/domain/entities/candle.dart';
import '../entities/speed.dart';

typedef OnCandleCallback = void Function(CandleEntity);

class ReplayEngine {
  final List<CandleEntity> candles;
  final OnCandleCallback onCandle;
  final ReplaySpeed speed;

  Timer? _timer;
  int _index = 0;

  ReplayEngine({
    required this.candles,
    required this.onCandle,
    this.speed = ReplaySpeed.x1,
  });

  void start() {
    stop();
    _index = 0;
    if (candles.isEmpty) return;

    final baseDelay = Duration(seconds: 1);
    final intervalMs = baseDelay.inMilliseconds ~/ speed.multiplier;

    _timer = Timer.periodic(Duration(milliseconds: intervalMs), (timer) {
      if (_index >= candles.length) {
        stop();
        return;
      }
      onCandle(candles[_index]);
      _index++;
    });
  }

  void stop() {
    _timer?.cancel();
    _timer = null;
  }

  void pause() => stop();

  bool get isRunning => _timer != null;
}
EOF
cat > lib/features/replay/presentation/bloc/replay_event.dart << 'EOF'
import '../../../replay/domain/entities/speed.dart';

abstract class ReplayEvent {}

class LoadReplayData extends ReplayEvent {
  final String symbol;
  final String timeframe;
  LoadReplayData({required this.symbol, required this.timeframe});
}

class StartReplay extends ReplayEvent {}

class PauseReplay extends ReplayEvent {}

class StopReplay extends ReplayEvent {}

class ChangeReplaySpeed extends ReplayEvent {
  final ReplaySpeed speed;
  ChangeReplaySpeed(this.speed);
}
EOF
cat > lib/features/replay/presentation/bloc/replay_state.dart << 'EOF'
import '../../../replay/domain/entities/speed.dart';

abstract class ReplayState {}

class ReplayIdle extends ReplayState {}

class ReplayLoading extends ReplayState {}

class ReplayReady extends ReplayState {
  final int total;
  final ReplaySpeed speed;
  ReplayReady({required this.total, required this.speed});
}

class ReplayRunning extends ReplayState {
  final int index;
  final int total;
  final ReplaySpeed speed;
  ReplayRunning({required this.index, required this.total, required this.speed});
}

class ReplayPaused extends ReplayState {
  final int index;
  final int total;
  final ReplaySpeed speed;
  ReplayPaused({required this.index, required this.total, required this.speed});
}

class ReplayError extends ReplayState {
  final String message;
  ReplayError(this.message);
}
EOF
cat > lib/features/replay/presentation/bloc/replay_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../replay/domain/engine/replay_engine.dart';
import '../../../replay/domain/entities/speed.dart';
import '../../../replay/data/datasources/replay_data_source.dart';
import '../../../market/domain/entities/candle.dart';
import 'replay_event.dart';
import 'replay_state.dart';

class ReplayBloc extends Bloc<ReplayEvent, ReplayState> {
  final ReplayDataSource dataSource;
  final Function(CandleEntity) onCandle;
  
  List<CandleEntity> _data = [];
  ReplayEngine? _engine;
  ReplaySpeed _speed = ReplaySpeed.x1;

  ReplayBloc({required this.dataSource, required this.onCandle}) : super(ReplayIdle()) {
    on<LoadReplayData>(_onLoadData);
    on<StartReplay>(_onStart);
    on<PauseReplay>(_onPause);
    on<StopReplay>(_onStop);
    on<ChangeReplaySpeed>(_onChangeSpeed);
  }

  Future<void> _onLoadData(LoadReplayData event, Emitter<ReplayState> emit) async {
    emit(ReplayLoading());
    try {
      _data = await dataSource.fetchForReplay(
        symbol: event.symbol,
        timeframe: event.timeframe,
      );
      emit(ReplayReady(total: _data.length, speed: _speed));
    } catch (e) {
      emit(ReplayError("Replay load failed"));
    }
  }

  void _onStart(StartReplay event, Emitter<ReplayState> emit) {
    if (_data.isEmpty) {
      emit(ReplayError("No data for replay"));
      return;
    }
    _engine?.stop();
    _engine = ReplayEngine(
      candles: _data,
      speed: _speed,
      onCandle: onCandle,
    );
    _engine!.start();
    emit(ReplayRunning(index: 0, total: _data.length, speed: _speed));
  }

  void _onPause(PauseReplay event, Emitter<ReplayState> emit) {
    _engine?.pause();
    emit(ReplayPaused(index: 0, total: _data.length, speed: _speed));
  }

  void _onStop(StopReplay event, Emitter<ReplayState> emit) {
    _engine?.stop();
    emit(ReplayReady(total: _data.length, speed: _speed));
  }

  void _onChangeSpeed(ChangeReplaySpeed event, Emitter<ReplayState> emit) {
    _speed = event.speed;
    emit(ReplayReady(total: _data.length, speed: _speed));
  }
}
EOF
cat > lib/features/replay/presentation/pages/replay_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../market/domain/entities/candle.dart';
import '../../presentation/bloc/replay_bloc.dart';
import '../../presentation/bloc/replay_event.dart';
import '../../presentation/bloc/replay_state.dart';
import '../../../replay/domain/entities/speed.dart';

class ReplayPage extends StatelessWidget {
  final String symbol;
  final String timeframe;

  ReplayPage({required this.symbol, required this.timeframe});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Market Replay (\$symbol)")),
      body: Column(
        children: [
          BlocBuilder<ReplayBloc, ReplayState>(
            builder: (context, state) {
              if (state is ReplayLoading) return CircularProgressIndicator();
              if (state is ReplayError) return Text(state.message);
              if (state is ReplayReady || state is ReplayPaused || state is ReplayRunning) {
                final total = (state as dynamic).total;
                final speed = (state as dynamic).speed;
                int index = (state is ReplayRunning) ? state.index : ((state is ReplayPaused) ? state.index : 0);

                return Column(
                  children: [
                    Text("Progress: \$index / \$total"),
                    SizedBox(height: 10),
                    Row(
                      children: [
                        ElevatedButton(onPressed: () => context.read<ReplayBloc>().add(StartReplay()), child: Text("Start")),
                        ElevatedButton(onPressed: () => context.read<ReplayBloc>().add(PauseReplay()), child: Text("Pause")),
                        ElevatedButton(onPressed: () => context.read<ReplayBloc>().add(StopReplay()), child: Text("Stop")),
                      ],
                    ),
                    Row(
                      children: [
                        Text("Speed:"),
                        DropdownButton<ReplaySpeed>(
                          value: speed,
                          items: ReplaySpeed.values.map((s) => DropdownMenuItem(value: s, child: Text(s.name))).toList(),
                          onChanged: (s) => context.read<ReplayBloc>().add(ChangeReplaySpeed(s!)),
                        ),
                      ],
                    ),
                  ],
                );
              }
              return ElevatedButton(
                onPressed: () => context.read<ReplayBloc>().add(LoadReplayData(symbol: symbol, timeframe: timeframe)),
                child: Text("Load Data"),
              );
            },
          ),
        ],
      ),
    );
  }
}
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_event.dart << 'EOF'
class NewReplayCandle extends ChartEvent {
  final CandleEntity candle;
  NewReplayCandle(this.candle);
}
EOF
cat >> lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'
    on<NewReplayCandle>((event, emit) {
      // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù€ live tick
      _processTick(event.candle);
    });
EOF
cat > lib/features/strategy_builder/domain/entities/block_type.dart << 'EOF'
enum BlockType {
  // Conditions
  priceAbove,
  priceBelow,
  emaCrossUp,
  emaCrossDown,
  rsiBelow,
  rsiAbove,

  // Logical connectors
  and,
  or,

  // Actions
  buy,
  sell,
}
EOF
cat > lib/features/strategy_builder/domain/entities/block.dart << 'EOF'
import 'block_type.dart';

class Block {
  final String id; // unique
  final BlockType type;
  final Map<String, dynamic> params; // e.g., period, threshold
  Block({required this.id, required this.type, Map<String, dynamic>? params})
      : this.params = params ?? {};
}
EOF
cat > lib/features/strategy_builder/domain/entities/connection.dart << 'EOF'
class Connection {
  final String fromBlockId;
  final String toBlockId;

  Connection({required this.fromBlockId, required this.toBlockId});
}
EOF
cat > lib/features/strategy_builder/domain/models/strategy_graph.dart << 'EOF'
import '../entities/block.dart';
import '../entities/connection.dart';

class StrategyGraph {
  final List<Block> blocks;
  final List<Connection> connections;

  StrategyGraph({required this.blocks, required this.connections});

  Map<String, dynamic> toJson() {
    return {
      "blocks": blocks.map((b) => {
            "id": b.id,
            "type": b.type.toString(),
            "params": b.params,
          }).toList(),
      "connections": connections
          .map((c) => {"from": c.fromBlockId, "to": c.toBlockId})
          .toList(),
    };
  }

  factory StrategyGraph.fromJson(Map<String, dynamic> json) {
    final blocks = (json["blocks"] as List<dynamic>)
        .map((b) => Block(
              id: b["id"],
              type: BlockType.values.firstWhere(
                  (e) => e.toString() == b["type"]),
              params: Map<String, dynamic>.from(b["params"] ?? {}),
            ))
        .toList();
    final connections = (json["connections"] as List<dynamic>)
        .map((c) => Connection(
              fromBlockId: c["from"],
              toBlockId: c["to"],
            ))
        .toList();
    return StrategyGraph(blocks: blocks, connections: connections);
  }
}
EOF
cat > lib/features/strategy_builder/presentation/widgets/block_palette.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../domain/entities/block_type.dart';

class BlockPalette extends StatelessWidget {
  final Function(BlockType) onDragStart;

  const BlockPalette({required this.onDragStart});

  @override
  Widget build(BuildContext context) {
    final blocks = {
      "Price Above": BlockType.priceAbove,
      "Price Below": BlockType.priceBelow,
      "EMA Cross Up": BlockType.emaCrossUp,
      "EMA Cross Down": BlockType.emaCrossDown,
      "RSI Below": BlockType.rsiBelow,
      "RSI Above": BlockType.rsiAbove,
      "AND": BlockType.and,
      "OR": BlockType.or,
      "BUY": BlockType.buy,
      "SELL": BlockType.sell,
    };

    return Container(
      width: 180,
      color: Colors.grey.shade900,
      child: ListView(
        children: blocks.entries.map((e) {
          return Draggable<BlockType>(
            data: e.value,
            feedback: _buildBlock(e.key, Colors.blueAccent),
            child: _buildBlock(e.key, Colors.white),
            onDragStarted: () => onDragStart(e.value),
          );
        }).toList(),
      ),
    );
  }

  Widget _buildBlock(String label, Color color) {
    return Container(
      margin: EdgeInsets.all(8),
      padding: EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        border: Border.all(color: color),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Center(child: Text(label, style: TextStyle(color: color))),
    );
  }
}
EOF
cat > lib/features/strategy_builder/presentation/canvas/node_widget.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../domain/entities/block.dart';
import '../../domain/entities/block_type.dart';

class StrategyNode extends StatelessWidget {
  final Block block;
  final Offset position;

  const StrategyNode({required this.block, required this.position});

  @override
  Widget build(BuildContext context) {
    return Positioned(
      left: position.dx,
      top: position.dy,
      child: Container(
        width: 180,
        padding: EdgeInsets.all(10),
        decoration: BoxDecoration(
          color: Colors.black87,
          border: Border.all(color: Colors.blueAccent),
          borderRadius: BorderRadius.circular(10),
          boxShadow: [
            BoxShadow(color: Colors.black26, blurRadius: 6, spreadRadius: 1)
          ],
        ),
        child: Column(
          children: [
            Text(
              block.type.toString().split('.').last,
              style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
            ),
            SizedBox(height: 8),
            _buildPorts(),
          ],
        ),
      ),
    );
  }

  Widget _buildPorts() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        _port(Icons.input, Colors.green),  // input port
        _port(Icons.output, Colors.red),   // output port
      ],
    );
  }

  Widget _port(IconData icon, Color color) {
    return Container(
      padding: EdgeInsets.all(6),
      decoration: BoxDecoration(
        color: color.withOpacity(0.2),
        shape: BoxShape.circle,
        border: Border.all(color: color),
      ),
      child: Icon(icon, size: 14, color: color),
    );
  }
}
EOF
cat > lib/features/strategy_builder/presentation/canvas/strategy_canvas.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../domain/entities/block.dart';
import '../../domain/entities/block_type.dart';
import '../../domain/entities/connection.dart';
import 'node_widget.dart';

class StrategyCanvas extends StatefulWidget {
  final List<Block> blocks;
  final List<Connection> connections;
  final Function(Block, Offset) onDrop;

  const StrategyCanvas({
    required this.blocks,
    required this.connections,
    required this.onDrop,
  });

  @override
  State<StrategyCanvas> createState() => _StrategyCanvasState();
}

class _StrategyCanvasState extends State<StrategyCanvas> {
  final Map<String, Offset> nodePositions = {};

  @override
  Widget build(BuildContext context) {
    return DragTarget<BlockType>(
      onAcceptWithDetails: (details) {
        final position = details.offset;
        final newBlock = Block(
          id: DateTime.now().millisecondsSinceEpoch.toString(),
          type: details.data,
        );
        widget.onDrop(newBlock, position);
        nodePositions[newBlock.id] = position;
      },
      builder: (context, candidateData, rejectedData) {
        return Stack(
          children: [
            Container(color: Colors.grey.shade800),
            ...widget.blocks.map((b) {
              final pos = nodePositions[b.id] ?? Offset(100, 100);
              return StrategyNode(block: b, position: pos);
            }).toList(),
          ],
        );
      },
    );
  }
}
EOF
cat > lib/features/strategy_builder/presentation/canvas/connection_painter.dart << 'EOF'
import 'package:flutter/material.dart';

class ConnectionPainter extends CustomPainter {
  final List<Offset> points;

  ConnectionPainter(this.points);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.blueAccent
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;

    if (points.length < 2) return;

    final path = Path();
    path.moveTo(points.first.dx, points.first.dy);

    for (int i = 1; i < points.length; i++) {
      final prev = points[i - 1];
      final curr = points[i];
      final control = Offset((prev.dx + curr.dx) / 2, prev.dy);
      path.quadraticBezierTo(control.dx, control.dy, curr.dx, curr.dy);
    }

    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant ConnectionPainter oldDelegate) => true;
}
EOF
cat > lib/features/strategy_builder/domain/interpreter/strategy_interpreter.dart << 'EOF'
import '../entities/block.dart';
import '../entities/block_type.dart';
import '../models/strategy_graph.dart';
import '../../../market/domain/entities/candle.dart';

class StrategyInterpreter {
  final StrategyGraph graph;

  StrategyInterpreter(this.graph);

  bool evaluate(List<CandleEntity> history) {
    final Map<String, bool> results = {};

    for (var block in graph.blocks) {
      results[block.id] = _evalBlock(block, history, results);
    }

    // Find final BUY/SELL blocks
    final buyBlocks =
        graph.blocks.where((b) => b.type == BlockType.buy).toList();
    for (var b in buyBlocks) {
      final incoming = graph.connections
          .where((c) => c.toBlockId == b.id)
          .map((c) => results[c.fromBlockId] ?? false)
          .toList();

      if (incoming.every((v) => v == true)) return true;
    }

    return false;
  }

  bool _evalBlock(Block b, List<CandleEntity> history, Map<String, bool> results) {
    switch (b.type) {
      case BlockType.priceAbove:
        return history.last.close >
            history[history.length - 2].close;

      case BlockType.rsiBelow:
        return b.params["value"] != null
            ? history.last.close < b.params["value"]
            : true;

      case BlockType.and:
        final inputs = graph.connections
            .where((c) => c.toBlockId == b.id)
            .map((c) => results[c.fromBlockId] ?? false)
            .toList();
        return inputs.every((v) => v);

      case BlockType.or:
        final inputs = graph.connections
            .where((c) => c.toBlockId == b.id)
            .map((c) => results[c.fromBlockId] ?? false)
            .toList();
        return inputs.any((v) => v);

      default:
        return false;
    }
  }
}
EOF
cat > lib/features/strategy_builder/data/strategy_storage.dart << 'EOF'
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../domain/models/strategy_graph.dart';

class StrategyStorage {
  static const _key = "saved_strategy";

  Future<void> save(StrategyGraph graph) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_key, jsonEncode(graph.toJson()));
  }

  Future<StrategyGraph?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final data = prefs.getString(_key);
    if (data == null) return null;
    return StrategyGraph.fromJson(jsonDecode(data));
  }
}
EOF
cat > lib/features/portrait/presentation/pages/portrait_home_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../market/presentation/pages/interactive_chart_page.dart';
import '../widgets/portrait_tabs.dart';

class PortraitHomePage extends StatefulWidget {
  final String symbol;
  PortraitHomePage({required this.symbol});

  @override
  _PortraitHomePageState createState() => _PortraitHomePageState();
}

class _PortraitHomePageState extends State<PortraitHomePage> {
  int _currentTab = 0;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: IndexedStack(
                index: _currentTab,
                children: [
                  InteractiveChartPage(symbol: widget.symbol),
                  IndicatorsPortraitPage(), // Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                  OrdersPortraitPage(),     // Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                  AlertsPortraitPage(),     // Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
                ],
              ),
            ),
            PortraitTabBar(
              currentIndex: _currentTab,
              onTap: (idx) => setState(() => _currentTab = idx),
            ),
          ],
        ),
      ),
    );
  }
}
EOF
cat > lib/features/portrait/presentation/pages/indicators_portrait_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../market/presentation/bloc/chart/chart_bloc.dart';
import '../../../market/presentation/bloc/chart/chart_state.dart';
import '../../../market/presentation/widgets/custom_chart/multi_indicator_chart.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class IndicatorsPortraitPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Text("Indicators", style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
        Expanded(
          child: BlocBuilder<ChartBloc, ChartState>(
            builder: (context, state) {
              if (state is ChartLoaded) {
                return MultiIndicatorChart(
                  prices: state.candles.map((c) => c.close).toList(),
                  indicators: state.indicators,
                );
              }
              return Center(child: CircularProgressIndicator());
            },
          ),
        ),
      ],
    );
  }
}
EOF
cat > lib/features/portrait/presentation/pages/orders_portrait_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../market/presentation/bloc/trading/trading_bloc.dart';
import '../../../market/presentation/bloc/trading/trading_state.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class OrdersPortraitPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<TradingBloc, TradingState>(
      builder: (context, state) {
        if (state is TradingUpdated) {
          return ListView(
            padding: EdgeInsets.all(12),
            children: state.openPositions.map((p) {
              return ListTile(
                title: Text("${p.instrument} â€” ${p.units.toString()}"),
                subtitle: Text("P/L: ${p.floatingPL.toStringAsFixed(2)}"),
              );
            }).toList(),
          );
        }
        return Center(child: Text("No Positions"));
      },
    );
  }
}
EOF
cat > lib/features/portrait/presentation/pages/alerts_portrait_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../market/presentation/bloc/smart_alert/smart_alert_bloc.dart';
import '../../../market/presentation/bloc/smart_alert/smart_alert_state.dart';

class AlertsPortraitPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<SmartAlertBloc, SmartAlertState>(
      builder: (context, state) {
        if (state is SmartAlertUpdated) {
          return ListView.builder(
            itemCount: state.alerts.length,
            itemBuilder: (ctx, i) {
              final alert = state.alerts[i];
              return ListTile(
                title: Text(alert.condition.type.toString()),
                subtitle: Text("Active"),
              );
            },
          );
        }
        return Center(child: Text("No Alerts"));
      },
    );
  }
}
EOF
cat > lib/features/portrait/presentation/widgets/portrait_floating_controls.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../replay/domain/entities/speed.dart';

class PortraitFloatingControls extends StatelessWidget {
  final Function() onZoomIn;
  final Function() onZoomOut;
  final Function(ReplaySpeed) onSpeedChange;

  const PortraitFloatingControls({
    required this.onZoomIn,
    required this.onZoomOut,
    required this.onSpeedChange,
  });

  @override
  Widget build(BuildContext context) {
    return Positioned(
      right: 16,
      bottom: 16,
      child: Column(
        children: [
          FloatingActionButton(
            heroTag: "zoomIn",
            mini: true,
            child: Icon(Icons.zoom_in),
            onPressed: onZoomIn,
          ),
          SizedBox(height: 8),
          FloatingActionButton(
            heroTag: "zoomOut",
            mini: true,
            child: Icon(Icons.zoom_out),
            onPressed: onZoomOut,
          ),
          SizedBox(height: 8),
          PopupMenuButton<ReplaySpeed>(
            icon: Icon(Icons.speed),
            itemBuilder: (_) => ReplaySpeed.values
                .map((s) => PopupMenuItem(value: s, child: Text(s.name)))
                .toList(),
            onSelected: (speed) => onSpeedChange(speed),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/portrait/presentation/widgets/portrait_tabs.dart << 'EOF'
import 'package:flutter/material.dart';

class PortraitTabBar extends StatelessWidget {
  final int currentIndex;
  final Function(int) onTap;

  const PortraitTabBar({required this.currentIndex, required this.onTap});

  @override
  Widget build(BuildContext context) {
    return BottomNavigationBar(
      currentIndex: currentIndex,
      onTap: onTap,
      items: [
        BottomNavigationBarItem(icon: Icon(Icons.show_chart), label: "Chart"),
        BottomNavigationBarItem(icon: Icon(Icons.bar_chart), label: "Indicators"),
        BottomNavigationBarItem(icon: Icon(Icons.list), label: "Orders"),
        BottomNavigationBarItem(icon: Icon(Icons.notifications), label: "Alerts"),
      ],
      type: BottomNavigationBarType.fixed,
    );
  }
}
EOF
cat > lib/features/strategy_script/domain/token.dart << 'EOF'
enum TokenType {
  identifier,
  number,
  comparison,
  comma,
  leftParen,
  rightParen,
  keywordIf,
  keywordThen,
  semicolon,
  eof,
}

class Token {
  final TokenType type;
  final String lexeme;
  Token(this.type, this.lexeme);
}
EOF
cat > lib/features/strategy_script/domain/tokenizer.dart << 'EOF'
import 'token.dart';

class Tokenizer {
  final String _input;
  int _pos = 0;

  Tokenizer(this._input);

  List<Token> tokenize() {
    final tokens = <Token>[];

    while (_pos < _input.length) {
      final c = _input[_pos];

      if (c.trim().isEmpty) { _pos++; continue; }

      if (isLetter(c)) {
        final word = readWhile(isLetter);
        if (word.toUpperCase() == 'IF') tokens.add(Token(TokenType.keywordIf, word));
        else if (word.toUpperCase() == 'THEN') tokens.add(Token(TokenType.keywordThen, word));
        else tokens.add(Token(TokenType.identifier, word));
        continue;
      }

      if (isDigit(c)) {
        final numStr = readWhile((ch) => isDigit(ch) || ch == '.');
        tokens.add(Token(TokenType.number, numStr));
        continue;
      }

      switch (c) {
        case '>':
        case '<':
        case '=':
          tokens.add(Token(TokenType.comparison, c));
          break;
        case ',':
          tokens.add(Token(TokenType.comma, c));
          break;
        case '(':
          tokens.add(Token(TokenType.leftParen, c));
          break;
        case ')':
          tokens.add(Token(TokenType.rightParen, c));
          break;
        case ';':
          tokens.add(Token(TokenType.semicolon, c));
          break;
      }

      _pos++;
    }

    tokens.add(Token(TokenType.eof, ''));
    return tokens;
  }

  bool isLetter(String c) => RegExp(r'[A-Za-z_]').hasMatch(c);
  bool isDigit(String c) => RegExp(r'[0-9]').hasMatch(c);

  String readWhile(bool Function(String) test) {
    final start = _pos;
    while (_pos < _input.length && test(_input[_pos])) _pos++;
    return _input.substring(start, _pos);
  }
}
EOF
cat > lib/features/strategy_script/domain/ast.dart << 'EOF'
abstract class ASTNode {}

class IfStatement extends ASTNode {
  final Expression condition;
  final Action action;
  IfStatement(this.condition, this.action);
}

abstract class Expression extends ASTNode {}

class BinaryExpression extends Expression {
  final Expression left;
  final String op;
  final Expression right;
  BinaryExpression(this.left, this.op, this.right);
}

class FunctionCall extends Expression {
  final String name;
  final List<Expression> args;
  FunctionCall(this.name, this.args);
}

class NumberLiteral extends Expression {
  final double value;
  NumberLiteral(this.value);
}

class Identifier extends Expression {
  final String name;
  Identifier(this.name);
}

class Action extends ASTNode {
  final String type;
  Action(this.type);
}
EOF
cat > lib/features/strategy_script/domain/parser.dart << 'EOF'
import 'token.dart';
import 'tokenizer.dart';
import 'ast.dart';

class Parser {
  final List<Token> tokens;
  int _pos = 0;

  Parser(this.tokens);

  Token get current => tokens[_pos];

  void advance() => _pos++;

  bool accept(TokenType type) {
    if (current.type == type) { advance(); return true; }
    return false;
  }

  ASTNode? parse() {
    if (accept(TokenType.keywordIf)) {
      final cond = parseExpression();
      expect(TokenType.keywordThen);
      final act = parseAction();
      expect(TokenType.semicolon);
      return IfStatement(cond!, act);
    }
    return null;
  }

  Expression? parseExpression() {
    if (current.type == TokenType.identifier) {
      final name = current.lexeme;
      advance();
      if (accept(TokenType.leftParen)) {
        final args = <Expression>[];
        while (!accept(TokenType.rightParen)) {
          final expr = parseExpression();
          if (expr != null) args.add(expr);
          accept(TokenType.comma);
        }
        return FunctionCall(name, args);
      }
      return Identifier(name);
    }
    if (current.type == TokenType.number) {
      final val = double.parse(current.lexeme);
      advance();
      return NumberLiteral(val);
    }
    return null;
  }

  Action parseAction() {
    final name = current.lexeme;
    advance();
    return Action(name);
  }

  void expect(TokenType type) {
    if (current.type != type) throw Exception("Expected $type");
    advance();
  }
}
EOF
cat > lib/features/strategy_script/domain/interpreter.dart << 'EOF'
import 'ast.dart';
import '../../../market/domain/entities/candle.dart';
import '../../strategy_script/domain/ast.dart';

typedef IndicatorFunc = List<double> Function(List<CandleEntity>, int);

class ScriptInterpreter {
  final List<ASTNode> ast;
  final Map<String, IndicatorFunc> indicatorLibrary;

  ScriptInterpreter(this.ast, this.indicatorLibrary);

  bool evaluate(List<CandleEntity> history) {
    for (var node in ast) {
      if (node is IfStatement) {
        final cond = _evalExpression(node.condition, history);
        if (cond) {
          if (node.action.type.toUpperCase() == 'BUY') return true;
        }
      }
    }
    return false;
  }

  dynamic _evalExpression(Expression expr, List<CandleEntity> history) {
    if (expr is FunctionCall) {
      final name = expr.name.toUpperCase();
      final args = expr.args.map((e) => _evalExpression(e, history)).toList();

      if (indicatorLibrary.containsKey(name)) {
        return indicatorLibrary[name]!(history, args[1].toInt());
      }
    }
    return null;
  }
}
EOF
cat > lib/features/strategy_script/data/script_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';

class ScriptStorage {
  static const _key = 'strategy_script';

  Future<void> save(String script) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_key, script);
  }

  Future<String?> load() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_key);
  }
}
EOF
cat > lib/features/strategy_script/presentation/pages/script_editor_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../strategy_script/data/script_storage.dart';

class ScriptEditorPage extends StatefulWidget {
  @override
  _ScriptEditorPageState createState() => _ScriptEditorPageState();
}

class _ScriptEditorPageState extends State<ScriptEditorPage> {
  final controller = TextEditingController();

  @override
  void initState() {
    super.initState();
    ScriptStorage().load().then((value) {
      if (value != null) setState(() => controller.text = value);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Edit Strategy Script")),
      body: Column(
        children: [
          Expanded(
            child: TextField(
              controller: controller,
              maxLines: null,
              decoration: InputDecoration(border: OutlineInputBorder()),
            ),
          ),
          ElevatedButton(
            onPressed: () {
              ScriptStorage().save(controller.text);
              Navigator.pop(context);
            },
            child: Text("Save Script"),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/indicators/ema_calculator.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';

class EMAResult {
  final List<double> values;
  EMAResult(this.values);
}

class EMACalculator {
  static EMAResult calculate(List<CandleEntity> data, int period) {
    final values = <double>[];
    if (data.isEmpty || period <= 0) return EMAResult(values);

    final k = 2 / (period + 1);
    double? prevEma;

    for (int i = 0; i < data.length; i++) {
      final price = data[i].close;
      if (i + 1 < period) {
        // Not enough data yet â€” push 0 or null
        values.add(0.0);
      } else if (i + 1 == period) {
        // First EMA = simple average
        final sum = data.sublist(0, period).fold(0.0, (p, c) => p + c.close);
        prevEma = sum / period;
        values.add(prevEma);
      } else {
        final ema = (price - prevEma!) * k + prevEma;
        prevEma = ema;
        values.add(ema);
      }
    }

    return EMAResult(values);
  }
}
EOF
cat > lib/features/market/domain/indicators/rsi_calculator.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';

class RSIResult {
  final List<double> values;
  RSIResult(this.values);
}

class RSICalculator {
  static RSIResult calculate(List<CandleEntity> data, int period) {
    final values = <double>[];
    if (data.length <= period) return RSIResult(values);

    List<double> gains = [];
    List<double> losses = [];

    for (int i = 1; i < data.length; i++) {
      final change = data[i].close - data[i - 1].close;
      gains.add(change > 0 ? change : 0);
      losses.add(change < 0 ? -change : 0);
    }

    double avgGain = gains.take(period).reduce((a, b) => a + b) / period;
    double avgLoss = losses.take(period).reduce((a, b) => a + b) / period;
    values.add(100 - (100 / (1 + (avgGain / avgLoss))));

    for (int i = period; i < gains.length; i++) {
      avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
      avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;

      final rs = avgGain / (avgLoss == 0 ? 1 : avgLoss);
      final rsi = 100 - (100 / (1 + rs));
      values.add(rsi);
    }

    return RSIResult(values);
  }
}
EOF
cat > lib/features/market/domain/indicators/macd_calculator.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';
import 'ema_calculator.dart';

class MACDResult {
  final List<double> macd;
  final List<double> signal;
  final List<double> histogram;

  MACDResult({required this.macd, required this.signal, required this.histogram});
}

class MACDCalculator {
  static MACDResult calculate(List<CandleEntity> data, {int fast = 12, int slow = 26, int signalPeriod = 9}) {
    final close = data.map((c) => c.close).toList();
    final fastEma = EMACalculator.calculate(data, fast).values;
    final slowEma = EMACalculator.calculate(data, slow).values;

    final macdLine = List<double>.generate(close.length, (i) {
      if (i < slow - 1) return 0.0;
      return fastEma[i] - slowEma[i];
    });

    final signalLine = <double>[];
    double? prevSignal;

    for (int i = 0; i < macdLine.length; i++) {
      if (i < slow - 1 + signalPeriod - 1) {
        signalLine.add(0.0);
      } else if (i == slow - 1 + signalPeriod - 1) {
        final sum = macdLine.sublist(slow - 1, slow - 1 + signalPeriod).fold(0.0, (a, b) => a + b);
        prevSignal = sum / signalPeriod;
        signalLine.add(prevSignal);
      } else {
        final next = ((macdLine[i] - prevSignal!) * (2 / (signalPeriod + 1))) + prevSignal;
        prevSignal = next;
        signalLine.add(next);
      }
    }

    final hist = List<double>.generate(close.length, (i) => macdLine[i] - signalLine[i]);

    return MACDResult(macd: macdLine, signal: signalLine, histogram: hist);
  }
}
EOF
cat > lib/features/market/domain/indicators/bollinger_calculator.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';
import 'dart:math';

class BollingerResult {
  final List<double> middle;
  final List<double> upper;
  final List<double> lower;

  BollingerResult({required this.middle, required this.upper, required this.lower});
}

class BollingerCalculator {
  static BollingerResult calculate(List<CandleEntity> data, int period, double mult) {
    final closes = data.map((c) => c.close).toList();
    final middle = <double>[];
    final upper = <double>[];
    final lower = <double>[];

    for (int i = 0; i < closes.length; i++) {
      if (i + 1 >= period) {
        final window = closes.sublist(i + 1 - period, i + 1);
        final mean = window.reduce((a, b) => a + b) / period;
        final variance = window.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b) / period;
        final stdDev = sqrt(variance);

        middle.add(mean);
        upper.add(mean + (stdDev * mult));
        lower.add(mean - (stdDev * mult));
      } else {
        middle.add(0.0);
        upper.add(0.0);
        lower.add(0.0);
      }
    }

    return BollingerResult(middle: middle, upper: upper, lower: lower);
  }
}
EOF
cat > lib/features/market/presentation/widgets/chart_utils/chart_mapper.dart << 'EOF'
import 'dart:ui';
import '../../../market/domain/chart/x_axis_range.dart';

/// Convert a timestamp (DateTime) to an X pixel
double timeToPx(DateTime t, XAxisRange range, double width) {
  final total = range.max.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  if (total == 0) return 0.0;
  final delta = t.millisecondsSinceEpoch - range.min.millisecondsSinceEpoch;
  return (delta / total) * width;
}

/// Convert a price to a Y pixel (inverted coordinate system)
double priceToPx(double price, double minPrice, double maxPrice, double height) {
  if (maxPrice - minPrice == 0) return height / 2;
  return height * (1 - (price - minPrice) / (maxPrice - minPrice));
}
EOF
cat > lib/features/market/presentation/widgets/candles_painter.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../market/domain/entities/candle.dart';
import 'chart_utils/chart_mapper.dart';
import '../../../market/domain/chart/x_axis_range.dart';

class CandlesPainter extends CustomPainter {
  final List<CandleEntity> candles;
  final XAxisRange visibleRange;

  CandlesPainter({required this.candles, required this.visibleRange});

  @override
  void paint(Canvas canvas, Size size) {
    if (candles.isEmpty) return;

    double minPrice = candles.map((c) => c.low).reduce((a, b) => a < b ? a : b);
    double maxPrice = candles.map((c) => c.high).reduce((a, b) => a > b ? a : b);

    final paintBull = Paint()..color = Colors.green;
    final paintBear = Paint()..color = Colors.red;

    for (var c in candles) {
      if (!visibleRange.contains(c.time)) continue;

      final x = timeToPx(c.time, visibleRange, size.width);
      final yHigh = priceToPx(c.high, minPrice, maxPrice, size.height);
      final yLow = priceToPx(c.low, minPrice, maxPrice, size.height);
      final yOpen = priceToPx(c.open, minPrice, maxPrice, size.height);
      final yClose = priceToPx(c.close, minPrice, maxPrice, size.height);

      final isBull = c.close >= c.open;
      final paint = isBull ? paintBull : paintBear;

      // Wick
      canvas.drawLine(Offset(x, yHigh), Offset(x, yLow), paint);

      // Body
      final bodyTop = isBull ? yClose : yOpen;
      final bodyBottom = isBull ? yOpen : yClose;
      canvas.drawRect(Rect.fromLTRB(x - 2, bodyTop, x + 2, bodyBottom), paint);
    }
  }

  @override
  bool shouldRepaint(covariant CandlesPainter old) {
    return old.visibleRange != visibleRange || old.candles != candles;
  }
}
EOF
cat > lib/features/market/presentation/widgets/overlay_indicators_painter.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../market/domain/indicators/types/indicator_series.dart';
import 'chart_utils/chart_mapper.dart';
import '../../../market/domain/chart/x_axis_range.dart';

class OverlayIndicatorsPainter extends CustomPainter {
  final List<IndicatorSeries> seriesList;
  final List<DateTime> times;
  final XAxisRange visibleRange;
  final double minPrice;
  final double maxPrice;

  OverlayIndicatorsPainter({
    required this.seriesList,
    required this.times,
    required this.visibleRange,
    required this.minPrice,
    required this.maxPrice,
  });

  @override
  void paint(Canvas canvas, Size size) {
    for (var series in seriesList) {
      final paint = Paint()
        ..color = series.color
        ..strokeWidth = 2
        ..style = PaintingStyle.stroke;

      Path path = Path();
      bool started = false;

      for (int i = 0; i < times.length; i++) {
        if (!visibleRange.contains(times[i])) continue;

        final x = timeToPx(times[i], visibleRange, size.width);
        final y = priceToPx(series.values[i], minPrice, maxPrice, size.height);

        if (!started) {
          path.moveTo(x, y);
          started = true;
        } else {
          path.lineTo(x, y);
        }
      }
      canvas.drawPath(path, paint);
    }
  }

  @override
  bool shouldRepaint(covariant OverlayIndicatorsPainter old) => true;
}
EOF
cat > lib/features/market/presentation/widgets/subchart_rsi_painter.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../market/domain/chart/x_axis_range.dart';
import 'chart_utils/chart_mapper.dart';

class RSIChartPainter extends CustomPainter {
  final List<DateTime> times;
  final List<double> values;
  final XAxisRange visibleRange;

  RSIChartPainter({required this.times, required this.values, required this.visibleRange});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()..color = Colors.purple..strokeWidth = 1.5;

    double maxVal = values.reduce((a, b) => a > b ? a : b);
    double minVal = values.reduce((a, b) => a < b ? a : b);

    Path path = Path();
    bool started = false;

    for (int i = 0; i < times.length; i++) {
      if (!visibleRange.contains(times[i])) continue;

      final x = timeToPx(times[i], visibleRange, size.width);
      final y = priceToPx(values[i], minVal, maxVal, size.height);

      if (!started) {
        path.moveTo(x, y);
        started = true;
      } else {
        path.lineTo(x, y);
      }
    }
    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant RSIChartPainter old) => true;
}
EOF
cat > lib/core/widgets/crosshair.dart << 'EOF'
import 'package:flutter/material.dart';

class CrosshairPainter extends CustomPainter {
  final Offset position;
  final XAxisRange visibleRange;
  final double minPrice;
  final double maxPrice;

  CrosshairPainter({
    required this.position,
    required this.visibleRange,
    required this.minPrice,
    required this.maxPrice,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = Colors.white70
      ..strokeWidth = 1;

    // Vertical line
    canvas.drawLine(Offset(position.dx, 0), Offset(position.dx, size.height), paint);

    // Horizontal line
    canvas.drawLine(Offset(0, position.dy), Offset(size.width, position.dy), paint);
  }

  @override
  bool shouldRepaint(covariant CrosshairPainter old) => old.position != position;
}
EOF
cat > lib/core/widgets/marker_painter.dart << 'EOF'
import 'package:flutter/material.dart';

class MarkerPainter extends CustomPainter {
  final List<Offset> buyPoints;
  final List<Offset> sellPoints;

  MarkerPainter({required this.buyPoints, required this.sellPoints});

  @override
  void paint(Canvas canvas, Size size) {
    final paintBuy = Paint()..color = Colors.greenAccent;
    final paintSell = Paint()..color = Colors.redAccent;

    for (var p in buyPoints) {
      canvas.drawCircle(p, 6, paintBuy);
    }
    for (var p in sellPoints) {
      canvas.drawCircle(p, 6, paintSell);
    }
  }

  @override
  bool shouldRepaint(covariant MarkerPainter old) => true;
}
EOF
cat >> lib/core/network/oanda_rest_client.dart << 'EOF'

  void setTokenExpiredCallback(Function()? callback) {
    _tokenExpiredCallback = callback;
  }

  Function()? _tokenExpiredCallback;
EOF
cat >> lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart << 'EOF'
class TokenExpiredEvent extends OandaSetupEvent {}
EOF
cat >> lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart << 'EOF'
class OandaTokenExpired extends OandaSetupState {}
EOF
cat >> lib/core/network/oanda_stream_client.dart << 'EOF'

bool _disposed = false;
void startStreaming() {
  _connect();
}

void _connect() async {
  final channel = IOWebSocketChannel.connect(_url);

  channel.stream.listen((msg) {
    _lastReceivedTime = DateTime.now();
    _onMessage(msg);
  }, onError: (e) {
    if (!_disposed) Future.delayed(Duration(seconds: 2), () => _connect());
  }, onDone: () {
    if (!_disposed) Future.delayed(Duration(seconds: 2), () => _connect());
  });

  _startHeartbeatMonitor();
}

void _startHeartbeatMonitor() {
  Timer.periodic(Duration(seconds: 10), (t) {
    if (DateTime.now().difference(_lastReceivedTime).inSeconds > 30) {
      // reconnect
      _connect();
    }
  });
}

void dispose() {
  _disposed = true;
}
EOF
cat > lib/features/market/data/tick_aggregator.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';
import '../../../market/domain/entities/tick.dart';

class CandleAggregator {
  final Duration interval;
  final List<CandleEntity> result = [];
  DateTime? currentStart;
  CandleEntity? current;

  List<Tick> buffer = [];

  CandleAggregator(this.interval);

  void processTick(Tick tick) {
    buffer.add(tick);
    buffer.sort((a, b) => a.time.compareTo(b.time));

    final start = _alignToInterval(buffer.first.time);

    if (currentStart == null) {
      currentStart = start;
      current = CandleEntity(
        time: start,
        open: buffer.first.price,
        high: buffer.first.price,
        low: buffer.first.price,
        close: buffer.first.price,
        volume: 0,
      );
    }

    while (buffer.isNotEmpty) {
      final t = buffer.removeAt(0);

      if (t.time.isBefore(currentStart!.add(interval))) {
        current!.high = max(current!.high, t.price);
        current!.low = min(current!.low, t.price);
        current!.close = t.price;
        current!.volume += 1;
      } else {
        result.add(current!);
        currentStart = _alignToInterval(t.time);
        current = CandleEntity(
          time: currentStart!,
          open: t.price,
          high: t.price,
          low: t.price,
          close: t.price,
          volume: 1,
        );
      }
    }
  }

  DateTime _alignToInterval(DateTime t) {
    final millis = t.millisecondsSinceEpoch;
    final intInterval = interval.inMilliseconds;
    final startMillis = (millis ~/ intInterval) * intInterval;
    return DateTime.fromMillisecondsSinceEpoch(startMillis);
  }
}
EOF
cat >> lib/core/network/rate_limit_interceptor.dart << 'EOF'
import 'package:dio/dio.dart';

class RateLimitInterceptor extends Interceptor {
  @override
  void onError(DioError err, ErrorInterceptorHandler handler) {
    if (err.response?.statusCode == 429) {
      final retryAfter = int.tryParse(err.response?.headers.value('retry-after') ?? '1') ?? 1;
      Future.delayed(Duration(seconds: retryAfter), () {
        handler.next(err);
      });
      return;
    }
    handler.next(err);
  }
}
EOF
cat > lib/features/market/data/candle_normalizer.dart << 'EOF'
import '../../../market/domain/entities/candle.dart';

class CandleNormalizer {
  static List<CandleEntity> fillGaps(List<CandleEntity> input, Duration interval) {
    if (input.isEmpty) return [];
    List<CandleEntity> output = [];
    DateTime curr = input.first.time;

    final end = input.last.time;

    int idx = 0;
    while (curr.isBefore(end)) {
      if (idx < input.length && input[idx].time == curr) {
        output.add(input[idx]);
        idx++;
      } else {
        final prev = output.isNotEmpty ? output.last.close : 0;
        output.add(CandleEntity(
          time: curr,
          open: prev,
          high: prev,
          low: prev,
          close: prev,
          volume: 0,
        ));
      }
      curr = curr.add(interval);
    }
    return output;
  }
}
EOF
cat > lib/core/network/error_utils.dart << 'EOF'
import 'package:dio/dio.dart';

enum OandaErrorType { network, client, server, rateLimit, unknown }

OandaErrorType classifyError(DioError e) {
  if (e.type == DioErrorType.connectTimeout || e.type == DioErrorType.receiveTimeout) {
    return OandaErrorType.network;
  }
  final status = e.response?.statusCode ?? 0;
  if (status >= 400 && status < 500) return OandaErrorType.client;
  if (status == 429) return OandaErrorType.rateLimit;
  if (status >= 500) return OandaErrorType.server;
  return OandaErrorType.unknown;
}
EOF
cat > lib/features/market/domain/backtest/backtest_models.dart << 'EOF'
enum OrderSide { buy, sell }

class BacktestOrder {
  final OrderSide side;
  final DateTime time;
  final double price;
  final double size;

  BacktestOrder({
    required this.side,
    required this.time,
    required this.price,
    required this.size,
  });
}

class Position {
  final OrderSide side;
  final DateTime entryTime;
  final double entryPrice;
  final double size;
  double exitPrice;
  DateTime? exitTime;

  Position({
    required this.side,
    required this.entryTime,
    required this.entryPrice,
    required this.size,
    this.exitPrice = 0.0,
    this.exitTime,
  });

  double get profit => (exitPrice - entryPrice) * (side == OrderSide.buy ? 1 : -1) * size;
}
EOF
cat > lib/features/market/domain/backtest/backtest_result.dart << 'EOF'
class BacktestResult {
  final List<double> equityCurve;
  final List<Position> positions;
  final int totalTrades;
  final double netProfit;
  final double winRate;
  final double maxDrawdown;

  BacktestResult({
    required this.equityCurve,
    required this.positions,
    required this.totalTrades,
    required this.netProfit,
    required this.winRate,
    required this.maxDrawdown,
  });
}
EOF
cat > lib/features/market/domain/backtest/backtest_engine.dart << 'EOF'
import 'package:meta/meta.dart';
import '../../../market/domain/entities/candle.dart';
import '../../domain/strategy/strategy_manager.dart';
import 'backtest_models.dart';
import 'backtest_result.dart';

class BacktestEngine {
  final List<CandleEntity> history;
  final StrategyManager strategy;
  final double initialCapital;

  BacktestEngine({
    required this.history,
    required this.strategy,
    this.initialCapital = 10000,
  });

  BacktestResult run() {
    double equity = initialCapital;
    List<double> equityCurve = [];
    List<Position> openPositions = [];
    List<Position> closedPositions = [];

    for (int i = 1; i < history.length; i++) {
      final candle = history[i];

      // Update indicators incrementally
      strategy.updateWithCandle(candle, i);

      // Check signal
      final signal = strategy.checkSignal();

      // Entry logic
      if (signal == Signal.BUY) {
        openPositions.add(Position(
          side: OrderSide.buy,
          entryTime: candle.time,
          entryPrice: candle.close,
          size: 1.0,
        ));
      }

      // Exit logic (SELL)
      if (signal == Signal.SELL && openPositions.isNotEmpty) {
        Position pos = openPositions.removeLast();
        pos.exitPrice = candle.close;
        pos.exitTime = candle.time;
        closedPositions.add(pos);
        equity += pos.profit;
      }

      equityCurve.add(equity);
    }

    final totalTrades = closedPositions.length;
    final wins = closedPositions.where((p) => p.profit > 0).length;
    final winRate = totalTrades > 0 ? wins / totalTrades : 0.0;
    final netProfit = equity - initialCapital;

    double peak = equityCurve.first;
    double maxDrawdown = 0;
    for (var val in equityCurve) {
      if (val > peak) peak = val;
      final dd = (peak - val) / peak;
      if (dd > maxDrawdown) maxDrawdown = dd;
    }

    return BacktestResult(
      equityCurve: equityCurve,
      positions: closedPositions,
      totalTrades: totalTrades,
      netProfit: netProfit,
      winRate: winRate,
      maxDrawdown: maxDrawdown,
    );
  }
}
EOF
cat > lib/core/bloc/app_bloc_observer.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

class AppBlocObserver extends BlocObserver {
  @override
  void onEvent(Bloc bloc, Object? event) {
    super.onEvent(bloc, event);
    print('[BlocEvent] ${bloc.runtimeType} $event');
  }

  @override
  void onChange(BlocBase bloc, Change change) {
    super.onChange(bloc, change);
    print('[BlocChange] ${bloc.runtimeType} $change');
  }

  @override
  void onError(BlocBase bloc, Object error, StackTrace stackTrace) {
    super.onError(bloc, error, stackTrace);
    print('[BlocError] ${bloc.runtimeType} $error');
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_state.dart << 'EOF'
abstract class ChartState {}

class ChartInitial extends ChartState {}

class ChartLoading extends ChartState {}

class ChartLoaded extends ChartState {
  final List candles;
  final XAxisRange visibleRange;
  final Map<String, dynamic>? indicators;

  ChartLoaded({
    required this.candles,
    required this.visibleRange,
    this.indicators,
  });
}

class ChartUpdating extends ChartState {
  final ChartLoaded previous;
  ChartUpdating(this.previous);
}

class ChartError extends ChartState {
  final String error;
  ChartError(this.error);
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_event.dart << 'EOF'
abstract class ChartEvent {}

class LoadChart extends ChartEvent {
  final String symbol;
  final String timeframe;
  LoadChart({required this.symbol, required this.timeframe});
}

class UpdateVisibleRange extends ChartEvent {
  final DateTime min, max;
  UpdateVisibleRange({required this.min, required this.max});
}

class RefreshChart extends ChartEvent {}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'chart_event.dart';
import 'chart_state.dart';
import '../../../../market/data/repositories/market_repository.dart';

class ChartBloc extends Bloc<ChartEvent, ChartState> {
  final MarketRepository repository;

  ChartBloc(this.repository) : super(ChartInitial()) {
    on<LoadChart>(_onLoad);
    on<UpdateVisibleRange>(_onUpdateRange);
    on<RefreshChart>(_onRefresh);
  }

  void _onLoad(LoadChart event, Emitter<ChartState> emit) async {
    emit(ChartLoading());
    try {
      final data = await repository.getHistoricalCandles(
          symbol: event.symbol, timeframe: event.timeframe);
      emit(ChartLoaded(
          candles: data,
          visibleRange: XAxisRange(min: data.first.time, max: data.last.time)));
    } catch (e) {
      emit(ChartError(e.toString()));
    }
  }

  void _onUpdateRange(UpdateVisibleRange event, Emitter<ChartState> emit) {
    if (state is ChartLoaded) {
      final prev = state as ChartLoaded;
      emit(ChartLoaded(
          candles: prev.candles,
          visibleRange:
              XAxisRange(min: event.min, max: event.max),
          indicators: prev.indicators));
    }
  }

  void _onRefresh(RefreshChart event, Emitter<ChartState> emit) {
    if (state is ChartLoaded) {
      final prev = state as ChartLoaded;
      add(LoadChart(
          symbol: prev.candles.first.instrument,
          timeframe: prev.visibleRange.toString()));
    }
  }
}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_state.dart << 'EOF'
abstract class TradingState {}

class TradingInitial extends TradingState {}

class TradingLoading extends TradingState {}

class TradingSuccess extends TradingState {
  final List openPositions;
  TradingSuccess(this.openPositions);
}

class TradingFailure extends TradingState {
  final String message;
  TradingFailure(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_event.dart << 'EOF'
abstract class TradingEvent {}

class PlaceOrder extends TradingEvent {
  final OrderRequest request;
  PlaceOrder(this.request);
}

class ClosePosition extends TradingEvent {
  final String instrument;
  ClosePosition(this.instrument);
}

class RefreshPositions extends TradingEvent {}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'trading_event.dart';
import 'trading_state.dart';
import '../../../../market/data/repositories/trading_repository.dart';

class TradingBloc extends Bloc<TradingEvent, TradingState> {
  final TradingRepository repository;

  TradingBloc(this.repository) : super(TradingInitial()) {
    on<PlaceOrder>(_onPlaceOrder);
    on<ClosePosition>(_onClosePosition);
    on<RefreshPositions>(_onRefreshPositions);
  }

  void _onPlaceOrder(PlaceOrder event, Emitter<TradingState> emit) async {
    emit(TradingLoading());
    try {
      final result = await repository.placeOrder(event.request);
      emit(TradingSuccess(result.openPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }

  void _onClosePosition(ClosePosition event, Emitter<TradingState> emit) async {
    emit(TradingLoading());
    try {
      final result = await repository.closePosition(event.instrument);
      emit(TradingSuccess(result.openPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }

  void _onRefreshPositions(RefreshPositions event, Emitter<TradingState> emit) async {
    emit(TradingLoading());
    try {
      final result = await repository.getOpenPositions();
      emit(TradingSuccess(result.openPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }
}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_state.dart << 'EOF'
abstract class BacktestState {}

class BacktestInitial extends BacktestState {}

class BacktestRunning extends BacktestState {}

class BacktestSuccess extends BacktestState {
  final BacktestResult result;
  BacktestSuccess(this.result);
}

class BacktestError extends BacktestState {
  final String message;
  BacktestError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_event.dart << 'EOF'
abstract class BacktestEvent {}

class RunBacktest extends BacktestEvent {
  final List<CandleEntity> history;
  final StrategyManager strategy;

  RunBacktest({required this.history, required this.strategy});
}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'backtest_event.dart';
import 'backtest_state.dart';
import '../../../../market/domain/backtest/backtest_engine.dart';

class BacktestBloc extends Bloc<BacktestEvent, BacktestState> {
  BacktestBloc() : super(BacktestInitial()) {
    on<RunBacktest>(_onRun);
  }

  void _onRun(RunBacktest event, Emitter<BacktestState> emit) async {
    emit(BacktestRunning());
    try {
      final result = BacktestEngine(
        history: event.history,
        strategy: event.strategy,
      ).run();
      emit(BacktestSuccess(result));
    } catch (e) {
      emit(BacktestError(e.toString()));
    }
  }
}
EOF
cat > lib/core/storage/theme/theme_hive.dart << 'EOF'
import 'package:hive/hive.dart';
import 'package:flutter/material.dart';

part 'theme_hive.g.dart';

@HiveType(typeId: 1)
class ThemeEntity extends HiveObject {
  @HiveField(0)
  final bool isDark;

  @HiveField(1)
  final int bullCandleValue;

  @HiveField(2)
  final int bearCandleValue;

  ThemeEntity({
    required this.isDark,
    required this.bullCandleValue,
    required this.bearCandleValue,
  });

  ThemeData toThemeData() {
    return ThemeData(
      brightness: isDark ? Brightness.dark : Brightness.light,
      primaryColor: Color(bullCandleValue),
      accentColor: Color(bearCandleValue),
    );
  }
}
EOF
cat > lib/core/storage/theme/theme_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'theme_hive.dart';

class ThemeStorage {
  static const _boxName = "theme_box";

  Future<void> saveTheme(ThemeEntity theme) async {
    final box = await Hive.openBox<ThemeEntity>(_boxName);
    await box.put('current', theme);
  }

  Future<ThemeEntity?> loadTheme() async {
    final box = await Hive.openBox<ThemeEntity>(_boxName);
    return box.get('current');
  }
}
EOF
cat > lib/core/storage/script/script_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'script_hive.g.dart';

@HiveType(typeId: 2)
class ScriptEntity extends HiveObject {
  @HiveField(0)
  final String name;

  @HiveField(1)
  final String script;

  ScriptEntity({required this.name, required this.script});
}
EOF
cat > lib/core/storage/script/script_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'script_hive.dart';

class ScriptStorage {
  static const _boxName = "scripts_box";

  Future<void> saveScript(ScriptEntity script) async {
    final box = await Hive.openBox<ScriptEntity>(_boxName);
    await box.put(script.name, script);
  }

  Future<ScriptEntity?> loadScript(String name) async {
    final box = await Hive.openBox<ScriptEntity>(_boxName);
    return box.get(name);
  }

  Future<List<ScriptEntity>> getAllScripts() async {
    final box = await Hive.openBox<ScriptEntity>(_boxName);
    return box.values.toList();
  }
}
EOF
cat > lib/core/storage/audit/audit_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'audit_hive.g.dart';

@HiveType(typeId: 3)
class AuditEntity extends HiveObject {
  @HiveField(0)
  final DateTime time;

  @HiveField(1)
  final String type;

  @HiveField(2)
  final String details;

  AuditEntity({required this.time, required this.type, required this.details});
}
EOF
cat > lib/core/storage/audit/audit_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'audit_hive.dart';

class AuditStorage {
  static const _boxName = "audit_box";

  Future<void> logEvent(AuditEntity event) async {
    final box = await Hive.openBox<AuditEntity>(_boxName);
    await box.add(event);
  }

  Future<List<AuditEntity>> getAllEvents() async {
    final box = await Hive.openBox<AuditEntity>(_boxName);
    return box.values.toList();
  }

  Future<void> clear() async {
    final box = await Hive.openBox<AuditEntity>(_boxName);
    await box.clear();
  }
}
EOF
cat > lib/core/storage/indicator/indicator_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'indicator_hive.g.dart';

@HiveType(typeId: 4)
class IndicatorSettingsEntity extends HiveObject {
  @HiveField(0)
  final String id;
  @HiveField(1)
  final Map<String, dynamic> params;

  IndicatorSettingsEntity({required this.id, required this.params});
}
EOF
cat > lib/core/storage/indicator/indicator_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'indicator_hive.dart';

class IndicatorStorage {
  static const _boxName = "indicator_box";

  Future<void> saveSettings(IndicatorSettingsEntity e) async {
    final box = await Hive.openBox<IndicatorSettingsEntity>(_boxName);
    await box.put(e.id, e);
  }

  Future<IndicatorSettingsEntity?> loadSettings(String id) async {
    final box = await Hive.openBox<IndicatorSettingsEntity>(_boxName);
    return box.get(id);
  }

  Future<List<IndicatorSettingsEntity>> getAllSettings() async {
    final box = await Hive.openBox<IndicatorSettingsEntity>(_boxName);
    return box.values.toList();
  }
}
EOF
cat > lib/core/storage/oanda/secure_storage.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class OandaSecureStorage {
  final _storage = FlutterSecureStorage();

  static const _tokenKey = "oanda_token";
  static const _accountIdKey = "oanda_account";

  Future<void> saveToken(String token) async {
    await _storage.write(key: _tokenKey, value: token);
  }

  Future<String?> loadToken() async {
    return await _storage.read(key: _tokenKey);
  }

  Future<void> saveAccountId(String id) async {
    await _storage.write(key: _accountIdKey, value: id);
  }

  Future<String?> loadAccountId() async {
    return await _storage.read(key: _accountIdKey);
  }

  Future<void> clearAll() async {
    await _storage.deleteAll();
  }
}
EOF
cat > lib/core/storage/replay_storage.dart << 'EOF'
import 'package:hive/hive.dart';

part 'replay_storage.g.dart';

@HiveType(typeId: 5)
class ReplayStateEntity extends HiveObject {
  @HiveField(0)
  final String symbol;
  @HiveField(1)
  final String timeframe;
  @HiveField(2)
  final int lastIndex;

  ReplayStateEntity({
    required this.symbol,
    required this.timeframe,
    required this.lastIndex,
  });
}
EOF
cat > test/domain/indicators/ema_calculator_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/indicators/ema_calculator.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('EMA returns correct length and values', () {
    final data = List.generate(10, (i) => CandleEntity(
      time: DateTime.now().add(Duration(minutes: i)),
      open: i.toDouble(),
      high: i.toDouble() + 1,
      low: i.toDouble() - 1,
      close: i.toDouble(),
      volume: 1,
    ));

    final ema = EMACalculator.calculate(data, 5).values;

    expect(ema.length, 10);
    expect(ema.skip(4).first,
      greaterThan(ema.skip(3).first));
  });
}
EOF
cat > test/domain/indicators/rsi_calculator_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/indicators/rsi_calculator.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('RSI simple test', () {
    final data = List.generate(20, (i) => CandleEntity(
      time: DateTime.now().add(Duration(minutes: i)),
      open: i.toDouble(),
      high: i.toDouble(),
      low: i.toDouble(),
      close: i.toDouble() + 1,
      volume: 1,
    ));

    final rsi = RSICalculator.calculate(data, 14).values;
    expect(rsi.length, greaterThan(0));
    expect(rsi.first, isNonNegative);
  });
}
EOF
cat > test/domain/backtest/backtest_engine_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('Backtest should return correct stats', () {
    final history = List.generate(30, (i) => CandleEntity(
      time: DateTime.now().add(Duration(minutes: i)),
      open: i.toDouble(),
      high: i.toDouble() + 1,
      low: i.toDouble() - 1,
      close: i.isEven ? i.toDouble() + 1 : i.toDouble() - 1,
      volume: 1,
    ));

    final engine = BacktestEngine(history: history, strategy: /* your test strategy */);
    final result = engine.run();

    expect(result.equityCurve.first, 10000);
    expect(result.totalTrades, isNonNegative);
  });
}
EOF
cat > test/bloc/chart_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_state.dart';
import 'package:your_app/market/data/repositories/market_repository.dart';
import 'package:mocktail/mocktail.dart';

class MockMarketRepo extends Mock implements MarketRepository {}

void main() {
  group('ChartBloc', () {
    late ChartBloc bloc;
    late MockMarketRepo repo;

    setUp(() {
      repo = MockMarketRepo();
      bloc = ChartBloc(repo);
    });

    blocTest<ChartBloc, ChartState>(
      'emits ChartLoaded on successful LoadChart',
      build: () {
        when(() => repo.getHistoricalCandles(symbol: any(named: 'symbol'),
            timeframe: any(named: 'timeframe')))
            .thenAnswer((_) async => []);
        return bloc;
      },
      act: (b) => b.add(LoadChart(symbol: 'EU', timeframe: 'M1')),
      expect: () => [isA<ChartLoading>(), isA<ChartLoaded>()],
    );
  });
}
EOF
cat > test/widgets/strategy_builder_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy_builder/presentation/pages/strategy_builder_page.dart';
import 'package:flutter/material.dart';

void main() {
  testWidgets('Strategy builder shows nodes list', (tester) async {
    await tester.pumpWidget(MaterialApp(home: StrategyBuilderPage()));
    expect(find.text('Price Above'), findsOneWidget);
    expect(find.text('EMA Cross Up'), findsOneWidget);
  });
}
EOF
cat > test/domain/candle_normalizer_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/data/candle_normalizer.dart';
import 'package:your_app/market/domain/entities/candle.dart';

void main() {
  test('fillGaps should produce continuous candles', () {
    final input = [
      CandleEntity(time: DateTime(2025,1,1,10,0), open:1,high:1,low:1,close:1,volume:1),
      CandleEntity(time: DateTime(2025,1,1,10,2), open:2,high:2,low:2,close:2,volume:1),
    ];
    final output = CandleNormalizer.fillGaps(input, Duration(minutes:1));
    expect(output.length, 3);
    expect(output[1].volume, 0);
  });
}
EOF
cat > lib/core/models/candle_entity.dart << 'EOF'
class CandleEntity {
  final String instrument;   // e.g. "XAU_USD"
  final DateTime timeUtc;    // UTC time
  final double open;
  final double high;
  final double low;
  final double close;
  final double volume;

  CandleEntity({
    required this.instrument,
    required this.timeUtc,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });

  factory CandleEntity.fromJson(String instrument, Map<String, dynamic> json) {
    return CandleEntity(
      instrument: instrument,
      // convert to UTC
      timeUtc: DateTime.parse(json['time']).toUtc(),
      open: double.parse(json['open']),
      high: double.parse(json['high']),
      low: double.parse(json['low']),
      close: double.parse(json['close']),
      volume: double.parse(json['volume']),
    );
  }

  Map<String, dynamic> toJson() {
    return {
      "time": timeUtc.toIso8601String(),
      "open": open.toString(),
      "high": high.toString(),
      "low": low.toString(),
      "close": close.toString(),
      "volume": volume.toString(),
    };
  }
}
EOF
cat > lib/core/models/tick_entity.dart << 'EOF'
class TickEntity {
  final String instrument;
  final DateTime timeUtc;
  final double bid;
  final double ask;

  TickEntity({
    required this.instrument,
    required this.timeUtc,
    required this.bid,
    required this.ask,
  });

  factory TickEntity.fromJson(String instrument, Map<String, dynamic> json) {
    return TickEntity(
      instrument: instrument,
      timeUtc: DateTime.parse(json['time']).toUtc(),
      bid: double.parse(json['bid']),
      ask: double.parse(json['ask']),
    );
  }

  double get mid => (bid + ask) / 2;
}
EOF
cat > test/models/candle_entity_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('CandleEntity UTC conversion & fields', () {
    final json = {
      "time": "2025-01-01T10:00:00Z",
      "open": "100",
      "high": "110",
      "low": "90",
      "close": "105",
      "volume": "1000"
    };

    final candle = CandleEntity.fromJson("EUR_USD", json);

    expect(candle.instrument, "EUR_USD");
    expect(candle.timeUtc.isUtc, true);
    expect(candle.open, 100.0);
    expect(candle.high, 110.0);
    expect(candle.close, 105.0);
  });
}
EOF
cat > lib/features/strategy/domain/indicators/indicator.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

abstract class Indicator<T> {
  /// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø± Ù…Ø¹ ÙƒÙ„ Ø´Ù…Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
  void addCandle(CandleEntity candle);

  /// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø© Ø­Ø§Ù„ÙŠØ©
  T get current;

  /// Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  List<T> get series;
}
EOF
cat > lib/features/strategy/domain/indicators/ema.dart << 'EOF'
import '../../../core/models/candle_entity.dart';
import 'indicator.dart';
import 'dart:math';

class EMAIndicator implements Indicator<double> {
  final int period;
  double? _prevEma;
  final List<double> _series = [];

  EMAIndicator(this.period);

  double get _multiplier => 2.0 / (period + 1);

  @override
  void addCandle(CandleEntity candle) {
    final price = candle.close;

    if (_prevEma == null) {
      _prevEma = price; // Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø©
    } else {
      _prevEma = (price - _prevEma!) * _multiplier + _prevEma!;
    }

    _series.add(_prevEma!);
  }

  @override
  double get current => _prevEma ?? 0.0;

  @override
  List<double> get series => List.unmodifiable(_series);
}
EOF
cat > lib/features/strategy/domain/ast/expr_node.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

abstract class ExprNode {
  /// ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø¹Ù†Ø¯ Ø´Ù…Ø¹Ø© Ù…Ø¹ÙŠÙ†Ø©
  bool evaluate(CandleEntity candle, int index);
}
EOF
cat > lib/features/strategy/domain/ast/greater_than_node.dart << 'EOF'
import 'expr_node.dart';
import '../indicators/indicator.dart';
import '../../../core/models/candle_entity.dart';

class GreaterThanNode extends ExprNode {
  final Indicator<double> left;
  final Indicator<double> right;

  GreaterThanNode(this.left, this.right);

  @override
  bool evaluate(CandleEntity candle, int index) {
    return left.current > right.current;
  }
}
EOF
cat > lib/features/strategy/domain/ast/and_node.dart << 'EOF'
import 'expr_node.dart';
import '../../../core/models/candle_entity.dart';

class AndNode extends ExprNode {
  final ExprNode a;
  final ExprNode b;

  AndNode(this.a, this.b);

  @override
  bool evaluate(CandleEntity candle, int index) {
    return a.evaluate(candle, index) && b.evaluate(candle, index);
  }
}
EOF
cat > lib/features/strategy/domain/ast/cross_up_node.dart << 'EOF'
import 'expr_node.dart';
import '../indicators/indicator.dart';
import '../../../core/models/candle_entity.dart';

class CrossUpNode extends ExprNode {
  final Indicator<double> fast;
  final Indicator<double> slow;
  double? _prevFast;
  double? _prevSlow;

  CrossUpNode(this.fast, this.slow);

  @override
  bool evaluate(CandleEntity candle, int index) {
    final currFast = fast.current;
    final currSlow = slow.current;

    bool crossed = false;

    if (_prevFast != null && _prevSlow != null) {
      crossed = (_prevFast! <= _prevSlow!) && (currFast > currSlow);
    }

    _prevFast = currFast;
    _prevSlow = currSlow;

    return crossed;
  }
}
EOF
cat > lib/features/strategy/domain/evaluator/sequential_evaluator.dart << 'EOF'
import '../../../core/models/candle_entity.dart';
import '../ast/expr_node.dart';
import '../indicators/ema.dart';

enum Signal { BUY, SELL, NONE }

class SequentialEvaluator {
  final EMAIndicator emaFast;
  final EMAIndicator emaSlow;
  final ExprNode root;

  SequentialEvaluator({
    required this.emaFast,
    required this.emaSlow,
    required this.root,
  });

  /// ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ø´Ù…ÙˆØ¹
  List<Signal> evaluateSeries(List<CandleEntity> history) {
    List<Signal> signals = [];

    for (int i = 0; i < history.length; i++) {
      final candle = history[i];

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø£ÙˆÙ„Ù‹Ø§
      emaFast.addCandle(candle);
      emaSlow.addCandle(candle);

      // ØªÙ‚ÙŠÙŠÙ… AST
      bool condition = root.evaluate(candle, i);

      if (condition) {
        signals.add(Signal.BUY);
      } else {
        signals.add(Signal.NONE);
      }
    }

    return signals;
  }
}
EOF
cat > lib/features/strategy/domain/evaluator/example_strategy.dart << 'EOF'
import '../indicators/ema.dart';
import '../ast/greater_than_node.dart';
import '../ast/and_node.dart';
import '../ast/cross_up_node.dart';
import 'sequential_evaluator.dart';

SequentialEvaluator buildExampleStrategy() {
  final ema10 = EMAIndicator(10);
  final ema20 = EMAIndicator(20);

  final greater = GreaterThanNode(ema10, ema20);
  final cross = CrossUpNode(ema10, ema20);

  final root = AndNode(greater, cross);

  return SequentialEvaluator(
    emaFast: ema10,
    emaSlow: ema20,
    root: root,
  );
}
EOF
cat > test/strategy/sequential_evaluator_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('SequentialEvaluator produces signals', () {
    final history = List.generate(30, (i) => CandleEntity(
      instrument: "EUR_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble() + 1,
      low: i.toDouble() - 1,
      close: i.toDouble(),
      volume: 1,
    ));

    final evaluator = buildExampleStrategy();
    final signals = evaluator.evaluateSeries(history);

    expect(signals.length, history.length);
  });
}
EOF
cat > lib/core/network/ws_manager.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import 'package:web_socket_channel/status.dart' as status;

class WSManager {
  final String url;
  WebSocketChannel? _channel;
  StreamController<String> _streamController = StreamController.broadcast();
  Timer? _reconnectTimer;
  Timer? _pingTimer;

  WSManager(this.url);

  Stream<String> get stream => _streamController.stream;

  void connect() {
    _channel = WebSocketChannel.connect(Uri.parse(url));

    _channel!.stream.listen(
      (event) {
        _streamController.add(event);
      },
      onDone: _handleDisconnect,
      onError: (err) {
        print('WebSocket error: $err');
        _handleDisconnect();
      },
      cancelOnError: true,
    );

    _startPing();
  }

  void _handleDisconnect() {
    _stopPing();
    _reconnectTimer = Timer(Duration(seconds: 3), () {
      connect();
    });
  }

  void _startPing() {
    _pingTimer = Timer.periodic(Duration(seconds: 15), (_) {
      _channel?.sink.add('ping');
    });
  }

  void _stopPing() {
    _pingTimer?.cancel();
  }

  void send(String msg) {
    _channel?.sink.add(msg);
  }

  void dispose() {
    _stopPing();
    _reconnectTimer?.cancel();
    _channel?.sink.close(status.goingAway);
  }
}
EOF
cat > lib/features/market/data/streaming/tick_aggregator.dart << 'EOF'
import 'dart:collection';
import '../../../core/models/tick_entity.dart';
import '../../../core/models/candle_entity.dart';

class TickAggregator {
  final Duration interval;
  final String instrument;
  final SplayTreeMap<DateTime, List<TickEntity>> _buckets = SplayTreeMap();

  TickAggregator(this.instrument, this.interval);

  void addTick(TickEntity tick) {
    final alignedTime = _align(tick.timeUtc);
    _buckets.putIfAbsent(alignedTime, () => []).add(tick);
  }

  DateTime _align(DateTime time) {
    final seconds = time.second;
    final aligned = DateTime.utc(time.year, time.month, time.day, time.hour,
        time.minute, (seconds ~/ interval.inSeconds) * interval.inSeconds);
    return aligned;
  }

  List<CandleEntity> buildCandles() {
    List<CandleEntity> candles = [];

    for (final entry in _buckets.entries) {
      final ticks = entry.value;
      final open = ticks.first.bid;
      final close = ticks.last.bid;
      final high = ticks.map((e) => e.bid).reduce((a, b) => a > b ? a : b);
      final low = ticks.map((e) => e.bid).reduce((a, b) => a < b ? a : b);

      candles.add(CandleEntity(
        instrument: instrument,
        timeUtc: entry.key,
        open: open,
        high: high,
        low: low,
        close: close,
        volume: ticks.length.toDouble(),
      ));
    }

    _buckets.clear();
    return candles;
  }
}
EOF
cat > lib/core/network/rest_client.dart << 'EOF'
import 'dart:convert';
import 'package:http/http.dart' as http;

class RestClient {
  final String token;
  final String baseUrl;

  RestClient(this.token, this.baseUrl);

  Future<http.Response> get(String endpoint) async {
    final uri = Uri.parse('$baseUrl$endpoint');
    final headers = {
      'Authorization': 'Bearer $token',
    };

    for (int attempt = 0; attempt < 3; attempt++) {
      final response = await http.get(uri, headers: headers);

      if (response.statusCode == 429) {
        final retryAfter = response.headers['retry-after'];
        final wait = int.tryParse(retryAfter ?? '2') ?? 2;
        await Future.delayed(Duration(seconds: wait));
      } else if (response.statusCode == 401) {
        // Handle token refresh logic here
        throw Exception('Token expired');
      } else {
        return response;
      }
    }

    throw Exception('Too many requests, even after retrying.');
  }
}
EOF
cat > test/ws/ws_manager_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/network/ws_manager.dart';

void main() {
  test('WSManager initializes and reconnects', () async {
    final ws = WSManager('wss://echo.websocket.events');
    ws.connect();

    await Future.delayed(Duration(seconds: 2));
    ws.send('ping');

    await ws.stream.first;

    ws.dispose();
  });
}
EOF
cat > lib/features/strategy/domain/indicators/indicator.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

abstract class Indicator<T> {
  void addCandle(CandleEntity candle); // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  T get current;                        // Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø©
  List<T> get series;                  // Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
}
EOF
cat > lib/features/strategy/domain/indicators/ema_indicator.dart << 'EOF'
import 'indicator.dart';
import '../../../core/models/candle_entity.dart';

class EMAIndicator implements Indicator<double> {
  final int period;
  double? _ema;
  final List<double> _series = [];

  EMAIndicator(this.period);

  double get _multiplier => 2.0 / (period + 1);

  @override
  void addCandle(CandleEntity candle) {
    final price = candle.close;

    _ema = _ema == null ? price : (price - _ema!) * _multiplier + _ema!;
    _series.add(_ema!);
  }

  @override
  double get current => _ema ?? 0;

  @override
  List<double> get series => List.unmodifiable(_series);
}
EOF
cat > lib/features/strategy/domain/indicators/rsi_indicator.dart << 'EOF'
import 'indicator.dart';
import '../../../core/models/candle_entity.dart';

class RSIIndicator implements Indicator<double> {
  final int period;
  final List<CandleEntity> _history = [];
  final List<double> _series = [];
  double? _avgGain;
  double? _avgLoss;

  RSIIndicator(this.period);

  @override
  void addCandle(CandleEntity candle) {
    if (_history.isNotEmpty) {
      final prev = _history.last;
      final change = candle.close - prev.close;
      final gain = change > 0 ? change : 0;
      final loss = change < 0 ? -change : 0;

      if (_avgGain == null) {
        _avgGain = gain;
        _avgLoss = loss;
      } else {
        _avgGain = (_avgGain! * (period - 1) + gain) / period;
        _avgLoss = (_avgLoss! * (period - 1) + loss) / period;
      }

      if (_avgLoss == 0) {
        _series.add(100.0);
      } else {
        final rs = _avgGain! / _avgLoss!;
        _series.add(100 - (100 / (1 + rs)));
      }
    }

    _history.add(candle);
  }

  @override
  double get current => _series.isEmpty ? 0 : _series.last;

  @override
  List<double> get series => List.unmodifiable(_series);
}
EOF
cat > lib/features/strategy/domain/indicators/bollinger_indicator.dart << 'EOF'
import 'indicator.dart';
import '../../../core/models/candle_entity.dart';
import 'dart:math';

class BollingerBand {
  final double upper;
  final double middle;
  final double lower;

  BollingerBand(this.upper, this.middle, this.lower);
}

class BollingerIndicator implements Indicator<BollingerBand> {
  final int period;
  final List<double> _closes = [];
  final List<BollingerBand> _series = [];

  BollingerIndicator(this.period);

  @override
  void addCandle(CandleEntity candle) {
    _closes.add(candle.close);
    if (_closes.length > period) _closes.removeAt(0);

    if (_closes.length == period) {
      final mean = _closes.reduce((a, b) => a + b) / period;
      final std = sqrt(_closes.map((v) => pow(v - mean, 2)).reduce((a, b) => a + b) / period);
      final upper = mean + 2 * std;
      final lower = mean - 2 * std;
      _series.add(BollingerBand(upper, mean, lower));
    }
  }

  @override
  BollingerBand get current => _series.isEmpty ? BollingerBand(0,0,0) : _series.last;

  @override
  List<BollingerBand> get series => List.unmodifiable(_series);
}
EOF
cat > test/indicators/ema_rsi_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/indicators/ema_indicator.dart';
import 'package:your_app/features/strategy/domain/indicators/rsi_indicator.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  final candles = List.generate(20, (i) => CandleEntity(
    instrument: "XAU_USD",
    timeUtc: DateTime.utc(2025,1,1,0,i),
    open: i.toDouble(),
    high: i.toDouble(),
    low: i.toDouble(),
    close: i.toDouble(),
    volume: 1,
  ));

  test('EMA calculates correctly', () {
    final ema = EMAIndicator(10);
    for (final c in candles) ema.addCandle(c);
    expect(ema.series.length, candles.length);
    expect(ema.current, greaterThan(0));
  });

  test('RSI calculates correctly', () {
    final rsi = RSIIndicator(14);
    for (final c in candles) rsi.addCandle(c);
    expect(rsi.series.length, greaterThan(1));
    expect(rsi.current, inInclusiveRange(0, 100));
  });
}
EOF
cat > lib/features/market/domain/backtest/backtest_models.dart << 'EOF'
enum OrderSide { buy, sell }

class Order {
  final OrderSide side;
  final DateTime time;
  final double price;
  final double size;

  Order({
    required this.side,
    required this.time,
    required this.price,
    required this.size,
  });
}

class Position {
  final OrderSide side;
  final DateTime entryTime;
  final double entryPrice;
  final double size;
  DateTime? exitTime;
  double? exitPrice;

  Position({
    required this.side,
    required this.entryTime,
    required this.entryPrice,
    required this.size,
    this.exitPrice,
    this.exitTime,
  });

  double get profit {
    if (exitPrice == null) return 0.0;
    return (side == OrderSide.buy)
        ? (exitPrice! - entryPrice) * size
        : (entryPrice - exitPrice!) * size;
  }
}
EOF
cat > lib/features/market/domain/backtest/backtest_result.dart << 'EOF'
class BacktestResult {
  final List<double> equityCurve;
  final List<double> balanceCurve;
  final List<dynamic> trades; // ÙŠÙ…ÙƒÙ† ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù†ÙˆØ¹ Ù„Ø§Ø­Ù‚Ù‹Ø§
  final double netProfit;
  final double winRate;
  final double maxDrawdown;

  BacktestResult({
    required this.equityCurve,
    required this.balanceCurve,
    required this.trades,
    required this.netProfit,
    required this.winRate,
    required this.maxDrawdown,
  });
}
EOF
cat > lib/features/market/domain/backtest/backtest_engine.dart << 'EOF'
import 'package:meta/meta.dart';
import '../../../core/models/candle_entity.dart';
import '../strategy/domain/evaluator/sequential_evaluator.dart';
import 'backtest_models.dart';
import 'backtest_result.dart';

class BacktestEngine {
  final List<CandleEntity> history;
  final SequentialEvaluator evaluator;
  final double initialBalance;
  final double takeProfit; // Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ (Ù…Ø«Ø§Ù„: 0.02 = 2%)
  final double stopLoss;   // Ù†Ø³Ø¨Ø© Ø§Ù„Ø®Ø³Ø§Ø±Ø© (Ù…Ø«Ø§Ù„: 0.01 = 1%)

  BacktestEngine({
    required this.history,
    required this.evaluator,
    this.initialBalance = 10000,
    this.takeProfit = 0,
    this.stopLoss = 0,
  });

  BacktestResult run() {
    double balance = initialBalance;
    double equity = initialBalance;
    List<double> equityCurve = [];
    List<double> balanceCurve = [];
    List<dynamic> trades = [];

    Position? currentPosition;

    for (int i = 0; i < history.length; i++) {
      final candle = history[i];

      // --- 1) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ---
      evaluator.emaFast.addCandle(candle);
      evaluator.emaSlow.addCandle(candle);
      bool signal = evaluator.root.evaluate(candle, i);

      // --- 2) Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ---
      if (currentPosition != null) {
        final price = candle.close;

        final profit = (currentPosition.side == OrderSide.buy)
            ? (price - currentPosition.entryPrice) * currentPosition.size
            : (currentPosition.entryPrice - price) * currentPosition.size;

        equity = balance + profit;

        // --- ØªØ­Ù‚Ù‚ TP/SL Ø¥Ø°Ø§ ÙƒØ§Ù†Øª > 0 ---
        if (takeProfit > 0 && profit >= currentPosition.entryPrice * takeProfit) {
          currentPosition.exitPrice = price;
          currentPosition.exitTime = candle.timeUtc;
          trades.add(currentPosition);
          balance += profit;
          currentPosition = null;
        } else if (stopLoss > 0 &&
            profit <= -currentPosition.entryPrice * stopLoss) {
          currentPosition.exitPrice = price;
          currentPosition.exitTime = candle.timeUtc;
          trades.add(currentPosition);
          balance += profit;
          currentPosition = null;
        }
      }

      // --- 3) ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØµÙÙ‚Ø© Ø­Ø§Ù„ÙŠØ© ---
      if (currentPosition == null && signal) {
        currentPosition = Position(
          side: OrderSide.buy,
          entryPrice: candle.close,
          entryTime: candle.timeUtc,
          size: 1.0,
        );
      }

      equityCurve.add(equity);
      balanceCurve.add(balance);
    }

    // --- 4) Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ---
    final netProfit = equity - initialBalance;
    final closedTrades = trades.where((t) => t.exitPrice != null).toList();
    final wins = closedTrades.where((p) => p.profit > 0).length;
    final totalTrades = closedTrades.length;
    final winRate = totalTrades > 0 ? wins / totalTrades : 0.0;

    double peak = equityCurve.isNotEmpty ? equityCurve.first : initialBalance;
    double maxDrawdown = 0;
    for (var val in equityCurve) {
      if (val > peak) peak = val;
      final dd = (peak - val) / peak;
      if (dd > maxDrawdown) maxDrawdown = dd;
    }

    return BacktestResult(
      equityCurve: equityCurve,
      balanceCurve: balanceCurve,
      trades: trades,
      netProfit: netProfit,
      winRate: winRate,
      maxDrawdown: maxDrawdown,
    );
  }
}
EOF
cat > test/backtest/backtest_engine_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('Backtest basic run', () {
    final history = List.generate(50, (i) => CandleEntity(
      instrument: "EUR_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble()+1,
      low: i.toDouble()-1,
      close: i.toDouble(),
      volume: 1,
    ));

    final engine = BacktestEngine(
      history: history,
      evaluator: buildExampleStrategy(),
      initialBalance: 10000,
      takeProfit: 0.01,
      stopLoss: 0.005,
    );

    final result = engine.run();
    expect(result.equityCurve.length, history.length);
    expect(result.netProfit, isA<double>());
    expect(result.winRate, inInclusiveRange(0.0, 1.0));
  });
}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_setup_event.dart << 'EOF'
abstract class OandaSetupEvent {}

class SubmitOandaCredentials extends OandaSetupEvent {
  final String token;
  final String accountId;

  SubmitOandaCredentials({
    required this.token,
    required this.accountId,
  });
}

class RetryConnection extends OandaSetupEvent {}

class LogoutOanda extends OandaSetupEvent {}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_setup_state.dart << 'EOF'
abstract class OandaSetupState {}

class OandaInitial extends OandaSetupState {}

class OandaLoading extends OandaSetupState {}

class OandaConnected extends OandaSetupState {}

class OandaTokenExpired extends OandaSetupState {}

class OandaError extends OandaSetupState {
  final String message;
  OandaError(this.message);
}

class OandaLoggedOut extends OandaSetupState {}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'oanda_setup_event.dart';
import 'oanda_setup_state.dart';
import '../../../../core/storage/oanda/secure_storage.dart';
import '../../../../core/network/rest_client.dart';

class OandaSetupBloc extends Bloc<OandaSetupEvent, OandaSetupState> {
  final OandaSecureStorage storage;
  final String baseUrl;

  OandaSetupBloc({
    required this.storage,
    required this.baseUrl,
  }) : super(OandaInitial()) {
    on<SubmitOandaCredentials>(_onSubmit);
    on<RetryConnection>(_onRetry);
    on<LogoutOanda>(_onLogout);
  }

  Future<void> _onSubmit(SubmitOandaCredentials event, Emitter<OandaSetupState> emit) async {
    emit(OandaLoading());

    try {
      // store securely
      await storage.saveToken(event.token);
      await storage.saveAccountId(event.accountId);

      // test connection
      final rest = RestClient(event.token, baseUrl);
      final res = await rest.get('/v3/accounts/${event.accountId}');
      if (res.statusCode == 200) {
        emit(OandaConnected());
      } else if (res.statusCode == 401) {
        emit(OandaTokenExpired());
      } else {
        emit(OandaError('HTTP ${res.statusCode}'));
      }
    } catch (e) {
      emit(OandaError(e.toString()));
    }
  }

  Future<void> _onRetry(RetryConnection event, Emitter<OandaSetupState> emit) async {
    final token = await storage.loadToken();
    final accountId = await storage.loadAccountId();

    if (token == null || accountId == null) {
      return emit(OandaError('No credentials stored'));
    }

    add(SubmitOandaCredentials(token: token, accountId: accountId));
  }

  Future<void> _onLogout(LogoutOanda event, Emitter<OandaSetupState> emit) async {
    await storage.clearAll();
    emit(OandaLoggedOut());
  }
}
EOF
cat > test/bloc/oanda_setup/oanda_setup_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/oanda/oanda_setup_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/oanda/oanda_setup_event.dart';
import 'package:your_app/features/market/presentation/bloc/oanda/oanda_setup_state.dart';
import 'package:mocktail/mocktail.dart';
import '../../../mocks.dart';

class MockSecureStorage extends Mock implements OandaSecureStorage {}
class MockRestClient extends Mock implements RestClient {}

void main() {
  group('OandaSetupBloc', () {
    late MockSecureStorage mockStorage;

    setUp(() {
      mockStorage = MockSecureStorage();
    });

    blocTest<OandaSetupBloc, OandaSetupState>(
      'emits Connected when valid credentials',
      build: () {
        return OandaSetupBloc(storage: mockStorage, baseUrl: 'https://fake');
      },
      act: (bloc) => bloc.add(SubmitOandaCredentials(token: 't', accountId: 'id')),
      expect: () => [isA<OandaLoading>(), isA<OandaConnected>()],
    );
  });
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_event.dart << 'EOF'
abstract class ChartEvent {}

class LoadChartData extends ChartEvent {
  final String symbol;
  final String timeframe;

  LoadChartData({
    required this.symbol,
    required this.timeframe,
  });
}

class UpdateVisibleRange extends ChartEvent {
  final DateTime min;
  final DateTime max;

  UpdateVisibleRange({
    required this.min,
    required this.max,
  });
}

class RefreshChart extends ChartEvent {}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_state.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

abstract class ChartState {}

class ChartInitial extends ChartState {}

class ChartLoading extends ChartState {}

class ChartLoaded extends ChartState {
  final List<CandleEntity> candles;
  final DateTime visibleMin;
  final DateTime visibleMax;

  ChartLoaded({
    required this.candles,
    required this.visibleMin,
    required this.visibleMax,
  });
}

class ChartUpdating extends ChartState {
  final ChartLoaded previous;

  ChartUpdating(this.previous);
}

class ChartError extends ChartState {
  final String message;

  ChartError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'chart_event.dart';
import 'chart_state.dart';
import '../../../../core/models/candle_entity.dart';
import '../../../../market/data/repositories/market_repository.dart';

class ChartBloc extends Bloc<ChartEvent, ChartState> {
  final MarketRepository repository;

  ChartBloc(this.repository) : super(ChartInitial()) {
    on<LoadChartData>(_onLoad);
    on<UpdateVisibleRange>(_onUpdateRange);
    on<RefreshChart>(_onRefresh);
  }

  Future<void> _onLoad(LoadChartData event, Emitter<ChartState> emit) async {
    emit(ChartLoading());
    try {
      final candles = await repository.getHistoricalCandles(
        symbol: event.symbol,
        timeframe: event.timeframe,
      );

      if (candles.isEmpty) {
        return emit(ChartError("No candles returned"));
      }

      emit(ChartLoaded(
        candles: candles,
        visibleMin: candles.first.timeUtc,
        visibleMax: candles.last.timeUtc,
      ));
    } catch (e) {
      emit(ChartError(e.toString()));
    }
  }

  void _onUpdateRange(UpdateVisibleRange event, Emitter<ChartState> emit) {
    final stateNow = state;
    if (stateNow is ChartLoaded) {
      emit(ChartLoaded(
        candles: stateNow.candles,
        visibleMin: event.min,
        visibleMax: event.max,
      ));
    }
  }

  void _onRefresh(RefreshChart event, Emitter<ChartState> emit) {
    final stateNow = state;
    if (stateNow is ChartLoaded) {
      add(LoadChartData(
        symbol: stateNow.candles.first.instrument,
        timeframe: (stateNow.visibleMax.difference(stateNow.visibleMin).inMinutes == 1)
            ? "M1"
            : "Unknown",
      ));
    }
  }
}
EOF
cat > test/bloc/chart/chart_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_state.dart';
import 'package:your_app/market/data/repositories/market_repository.dart';
import 'package:mocktail/mocktail.dart';
import '../../../mocks.dart';
import '../../../../core/models/candle_entity.dart';

class MockMarketRepo extends Mock implements MarketRepository {}

void main() {
  late MockMarketRepo mockRepo;

  setUp(() {
    mockRepo = MockMarketRepo();
  });

  blocTest<ChartBloc, ChartState>(
    'emits [ChartLoading, ChartLoaded] when candles returned',
    build: () {
      when(() => mockRepo.getHistoricalCandles(symbol: any(named: "symbol"), timeframe: any(named: "timeframe")))
          .thenAnswer((_) async => [
                CandleEntity(
                    instrument: "EUR_USD",
                    timeUtc: DateTime.utc(2025, 1, 1, 0, 0),
                    open: 1.0,
                    high: 2.0,
                    low: 0.9,
                    close: 1.5,
                    volume: 1),
              ]);
      return ChartBloc(mockRepo);
    },
    act: (bloc) => bloc.add(LoadChartData(symbol: "EUR_USD", timeframe: "M1")),
    expect: () => [
      isA<ChartLoading>(),
      isA<ChartLoaded>(),
    ],
  );
}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_event.dart << 'EOF'
abstract class TradingEvent {}

class PlaceOrder extends TradingEvent {
  final String instrument;
  final OrderSide side;
  final double price;
  final double size;

  PlaceOrder({
    required this.instrument,
    required this.side,
    required this.price,
    required this.size,
  });
}

class ClosePosition extends TradingEvent {
  final String positionId;

  ClosePosition({required this.positionId});
}

class RefreshPositions extends TradingEvent {}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_state.dart << 'EOF'
import '../../../../market/domain/backtest/backtest_models.dart';

abstract class TradingState {}

class TradingInitial extends TradingState {}

class TradingLoading extends TradingState {}

class TradingPositionsLoaded extends TradingState {
  final List<Position> positions;
  TradingPositionsLoaded(this.positions);
}

class TradingOrderSuccess extends TradingState {
  final String message;
  TradingOrderSuccess(this.message);
}

class TradingFailure extends TradingState {
  final String error;
  TradingFailure(this.error);
}
EOF
cat > lib/features/market/presentation/bloc/trading/trading_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'trading_event.dart';
import 'trading_state.dart';
import '../../../../market/data/repositories/trading_repository.dart';
import '../../../../market/domain/backtest/backtest_models.dart';

class TradingBloc extends Bloc<TradingEvent, TradingState> {
  final TradingRepository repository;

  TradingBloc(this.repository) : super(TradingInitial()) {
    on<PlaceOrder>(_onPlaceOrder);
    on<ClosePosition>(_onClosePosition);
    on<RefreshPositions>(_onRefreshPositions);
  }

  Future<void> _onPlaceOrder(PlaceOrder event, Emitter<TradingState> emit) async {
    emit(TradingLoading());

    try {
      final updatedPositions = await repository.placeOrder(
        instrument: event.instrument,
        side: event.side,
        price: event.price,
        size: event.size,
      );

      emit(TradingOrderSuccess("Order placed successfully"));
      emit(TradingPositionsLoaded(updatedPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }

  Future<void> _onClosePosition(ClosePosition event, Emitter<TradingState> emit) async {
    emit(TradingLoading());

    try {
      final updatedPositions = await repository.closePosition(event.positionId);
      emit(TradingOrderSuccess("Position closed successfully"));
      emit(TradingPositionsLoaded(updatedPositions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }

  Future<void> _onRefreshPositions(RefreshPositions event, Emitter<TradingState> emit) async {
    emit(TradingLoading());

    try {
      final positions = await repository.getOpenPositions();
      emit(TradingPositionsLoaded(positions));
    } catch (e) {
      emit(TradingFailure(e.toString()));
    }
  }
}
EOF
cat > test/bloc/trading/trading_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/trading/trading_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/trading/trading_event.dart';
import 'package:your_app/features/market/presentation/bloc/trading/trading_state.dart';
import 'package:your_app/market/data/repositories/trading_repository.dart';
import 'package:mocktail/mocktail.dart';
import '../../../../market/domain/backtest/backtest_models.dart';

class MockTradingRepo extends Mock implements TradingRepository {}

void main() {
  late MockTradingRepo mockRepo;

  setUp(() {
    mockRepo = MockTradingRepo();
  });

  blocTest<TradingBloc, TradingState>(
    'emits OrderSuccess and PositionsLoaded on successful PlaceOrder',
    build: () {
      when(() => mockRepo.placeOrder(
          instrument: any(named: 'instrument'),
          side: any(named: 'side'),
          price: any(named: 'price'),
          size: any(named: 'size')))
          .thenAnswer((_) async => <Position>[]);

      return TradingBloc(mockRepo);
    },
    act: (bloc) => bloc.add(PlaceOrder(
      instrument: "EUR_USD",
      side: OrderSide.buy,
      price: 1.1,
      size: 1.0,
    )),
    expect: () => [
      isA<TradingLoading>(),
      isA<TradingOrderSuccess>(),
      isA<TradingPositionsLoaded>(),
    ],
  );
}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_event.dart << 'EOF'
abstract class BacktestEvent {}

class RunBacktest extends BacktestEvent {
  final List<dynamic> history; // List<CandleEntity>
  final String strategyId;      // Ù…Ø¹Ø±Ù Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© (Ø³ÙŠØªÙ… ØªØ±Ø¬Ù…ØªÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)
  final double takeProfit;
  final double stopLoss;

  RunBacktest({
    required this.history,
    required this.strategyId,
    this.takeProfit = 0,
    this.stopLoss = 0,
  });
}

class CancelBacktest extends BacktestEvent {}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_state.dart << 'EOF'
import '../../../../features/market/domain/backtest/backtest_result.dart';

abstract class BacktestState {}

class BacktestInitial extends BacktestState {}

class BacktestRunning extends BacktestState {}

class BacktestSuccess extends BacktestState {
  final BacktestResult result;
  BacktestSuccess(this.result);
}

class BacktestError extends BacktestState {
  final String message;
  BacktestError(this.message);
}

class BacktestCancelled extends BacktestState {}
EOF
cat > lib/features/market/presentation/bloc/backtest/backtest_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'backtest_event.dart';
import 'backtest_state.dart';
import '../../../../features/market/domain/backtest/backtest_engine.dart';
import '../../../../features/strategy/domain/evaluator/example_strategy.dart';
import '../../../../core/models/candle_entity.dart';

class BacktestBloc extends Bloc<BacktestEvent, BacktestState> {
  BacktestBloc() : super(BacktestInitial()) {
    on<RunBacktest>(_onRunBacktest);
    on<CancelBacktest>(_onCancelBacktest);
  }

  bool _cancelRequested = false;

  Future<void> _onRunBacktest(RunBacktest event, Emitter<BacktestState> emit) async {
    emit(BacktestRunning());
    _cancelRequested = false;

    try {
      // ØªØ±Ø¬Ù…Ø© strategyId Ø¥Ù„Ù‰ StrategyEvaluator
      // Ù‡Ù†Ø§ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§ Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø«Ø§Ù„
      final evaluator = buildExampleStrategy();

      final engine = BacktestEngine(
        history: event.history.cast<CandleEntity>(),
        evaluator: evaluator,
        takeProfit: event.takeProfit,
        stopLoss: event.stopLoss,
      );

      final result = engine.run();

      if (_cancelRequested) {
        emit(BacktestCancelled());
      } else {
        emit(BacktestSuccess(result));
      }
    } catch (e) {
      emit(BacktestError(e.toString()));
    }
  }

  void _onCancelBacktest(CancelBacktest event, Emitter<BacktestState> emit) {
    _cancelRequested = true;
    emit(BacktestCancelled());
  }
}
EOF
cat > test/bloc/backtest/backtest_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_event.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_state.dart';
import '../../../mocks.dart';
import '../../../../core/models/candle_entity.dart';

void main() {
  blocTest<BacktestBloc, BacktestState>(
    'emits [Running, Success] when backtest runs without cancellation',
    build: () => BacktestBloc(),
    act: (bloc) => bloc.add(RunBacktest(
      history: [
        CandleEntity(
            instrument: "EUR_USD",
            timeUtc: DateTime.utc(2025, 1, 1),
            open: 1.0,
            high: 1.1,
            low: 0.9,
            close: 1.05,
            volume: 1)
      ],
      strategyId: "example",
    )),
    expect: () => [
      isA<BacktestRunning>(),
      isA<BacktestSuccess>(),
    ],
  );
}
EOF
cat > lib/features/strategy/presentation/bloc/strategy_builder_event.dart << 'EOF'
abstract class StrategyBuilderEvent {}

class AddBlock extends StrategyBuilderEvent {
  final String id;
  final String type;
  final Map<String, dynamic> params;

  AddBlock({
    required this.id,
    required this.type,
    required this.params,
  });
}

class RemoveBlock extends StrategyBuilderEvent {
  final String id;
  RemoveBlock(this.id);
}

class ConnectBlocks extends StrategyBuilderEvent {
  final String fromId;
  final String toId;

  ConnectBlocks({required this.fromId, required this.toId});
}

class UpdateBlockParams extends StrategyBuilderEvent {
  final String id;
  final Map<String, dynamic> params;

  UpdateBlockParams({required this.id, required this.params});
}

class LoadStrategyGraph extends StrategyBuilderEvent {
  final String graphId;
  LoadStrategyGraph(this.graphId);
}

class SaveStrategyGraph extends StrategyBuilderEvent {
  final String graphId;
  SaveStrategyGraph(this.graphId);
}
EOF
cat > lib/features/strategy/presentation/bloc/strategy_builder_state.dart << 'EOF'
import '../../../../core/models/strategy_graph.dart';

abstract class StrategyBuilderState {}

class BuilderInitial extends StrategyBuilderState {}

class BuilderLoaded extends StrategyBuilderState {
  final StrategyGraph graph;
  BuilderLoaded(this.graph);
}

class BuilderError extends StrategyBuilderState {
  final String message;
  BuilderError(this.message);
}
EOF
cat > lib/features/strategy/presentation/bloc/strategy_builder_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'strategy_builder_event.dart';
import 'strategy_builder_state.dart';
import '../../../../core/storage/strategy/strategy_storage.dart';
import '../../../../core/models/strategy_graph.dart';

class StrategyBuilderBloc extends Bloc<StrategyBuilderEvent, StrategyBuilderState> {
  final StrategyStorage storage;

  StrategyBuilderBloc(this.storage) : super(BuilderInitial()) {
    on<AddBlock>(_onAddBlock);
    on<RemoveBlock>(_onRemoveBlock);
    on<ConnectBlocks>(_onConnect);
    on<UpdateBlockParams>(_onUpdateParams);
    on<LoadStrategyGraph>(_onLoad);
    on<SaveStrategyGraph>(_onSave);
  }

  StrategyGraph _current = StrategyGraph(blocks: [], connections: []);

  void _onAddBlock(AddBlock event, Emitter<StrategyBuilderState> emit) {
    _current.blocks.add(
      Block(id: event.id, type: event.type, params: event.params),
    );
    emit(BuilderLoaded(_current));
  }

  void _onRemoveBlock(RemoveBlock event, Emitter<StrategyBuilderState> emit) {
    _current.blocks.removeWhere((b) => b.id == event.id);
    _current.connections.removeWhere((c) => c.fromBlockId == event.id || c.toBlockId == event.id);
    emit(BuilderLoaded(_current));
  }

  void _onConnect(ConnectBlocks event, Emitter<StrategyBuilderState> emit) {
    _current.connections.add(Connection(fromBlockId: event.fromId, toBlockId: event.toId));
    emit(BuilderLoaded(_current));
  }

  void _onUpdateParams(UpdateBlockParams event, Emitter<StrategyBuilderState> emit) {
    final block = _current.blocks.firstWhere((b) => b.id == event.id);
    if (block != null) {
      block.params.addAll(event.params);
    }
    emit(BuilderLoaded(_current));
  }

  Future<void> _onLoad(LoadStrategyGraph event, Emitter<StrategyBuilderState> emit) async {
    try {
      final graph = await storage.load(event.graphId);
      _current = graph;
      emit(BuilderLoaded(graph));
    } catch (e) {
      emit(BuilderError(e.toString()));
    }
  }

  Future<void> _onSave(SaveStrategyGraph event, Emitter<StrategyBuilderState> emit) async {
    try {
      await storage.save(event.graphId, _current);
      emit(BuilderLoaded(_current));
    } catch (e) {
      emit(BuilderError(e.toString()));
    }
  }
}
EOF
cat > lib/core/storage/strategy/strategy_storage.dart << 'EOF'
import '../../../../core/models/strategy_graph.dart';

abstract class StrategyStorage {
  Future<void> save(String id, StrategyGraph graph);
  Future<StrategyGraph> load(String id);
}
EOF
cat > test/bloc/strategy_builder/strategy_builder_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/strategy/presentation/bloc/strategy_builder_bloc.dart';
import 'package:your_app/features/strategy/presentation/bloc/strategy_builder_event.dart';
import 'package:your_app/features/strategy/presentation/bloc/strategy_builder_state.dart';
import 'package:mocktail/mocktail.dart';
import '../../../../core/models/strategy_graph.dart';
import '../../../mocks.dart';

class MockStrategyStorage extends Mock implements StrategyStorage {}

void main() {
  late MockStrategyStorage mockStorage;

  setUp(() {
    mockStorage = MockStrategyStorage();
  });

  blocTest<StrategyBuilderBloc, StrategyBuilderState>(
    'emits BuilderLoaded on AddBlock',
    build: () => StrategyBuilderBloc(mockStorage),
    act: (bloc) =>
        bloc.add(AddBlock(id: 'b1', type: 'ema', params: {})),
    expect: () => [isA<BuilderLoaded>()],
  );
}
EOF
cat > lib/features/alert/presentation/bloc/smart_alert_event.dart << 'EOF'
abstract class SmartAlertEvent {}

class AddAlertRule extends SmartAlertEvent {
  final String id;
  final String condition; // expression like "RSI < 30"
  AddAlertRule(this.id, this.condition);
}

class RemoveAlertRule extends SmartAlertEvent {
  final String id;
  RemoveAlertRule(this.id);
}

class CheckAlerts extends SmartAlertEvent {
  final dynamic candle; // can be CandleEntity or other
  CheckAlerts(this.candle);
}
EOF
cat > lib/features/alert/presentation/bloc/smart_alert_state.dart << 'EOF'
abstract class SmartAlertState {}

class AlertInitial extends SmartAlertState {}

class AlertRuleAdded extends SmartAlertState {}

class AlertRuleRemoved extends SmartAlertState {}

class AlertTriggered extends SmartAlertState {
  final String id;
  AlertTriggered(this.id);
}

class AlertError extends SmartAlertState {
  final String message;
  AlertError(this.message);
}
EOF
cat > lib/features/alert/presentation/bloc/smart_alert_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'smart_alert_event.dart';
import 'smart_alert_state.dart';

class SmartAlertBloc extends Bloc<SmartAlertEvent, SmartAlertState> {
  final Map<String, String> _rules = {};

  SmartAlertBloc() : super(AlertInitial()) {
    on<AddAlertRule>(_onAddRule);
    on<RemoveAlertRule>(_onRemoveRule);
    on<CheckAlerts>(_onCheck);
  }

  void _onAddRule(AddAlertRule event, Emitter<SmartAlertState> emit) {
    _rules[event.id] = event.condition;
    emit(AlertRuleAdded());
  }

  void _onRemoveRule(RemoveAlertRule event, Emitter<SmartAlertState> emit) {
    _rules.remove(event.id);
    emit(AlertRuleRemoved());
  }

  void _onCheck(CheckAlerts event, Emitter<SmartAlertState> emit) {
    try {
      // simple evaluator placeholder
      final triggered = _rules.entries
          .where((e) => event.candle.toString().contains(e.value))
          .map((e) => e.key)
          .toList();

      for (final id in triggered) {
        emit(AlertTriggered(id));
      }
    } catch (e) {
      emit(AlertError(e.toString()));
    }
  }
}
EOF
cat > lib/features/replay/presentation/bloc/replay_event.dart << 'EOF'
abstract class ReplayEvent {}

class StartReplay extends ReplayEvent {
  final List<dynamic> history;
  StartReplay(this.history);
}

class PauseReplay extends ReplayEvent {}

class SeekReplay extends ReplayEvent {
  final int index;
  SeekReplay(this.index);
}

class ChangeReplaySpeed extends ReplayEvent {
  final double speed;
  ChangeReplaySpeed(this.speed);
}
EOF
cat > lib/features/replay/presentation/bloc/replay_state.dart << 'EOF'
abstract class ReplayState {}

class ReplayInitial extends ReplayState {}

class ReplayRunning extends ReplayState {
  final int index;
  final double speed;
  ReplayRunning(this.index, this.speed);
}

class ReplayPaused extends ReplayState {
  final int index;
  final double speed;
  ReplayPaused(this.index, this.speed);
}

class ReplayError extends ReplayState {
  final String error;
  ReplayError(this.error);
}
EOF
cat > lib/features/replay/presentation/bloc/replay_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'replay_event.dart';
import 'replay_state.dart';

class ReplayBloc extends Bloc<ReplayEvent, ReplayState> {
  ReplayBloc() : super(ReplayInitial()) {
    on<StartReplay>(_onStart);
    on<PauseReplay>(_onPause);
    on<SeekReplay>(_onSeek);
    on<ChangeReplaySpeed>(_onSpeed);
  }

  int _currentIndex = 0;
  double _speed = 1.0;

  void _onStart(StartReplay event, Emitter<ReplayState> emit) {
    if (event.history.isEmpty) {
      return emit(ReplayError("No data"));
    }
    _currentIndex = 0;
    emit(ReplayRunning(_currentIndex, _speed));
  }

  void _onPause(PauseReplay event, Emitter<ReplayState> emit) {
    emit(ReplayPaused(_currentIndex, _speed));
  }

  void _onSeek(SeekReplay event, Emitter<ReplayState> emit) {
    _currentIndex = event.index;
    emit(ReplayRunning(_currentIndex, _speed));
  }

  void _onSpeed(ChangeReplaySpeed event, Emitter<ReplayState> emit) {
    _speed = event.speed;
    emit(ReplayRunning(_currentIndex, _speed));
  }
}
EOF
cat > lib/core/storage/theme/theme_hive.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:hive/hive.dart';

part 'theme_hive.g.dart';

@HiveType(typeId: 10)
class ThemeEntity extends HiveObject {
  @HiveField(0)
  final bool isDark;

  @HiveField(1)
  final int primaryColorValue;

  @HiveField(2)
  final int accentColorValue;

  ThemeEntity({
    required this.isDark,
    required this.primaryColorValue,
    required this.accentColorValue,
  });

  ThemeData toThemeData() {
    return ThemeData(
      brightness: isDark ? Brightness.dark : Brightness.light,
      primaryColor: Color(primaryColorValue),
      colorScheme: ColorScheme.fromSwatch(
        primarySwatch: MaterialColor(
          primaryColorValue,
          <int, Color>{
            50: Color(primaryColorValue),
            100: Color(primaryColorValue),
            200: Color(primaryColorValue),
            300: Color(primaryColorValue),
            400: Color(primaryColorValue),
            500: Color(primaryColorValue),
            600: Color(primaryColorValue),
            700: Color(primaryColorValue),
            800: Color(primaryColorValue),
            900: Color(primaryColorValue),
          },
        ),
      ).copyWith(secondary: Color(accentColorValue)),
    );
  }
}
EOF
cat > lib/core/storage/theme/theme_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'theme_hive.dart';

class ThemeStorage {
  static const _box = "theme_box";

  Future<void> saveTheme(ThemeEntity theme) async {
    final box = await Hive.openBox<ThemeEntity>(_box);
    await box.put('current', theme);
  }

  Future<ThemeEntity?> loadTheme() async {
    final box = await Hive.openBox<ThemeEntity>(_box);
    return box.get('current');
  }

  Future<void> clear() async {
    final box = await Hive.openBox<ThemeEntity>(_box);
    await box.clear();
  }
}
EOF
cat > test/storage/theme/theme_storage_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'package:path_provider_platform_interface/path_provider_platform_interface.dart';
import 'package:your_app/core/storage/theme/theme_storage.dart';
import 'package:your_app/core/storage/theme/theme_hive.dart';
import 'dart:io';

class FakePathProvider extends Fake implements PathProviderPlatform {
  @override
  Future<String?> getApplicationDocumentsPath() async {
    return Directory.systemTemp.path;
  }
}

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(ThemeEntityAdapter());
  });

  test('save and load theme', () async {
    final store = ThemeStorage();
    final theme = ThemeEntity(isDark: true, primaryColorValue: 0xFF0000, accentColorValue: 0x00FF00);
    await store.saveTheme(theme);

    final loaded = await store.loadTheme();
    expect(loaded?.isDark, true);
    expect(loaded?.primaryColorValue, theme.primaryColorValue);
  });
}
EOF
cat > lib/core/storage/script/script_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'script_hive.g.dart';

@HiveType(typeId: 11)
class ScriptEntity extends HiveObject {
  @HiveField(0)
  final String name;
  @HiveField(1)
  final String script;

  ScriptEntity({required this.name, required this.script});
}
EOF
cat > lib/core/storage/script/script_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'script_hive.dart';

class ScriptStorage {
  static const _box = "scripts_box";

  Future<void> saveScript(ScriptEntity script) async {
    final box = await Hive.openBox<ScriptEntity>(_box);
    await box.put(script.name, script);
  }

  Future<ScriptEntity?> loadScript(String name) async {
    final box = await Hive.openBox<ScriptEntity>(_box);
    return box.get(name);
  }

  Future<List<ScriptEntity>> getAllScripts() async {
    final box = await Hive.openBox<ScriptEntity>(_box);
    return box.values.toList();
  }

  Future<void> deleteScript(String name) async {
    final box = await Hive.openBox<ScriptEntity>(_box);
    await box.delete(name);
  }
}
EOF
cat > test/storage/script/script_storage_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'dart:io';
import 'package:your_app/core/storage/script/script_storage.dart';
import 'package:your_app/core/storage/script/script_hive.dart';

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(ScriptEntityAdapter());
  });

  test('save and load script', () async {
    final storage = ScriptStorage();
    final script = ScriptEntity(name: "Test1", script: "EMA(10)>EMA(20)");
    await storage.saveScript(script);

    final loaded = await storage.loadScript("Test1");
    expect(loaded?.script, "EMA(10)>EMA(20)");
  });
}
EOF
cat > lib/core/storage/audit/audit_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'audit_hive.g.dart';

@HiveType(typeId: 12)
class AuditEntity extends HiveObject {
  @HiveField(0)
  final DateTime time;
  @HiveField(1)
  final String type;
  @HiveField(2)
  final String message;

  AuditEntity({
    required this.time,
    required this.type,
    required this.message,
  });
}
EOF
cat > lib/core/storage/audit/audit_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'audit_hive.dart';

class AuditStorage {
  static const _box = "audit_box";

  Future<void> logEvent(AuditEntity event) async {
    final box = await Hive.openBox<AuditEntity>(_box);
    await box.add(event);
  }

  Future<List<AuditEntity>> getEvents() async {
    final box = await Hive.openBox<AuditEntity>(_box);
    return box.values.toList();
  }

  Future<void> clear() async {
    final box = await Hive.openBox<AuditEntity>(_box);
    await box.clear();
  }
}
EOF
cat > test/storage/audit/audit_storage_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'dart:io';
import 'package:your_app/core/storage/audit/audit_storage.dart';
import 'package:your_app/core/storage/audit/audit_hive.dart';

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(AuditEntityAdapter());
  });

  test('log and retrieve audit event', () async {
    final storage = AuditStorage();
    final event = AuditEntity(time: DateTime.now(), type: "Test", message: "Hello");
    await storage.logEvent(event);

    final list = await storage.getEvents();
    expect(list.length, greaterThan(0));
  });
}
EOF
cat > lib/core/storage/indicator/indicator_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'indicator_hive.g.dart';

@HiveType(typeId: 13)
class IndicatorSettingsEntity extends HiveObject {
  @HiveField(0)
  final String id;

  @HiveField(1)
  final Map<String, dynamic> params;

  IndicatorSettingsEntity({
    required this.id,
    required this.params,
  });
}
EOF
cat > lib/core/storage/indicator/indicator_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'indicator_hive.dart';

class IndicatorSettingsStorage {
  static const _box = "indicator_box";

  Future<void> saveSettings(IndicatorSettingsEntity e) async {
    final box = await Hive.openBox<IndicatorSettingsEntity>(_box);
    await box.put(e.id, e);
  }

  Future<IndicatorSettingsEntity?> loadSettings(String id) async {
    final box = await Hive.openBox<IndicatorSettingsEntity>(_box);
    return box.get(id);
  }

  Future<List<IndicatorSettingsEntity>> getAll() async {
    final box = await Hive.openBox<IndicatorSettingsEntity>(_box);
    return box.values.toList();
  }
}
EOF
cat > test/storage/indicator/indicator_storage_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:hive/hive.dart';
import 'dart:io';
import 'package:your_app/core/storage/indicator/indicator_storage.dart';
import 'package:your_app/core/storage/indicator/indicator_hive.dart';

void main() {
  setUpAll(() {
    Hive.init(Directory.systemTemp.path);
    Hive.registerAdapter(IndicatorSettingsEntityAdapter());
  });

  test('save and load indicator settings', () async {
    final store = IndicatorSettingsStorage();
    final e = IndicatorSettingsEntity(id: "EMA10", params: {"color": 0xFF0000});
    await store.saveSettings(e);

    final loaded = await store.loadSettings("EMA10");
    expect(loaded?.params["color"], 0xFF0000);
  });
}
EOF
cat > lib/core/storage/replay/replay_hive.dart << 'EOF'
import 'package:hive/hive.dart';

part 'replay_hive.g.dart';

@HiveType(typeId: 14)
class ReplayStateEntity extends HiveObject {
  @HiveField(0)
  final String symbol;

  @HiveField(1)
  final int lastIndex;

  ReplayStateEntity({required this.symbol, required this.lastIndex});
}
EOF
cat > lib/core/storage/replay/replay_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'replay_hive.dart';

class ReplayStorage {
  static const _box = "replay_box";

  Future<void> save(String symbol, int index) async {
    final box = await Hive.openBox<ReplayStateEntity>(_box);
    await box.put(symbol, ReplayStateEntity(symbol: symbol, lastIndex: index));
  }

  Future<ReplayStateEntity?> load(String symbol) async {
    final box = await Hive.openBox<ReplayStateEntity>(_box);
    return box.get(symbol);
  }
}
EOF
cat > test/unit/indicators/ema_indicator_edge_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/indicators/ema_indicator.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('EMA with constant values stabilizes', () {
    final ema = EMAIndicator(5);
    final candles = List.generate(100, (i) => CandleEntity(
      instrument: "XAU_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: 10.0,
      high: 10.0,
      low: 10.0,
      close: 10.0,
      volume: 1,
    ));

    for (var c in candles) {
      ema.addCandle(c);
    }

    // After many identical closes, current should equal 10
    expect(ema.current, 10.0);
  });
}
EOF
cat > test/unit/indicators/rsi_no_loss_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/strategy/domain/indicators/rsi_indicator.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('RSI when there is no loss should be 100', () {
    final rsi = RSIIndicator(14);
    final candles = List.generate(20, (i) => CandleEntity(
      instrument: "EUR_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble()+1,
      low: i.toDouble(),
      close: i.toDouble()+2,
      volume: 1,
    ));

    for (var c in candles) {
      rsi.addCandle(c);
    }

    expect(rsi.current, 100.0);
  });
}
EOF
cat > test/unit/backtest/backtest_engine_profit_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('Backtest net profit should accumulate correctly', () {
    // Construct history where price moves up
    final history = [
      CandleEntity(instrument: "EUR_USD", timeUtc: DateTime.utc(2025,1,1), open: 1.0, high: 2.0, low: 1.0, close: 1.5, volume: 1),
      CandleEntity(instrument: "EUR_USD", timeUtc: DateTime.utc(2025,1,1,0,1), open: 1.5, high: 2.5, low: 1.5, close: 2.0, volume: 1),
    ];

    final engine = BacktestEngine(
      history: history,
      evaluator: buildExampleStrategy(),
      initialBalance: 1000,
      takeProfit: 0,
      stopLoss: 0,
    );

    final result = engine.run();

    expect(result.netProfit, greaterThan(0));
    expect(result.equityCurve.last, greaterThan(result.equityCurve.first));
  });
}
EOF
cat > test/unit/streaming/tick_aggregator_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/data/streaming/tick_aggregator.dart';
import 'package:your_app/core/models/tick_entity.dart';

void main() {
  test('TickAggregator handles out of order ticks', () {
    final agg = TickAggregator("EUR_USD", Duration(seconds: 60));

    final t1 = TickEntity(instrument:"EUR_USD", timeUtc: DateTime.utc(2025,1,1,0,1), bid:2, ask:2);
    final t0 = TickEntity(instrument:"EUR_USD", timeUtc: DateTime.utc(2025,1,1,0,0), bid:1, ask:1);

    agg.addTick(t1);
    agg.addTick(t0);

    final candles = agg.buildCandles();
    expect(candles.length, 2);
    expect(candles[0].open, 1);
    expect(candles[1].open, 2);
  });
}
EOF
cat > test/bloc/backtest/backtest_cancel_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_event.dart';
import 'package:your_app/features/market/presentation/bloc/backtest/backtest_state.dart';

void main() {
  blocTest<BacktestBloc, BacktestState>(
    'emits Cancelled when cancel event is added',
    build: () => BacktestBloc(),
    act: (bloc) {
      bloc.add(RunBacktest(history: [], strategyId: "", takeProfit: 0, stopLoss: 0));
      bloc.add(CancelBacktest());
    },
    expect: () => [isA<BacktestRunning>(), isA<BacktestCancelled>()],
  );
}
EOF
cat > test/bloc/replay/replay_edge_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:your_app/features/replay/presentation/bloc/replay_bloc.dart';
import 'package:your_app/features/replay/presentation/bloc/replay_event.dart';
import 'package:your_app/features/replay/presentation/bloc/replay_state.dart';

void main() {
  blocTest<ReplayBloc, ReplayState>(
    'SeekReplay updates index',
    build: () => ReplayBloc(),
    act: (bloc) => bloc.add(SeekReplay(5)),
    expect: () => [isA<ReplayRunning>()],
    verify: (bloc) {
      final state = bloc.state;
      expect((state as ReplayRunning).index, 5);
    },
  );

  blocTest<ReplayBloc, ReplayState>(
    'ChangeReplaySpeed updates speed',
    build: () => ReplayBloc(),
    act: (bloc) => bloc.add(ChangeReplaySpeed(2.0)),
    expect: () => [isA<ReplayRunning>()],
    verify: (bloc) {
      final state = bloc.state;
      expect((state as ReplayRunning).speed, 2.0);
    },
  );
}
EOF
cat > integration_test/chart_integration_test.dart << 'EOF'
import 'package:integration_test/integration_test.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_bloc.dart';
import 'package:your_app/features/market/presentation/bloc/chart/chart_event.dart';
import 'package:your_app/market/data/repositories/market_repository.dart';
import 'package:your_app/core/network/rest_client.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets('ChartBloc integration test', (tester) async {
    final repo = MarketRepository(RestClient("fakeToken","https://fake.url"));
    final bloc = ChartBloc(repo);

    bloc.add(LoadChartData(symbol: "EUR_USD", timeframe: "M1"));
    await tester.pumpAndSettle();
    expect(bloc.state, isNot(isA<ChartError>()));
  });
}
EOF
cat > test/stress/backtest_stress_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/features/market/domain/backtest/backtest_engine.dart';
import 'package:your_app/features/strategy/domain/evaluator/example_strategy.dart';
import 'package:your_app/core/models/candle_entity.dart';

void main() {
  test('Backtest handles 10000 candles in <1 second', () {
    final history = List.generate(10000, (i) => CandleEntity(
      instrument: "XAU_USD",
      timeUtc: DateTime.utc(2025,1,1,0,i),
      open: i.toDouble(),
      high: i.toDouble()+1,
      low: i.toDouble(),
      close: i.toDouble(),
      volume: 1,
    ));

    final engine = BacktestEngine(history: history, evaluator: buildExampleStrategy());
    final stopwatch = Stopwatch()..start();
    engine.run();
    stopwatch.stop();

    expect(stopwatch.elapsed.inSeconds < 1, true);
  });
}
EOF
cat > test/integration/ws/ws_reconnect_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/network/ws_manager.dart';

void main() {
  test('WSManager reconnect logic', () async {
    final ws = WSManager('wss://echo.websocket.events');
    ws.connect();
    await Future.delayed(Duration(seconds: 2));
    ws.send('test');

    final data = await ws.stream.first;
    expect(data, isNotNull);

    ws.dispose();
  });
}
EOF
cat > test/unit/network/rest_token_expired_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/network/rest_client.dart';
import 'package:http/http.dart' as http;
import 'package:http/testing.dart';

void main() {
  test('REST client handles token expired (401)', () async {
    final mockClient = MockClient((request) async {
      return http.Response('', 401);
    });

    final client = RestClient("token","base", client: mockClient);
    expect(() => client.get("/x"), throwsException);
  });
}
EOF
cat > lib/core/sync/sync_manager.dart << 'EOF'
import 'dart:async';
import '../network/ws_manager.dart';
import '../../features/market/data/streaming/tick_aggregator.dart';
import '../models/tick_entity.dart';
import '../network/rest_client.dart';

typedef CandleUpdateCallback = void Function(List<dynamic> candles);

class SyncManager {
  final WSManager ws;
  final RestClient rest;
  final TickAggregator aggregator;
  final CandleUpdateCallback onCandle;

  StreamSubscription? _wsSub;

  SyncManager({
    required this.ws,
    required this.rest,
    required this.aggregator,
    required this.onCandle,
  });

  void start() {
    ws.connect();
    _wsSub = ws.stream.listen(_processMessage);
  }

  Future<void> stop() async {
    await _wsSub?.cancel();
    ws.dispose();
  }

  void _processMessage(dynamic data) {
    final tick = TickEntity.fromJson("UNKNOWN", data);
    aggregator.addTick(tick);

    final candles = aggregator.buildCandles();
    if (candles.isNotEmpty) {
      onCandle(candles);
    }
  }
}
EOF
cat > test/sync/sync_manager_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:your_app/core/sync/sync_manager.dart';
import 'package:your_app/core/network/ws_manager.dart';
import 'package:your_app/core/network/rest_client.dart';
import 'package:your_app/features/market/data/streaming/tick_aggregator.dart';

void main() {
  test('SyncManager processes ticks and builds candles', () async {
    final ws = WSManager('wss://echo.websocket.events');
    final rest = RestClient('','');
    final agg = TickAggregator("SYM", Duration(seconds: 60));
    bool called = false;

    final manager = SyncManager(
      ws: ws,
      rest: rest,
      aggregator: agg,
      onCandle: (c) => called = true,
    );

    manager.start();
    await Future.delayed(Duration(seconds: 1));
    await manager.stop();

    expect(called, true);
  });
}
EOF
cat > test/widgets/chart/interactive_chart_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:your_app/features/chart/presentation/widgets/interactive_chart.dart';

void main() {
  testWidgets('Pinch Zoom changes scale', (tester) async {
    await tester.pumpWidget(MaterialApp(
      home: InteractiveChart(candles: [], onRangeChanged: (_,__){}),
    ));

    final finder = find.byType(InteractiveChart);
    await tester.pinch(finder, 1.5);
    await tester.pump();

    // ØªØ£ÙƒØ¯ Ø£Ù† scale ØªØºÙŠØ±Øª
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªØ­Ù‚Ù‚ Ø¯Ø§Ø®Ù„ÙŠ Ù…Ù† Ø­Ø§Ù„Ø© widget
  });
}
EOF
cat > lib/core/network/network_service.dart << 'EOF'
import 'dart:async';
import 'package:connectivity_plus/connectivity_plus.dart';

enum NetworkStatus { online, offline }

class NetworkService {
  final _controller = StreamController<NetworkStatus>.broadcast();

  NetworkService() {
    Connectivity().onConnectivityChanged.listen((status) {
      if (status == ConnectivityResult.none) {
        _controller.add(NetworkStatus.offline);
      } else {
        _controller.add(NetworkStatus.online);
      }
    });
  }

  Stream<NetworkStatus> get networkStatusStream => _controller.stream;
}
EOF
cat >> lib/main.dart << 'EOF'

// Ø¨Ø¹Ø¯ runApp
final netService = NetworkService();
netService.networkStatusStream.listen((status) {
  print('Network changed: $status');
  // ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ event Ø¥Ù„Ù‰ Bloc Ù…Ø¹ÙŠÙ†
});
EOF
cat > lib/market/data/repositories/market_repository.dart << 'EOF'
import '../../../core/storage/chart_cache/chart_cache_storage.dart';
import '../../../core/network/rest_client.dart';
import '../../../core/models/candle_entity.dart';

class MarketRepository {
  final RestClient rest;
  final ChartCacheStorage cache;

  MarketRepository({required this.rest, required this.cache});

  Future<List<CandleEntity>> getHistoricalCandles({
    required String symbol,
    required String timeframe,
  }) async {
    final cached = await cache.get(symbol, timeframe);
    if (cached.isNotEmpty) {
      // return cache while fetching remote update
      _refreshRemote(symbol, timeframe);
      return cached;
    }
    final remote = await _fetchRemote(symbol, timeframe);
    await cache.save(symbol, timeframe, remote);
    return remote;
  }

  Future<void> _refreshRemote(String symbol, String timeframe) async {
    try {
      final remote = await _fetchRemote(symbol, timeframe);
      await cache.save(symbol, timeframe, remote);
    } catch (e) {
      // ignore
    }
  }

  Future<List<CandleEntity>> _fetchRemote(
      String symbol, String timeframe) async {
    final resp = await rest.get("/history/$symbol/$timeframe");
    // parse JSON â†’ List<CandleEntity>
    // implementation depends on API shape
    return [];
  }
}
EOF
cat > lib/core/storage/chart_cache/chart_cache_hive.dart << 'EOF'
import 'package:hive/hive.dart';
import '../../../core/models/candle_entity.dart';

part "chart_cache_hive.g.dart";

@HiveType(typeId: 50)
class ChartCacheEntity extends HiveObject {
  @HiveField(0)
  final String symbol;

  @HiveField(1)
  final String timeframe;

  @HiveField(2)
  final List<CandleEntity> candles;

  ChartCacheEntity({
    required this.symbol,
    required this.timeframe,
    required this.candles,
  });
}
EOF
cat > lib/core/storage/chart_cache/chart_cache_storage.dart << 'EOF'
import 'package:hive/hive.dart';
import 'chart_cache_hive.dart';

class ChartCacheStorage {
  static const _box = "chart_cache_box";

  Future<void> save(
      String symbol, String timeframe, List<CandleEntity> candles) async {
    final box = await Hive.openBox<ChartCacheEntity>(_box);
    await box.put("${symbol}_$timeframe",
        ChartCacheEntity(symbol: symbol, timeframe: timeframe, candles: candles));
  }

  Future<List<CandleEntity>> get(String symbol, String timeframe) async {
    final box = await Hive.openBox<ChartCacheEntity>(_box);
    final entity = box.get("${symbol}_$timeframe");
    return entity?.candles ?? [];
  }

  Future<void> clear() async {
    final box = await Hive.openBox<ChartCacheEntity>(_box);
    await box.clear();
  }
}
EOF
cat > test/widgets/offline/offline_banner_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:your_app/main.dart';

void main() {
  testWidgets('Offline banner appears', (tester) async {
    await tester.pumpWidget(MyApp());
    // Simulate offline event
    // This part may require dependency injection of NetworkService
  });
}
EOF
cat > lib/core/time/time_canon.dart << 'EOF'
class TimeCanon {
  /// ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ DateTime Ø£Ùˆ String Ø¥Ù„Ù‰ UTC Ù…ÙˆØ­Ù‘Ø¯
  static DateTime toUtc(dynamic t) {
    if (t is DateTime) {
      return t.toUtc();
    }
    if (t is String) {
      return DateTime.parse(t).toUtc();
    }
    throw ArgumentError("Unsupported time type: $t");
  }

  /// ÙŠÙ‚Ø§Ø±Ù† Ø²Ù…Ù†ÙŠÙ† Ø¨Ø¹Ø¯ ØªÙˆØ­ÙŠØ¯Ù‡Ù…Ø§
  static bool isSameInstant(dynamic a, dynamic b) {
    return toUtc(a).isAtSameMomentAs(toUtc(b));
  }

  /// ÙŠØ¶Ù…Ù† Ø£Ù† Ø£ÙŠ Timestamp ØµØ§Ø¯Ø± Ø¹Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡Ùˆ UTC ÙÙ‚Ø·
  static String isoUtc(DateTime t) {
    return t.toUtc().toIso8601String();
  }
}
EOF
cat > lib/core/models/candle_entity.dart << 'EOF'
import '../time/time_canon.dart';

class CandleEntity {
  final String instrument;
  final DateTime timeUtc;
  final double open;
  final double high;
  final double low;
  final double close;
  final double volume;

  CandleEntity({
    required this.instrument,
    required this.timeUtc,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });

  factory CandleEntity.fromJson(String instrument, Map<String, dynamic> json) {
    return CandleEntity(
      instrument: instrument,
      timeUtc: TimeCanon.toUtc(json['time']),
      open: double.parse(json['open']),
      high: double.parse(json['high']),
      low: double.parse(json['low']),
      close: double.parse(json['close']),
      volume: double.parse(json['volume']),
    );
  }
}
EOF
cat > lib/core/models/price/market_price.dart << 'EOF'
enum PriceType { bid, ask, mid }

class MarketPrice {
  final double bid;
  final double ask;

  MarketPrice({required this.bid, required this.ask});

  double of(PriceType type) {
    switch (type) {
      case PriceType.bid:
        return bid;
      case PriceType.ask:
        return ask;
      case PriceType.mid:
        return (bid + ask) / 2;
    }
  }
}
EOF
cat > lib/core/models/tick_entity.dart << 'EOF'
import '../time/time_canon.dart';
import 'price/market_price.dart';

class TickEntity {
  final String instrument;
  final DateTime timeUtc;
  final MarketPrice price;

  TickEntity({
    required this.instrument,
    required this.timeUtc,
    required this.price,
  });

  factory TickEntity.fromJson(String instrument, Map<String, dynamic> json) {
    return TickEntity(
      instrument: instrument,
      timeUtc: TimeCanon.toUtc(json['time']),
      price: MarketPrice(
        bid: double.parse(json['bid']),
        ask: double.parse(json['ask']),
      ),
    );
  }
}
EOF
cat > lib/features/market/data/streaming/tick_aggregator.dart << 'EOF'
import '../../../core/models/tick_entity.dart';
import '../../../core/models/candle_entity.dart';
import '../../../core/time/time_canon.dart';

class TickAggregator {
  final String instrument;
  final Duration timeframe;
  CandleEntity? _current;
  final List<CandleEntity> archive = [];

  TickAggregator(this.instrument, this.timeframe);

  void addTick(TickEntity tick) {
    final tickTime = tick.timeUtc;

    if (_current == null) {
      _current = _newCandleFromTick(tick);
      return;
    }

    // Ø¥Ø°Ø§ Ù‚ÙØ² Ø§Ù„Ø²Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† timeframe â†’ ÙØ¬ÙˆØ©
    if (tickTime.difference(_current!.timeUtc) >= timeframe) {
      archive.add(_current!);
      _current = _newCandleFromTick(tick);
      return;
    }

    // ØªØ­Ø¯ÙŠØ« High/Low/Close
    _current = CandleEntity(
      instrument: instrument,
      timeUtc: _current!.timeUtc,
      open: _current!.open,
      high: tick.price.of(PriceType.mid) > _current!.high
          ? tick.price.of(PriceType.mid)
          : _current!.high,
      low: tick.price.of(PriceType.mid) < _current!.low
          ? tick.price.of(PriceType.mid)
          : _current!.low,
      close: tick.price.of(PriceType.mid),
      volume: _current!.volume + 1,
    );
  }

  CandleEntity _newCandleFromTick(TickEntity t) {
    final p = t.price.of(PriceType.mid);
    return CandleEntity(
      instrument: instrument,
      timeUtc: t.timeUtc,
      open: p,
      high: p,
      low: p,
      close: p,
      volume: 1,
    );
  }

  List<CandleEntity> buildCandles() {
    return List.unmodifiable(archive);
  }
}
EOF
cat > lib/features/strategy/domain/ast/expr.dart << 'EOF'
abstract class Expr {
  bool eval(Map<String, double> ctx);
}

class GreaterThan extends Expr {
  final String left;
  final String right;

  GreaterThan(this.left, this.right);

  @override
  bool eval(Map<String, double> ctx) {
    return ctx[left]! > ctx[right]!;
  }
}

class LessThan extends Expr {
  final String left;
  final String right;

  LessThan(this.left, this.right);

  @override
  bool eval(Map<String, double> ctx) {
    return ctx[left]! < ctx[right]!;
  }
}

class AndExpr extends Expr {
  final Expr a, b;
  AndExpr(this.a, this.b);

  @override
  bool eval(Map<String, double> ctx) => a.eval(ctx) && b.eval(ctx);
}
EOF
cat > lib/features/strategy/domain/signal/signal.dart << 'EOF'
enum SignalType { buy, sell, hold }

class Signal {
  final SignalType type;
  final DateTime time;

  Signal(this.type, this.time);
}
EOF
cat > lib/features/strategy/domain/fsm/strategy_state.dart << 'EOF'
enum StrategyState {
  idle,
  initializing,
  active,
  paused,
  error,
  completed,
}
EOF
cat > lib/features/strategy/domain/fsm/strategy_fsm.dart << 'EOF'
import 'strategy_state.dart';

class StrategyFSM {
  StrategyState _state = StrategyState.idle;
  StrategyState get state => _state;

  void transitionTo(StrategyState next) {
    // Ù…Ù†Ø·Ù‚ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¢Ù…Ù†
    if (_state == StrategyState.error && next != StrategyState.idle) return;
    _state = next;
  }

  bool get isRunning => _state == StrategyState.active;
}
EOF
cat > lib/features/strategy/presentation/bloc/strategy_bloc.dart << 'EOF'
import '../../../domain/fsm/strategy_fsm.dart';

class StrategyBloc {
  final StrategyFSM fsm = StrategyFSM();

  void start() {
    fsm.transitionTo(StrategyState.initializing);
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    fsm.transitionTo(StrategyState.active);
  }

  void stop() {
    fsm.transitionTo(StrategyState.paused);
  }
}
EOF
cat > lib/features/trading/domain/lot_manager.dart << 'EOF'
class LotManager {
  double lotSize = 1.0;

  void setLot(double l) {
    if (l <= 0) throw ArgumentError("Lot size must be > 0");
    lotSize = l;
  }

  double get current => lotSize;
}
EOF
cat > lib/features/trading/domain/execution_engine.dart << 'EOF'
import 'lot_manager.dart';

class ExecutionEngine {
  final LotManager lotManager;

  ExecutionEngine(this.lotManager);

  void executeBuy(String symbol) {
    final lot = lotManager.current;
    print("Executing BUY $symbol @ lot $lot");
    // TODO: ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©
  }
}
EOF
cat > lib/features/account/domain/account_model.dart << 'EOF'
class AccountModel {
  double balance;
  double equity;
  double marginUsed = 0;
  double leverage = 100;

  AccountModel({
    required this.balance,
    required this.equity,
    this.leverage = 100,
  });

  double get availableMargin => equity - marginUsed;

  bool canOpen(double lotSize, double price) {
    final required = (lotSize * price) / leverage;
    return required <= availableMargin;
  }

  void openPosition(double lotSize, double price) {
    final required = (lotSize * price) / leverage;
    if (!canOpen(lotSize, price)) throw Exception("Insufficient margin");
    marginUsed += required;
  }

  void closePosition(double lotSize, double price) {
    final released = (lotSize * price) / leverage;
    marginUsed -= released;
  }
}
EOF
cat > lib/features/trading/domain/slippage_model.dart << 'EOF'
import 'dart:math';

class SlippageModel {
  double maxSlippage = 0.0005;

  double apply(double intendedPrice) {
    final slip = Random().nextDouble() * maxSlippage;
    return intendedPrice + slip;
  }
}
EOF
cat > lib/features/trading/domain/slipped_execution.dart << 'EOF'
import 'slippage_model.dart';

class SlippedExecution {
  final SlippageModel slippage;

  SlippedExecution(this.slippage);

  double execute(double intendedPrice) {
    return slippage.apply(intendedPrice);
  }
}
EOF
cat > lib/core/models/price/spread_model.dart << 'EOF'
class SpreadModel {
  final double bid;
  final double ask;

  SpreadModel({required this.bid, required this.ask});

  double get spread => ask - bid;
}
EOF
cat > lib/features/trading/domain/order/order.dart << 'EOF'
enum OrderStatus { pending, partiallyFilled, filled, rejected }

class Order {
  final String id;
  final String symbol;
  final double requestedLots;
  double filledLots;
  final double price;
  OrderStatus status;

  Order({
    required this.id,
    required this.symbol,
    required this.requestedLots,
    required this.filledLots,
    required this.price,
    this.status = OrderStatus.pending,
  });

  double get remainingLots => requestedLots - filledLots;

  void fill(double lots) {
    filledLots += lots;
    if (filledLots >= requestedLots) {
      filledLots = requestedLots;
      status = OrderStatus.filled;
    } else {
      status = OrderStatus.partiallyFilled;
    }
  }
}
EOF
cat > lib/features/trading/domain/order/partial_execution_engine.dart << 'EOF'
import 'dart:math';
import 'order.dart';

class PartialExecutionEngine {
  final Random _rng = Random();

  Order execute(Order order) {
    // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ†ÙÙŠØ° Ø¬Ø²Ø¦ÙŠ
    final fill = order.requestedLots * (0.5 + _rng.nextDouble() * 0.5);

    order.fill(fill);
    return order;
  }
}
EOF
cat > lib/features/trading/domain/errors/execution_error.dart << 'EOF'
enum ExecutionErrorType {
  network,
  insufficientMargin,
  rejectedByBroker,
  timeout,
}

class ExecutionError implements Exception {
  final ExecutionErrorType type;
  final String message;

  ExecutionError(this.type, this.message);
}
EOF
cat > lib/features/trading/domain/order/retriable_execution_engine.dart << 'EOF'
import 'dart:async';
import '../errors/execution_error.dart';
import 'order.dart';

class RetriableExecutionEngine {
  Future<Order> executeWithRetry(
    Order order, {
    int maxRetries = 3,
  }) async {
    int attempt = 0;

    while (attempt < maxRetries) {
      try {
        // Ù‡Ù†Ø§ Ù…ÙƒØ§Ù† Ø±Ø¨Ø· Ø§Ù„Ù€ API Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
        if (attempt == 0) throw ExecutionError(ExecutionErrorType.network, "Timeout");

        order.status = OrderStatus.filled;
        return order;
      } catch (e) {
        attempt++;
        if (attempt >= maxRetries) rethrow;
        await Future.delayed(Duration(milliseconds: 500 * attempt));
      }
    }
    throw ExecutionError(ExecutionErrorType.timeout, "Max retries exceeded");
  }
}
EOF
cat > lib/features/trading/domain/order/order.dart << 'EOF'
enum OrderStatus { pending, partiallyFilled, filled, rejected }

class Order {
  final String id;
  final String symbol;
  final double requestedLots;
  double filledLots;
  final double price;
  final DateTime createdAt;
  DateTime? executedAt;
  OrderStatus status;

  Order({
    required this.id,
    required this.symbol,
    required this.requestedLots,
    required this.filledLots,
    required this.price,
    DateTime? createdAt,
    this.executedAt,
    this.status = OrderStatus.pending,
  }) : createdAt = createdAt ?? DateTime.now().toUtc();

  double get remainingLots => requestedLots - filledLots;

  void markExecuted() {
    executedAt = DateTime.now().toUtc();
    status = OrderStatus.filled;
  }
}
EOF
cat > lib/features/trading/domain/history/trade_history.dart << 'EOF'
class TradeHistory {
  final List<String> events = [];

  void log(String event) {
    events.add("${DateTime.now().toUtc().toIso8601String()} | $event");
  }
}
EOF
cat > lib/features/trading/domain/audit/reject_logger.dart << 'EOF'
class RejectLogger {
  final List<String> rejected = [];

  void log(String orderId, String reason) {
    rejected.add("${DateTime.now().toUtc().toIso8601String()} | $orderId | $reason");
  }
}
EOF
cat > lib/core/models/dto/candle_dto.dart << 'EOF'
class CandleDto {
  final String time;
  final String open;
  final String high;
  final String low;
  final String close;
  final String volume;

  CandleDto({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    required this.volume,
  });

  factory CandleDto.fromJson(Map<String, dynamic> json) {
    return CandleDto(
      time: json['time'],
      open: json['o'],
      high: json['h'],
      low: json['l'],
      close: json['c'],
      volume: json['v'],
    );
  }
}
EOF
cat > lib/features/market/domain/repository/market_repository.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

abstract class MarketRepository {
  Future<List<CandleEntity>> getCandles(String symbol, String timeframe);
  Stream<CandleEntity> streamCandles(String symbol, String timeframe);
}
EOF
cat > lib/features/market/data/repository/market_repository_impl.dart << 'EOF'
import '../../../domain/repository/market_repository.dart';
import '../../../../core/models/candle_entity.dart';

class MarketRepositoryImpl implements MarketRepository {
  @override
  Future<List<CandleEntity>> getCandles(String symbol, String timeframe) async {
    // Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ø¨Ø± REST
    throw UnimplementedError();
  }

  @override
  Stream<CandleEntity> streamCandles(String symbol, String timeframe) {
    // Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ø¨Ø± WebSocket
    throw UnimplementedError();
  }
}
EOF
cat > lib/features/trading/domain/interface/trading_engine.dart << 'EOF'
import '../order/order.dart';

abstract class TradingEngine {
  Future<Order> sendOrder(Order order);
  void cancelOrder(String orderId);
  List<Order> activeOrders();
}
EOF
cat > lib/features/trading/domain/usecases/place_order_usecase.dart << 'EOF'
import '../interface/trading_engine.dart';
import '../order/order.dart';

class PlaceOrderUseCase {
  final TradingEngine engine;

  PlaceOrderUseCase(this.engine);

  Future<Order> call(Order order) => engine.sendOrder(order);
}
EOF
cat > lib/core/async/dispatcher.dart << 'EOF'
import 'dart:async';
import 'package:flutter/foundation.dart';

class Dispatcher {
  static Future<T> computeAsync<T>(FutureOr<T> Function() fn) {
    return compute(_wrap, fn);
  }

  static T _wrap<T>(FutureOr<T> Function() fn) => fn();
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_state.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

abstract class ChartState {}

class ChartIdle extends ChartState {}

class ChartLoading extends ChartState {}

class ChartLoaded extends ChartState {
  final List<CandleEntity> candles;
  final DateTime from;
  final DateTime to;

  ChartLoaded(this.candles, this.from, this.to);
}

class ChartLiveUpdated extends ChartState {
  final CandleEntity latest;
  ChartLiveUpdated(this.latest);
}

class ChartError extends ChartState {
  final String message;
  ChartError(this.message);
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_event.dart << 'EOF'
abstract class ChartEvent {}

class LoadChartHistory extends ChartEvent {
  final String symbol;
  final String timeframe;
  final DateTime from;
  final DateTime to;

  LoadChartHistory(this.symbol, this.timeframe, this.from, this.to);
}

class AppendLiveCandle extends ChartEvent {
  final CandleEntity newCandle;
  AppendLiveCandle(this.newCandle);
}
EOF
cat > lib/features/backtest/domain/backtest_controller.dart << 'EOF'
import 'dart:async';

class BacktestController {
  bool _cancelled = false;

  bool get isCancelled => _cancelled;

  void cancel() {
    _cancelled = true;
  }
}
EOF
cat > lib/features/common/data/cache/bloc_state_cache.dart << 'EOF'
import 'package:hive/hive.dart';

class BlocStateCache {
  final Box box;

  BlocStateCache(this.box);

  void save(String key, dynamic data) => box.put(key, data);
  dynamic load(String key) => box.get(key);
}
EOF
cat > lib/core/network/websocket/ping_manager.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class PingManager {
  final WebSocketChannel channel;
  late Timer _timer;

  PingManager(this.channel);

  void start() {
    _timer = Timer.periodic(Duration(seconds: 20), (_) {
      channel.sink.add('ping');
    });
  }

  void stop() {
    _timer.cancel();
  }
}
EOF
cat > lib/core/network/websocket/message_verifier.dart << 'EOF'
class MessageVerifier {
  int? lastId;

  bool isInOrder(int newId) {
    if (lastId == null) {
      lastId = newId;
      return true;
    }

    if (newId > lastId!) {
      lastId = newId;
      return true;
    }

    return false; // out-of-order
  }
}
EOF
cat > lib/features/market/data/cache/tick_buffer.dart << 'EOF'
import '../../../core/models/tick_entity.dart';

class TickBuffer {
  final List<TickEntity> buffer = [];

  void add(TickEntity t) => buffer.add(t);

  List<TickEntity> flush() {
    final copy = List<TickEntity>.from(buffer);
    buffer.clear();
    return copy;
  }
}
EOF
cat > lib/core/network/fallback_manager.dart << 'EOF'
enum SourceStatus { healthy, degraded, offline }

class FallbackManager {
  SourceStatus status = SourceStatus.healthy;

  void markDegraded() => status = SourceStatus.degraded;
  void markOffline() => status = SourceStatus.offline;
  void markHealthy() => status = SourceStatus.healthy;

  bool shouldUseRest() => status != SourceStatus.healthy;
}
EOF
cat > lib/features/market/domain/sync/market_sync_coordinator.dart << 'EOF'
import '../../../core/models/candle_entity.dart';
import '../../../core/models/tick_entity.dart';

typedef TickListener = void Function(TickEntity tick);
typedef CandleListener = void Function(CandleEntity candle);

class MarketSyncCoordinator {
  final _tickListeners = <TickListener>[];
  final _candleListeners = <CandleListener>[];

  void registerTickListener(TickListener listener) => _tickListeners.add(listener);
  void registerCandleListener(CandleListener listener) => _candleListeners.add(listener);

  void dispatchTick(TickEntity tick) {
    for (final l in _tickListeners) {
      l(tick);
    }
  }

  void dispatchCandle(CandleEntity candle) {
    for (final l in _candleListeners) {
      l(candle);
    }
  }
}
EOF
cat > lib/features/indicators/domain/visible_range_engine.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class VisibleRangeEngine {
  List<CandleEntity> applyVisibleRange(
    List<CandleEntity> candles,
    DateTime from,
    DateTime to,
  ) {
    return candles.where((c) => c.timeUtc.isAfter(from) && c.timeUtc.isBefore(to)).toList();
  }
}
EOF
cat > lib/features/indicators/domain/live_indicator_updater.dart << 'EOF'
import '../../../core/models/tick_entity.dart';
import '../../../core/models/candle_entity.dart';

class LiveIndicatorUpdater {
  CandleEntity _current = CandleEntity(...); // ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø¢Ø®Ø± Ø´Ù…Ø¹Ø©

  void onTick(TickEntity tick) {
    // ØªØ­Ø¯ÙŠØ« High/Low/Close Ù„Ø­Ø¸ÙŠÙ‹Ø§
    final mid = (tick.price.ask + tick.price.bid) / 2;
    _current = CandleEntity(
      instrument: _current.instrument,
      timeUtc: _current.timeUtc,
      open: _current.open,
      high: mid > _current.high ? mid : _current.high,
      low: mid < _current.low ? mid : _current.low,
      close: mid,
      volume: _current.volume + 1,
    );

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ†
  }
}
EOF
cat > lib/features/indicators/domain/sync_aligner.dart << 'EOF'
class SyncAligner {
  final Duration bufferDelay = Duration(milliseconds: 500);

  DateTime align(DateTime input) {
    return input.add(bufferDelay);
  }
}
EOF
cat > lib/features/chart/domain/tools/drawing_tool_sync.dart << 'EOF'
class DrawingToolSync {
  double mapPriceToY({
    required double price,
    required double minPrice,
    required double maxPrice,
    required double height,
  }) {
    return height * (maxPrice - price) / (maxPrice - minPrice);
  }

  double mapTimeToX({
    required DateTime time,
    required DateTime start,
    required DateTime end,
    required double width,
  }) {
    final total = end.difference(start).inMilliseconds.toDouble();
    final delta = time.difference(start).inMilliseconds.toDouble();
    return width * (delta / total);
  }
}
EOF
cat > lib/core/storage/hive/hive_migration.dart << 'EOF'
import 'package:hive/hive.dart';

Future<void> performMigration(Box box, int fromVersion, int toVersion) async {
  if (fromVersion < 2 && toVersion >= 2) {
    // Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ ØªØ­Ø¯ÙŠØ« schema
    final all = box.toMap();
    for (var k in all.keys) {
      final entry = all[k];
      if (entry is Map && !entry.containsKey('volume')) {
        entry['volume'] = '0';
        await box.put(k, entry);
      }
    }
  }
}
EOF
cat > lib/core/storage/safe_storage.dart << 'EOF'
import 'package:hive/hive.dart';

class SafeStorage {
  final Box box;

  SafeStorage(this.box);

  T? read<T>(String key) {
    try {
      return box.get(key) as T?;
    } catch (e) {
      return null;
    }
  }

  Future<void> write<T>(String key, T value) async {
    try {
      await box.put(key, value);
    } catch (e) {
      print("Storage error: $e");
    }
  }
}
EOF
cat > lib/features/market/data/cache/candle_cache_cleaner.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class CandleCacheCleaner {
  final int maxSize;

  CandleCacheCleaner({this.maxSize = 1000});

  List<CandleEntity> clean(List<CandleEntity> candles) {
    if (candles.length <= maxSize) return candles;
    return candles.sublist(candles.length - maxSize);
  }
}
EOF
cat > lib/core/storage/hive/compactor.dart << 'EOF'
import 'package:hive/hive.dart';

Future<void> compactIfNeeded(Box box) async {
  if (box.length > 1000) {
    await box.compact();
  }
}
EOF
cat > lib/core/storage/usage_monitor.dart << 'EOF'
import 'dart:io';
import 'package:path_provider/path_provider.dart';

class StorageUsageMonitor {
  Future<int> calculateUsedBytes() async {
    final dir = await getApplicationDocumentsDirectory();
    int total = 0;
    await for (var file in dir.list(recursive: true)) {
      if (file is File) {
        total += await file.length();
      }
    }
    return total;
  }
}
EOF
cat > lib/features/indicators/engine/indicator_engine.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

abstract class IndicatorPlugin {
  Map<String, double> compute(List<CandleEntity> candles);
}

class IndicatorEngine {
  final List<IndicatorPlugin> plugins;

  IndicatorEngine(this.plugins);

  Map<String, double> calculate(List<CandleEntity> candles) {
    final result = <String, double>{};
    for (final plugin in plugins) {
      result.addAll(plugin.compute(candles));
    }
    return result;
  }
}
EOF
cat > lib/features/indicators/plugins/ema_plugin.dart << 'EOF'
import '../../engine/indicator_engine.dart';
import '../../../../core/models/candle_entity.dart';

class EMAPlugin implements IndicatorPlugin {
  final int period;
  double? prevEma;

  EMAPlugin(this.period);

  @override
  Map<String, double> compute(List<CandleEntity> candles) {
    final prices = candles.map((e) => e.close).toList();
    final multiplier = 2 / (period + 1);
    double? ema = prevEma ?? prices.first;

    for (final price in prices) {
      ema = (price - ema!) * multiplier + ema;
    }

    prevEma = ema;
    return {'EMA$period': ema ?? 0};
  }
}
EOF
cat > lib/features/indicators/engine/zoom_sensitive_engine.dart << 'EOF'
import '../../../core/models/candle_entity.dart';
import 'indicator_engine.dart';

class ZoomSensitiveEngine extends IndicatorEngine {
  ZoomSensitiveEngine(super.plugins);

  Map<String, double> calculateInRange(
      List<CandleEntity> all, DateTime from, DateTime to) {
    final visible = all.where((c) => c.timeUtc.isAfter(from) && c.timeUtc.isBefore(to)).toList();
    return super.calculate(visible);
  }
}
EOF
cat > assets/js/chart_extension.js << 'EOF'
// ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Flutter
function addIndicatorSeries(name, dataPoints) {
  const series = chart.addLineSeries({ color: '#00bcd4' });
  series.setData(dataPoints);
}
EOF
cat > test/performance/indicator_perf_test.dart << 'EOF'
import 'package:test/test.dart';
import '../../../lib/features/indicators/engine/indicator_engine.dart';
import '../../../lib/features/indicators/plugins/ema_plugin.dart';

void main() {
  test('EMA performance on 50k candles', () {
    final candles = List.generate(
      50000,
      (i) => CandleEntity(...), // mock data
    );

    final engine = IndicatorEngine([EMAPlugin(50)]);

    final sw = Stopwatch()..start();
    final result = engine.calculate(candles);
    sw.stop();

    print("Execution time: ${sw.elapsedMilliseconds} ms");

    expect(sw.elapsedMilliseconds < 300, true); // Ø£Ù‚Ù„ Ù…Ù† 300ms
  });
}
EOF
cat > lib/core/navigation/fade_route.dart << 'EOF'
import 'package:flutter/material.dart';

class FadeRoute extends PageRouteBuilder {
  final Widget page;

  FadeRoute(this.page)
      : super(
          pageBuilder: (context, animation, secondaryAnimation) => page,
          transitionsBuilder: (context, animation, secondaryAnimation, child) {
            return FadeTransition(opacity: animation, child: child);
          },
        );
}
EOF
cat > lib/core/widgets/shimmer_placeholder.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

class ShimmerPlaceholder extends StatelessWidget {
  final double height;
  final double width;

  ShimmerPlaceholder({this.height = 100, this.width = double.infinity});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey[300]!,
      highlightColor: Colors.grey[100]!,
      child: Container(
        height: height,
        width: width,
        color: Colors.white,
      ),
    );
  }
}
EOF
cat > lib/core/network/error_handler.dart << 'EOF'
class NetworkErrorHandler {
  static String parseError(dynamic error) {
    if (error.toString().contains('SocketException')) return "Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
    if (error.toString().contains('TimeoutException')) return "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„.";
    return "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
  }
}
EOF
cat > lib/core/widgets/notification_toast.dart << 'EOF'
import 'package:fluttertoast/fluttertoast.dart';

class NotificationToast {
  static void show(String msg) {
    Fluttertoast.showToast(
      msg: msg,
      toastLength: Toast.LENGTH_SHORT,
      gravity: ToastGravity.BOTTOM,
    );
  }
}
EOF
cat > lib/core/audio/alert_sound.dart << 'EOF'
import 'package:audioplayers/audioplayers.dart';

class AlertSound {
  final AudioPlayer _player = AudioPlayer();

  Future<void> playBuy() => _player.play(AssetSource('audio/buy.mp3'));
  Future<void> playSell() => _player.play(AssetSource('audio/sell.mp3'));
}
EOF
cat > lib/core/theme/app_theme.dart << 'EOF'
import 'package:flutter/material.dart';

class AppTheme {
  static final light = ThemeData.light().copyWith(
    primaryColor: Colors.blue,
    brightness: Brightness.light,
  );

  static final dark = ThemeData.dark().copyWith(
    primaryColor: Colors.blueGrey,
    brightness: Brightness.dark,
  );
}
EOF
cat > lib/features/settings/domain/chart_style_settings.dart << 'EOF'
class ChartStyleSettings {
  String candleUpColor = "#00ff00";
  String candleDownColor = "#ff0000";
  String emaColor = "#00bcd4";
}
EOF
cat > lib/core/storage/preferences.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';

class UserPreferences {
  static Future<void> saveTheme(bool isDark) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('darkMode', isDark);
  }

  static Future<bool> loadTheme() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool('darkMode') ?? false;
  }
}
EOF
cat > lib/features/settings/domain/trading_profile.dart << 'EOF'
class TradingProfile {
  final String name;
  final double riskPercent;
  final double lotSize;

  TradingProfile({
    required this.name,
    required this.riskPercent,
    required this.lotSize,
  });
}
EOF
cat > lib/features/settings/presentation/settings_screen.dart << 'EOF'
import 'package:flutter/material.dart';

class SettingsScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")),
      body: ListView(
        children: [
          SwitchListTile(
            title: Text("Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ"),
            value: true,
            onChanged: (val) {},
          ),
          ListTile(
            title: Text("Ù„ÙˆÙ† Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„ØµØ§Ø¹Ø¯Ø©"),
            trailing: CircleAvatar(backgroundColor: Colors.green),
          ),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/alerts/domain/alert_condition.dart << 'EOF'
class AlertCondition {
  final String indicator;
  final String operator; // ex: <, >, <=
  final double threshold;
  final Duration duration; // e.g., trigger if condition holds for 2 minutes

  AlertCondition({
    required this.indicator,
    required this.operator,
    required this.threshold,
    required this.duration,
  });
}
EOF
cat > lib/features/alerts/domain/alert_engine.dart << 'EOF'
import 'alert_condition.dart';

class AlertEngine {
  final List<AlertCondition> conditions;
  final Map<String, DateTime> _startMap = {};

  AlertEngine(this.conditions);

  List<String> evaluate(Map<String, double> indicatorValues) {
    final now = DateTime.now();
    final triggered = <String>[];

    for (final cond in conditions) {
      final value = indicatorValues[cond.indicator] ?? 0;
      final satisfied = _compare(value, cond.operator, cond.threshold);

      final key = cond.indicator + cond.operator + cond.threshold.toString();
      if (satisfied) {
        _startMap.putIfAbsent(key, () => now);
        if (now.difference(_startMap[key]!) >= cond.duration) {
          triggered.add('${cond.indicator} ${cond.operator} ${cond.threshold}');
        }
      } else {
        _startMap.remove(key);
      }
    }

    return triggered;
  }

  bool _compare(double v, String op, double t) {
    switch (op) {
      case '>': return v > t;
      case '<': return v < t;
      case '>=': return v >= t;
      case '<=': return v <= t;
      case '==': return v == t;
      default: return false;
    }
  }
}
EOF
cat > lib/features/alerts/presentation/alert_notifier.dart << 'EOF'
import '../../../core/widgets/notification_toast.dart';
import '../../../core/audio/alert_sound.dart';

class AlertNotifier {
  final _sound = AlertSound();

  void trigger(String message) {
    NotificationToast.show(message);
    _sound.playBuy(); // Ù…Ø«Ø§Ù„: ØµÙˆØª Ù…ÙˆØ­Ø¯
  }
}
EOF
cat > lib/features/alerts/data/alert_log_repository.dart << 'EOF'
import 'package:hive/hive.dart';

class AlertLogRepository {
  static Future<void> log(String msg) async {
    final box = await Hive.openBox('alertLogs');
    await box.add({'msg': msg, 'timestamp': DateTime.now().toIso8601String()});
  }

  static Future<List<Map>> getLogs() async {
    final box = await Hive.openBox('alertLogs');
    return box.values.cast<Map>().toList();
  }
}
EOF
cat > lib/features/alerts/presentation/alert_log_screen.dart << 'EOF'
import 'package:flutter/material.dart';
import '../data/alert_log_repository.dart';

class AlertLogScreen extends StatefulWidget {
  @override
  _AlertLogScreenState createState() => _AlertLogScreenState();
}

class _AlertLogScreenState extends State<AlertLogScreen> {
  List<Map> logs = [];

  @override
  void initState() {
    super.initState();
    AlertLogRepository.getLogs().then((value) => setState(() => logs = value));
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Ø³Ø¬Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª")),
      body: ListView.builder(
        itemCount: logs.length,
        itemBuilder: (_, i) => ListTile(
          title: Text(logs[i]['msg']),
          subtitle: Text(logs[i]['timestamp']),
        ),
      ),
    );
  }
}
EOF
cat > lib/features/indicators/presentation/indicator_selector.dart << 'EOF'
import 'package:flutter/material.dart';

class IndicatorSelector extends StatelessWidget {
  final Function(String) onSelect;

  IndicatorSelector({required this.onSelect});

  @override
  Widget build(BuildContext context) {
    final indicators = ["EMA", "RSI", "Stochastic", "MACD"];

    return BottomSheet(
      onClosing: () {},
      builder: (ctx) => ListView(
        children: indicators.map((ind) => ListTile(
          title: Text(ind),
          onTap: () => onSelect(ind),
        )).toList(),
      ),
    );
  }
}
EOF
cat > lib/features/strategy/domain/strategy_model.dart << 'EOF'
class StrategyModel {
  final List<String> requiredSignals;
  final String action; // BUY / SELL

  StrategyModel({
    required this.requiredSignals,
    required this.action,
  });

  bool canTrigger(List<String> activeSignals) {
    return requiredSignals.every((sig) => activeSignals.contains(sig));
  }
}
EOF
cat > lib/features/strategy/domain/strategy_engine.dart << 'EOF'
import 'strategy_model.dart';

class StrategyEngine {
  final List<StrategyModel> strategies;

  StrategyEngine(this.strategies);

  String? evaluate(List<String> activeSignals) {
    for (final strategy in strategies) {
      if (strategy.canTrigger(activeSignals)) return strategy.action;
    }
    return null;
  }
}
EOF
cat > assets/js/zone_overlay.js << 'EOF'
// ÙŠØ³ØªØ¯Ø¹ÙŠÙ‡Ø§ Flutter Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ­ØµÙ„ ØªÙ†Ø¨ÙŠÙ‡
function highlightZone(fromTs, toTs, color = '#ffc107') {
  chart.addAreaSeries({
    topColor: color,
    bottomColor: color + "33",
    lineColor: color,
    lineWidth: 1,
  }).setData([
    { time: fromTs, value: 1 },
    { time: toTs, value: 1 }
  ]);
}
EOF
cat > lib/features/chart/domain/chart_zones_repository.dart << 'EOF'
import 'package:hive/hive.dart';

class ChartZonesRepository {
  static Future<void> saveZone(int fromTs, int toTs, String color) async {
    final box = await Hive.openBox('chartZones');
    await box.add({'from': fromTs, 'to': toTs, 'color': color});
  }

  static Future<List<Map>> getZones() async {
    final box = await Hive.openBox('chartZones');
    return box.values.cast<Map>().toList();
  }
}
EOF
cat > lib/features/analytics/domain/trade_statistics.dart << 'EOF'
import '../../../features/trading/domain/order/order.dart';

class TradeStatistics {
  final List<Order> orders;

  TradeStatistics(this.orders);

  double get totalProfit => orders.fold(0.0, (sum, o) => sum + (o.filledLots * o.price));

  double get winRate {
    final wins = orders.where((o) => o.price > 0).length;
    return orders.isEmpty ? 0 : wins / orders.length;
  }

  double get maxDrawdown {
    // Ù…Ø«Ø§Ù„ ØªÙ‚Ø±ÙŠØ¨ÙŠ
    double peak = 0;
    double drawdown = 0;
    double equity = 0;
    for (var o in orders) {
      equity += o.price;
      if (equity > peak) peak = equity;
      drawdown = peak - equity;
    }
    return drawdown;
  }
}
EOF
cat > assets/js/equity_curve.js << 'EOF'
function drawEquityCurve(points) {
  const series = chart.addLineSeries({ color: '#2196f3' });
  series.setData(points);
}
EOF
cat > lib/features/analytics/domain/strategy_comparer.dart << 'EOF'
import 'trade_statistics.dart';

class StrategyComparer {
  final TradeStatistics a, b;

  StrategyComparer(this.a, this.b);

  String compare() {
    if (a.totalProfit > b.totalProfit) return "A Ø£ÙØ¶Ù„";
    if (b.totalProfit > a.totalProfit) return "B Ø£ÙØ¶Ù„";
    return "Ù…ØªØ¹Ø§Ø¯Ù„Ø§Ù†";
  }
}
EOF
cat > lib/core/markets/market_definitions.dart << 'EOF'
enum MarketType { forex, crypto, commodity, stock }

class Instrument {
  final String symbol;
  final MarketType type;

  Instrument(this.symbol, this.type);
}
EOF
cat > lib/core/network/markets_api.dart << 'EOF'
import 'rest_client.dart';
import '../models/dto/instrument_dto.dart';

class MarketsApi {
  final RestClient client;

  MarketsApi(this.client);

  Future<List<InstrumentDto>> fetchAll() async {
    final res = await client.get("/instruments");
    return (res['instruments'] as List)
        .map((j) => InstrumentDto.fromJson(j))
        .toList();
  }
}
EOF
cat > lib/core/markets/filter.dart << 'EOF'
import 'market_definitions.dart';

class MarketFilter {
  static List<Instrument> byType(List<Instrument> list, MarketType type) =>
      list.where((i) => i.type == type).toList();
}
EOF
cat > lib/features/market/presentation/screens/market_info_screen.dart << 'EOF'
import 'package:flutter/material.dart';

class MarketInfoScreen extends StatelessWidget {
  final String symbol;
  final String description;

  MarketInfoScreen(this.symbol, this.description);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(symbol)),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Text("Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø³ÙˆÙ‚: $description"),
      ),
    );
  }
}
EOF
cat > lib/features/analytics/domain/liquidity_analyzer.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class LiquidityAnalyzer {
  final List<CandleEntity> candles;

  LiquidityAnalyzer(this.candles);

  double averageRange() {
    return candles.fold(0, (sum, c) => sum + (c.high - c.low)) / candles.length;
  }

  double volatility() {
    return averageRange(); // ØªØ¨Ø³ÙŠØ·
  }
}
EOF
cat > lib/core/async/batch_computer.dart << 'EOF'
import 'dart:async';

class BatchComputer {
  Future<void> processInBatches<T>(
      List<T> items,
      Future<void> Function(T) action,
      {int batchSize = 1000}) async {
    for (var i = 0; i < items.length; i += batchSize) {
      final batch = items.sublist(i, i + batchSize);
      await Future.wait(batch.map(action));
    }
  }
}
EOF
cat > lib/core/performance/fps_monitor.dart << 'EOF'
import 'package:flutter/scheduler.dart';

class FPSMonitor {
  void start(void Function(int) callback) {
    int lastFrameTime = 0;
    SchedulerBinding.instance.addTimingsCallback((timings) {
      final frameTime = timings.first.totalSpan.inMilliseconds;
      final fps = frameTime == 0 ? 0 : (1000 / frameTime).round();
      callback(fps);
      lastFrameTime = frameTime;
    });
  }
}
EOF
cat > lib/features/trading/data/exchanges/crypto/crypto_api.dart << 'EOF'
import '../../../core/network/rest_client.dart';

class CryptoApi {
  final RestClient client;

  CryptoApi(this.client);

  Future<double> fetchPrice(String symbol) async {
    final res = await client.get("/crypto/$symbol/price");
    return double.parse(res['price']);
  }
}
EOF
cat > lib/features/trading/data/exchanges/stock/stock_api.dart << 'EOF'
import '../../../core/network/rest_client.dart';

class StockApi {
  final RestClient client;

  StockApi(this.client);

  Future<double> fetchQuote(String symbol) async {
    final res = await client.get("/stocks/$symbol/quote");
    return double.parse(res['quote']);
  }
}
EOF
cat > lib/core/time/time_zone_config.dart << 'EOF'
class TimeZoneConfig {
  static const Map<String, int> instrumentOffsets = {
    "BTC_USD": -4, // Ù…Ø«Ø§Ù„ EDT
    "EUR_USD": 0,  // UTC
    "AAPL": -5     // EST
  };

  static DateTime toLocal(String symbol, DateTime utc) {
    final offset = instrumentOffsets[symbol] ?? 0;
    return utc.add(Duration(hours: offset));
  }
}
EOF
cat > lib/features/market/presentation/bloc/auto_fetch_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../core/network/markets_api.dart';
import '../../../core/models/dto/instrument_dto.dart';

class AutoFetchBloc extends Bloc<void, List<InstrumentDto>> {
  final MarketsApi marketsApi;

  AutoFetchBloc(this.marketsApi) : super([]) {
    on((_, emit) async {
      final list = await marketsApi.fetchAll();
      emit(list);
    });
  }
}
EOF
cat > lib/core/markets/search_filter.dart << 'EOF'
import 'market_definitions.dart';

class MarketSearchFilter {
  static List<Instrument> search(List<Instrument> all, String q) {
    return all.where((i) => i.symbol.contains(q.toUpperCase())).toList();
  }

  static List<Instrument> sortByName(List<Instrument> all) {
    all.sort((a, b) => a.symbol.compareTo(b.symbol));
    return all;
  }
}
EOF
cat > lib/features/analytics/domain/risk_analyzer.dart << 'EOF'
import '../../../features/trading/domain/order/order.dart';

class RiskAnalyzer {
  final double accountSize;

  RiskAnalyzer(this.accountSize);

  double riskPerTrade(double stopLossPips) {
    return accountSize * (stopLossPips / 100);
  }

  double lotSize(double riskAmount, double pipValue) {
    return riskAmount / pipValue;
  }
}
EOF
cat > lib/features/trading/presentation/widgets/stop_take_input.dart << 'EOF'
import 'package:flutter/material.dart';

class StopTakeInput extends StatelessWidget {
  final Function(double, double) onApply;

  StopTakeInput({required this.onApply});

  @override
  Widget build(BuildContext context) {
    double sl = 0, tp = 0;
    return Column(
      children: [
        TextField(
          decoration: InputDecoration(labelText: "Stop Loss"),
          onChanged: (v) => sl = double.tryParse(v) ?? 0,
        ),
        TextField(
          decoration: InputDecoration(labelText: "Take Profit"),
          onChanged: (v) => tp = double.tryParse(v) ?? 0,
        ),
        ElevatedButton(
          child: Text("Apply"),
          onPressed: () => onApply(sl, tp),
        )
      ],
    );
  }
}
EOF
cat > assets/js/sl_tp_overlay.js << 'EOF'
function drawSLTP(slTime, slPrice, tpTime, tpPrice) {
  chart.createPriceLine({
    price: slPrice,
    color: 'red',
    lineWidth: 1,
    lineStyle: LightweightCharts.LineStyle.Dashed,
  });
  chart.createPriceLine({
    price: tpPrice,
    color: 'green',
    lineWidth: 1,
  });
}
EOF
cat > lib/features/trading/presentation/widgets/signals_panel.dart << 'EOF'
import 'package:flutter/material.dart';

class SignalsPanel extends StatelessWidget {
  final List<String> signals;

  SignalsPanel(this.signals);

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: signals.map((s) => Text(s, style: TextStyle(fontSize: 14))).toList(),
    );
  }
}
EOF
cat > lib/features/trading/presentation/widgets/trade_action_button.dart << 'EOF'
import 'package:flutter/material.dart';

class TradeActionButton extends StatelessWidget {
  final String action;
  final VoidCallback onTap;

  TradeActionButton({required this.action, required this.onTap});

  @override
  Widget build(BuildContext context) {
    final isBuy = action.toUpperCase() == "BUY";
    return ElevatedButton(
      style: ElevatedButton.styleFrom(
        backgroundColor: isBuy ? Colors.green : Colors.red,
      ),
      child: Text(action),
      onPressed: onTap,
    );
  }
}
EOF
cat > lib/features/settings/presentation/widgets/color_picker_tile.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_colorpicker/flutter_colorpicker.dart';

class ColorPickerTile extends StatelessWidget {
  final String title;
  final Color current;
  final ValueChanged<Color> onColorChanged;

  ColorPickerTile({
    required this.title,
    required this.current,
    required this.onColorChanged,
  });

  @override
  Widget build(BuildContext context) {
    return ListTile(
      title: Text(title),
      trailing: CircleAvatar(backgroundColor: current),
      onTap: () => showDialog(
        context: context,
        builder: (_) => AlertDialog(
          title: Text("Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†"),
          content: BlockPicker(
            pickerColor: current,
            onColorChanged: onColorChanged,
          ),
        ),
      ),
    );
  }
}
EOF
cat > lib/core/storage/indicator/indicator_settings_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class IndicatorSettingsStorageSP {
  static const _key = "indicatorSettings";

  static Future<void> save(String id, Map<String, dynamic> params) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(_key + id, jsonEncode(params));
  }

  static Future<Map<String, dynamic>?> load(String id) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(_key + id);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/init/app_initializer.dart << 'EOF'
import 'package:flutter/material.dart';
import '../storage/preferences.dart';
import '../storage/indicator/indicator_settings_storage.dart';

class AppInitializer {
  static Future<void> init() async {
    final isDark = await UserPreferences.loadTheme();
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø«ÙŠÙ…
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
  }
}
EOF
cat > lib/features/strategy/domain/dsl/strategy_dsl.dart << 'EOF'
class StrategyDSLParser {
  /// Ù…Ø«Ø§Ù„: "EMA50 > EMA150 AND RSI14 < 30"
  static List<String> tokenize(String expr) =>
      expr.split(RegExp(r"\s+")).toList();
}
EOF
cat > lib/features/strategy/presentation/widgets/strategy_dsl_editor.dart << 'EOF'
import 'package:flutter/material.dart';

class StrategyDslEditor extends StatefulWidget {
  final String initial;
  final ValueChanged<String> onChanged;

  StrategyDslEditor({required this.initial, required this.onChanged});

  @override
  _StrategyDslEditorState createState() => _StrategyDslEditorState();
}

class _StrategyDslEditorState extends State<StrategyDslEditor> {
  late TextEditingController _ctrl;

  @override
  void initState() {
    super.initState();
    _ctrl = TextEditingController(text: widget.initial);
  }

  @override
  Widget build(BuildContext context) {
    return TextField(
      controller: _ctrl,
      decoration: InputDecoration(labelText: "Strategy Expression"),
      onSubmitted: widget.onChanged,
    );
  }
}
EOF
cat > lib/core/export/csv_exporter.dart << 'EOF'
import 'dart:io';
import 'package:path_provider/path_provider.dart';

class CsvExporter {
  static Future<String> exportTrades(List<List<String>> rows) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File('${dir.path}/trades_export.csv');
    final sink = file.openWrite();
    for (var r in rows) sink.writeln(r.join(','));
    await sink.close();
    return file.path;
  }
}
EOF
cat > lib/core/integration/webhook_handler.dart << 'EOF'
typedef WebhookHandlerFunc = Future<void> Function(Map<String, dynamic>);

class WebhookHandler {
  final Map<String, WebhookHandlerFunc> handlers = {};

  void register(String event, WebhookHandlerFunc fn) => handlers[event] = fn;

  Future<void> handle(String event, Map<String, dynamic> body) async {
    if (handlers.containsKey(event)) await handlers[event]!(body);
  }
}
EOF
cat > lib/core/integration/telegram/telegram_bot.dart << 'EOF'
import 'package:telebot/telebot.dart';

class TelegramBot {
  final String token;
  final Telebot _bot;

  TelegramBot(this.token) : _bot = Telebot(token);

  void start() {
    _bot.start();
    _bot.onMessage((msg) {
      print("Telegram Msg: ${msg.text}");
    });
  }
}
EOF
cat > lib/core/export/pdf/pdf_report.dart << 'EOF'
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart';

class PdfReport {
  static Future<List<int>> generate(List<String> lines) async {
    final pdf = Document();
    pdf.addPage(Page(build: (_) {
      return Column(children: lines.map((l) => Text(l)).toList());
    }));
    return pdf.save();
  }
}
EOF
cat > lib/features/alerts/data/alert_preferences.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class AlertPreferences {
  static Future<void> save(String id, Map<String, dynamic> cfg) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("alert_$id", jsonEncode(cfg));
  }

  static Future<Map<String, dynamic>?> load(String id) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString("alert_$id");
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/sync/cloud/cloud_sync_service.dart << 'EOF'
import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
// ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ù€ Firebase/Backend Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§

class CloudSyncService {
  static Future<void> uploadUserSettings(Map<String, dynamic> settings) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("cloud_user_settings", jsonEncode(settings));
  }

  static Future<Map<String, dynamic>?> downloadUserSettings() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString("cloud_user_settings");
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/export/settings/json_settings_exporter.dart << 'EOF'
import 'dart:io';
import 'package:path_provider/path_provider.dart';

class JsonSettingsExporter {
  static Future<String> save(Map<String, dynamic> settings) async {
    final dir = await getApplicationDocumentsDirectory();
    final file = File('${dir.path}/settings_export.json');
    await file.writeAsString(settings.toString());
    return file.path;
  }

  static Future<Map<String, dynamic>> load(File file) async {
    final content = await file.readAsString();
    return Map<String, dynamic>.from(jsonDecode(content));
  }
}
EOF
cat > lib/core/notifications/firebase_messaging_service.dart << 'EOF'
import 'package:firebase_messaging/firebase_messaging.dart';

class FirebaseMessagingService {
  final FirebaseMessaging _fcm = FirebaseMessaging.instance;

  Future<void> init() async {
    await _fcm.requestPermission();
    FirebaseMessaging.onMessage.listen((msg) {
      // Handle foreground
    });
  }

  Future<String?> getToken() => _fcm.getToken();
}
EOF
cat > lib/core/integration/webhook_push_bridge.dart << 'EOF'
import '../notifications/firebase_messaging_service.dart';

class WebhookPushBridge {
  final FirebaseMessagingService fcm;

  WebhookPushBridge(this.fcm);

  Future<void> sendPushOnWebhook(Map<String, dynamic> body) async {
    final token = await fcm.getToken();
    if (token != null) {
      // ØªÙ†ÙÙŠØ° POST Ù„FCM API (Server Side)
    }
  }
}
EOF
cat > lib/core/telemetry/sentry_service.dart << 'EOF'
import 'package:sentry_flutter/sentry_flutter.dart';

class SentryService {
  static Future<void> init() async {
    await SentryFlutter.init(
      (options) => options.dsn = 'YOUR_SENTRY_DSN_HERE',
    );
  }
}
EOF
cat > lib/core/log/logger_service.dart << 'EOF'
import 'package:logger/logger.dart';

class LoggerService {
  static final Logger _logger = Logger();

  static void d(String msg) => _logger.d(msg);
  static void e(String msg, [dynamic err]) => _logger.e(msg, err);
  static void i(String msg) => _logger.i(msg);
}
EOF
cat > lib/features/strategy/domain/undo_redo_manager.dart << 'EOF'
class UndoRedoManager<T> {
  final List<T> _stack = [];
  int _pointer = -1;

  void add(T state) {
    _stack.removeRange(_pointer + 1, _stack.length);
    _stack.add(state);
    _pointer++;
  }

  T? undo() => _pointer > 0 ? _stack[--_pointer] : null;
  T? redo() => _pointer < _stack.length - 1 ? _stack[++_pointer] : null;
}
EOF
cat > lib/core/permissions/permission_manager.dart << 'EOF'
import 'package:permission_handler/permission_handler.dart';

class PermissionManager {
  static Future<bool> requestStorage() async {
    final status = await Permission.storage.request();
    return status.isGranted;
  }

  static Future<bool> requestNotifications() async {
    final status = await Permission.notification.request();
    return status.isGranted;
  }
}
EOF
cat > lib/core/storage/audit/event_audit_manager.dart << 'EOF'
import 'package:hive/hive.dart';

class EventAuditManager {
  static Future<void> log(String event) async {
    final box = await Hive.openBox('eventAudit');
    await box.add({'event': event, 'timestamp': DateTime.now().toIso8601String()});
  }

  static Future<List<Map>> getAll() async {
    final box = await Hive.openBox('eventAudit');
    return box.values.cast<Map>().toList();
  }
}
EOF
cat > lib/features/dashboard/presentation/dashboard_screen.dart << 'EOF'
import 'package:flutter/material.dart';

class DashboardScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          Text("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­"),
          Text("Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµÙÙ‚Ø§Øª"),
          Text("Ø£Ø¹Ù„Ù‰ Drawdown"),
        ],
      ),
    );
  }
}
EOF
cat > lib/features/replay/domain/replay_state.dart << 'EOF'
enum ReplayPlaybackState {
  idle,
  playing,
  paused,
  ended,
}
EOF
cat > lib/features/replay/domain/replay_engine.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

typedef ReplayTickCallback = void Function(CandleEntity);

class ReplayEngine {
  final List<CandleEntity> history;
  int _index = 0;
  bool _isPlaying = false;
  Duration _speedFactor = Duration(milliseconds: 500); // 2x real

  ReplayEngine(this.history);

  void play(ReplayTickCallback onTick) async {
    _isPlaying = true;
    while (_isPlaying && _index < history.length) {
      onTick(history[_index]);
      await Future.delayed(_speedFactor);
      _index++;
    }
  }

  void pause() => _isPlaying = false;

  void resume(ReplayTickCallback onTick) => play(onTick);

  void stop() {
    _isPlaying = false;
    _index = 0;
  }

  void setSpeed(double factor) {
    _speedFactor = Duration(milliseconds: (1000 / factor).round());
  }
}
EOF
cat > lib/features/replay/presentation/bloc/replay_event.dart << 'EOF'
abstract class ReplayEvent {}
class StartReplay extends ReplayEvent {
  final DateTime from;
  final DateTime to;
  final double speed;

  StartReplay({required this.from, required this.to, this.speed = 1});
}
class PauseReplay extends ReplayEvent {}
class ResumeReplay extends ReplayEvent {}
class StopReplay extends ReplayEvent {}
EOF
cat > lib/features/replay/presentation/bloc/replay_state.dart << 'EOF'
import '../../../domain/replay_state.dart';

abstract class ReplayStatus {}
class ReplayIdle extends ReplayStatus {}
class ReplayPlaying extends ReplayStatus {}
class ReplayPaused extends ReplayStatus {}
class ReplayEnded extends ReplayStatus {}
EOF
cat > lib/features/replay/presentation/bloc/replay_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'replay_event.dart';
import 'replay_state.dart';
import '../../../domain/replay_engine.dart';
import '../../../domain/replay_state.dart';

class ReplayBloc extends Bloc<ReplayEvent, ReplayStatus> {
  ReplayEngine? engine;

  ReplayBloc() : super(ReplayIdle()) {
    on<StartReplay>(_onStart);
    on<PauseReplay>((_, emit) => emit(ReplayPaused()));
    on<ResumeReplay>((_, emit) => emit(ReplayPlaying()));
    on<StopReplay>((_, emit) => emit(ReplayEnded()));
  }

  void _onStart(StartReplay event, Emitter<ReplayStatus> emit) async {
    // load history from repo
    engine = ReplayEngine([]);
    engine!.setSpeed(event.speed);
    emit(ReplayPlaying());
    engine!.play((c) {
      // dispatch to chart Bloc
    });
  }
}
EOF
cat > lib/features/replay/presentation/widgets/replay_controls.dart << 'EOF'
import 'package:flutter/material.dart';

class ReplayControls extends StatelessWidget {
  final VoidCallback onPlay;
  final VoidCallback onPause;
  final VoidCallback onStop;

  ReplayControls({
    required this.onPlay,
    required this.onPause,
    required this.onStop,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        IconButton(icon: Icon(Icons.play_arrow), onPressed: onPlay),
        IconButton(icon: Icon(Icons.pause), onPressed: onPause),
        IconButton(icon: Icon(Icons.stop), onPressed: onStop),
      ],
    );
  }
}
EOF
cat > lib/features/market_depth/domain/order_book.dart << 'EOF'
class OrderBookLevel {
  final double price;
  final double volume;
  OrderBookLevel(this.price, this.volume);
}

class OrderBook {
  final List<OrderBookLevel> bids;
  final List<OrderBookLevel> asks;

  OrderBook({required this.bids, required this.asks});
}
EOF
cat > lib/features/market_depth/data/order_book_ws.dart << 'EOF'
import '../../../core/network/ws_manager.dart';
import '../domain/order_book.dart';

class OrderBookWs {
  final WSManager ws;
  OrderBookWs(this.ws);

  void listen(void Function(OrderBook) onUpdate) {
    ws.stream.listen((data) {
      final bids = <OrderBookLevel>[];
      final asks = <OrderBookLevel>[];
      for (var b in data['bids']) {
        bids.add(OrderBookLevel(b[0], b[1]));
      }
      for (var a in data['asks']) {
        asks.add(OrderBookLevel(a[0], a[1]));
      }
      onUpdate(OrderBook(bids: bids, asks: asks));
    });
  }
}
EOF
cat > lib/features/market_depth/presentation/widgets/order_book_view.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../domain/order_book.dart';

class OrderBookView extends StatelessWidget {
  final OrderBook book;
  OrderBookView(this.book);

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Expanded(child: ListView(
          children: book.bids.map((l) => Text("Bid ${l.price}: ${l.volume}")).toList(),
        )),
        Expanded(child: ListView(
          children: book.asks.map((l) => Text("Ask ${l.price}: ${l.volume}")).toList(),
        )),
      ],
    );
  }
}
EOF
cat > lib/features/market_depth/presentation/bloc/order_book_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../domain/order_book.dart';

abstract class OrderBookEvent {}
class OrderBookUpdate extends OrderBookEvent {
  final OrderBook book;
  OrderBookUpdate(this.book);
}

abstract class OrderBookState {}
class OrderBookInitial extends OrderBookState {}
class OrderBookLoaded extends OrderBookState {
  final OrderBook book;
  OrderBookLoaded(this.book);
}

class OrderBookBloc extends Bloc<OrderBookEvent, OrderBookState> {
  OrderBookBloc(): super(OrderBookInitial()) {
    on<OrderBookUpdate>((evt, emit) => emit(OrderBookLoaded(evt.book)));
  }
}
EOF
cat > lib/features/tape/domain/tape_event.dart << 'EOF'
class TapeEvent {
  final double price;
  final double volume;
  final DateTime time;
  final String side; // buy/sell

  TapeEvent(this.price, this.volume, this.time, this.side);
}
EOF
cat > lib/features/tape/presentation/widgets/tape_view.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../domain/tape_event.dart';

class TapeView extends StatelessWidget {
  final List<TapeEvent> events;
  TapeView(this.events);

  @override
  Widget build(BuildContext context) {
    return ListView(
      children: events.map((e) =>
        ListTile(
          title: Text("${e.price} (${e.side})"),
          trailing: Text("${e.volume}"),
          subtitle: Text("${e.time.toIso8601String()}"),
        )).toList(),
    );
  }
}
EOF
cat > lib/features/indicators/plugins/vwap_plugin.dart << 'EOF'
import '../../engine/indicator_engine.dart';
import '../../../../core/models/candle_entity.dart';

class VWAPPlugin implements IndicatorPlugin {
  @override
  Map<String, double> compute(List<CandleEntity> candles) {
    double cumulPV = 0, cumulVol = 0;
    for (var c in candles) {
      final typical = (c.high + c.low + c.close) / 3;
      cumulPV += typical * c.volume;
      cumulVol += c.volume;
    }
    final vwap = cumulVol == 0 ? 0 : cumulPV / cumulVol;
    return {'VWAP': vwap};
  }
}
EOF
cat > lib/features/trading/domain/order/advanced_order.dart << 'EOF'
enum OrderType { market, limit, stop, stopLimit }

class AdvancedOrder {
  final String id;
  final String symbol;
  final OrderType type;
  final double price;
  final double stopPrice;
  final double lots;

  AdvancedOrder({
    required this.id,
    required this.symbol,
    this.type = OrderType.market,
    this.price = 0,
    this.stopPrice = 0,
    required this.lots,
  });
}
EOF
cat > lib/features/trading/domain/order/oco_order.dart << 'EOF'
class OCOOrder {
  final AdvancedOrder primary;
  final AdvancedOrder secondary;

  OCOOrder(this.primary, this.secondary);
}
EOF
cat > lib/features/trading/domain/order/oco_execution_engine.dart << 'EOF'
import 'oco_order.dart';

class OCOExecutionEngine {
  void submit(OCOOrder oco) {
    // if primary fills -> cancel secondary
  }
}
EOF
cat > lib/features/trading/domain/hedging/hedge_manager.dart << 'EOF'
class HedgeManager {
  bool shouldHedge(double exposure, double threshold) {
    return exposure.abs() > threshold;
  }
}
EOF
cat > lib/features/trading/domain/risk/position_sizing.dart << 'EOF'
double calculateLotSize({
  required double riskPercent,
  required double accountBalance,
  required double stopLossPips,
  required double pipValue,
}) {
  final riskAmt = accountBalance * (riskPercent / 100);
  return riskAmt / (stopLossPips * pipValue);
}
EOF
cat > lib/features/trading/domain/order/fee_model.dart << 'EOF'
class FeeModel {
  final double commissionPerLot;
  final double spreadCost;

  FeeModel(this.commissionPerLot, this.spreadCost);

  double totalCost(double lots) =>
      commissionPerLot * lots + spreadCost * lots;
}
EOF
cat > lib/features/trading/domain/order/execution_with_fees.dart << 'EOF'
import 'fee_model.dart';
import 'order.dart';

class ExecutionWithFees {
  final FeeModel feeModel;

  ExecutionWithFees(this.feeModel);

  double netPnL(double grossPnL, double lots) {
    final cost = feeModel.totalCost(lots);
    return grossPnL - cost;
  }
}
EOF
cat > lib/core/network/ws/ws_channel_manager.dart << 'EOF'
import 'package:web_socket_channel/web_socket_channel.dart';

class WSChannelManager {
  WebSocketChannel? _channel;
  String? _currentSymbol;

  WebSocketChannel? get channel => _channel;

  void connectForSymbol(String symbol, String url) {
    if (_currentSymbol == symbol) {
      return; // Already connected for same
    }
    _disconnect();
    _currentSymbol = symbol;
    _channel = WebSocketChannel.connect(Uri.parse("$url?symbol=$symbol"));
  }

  void _disconnect() {
    _channel?.sink.close();
    _channel = null;
    _currentSymbol = null;
  }

  void dispose() => _disconnect();
}
EOF
cat > lib/features/replay/domain/replay_engine2.dart << 'EOF'
import '../../../core/models/tick_entity.dart';
import '../../../core/models/candle_entity.dart';

typedef ReplayTickCb = void Function(TickEntity);
typedef ReplayCandleCb = void Function(CandleEntity);

class ReplayEngine2 {
  final List<TickEntity> ticks;
  final List<CandleEntity> candles;
  int _tickIdx = 0;
  int _candleIdx = 0;
  bool _playing = false;

  ReplayEngine2(this.ticks, this.candles);

  void play({required ReplayTickCb onTick, required ReplayCandleCb onCandle}) async {
    _playing = true;
    while (_playing &&
           (_tickIdx < ticks.length || _candleIdx < candles.length)) {
      if (_tickIdx < ticks.length) {
        onTick(ticks[_tickIdx++]);
      }
      if (_candleIdx < candles.length) {
        onCandle(candles[_candleIdx++]);
      }
      await Future.delayed(Duration(milliseconds: 200));
    }
  }

  void stop() => _playing = false;
}
EOF
cat > lib/features/indicators/engine/zoom_sensitive_engine_fix.dart << 'EOF'
import '../../../core/models/candle_entity.dart';
import 'indicator_engine.dart';

class ZoomSensitiveEngineFix extends IndicatorEngine {
  ZoomSensitiveEngineFix(super.plugins);

  Map<String, double> calculateInRange(
      List<CandleEntity> all, DateTime from, DateTime to) {
    final visible = all.where((c) =>
      !c.timeUtc.isBefore(from) && !c.timeUtc.isAfter(to)
    ).toList();
    final result = super.calculate(visible);
    return result;
  }
}
EOF
cat > lib/core/storage/indicator/indicator_settings_storage2.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class IndicatorSettingsStorage2 {
  static Future<void> save(String id, Map<String, dynamic> params) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "indicator_settings_$id";
    prefs.setString(key, jsonEncode(params));
  }

  static Future<Map<String, dynamic>?> load(String id) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "indicator_settings_$id";
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/storage/audit/event_audit_manager2.dart << 'EOF'
import 'package:hive/hive.dart';

class EventAuditManager2 {
  static Box? _box;

  static Future<Box> _openBox() async {
    if (_box != null && _box!.isOpen) return _box!;
    _box = await Hive.openBox('eventAudit');
    return _box!;
  }

  static Future<void> log(String event) async {
    final b = await _openBox();
    await b.add({'event': event, 'timestamp': DateTime.now().toIso8601String()});
  }

  static Future<List<Map>> getAll() async {
    final b = await _openBox();
    return b.values.cast<Map>().toList();
  }
}
EOF
cat > lib/features/indicators/engine/windowed_engine.dart << 'EOF'
import '../../../core/models/candle_entity.dart';
import 'indicator_engine.dart';

class WindowedIndicatorEngine extends IndicatorEngine {
  WindowedIndicatorEngine(super.plugins);

  @override
  Map<String, double> calculate(List<CandleEntity> candles) {
    final windowSize = 500; // Ø¢Ø®Ø± 500 Ø´Ù…Ø¹Ø© ÙÙ‚Ø·
    final subset = candles.length > windowSize
        ? candles.sublist(candles.length - windowSize)
        : candles;
    return super.calculate(subset);
  }
}
EOF
cat > lib/features/chart/domain/drawing_storage.dart << 'EOF'
import 'package:hive/hive.dart';

class DrawingStorage {
  static Box? _box;

  static Future<Box> _getBox() async =>
      _box ??= await Hive.openBox('drawings');

  static Future<void> saveDrawing(String key, Map data) async {
    final b = await _getBox();
    await b.put(key, data);
  }

  static Future<Map?> loadDrawing(String key) async {
    final b = await _getBox();
    return b.get(key)?.cast<String, dynamic>();
  }
}
EOF
cat > lib/features/backtest/domain/backtest_engine2.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class BacktestEngine2 {
  final List<CandleEntity> history;
  final StrategyEngine strategy;

  BacktestEngine2(this.history, this.strategy);

  void run() {
    Map<String, double> lastIndicators = {};

    for (int i = 0; i < history.length; i++) {
      final candle = history[i];
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø£ÙˆÙ„Ø§
      lastIndicators = calculateIndicators(history.sublist(0, i + 1));
      final signals = strategy.evaluateSignals(lastIndicators);

      // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
      for (final s in signals) {
        executeSignal(s, candle);
      }
    }
  }
}
EOF
cat > lib/features/strategy/domain/dsl/strategy_dsl_validator.dart << 'EOF'
class StrategyDslValidator {
  static bool isValid(List<String> tokens) {
    if (tokens.isEmpty) return false;
    final ops = ['>', '<', '>=', '<=', 'AND', 'OR'];
    // Ø¨Ø³ÙŠØ· Ø¬Ø¯Ù‹Ø§: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ Operator Ø£Ùˆ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù‡
    if (ops.contains(tokens.first) || ops.contains(tokens.last)) return false;
    return true;
  }
}
EOF
cat > lib/core/time/market_hours_filter.dart << 'EOF'
class MarketHoursFilter {
  static bool isMarketOpen(DateTime timeUtc) {
    final weekday = timeUtc.weekday;
    final hour = timeUtc.hour;
    // Ø£Ù…Ø«Ù„Ø© (Forex): Ù…Ù† Ø§Ù„Ø£Ø­Ø¯ 22:00 Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù…Ø¹Ø© 22:00 UTC
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) return false;
    if (hour < 22 && weekday == DateTime.sunday) return false;
    return true;
  }
}
EOF
cat > lib/features/market/presentation/widgets/chart_screen_lifecycle_fix.dart << 'EOF'
import 'package:flutter/material.dart';
import 'chart_widget.dart';
import 'package:webview_flutter/webview_flutter.dart';

class ChartScreen extends StatefulWidget {
  @override
  _ChartScreenState createState() => _ChartScreenState();
}

class _ChartScreenState extends State<ChartScreen> {
  WebViewController? _controller;

  @override
  void dispose() {
    _controller = null; // ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù€GC Ø¨Ø¥Ù†Ù‡Ø§Ø¡ WebView
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return WebView(
      onWebViewCreated: (ctrl) => _controller = ctrl,
      initialUrl: "about:blank",
    );
  }
}
EOF
cat > lib/core/navigation/back_handler.dart << 'EOF'
import 'package:flutter/material.dart';

class BackHandler extends StatelessWidget {
  final Widget child;
  final VoidCallback onBack;

  BackHandler({required this.child, required this.onBack});

  @override
  Widget build(BuildContext context) {
    return WillPopScope(
      onWillPop: () async {
        onBack();
        return false;
      },
      child: child,
    );
  }
}
EOF
cat > lib/core/state/event_queue.dart << 'EOF'
import 'dart:async';

class EventQueue<T> {
  final _queue = StreamController<T>();
  bool _processing = false;

  void add(T event) {
    _queue.add(event);
    if (!_processing) _process();
  }

  void _process() async {
    _processing = true;
    await for (final e in _queue.stream) {
      // ÙŠÙ…Ø±Ù‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ù€ Bloc Ø£Ùˆ Handler Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    }
    _processing = false;
  }

  void dispose() => _queue.close();
}
EOF
cat > lib/features/settings/data/chart_settings_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ChartSettingsStorage {
  static const key = "chart_settings";

  static Future<void> save(Map<String, dynamic> cfg) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(cfg));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/features/replay/domain/replay_scheduler.dart << 'EOF'
import 'dart:async';

class ReplayScheduler {
  Timer? _replayTimer;

  void start(void Function() onTick, Duration interval) {
    stop();
    _replayTimer = Timer.periodic(interval, (_) => onTick());
  }

  void stop() {
    _replayTimer?.cancel();
    _replayTimer = null;
  }
}
EOF
cat > lib/core/network/network_observer.dart << 'EOF'
import 'dart:async';
import 'package:connectivity_plus/connectivity_plus.dart';

enum NetState { online, offline }

class NetworkObserver {
  final _controller = StreamController<NetState>.broadcast();

  NetworkObserver() {
    Connectivity().onConnectivityChanged.listen((status) {
      _controller.add(status == ConnectivityResult.none
        ? NetState.offline : NetState.online);
    });
  }

  Stream<NetState> get stream => _controller.stream;
}
EOF
cat > lib/core/storage/safe_restore.dart << 'EOF'
import 'package:hive/hive.dart';

Future<void> safeRestore(String boxName) async {
  try {
    await Hive.openBox(boxName);
  } catch (err) {
    await Hive.deleteBoxFromDisk(boxName);
    await Hive.openBox(boxName);
  }
}
EOF
cat > lib/features/market/presentation/bloc/market_sync_bloc_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../repository/market_repository.dart';

class MarketSyncBloc extends Cubit<bool> {
  final MarketRepository repo;

  MarketSyncBloc(this.repo) : super(false);

  Future<void> init(String symbol, String timeframe) async {
    await repo.getCandles(symbol, timeframe);
    emit(true); // Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø« Ø§Ù„Ù„Ø­Ø¸ÙŠ
  }
}
EOF
cat > lib/core/webview/js_error_filter.js << 'EOF'
window.onerror = function(message, source, lineno, colno, error) {
  if (message.includes('ResizeObserver')) return true;
  return false;
};
EOF
cat > lib/core/lifecycle/app_lifecycle_observer.dart << 'EOF'
import 'package:flutter/widgets.dart';

class AppLifecycleObserver extends WidgetsBindingObserver {
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.detached ||
        state == AppLifecycleState.inactive) {
      // Ù‡Ù†Ø§ Ù‚Ù… Ø¨Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (WebSockets, Streams, Timers)
    }
  }
}
EOF
cat > lib/core/storage/audit/event_audit_manager3.dart << 'EOF'
import 'package:hive/hive.dart';

class EventAuditManager3 {
  static Box? _box;

  static Future<Box> _openBox() async {
    if (_box != null && _box!.isOpen) return _box!;
    _box = await Hive.openBox('eventAudit');
    return _box!;
  }

  static Future<void> log(String event) async {
    final box = await _openBox();
    final timestamp = DateTime.now().toUtc().toIso8601String();
    await box.add({'event': event, 'timestamp': timestamp});
  }

  static Future<List<Map>> getAllSorted() async {
    final box = await _openBox();
    final values = box.values.cast<Map>().toList();
    values.sort((a, b) => a['timestamp'].compareTo(b['timestamp']));
    return values;
  }
}
EOF
cat > lib/core/audio/alert_sound_singleton.dart << 'EOF'
import 'package:audioplayers/audioplayers.dart';

class AlertSoundManager {
  static final AlertSoundManager _instance = AlertSoundManager._internal();
  factory AlertSoundManager() => _instance;

  final AudioPlayer _player = AudioPlayer();

  AlertSoundManager._internal();

  Future<void> playBuy() => _player.play(AssetSource('audio/buy.mp3'));
  Future<void> playSell() => _player.play(AssetSource('audio/sell.mp3'));
}
EOF
cat > lib/features/trading/domain/sl_tp_settings.dart << 'EOF'
class SLTPSettings {
  double stopLoss = 0;
  double takeProfit = 0;

  void update(double sl, double tp) {
    stopLoss = sl;
    takeProfit = tp;
  }
}
EOF
cat > lib/core/webview/js_batch_update.js << 'EOF'
function batchUpdate(seriesData) {
  const chunkSize = 500;
  for (let i = 0; i < seriesData.length; i += chunkSize) {
    setTimeout(() => {
      chart.series[0].setData(seriesData.slice(i, i + chunkSize));
    }, i / chunkSize);
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_bloc_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

class ChartBlocFix extends Bloc<ChartEvent, ChartState> {
  List<CandleEntity> _candles = [];

  ChartBlocFix() : super(ChartIdle()) {
    on<LoadChartHistory>((evt, emit) {
      _candles = evt.candles;
      emit(ChartLoaded(_candles, evt.from, evt.to));
    });

    on<ClearChart>((_, emit) {
      _candles.clear();
      emit(ChartIdle());
    });
  }
}
EOF
cat > lib/features/trading/domain/history/trade_history_fix.dart << 'EOF'
import '../order/order.dart';
import '../../../../../core/storage/audit/event_audit_manager3.dart';

class TradeHistoryFix {
  static void recordUpdate(Order order, String note) {
    EventAuditManager3.log("TradeUpdate: ${order.id} | $note");
  }
}
EOF
cat > lib/features/indicators/domain/indicator_update_lock.dart << 'EOF'
import 'dart:async';

class IndicatorUpdateLock {
  bool _busy = false;

  Future<void> run(Future<void> Function() action) async {
    if (_busy) return;
    _busy = true;
    await action();
    _busy = false;
  }
}
EOF
cat > lib/features/market/data/repository/history_paging.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';
import '../../../domain/repository/market_repository.dart';

class HistoryPaging {
  final MarketRepository repo;

  HistoryPaging(this.repo);

  Future<List<CandleEntity>> fetchAll(
      String symbol, String timeframe) async {
    List<CandleEntity> all = [];
    int page = 0;
    while (true) {
      final chunk = await repo.fetchHistoryPage(symbol, timeframe, page++);
      if (chunk.isEmpty) break;
      all.addAll(chunk);
    }
    return all;
  }
}
EOF
cat > lib/features/strategy/domain/dsl/strategy_dsl_safety.dart << 'EOF'
class StrategyDslSafety {
  static bool hasEnoughTokens(List<String> tokens) {
    return tokens.length >= 3;
  }
}
EOF
cat > lib/core/state/debounce_helper.dart << 'EOF'
import 'dart:async';

class DebounceHelper<T> {
  final Duration delay;
  Timer? _timer;
  void Function(T)? _action;

  DebounceHelper(this.delay);

  void call(T value, void Function(T) action) {
    _action = action;
    _timer?.cancel();
    _timer = Timer(delay, () => action(value));
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/timeframe_stream_fix.dart << 'EOF'
import 'dart:async';

class TimeframeStreamFix {
  StreamSubscription? _sub;

  void subscribe(Stream stream, Function onData) {
    _sub?.cancel(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
    _sub = stream.listen((data) => onData(data));
  }

  void dispose() {
    _sub?.cancel();
    _sub = null;
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/history_cache_fix.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

class HistoryCacheFix {
  List<CandleEntity>? _lastCache;

  List<CandleEntity>? get cached => _lastCache;

  void save(List<CandleEntity> data) {
    _lastCache = data;
  }

  void clear() {
    _lastCache = null;
  }
}
EOF
cat > lib/features/market/data/repository/instant_first_candle_fix.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';
import '../local/candle_dao.dart';

class InstantFirstCandleFix {
  final CandleDao dao;
  InstantFirstCandleFix(this.dao);

  Future<CandleEntity?> getLastKnown(String symbol, String tf) async {
    return await dao.getLastCandle(symbol, tf);
  }
}
EOF
cat > lib/features/market_depth/domain/order_book_safe.dart << 'EOF'
import 'order_book.dart';

class OrderBookSafe {
  static OrderBook empty() =>
      OrderBook(bids: const [], asks: const []);
}
EOF
cat > lib/features/replay/domain/replay_scheduler_fix.dart << 'EOF'
import 'dart:async';

class ReplaySchedulerFix {
  Timer? _timer;

  void start(void Function() cb, Duration interval) {
    stop();
    _timer = Timer.periodic(interval, (_) => cb());
  }

  void stop() {
    _timer?.cancel();
    _timer = null;
  }
}
EOF
cat > lib/features/chart/data/view_state_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ViewStateStorage {
  static const key = "chart_view_state";

  static Future<void> save(Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/state/mode_mutex.dart << 'EOF'
class ModeMutex {
  bool _replayActive = false;

  bool get canStartLive => !_replayActive;

  void startReplay() => _replayActive = true;
  void stopReplay() => _replayActive = false;
}
EOF
cat > lib/core/time/time_formatter.dart << 'EOF'
class TimeFormatter {
  static String format(DateTime utc) {
    return utc.toLocal().toIso8601String();
  }
}
EOF
cat > lib/features/indicators/engine/plugin_manager_fix.dart << 'EOF'
import 'indicator_engine.dart';

class PluginManagerFix {
  final List<IndicatorPlugin> _plugins = [];

  void add(IndicatorPlugin p) => _plugins.add(p);

  void remove(IndicatorPlugin p) => _plugins.remove(p);

  void clear() => _plugins.clear();

  List<IndicatorPlugin> get active => List.unmodifiable(_plugins);
}
EOF
cat > lib/core/network/ws/ws_disconnect_on_offline.dart << 'EOF'
import 'ws_channel_manager.dart';
import '../network_observer.dart';

class WsDisconnectOnOffline {
  final WSChannelManager manager;
  final NetworkObserver observer;

  WsDisconnectOnOffline(this.manager, this.observer) {
    observer.stream.listen((state) {
      if (state == NetState.offline) {
        manager.dispose();
      }
    });
  }
}
EOF
cat > lib/features/backtest/domain/backtest_cancel_token.dart << 'EOF'
class BacktestCancelToken {
  bool _cancelled = false;
  void cancel() => _cancelled = true;
  bool get isCancelled => _cancelled;
}
EOF
cat > lib/core/network/rest_error.dart << 'EOF'
class RestError implements Exception {
  final String message;
  RestError(this.message);
}
EOF
cat > lib/features/market/data/repository/market_repository_error_fix.dart << 'EOF'
import '../../../../core/network/rest_error.dart';

Future<List<CandleEntity>> safeGetCandles(...) async {
  try {
    return await _fetchRemote(...);
  } catch (e) {
    throw RestError("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: $e");
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_bloc_error_handling.dart << 'EOF'
on<LoadChartHistory>((evt, emit) async {
  try {
    final candles = await repo.getCandles(...);
    emit(ChartLoaded(candles, evt.from, evt.to));
  } catch (e) {
    if (e is RestError) {
      emit(ChartError(e.message));
    } else {
      emit(ChartError("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹"));
    }
  }
});
EOF
cat > lib/features/chart/domain/draw_mode_flag.dart << 'EOF'
class DrawModeFlag {
  bool _active = false;
  void enable() => _active = true;
  void disable() => _active = false;
  bool get isActive => _active;
}
EOF
cat > lib/core/models/price/spread_fix.dart << 'EOF'
class SpreadCalculator {
  static double forBuy(double ask, double bid) => ask - bid;
  static double forSell(double bid, double ask) => bid - ask;
}
EOF
cat > lib/features/indicators/plugins/rsi_plugin_fix.dart << 'EOF'
Map<String, double> compute(...) {
  if (candles.length < period) {
    return {"RSI$period": 0.0};
  }
  // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
}
EOF
cat > lib/core/navigation/router_observer_fix.dart << 'EOF'
import 'package:flutter/widgets.dart';

class RouterObserverFix extends RouteObserver<PageRoute<dynamic>> {
  @override
  void didPop(Route route, Route? previousRoute) {
    // Ø¥ÙŠÙ‚Ø§Ù Replay / Streams
  }

  @override
  void didPush(Route route, Route? previousRoute) {
    // Ù…Ù…Ø§Ø«Ù„
  }
}
EOF
cat > lib/core/streams/symbol_stream_guard.dart << 'EOF'
import 'dart:async';

class SymbolStreamGuard {
  StreamSubscription? _sub;

  void bind(Stream stream, void Function(dynamic) onData) {
    _sub?.cancel(); // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯Ø§Ø¦Ù…Ù‹Ø§
    _sub = stream.listen(onData);
  }

  void dispose() {
    _sub?.cancel();
    _sub = null;
  }
}
EOF
cat > lib/features/market/data/repository/boot_history_restore_fix.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';
import '../local/candle_dao.dart';

class BootHistoryRestoreFix {
  final CandleDao dao;
  BootHistoryRestoreFix(this.dao);

  Future<List<CandleEntity>> restoreOnBoot(String symbol, String tf) async {
    final cached = await dao.getAll(symbol, tf);
    return cached.isEmpty ? [] : cached;
  }
}
EOF
cat > lib/core/compute/async_loader_fix.dart << 'EOF'
import 'dart:isolate';

Future<T> runInIsolate<T>(T Function() fn) async {
  return await Isolate.run(fn);
}
EOF
cat > lib/core/network/ws/ws_timeframe_guard.dart << 'EOF'
import 'ws_channel_manager.dart';

class WsTimeframeGuard {
  final WSChannelManager manager;

  WsTimeframeGuard(this.manager);

  void switchTimeframe(String newSymbol, String url) {
    manager.dispose(); // Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ø§ØªØµØ§Ù„ Ø³Ø§Ø¨Ù‚
    manager.connectForSymbol(newSymbol, url);
  }
}
EOF
cat > lib/features/replay/domain/replay_engine_cleanup_fix.dart << 'EOF'
class ReplayEngineCleanupFix {
  bool _playing = false;

  void stop() {
    _playing = false;
  }

  bool get isPlaying => _playing;
}
EOF
cat > lib/features/chart/domain/touch_mode_guard.dart << 'EOF'
class TouchModeGuard {
  bool drawing = false;

  bool allowWebViewGesture() => !drawing;
}
EOF
cat > lib/features/indicators/domain/indicator_queue_fix.dart << 'EOF'
import 'dart:async';

class IndicatorQueueFix {
  final _queue = StreamController<void>();

  void enqueue(void Function() task) {
    _queue.add(null);
    task();
  }

  void dispose() {
    _queue.close();
  }
}
EOF
cat > lib/features/chart/data/orientation_state_fix.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class OrientationStateFix {
  static const key = "chart_orientation_state";

  static Future<void> save(Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/storage/hive_cleanup_fix.dart << 'EOF'
import 'package:hive/hive.dart';

Future<void> closeAllHiveBoxes() async {
  for (var box in Hive.boxes.values) {
    if (box.isOpen) {
      await box.close();
    }
  }
}
EOF
cat > lib/features/backtest/domain/backtest_cancel_guard.dart << 'EOF'
class BacktestCancelGuard {
  bool _cancel = false;

  void cancel() => _cancel = true;
  bool get cancelled => _cancel;
}
EOF
cat > lib/features/indicators/domain/indicator_cache_cleanup.dart << 'EOF'
class IndicatorCacheCleanup {
  static void clearCache(Map<String, double> cache) {
    cache.clear();
  }
}
EOF
cat > lib/core/compute/backtest_save_isolate.dart << 'EOF'
import 'dart:isolate';

Future<void> saveBacktestInIsolate(Function saveFn) async {
  await Isolate.run(saveFn);
}
EOF
cat > lib/core/storage/audit/audit_flush_on_error.dart << 'EOF'
import 'event_audit_manager3.dart';

Future<void> flushAuditOnError() async {
  final events = await EventAuditManager3.getAllSorted();
  for (var e in events) {
    //  Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
  }
}
EOF
cat > lib/core/webview/js_sl_tp_fix.js << 'EOF'
function drawSLTPWhenReady(sl, tp) {
  if (!window.chart) {
    setTimeout(() => drawSLTPWhenReady(sl, tp), 50);
    return;
  }
  drawSLTP(sl, tp);
}
EOF
cat > lib/features/market/data/repository/history_refresh_fix.dart << 'EOF'
Future<List<CandleEntity>> refreshHistory(
    String symbol, String timeframe) async {
  await cache.clear();  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  return await repo.getCandles(symbol, timeframe);
}
EOF
cat > lib/features/backtest/presentation/bloc/backtest_control_fix.dart << 'EOF'
class BacktestControlFix {
  bool _isRunning = false;

  bool startIfNotRunning(Function startFn) {
    if (_isRunning) return false;
    _isRunning = true;
    startFn();
    return true;
  }

  void done() => _isRunning = false;
}
EOF
cat > lib/features/market/presentation/bloc/timeframe_loading_fix.dart << 'EOF'
class TimeframeLoadingFix {
  bool _loading = false;

  Future<void> loadIfNotLoading(Future<void> Function() loadFn) async {
    if (_loading) return;
    _loading = true;
    await loadFn();
    _loading = false;
  }
}
EOF
cat > lib/core/time/market_hours_filter_fix.dart << 'EOF'
class MarketHoursFilterFix {
  static bool isMarketOpen(DateTime t) {
    final utc = t.toUtc();
    final weekday = utc.weekday;
    // Forex example:
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) {
      return false;
    }
    return true;
  }
}
EOF
cat > lib/features/alerts/data/alert_persistence_fix.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class AlertPersistenceFix {
  static Future<void> save(String key, Map cfg) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("alert_cfg_$key", jsonEncode(cfg));
  }

  static Future<Map?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString("alert_cfg_$key");
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/state/bloc_close_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

mixin BlocCloseFix on BlocBase {
  @override
  Future<void> close() async {
    await super.close();
  }
}
EOF
cat > lib/core/storage/sync/preferences_write_lock.dart << 'EOF'
import 'dart:async';

class PreferencesWriteLock {
  Completer<void>? _lock;

  Future<void> synchronized(Future<void> Function() fn) async {
    while (_lock != null) {
      await _lock!.future;
    }
    _lock = Completer<void>();
    await fn();
    _lock!.complete();
    _lock = null;
  }
}
EOF
cat > lib/core/network/ws/parsers/tick_parser_fix.dart << 'EOF'
Map<String, dynamic>? safeParse(dynamic data) {
  try {
    if (data == null || data['price'] == null) return null;
    return data as Map<String, dynamic>;
  } catch (_) {
    return null;
  }
}
EOF
cat > lib/features/indicators/domain/visible_synchronizer_fix.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class VisibleSynchronizerFix {
  List<CandleEntity> sync(
      List<CandleEntity> all, DateTime from, DateTime to) {
    return all.where((c) =>
        !c.timeUtc.isBefore(from) && !c.timeUtc.isAfter(to)).toList();
  }
}
EOF
cat > lib/features/strategy/domain/strategy_engine_cleanup_fix.dart << 'EOF'
class StrategyEngineCleanupFix {
  void clearCache(Map<String, double> cache) => cache.clear();
}
EOF
cat > lib/features/strategy/domain/dsl/strategy_dsl_safe_eval.dart << 'EOF'
import 'strategy_dsl_validator.dart';
import 'strategy_dsl_safety.dart';

bool safeEval(String expr) {
  final tokens = expr.split(RegExp(r"\s+"));
  if (!StrategyDslValidator.isValid(tokens)) return false;
  if (!StrategyDslSafety.hasEnoughTokens(tokens)) return false;
  return true;
}
EOF
cat > lib/features/alerts/domain/alert_rate_limit_fix.dart << 'EOF'
class AlertRateLimiter {
  DateTime? lastTriggered;

  bool canTrigger(Duration minGap) {
    final now = DateTime.now();
    if (lastTriggered == null ||
        now.difference(lastTriggered!) >= minGap) {
      lastTriggered = now;
      return true;
    }
    return false;
  }
}
EOF
cat > lib/core/network/ws/ws_reconnect_manager.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class WsReconnectManager {
  final String url;
  WebSocketChannel? _channel;
  Timer? _reconnectTimer;

  WsReconnectManager(this.url);

  void connect(void Function(dynamic) onData) {
    _channel = WebSocketChannel.connect(Uri.parse(url));
    _channel?.stream.listen(onData,
        onError: (_) => _scheduleReconnect(onData),
        onDone: () => _scheduleReconnect(onData));
  }

  void _scheduleReconnect(void Function(dynamic) onData) {
    _reconnectTimer?.cancel();
    _reconnectTimer = Timer(Duration(seconds: 5), () => connect(onData));
  }

  void dispose() {
    _channel?.sink.close();
    _reconnectTimer?.cancel();
  }
}
EOF
cat > lib/features/indicators/engine/plugin_manager_cleanup_fix.dart << 'EOF'
import 'indicator_engine.dart';

class PluginManagerCleanupFix {
  final List<IndicatorPlugin> _active = [];

  void add(IndicatorPlugin p) {
    _active.add(p);
  }

  void remove(IndicatorPlugin p) {
    _active.removeWhere((x) => x == p);
    // ØªØ­Ø±Ù‘Ø± Ø£ÙŠ Ù…ÙˆØ±Ø¯ Ø¯Ø§Ø®Ù„ÙŠ Ø¯Ø§Ø®Ù„ p Ø¥Ù† ÙˆØ¬Ø¯
  }

  void clear() => _active.clear();
}
EOF
cat > lib/features/replay/domain/replay_strategy_sync_fix.dart << 'EOF'
class ReplayStrategySyncFix {
  bool _ready = false;

  void markReady() => _ready = true;
  bool get isReady => _ready;
}
EOF
cat > lib/core/state/subscription_cleanup_fix.dart << 'EOF'
import 'dart:async';

mixin SubscriptionCleanupFix {
  final List<StreamSubscription> _subs = [];

  void addSub(StreamSubscription sub) => _subs.add(sub);

  @override
  Future<void> close() async {
    for (final s in _subs) {
      await s.cancel();
    }
    _subs.clear();
    await super.close();
  }
}
EOF
cat > lib/features/market/data/cache/history_cache_by_tf.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

class HistoryCacheByTimeframe {
  final Map<String, List<CandleEntity>> _cache = {};

  void save(String symbol, String timeframe, List<CandleEntity> data) {
    _cache["$symbol-$timeframe"] = data;
  }

  List<CandleEntity>? load(String symbol, String timeframe) {
    return _cache["$symbol-$timeframe"];
  }

  void clear(String symbol, String timeframe) {
    _cache.remove("$symbol-$timeframe");
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_bloc_order_fix.dart << 'EOF'
void _onLoadChartHistory(...) async {
  final history = await repo.getCandles(...);
  emit(ChartLoaded(history, ...));
  // Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙ‚Ø·
  _streamSubscription = stream.listen((candle) {
    add(AppendLiveCandle(candle));
  });
}
EOF
cat > lib/features/market_depth/presentation/bloc/order_book_state_fix.dart << 'EOF'
class OrderBookState {
  final List bids;
  final List asks;

  OrderBookState({this.bids = const [], this.asks = const []});
}
EOF
cat > lib/core/network/network_listener_fix.dart << 'EOF'
import 'package:flutter/material.dart';
import 'network_observer.dart';

class NetworkStateListener extends StatefulWidget {
  final Widget child;
  NetworkStateListener(this.child);

  @override
  _NetworkStateListenerState createState() => _NetworkStateListenerState();
}

class _NetworkStateListenerState extends State<NetworkStateListener> {
  @override
  void initState() {
    super.initState();
    NetworkObserver().stream.listen((state) {
      setState(() {}); // triggers rebuild to show Online/Offline
    });
  }

  @override
  Widget build(BuildContext context) => widget.child;
}
EOF
cat > lib/features/replay/domain/replay_engine_reset_fix.dart << 'EOF'
class ReplayEngineResetFix {
  int _index = 0;

  void reset() => _index = 0;
}
EOF
cat > lib/features/indicators/plugins/vwap_plugin_fix.dart << 'EOF'
Map<String, double> compute(List candles) {
  double cumulPV = 0, cumulVol = 0;
  for (var c in candles) {
    final typical = (c.high + c.low + c.close) / 3;
    cumulPV += typical * c.volume;
    cumulVol += c.volume;
  }
  final vwap = cumulVol == 0 ? 0.0 : cumulPV / cumulVol;
  return {'VWAP': vwap};
}
EOF
cat > lib/features/indicators/domain/compute_lock.dart << 'EOF'
import 'dart:async';

class ComputeLock {
  bool _busy = false;

  Future<T?> run<T>(Future<T> Function() fn) async {
    if (_busy) return null;
    _busy = true;
    final result = await fn();
    _busy = false;
    return result;
  }
}
EOF
cat > lib/features/backtest/domain/backtest_sync_signals_fix.dart << 'EOF'
void executeSignalsSafely() {
  updateEquity();
  for (final s in signals) {
    executeSignal(s);
  }
}
EOF
cat > lib/features/market/data/repository/timeframe_transition_fix.dart << 'EOF'
Future<void> transitionTF(
    String symbol, String fromTF, String toTF) async {
  await manager.dispose(); // close WS
  final hist = await repo.getCandles(symbol, toTF); // load history
  manager.connectForSymbol(symbol, wsUrl(toTF)); // open new WS
}
EOF
cat > lib/features/alerts/presentation/bloc/alert_bloc_cleanup.dart << 'EOF'
import 'dart:async';
mixin AlertBlocCleanup {
  final List<StreamController> _controllers = [];

  void addController(StreamController c) => _controllers.add(c);

  @override
  Future<void> close() async {
    for (final c in _controllers) {
      await c.close();
    }
    await super.close();
  }
}
EOF
cat > lib/core/bloc/init/bloc_init_coordinator.dart << 'EOF'
typedef InitFuture = Future<void> Function();

class BlocInitCoordinator {
  final List<InitFuture> _initializers = [];

  void add(InitFuture fn) => _initializers.add(fn);

  Future<void> run() async {
    for (final init in _initializers) {
      await init();
    }
  }
}
EOF
cat > lib/core/network/rest/cancelable_request.dart << 'EOF'
import 'dart:async';

class CancelableRequest {
  bool _cancelled = false;

  void cancel() => _cancelled = true;

  Future<T?> execute<T>(Future<T> Function() fn) async {
    if (_cancelled) return null;
    final result = await fn();
    if (_cancelled) return null;
    return result;
  }
}
EOF
cat > lib/features/indicators/data/cache/indicator_results_cache_fix.dart << 'EOF'
import 'dart:collection';

class IndicatorResultsCacheFix {
  final _cache = HashMap<String, double>();

  void put(String key, double value) => _cache[key] = value;
  double? get(String key) => _cache[key];

  void clear() => _cache.clear();
}
EOF
cat > lib/features/strategy/domain/strategy_safe_eval_fix.dart << 'EOF'
bool canEvaluate(Map<String, double> indicators) {
  if (indicators.isEmpty) return false;
  return true;
}
EOF
cat > lib/core/state/event/event_queue_fix.dart << 'EOF'
import 'dart:async';

class EventQueueFix<T> {
  final _queue = StreamController<T>();
  bool _processing = false;

  void add(T evt) { _queue.add(evt); if (!_processing) _process(); }

  void _process() async {
    _processing = true;
    await for (final e in _queue.stream) {
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø¯Ø« Ø¯Ø§Ø®Ù„ Bloc Ø£Ùˆ Handler
    }
    _processing = false;
  }

  void dispose() => _queue.close();
}
EOF
cat > lib/core/network/ws/ws_reconnect_guard_fix.dart << 'EOF'
import 'dart:async';
import 'ws_reconnect_manager.dart';

class WsReconnectGuardFix {
  final WsReconnectManager manager;
  bool _attempting = false;

  WsReconnectGuardFix(this.manager);

  void attemptReconnect(void Function(dynamic) onData) {
    if (_attempting) return;
    _attempting = true;
    manager.connect((msg) {
      onData(msg);
      _attempting = false;
    });
  }
}
EOF
cat > lib/core/network/retry/retry_with_backoff.dart << 'EOF'
Future<T> retryWithBackoff<T>(
    Future<T> Function() fn, {
    int retries = 3,
    Duration delay = const Duration(milliseconds: 500),
  }) async {
  try {
    return await fn();
  } catch (e) {
    if (retries > 0) {
      await Future.delayed(delay);
      return retryWithBackoff(fn, retries: retries - 1, delay: delay * 2);
    }
    rethrow;
  }
}
EOF
cat > lib/core/state/shared/latest_price_holder_fix.dart << 'EOF'
class LatestPriceHolderFix {
  double? _price;

  void update(double v) => _price = v;
  double? get current => _price;
}
EOF
cat > lib/features/backtest/domain/backtest_equity_update_fix.dart << 'EOF'
void safelyUpdateEquity(List signals, double Function() equityCalc) {
  for (final s in signals) {
    executeSignal(s);
  }
  final newEquity = equityCalc();
  // ØªØ­Ø¯ÙŠØ« Equity Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° ÙƒÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
}
EOF
cat > lib/core/state/bloc/bloc_event_cancel_fix.dart << 'EOF'
import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';

mixin BlocEventCancelFix<Event> on Bloc<Event, dynamic> {
  final List<StreamSubscription> _evtSubs = [];

  void addCancelable(StreamSubscription sub) => _evtSubs.add(sub);

  @override
  Future<void> close() async {
    for (final s in _evtSubs) {
      await s.cancel();
    }
    _evtSubs.clear();
    return super.close();
  }
}
EOF
cat > lib/features/chart/domain/touch_event_filter.dart << 'EOF'
class TouchEventFilter {
  bool drawingMode = false;

  bool shouldHandleTouch(double x, double y) {
    return drawingMode; // ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø³Ù…
  }
}
EOF
cat > lib/features/market/domain/candle_deduper.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class CandleDeduper {
  final Set<int> _seenTimestamps = {};

  bool isDuplicate(CandleEntity candle) {
    final ts = candle.timeUtc.millisecondsSinceEpoch;
    if (_seenTimestamps.contains(ts)) return true;
    _seenTimestamps.add(ts);
    return false;
  }
}
EOF
cat > lib/features/replay/domain/replay_volume_fix.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class ReplayVolumeFix {
  double lastVolume = 0;

  void track(CandleEntity candle) {
    lastVolume = candle.volume;
  }
}
EOF
cat > lib/core/widgets/fix/disposable_stateful.dart << 'EOF'
import 'package:flutter/widgets.dart';

abstract class DisposableStateful<T extends StatefulWidget> extends State<T> {
  @override
  void dispose() {
    super.dispose();
  }

  void cleanUp() {
    dispose();
  }
}
EOF
cat > lib/features/replay/domain/replay_execution_lock.dart << 'EOF'
class ReplayExecutionLock {
  bool _busy = false;

  Future<void> runSafe(Future<void> Function() fn) async {
    if (_busy) return;
    _busy = true;
    await fn();
    _busy = false;
  }
}
EOF
cat > lib/core/lifecycle/init_once_guard.dart << 'EOF'
class InitOnceGuard {
  bool _initialized = false;

  Future<void> runOnce(Future<void> Function() fn) async {
    if (_initialized) return;
    _initialized = true;
    await fn();
  }
}
EOF
cat > lib/core/bloc/sync/bloc_init_barrier.dart << 'EOF'
class BlocInitBarrier {
  bool chartReady = false;
  bool indicatorReady = false;

  bool get allReady => chartReady && indicatorReady;

  void setChartReady() => chartReady = true;
  void setIndicatorReady() => indicatorReady = true;
}
EOF
cat > lib/features/trading/domain/order_submit_guard.dart << 'EOF'
class OrderSubmitGuard {
  bool canSubmit(String? symbol) => symbol != null && symbol.isNotEmpty;
}
EOF
cat > lib/features/backtest/domain/signal_eval_buffer_fix.dart << 'EOF'
class SignalEvalBufferFix {
  bool _processing = false;

  Future<void> process(Future<void> Function() fn) async {
    if (_processing) return;
    _processing = true;
    await fn();
    _processing = false;
  }
}
EOF
cat > lib/core/lifecycle/resource_lifecycle_observer_fix.dart << 'EOF'
import 'package:flutter/widgets.dart';

class ResourceLifecycleObserverFix extends WidgetsBindingObserver {
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.detached ||
        state == AppLifecycleState.inactive ||
        state == AppLifecycleState.paused) {
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù‡Ù†Ø§
    }
  }
}
EOF
cat > lib/core/network/ws/lifecycle/ws_lifecycle_handler.dart << 'EOF'
import 'package:flutter/widgets.dart';
import '../ws_channel_manager.dart';

class WsLifecycleHandler extends WidgetsBindingObserver {
  final WSChannelManager manager;

  WsLifecycleHandler(this.manager);

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.paused) {
      manager.dispose();
    }
  }
}
EOF
cat > lib/core/state/tab/tab_state_preserver.dart << 'EOF'
import 'package:flutter/widgets.dart';

class TabStatePreserver with WidgetsBindingObserver {
  final Map<String, dynamic> _states = {};

  void save(String key, dynamic state) => _states[key] = state;
  dynamic restore(String key) => _states[key];
}
EOF
cat > lib/core/network/ws/ws_reconnect_fix.dart << 'EOF'
import 'dart:async';
import 'ws_reconnect_manager.dart';

class WsReconnectFix {
  final WsReconnectManager manager;
  Timer? _retry;

  WsReconnectFix(this.manager);

  void attempt(void Function(dynamic) onData) {
    _retry?.cancel();
    _retry = Timer.periodic(Duration(seconds: 5), (_) {
      manager.connect(onData);
    });
  }

  void stop() => _retry?.cancel();
}
EOF
cat > lib/core/network/rest/parsers/safe_json_parser.dart << 'EOF'
T? safeJsonParse<T>(Map<String, dynamic>? json, String key) {
  if (json == null) return null;
  if (!json.containsKey(key)) return null;
  return json[key] as T;
}
EOF
cat > lib/core/network/ws/error/ws_error_handler.dart << 'EOF'
import 'package:web_socket_channel/web_socket_channel.dart';

class WsErrorHandler {
  void bind(WebSocketChannel channel, void Function(dynamic) onData) {
    channel.stream.listen(
      (msg) => onData(msg),
      onError: (_) => channel.sink.close(),
      onDone: () => channel.sink.close(),
    );
  }
}
EOF
cat > lib/features/backtest/domain/cancel/backtest_cancel_guard2.dart << 'EOF'
class BacktestCancelGuard2 {
  bool _cancelled = false;

  void cancel() => _cancelled = true;
  bool get isCancelled => _cancelled;
}
EOF
cat > lib/core/webview/webview_controller_cleanup_fix.dart << 'EOF'
import 'package:webview_flutter/webview_flutter.dart';

class WebViewControllerCleanupFix {
  void disposeController(WebViewController? ctrl) {
    ctrl = null;
  }
}
EOF
cat > lib/features/settings/domain/chart_settings_lock_fix.dart << 'EOF'
class ChartSettingsLockFix {
  bool _updating = false;

  Future<void> runSafe(Future<void> Function() fn) async {
    if (_updating) return;
    _updating = true;
    await fn();
    _updating = false;
  }
}
EOF
cat > lib/core/network/retry/network_bounce_handler_fix.dart << 'EOF'
import 'dart:async';

class NetworkBounceHandlerFix {
  Timer? _bounceTimer;

  void onNetworkChange(bool isOnline, void Function() onReconnect) {
    _bounceTimer?.cancel();
    if (isOnline) {
      _bounceTimer = Timer(Duration(seconds: 1), onReconnect);
    }
  }
}
EOF
cat > lib/core/storage/transaction/transactional_write_fix.dart << 'EOF'
import 'dart:io';

class TransactionalStorage {
  static Future<void> safeWrite(String path, String data) async {
    final temp = File(path + ".tmp");
    await temp.writeAsString(data);
    final original = File(path);
    await temp.rename(original.path);
  }
}
EOF
cat > lib/core/bloc/subscription_manager/subscription_manager.dart << 'EOF'
import 'dart:async';

/// A manager that keeps only one active subscription at a time.
/// Cancels previous one automatically when a new one is added.
class SubscriptionManager {
  StreamSubscription<dynamic>? _current;

  /// Replace the current subscription with a new one,
  /// canceling the previous if it exists.
  void replace(StreamSubscription<dynamic> newSub) {
    _current?.cancel();
    _current = newSub;
  }

  /// Cancel and clear the current subscription.
  Future<void> dispose() async {
    if (_current != null) {
      await _current!.cancel();
      _current = null;
    }
  }
}
EOF
cat > lib/core/filters/candle_outlier_filter.dart << 'EOF'
import '../../core/models/candle_entity.dart';

class CandleOutlierFilter {
  final double maxAllowedRangePercentage;

  CandleOutlierFilter({this.maxAllowedRangePercentage = 50});

  /// Filters out candles whose range deviates too much compared to neighbors.
  bool isValid(CandleEntity candle) {
    if (candle.open == 0 || candle.high == 0 || candle.low == 0) {
      return false;
    }
    final range = candle.high - candle.low;
    final avgPrice = (candle.high + candle.low) / 2.0;
    final pct = (range / avgPrice) * 100.0;
    return pct <= maxAllowedRangePercentage;
  }
}
EOF
cat > lib/core/queue/execution_queue.dart << 'EOF'
import 'dart:async';

/// A simple sequential queue for async tasks.
/// Ensures tasks run one at a time in order.
class ExecutionQueue {
  final _taskController = StreamController<Future Function()>();

  ExecutionQueue() {
    _taskController.stream.asyncMap((task) => task()).listen((_) {});
  }

  /// Add a function that returns a Future to the queue.
  void schedule(Future Function() task) {
    _taskController.add(task);
  }

  /// Close the queue.
  Future<void> dispose() async {
    await _taskController.close();
  }
}
EOF
cat > lib/features/backtest/domain/backtest_network_bounce_guard.dart << 'EOF'
import '../../../core/network/retry/retry_with_backoff.dart';

class BacktestNetworkBounceGuard {
  final int maxRetries;

  BacktestNetworkBounceGuard({this.maxRetries = 5});

  Future<T> safeFetch<T>(Future<T> Function() fetchFn) {
    return retryWithBackoff(fetchFn, retries: maxRetries);
  }
}
EOF
cat > lib/features/trading/data/sl_tp_storage_fix.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class SLTPStorageFix {
  static Future<void> save(String symbol, double sl, double tp) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(
      'sl_tp_$symbol',
      jsonEncode({'sl': sl, 'tp': tp}),
    );
  }

  static Future<Map<String, double>?> load(String symbol) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString('sl_tp_$symbol');
    if (str == null) return null;
    final map = jsonDecode(str) as Map<String, dynamic>;
    return {
      'sl': (map['sl'] as num).toDouble(),
      'tp': (map['tp'] as num).toDouble(),
    };
  }
}
EOF
cat > lib/core/sync/timestamp_aligner.dart << 'EOF'
class TimestampAligner {
  static double alignWeightedAverage(
      double currentValue,
      DateTime currentTimestamp,
      double latestValue,
      DateTime latestTimestamp) {
    final dt = latestTimestamp.difference(currentTimestamp).inMilliseconds;
    final w1 = dt <= 0 ? 1.0 : 1 / (1 + dt);
    final w2 = 1 - w1;
    return (currentValue * w1) + (latestValue * w2);
  }
}
EOF
cat > lib/features/chart/domain/drawing/trendline_mapping_fix.dart << 'EOF'
class TrendlineMappingFix {
  static double mapPriceToY({
    required double price,
    required double minPrice,
    required double maxPrice,
    required double height,
  }) {
    final range = maxPrice - minPrice;
    return (maxPrice - price) / (range == 0 ? 1 : range) * height;
  }

  static double mapTimeToX({
    required DateTime time,
    required DateTime start,
    required DateTime end,
    required double width,
  }) {
    final total = end.difference(start).inMilliseconds;
    final delta = time.difference(start).inMilliseconds;
    return width * (total == 0 ? 0 : delta / total);
  }
}
EOF
cat > lib/core/buffer/ring_buffer.dart << 'EOF'
class RingBuffer<T> {
  final int capacity;
  final List<T> _buffer = [];
  int _index = 0;

  RingBuffer(this.capacity);

  void add(T item) {
    if (_buffer.length < capacity) {
      _buffer.add(item);
    } else {
      _buffer[_index] = item;
      _index = (_index + 1) % capacity;
    }
  }

  List<T> toList() => List.unmodifiable(_buffer);
}
EOF
cat > lib/core/widgets/keep_alive_chart.dart << 'EOF'
import 'package:flutter/widgets.dart';

class KeepAliveChart extends StatefulWidget {
  final Widget child;

  KeepAliveChart({required this.child});

  @override
  _KeepAliveChartState createState() => _KeepAliveChartState();
}

class _KeepAliveChartState extends State<KeepAliveChart>
    with AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true;

  @override
  Widget build(BuildContext context) {
    super.build(context);
    return widget.child;
  }
}
EOF
cat > lib/core/lifecycle/resume_load_coordinator_fix.dart << 'EOF'
class ResumeLoadCoordinatorFix {
  bool _historyDone = false;

  void markHistoryDone() => _historyDone = true;

  bool canStartWS() => _historyDone;
}
EOF
cat > lib/features/chart/presentation/bloc/chart_bloc_with_subscription_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/bloc/subscription_manager/subscription_manager.dart';

class ChartBloc extends Bloc<ChartEvent, ChartState> {
  final SubscriptionManager _subsManager = SubscriptionManager();

  ChartBloc() : super(ChartInitial()) {
    on<StartLiveFeed>((event, emit) {
      final sub = event.stream.listen((data) {
        add(LiveDataArrived(data));
      });
      _subsManager.replace(sub);
    });

    on<LiveDataArrived>((event, emit) {
      emit(ChartUpdated(event.data));
    });
  }

  @override
  Future<void> close() async {
    await _subsManager.dispose();
    return super.close();
  }
}
EOF
cat > lib/features/market/data/repository/candle_repository_with_filter.dart << 'EOF'
import '../../../../core/filters/candle_outlier_filter.dart';
import '../../../../core/models/candle_entity.dart';

class CandleRepositoryWithFilter {
  final CandleOutlierFilter filter = CandleOutlierFilter();

  Future<List<CandleEntity>> fetchCandles(String symbol, String timeframe) async {
    // Ù…Ø«Ø§Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† API
    final raw = await getRawCandlesFromApi(symbol, timeframe);

    // Ø§Ù„ØªØµÙÙŠØ©
    final cleaned = raw.where((c) => filter.isValid(c)).toList();

    return cleaned;
  }

  Future<List<CandleEntity>> getRawCandlesFromApi(String symbol, String timeframe) async {
    // Placeholder
    return [];
  }
}
EOF
cat > lib/core/network/ws/smart/ws_smart_manager.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../network_observer.dart';

/// Smart WS Manager: handles connect/disconnect cleanly,
/// autoâ€‘reconnect, disposals on app pause, and prevents leaks.
class WSSmartManager {
  WebSocketChannel? _channel;
  final String url;
  final NetworkObserver _observer;
  Timer? _reconnectTimer;

  bool _connected = false;

  WSSmartManager(this.url, this._observer) {
    _observer.stream.listen((state) {
      if (state == NetState.offline) {
        _disconnect();
      } else {
        _scheduleReconnect();
      }
    });
  }

  void connect(void Function(dynamic) onData) {
    _disconnect(); // always clean before new
    _channel = WebSocketChannel.connect(Uri.parse(url));
    _channel!.stream.listen(onData,
        onError: (_) => _scheduleReconnect(),
        onDone: () => _scheduleReconnect());
    _connected = true;
  }

  void _scheduleReconnect() {
    _reconnectTimer?.cancel();
    _reconnectTimer = Timer(const Duration(seconds: 5), () {
      if (_connected) return;
      connect((_) {});
    });
  }

  void _disconnect() {
    _reconnectTimer?.cancel();
    _channel?.sink.close();
    _channel = null;
    _connected = false;
  }

  void dispose() {
    _disconnect();
  }
}
EOF
cat > lib/features/market/presentation/bloc/ws/ws_manager_bloc_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/network/ws/smart/ws_smart_manager.dart';
import '../../../../core/network/network_observer.dart';

class WSBloc extends Cubit<void> {
  final WSSmartManager manager;

  WSBloc(this.manager) : super(null);

  void start(String symbol) {
    manager.connect((data) {
      // dispatch into ChartBloc/OrderBookBloc
    });
  }

  @override
  Future<void> close() async {
    manager.dispose(); // clean
    return super.close();
  }
}
EOF
cat > lib/core/data/sanitizer/data_sanitizer.dart << 'EOF'
class DataSanitizer {
  static bool isValidNumber(dynamic v) {
    if (v == null) return false;
    if (v is num) return true;
    return num.tryParse(v.toString()) != null;
  }

  static double safeDouble(dynamic v, {double fallback = 0.0}) {
    return isValidNumber(v) ? double.parse(v.toString()) : fallback;
  }

  static bool isValidMap(Map? m) => m != null && m.isNotEmpty;
}
EOF
cat > lib/core/network/rest/parsers/safe_api_parser.dart << 'EOF'
import '../../../../core/data/sanitizer/data_sanitizer.dart';

class SafeApiParser {
  static Map<String, dynamic> parseCandle(Map<String, dynamic>? json) {
    if (json == null) return {};
    return {
      'time': json['time'] ?? '',
      'open': DataSanitizer.safeDouble(json['open']),
      'high': DataSanitizer.safeDouble(json['high']),
      'low': DataSanitizer.safeDouble(json['low']),
      'close': DataSanitizer.safeDouble(json['close']),
      'volume': DataSanitizer.safeDouble(json['volume']),
    };
  }
}
EOF
cat > lib/core/network/ws/parsers/safe_ws_parser.dart << 'EOF'
import '../../../../core/data/sanitizer/data_sanitizer.dart';

Map<String, dynamic>? safeWS(Map<String, dynamic>? data) {
  if (data == null) return null;
  if (!DataSanitizer.isValidNumber(data['price'])) return null;
  return data;
}
EOF
cat > lib/features/replay/domain/controller/replay_controller.dart << 'EOF'
import 'dart:async';

class ReplayController {
  final List<StreamSubscription> _subs = [];
  bool _isPlaying = false;

  void play(Stream stream, void Function(dynamic) onData) {
    stop();      // ØªÙˆÙ‚Ù Ø£ÙŠ ØªØ´ØºÙŠÙ„ Ø³Ø§Ø¨Ù‚
    _isPlaying = true;
    final sub = stream.listen((data) {
      if (!_isPlaying) return;
      onData(data);
    });
    _subs.add(sub);
  }

  void stop() {
    _isPlaying = false;
    for (final s in _subs) {
      s.cancel();
    }
    _subs.clear();
  }

  void dispose() => stop();
}
EOF
cat > lib/features/replay/presentation/bloc/replay_bloc_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/controller/replay_controller.dart';

class ReplayBlocFix extends Bloc<ReplayEvent, ReplayState> {
  final ReplayController _ctrl = ReplayController();

  ReplayBlocFix(): super(ReplayIdle()) {
    on<StartReplay>((evt, emit) {
      _ctrl.play(evt.stream, (data) => add(ReplayTick(data)));
      emit(ReplayPlaying());
    });

    on<StopReplay>((_, emit) {
      _ctrl.stop();
      emit(ReplayStopped());
    });
  }

  @override
  Future<void> close() async {
    _ctrl.dispose();
    return super.close();
  }
}
EOF
cat > lib/features/backtest/domain/engine/backtest_engine_fix.dart << 'EOF'
import 'dart:async';

class BacktestEngineFix {
  bool _cancel = false;
  final StreamController<double> equityStream = StreamController.broadcast();

  void cancel() => _cancel = true;

  Future<void> run(List dataset) async {
    double equity = 0.0;

    for (final data in dataset) {
      if (_cancel) break;

      // update indicators safely
      final signals = computeSignals(data);

      // execute trades
      for (final sig in signals) {
        equity += executeTrade(sig);
      }

      equityStream.add(equity);

      // yield control to avoid blocking
      await Future.delayed(Duration(milliseconds: 1));
    }
  }

  void dispose() {
    equityStream.close();
  }

  List computeSignals(dynamic data) => [];
  double executeTrade(dynamic sig) => 0.0;
}
EOF
cat > lib/features/settings/domain/controllers/chart_settings_controller_fix.dart << 'EOF'
import 'dart:async';
import 'package:shared_preferences/shared_preferences.dart';

class ChartSettingsControllerFix {
  final List<Map<String, dynamic>> _undoStack = [];
  final List<Map<String, dynamic>> _redoStack = [];

  Future<void> save(Map<String, dynamic> cfg) async {
    final prefs = await SharedPreferences.getInstance();
    final backup = await load();
    if (backup != null) _undoStack.add(backup);

    await prefs.setString('chart_settings', cfg.toString());
  }

  Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString('chart_settings');
    if (str == null) return null;
    return Map<String, dynamic>.from({});
  }

  Future<void> undo() async {
    if (_undoStack.isEmpty) return;
    final last = _undoStack.removeLast();
    _redoStack.add(last);
    await save(last);
  }

  Future<void> redo() async {
    if (_redoStack.isEmpty) return;
    final last = _redoStack.removeLast();
    _undoStack.add(last);
    await save(last);
  }
}
EOF
cat > lib/core/sync/event_sync_controller.dart << 'EOF'
import 'dart:async';

/// Ensures only one update type is processed at a time.
/// Other events wait in queue.
class EventSyncController {
  final _queue = StreamController<Function()>();

  EventSyncController() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  /// add an event to execution queue
  void addToQueue(void Function() task) {
    _queue.add(task);
  }

  Future<void> close() async {
    await _queue.close();
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart_bloc_sync_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/sync/event_sync_controller.dart';

class ChartBlocSyncFix extends Bloc<ChartEvent, ChartState> {
  final EventSyncController _sync = EventSyncController();

  ChartBlocSyncFix() : super(ChartInitial()) {
    on<NewLiveCandle>((event, emit) {
      _sync.addToQueue(() {
        // process candle update
        emit(ChartUpdated(event.candle));
      });
    });

    on<ZoomPanChanged>((event, emit) {
      _sync.addToQueue(() {
        // process zoom/pan update
        emit(ChartZoomed(event.range));
      });
    });
  }

  @override
  Future<void> close() async {
    await _sync.close();
    return super.close();
  }
}
EOF
cat > lib/core/network/error/network_error_handler.dart << 'EOF'
import 'dart:io';

enum NetworkErrorType {
  noConnection,
  timeout,
  serverError,
  unknown
}

class NetworkErrorHandler {
  static NetworkErrorType classify(error) {
    if (error is SocketException) {
      return NetworkErrorType.noConnection;
    } else if (error is TimeoutException) {
      return NetworkErrorType.timeout;
    } else if (error.toString().contains('500')) {
      return NetworkErrorType.serverError;
    }
    return NetworkErrorType.unknown;
  }

  static String message(NetworkErrorType type) {
    switch (type) {
      case NetworkErrorType.noConnection:
        return "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
      case NetworkErrorType.timeout:
        return "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„.";
      case NetworkErrorType.serverError:
        return "Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù….";
      case NetworkErrorType.unknown:
      default:
        return "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©.";
    }
  }
}
EOF
cat > lib/features/market/data/repository/market_repository_error_fix.dart << 'EOF'
import '../../../../core/network/error/network_error_handler.dart';
import '../../../../core/network/rest_error.dart';

Future<List<CandleEntity>> safeFetchHistory(...) async {
  try {
    return await _fetchHistory(...);
  } catch (e) {
    final type = NetworkErrorHandler.classify(e);
    final message = NetworkErrorHandler.message(type);
    throw RestError(message);
  }
}
EOF
cat > lib/core/utils/debounce.dart << 'EOF'
import 'dart:async';

class Debouncer {
  final Duration delay;
  Timer? _timer;

  Debouncer(this.delay);

  void call(void Function() action) {
    _timer?.cancel();
    _timer = Timer(delay, action);
  }

  void cancel() {
    _timer?.cancel();
    _timer = null;
  }
}
EOF
cat > lib/features/market/presentation/bloc/zoom_debounce_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/utils/debounce.dart';

class ZoomBloc extends Bloc<ZoomEvent, ZoomState> {
  final Debouncer _debouncer = Debouncer(Duration(milliseconds: 200));

  ZoomBloc(): super(ZoomIdle()) {
    on<ZoomChanged>((event, emit) {
      _debouncer(() {
        emit(ZoomUpdated(event.range));
      });
    });
  }
}
EOF
cat > lib/core/mode/app_mode_guard.dart << 'EOF'
enum AppMode { live, backtest }

class AppModeGuard {
  AppMode _current = AppMode.live;

  AppMode get current => _current;

  bool canEnterBacktest() => _current != AppMode.backtest;
  bool canEnterLive() => _current != AppMode.live;

  void enterBacktest() => _current = AppMode.backtest;
  void enterLive() => _current = AppMode.live;
}
EOF
cat > lib/features/backtest/presentation/bloc/backtest_mode_guard_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/mode/app_mode_guard.dart';

class BacktestModeBloc extends Bloc<BacktestEvent, BacktestState> {
  final AppModeGuard _guard;

  BacktestModeBloc(this._guard) : super(BacktestIdle());

  void startBacktest(...) {
    if (!_guard.canEnterBacktest()) return; // Ù„Ø§ Ø¥Ø¹Ø§Ø¯Ø© Backtest Ø£Ø«Ù†Ø§Ø¡ live
    _guard.enterBacktest();
    // start backtest
  }

  void stopBacktest() {
    _guard.enterLive();
    // stop backtest
  }
}
EOF
cat > lib/core/persistence/persistent_state_manager.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class PersistentStateManager {
  static Future<void> save(String key, Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }

  static Future<void> clear(String key) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.remove(key);
  }
}
EOF
cat > lib/core/lifecycle/app_lifecycle_manager.dart << 'EOF'
import 'package:flutter/widgets.dart';
import '../persistence/persistent_state_manager.dart';

class AppLifecycleManager extends WidgetsBindingObserver {
  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      // Ù…Ø«Ø§Ù„: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„ Chart
      PersistentStateManager.load("chart_state")?.then((data) {
        // dispatch to ChartBloc
      });
    }
  }
}
EOF
cat > lib/core/persistence/persistent_state_manager.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class PersistentStateManager {
  static Future<void> save(String key, Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(state));
  }
  static Future<Map<String, dynamic>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/core/time/time_normalizer.dart << 'EOF'
class TimeNormalizer {
  static DateTime toUtc(dynamic input) {
    if (input is String) return DateTime.parse(input).toUtc();
    if (input is DateTime) return input.toUtc();
    return DateTime.now().toUtc();
  }
}
EOF
cat > lib/core/time/session_filter.dart << 'EOF'
class SessionFilter {
  static bool isWithinMarketHours(DateTime utc) {
    final weekday = utc.weekday;
    if (weekday == DateTime.saturday || weekday == DateTime.sunday) return false;
    return true;
  }
}
EOF
cat > lib/core/bloc/mixins/safe_dispose_mixin.dart << 'EOF'
import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';

mixin SafeDisposeMixin on BlocBase {
  final List<StreamSubscription> _subs = [];

  void addSub(StreamSubscription sub) => _subs.add(sub);

  @override
  Future<void> close() async {
    for (final s in _subs) await s.cancel();
    _subs.clear();
    return super.close();
  }
}
EOF
cat > lib/core/state/shared/price_volume_state.dart << 'EOF'
import 'package:flutter/foundation.dart';

class PriceVolumeState with ChangeNotifier {
  double _price = 0, _volume = 0;

  double get price => _price;
  double get volume => _volume;

  void update(double p, double v) {
    _price = p;
    _volume = v;
    notifyListeners();
  }
}
EOF
cat > lib/core/network/rest/parsers/safe_map_parser.dart << 'EOF'
T? parseSafe<T>(Map<String, dynamic>? json, String key) {
  if (json == null) return null;
  final val = json[key];
  if (val == null) return null;
  return val is T ? val : null;
}
EOF
cat > lib/core/webview/webview_error_guard.dart << 'EOF'
import 'package:webview_flutter/webview_flutter.dart';

class WebViewErrorGuard {
  static void guard(WebViewController ctrl) {
    ctrl.setJavaScriptMode(JavaScriptMode.unrestricted);
    ctrl.addJavaScriptChannel(
      'ErrorGuard',
      onMessageReceived: (msg) {
        // ØªØ±Ø³Ù„ Ø£ÙŠ Ø®Ø·Ø£ Ø£Ùˆ ØªØ­Ø°ÙŠØ±
      },
    );
  }
}
EOF
cat > lib/features/backtest/domain/strategy/strategy_freeze_guard.dart << 'EOF'
class StrategyFreezeGuard {
  bool _frozen = false;

  void freeze() => _frozen = true;
  void unfreeze() => _frozen = false;

  bool get isFrozen => _frozen;
}
EOF
cat > lib/features/settings/data/undo_redo_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class UndoRedoStorage {
  static Future<void> save(String key, List<Map<String, dynamic>> states) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(key, jsonEncode(states));
  }
  static Future<List<Map<String, dynamic>>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(key);
    if (str == null) return null;
    return (jsonDecode(str) as List).cast<Map<String, dynamic>>();
  }
}
EOF
cat > lib/core/compute/backtest_chunked_runner.dart << 'EOF'
import 'dart:isolate';

class BacktestChunkedRunner {
  static Future<void> run(List dataset, void Function(dynamic) onResult) async {
    await Isolate.run(() async {
      for (final chunk in dataset) {
        onResult(chunk);
      }
    });
  }
}
EOF
cat > lib/features/alerts/domain/alert_rate_manager.dart << 'EOF'
class AlertRateManager {
  DateTime? _lastTime;

  bool canNotify(Duration gap) {
    final now = DateTime.now();
    if (_lastTime == null || now.difference(_lastTime!) >= gap) {
      _lastTime = now;
      return true;
    }
    return false;
  }

  void reset() => _lastTime = null;
}
EOF
cat > lib/core/sync/signal_sync_controller.dart << 'EOF'
import 'dart:async';

/// Ensures that indicator values are updated before evaluating signals.
class SignalSyncController {
  final _queue = StreamController<Function()>();

  SignalSyncController() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  void addTask(Function() task) {
    _queue.add(task);
  }

  Future<void> dispose() async {
    await _queue.close();
  }
}
EOF
cat > lib/features/strategy/domain/signal_evaluator_sync_fix.dart << 'EOF'
import '../../../../core/sync/signal_sync_controller.dart';

class StrategyEvaluatorSyncFix {
  final SignalSyncController _sync = SignalSyncController();

  void evaluate(Map<String, double> indicators, Function applySignal) {
    _sync.addTask(() {
      if (!_sync.isClosed) {
        applySignal(indicators);
      }
    });
  }

  Future<void> dispose() => _sync.dispose();
}
EOF
cat > lib/core/cache/persistent_history_cache.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class PersistentHistoryCache {
  static const _keyPrefix = "history_cache_";

  static Future<void> save(String key, List<Map<String, dynamic>> data) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(_keyPrefix + key, jsonEncode(data));
  }

  static Future<List<Map<String, dynamic>>?> load(String key) async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(_keyPrefix + key);
    if (str == null) return null;
    return (jsonDecode(str) as List).cast<Map<String, dynamic>>();
  }

  static Future<void> clear(String key) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.remove(_keyPrefix + key);
  }
}
EOF
cat > lib/core/chart/chart_controller_manager.dart << 'EOF'
import 'package:flutter/animation.dart';

class ChartControllerManager {
  final List<AnimationController> _controllers = [];

  void register(AnimationController c) {
    _controllers.add(c);
  }

  void disposeAll() {
    for (final c in _controllers) {
      c.dispose();
    }
    _controllers.clear();
  }
}
EOF
cat > lib/core/filters/range_filter_fix.dart << 'EOF'
import '../../core/models/candle_entity.dart';

class RangeFilterFix {
  List<CandleEntity> filterRange(
      List<CandleEntity> data, DateTime from, DateTime to) {
    return data.where((c) =>
        !c.timeUtc.isBefore(from) &&
        !c.timeUtc.isAfter(to)).toList();
  }
}
EOF
cat > lib/features/trading/domain/order_safe_guard.dart << 'EOF'
import 'order.dart';

class OrderSafeGuard {
  static bool isValid(Order? order) {
    if (order == null) return false;
    if (order.symbol.isEmpty) return false;
    if (order.lots <= 0) return false;
    return true;
  }
}
EOF
cat > lib/core/network/retry/retry_limiter.dart << 'EOF'
import 'dart:async';

class RetryLimiter {
  final int maxAttempts;
  final Duration baseDelay;

  RetryLimiter({this.maxAttempts = 3, this.baseDelay = const Duration(milliseconds: 500)});

  Future<T?> run<T>(Future<T> Function() fn) async {
    int attempts = 0;
    while (attempts < maxAttempts) {
      try {
        return await fn();
      } catch (e) {
        attempts++;
        await Future.delayed(baseDelay * attempts);
      }
    }
    return null;
  }
}
EOF
cat > lib/core/bloc/guards/async_dispose_guard.dart << 'EOF'
import 'dart:async';

class AsyncDisposeGuard {
  bool _disposing = false;
  final List<Future<void>> _pending = [];

  void track(Future<void> future) {
    if (!_disposing) _pending.add(future);
  }

  Future<void> dispose() async {
    _disposing = true;
    await Future.wait(_pending);
    _pending.clear();
  }
}
EOF
cat > lib/core/widgets/fix/repaint_boundary_chart.dart << 'EOF'
import 'package:flutter/widgets.dart';

class RepaintBoundaryChart extends StatelessWidget {
  final Widget child;

  RepaintBoundaryChart({required this.child});

  @override
  Widget build(BuildContext context) {
    return RepaintBoundary(child: child);
  }
}
EOF
cat > lib/core/chart/update/batch_update_manager.dart << 'EOF'
import 'dart:async';

class BatchUpdateManager {
  final Duration delay;
  Timer? _timer;
  List<dynamic> _pending = [];

  BatchUpdateManager({this.delay = const Duration(milliseconds: 50)});

  void add(dynamic data, void Function(List<dynamic>) callback) {
    _pending.add(data);
    _timer?.cancel();
    _timer = Timer(delay, () {
      callback(_pending);
      _pending.clear();
    });
  }
}
EOF
cat > lib/core/market/symbol_normalizer.dart << 'EOF'
class SymbolNormalizer {
  /// ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ ØµÙŠØºØ© Ø±Ù…Ø²ÙŠØ© Ù„Ù€ "CONCAT" (Ø¨Ø¯ÙˆÙ† underscore)
  static String normalize(String sym) {
    return sym.replaceAll("_", "").toUpperCase();
  }

  /// ÙŠÙØµÙ‘Ù„ Ø§Ù„ØµÙŠØºØ© Ø¥Ù„Ù‰ Ø²ÙˆØ¬/Ø³ÙˆÙ‚
  static String formatWithUnderscore(String sym) {
    final n = normalize(sym);
    // Ù…Ø«Ø§Ù„: XAUUSD â†’ XAU_USD
    if (n.length == 6) {
      return "${n.substring(0, 3)}_${n.substring(3)}";
    }
    return sym;
  }
}
EOF
cat > lib/core/sync/compute_guard.dart << 'EOF'
import 'dart:async';

class ComputeGuard {
  bool _busy = false;

  Future<void> run(Future<void> Function() fn) async {
    while (_busy) {
      await Future.delayed(Duration(milliseconds: 5));
    }
    _busy = true;
    await fn();
    _busy = false;
  }
}
EOF
cat > lib/features/indicators/domain/indicator_engine_compute_fix.dart << 'EOF'
import '../../../../core/sync/compute_guard.dart';
import '../../../core/models/candle_entity.dart';

class IndicatorEngineComputeFix {
  final ComputeGuard _guard = ComputeGuard();

  Future<Map<String, double>> computeSafe(
      List<CandleEntity> snapshot,
      Future<Map<String, double>> Function(List<CandleEntity>) computeFn) async {
    Map<String, double> result = {};
    await _guard.run(() async {
      result = await computeFn(snapshot);
    });
    return result;
  }
}
EOF
cat > lib/core/webview/guard/webview_js_ready_guard.dart << 'EOF'
import 'package:webview_flutter/webview_flutter.dart';

class WebViewJSReadyGuard {
  static Future<void> evaluateWhenReady(
      WebViewController ctrl, String script) async {
    final ready = await ctrl
        .runJavascriptReturningResult("document.readyState === 'complete'");
    if (ready == '"complete"') {
      await ctrl.runJavascript(script);
    } else {
      ctrl.runJavascript(
          "document.addEventListener('DOMContentLoaded', function() { $script });");
    }
  }
}
EOF
cat > lib/core/network/rest/guard/safe_rest_response.dart << 'EOF'
import 'dart:convert';
import 'package:http/http.dart' as http;

class SafeRestResponse {
  static Map<String, dynamic>? parse(http.Response res) {
    if (res.statusCode != 200) return null;
    try {
      return jsonDecode(res.body) as Map<String, dynamic>;
    } catch (_) {
      return null;
    }
  }
}
EOF
cat > lib/core/bloc/mixins/stream_controller_manager.dart << 'EOF'
import 'dart:async';

mixin StreamControllerManager {
  final List<StreamController> _controllers = [];

  StreamController<T> createController<T>({bool broadcast = false}) {
    final c = broadcast
        ? StreamController<T>.broadcast()
        : StreamController<T>();
    _controllers.add(c);
    return c;
  }

  Future<void> disposeControllers() async {
    for (final c in _controllers) {
      await c.close();
    }
    _controllers.clear();
  }
}
EOF
cat > lib/features/indicators/domain/gap/gap_aware_indicator.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

class GapAwareIndicator {
  static List<CandleEntity> fillGaps(
      List<CandleEntity> data, Duration interval) {
    if (data.isEmpty) return data;
    final List<CandleEntity> filled = [];
    for (int i = 0; i < data.length - 1; i++) {
      filled.add(data[i]);
      final diff = data[i + 1].timeUtc
          .difference(data[i].timeUtc)
          .inMilliseconds;
      if (diff > interval.inMilliseconds) {
        // Gap exists
        final count = (diff / interval.inMilliseconds).floor() - 1;
        for (int j = 1; j <= count; j++) {
          filled.add(CandleEntity(
            timeUtc: data[i].timeUtc
                .add(Duration(milliseconds: interval.inMilliseconds * j)),
            open: data[i].close,
            high: data[i].close,
            low: data[i].close,
            close: data[i].close,
            volume: 0,
          ));
        }
      }
    }
    filled.add(data.last);
    return filled;
  }
}
EOF
cat > lib/core/navigation/router_bloc_cleanup.dart << 'EOF'
import 'package:flutter/widgets.dart';

class RouterBlocCleanup extends RouteObserver<PageRoute<dynamic>> {
  @override
  void didPop(Route route, Route? previousRoute) {
    if (route is PageRoute) {
      // dispatch cleanup event to relevant Blocs
    }
  }

  @override
  void didPush(Route route, Route? previousRoute) {
    if (previousRoute is PageRoute) {
      // dispatch cleanup event
    }
  }
}
EOF
cat > lib/core/compute/isolate_task_manager.dart << 'EOF'
import 'dart:isolate';

class IsolateTaskManager {
  final List<Isolate> _isolates = [];

  Future<Isolate> spawn(Function entry) async {
    final iso = await Isolate.spawn(entry, null);
    _isolates.add(iso);
    return iso;
  }

  void killAll() {
    for (final iso in _isolates) {
      iso.kill(priority: Isolate.immediate);
    }
    _isolates.clear();
  }
}
EOF
cat > lib/core/filters/price_spike_filter.dart << 'EOF'
class PriceSpikeFilter {
  static bool isSpike(double prev, double curr, double thresholdPct) {
    final diff = (curr - prev).abs();
    final pct = (diff / prev) * 100.0;
    return pct > thresholdPct;
  }
}
EOF
cat > lib/core/localization/app_localizations.dart << 'EOF'
import 'dart:ui';

class AppLocalizations {
  static String networkError() => "Network error occurred.";
  static String unknownError() => "Unknown error.";
  static String priceInvalid() => "Invalid price data.";
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
}
EOF
cat > lib/core/utils/settings_debouncer.dart << 'EOF'
import 'dart:async';

class SettingsDebouncer {
  final Duration delay;
  Timer? _timer;

  SettingsDebouncer({this.delay = const Duration(milliseconds: 300)});

  void save(void Function() saveFn) {
    _timer?.cancel();
    _timer = Timer(delay, saveFn);
  }
}
EOF
cat > lib/core/mode/mode_stream_manager.dart << 'EOF'
import 'dart:async';

class ModeStreamManager {
  final List<StreamSubscription> _streams = [];

  void register(StreamSubscription sub) => _streams.add(sub);

  Future<void> clearAll() async {
    for (final s in _streams) {
      await s.cancel();
    }
    _streams.clear();
  }
}
EOF
cat > lib/core/sync/rest_ws_sync_coordinator.dart << 'EOF'
import 'dart:async';

class RestWsSyncCoordinator {
  bool _historyLoaded = false;
  final List<Function()> _pendingConnectWs = [];

  void historyLoaded() {
    _historyLoaded = true;
    while (_pendingConnectWs.isNotEmpty) {
      final action = _pendingConnectWs.removeAt(0);
      action();
    }
  }

  void connectWsWhenReady(Function() connectFn) {
    if (_historyLoaded) {
      connectFn();
    } else {
      _pendingConnectWs.add(connectFn);
    }
  }
}
EOF
cat > lib/features/backtest/domain/check/preflight_check.dart << 'EOF'
import '../../../core/models/candle_entity.dart';

class BacktestPreflightCheck {
  bool validate(List<CandleEntity> history, int minCandles) {
    if (history.length < minCandles) return false;
    // Ø£ÙŠ Ø´Ø±ÙˆØ· Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
    return true;
  }
}
EOF
cat > lib/core/widgets/animation_controller_guard.dart << 'EOF'
import 'package:flutter/animation.dart';

class AnimationControllerGuard {
  final List<AnimationController> _controllers = [];

  void register(AnimationController c) => _controllers.add(c);

  void disposeAll() {
    for (final c in _controllers) {
      c.dispose();
    }
    _controllers.clear();
  }
}
EOF
cat > lib/core/network/rest/parsers/json_safe_helpers.dart << 'EOF'
T safeParse<T>(dynamic value, T fallback) {
  try {
    if (value == null) return fallback;
    if (value is T) return value;
    if (T == double) return double.tryParse(value.toString()) as T? ?? fallback;
    if (T == int) return int.tryParse(value.toString()) as T? ?? fallback;
    return fallback;
  } catch (_) {
    return fallback;
  }
}
EOF
cat > lib/core/network/ws/backoff/ws_backoff_manager.dart << 'EOF'
import 'dart:async';

class WsBackoffManager {
  int _attempts = 0;
  Timer? _timer;

  void scheduleReconnect(Function() reconnect) {
    _timer?.cancel();
    _attempts++;
    final wait = Duration(seconds: 2 * _attempts);
    _timer = Timer(wait, reconnect);
  }

  void reset() => _attempts = 0;
}
EOF
cat > lib/core/storage/shared_prefs_cleaner.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';

class SharedPrefsCleaner {
  static Future<void> cleanAll() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.clear();
  }
}
EOF
cat > lib/core/widgets/keep_alive_responsive.dart << 'EOF'
import 'package:flutter/widgets.dart';

class KeepAliveResponsive extends StatefulWidget {
  final Widget child;
  KeepAliveResponsive({required this.child});

  @override
  _KeepAliveResponsiveState createState() => _KeepAliveResponsiveState();
}

class _KeepAliveResponsiveState extends State<KeepAliveResponsive>
    with AutomaticKeepAliveClientMixin {
  @override
  bool get wantKeepAlive => true;

  @override
  Widget build(BuildContext context) {
    super.build(context);
    return widget.child;
  }
}
EOF
cat > lib/core/navigation/bloc_auto_dispose_route.dart << 'EOF'
import 'package:flutter/widgets.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

class BlocAutoDisposeRoute<T> extends MaterialPageRoute<T> {
  final BlocProvider _provider;

  BlocAutoDisposeRoute({required Widget child, required BlocProvider provider})
      : _provider = provider,
        super(builder: (_) => child);

  @override
  void dispose() {
    _provider.close();
    super.dispose();
  }
}
EOF
cat > lib/core/network/rest/timeout/timeout_handler.dart << 'EOF'
import 'package:http/http.dart' as http;

class TimeoutHandler {
  final Duration timeout;

  TimeoutHandler(this.timeout);

  Future<http.Response?> run(Future<http.Response> Function() fn) async {
    try {
      return await fn().timeout(timeout);
    } catch (_) {
      return null;
    }
  }
}
EOF
cat > lib/core/bloc/mixins/side_effect_queue.dart << 'EOF'
mixin SideEffectQueue<E> on BlocBase<E> {
  final List<E> _effects = [];

  void addEffect(E effect) => _effects.add(effect);

  List<E> consumeEffects() {
    final copy = List<E>.from(_effects);
    _effects.clear();
    return copy;
  }
}
EOF
cat > lib/core/widgets/mixins/safe_widget_dispose.dart << 'EOF'
import 'dart:async';
import 'package:flutter/widgets.dart';

mixin SafeWidgetDispose<T extends StatefulWidget> on State<T> {
  final List<StreamSubscription> _subs = [];
  final List<AnimationController> _controllers = [];

  void trackSub(StreamSubscription sub) => _subs.add(sub);

  void trackController(AnimationController controller) =>
      _controllers.add(controller);

  @override
  void dispose() {
    for (final sub in _subs) sub.cancel();
    _subs.clear();
    for (final controller in _controllers) controller.dispose();
    _controllers.clear();
    super.dispose();
  }
}
EOF
cat > lib/core/ui/theme_notifier.dart << 'EOF'
import 'package:flutter/material.dart';

class ThemeNotifier extends ChangeNotifier {
  ThemeMode _mode = ThemeMode.system;

  ThemeMode get mode => _mode;

  void setMode(ThemeMode value) {
    _mode = value;
    notifyListeners();
  }
}
EOF
cat > lib/core/time/iso_date_normalizer.dart << 'EOF'
class IsoDateNormalizer {
  static String normalize(dynamic value) {
    try {
      return DateTime.parse(value.toString()).toUtc().toIso8601String();
    } catch (_) {
      return DateTime.now().toUtc().toIso8601String();
    }
  }
}
EOF
cat > lib/core/chart/data/chart_data_stitcher.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

class ChartDataStitcher {
  List<CandleEntity> merge(
      List<CandleEntity> history, List<CandleEntity> live) {
    final Map<int, CandleEntity> map = {};
    for (final c in history) {
      map[c.timeUtc.millisecondsSinceEpoch] = c;
    }
    for (final c in live) {
      map[c.timeUtc.millisecondsSinceEpoch] = c;
    }
    final keys = map.keys.toList()..sort();
    return keys.map((k) => map[k]!).toList();
  }
}
EOF
cat > lib/features/market_depth/domain/order_book_sync.dart << 'EOF'
import 'dart:async';

class OrderBookSync {
  final _queue = StreamController<Function()>();

  OrderBookSync() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  void process(Function() updateFn) => _queue.add(updateFn);

  Future<void> dispose() async => _queue.close();
}
EOF
cat > lib/features/trading/domain/execution/slippage_guard.dart << 'EOF'
class SlippageGuard {
  final double maxSlippage; 

  SlippageGuard(this.maxSlippage);

  double apply(double price, double slippagePct) {
    final change = price * (slippagePct / 100);
    return price + change.clamp(-maxSlippage, maxSlippage);
  }
}
EOF
cat > lib/core/network/ws/security/ws_certificate_pinning.dart << 'EOF'
import 'dart:io';
import 'package:web_socket_channel/io.dart';

class WsCertPinning {
  static IOWebSocketChannel connectPinned(
      String url, SecurityContext context) {
    return IOWebSocketChannel.connect(
      url,
      customClient: HttpClient(context: context),
    );
  }
}
EOF
cat > lib/core/security/secure_storage_manager.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class SecureStorageManager {
  static final _storage = FlutterSecureStorage();

  static Future<void> saveToken(String key, String token) =>
      _storage.write(key: key, value: token);

  static Future<String?> readToken(String key) =>
      _storage.read(key: key);

  static Future<void> deleteToken(String key) =>
      _storage.delete(key: key);
}
EOF
cat > lib/core/network/rest/throttle/rest_throttle.dart << 'EOF'
import 'dart:async';

class RestThrottle {
  final Duration interval;
  DateTime _last = DateTime.fromMillisecondsSinceEpoch(0);

  RestThrottle(this.interval);

  bool canFetch() {
    if (DateTime.now().difference(_last) >= interval) {
      _last = DateTime.now();
      return true;
    }
    return false;
  }
}
EOF
cat > lib/core/state/paging/paging_guard.dart << 'EOF'
class PagingGuard {
  final Set<int> loadedPages = {};

  bool canLoad(int page) {
    if (loadedPages.contains(page)) return false;
    loadedPages.add(page);
    return true;
  }
}
EOF
cat > lib/core/network/ws/manager/ws_switch_manager.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class WsSwitchManager {
  WebSocketChannel? _currentChannel;
  StreamSubscription? _currentSub;

  void switchTo(String url, void Function(dynamic) onData) {
    // Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    _currentSub?.cancel();
    _currentChannel?.sink.close();

    // ÙØªØ­ Ø¬Ø¯ÙŠØ¯
    _currentChannel = WebSocketChannel.connect(Uri.parse(url));
    _currentSub = _currentChannel!.stream.listen(onData);
  }

  Future<void> dispose() async {
    await _currentSub?.cancel();
    _currentChannel?.sink.close();
    _currentChannel = null;
    _currentSub = null;
  }
}
EOF
cat > lib/core/chart/gap/gap_fill_manager.dart << 'EOF'
import '../../../../core/models/candle_entity.dart';

class GapFillManager {
  static List<CandleEntity> fill(
      List<CandleEntity> data, Duration interval) {
    final List<CandleEntity> filled = [];
    if (data.isEmpty) return filled;

    for (int i = 0; i < data.length - 1; i++) {
      final current = data[i];
      final next = data[i + 1];
      filled.add(current);

      final gap = next.timeUtc
          .difference(current.timeUtc)
          .inMilliseconds;
      final step = interval.inMilliseconds;

      if (gap > step) {
        final missing = (gap / step).floor() - 1;
        for (int j = 1; j <= missing; j++) {
          final t = current.timeUtc.add(Duration(milliseconds: step * j));
          filled.add(CandleEntity(
            timeUtc: t,
            open: current.close,
            high: current.close,
            low: current.close,
            close: current.close,
            volume: 0,
          ));
        }
      }
    }
    filled.add(data.last);
    return filled;
  }
}
EOF
cat > lib/core/bloc/mixins/stream_controller_guard.dart << 'EOF'
import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';

mixin StreamControllerGuard on BlocBase {
  final List<StreamController> _controllers = [];

  StreamController<T> createController<T>({bool broadcast = false}) {
    final c = broadcast
        ? StreamController<T>.broadcast()
        : StreamController<T>();
    _controllers.add(c);
    return c;
  }

  @override
  Future<void> close() async {
    for (final c in _controllers) {
      await c.close();
    }
    _controllers.clear();
    return super.close();
  }
}
EOF
cat > lib/features/market/presentation/bloc/chart/chart_state_reset.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

class ChartStateReset extends ChartEvent {}

class ChartBlocStateResetFix extends Bloc<ChartEvent, ChartState> {
  ChartBlocStateResetFix(): super(ChartIdle()) {
    on<ChartStateReset>((_, emit) {
      emit(ChartIdle()); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    });
  }
}
EOF
cat > lib/features/market_depth/presentation/bloc/order_book_reset_fix.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

class OrderBookReset extends OrderBookEvent {}

class OrderBookBlocResetFix extends Bloc<OrderBookEvent, OrderBookState> {
  OrderBookBlocResetFix(): super(OrderBookInitial()) {
    on<OrderBookReset>((_, emit) {
      emit(OrderBookInitial(bids: [], asks: []));
    });

    on<SubscribeUpdates>((event, emit) {
      add(OrderBookReset()); // ØªÙ†Ø¸ÙŠÙ
      // Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ Ø§Ø´ØªØ±Ùƒ ÙÙŠ Stream Ø¬Ø¯ÙŠØ¯
    });
  }
}
EOF
cat > lib/core/cache/history_cache_guard.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class HistoryCacheGuard {
  static Future<void> save(
      String symbol, String timeframe, List<Map<String, dynamic>> data) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "$symbol-$timeframe";
    prefs.setString(key, jsonEncode(data));
  }

  static Future<List<Map<String, dynamic>>?> load(
      String symbol, String timeframe) async {
    final prefs = await SharedPreferences.getInstance();
    final key = "$symbol-$timeframe";
    final str = prefs.getString(key);
    if (str == null) return null;
    return (jsonDecode(str) as List).cast<Map<String, dynamic>>();
  }
}
EOF
cat > lib/features/trading/domain/execution/execution_queue.dart << 'EOF'
import 'dart:async';

class ExecutionQueue {
  final _queue = StreamController<Function()>();

  ExecutionQueue() {
    _queue.stream.asyncMap((task) => Future(() => task())).listen((_) {});
  }

  void schedule(Function() exec) => _queue.add(exec);

  Future<void> dispose() => _queue.close();
}
EOF
cat > lib/core/security/token_refresh_guard.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class TokenRefreshGuard {
  final FlutterSecureStorage _storage = const FlutterSecureStorage();

  Future<String?> refresh(String oldToken) async {
    try {
      // logic to refresh via REST
      final newToken = oldToken + "_refreshed"; 
      await _storage.write(key: "apiToken", value: newToken);
      return newToken;
    } catch (_) {
      return null;
    }
  }
}
EOF
cat > lib/features/watchlist/domain/watchlist_clean_guard.dart << 'EOF'
class WatchlistCleanGuard {
  static void clean(String symbol, Map cache) {
    cache.remove(symbol);
  }
}
EOF
cat > lib/core/compute/history_fetch_isolate.dart << 'EOF'
import 'dart:isolate';

class HistoryFetchIsolate {
  static Future<List<dynamic>> run(fetchFn) =>
      Isolate.run(() => fetchFn());
}
EOF
cat > lib/core/network/manager/network_mode_coordinator.dart << 'EOF'
import 'dart:async';
import '../network_observer.dart';

class NetworkModeCoordinator {
  bool _isOffline = false;
  final List<Function()> _onReconnectTasks = [];

  void updateState(NetState state) {
    if (state == NetState.offline) {
      _isOffline = true;
    } else {
      if (_isOffline) {
        _isOffline = false;
        _runReconnectTasks();
      }
    }
  }

  void scheduleOnReconnect(Function() task) {
    _onReconnectTasks.add(task);
  }

  void _runReconnectTasks() {
    for (final t in _onReconnectTasks) {
      t();
    }
    _onReconnectTasks.clear();
  }
}
EOF
cat > lib/features/chart/data/storage/chart_view_state_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';

class ChartViewStateStorage {
  static const _key = "chart_view_state";

  static Future<void> save(Map<String, dynamic> state) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString(_key, jsonEncode(state));
  }

  static Future<Map<String, dynamic>?> load() async {
    final prefs = await SharedPreferences.getInstance();
    final str = prefs.getString(_key);
    return str == null ? null : jsonDecode(str);
  }
}
EOF
cat > lib/features/indicators/render/batch_indicator_renderer.dart << 'EOF'
import 'dart:ui';

class BatchIndicatorRenderer {
  void draw(Canvas canvas, Size size, List<Function(Canvas, Size)> draws) {
    for (final drawFn in draws) {
      drawFn(canvas, size);
    }
  }
}
EOF
cat > lib/core/network/rest/guard/rest_fetch_guard.dart << 'EOF'
class RestFetchGuard {
  final Map<String, dynamic> _cache = {};

  bool shouldFetch(String key) => !_cache.containsKey(key);

  void save(String key, dynamic value) => _cache[key] = value;

  dynamic get(String key) => _cache[key];
}
EOF
cat > lib/core/ui/fonts/text_style_manager.dart << 'EOF'
import 'package:flutter/material.dart';

class TextStyleManager {
  static TextStyle headline(BuildContext ctx) =>
      Theme.of(ctx).textTheme.headline6!;

  static TextStyle body(BuildContext ctx) =>
      Theme.of(ctx).textTheme.bodyText2!;
}
EOF
cat > lib/core/state/empty/empty_state.dart << 'EOF'
abstract class EmptyState {}

class LoadingState {}

class HasDataState<T> {
  final T data;
  HasDataState(this.data);
}

class NoDataState extends EmptyState {}
EOF
cat > lib/core/notifications/notification_service.dart << 'EOF'
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  final _flutterNotif = FlutterLocalNotificationsPlugin();

  Future<void> init() async {
    const android = AndroidInitializationSettings('@mipmap/ic_launcher');
    const settings = InitializationSettings(android: android);
    await _flutterNotif.initialize(settings);
  }

  Future<void> show(String title, String body) async {
    const androidDetails = AndroidNotificationDetails(
      "channel_id",
      "channel_name",
      importance: Importance.max,
    );
    await _flutterNotif.show(0, title, body, NotificationDetails(android: androidDetails));
  }
}
EOF
cat > lib/core/state/paging/paging_tracker.dart << 'EOF'
class PagingTracker {
  final Set<int> _loadedPages = {};

  bool canLoad(int page) {
    if (_loadedPages.contains(page)) return false;
    _loadedPages.add(page);
    return true;
  }
}
EOF
cat > lib/core/storage/transactional_file_saver.dart << 'EOF'
import 'dart:io';

class TransactionalFileSaver {
  static Future<void> safeWrite(String path, String data) async {
    final temp = File(path + ".tmp");
    await temp.writeAsString(data);
    final original = File(path);
    await temp.rename(original.path);
  }
}
EOF
cat > lib/core/state/guard/state_transition_locker.dart << 'EOF'
class StateTransitionLocker {
  bool _processing = false;

  Future<void> safeTransition(Future<void> Function() fn) async {
    if (_processing) return;
    _processing = true;
    await fn();
    _processing = false;
  }
}
EOF
cat > lib/features/trading/domain/execution/execution_snapshot_guard.dart << 'EOF'
import '../../../../../core/state/shared/price_volume_state.dart';

class ExecutionSnapshotGuard {
  final PriceVolumeState _stateHolder;

  ExecutionSnapshotGuard(this._stateHolder);

  Map<String, double> snapshot() {
    return {
      "price": _stateHolder.price,
      "volume": _stateHolder.volume,
    };
  }
}
EOF
cat > lib/features/backtest/domain/engine/backtest_completion_guard.dart << 'EOF'
class BacktestCompletionGuard {
  bool _done = false;

  void markDone() => _done = true;
  bool get isDone => _done;

  void reset() => _done = false;
}
EOF
cat > lib/core/network/ws/parsers/safe_depth_parser.dart << 'EOF'
Map<String, dynamic>? parseSafeDepth(Map<String, dynamic>? data) {
  if (data == null) return null;
  if (!data.containsKey('bids') || !data.containsKey('asks')) return null;
  return {
    'bids': data['bids'] ?? [],
    'asks': data['asks'] ?? [],
  };
}
EOF
cat > lib/core/storage/file_write_safe.dart << 'EOF'
import 'dart:io';

class FileWriteSafe {
  static Future<void> save(String path, String content) async {
    final tmp = File("$path.tmp");
    await tmp.writeAsString(content);
    final original = File(path);
    if (await original.exists()) {
      await original.delete();
    }
    await tmp.rename(path);
  }
}
EOF
cat > lib/core/sync/indicator_throttler.dart << 'EOF'
import 'dart:async';

class IndicatorThrottler {
  final Duration delay;
  Timer? _timer;
  List<dynamic> _pending = [];

  IndicatorThrottler({this.delay = const Duration(milliseconds: 50)});

  void add(dynamic data, void Function(List<dynamic>) compute) {
    _pending.add(data);
    _timer?.cancel();
    _timer = Timer(delay, () {
      compute(_pending);
      _pending.clear();
    });
  }
}
EOF
cat > lib/core/network/ws/registry/ws_subscription_registry.dart << 'EOF'
import 'dart:async';

class WsSubscriptionRegistry {
  final List<StreamSubscription> _subs = [];

  void register(StreamSubscription sub) => _subs.add(sub);

  Future<void> clearAll() async {
    for (final sub in _subs) {
      await sub.cancel();
    }
    _subs.clear();
  }
}
EOF
cat > lib/core/startup/loading_coordinator.dart << 'EOF'
class LoadingCoordinator {
  bool _done = false;

  void markDone() => _done = true;
  bool get isDone => _done;
}
EOF
cat > lib/features/trading/presentation/bloc/orders_update_guard.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

class OrdersUpdateGuardBloc extends Bloc<OrdersEvent, OrdersState> {
  OrdersUpdateGuardBloc(): super(OrdersIdle()) {
    on<OrderExecuted>((evt, emit) {
      // immediate update after execution
      emit(OrdersUpdated(evt.updatedList));
    });
  }
}
EOF
cat > lib/core/chart/filter/chart_filter_fix.dart << 'EOF'
import '../../core/models/candle_entity.dart';

class ChartFilterFix {
  static List<CandleEntity> applyRange(
      List<CandleEntity> data, double minPrice, double maxPrice) {
    return data.where((c) =>
        c.high >= minPrice && c.low <= maxPrice).toList();
  }
}
EOF
cat > lib/core/models/factories/candle_factory.dart << 'EOF'
import '../candle_entity.dart';

class CandleFactory {
  static CandleEntity fromJson(Map<String, dynamic>? json) {
    return CandleEntity(
      timeUtc: DateTime.tryParse(json?['time'] ?? '') ?? DateTime.now().toUtc(),
      open: (json?['open'] as num?)?.toDouble() ?? 0.0,
      high: (json?['high'] as num?)?.toDouble() ?? 0.0,
      low: (json?['low'] as num?)?.toDouble() ?? 0.0,
      close: (json?['close'] as num?)?.toDouble() ?? 0.0,
      volume: (json?['volume'] as num?)?.toDouble() ?? 0.0,
    );
  }
}
EOF
cat > lib/features/chart/domain/drawing/draw_tool_mapping_fix.dart << 'EOF'
import 'package:flutter/material.dart';

class DrawToolMappingFix {
  static Offset toScreen(
      {required DateTime time,
      required double price,
      required DateTime start,
      required DateTime end,
      required double minPrice,
      required double maxPrice,
      required Size size}) {
    final px = (time.millisecondsSinceEpoch - start.millisecondsSinceEpoch) /
        (end.millisecondsSinceEpoch - start.millisecondsSinceEpoch);
    final py = (price - minPrice) / (maxPrice - minPrice);

    return Offset(px * size.width, (1 - py) * size.height);
  }

  static Map<String, dynamic> fromScreen(Offset point, Size size,
      DateTime start, DateTime end, double minPrice, double maxPrice) {
    final px = point.dx / size.width;
    final py = 1 - (point.dy / size.height);

    final time = DateTime.fromMillisecondsSinceEpoch(
        start.millisecondsSinceEpoch +
            (end.millisecondsSinceEpoch - start.millisecondsSinceEpoch) *
                px.toInt());
    final price = minPrice + (maxPrice - minPrice) * py;
    return {"time": time, "price": price};
  }
}
EOF
cat > lib/features/trading/domain/simulation/sim_order_ring_buffer.dart << 'EOF'
class SimOrderRingBuffer<T> {
  final int capacity;
  final List<T> _vals = [];
  int _idx = 0;

  SimOrderRingBuffer(this.capacity);

  void add(T val) {
    if (_vals.length < capacity) {
      _vals.add(val);
    } else {
      _vals[_idx] = val;
      _idx = (_idx + 1) % capacity;
    }
  }

  List<T> list() => List.unmodifiable(_vals);
}
EOF
cat > lib/core/network/ws/smart/ws_smart_reconnect_fix.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';

class WSSmartReconnectFix {
  WebSocketChannel? _chan;
  final String url;
  Timer? _retry;
  int _fails = 0;

  WSSmartReconnectFix(this.url);

  void connect(void Function(dynamic) onData) {
    _chan?.sink.close();
    _chan = WebSocketChannel.connect(Uri.parse(url));
    _chan!.stream.listen(onData, onError: (_) => scheduleReconnect(onData),
        onDone: () => scheduleReconnect(onData));
    _fails = 0;
  }

  void scheduleReconnect(void Function(dynamic) onData) {
    _retry?.cancel();
    _fails++;
    final delay = Duration(seconds: 2 * _fails);
    _retry = Timer(delay, () => connect(onData));
  }

  void dispose() {
    _retry?.cancel();
    _chan?.sink.close();
  }
}
EOF
cat > lib/core/bloc/mixins/event_guard.dart << 'EOF'
mixin EventGuard<T> {
  bool isValidEvent(T event) {
    if (event == null) return false;
    return true;
  }
}
EOF
cat > lib/core/models/adapters/candle_entity_adapter.dart << 'EOF'
import 'package:hive/hive.dart';
import '../candle_entity.dart';

class CandleEntityAdapter extends TypeAdapter<CandleEntity> {
  @override
  final typeId = 1;

  @override
  CandleEntity read(BinaryReader reader) {
    return CandleEntity(
      timeUtc: DateTime.fromMillisecondsSinceEpoch(reader.readInt()),
      open: reader.readDouble(),
      high: reader.readDouble(),
      low: reader.readDouble(),
      close: reader.readDouble(),
      volume: reader.readDouble(),
    );
  }

  @override
  void write(BinaryWriter writer, CandleEntity obj) {
    writer.writeInt(obj.timeUtc.millisecondsSinceEpoch);
    writer.writeDouble(obj.open);
    writer.writeDouble(obj.high);
    writer.writeDouble(obj.low);
    writer.writeDouble(obj.close);
    writer.writeDouble(obj.volume);
  }
}
EOF
cat > lib/core/bloc/bloc_observer.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

class AppBlocObserver extends BlocObserver {
  @override
  void onEvent(Bloc bloc, Object? event) {
    super.onEvent(bloc, event);
    // debugPrint('Bloc Event: $event');
  }

  @override
  void onChange(BlocBase bloc, Change change) {
    super.onChange(bloc, change);
    // debugPrint('Bloc Change: $change');
  }

  @override
  void onError(BlocBase bloc, Object error, StackTrace stackTrace) {
    super.onError(bloc, error, stackTrace);
    // debugPrint('Bloc Error: $error');
  }
}
EOF
cat > lib/core/di/dependency_injection.dart << 'EOF'
import 'package:get_it/get_it.dart';
import 'package:hive/hive.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

final injector = GetIt.instance;

Future<void> setupDependencies() async {
  // Storage
  injector.registerSingleton<FlutterSecureStorage>(const FlutterSecureStorage());

  // Hive Boxes
  await Hive.openBox('app_settings');
  await Hive.openBox('history_cache');

  // Add other deps as needed e.g.
  // injector.registerSingleton<ApiService>(ApiService());
}
EOF
cat > lib/core/di/hive_init.dart << 'EOF'
import 'package:hive_flutter/hive_flutter.dart';

import '../models/adapters/candle_entity_adapter.dart';

Future<void> initHive() async {
  await Hive.initFlutter();

  Hive.registerAdapter(CandleEntityAdapter());
}
EOF
cat > lib/core/navigation/app_router.dart << 'EOF'
import 'package:go_router/go_router.dart';
import 'package:flutter/material.dart';

import '../../features/home/presentation/pages/home_page.dart';
import '../../features/chart/presentation/pages/chart_page.dart';
import '../../features/settings/presentation/pages/settings_page.dart';
import '../../features/trading/presentation/pages/trading_page.dart';
import '../../features/backtest/presentation/pages/backtest_page.dart';

final appRouter = GoRouter(
  initialLocation: '/',
  routes: [
    GoRoute(
      name: 'home',
      path: '/',
      builder: (context, state) => HomePage(),
    ),
    GoRoute(
      name: 'chart',
      path: '/chart',
      builder: (context, state) => ChartPage(),
    ),
    GoRoute(
      name: 'settings',
      path: '/settings',
      builder: (context, state) => SettingsPage(),
    ),
    GoRoute(
      name: 'trading',
      path: '/trading',
      builder: (context, state) => TradingPage(),
    ),
    GoRoute(
      name: 'backtest',
      path: '/backtest',
      builder: (context, state) => BacktestPage(),
    ),
  ],
);
EOF
cat > lib/core/ui/theme_setup.dart << 'EOF'
import 'package:flutter/material.dart';

final lightTheme = ThemeData.light().copyWith(
  primaryColor: Colors.blue,
  scaffoldBackgroundColor: Colors.white,
);

final darkTheme = ThemeData.dark().copyWith(
  primaryColor: Colors.blueGrey,
);
EOF
cat > lib/core/startup/loading_coordinator.dart << 'EOF'
class LoadingCoordinator {
  bool isDone = false;

  void complete() {
    isDone = true;
  }
}
EOF
cat > lib/features/home/presentation/pages/home_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Home"),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            ElevatedButton(
                onPressed: () => context.go('/chart'),
                child: Text("Open Chart")),
            ElevatedButton(
                onPressed: () => context.go('/settings'),
                child: Text("Settings")),
            ElevatedButton(
                onPressed: () => context.go('/trading'),
                child: Text("Trading")),
            ElevatedButton(
                onPressed: () => context.go('/backtest'),
                child: Text("Backtest")),
          ],
        ),
      ),
    );
  }
}
EOF
cat > lib/features/chart/presentation/pages/chart_page.dart << 'EOF'
import 'package:flutter/material.dart';

class ChartPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Chart Screen"),
      ),
      body: Center(child: Text("Chart Functionality Placeholder")),
    );
  }
}
EOF
cat > lib/features/settings/presentation/pages/settings_page.dart << 'EOF'
import 'package:flutter/material.dart';

class SettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Settings"),
      ),
      body: Center(child: Text("Settings Placeholder")),
    );
  }
}
EOF
cat > lib/features/trading/presentation/pages/trading_page.dart << 'EOF'
import 'package:flutter/material.dart';

class TradingPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Trading"),
      ),
      body: Center(child: Text("Trading Functionality Placeholder")),
    );
  }
}
EOF
cat > lib/features/backtest/presentation/pages/backtest_page.dart << 'EOF'
import 'package:flutter/material.dart';

class BacktestPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Backtest"),
      ),
      body: Center(child: Text("Backtest Placeholder")),
    );
  }
}
EOF
cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:hive_flutter/hive_flutter.dart';

import 'core/bloc/bloc_observer.dart';
import 'core/di/dependency_injection.dart';
import 'core/di/hive_init.dart';
import 'core/navigation/app_router.dart';
import 'core/ui/theme_setup.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Bloc Observer
  Bloc.observer = AppBlocObserver();

  // Setup Dependencies
  await initHive();
  await setupDependencies();

  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  final GoRouter _router = appRouter;

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: 'Trading App',
      theme: lightTheme,
      darkTheme: darkTheme,
      routerConfig: _router,
      debugShowCheckedModeBanner: false,
    );
  }
}
EOF
cat > lib/core/network/oanda/oanda_config.dart << 'EOF'
class OandaConfig {
  static const String restBaseUrl = "https://api-fxpractice.oanda.com/v3";
  static const String streamBaseUrl = "https://stream-fxpractice.oanda.com/v3";
  static const String tokenKey = "oanda_token";
  static const String accountKey = "oanda_account";
}
EOF
cat > lib/core/security/secure_storage_manager.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class SecureStorageManager {
  static final _storage = FlutterSecureStorage();

  static Future<void> saveOandaToken(String token) =>
      _storage.write(key: OandaConfig.tokenKey, value: token);

  static Future<String?> readOandaToken() =>
      _storage.read(key: OandaConfig.tokenKey);

  static Future<void> saveOandaAccount(String id) =>
      _storage.write(key: OandaConfig.accountKey, value: id);

  static Future<String?> readOandaAccount() =>
      _storage.read(key: OandaConfig.accountKey);
}
EOF
cat > lib/core/network/oanda/client/oanda_rest_client.dart << 'EOF'
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaRestClient {
  Future<http.Response> _call(String url) async {
    final token = await SecureStorageManager.readOandaToken();
    final headers = {
      "Authorization": "Bearer \$token",
      "Content-Type": "application/json",
    };
    return http.get(Uri.parse(url), headers: headers);
  }

  Future<List<String>> fetchInstruments() async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/accounts/\$accountId/instruments";
    final res = await _call(url);
    if (res.statusCode == 200) {
      final json = jsonDecode(res.body);
      final list = json["instruments"] as List;
      return list.map((i) => i["name"].toString()).toList();
    }
    throw Exception("OANDA fetchInstruments failed: \${res.body}");
  }

  Future<List<Map<String, dynamic>>> fetchCandles(
      String symbol, String granularity) async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/instruments/\$symbol/candles?granularity=\$granularity&count=500";
    final res = await _call(url);
    if (res.statusCode == 200) {
      final json = jsonDecode(res.body);
      final candles = json["candles"] as List;
      return candles.map((c) => c as Map<String, dynamic>).toList();
    }
    throw Exception("OANDA fetchCandles failed: \${res.body}");
  }
}
EOF
cat > lib/core/network/oanda/stream/oanda_stream_client.dart << 'EOF'
import 'package:web_socket_channel/web_socket_channel.dart';
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaStreamClient {
  WebSocketChannel? _channel;

  void connect(String symbol, Function(dynamic

// ========================================

// ==== Code Block 1706 ====
cat > lib/core/network/oanda/stream/oanda_ws_client.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaWSClient {
  WebSocketChannel? _channel;
  StreamSubscription? _subs;

  void connect(String symbol, void Function(dynamic) onData,
      {void Function()? onDone, void Function(dynamic)? onError}) async {
    final token = await SecureStorageManager.readOandaToken();
    final url =
        "\${OandaConfig.streamBaseUrl}/accounts/\${await SecureStorageManager.readOandaAccount()}/pricing/stream?instruments=\$symbol";
    _channel = WebSocketChannel.connect(
      Uri.parse(url),
      headers: {"Authorization": "Bearer \$token"},
    );

    _subs = _channel!.stream.listen(
      onData,
      onError: onError,
      onDone: onDone,
    );
  }

  void disconnect() {
    _subs?.cancel();
    _channel?.sink.close();
  }
}
EOF
cat > lib/features/market/data/oanda_market_repository.dart << 'EOF'
import '../../../../core/network/oanda/client/oanda_rest_client.dart';
import '../../../../core/network/oanda/stream/oanda_ws_client.dart';

class OandaMarketRepository {
  final OandaRestClient _rest = OandaRestClient();
  final OandaWSClient _ws = OandaWSClient();

  Future<List<String>> getInstruments() => _rest.fetchInstruments();

  Future<List<Map<String, dynamic>>> getCandles(
          String symbol, String timeframe) =>
      _rest.fetchCandles(symbol, timeframe);

  void subscribePricing(String symbol, void Function(dynamic) onData) {
    _ws.connect(symbol, onData);
  }

  void unsubscribe() {
    _ws.disconnect();
  }
}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../data/oanda_market_repository.dart';

part 'oanda_event.dart';
part 'oanda_state.dart';

class OandaBloc extends Bloc<OandaEvent, OandaState> {
  final OandaMarketRepository repo;

  OandaBloc(this.repo) : super(OandaInitial()) {
    on<LoadInstruments>((_, emit) async {
      emit(OandaLoading());
      try {
        final list = await repo.getInstruments();
        emit(OandaLoaded(list));
      } catch (e) {
        emit(OandaError(e.toString()));
      }
    });
  }
}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_event.dart << 'EOF'
part of 'oanda_bloc.dart';

abstract class OandaEvent {}
class LoadInstruments extends OandaEvent {}
EOF
cat > lib/features/market/presentation/bloc/oanda/oanda_state.dart << 'EOF'
part of 'oanda_bloc.dart';

abstract class OandaState {}
class OandaInitial extends OandaState {}
class OandaLoading extends OandaState {}
class OandaLoaded extends OandaState {
  final List<String> instruments;
  OandaLoaded(this.instruments);
}
class OandaError extends OandaState {
  final String message;
  OandaError(this.message);
}
EOF
cat > lib/features/chart/presentation/bloc/candles_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../market/data/oanda_market_repository.dart';

part 'candles_event.dart';
part 'candles_state.dart';

class CandlesBloc extends Bloc<CandlesEvent, CandlesState> {
  final OandaMarketRepository repo;

  CandlesBloc(this.repo) : super(CandlesInitial()) {
    on<LoadCandles>((event, emit) async {
      emit(CandlesLoading());
      try {
        final data = await repo.getCandles(event.symbol, event.timeframe);
        emit(CandlesLoaded(data));
      } catch (e) {
        emit(CandlesError(e.toString()));
      }
    });
  }
}
EOF
cat > lib/features/chart/presentation/bloc/candles_event.dart << 'EOF'
part of 'candles_bloc.dart';

abstract class CandlesEvent {}
class LoadCandles extends CandlesEvent {
  final String symbol;
  final String timeframe;
  LoadCandles(this.symbol, this.timeframe);
}
EOF
cat > lib/features/chart/presentation/bloc/candles_state.dart << 'EOF'
part of 'candles_bloc.dart';

abstract class CandlesState {}
class CandlesInitial extends CandlesState {}
class CandlesLoading extends CandlesState {}
class CandlesLoaded extends CandlesState {
  final List<Map<String, dynamic>> raw;
  CandlesLoaded(this.raw);
}
class CandlesError extends CandlesState {
  final String message;
  CandlesError(this.message);
}
EOF
cat > lib/features/settings/presentation/pages/settings_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../../core/security/secure_storage_manager.dart';

class SettingsPage extends StatefulWidget {
  @override
  _SettingsPageState createState() => _SettingsPageState();
}

class _SettingsPageState extends State<SettingsPage> {
  final _tokenCtrl = TextEditingController();
  final _accCtrl = TextEditingController();

  @override
  void initState() {
    super.initState();
    SecureStorageManager.readOandaToken().then((t) {
      if (t != null) _tokenCtrl.text = t;
    });
    SecureStorageManager.readOandaAccount().then((a) {
      if (a != null) _accCtrl.text = a;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("OANDA Settings")),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(children: [
          TextField(
            controller: _tokenCtrl,
            decoration: InputDecoration(labelText: "API Token"),
          ),
          TextField(
            controller: _accCtrl,
            decoration: InputDecoration(labelText: "Account ID"),
          ),
          SizedBox(height: 20),
          ElevatedButton(
            onPressed: () async {
              await SecureStorageManager.saveOandaToken(_tokenCtrl.text);
              await SecureStorageManager.saveOandaAccount(_accCtrl.text);
              ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(content: Text("Saved OANDA Credentials")));
            },
            child: Text("Save"),
          ),
        ]),
      ),
    );
  }
}
EOF
cat > lib/features/home/presentation/pages/home_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../features/market/presentation/bloc/oanda/oanda_bloc.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Home")),
      body: Column(
        children: [
          ElevatedButton(
              onPressed: () =>
                  context.go('/settings'),
              child: Text("Settings")),
          SizedBox(height: 20),
          ElevatedButton(
            onPressed: () =>
                context.read<OandaBloc>().add(LoadInstruments()),
            child: Text("Fetch OANDA Instruments"),
          ),
          Expanded(
            child: BlocBuilder<OandaBloc, OandaState>(
              builder: (context, state) {
                if (state is OandaLoading)
                  return Center(child: CircularProgressIndicator());
                if (state is OandaLoaded)
                  return ListView.builder(
                    itemCount: state.instruments.length,
                    itemBuilder: (context, i) => ListTile(
                      title: Text(state.instruments[i]),
                      onTap: () => context.go('/chart',
                          extra: state.instruments[i]),
                    ),
                  );
                if (state is OandaError)
                  return Center(child: Text(state.message));
                return Center(child: Text("No Data"));
              },
            ),
          )
        ],
      ),
    );
  }
}
EOF
cat > lib/features/chart/presentation/pages/chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../presentation/bloc/candles_bloc.dart';

class ChartPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final String symbol =
        ModalRoute.of(context)?.settings.arguments as String? ?? "";
    return Scaffold(
      appBar: AppBar(title: Text("Chart: \$symbol")),
      body: Column(
        children: [
          ElevatedButton(
            onPressed: () => context
                .read<CandlesBloc>()
                .add(LoadCandles(symbol, "M1")),
            child: Text("Load 1m Candles"),
          ),
          Expanded(
            child: BlocBuilder<CandlesBloc, CandlesState>(
              builder: (context, state) {
                if (state is CandlesLoading)
                  return Center(child: CircularProgressIndicator());
                if (state is CandlesLoaded) {
                  return ListView.builder(
                    itemCount: state.raw.length,
                    itemBuilder: (ctx, i) {
                      final c = state.raw[i];
                      return ListTile(
                        title: Text(
                            "\${c["time"]} O: \${c["open"]} C: \${c["close"]}"),
                      );
                    },
                  );
                }
                if (state is CandlesError)
                  return Center(child: Text(state.message));
                return Center(child: Text("No Data"));
              },
            ),
          )
        ],
      ),
    );
  }
}
EOF
cat > lib/main.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'core/bloc/bloc_observer.dart';
import 'core/di/dependency_injection.dart';
import 'core/di/hive_init.dart';
import 'core/navigation/app_router.dart';
import 'core/ui/theme_setup.dart';

import 'features/market/presentation/bloc/oanda/oanda_bloc.dart';
import 'features/market/data/oanda_market_repository.dart';
import 'features/chart/presentation/bloc/candles_bloc.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  Bloc.observer = AppBlocObserver();

  await initHive();
  await setupDependencies();

  final repo = OandaMarketRepository();

  runApp(
    MultiBlocProvider(
      providers: [
        BlocProvider(create: (_) => OandaBloc(repo)),
        BlocProvider(create: (_) => CandlesBloc(repo)),
      ],
      child: MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: 'Trading App',
      theme: lightTheme,
      darkTheme: darkTheme,
      routerConfig: appRouter,
      debugShowCheckedModeBanner: false,
    );
  }
}
EOF
cat > assets/lightweight_charts/chart.html << 'EOF'
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="lightweight-charts.standalone.production.js"></script>
    <style>
      html, body { margin:0; padding:0; overflow:hidden; }
      #chart { width:100%; height:100%; }
    </style>
  </head>
  <body>
    <div id="chart"></div>
    <script>
      const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { backgroundColor: 'white', textColor: 'black' },
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a', downColor: '#ef5350',
        wickUpColor: '#26a69a', wickDownColor: '#ef5350'
      });

      function setCandles(data) {
        candleSeries.setData(data);
      }

      function updateLastCandle(candle) {
        candleSeries.update(candle);
      }
    </script>
  </body>
</html>
EOF
cat > lib/features/chart/presentation/widgets/chart_webview.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class ChartWebView extends StatefulWidget {
  final List<Map<String, dynamic>> initialCandles;
  ChartWebView({required this.initialCandles});

  @override
  _ChartWebViewState createState() => _ChartWebViewState();
}

class _ChartWebViewState extends State<ChartWebView> {
  late WebViewController _ctrl;

  @override
  Widget build(BuildContext context) {
    return WebView(
      initialUrl: 'about:blank',
      javascriptMode: JavascriptMode.unrestricted,
      onWebViewCreated: (controller) async {
        _ctrl = controller;
        await controller.loadFlutterAsset("assets/lightweight_charts/chart.html");
        _setInitialData();
      },
    );
  }

  void _setInitialData() {
    final data = widget.initialCandles.map((c) {
      return {
        "time": c["time"],
        "open": c["open"],
        "high": c["high"],
        "low": c["low"],
        "close": c["close"]
      };
    }).toList();
    final js = "setCandles(${data.toString()});";
    _ctrl.runJavascript(js);
  }

  void updateLive(Map<String, dynamic> candle) {
    final js = "updateLastCandle(${candle.toString()});";
    _ctrl.runJavascript(js);
  }
}
EOF
cat > lib/features/chart/presentation/bloc/live_chart/live_chart_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

part 'live_chart_event.dart';
part 'live_chart_state.dart';

class LiveChartBloc extends Bloc<LiveChartEvent, LiveChartState> {
  LiveChartBloc(): super(LiveChartInitial());

  on<LoadLiveCandles>((event, emit) {
    emit(LiveChartLoaded(event.candles));
  });

  on<UpdateLiveCandle>((event, emit) {
    emit(LiveCandleUpdated(event.candle));
  });
}
EOF
cat > lib/features/chart/presentation/bloc/live_chart/live_chart_event.dart << 'EOF'
part of 'live_chart_bloc.dart';

abstract class LiveChartEvent {}
class LoadLiveCandles extends LiveChartEvent {
  final List<Map<String, dynamic>> candles;
  LoadLiveCandles(this.candles);
}
class UpdateLiveCandle extends LiveChartEvent {
  final Map<String, dynamic> candle;
  UpdateLiveCandle(this.candle);
}
EOF
cat > lib/features/chart/presentation/bloc/live_chart/live_chart_state.dart << 'EOF'
part of 'live_chart_bloc.dart';

abstract class LiveChartState {}
class LiveChartInitial extends LiveChartState {}
class LiveChartLoaded extends LiveChartState {
  final List<Map<String, dynamic>> candles;
  LiveChartLoaded(this.candles);
}
class LiveCandleUpdated extends LiveChartState {
  final Map<String, dynamic> candle;
  LiveCandleUpdated(this.candle);
}
EOF
cat > lib/features/chart/presentation/pages/chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../presentation/bloc/live_chart/live_chart_bloc.dart';
import '../widgets/chart_webview.dart';

class ChartPage extends StatelessWidget {
  final String symbol;
  ChartPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Chart: \$symbol")),
      body: BlocBuilder<LiveChartBloc, LiveChartState>(
        builder: (context, state) {
          if (state is LiveChartLoaded) {
            return ChartWebView(initialCandles: state.candles);
          }
          return Center(child: CircularProgressIndicator());
        },
      ),
    );
  }
}
EOF
cat > lib/features/indicators/domain/ema_calculator.dart << 'EOF'
class EmaCalculator {
  final int period;
  late double _multiplier;
  double? _prevEma;

  EmaCalculator(this.period) {
    _multiplier = 2.0 / (period + 1);
  }

  double calculate(double price) {
    if (_prevEma == null) {
      _prevEma = price;
    } else {
      _prevEma = (price - _prevEma!) * _multiplier + _prevEma!;
    }
    return _prevEma!;
  }

  void reset() {
    _prevEma = null;
  }
}
EOF
cat > lib/features/indicators/domain/rsi_calculator.dart << 'EOF'
class RsiCalculator {
  final int period;
  final List<double> _gains = [];
  final List<double> _losses = [];

  RsiCalculator(this.period);

  double? calculate(double prevClose, double close) {
    final diff = close - prevClose;
    final gain = diff > 0 ? diff : 0;
    final loss = diff < 0 ? -diff : 0;

    _gains.add(gain);
    _losses.add(loss);

    if (_gains.length > period) {
      _gains.removeAt(0);
      _losses.removeAt(0);
    }

    if (_gains.length < period) return null;

    final avgGain =
        _gains.reduce((a, b) => a + b) / _gains.length;
    final avgLoss =
        _losses.reduce((a, b) => a + b) / _losses.length;

    final rs = avgLoss == 0 ? 100 : avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  }

  void reset() {
    _gains.clear();
    _losses.clear();
  }
}
EOF
cat > lib/features/indicators/presentation/bloc/indicators_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

part 'indicators_event.dart';
part 'indicators_state.dart';

class IndicatorsBloc
    extends Bloc<IndicatorsEvent, IndicatorsState> {
  IndicatorsBloc() : super(IndicatorsInitial()) {
    on<CalculateIndicators>((event, emit) {
      emit(IndicatorsCalculating());
      final emaShort = event.emaShort;
      final emaLong = event.emaLong;
      final rsi = event.rsi;
      emit(IndicatorsLoaded(
        emaShort: emaShort,
        emaLong: emaLong,
        rsi: rsi,
      ));
    });
  }
}
EOF
cat > lib/features/indicators/presentation/bloc/indicators_event.dart << 'EOF'
part of 'indicators_bloc.dart';

abstract class IndicatorsEvent {}

class CalculateIndicators extends IndicatorsEvent {
  final List<double> emaShort;
  final List<double> emaLong;
  final List<double> rsi;

  CalculateIndicators({
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}
EOF
cat > lib/features/indicators/presentation/bloc/indicators_state.dart << 'EOF'
part of 'indicators_bloc.dart';

abstract class IndicatorsState {}

class IndicatorsInitial extends IndicatorsState {}

class IndicatorsCalculating extends IndicatorsState {}

class IndicatorsLoaded extends IndicatorsState {
  final List<double> emaShort;
  final List<double> emaLong;
  final List<double> rsi;

  IndicatorsLoaded({
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}
EOF
cat > assets/lightweight_charts/chart.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="lightweight-charts.standalone.production.js"></script>
  <style>
    html, body, #chart {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="chart"></div>

  <script>
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout: { backgroundColor: '#ffffff', textColor: '#000000' },
      rightPriceScale: { borderColor: '#ccc' },
      timeScale: { borderColor: '#ccc' },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#26a69a', downColor: '#ef5350',
      wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    });

    const emaShortSeries = chart.addLineSeries({
      color: '#2962FF', lineWidth: 2
    });

    const emaLongSeries = chart.addLineSeries({
      color: '#FF6D00', lineWidth: 2
    });

    const rsiChart = LightweightCharts.createChart(document.body, {
      width: document.body.clientWidth,
      height: 150,
    });
    const rsiSeries = rsiChart.addLineSeries({ color: '#8E24AA', lineWidth: 2 });

    window.setCandles = function(data) {
      candleSeries.setData(data);
    }

    window.updateLastCandle = function(candle) {
      candleSeries.update(candle);
    }

    window.setEmaShort = function(data) {
      emaShortSeries.setData(data);
    }

    window.setEmaLong = function(data) {
      emaLongSeries.setData(data);
    }

    window.setRsi = function(data) {
      rsiSeries.setData(data);
    }
  </script>
</body>
</html>
EOF
cat > lib/features/chart/presentation/widgets/chart_webview.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class ChartWebView extends StatefulWidget {
  final List<Map<String, dynamic>> candles;
  final List<Map<String, dynamic>> emaShort;
  final List<Map<String, dynamic>> emaLong;
  final List<Map<String, dynamic>> rsi;

  ChartWebView({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });

  @override
  _ChartWebViewState createState() => _ChartWebViewState();
}

class _ChartWebViewState extends State<ChartWebView> {
  late WebViewController _ctrl;

  @override
  Widget build(BuildContext context) {
    return WebView(
      initialUrl: 'about:blank',
      javascriptMode: JavascriptMode.unrestricted,
      onWebViewCreated: (controller) async {
        _ctrl = controller;
        await controller.loadFlutterAsset("assets/lightweight_charts/chart.html");
        _setInitialData();
      },
    );
  }

  void _setInitialData() {
    _runJs("setCandles(${widget.candles});");
    _runJs("setEmaShort(${widget.emaShort});");
    _runJs("setEmaLong(${widget.emaLong});");
    _runJs("setRsi(${widget.rsi});");
  }

  void updateLastCandle(Map<String, dynamic> candle) {
    _runJs("updateLastCandle($candle);");
  }

  void _runJs(String script) {
    _ctrl.runJavascript(script);
  }
}
EOF
cat > lib/features/chart/presentation/bloc/live_chart/live_chart_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

part 'live_chart_event.dart';
part 'live_chart_state.dart';

class LiveChartBloc extends Bloc<LiveChartEvent, LiveChartState> {
  LiveChartBloc() : super(LiveChartInitial());

  on<LoadLiveCandles>((event, emit) {
    emit(LiveChartLoaded(
      candles: event.candles,
      emaShort: event.emaShort,
      emaLong: event.emaLong,
      rsi: event.rsi,
    ));
  });

  on<UpdateLiveCandle>((event, emit) {
    final state = this.state;
    if (state is LiveChartLoaded) {
      final updatedCandles = List.from(state.candles);
      if (updatedCandles.isNotEmpty) {
        updatedCandles.removeLast();
      }
      updatedCandles.add(event.candle);

      emit(LiveChartLoaded(
        candles: updatedCandles,
        emaShort: event.emaShort,
        emaLong: event.emaLong,
        rsi: event.rsi,
      ));
    }
  });
}
EOF
cat > lib/features/chart/presentation/bloc/live_chart/live_chart_event.dart << 'EOF'
part of 'live_chart_bloc.dart';

abstract class LiveChartEvent {}

class LoadLiveCandles extends LiveChartEvent {
  final List<Map<String, dynamic>> candles;
  final List<Map<String, dynamic>> emaShort;
  final List<Map<String, dynamic>> emaLong;
  final List<Map<String, dynamic>> rsi;

  LoadLiveCandles({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}

class UpdateLiveCandle extends LiveChartEvent {
  final Map<String, dynamic> candle;
  final List<Map<String, dynamic>> emaShort;
  final List<Map<String, dynamic>> emaLong;
  final List<Map<String, dynamic>> rsi;

  UpdateLiveCandle({
    required this.candle,
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}
EOF
cat > lib/features/chart/presentation/bloc/live_chart/live_chart_state.dart << 'EOF'
part of 'live_chart_bloc.dart';

abstract class LiveChartState {}

class LiveChartInitial extends LiveChartState {}

class LiveChartLoaded extends LiveChartState {
  final List<Map<String, dynamic>> candles;
  final List<Map<String, dynamic>> emaShort;
  final List<Map<String, dynamic>> emaLong;
  final List<Map<String, dynamic>> rsi;

  LiveChartLoaded({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
  });
}
EOF
cat > lib/features/chart/presentation/pages/chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../widgets/chart_webview.dart';
import '../../presentation/bloc/live_chart/live_chart_bloc.dart';

class ChartPage extends StatelessWidget {
  final String symbol;
  ChartPage({required this.symbol});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Chart: \$symbol")),
      body: BlocBuilder<LiveChartBloc, LiveChartState>(
        builder: (context, state) {
          if (state is LiveChartLoaded) {
            return ChartWebView(
              candles: state.candles,
              emaShort: state.emaShort,
              emaLong: state.emaLong,
              rsi: state.rsi,
            );
          }
          return Center(child: CircularProgressIndicator());
        },
      ),
    );
  }
}
EOF
cat > lib/features/market/domain/aggregator/candle_aggregator.dart << 'EOF'
import 'dart:collection';

class LiveCandle {
  final int time; // unix seconds
  double open;
  double high;
  double low;
  double close;

  LiveCandle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });

  Map<String, dynamic> toMap() {
    return {
      "time": time,
      "open": open,
      "high": high,
      "low": low,
      "close": close,
    };
  }
}

class CandleAggregator {
  LiveCandle? _currentCandle;
  final Duration timeframe;
  final Queue<Map<String, dynamic>> _pendingTicks = Queue();

  CandleAggregator(this.timeframe);

  /// ÙŠØ­ÙˆÙ‘Ù„ Timestamp Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
  int _alignTime(int unixSeconds) {
    final bucket = timeframe.inSeconds;
    return (unixSeconds ~/ bucket) * bucket;
  }

  /// ÙŠØ³ØªÙ‚Ø¨Ù„ Tick ÙˆÙŠØ­Ø¯Ù‘Ø« Ø§Ù„Ø´Ù…Ø¹Ø© Ø£Ùˆ ÙŠÙ†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
  LiveCandle processTick(Map<String, dynamic> tick) {
    final int ts = tick["time"] as int;
    final double price = tick["price"] as double;
    final alignedTime = _alignTime(ts);

    // Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù…Ø¹Ø© Ø­Ø§Ù„ÙŠØ© -> Ø£Ù†Ø´Ø¦Ù‡Ø§
    if (_currentCandle == null) {
      _currentCandle = LiveCandle(
        time: alignedTime,
        open: price,
        high: price,
        low: price,
        close: price,
      );
      return _currentCandle!;
    }

    // Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø± Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù† -> Ø£ØºÙ„Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø¬Ø¯ÙŠØ¯Ø©
    if (_currentCandle!.time != alignedTime) {
      final closed = _currentCandle!;
      _currentCandle = LiveCandle(
        time: alignedTime,
        open: price,
        high: price,
        low: price,
        close: price,
      );
      return closed; // Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ù…ØºÙ„Ù‚Ø© Ø£ÙˆÙ„Ù‹Ø§
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    _currentCandle!.high =
        price > _currentCandle!.high ? price : _currentCandle!.high;
    _currentCandle!.low =
        price < _currentCandle!.low ? price : _currentCandle!.low;
    _currentCandle!.close = price;

    return _currentCandle!;
  }

  /// Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø«Ù… Ø¹ÙˆØ¯ØªÙ‡: Ù†Ø®Ø²Ù† Ticks Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
  void bufferTick(Map<String, dynamic> tick) {
    _pendingTicks.add(tick);
  }

  /// Ù…Ù„Ø¡ Ø§Ù„ÙØ¬ÙˆØ§Øª Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
  List<LiveCandle> flushBufferedTicks() {
    final List<LiveCandle> candles = [];
    while (_pendingTicks.isNotEmpty) {
      candles.add(processTick(_pendingTicks.removeFirst()));
    }
    return candles;
  }
}
EOF
cat > lib/core/network/oanda/stream/oanda_ws_client.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaWSClient {
  WebSocketChannel? _channel;
  StreamSubscription? _subs;
  bool _manuallyClosed = false;

  Future<void> connect(
    String symbol,
    void Function(dynamic) onData, {
    void Function()? onDone,
    void Function(dynamic)? onError,
  }) async {
    _manuallyClosed = false;
    final token = await SecureStorageManager.readOandaToken();
    final account =
        await SecureStorageManager.readOandaAccount();

    final url =
        "\${OandaConfig.streamBaseUrl}/accounts/\$account/pricing/stream?instruments=\$symbol";

    _channel = WebSocketChannel.connect(
      Uri.parse(url),
      headers: {"Authorization": "Bearer \$token"},
    );

    _subs = _channel!.stream.listen(
      onData,
      onError: (e) {
        onError?.call(e);
        if (!_manuallyClosed) {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
          Future.delayed(Duration(seconds: 2), () {
            connect(symbol, onData,
                onDone: onDone, onError: onError);
          });
        }
      },
      onDone: () {
        onDone?.call();
        if (!_manuallyClosed) {
          Future.delayed(Duration(seconds: 2), () {
            connect(symbol, onData,
                onDone: onDone, onError: onError);
          });
        }
      },
    );
  }

  void disconnect() {
    _manuallyClosed = true;
    _subs?.cancel();
    _channel?.sink.close();
  }
}
EOF
cat > lib/features/market/domain/timeframes/timeframe.dart << 'EOF'
enum Timeframe {
  m1,
  m5,
  m15,
  h1,
}

extension TimeframeExt on Timeframe {
  Duration get duration {
    switch (this) {
      case Timeframe.m1:
        return Duration(minutes: 1);
      case Timeframe.m5:
        return Duration(minutes: 5);
      case Timeframe.m15:
        return Duration(minutes: 15);
      case Timeframe.h1:
        return Duration(hours: 1);
    }
  }

  String get oandaName {
    switch (this) {
      case Timeframe.m1:
        return "M1";
      case Timeframe.m5:
        return "M5";
      case Timeframe.m15:
        return "M15";
      case Timeframe.h1:
        return "H1";
    }
  }
}
EOF
cat > lib/features/trading/data/oanda_trade_client.dart << 'EOF'
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../../../core/network/oanda/oanda_config.dart';
import '../../../core/security/secure_storage_manager.dart';

class OandaTradeClient {
  Future<http.Response> _post(String url, dynamic body) async {
    final token = await SecureStorageManager.readOandaToken();
    final headers = {
      "Authorization": "Bearer \$token",
      "Content-Type": "application/json",
    };
    return http.post(Uri.parse(url), headers: headers, body: jsonEncode(body));
  }

  Future<bool> marketOrder({
    required String instrument,
    required int units,
    double? stopLoss,
    double? takeProfit,
  }) async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/accounts/\$accountId/orders";
    final order = {
      "order": {
        "instrument": instrument,
        "units": units.toString(),
        "type": "MARKET",
        if (stopLoss != null)
          "stopLossOnFill": {"price": stopLoss.toString()},
        if (takeProfit != null)
          "takeProfitOnFill": {"price": takeProfit.toString()},
      }
    };

    final res = await _post(url, order);
    return res.statusCode == 201;
  }

  Future<bool> limitOrder({
    required String instrument,
    required int units,
    required double price,
  }) async {
    final accountId = await SecureStorageManager.readOandaAccount();
    final url =
        "\${OandaConfig.restBaseUrl}/accounts/\$accountId/orders";
    final order = {
      "order": {
        "instrument": instrument,
        "units": units.toString(),
        "price": price.toString(),
        "type": "LIMIT",
      }
    };

    final res = await _post(url, order);
    return res.statusCode == 201;
  }
}
EOF
cat > lib/features/trading/presentation/bloc/trading_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../data/oanda_trade_client.dart';

part 'trading_event.dart';
part 'trading_state.dart';

class TradingBloc extends Bloc<TradingEvent, TradingState> {
  final OandaTradeClient _client = OandaTradeClient();

  TradingBloc() : super(TradingInitial()) {
    on<PlaceMarketOrder>((event, emit) async {
      emit(TradingLoading());
      final success = await _client.marketOrder(
        instrument: event.symbol,
        units: event.units,
        stopLoss: event.stopLoss,
        takeProfit: event.takeProfit,
      );
      emit(success ? TradingSuccess() : TradingFailure());
    });

    on<PlaceLimitOrder>((event, emit) async {
      emit(TradingLoading());
      final success =
          await _client.limitOrder(instrument: event.symbol, units: event.units, price: event.price);
      emit(success ? TradingSuccess() : TradingFailure());
    });
  }
}
EOF
cat > lib/features/trading/presentation/bloc/trading_event.dart << 'EOF'
part of 'trading_bloc.dart';

abstract class TradingEvent {}

class PlaceMarketOrder extends TradingEvent {
  final String symbol;
  final int units;
  final double? stopLoss;
  final double? takeProfit;

  PlaceMarketOrder({
    required this.symbol,
    required this.units,
    this.stopLoss,
    this.takeProfit,
  });
}

class PlaceLimitOrder extends TradingEvent {
  final String symbol;
  final int units;
  final double price;

  PlaceLimitOrder({
    required this.symbol,
    required this.units,
    required this.price,
  });
}
EOF
cat > lib/features/trading/presentation/bloc/trading_state.dart << 'EOF'
part of 'trading_bloc.dart';

abstract class TradingState {}

class TradingInitial extends TradingState {}

class TradingLoading extends TradingState {}

class TradingSuccess extends TradingState {}

class TradingFailure extends TradingState {}
EOF
cat > lib/core/security/refresh/token_refresh_guard.dart << 'EOF'
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../oanda/oanda_config.dart';

class TokenRefreshGuard {
  final _storage = FlutterSecureStorage();

  Future<String?> refresh(String oldToken) async {
    try {
      final res = await http.post(
        Uri.parse("\${OandaConfig.restBaseUrl}/oauth2/token"),
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: {
          'grant_type': 'refresh_token',
          'refresh_token': oldToken,
        },
      );
      if (res.statusCode == 200) {
        final json = jsonDecode(res.body);
        final newToken = json['access_token'];
        await _storage.write(key: OandaConfig.tokenKey, value: newToken);
        return newToken;
      }
    } catch (_) {}
    return null;
  }
}
EOF
cat > lib/core/network/security/certificate_pinning.dart << 'EOF'
import 'dart:io';
import 'package:http/io_client.dart';

class CertificatePinning {
  static HttpClient getPinnedHttpClient() {
    final client = HttpClient();
    client.badCertificateCallback =
        (X509Certificate cert, String host, int port) {
      // Ø¶Ø¹ Ø§Ù„Ù€ SHA256 Pins Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù€ OANDA Ù‡Ù†Ø§
      return cert.sha256 == "SHA256_PIN_OF_OANDA";
    };
    return client;
  }

  static IOClient getIOClient() => IOClient(getPinnedHttpClient());
}
EOF
cat > lib/core/network/retry/retry_limiter.dart << 'EOF'
import 'dart:async';

class RetryLimiter {
  final int maxAttempts;
  final Duration baseDelay;

  RetryLimiter({this.maxAttempts = 3, this.baseDelay = const Duration(seconds: 1)});

  Future<T?> run<T>(Future<T> Function() fn) async {
    int attempts = 0;

    while (attempts < maxAttempts) {
      try {
        return await fn();
      } catch (e) {
        attempts++;
        await Future.delayed(baseDelay * attempts);
      }
    }
    return null;
  }
}
EOF
cat > lib/core/logging/audit_logger.dart << 'EOF'
import 'package:hive/hive.dart';
import 'dart:convert';

class AuditLogger {
  static const _box = "audit_logs";

  static Future<void> init() async {
    await Hive.openBox(_box);
  }

  static void log(String event, dynamic payload) {
    final box = Hive.box(_box);
    box.add({
      "timestamp": DateTime.now().toIso8601String(),
      "event": event,
      "payload": jsonEncode(payload),
    });
  }

  static List<dynamic> getAllLogs() {
    final box = Hive.box(_box);
    return box.values.toList();
  }
}
EOF
cat > lib/core/ui/styles/app_theme.dart << 'EOF'
import 'package:flutter/material.dart';

final ThemeData kLightTheme = ThemeData(
  primarySwatch: Colors.indigo,
  visualDensity: VisualDensity.adaptivePlatformDensity,
  scaffoldBackgroundColor: Colors.white,
  appBarTheme: AppBarTheme(
    elevation: 0,
    backgroundColor: Colors.indigo,
    titleTextStyle: TextStyle(
      fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white),
  ),
);

final ThemeData kDarkTheme = ThemeData.dark().copyWith(
  primaryColor: Colors.indigo,
);
EOF
cat > lib/features/home/presentation/pages/home_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../core/logging/audit_logger.dart';
import '../../../../features/market/presentation/bloc/oanda/oanda_bloc.dart';

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("Dashboard")),
      body: Column(children: [
        Padding(
          padding: EdgeInsets.all(8),
          child: ElevatedButton(
            child: Text("Fetch OANDA Instruments"),
            onPressed: () => context.read<OandaBloc>().add(LoadInstruments()),
          ),
        ),

        Expanded(child: BlocBuilder<OandaBloc, OandaState>(
          builder: (context, state) {
            if (state is OandaLoading)
              return Center(child: CircularProgressIndicator());
            if (state is OandaLoaded)
              return ListView.builder(
                itemCount: state.instruments.length,
                itemBuilder: (c, i) => ListTile(
                  title: Text(state.instruments[i]),
                  onTap: () {
                    AuditLogger.log("InstrumentSelected", state.instruments[i]);
                    Navigator.pushNamed(context, "/chart", arguments: state.instruments[i]);
                  },
                ),
              );
            if (state is OandaError)
              return Center(child: Text("Error: \${state.message}"));
            return Center(child: Text("No Data Loaded"));
          },
        )),

        Divider(),
        Padding(
          padding: EdgeInsets.all(8),
          child: ElevatedButton(
            child: Text("Settings"),
            onPressed: () => Navigator.pushNamed(context, "/settings"),
          ),
        ),
      ]),
    );
  }
}
EOF
cat > lib/features/trading/presentation/widgets/market_order_dialog.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../bloc/trading_bloc.dart';

class MarketOrderDialog extends StatefulWidget {
  final String symbol;
  MarketOrderDialog({required this.symbol});

  @override
  _MarketOrderDialogState createState() => _MarketOrderDialogState();
}

class _MarketOrderDialogState extends State<MarketOrderDialog> {
  final _unitsCtrl = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("Market Order: \${widget.symbol}"),
      content: Column(mainAxisSize: MainAxisSize.min, children: [
        TextField(
          controller: _unitsCtrl,
          decoration: InputDecoration(labelText: "Units"),
          keyboardType: TextInputType.number,
        ),
      ]),
      actions: [
        TextButton(
          child: Text("Cancel"),
          onPressed: () => Navigator.pop(context),
        ),
        ElevatedButton(
          child: Text("Place"),
          onPressed: () {
            final units = int.tryParse(_unitsCtrl.text) ?? 0;
            context.read<TradingBloc>().add(
                  PlaceMarketOrder(symbol: widget.symbol, units: units),
                );
            Navigator.pop(context);
          },
        ),
      ],
    );
  }
}
EOF
cat > lib/core/ui/widgets/error_widget.dart << 'EOF'
import 'package:flutter/material.dart';

class AppErrorWidget extends StatelessWidget {
  final String message;
  AppErrorWidget(this.message);

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(mainAxisSize: MainAxisSize.min, children: [
        Icon(Icons.error, size: 42, color: Colors.red),
        SizedBox(height: 10),
        Text(message),
      ]),
    );
  }
}
EOF
cat > lib/core/storage/app_preferences.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';

class AppPreferences {
  static Future<void> saveThemeMode(bool isDark) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setBool("dark_mode", isDark);
  }

  static Future<bool> loadThemeMode() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool("dark_mode") ?? false;
  }
}
EOF
cat > lib/core/settings/server_mode.dart << 'EOF'
enum ServerMode { sandbox, live }

extension ServerModeExt on ServerMode {
  String get name => this == ServerMode.sandbox ? "SANDBOX" : "LIVE";
}
EOF
cat > lib/core/settings/mode_storage.dart << 'EOF'
import 'package:shared_preferences/shared_preferences.dart';
import 'server_mode.dart';

class ModeStorage {
  static Future<void> save(ServerMode mode) async {
    final prefs = await SharedPreferences.getInstance();
    prefs.setString("server_mode", mode.name);
  }

  static Future<ServerMode> load() async {
    final prefs = await SharedPreferences.getInstance();
    final stored = prefs.getString("server_mode") ?? "SANDBOX";
    return stored == "LIVE" ? ServerMode.live : ServerMode.sandbox;
  }
}
EOF
cat > lib/core/logging/ui/logs_page.dart << 'EOF'
import 'package:flutter/material.dart';
import '../audit_logger.dart';

class LogsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final logs = AuditLogger.getAllLogs();
    return Scaffold(
      appBar: AppBar(title: Text("System Logs")),
      body: ListView.builder(
        itemCount: logs.length,
        itemBuilder: (c, i) {
          final item = logs[i];
          return ListTile(
            title: Text(item["event"]),
            subtitle: Text(item["payload"]),
            trailing: Text(item["timestamp"]),
          );
        },
      ),
    );
  }
}
EOF
cat > test/unit/indicator_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/features/indicators/domain/ema_calculator.dart';
import 'package:my_app/features/indicators/domain/rsi_calculator.dart';

void main() {
  test('EMA calculator works correctly', () {
    final ema = EmaCalculator(5);
    final values = [1, 2, 3, 4, 5];
    final result = values.map((v) => ema.calculate(v)).toList();
    expect(result.isNotEmpty, true);
  });

  test('RSI calculator returns a number between 0 and 100', () {
    final rsi = RsiCalculator(5);
    double prev = 1, curr = 2;
    final val = rsi.calculate(prev, curr);
    expect(val != null && val! >= 0 && val <= 100, true);
  });
}
EOF
cat > test/integration/navigation_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/main.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets("Home -> Settings navigation", (tester) async {
    await tester.pumpWidget(MyApp());
    expect(find.text("Dashboard"), findsOneWidget);
    await tester.tap(find.text("Settings"));
    await tester.pumpAndSettle();
    expect(find.text("OANDA Settings"), findsOneWidget);
  });
}
EOF
cat > test/widget/chart_widget_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/features/chart/presentation/widgets/chart_webview.dart';

void main() {
  testWidgets("ChartWebView widget builds", (tester) async {
    final mockData = [
      {"time": 1, "open": 1, "high": 1, "low": 1, "close": 1}
    ];
    await tester.pumpWidget(ChartWebView(
      candles: mockData,
      emaShort: [],
      emaLong: [],
      rsi: [],
    ));
    await tester.pumpAndSettle();
    expect(find.byType(ChartWebView), findsOneWidget);
  });
}
EOF
cat > lib/flavors/flavors.dart << 'EOF'
enum Flavor { dev, staging, prod }
EOF
cat > .github/workflows/flutter_ci.yml << 'EOF'
name: Flutter CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
EOF
cat > docs/PRODUCTION_SETUP.md << 'EOF'
# Production Setup

This document explains how to configure the application for production:

1. **API Keys**
   - Store OANDA API token in a secure vault.
   - Set environment variable `OANDA_API_KEY`.

2. **Certificate Pinning**
   - Update certificate SHA256 pins in certificate_pinning.dart.

3. **Flavors**
   - Build using `--flavor prod` for production builds.

4. **Security**
   - Ensure SSL pinning is enabled.
EOF
cat > scripts/release_android.sh << 'EOF'
#!/usr/bin/env bash
EOF
cat > lib/core/network/rest/rest_client.dart << 'EOF'
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:my_app/core/settings/server_mode.dart';
import 'package:my_app/core/settings/mode_storage.dart';
import '../security/certificate_pinning.dart';
import '../retry/retry_limiter.dart';
import '../../logging/audit_logger.dart';

class RestClient {
  final RetryLimiter _retry = RetryLimiter();

  Future<String> _baseUrl() async {
    final mode = await ModeStorage.load();
    return mode == ServerMode.live
        ? "https://api-fxtrade.oanda.com/v3"
        : "https://api-fxpractice.oanda.com/v3";
  }

  http.Client get _client => CertificatePinning.getIOClient();

  Future<dynamic> get(String path,
      {Map<String, String>? headers}) async {
    final url = "\${await _baseUrl()}\$path";
    AuditLogger.log("REST GET", {"url": url, "headers": headers});

    final res = await _retry.run(() => _client.get(
          Uri.parse(url),
          headers: headers,
        ));

    if (res == null) {
      throw Exception("REST GET Failed: No response");
    }

    if (res.statusCode < 200 || res.statusCode >= 300) {
      AuditLogger.log("REST ERROR", {
        "url": url,
        "status": res.statusCode,
        "body": res.body
      });
      throw Exception(
          "REST GET Error: \${res.statusCode} \${res.body}");
    }

    return jsonDecode(res.body);
  }

  Future<dynamic> post(String path,
      {Map<String, String>? headers, Object? body}) async {
    final url = "\${await _baseUrl()}\$path";
    AuditLogger.log("REST POST", {"url": url, "body": body});

    final res = await _retry.run(() =>
        _client.post(Uri.parse(url),
            headers: headers, body: jsonEncode(body)));

    if (res == null) {
      throw Exception("REST POST Failed: No response");
    }

    if (res.statusCode < 200 || res.statusCode >= 300) {
      AuditLogger.log("REST ERROR", {
        "url": url,
        "status": res.statusCode,
        "body": res.body
      });
      throw Exception(
          "REST POST Error: \${res.statusCode} \${res.body}");
    }

    return jsonDecode(res.body);
  }
}
EOF
cat > lib/core/network/ws/transport/ws_transport.dart << 'EOF'
import 'dart:async';
import 'package:web_socket_channel/web_socket_channel.dart';
import '../../../security/secure_storage_manager.dart';
import '../../../settings/mode_storage.dart';
import '../../../settings/server_mode.dart';
import '../../../logging/audit_logger.dart';

enum WsConnectionState {
  disconnected,
  connecting,
  connected,
  reconnecting,
  error
}

class WsTransport {
  WebSocketChannel? _channel;
  StreamSubscription? _sub;
  Timer? _pingTimer;

  final _stateController = StreamController<WsConnectionState>.broadcast();
  Stream<WsConnectionState> get stateStream => _stateController.stream;

  bool _manuallyClosed = false;
  int _reconnectAttempts = 0;

  Future<String> _baseUrl() async {
    final mode = await ModeStorage.load();
    return mode == ServerMode.live
        ? "wss://stream-fxtrade.oanda.com/v3"
        : "wss://stream-fxpractice.oanda.com/v3";
  }

  Future<void> connect({
    required String accountId,
    required String instrument,
    required Function(dynamic) onData,
  }) async {
    _manuallyClosed = false;
    _stateController.add(WsConnectionState.connecting);

    final token = await SecureStorageManager.readOandaToken();
    final base = await _baseUrl();
    final url =
        "\$base/accounts/\$accountId/pricing/stream?instruments=\$instrument";

    try {
      AuditLogger.log("WS_CONNECT", {"url": url});

      _channel = WebSocketChannel.connect(
        Uri.parse(url),
        headers: {"Authorization": "Bearer \$token"},
      );

      _stateController.add(WsConnectionState.connected);
      _reconnectAttempts = 0;

      _startPing();

      _sub = _channel!.stream.listen(
        (data) {
          onData(data);
        },
        onError: (e) {
          AuditLogger.log("WS_ERROR", {"error": e.toString()});
          _stateController.add(WsConnectionState.error);
          _attemptReconnect(accountId, instrument, onData);
        },
        onDone: () {
          if (!_manuallyClosed) {
            _stateController.add(WsConnectionState.reconnecting);
            _attemptReconnect(accountId, instrument, onData);
          }
        },
        cancelOnError: true,
      );
    } catch (e) {
      AuditLogger.log("WS_CONNECT_FAIL", {"error": e.toString()});
      _stateController.add(WsConnectionState.error);
      _attemptReconnect(accountId, instrument, onData);
    }
  }

  void _startPing() {
    _pingTimer?.cancel();
    _pingTimer = Timer.periodic(Duration(seconds: 20), (_) {
      try {
        _channel?.sink.add('{"type":"ping"}');
      } catch (_) {}
    });
  }

  void _attemptReconnect(
      String accountId, String instrument, Function(dynamic) onData) {
    if (_manuallyClosed) return;

    _reconnectAttempts++;
    final delay = Duration(
        seconds: (_reconnectAttempts * 2).clamp(2, 30));

    Future.delayed(delay, () {
      connect(
          accountId: accountId,
          instrument: instrument,
          onData: onData);
    });
  }

  void disconnect() {
    _manuallyClosed = true;
    _pingTimer?.cancel();
    _sub?.cancel();
    _channel?.sink.close();
    _stateController.add(WsConnectionState.disconnected);
  }
}
EOF
cat > lib/core/network/ws/pipeline/ws_pipeline.dart << 'EOF'
import 'dart:async';
import 'dart:collection';

class WsPipeline {
  final int maxBufferSize;
  final Queue<dynamic> _buffer = Queue();
  final StreamController<dynamic> _out =
      StreamController.broadcast();

  Stream<dynamic> get stream => _out.stream;

  WsPipeline({this.maxBufferSize = 5000});

  void push(dynamic event) {
    if (_buffer.length >= maxBufferSize) {
      _buffer.removeFirst(); // Ù…Ù†Ø¹ Overflow
    }
    _buffer.add(event);
    _drain();
  }

  void _drain() {
    while (_buffer.isNotEmpty) {
      _out.add(_buffer.removeFirst());
    }
  }

  void dispose() {
    _out.close();
  }
}
EOF
cat > lib/features/market/domain/streaming/live_stream_adapter.dart << 'EOF'
import 'dart:convert';
import '../../../core/network/ws/transport/ws_transport.dart';
import '../../../core/network/ws/pipeline/ws_pipeline.dart';
import '../aggregator/candle_aggregator.dart';
import '../timeframes/timeframe.dart';

class LiveStreamAdapter {
  final WsTransport _transport = WsTransport();
  final WsPipeline _pipeline = WsPipeline();
  late CandleAggregator _aggregator;

  Stream<Map<String, dynamic>> get candleStream =>
      _pipeline.stream.map((e) => e as Map<String, dynamic>);

  void start({
    required String accountId,
    required String symbol,
    required Timeframe timeframe,
  }) {
    _aggregator = CandleAggregator(timeframe.duration);

    _transport.connect(
      accountId: accountId,
      instrument: symbol,
      onData: (raw) {
        final decoded = jsonDecode(raw);

        if (decoded["type"] == "PRICE") {
          final tick = {
            "time": decoded["time"] is String
                ? DateTime.parse(decoded["time"])
                        .millisecondsSinceEpoch ~/
                    1000
                : decoded["time"],
            "price": double.parse(decoded["bids"][0]["price"]),
          };

          final candle = _aggregator.processTick(tick);
          _pipeline.push(candle.toMap());
        }
      },
    );
  }

  void stop() {
    _transport.disconnect();
    _pipeline.dispose();
  }
}
EOF
cat > lib/features/market/presentation/bloc/stream/stream_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/streaming/live_stream_adapter.dart';
import '../../../domain/timeframes/timeframe.dart';

part 'stream_event.dart';
part 'stream_state.dart';

class StreamBloc extends Bloc<StreamEvent, StreamState> {
  final LiveStreamAdapter _adapter = LiveStreamAdapter();

  StreamBloc() : super(StreamInitial()) {
    on<StartStream>((event, emit) {
      emit(StreamConnecting());

      _adapter.start(
        accountId: event.accountId,
        symbol: event.symbol,
        timeframe: event.timeframe,
      );

      _adapter.candleStream.listen((candle) {
        add(StreamTickReceived(candle));
      });

      emit(StreamConnected());
    });

    on<StreamTickReceived>((event, emit) {
      emit(StreamCandle(event.candle));
    });

    on<StopStream>((event, emit) {
      _adapter.stop();
      emit(StreamStopped());
    });
  }
}
EOF
cat > lib/features/market/presentation/bloc/stream/stream_event.dart << 'EOF'
part of 'stream_bloc.dart';

abstract class StreamEvent {}

class StartStream extends StreamEvent {
  final String accountId;
  final String symbol;
  final Timeframe timeframe;

  StartStream({
    required this.accountId,
    required this.symbol,
    required this.timeframe,
  });
}

class StreamTickReceived extends StreamEvent {
  final Map<String, dynamic> candle;
  StreamTickReceived(this.candle);
}

class StopStream extends StreamEvent {}
EOF
cat > lib/features/market/presentation/bloc/stream/stream_state.dart << 'EOF'
part of 'stream_bloc.dart';

abstract class StreamState {}

class StreamInitial extends StreamState {}

class StreamConnecting extends StreamState {}

class StreamConnected extends StreamState {}

class StreamCandle extends StreamState {
  final Map<String, dynamic> candle;
  StreamCandle(this.candle);
}

class StreamStopped extends StreamState {}
EOF
cat > lib/features/market/domain/models/candle.dart << 'EOF'
import 'package:equatable/equatable.dart';

class Candle extends Equatable {
  final int time; // Unix seconds (Ù…ÙˆØ­Ø¯ ÙÙŠ ÙƒÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
  final double open;
  final double high;
  final double low;
  final double close;
  final double? volume;

  const Candle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
    this.volume,
  });

  /// Factory Ø¢Ù…Ù† Ù…Ù† JSON (REST)
  factory Candle.fromRestJson(Map<String, dynamic> json) {
    final candle = json["mid"] ?? json["bid"] ?? json;

    return Candle(
      time: _toUnixSeconds(candle["time"]),
      open: _toDouble(candle["o"]),
      high: _toDouble(candle["h"]),
      low: _toDouble(candle["l"]),
      close: _toDouble(candle["c"]),
      volume: candle["volume"] != null ? _toDouble(candle["volume"]) : null,
    );
  }

  /// Factory Ø¢Ù…Ù† Ù…Ù† Tick (WebSocket)
  factory Candle.fromTick({
    required int time,
    required double price,
  }) {
    return Candle(
      time: time,
      open: price,
      high: price,
      low: price,
      close: price,
      volume: null,
    );
  }

  Map<String, dynamic> toMap() {
    return {
      "time": time,
      "open": open,
      "high": high,
      "low": low,
      "close": close,
      if (volume != null) "volume": volume,
    };
  }

  Candle copyWith({
    int? time,
    double? open,
    double? high,
    double? low,
    double? close,
    double? volume,
  }) {
    return Candle(
      time: time ?? this.time,
      open: open ?? this.open,
      high: high ?? this.high,
      low: low ?? this.low,
      close: close ?? this.close,
      volume: volume ?? this.volume,
    );
  }

  static int _toUnixSeconds(dynamic v) {
    if (v is int) return v;
    if (v is String) {
      return DateTime.parse(v).millisecondsSinceEpoch ~/ 1000;
    }
    throw FormatException("Invalid time format: \$v");
  }

  static double _toDouble(dynamic v) {
    if (v is double) return v;
    if (v is int) return v.toDouble();
    if (v is String) return double.parse(v);
    throw FormatException("Invalid price format: \$v");
  }

  @override
  List<Object?> get props => [time, open, high, low, close, volume];
}
EOF
cat > lib/features/market/domain/models/tick.dart << 'EOF'
import 'package:equatable/equatable.dart';

class Tick extends Equatable {
  final int time; // Unix seconds
  final double bid;
  final double ask;

  const Tick({
    required this.time,
    required this.bid,
    required this.ask,
  });

  factory Tick.fromOandaWs(Map<String, dynamic> json) {
    if (json["type"] != "PRICE") {
      throw FormatException("Not a PRICE message");
    }

    final time = _toUnix(json["time"]);
    final bid = _toDouble(json["bids"][0]["price"]);
    final ask = _toDouble(json["asks"][0]["price"]);

    return Tick(time: time, bid: bid, ask: ask);
  }

  Map<String, dynamic> toMap() {
    return {
      "time": time,
      "bid": bid,
      "ask": ask,
    };
  }

  static int _toUnix(dynamic v) {
    if (v is int) return v;
    if (v is String) {
      return DateTime.parse(v).millisecondsSinceEpoch ~/ 1000;
    }
    throw FormatException("Invalid time: \$v");
  }

  static double _toDouble(dynamic v) {
    if (v is double) return v;
    if (v is int) return v.toDouble();
    if (v is String) return double.parse(v);
    throw FormatException("Invalid price: \$v");
  }

  @override
  List<Object?> get props => [time, bid, ask];
}
EOF
cat > lib/features/market/domain/models/instrument.dart << 'EOF'
import 'package:equatable/equatable.dart';

class Instrument extends Equatable {
  final String name;      // Ù…Ø«Ø§Ù„: "XAU_USD"
  final String display;   // Ù…Ø«Ø§Ù„: "XAUUSD"
  final int displayPrecision;
  final int tradeUnitsPrecision;

  const Instrument({
    required this.name,
    required this.display,
    required this.displayPrecision,
    required this.tradeUnitsPrecision,
  });

  factory Instrument.fromRest(Map<String, dynamic> json) {
    final name = json["name"] as String;
    return Instrument(
      name: name,
      display: name.replaceAll("_", ""),
      displayPrecision: json["displayPrecision"] as int,
      tradeUnitsPrecision: json["tradeUnitsPrecision"] as int,
    );
  }

  @override
  List<Object?> get props =>
      [name, display, displayPrecision, tradeUnitsPrecision];
}
EOF
cat > lib/features/trading/domain/models/order.dart << 'EOF'
import 'package:equatable/equatable.dart';

enum OrderType { market, limit, stop }

class Order extends Equatable {
  final String instrument;
  final OrderType type;
  final int units;
  final double? price;
  final double? stopLoss;
  final double? takeProfit;

  const Order({
    required this.instrument,
    required this.type,
    required this.units,
    this.price,
    this.stopLoss,
    this.takeProfit,
  });

  Map<String, dynamic> toOandaPayload() {
    final base = {
      "instrument": instrument,
      "units": units.toString(),
      "type": type.name.toUpperCase(),
    };

    if (type == OrderType.limit && price != null) {
      base["price"] = price.toString();
    }

    if (stopLoss != null) {
      base["stopLossOnFill"] = {"price": stopLoss.toString()};
    }

    if (takeProfit != null) {
      base["takeProfitOnFill"] = {"price": takeProfit.toString()};
    }

    return {"order": base};
  }

  @override
  List<Object?> get props =>
      [instrument, type, units, price, stopLoss, takeProfit];
}
EOF
cat > lib/features/market/data/market_repository.dart << 'EOF'
import '../../domain/models/candle.dart';
import '../../domain/models/instrument.dart';
import '../../../core/network/rest/rest_client.dart';

class MarketRepository {
  final RestClient _client = RestClient();

  Future<List<Candle>> getHistoricalCandles(
      String accountId, String instrument, String granularity,
      {int count = 500}) async {
    final data = await _client.get(
        "/accounts/\$accountId/instruments/\$instrument/candles?granularity=\$granularity&count=\$count");

    final List list = data["candles"];
    return list.map((e) => Candle.fromRestJson(e)).toList();
  }

  Future<List<Instrument>> getInstruments(String accountId) async {
    final data =
        await _client.get("/accounts/\$accountId/instruments");

    final List list = data["instruments"];
    return list.map((e) => Instrument.fromRest(e)).toList();
  }
}
EOF
cat > lib/core/network/security/pinning/pin_store.dart << 'EOF'
class PinStore {
  /// **Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰**
  static const List<String> sandboxRestPins = [
    "REPLACE_WITH_SANDBOX_REST_SHA256_BASE64",
  ];

  static const List<String> sandboxStreamPins = [
    "REPLACE_WITH_SANDBOX_STREAM_SHA256_BASE64",
  ];

  static const List<String> liveRestPins = [
    "REPLACE_WITH_LIVE_REST_SHA256_BASE64",
  ];

  static const List<String> liveStreamPins = [
    "REPLACE_WITH_LIVE_STREAM_SHA256_BASE64",
  ];
}
EOF
cat > lib/core/network/security/http_pinning_client.dart << 'EOF'
import 'dart:io';
import 'package:http/io_client.dart';
import '../pinning/pin_store.dart';
import '../../settings/mode_storage.dart';
import '../../settings/server_mode.dart';

class HttpPinningClient {
  static Future<IOClient> create() async {
    final mode = await ModeStorage.load();
    final pins = mode == ServerMode.live
        ? [...PinStore.liveRestPins, ...PinStore.liveStreamPins]
        : [...PinStore.sandboxRestPins, ...PinStore.sandboxStreamPins];

    final httpClient = HttpClient()
      ..badCertificateCallback = (cert, host, port) {
        final sha256 = cert.sha256;
        return pins.contains(sha256);
      };

    return IOClient(httpClient);
  }
}
EOF
cat > lib/core/network/security/pinning/ws_pinned_io.dart << 'EOF'
import 'dart:io';
import 'package:web_socket_channel/io.dart';
import '../pinning/pin_store.dart';
import '../../settings/mode_storage.dart';
import '../../settings/server_mode.dart';

class WsPinningFactory {
  static Future<IOWebSocketChannel> connectWithPinning(
      Uri uri, Map<String, dynamic> headers) async {
    final mode = await ModeStorage.load();
    final pins = mode == ServerMode.live
        ? PinStore.liveStreamPins
        : PinStore.sandboxStreamPins;

    final client = HttpClient()
      ..badCertificateCallback = (cert, host, port) {
        return pins.contains(cert.sha256);
      };

    return IOWebSocketChannel.connect(
      uri,
      customClient: client,
      headers: headers.cast<String, dynamic>(),
    );
  }
}
EOF
cat > test/pinning/pin_fail_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'dart:io';
import 'package:my_app/core/network/security/pinning/pin_store.dart';

void main() {
  test("Cert pin lists not empty", () {
    expect(PinStore.sandboxRestPins.isNotEmpty, true);
    expect(PinStore.sandboxStreamPins.isNotEmpty, true);
    expect(PinStore.liveRestPins.isNotEmpty, true);
    expect(PinStore.liveStreamPins.isNotEmpty, true);
  });
}
EOF
cat > lib/core/network/retry/retry_policy.dart << 'EOF'
import 'dart:async';

enum RetryErrorType {
  timeout,
  server,
  client,
  unknown,
}

class RetryPolicy {
  final int maxAttempts;
  final Duration baseDelay;
  final bool enableJitter;

  RetryPolicy({
    this.maxAttempts = 5,
    this.baseDelay = const Duration(seconds: 1),
    this.enableJitter = true,
  });

  Duration _jitter(Duration d) {
    if (!enableJitter) return d;
    final millis = d.inMilliseconds;
    final jitter = (millis * 0.5).toInt();
    return Duration(milliseconds: millis + jitter);
  }

  Future<T> execute<T>(
    Future<T> Function() action, {
    required void Function(int attempt, Duration delay, RetryErrorType type) onRetry,
  }) async {
    int attempts = 0;
    Duration delay = baseDelay;

    while (true) {
      try {
        return await action();
      } catch (e) {
        attempts++;
        if (attempts >= maxAttempts) rethrow;

        final errorType = _classifyError(e);

        // Logging retry attempt
        onRetry(attempts, delay, errorType);

        await Future.delayed(_jitter(delay));

        // Exponential backoff
        delay = Duration(seconds: delay.inSeconds * 2);
      }
    }
  }

  RetryErrorType _classifyError(Object error) {
    final msg = error.toString().toLowerCase();
    if (msg.contains("timeout")) return RetryErrorType.timeout;
    if (msg.contains("5")) return RetryErrorType.server;
    if (msg.contains("4")) return RetryErrorType.client;
    return RetryErrorType.unknown;
  }
}
EOF
cat > lib/core/network/rest/rest_client.dart << 'EOF'
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../retry/retry_policy.dart';
import '../security/http_pinning_client.dart';
import '../../logging/audit_logger.dart';

class RestClient {
  final RetryPolicy _retry = RetryPolicy();

  Future<String> _baseUrl() =>
      ModeStorage.load().then((mode) => mode == ServerMode.live
          ? "https://api-fxtrade.oanda.com/v3"
          : "https://api-fxpractice.oanda.com/v3");

  Future<dynamic> get(String path,
      {Map<String, String>? headers}) async {
    final url = "\${await _baseUrl()}\$path";
    http.Client client = await HttpPinningClient.create();

    return _retry.execute(() => client.get(Uri.parse(url), headers: headers)
        .then((res) {
      if (res.statusCode < 200 || res.statusCode >= 300) {
        throw Exception(
            "REST GET \${res.statusCode}: \${res.body}");
      }
      return jsonDecode(res.body);
    }), onRetry: (attempt, delay, type) {
      AuditLogger.log("REST_RETRY", {
        "url": url,
        "attempt": attempt,
        "delay": delay.inString(),
        "type": type.toString(),
      });
    });
  }

  Future<dynamic> post(String path,
      {Map<String, String>? headers, Object? body}) async {
    final url = "\${await _baseUrl()}\$path";
    http.Client client = await HttpPinningClient.create();

    return _retry.execute(() => client
        .post(Uri.parse(url),
            headers: headers, body: jsonEncode(body))
        .then((res) {
      if (res.statusCode < 200 || res.statusCode >= 300) {
        throw Exception(
            "REST POST \${res.statusCode}: \${res.body}");
      }
      return jsonDecode(res.body);
    }), onRetry: (attempt, delay, type) {
      AuditLogger.log("REST_RETRY", {
        "url": url,
        "attempt": attempt,
        "delay": delay.inString(),
        "type": type.toString(),
      });
    });
  }
}
EOF
cat > lib/core/network/rest/rest_timeout.dart << 'EOF'
import 'dart:async';

extension HttpTimeout<T> on Future<T> {
  Future<T> withTimeout(Duration timeout) {
    return this.timeout(timeout, onTimeout: () {
      throw Exception("Request Timeout after \$timeout");
    });
  }
}
EOF
cat > lib/core/network/ws/transport/ws_transport_retry.dart << 'EOF'
import 'package:flutter/foundation.dart';
import '../ws_transport.dart';
import '../../retry/retry_policy.dart';

class WsTransportRetry {
  final RetryPolicy _retry = RetryPolicy(maxAttempts: 4);

  Future<void> connectWithRetry({
    required String accountId,
    required String instrument,
    required Function(dynamic) onData,
    required WsTransport transport,
  }) async {
    await _retry.execute(() {
      return transport.connect(
        accountId: accountId,
        instrument: instrument,
        onData: onData,
      );
    }, onRetry: (attempt, delay, type) {
      debugPrint("WS RETRY \$attempt delay=\$delay type=\$type");
    });
  }
}
EOF
cat > lib/core/storage/hive_adapters/candle_adapter.dart << 'EOF'
import 'package:hive/hive.dart';
import '../../features/market/domain/models/candle.dart';

part 'candle_adapter.g.dart';

@HiveType(typeId: 1)
class HiveCandle {
  @HiveField(0)
  final int time;

  @HiveField(1)
  final double open;

  @HiveField(2)
  final double high;

  @HiveField(3)
  final double low;

  @HiveField(4)
  final double close;

  HiveCandle({
    required this.time,
    required this.open,
    required this.high,
    required this.low,
    required this.close,
  });
}

// Adapter Serializer
class HiveCandleAdapter extends TypeAdapter<HiveCandle> {
  @override
  final typeId = 1;

  @override
  HiveCandle read(BinaryReader reader) {
    return HiveCandle(
      time: reader.readInt(),
      open: reader.readDouble(),
      high: reader.readDouble(),
      low: reader.readDouble(),
      close: reader.readDouble(),
    );
  }

  @override
  void write(BinaryWriter writer, HiveCandle obj) {
    writer.writeInt(obj.time);
    writer.writeDouble(obj.open);
    writer.writeDouble(obj.high);
    writer.writeDouble(obj.low);
    writer.writeDouble(obj.close);
  }
}
EOF
cat > lib/core/storage/cache/cache_strategy.dart << 'EOF'
abstract class CacheStrategy<T> {
  Future<T?> read(String key);
  Future<void> write(String key, T value);
  Future<void> delete(String key);
  bool shouldInvalidate(String key);
}
EOF
cat > lib/core/storage/cache/ttl_cache.dart << 'EOF'
import 'dart:convert';
import 'package:hive/hive.dart';
import 'cache_strategy.dart';

class TtlCache<T> implements CacheStrategy<T> {
  final Box _box;
  final Duration ttl;

  TtlCache(this._box, {required this.ttl});

  @override
  Future<void> write(String key, T value) async {
    final wrapper = {
      "ts": DateTime.now().millisecondsSinceEpoch,
      "data": value,
    };
    await _box.put(key, wrapper);
  }

  @override
  Future<T?> read(String key) async {
    final stored = _box.get(key);
    if (stored == null) return null;
    final ts = stored["ts"] as int;
    final diff =
        DateTime.now().millisecondsSinceEpoch - ts;
    if (Duration(milliseconds: diff) > ttl) {
      await _box.delete(key);
      return null;
    }
    return stored["data"] as T;
  }

  @override
  Future<void> delete(String key) async => _box.delete(key);

  @override
  bool shouldInvalidate(String key) {
    return !_box.containsKey(key);
  }
}
EOF
cat > lib/core/storage/cache/cache_manager.dart << 'EOF'
import 'package:hive/hive.dart';
import 'cache_strategy.dart';
import 'ttl_cache.dart';

class CacheManager {
  static final _inst = CacheManager._();
  CacheManager._();

  static CacheManager get instance => _inst;

  late CacheStrategy _symbolsCache;
  late CacheStrategy _instrumentsCache;

  Future<void> init() async {
    final symBox = Hive.box("cache_symbols");
    _symbolsCache = TtlCache(symBox, ttl: Duration(minutes: 10));

    final insBox = Hive.box("cache_instruments");
    _instrumentsCache = TtlCache(insBox, ttl: Duration(minutes: 30));
  }

  Future<List<String>?> getSymbols(String key) =>
      _symbolsCache.read(key);

  Future<void> setSymbols(String key, List<String> val) =>
      _symbolsCache.write(key, val);

  Future<void> deleteSymbols(String key) =>
      _symbolsCache.delete(key);

  Future<List<dynamic>?> getInstruments(String key) =>
      _instrumentsCache.read(key);

  Future<void> setInstruments(String key, List<dynamic> val) =>
      _instrumentsCache.write(key, val);

  Future<void> deleteInstruments(String key) =>
      _instrumentsCache.delete(key);
}
EOF
cat > lib/features/market/data/market_repository.dart << 'EOF'
import '../../domain/models/candle.dart';
import '../../domain/models/instrument.dart';
import '../../../core/network/rest/rest_client.dart';
import '../../../core/storage/cache/cache_manager.dart';

class MarketRepository {
  final RestClient _client = RestClient();
  final CacheManager _cache = CacheManager.instance;

  Future<List<Instrument>> getInstrumentsCached(
      String accountId) async {
    final key = "instruments_\$accountId";
    final fromCache = await _cache.getInstruments(key);
    if (fromCache != null) {
      return fromCache.cast<Instrument>();
    }

    final data =
        await _client.get("/accounts/\$accountId/instruments");
    final list = (data["instruments"] as List)
        .map((e) => Instrument.fromRest(e))
        .toList();

    await _cache.setInstruments(key, list);
    return list;
  }

  Future<List<Candle>> getCandlesCached(
      String accountId, String instrument, String granularity) async {
    final key = "candles_\$accountId_\$instrument_\$granularity";
    final fromCache = await _cache.getSymbols(key);
    if (fromCache != null) {
      return fromCache.cast<Candle>();
    }

    final raw = await _client.get(
        "/accounts/\$accountId/instruments/\$instrument/candles?granularity=\$granularity&count=500");
    final list = (raw["candles"] as List)
        .map((e) => Candle.fromRestJson(e))
        .toList();

    await _cache.setSymbols(key, list);
    return list;
  }
}
EOF
cat > lib/core/storage/watchlist.dart << 'EOF'
import 'package:hive/hive.dart';

class WatchlistManager {
  final Box _box = Hive.box("watchlist_box");

  List<String> getAll() =>
      _box.values.cast<String>().toList();

  Future<void> add(String symbol) async {
    if (!_box.values.contains(symbol)) {
      await _box.add(symbol);
    }
  }

  Future<void> remove(String symbol) async {
    final key = _box.keys
        .firstWhere((k) => _box.get(k) == symbol);
    await _box.delete(key);
  }
}
EOF
cat > lib/core/bloc/base_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

abstract class BaseEvent {}

abstract class BaseState {}

abstract class BaseEffect {}

abstract class BaseBloc<E extends BaseEvent, S extends BaseState>
    extends Bloc<E, S> {
  BaseBloc(S initialState) : super(initialState);

  void emitSafe(S state) {
    if (!isClosed) {
      emit(state);
    }
  }
}
EOF
cat > lib/core/bloc/subscriptions/subscription_manager.dart << 'EOF'
import 'dart:async';

class SubscriptionManager {
  final List<StreamSubscription> _subs = [];

  void add(StreamSubscription sub) {
    _subs.add(sub);
  }

  Future<void> cancelAll() async {
    for (final s in _subs) {
      await s.cancel();
    }
    _subs.clear();
  }
}
EOF
cat > lib/features/market/presentation/bloc/market/market_state.dart << 'EOF'
import 'package:equatable/equatable.dart';
import '../../../domain/models/candle.dart';

abstract class MarketState extends Equatable {
  @override
  List<Object?> get props => [];
}

class MarketIdle extends MarketState {}

class MarketLoadingHistory extends MarketState {}

class MarketHistoryReady extends MarketState {
  final List<Candle> candles;
  MarketHistoryReady(this.candles);

  @override
  List<Object?> get props => [candles];
}

class MarketStreaming extends MarketState {}

class MarketError extends MarketState {
  final String message;
  MarketError(this.message);

  @override
  List<Object?> get props => [message];
}
EOF
cat > lib/core/error/failure.dart << 'EOF'
abstract class Failure {
  final String message;
  Failure(this.message);
}

class NetworkFailure extends Failure {
  NetworkFailure(String m) : super(m);
}

class AuthFailure extends Failure {
  AuthFailure(String m) : super(m);
}

class ParsingFailure extends Failure {
  ParsingFailure(String m) : super(m);
}

class UnknownFailure extends Failure {
  UnknownFailure(String m) : super(m);
}
EOF
cat > lib/features/market/presentation/bloc/market/market_effect.dart << 'EOF'
abstract class MarketEffect {}

class ShowToast extends MarketEffect {
  final String message;
  ShowToast(this.message);
}

class NavigateToSettings extends MarketEffect {}

class NotifyTradeOpened extends MarketEffect {
  final String symbol;
  NotifyTradeOpened(this.symbol);
}
EOF
cat > lib/core/bloc/stream_handler.dart << 'EOF'
import 'dart:async';

class StreamHandler<T> {
  StreamSubscription? _sub;

  void listen(Stream<T> stream, void Function(T) onData) {
    _sub = stream.listen(onData);
  }

  Future<void> cancel() async {
    await _sub?.cancel();
  }
}
EOF
cat > lib/features/market/presentation/bloc/market/market_event.dart << 'EOF'
abstract class MarketEvent {}

class LoadHistory extends MarketEvent {
  final String accountId;
  final String symbol;
  final String timeframe;

  LoadHistory(this.accountId, this.symbol, this.timeframe);
}

class StartStreaming extends MarketEvent {}

class StopStreaming extends MarketEvent {}
EOF
cat > lib/features/market/presentation/bloc/market/market_bloc.dart << 'EOF'
import 'dart:async';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'market_event.dart';
import 'market_state.dart';
import 'market_effect.dart';
import '../../../domain/models/candle.dart';
import '../../../data/market_repository.dart';
import '../../../domain/streaming/live_stream_adapter.dart';
import '../../../../core/bloc/subscriptions/subscription_manager.dart';

class MarketBloc extends Bloc<MarketEvent, MarketState> {
  final MarketRepository _repo;
  final LiveStreamAdapter _stream;
  final SubscriptionManager _subs = SubscriptionManager();

  MarketBloc(this._repo, this._stream) : super(MarketIdle()) {
    on<LoadHistory>(_onLoadHistory);
    on<StartStreaming>(_onStartStreaming);
    on<StopStreaming>(_onStopStreaming);
  }

  Future<void> _onLoadHistory(
      LoadHistory e, Emitter<MarketState> emit) async {
    emit(MarketLoadingHistory());

    try {
      final candles = await _repo.getCandlesCached(
        e.accountId,
        e.symbol,
        e.timeframe,
      );

      emit(MarketHistoryReady(candles));
    } catch (err) {
      emit(MarketError("Failed to load history"));
    }
  }

  void _onStartStreaming(
      StartStreaming e, Emitter<MarketState> emit) {
    emit(MarketStreaming());

    final sub = _stream.candleStream.listen((candleMap) {
      final candle = Candle(
        time: candleMap["time"],
        open: candleMap["open"],
        high: candleMap["high"],
        low: candleMap["low"],
        close: candleMap["close"],
      );

      add(_MarketTick(candle));
    });

    _subs.add(sub);
  }

  void _onStopStreaming(
      StopStreaming e, Emitter<MarketState> emit) async {
    await _subs.cancelAll();
    emit(MarketIdle());
  }
}

class _MarketTick extends MarketEvent {
  final Candle candle;
  _MarketTick(this.candle);
}
EOF
cat > lib/features/market/presentation/bloc/stream/stream_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../domain/streaming/live_stream_adapter.dart';
import '../../../../core/bloc/subscriptions/subscription_manager.dart';

abstract class StreamEvent {}

class ConnectStream extends StreamEvent {
  final String accountId;
  final String symbol;
  ConnectStream(this.accountId, this.symbol);
}

class DisconnectStream extends StreamEvent {}

abstract class StreamState {}

class StreamIdle extends StreamState {}

class StreamConnecting extends StreamState {}

class StreamConnected extends StreamState {}

class StreamError extends StreamState {
  final String message;
  StreamError(this.message);
}

class StreamBloc extends Bloc<StreamEvent, StreamState> {
  final LiveStreamAdapter _adapter;
  final SubscriptionManager _subs = SubscriptionManager();

  StreamBloc(this._adapter) : super(StreamIdle()) {
    on<ConnectStream>(_onConnect);
    on<DisconnectStream>(_onDisconnect);
  }

  void _onConnect(
      ConnectStream e, Emitter<StreamState> emit) {
    emit(StreamConnecting());

    _adapter.start(
      accountId: e.accountId,
      symbol: e.symbol,
      timeframe: Timeframe.m1,
    );

    emit(StreamConnected());
  }

  void _onDisconnect(
      DisconnectStream e, Emitter<StreamState> emit) async {
    _adapter.stop();
    await _subs.cancelAll();
    emit(StreamIdle());
  }
}
EOF
cat > lib/core/bloc/root/root_event.dart << 'EOF'
abstract class RootEvent {}

class InitApp extends RootEvent {}

class TerminateApp extends RootEvent {}

class ConnectionStatusChanged extends RootEvent {
  final bool connected;
  ConnectionStatusChanged(this.connected);
}

class GlobalErrorOccurred extends RootEvent {
  final String message;
  GlobalErrorOccurred(this.message);
}
EOF
cat > lib/core/bloc/root/root_state.dart << 'EOF'
abstract class RootState {}

class AppUninitialized extends RootState {}

class AppReady extends RootState {}

class AppTerminated extends RootState {}

class AppErrorState extends RootState {
  final String message;
  AppErrorState(this.message);
}

class ConnectivityState extends RootState {
  final bool online;
  ConnectivityState(this.online);
}
EOF
cat > lib/core/bloc/root/root_bloc.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';
import 'root_event.dart';
import 'root_state.dart';

class RootBloc extends Bloc<RootEvent, RootState> {
  RootBloc() : super(AppUninitialized()) {
    on<InitApp>((event, emit) {
      emit(AppReady());
    });

    on<ConnectionStatusChanged>((event, emit) {
      emit(ConnectivityState(event.connected));
    });

    on<GlobalErrorOccurred>((event, emit) {
      emit(AppErrorState(event.message));
    });

    on<TerminateApp>((event, emit) {
      // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Cleanup Ù‡Ù†Ø§
      emit(AppTerminated());
    });
  }
}
EOF
cat > lib/core/bloc/providers/app_bloc_providers.dart << 'EOF'
import 'package:flutter_bloc/flutter_bloc.dart';

import '../root/root_bloc.dart';
import '../../features/market/presentation/bloc/market/market_bloc.dart';
import '../../features/market/presentation/bloc/stream/stream_bloc.dart';
import '../../features/trading/presentation/bloc/trading_bloc.dart';

class AppBlocProviders {
  static List<BlocProvider> all(
    dynamic marketRepo,
    dynamic streamAdapter,
  ) {
    return [
      BlocProvider<RootBloc>(create: (_) => RootBloc()),
      BlocProvider<MarketBloc>(
          create: (_) => MarketBloc(marketRepo, streamAdapter)),
      BlocProvider<StreamBloc>(
          create: (_) => StreamBloc(streamAdapter)),
      BlocProvider<TradingBloc>(create: (_) => TradingBloc()),
    ];
  }
}
EOF
cat > lib/features/trading/presentation/bloc/trading_extension.dart << 'EOF'
extension TradingBlocStreamLink on TradingBloc {
  void bindMarketStream(Stream<Map<String, dynamic>> stream) {
    stream.listen((candle) {
      add(CheckStrategySignal(candle)); // Ø­Ø¯Ø« ÙØ­Øµ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©
    });
  }
}
EOF
cat > lib/core/ui/theme/app_themes.dart << 'EOF'
import 'package:flutter/material.dart';

final ThemeData lightTheme = ThemeData(
  colorScheme: ColorScheme.fromSeed(seedColor: Colors.indigo),
  useMaterial3: true,
  scaffoldBackgroundColor: Colors.white,
);

final ThemeData darkTheme = ThemeData(
  brightness: Brightness.dark,
  colorScheme: ColorScheme.fromSeed(seedColor: Colors.indigo),
  useMaterial3: true,
);
EOF
cat > lib/core/ui/widgets/base_scaffold.dart << 'EOF'
import 'package:flutter/material.dart';

class BaseScaffold extends StatelessWidget {
  final String title;
  final Widget body;
  final List<Widget>? actions;

  const BaseScaffold({
    required this.title,
    required this.body,
    this.actions,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(title),
        actions: actions,
      ),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: body,
        ),
      ),
    );
  }
}
EOF
cat > lib/core/navigation/app_router.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

import '../ui/widgets/error_screen.dart';
import '../../features/home/presentation/pages/home_page.dart';
import '../../features/settings/presentation/pages/settings_page.dart';
import '../../features/chart/presentation/pages/chart_page.dart';
import '../../features/trading/presentation/pages/trading_page.dart';

final appRouter = GoRouter(
  initialLocation: '/',
  debugLogDiagnostics: true,
  errorBuilder: (context, state) => ErrorScreen(state.error.toString()),
  routes: [
    GoRoute(
      path: '/',
      pageBuilder: (c, s) => MaterialPage(child: HomePage()),
    ),
    GoRoute(
      path: '/settings',
      pageBuilder: (c, s) => MaterialPage(child: SettingsPage()),
    ),
    GoRoute(
      path: '/chart',
      pageBuilder: (c, s) {
        final symbol = s.queryParams['symbol'] ?? "";
        return MaterialPage(child: ChartPage(symbol: symbol));
      },
    ),
    GoRoute(
      path: '/trading',
      pageBuilder: (c, s) => MaterialPage(child: TradingPage()),
    ),
  ],
);
EOF
cat > lib/core/ui/widgets/loading_widget.dart << 'EOF'
import 'package:flutter/material.dart';

class LoadingWidget extends StatelessWidget {
  final String message;
  const LoadingWidget({this.message = "Loading..."});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          CircularProgressIndicator(),
          SizedBox(height: 12),
          Text(message, style: Theme.of(context).textTheme.bodyMedium),
        ],
      ),
    );
  }
}
EOF
cat > lib/core/ui/widgets/error_screen.dart << 'EOF'
import 'package:flutter/material.dart';

class ErrorScreen extends StatelessWidget {
  final String message;
  const ErrorScreen(this.message);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(mainAxisSize: MainAxisSize.min, children: [
          Icon(Icons.error, size: 64, color: Colors.red),
          SizedBox(height: 12),
          Text(message, textAlign: TextAlign.center),
          SizedBox(height: 20),
          ElevatedButton(
            child: Text("Retry"),
            onPressed: () => Navigator.pop(context),
          ),
        ]),
      ),
    );
  }
}
EOF
cat > lib/core/ui/widgets/shimmer_placeholder.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

class ShimmerPlaceholder extends StatelessWidget {
  final double width;
  final double height;

  const ShimmerPlaceholder({required this.width, required this.height});

  @override
  Widget build(BuildContext context) {
    return Shimmer.fromColors(
      baseColor: Colors.grey.shade300,
      highlightColor: Colors.grey.shade100,
      child: Container(
        width: width,
        height: height,
        color: Colors.grey,
      ),
    );
  }
}
EOF
cat > lib/features/chart/presentation/pages/chart_page.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../core/ui/widgets/loading_widget.dart';
import '../widgets/chart_webview.dart';
import '../../presentation/bloc/live_chart/live_chart_bloc.dart';

class ChartPage extends StatefulWidget {
  final String symbol;
  const ChartPage({required this.symbol});

  @override
  State<ChartPage> createState() => _ChartPageState();
}

class _ChartPageState extends State<ChartPage> {
  String _timeframe = "M1";

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("Chart: \${widget.symbol}"),
        actions: [
          PopupMenuButton<String>(
            onSelected: (tf) {
              setState(() => _timeframe = tf);
              context.read<LiveChartBloc>().add(LoadLiveCandlesRequest(
                    widget.symbol,
                    tf,
                  ));
            },
            itemBuilder: (c) => [
              "M1",
              "M5",
              "M15",
              "H1",
            ].map((tf) => PopupMenuItem(
                  value: tf,
                  child: Text(tf),
                )).toList(),
          ),
        ],
      ),
      body: BlocBuilder<LiveChartBloc, LiveChartState>(
        builder: (c, state) {
          if (state is LiveChartLoading)
            return LoadingWidget(message: "Loading Candles...");
          if (state is LiveChartLoaded)
            return ChartWebView(
              candles: state.candles,
              emaShort: state.emaShort,
              emaLong: state.emaLong,
              rsi: state.rsi,
            );
          return ErrorScreen("Failed to load chart");
        },
      ),
    );
  }
}
EOF
cat > lib/core/ui/widgets/add_to_watchlist_sheet.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../../core/storage/watchlist.dart';

class AddToWatchlistSheet extends StatelessWidget {
  final String symbol;
  const AddToWatchlistSheet(this.symbol);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: EdgeInsets.all(16),
      child: Column(mainAxisSize: MainAxisSize.min, children: [
        Text("Add \${symbol} to Watchlist?"),
        SizedBox(height: 10),
        ElevatedButton(
          child: Text("Add"),
          onPressed: () {
            WatchlistManager().add(symbol);
            Navigator.pop(context);
          },
        ),
      ]),
    );
  }
}
EOF
cat > lib/features/settings/presentation/pages/theme_switch.dart << 'EOF'
import 'package:flutter/material.dart';
import '../../../../core/storage/app_preferences.dart';

class ThemeSwitch extends StatefulWidget {
  @override
  _ThemeSwitchState createState() => _ThemeSwitchState();
}

class _ThemeSwitchState extends State<ThemeSwitch> {
  bool _isDark = false;

  @override
  void initState() {
    super.initState();
    AppPreferences.loadThemeMode().then((d) {
      setState(() => _isDark = d);
    });
  }

  @override
  Widget build(BuildContext context) {
    return SwitchListTile(
      title: Text("Dark Mode"),
      value: _isDark,
      onChanged: (v) {
        AppPreferences.saveThemeMode(v);
        setState(() => _isDark = v);
      },
    );
  }
}
EOF
cat > lib/core/ui/widgets/responsive_widget.dart << 'EOF'
import 'package:flutter/material.dart';

class ResponsiveWidget extends StatelessWidget {
  final Widget mobile;
  final Widget tablet;

  const ResponsiveWidget({
    required this.mobile,
    required this.tablet,
  });

  @override
  Widget build(BuildContext context) => LayoutBuilder(
        builder: (context, constraints) {
          if (constraints.maxWidth > 600) return tablet;
          return mobile;
        },
      );
}
EOF
cat > test/unit/models/candle_tick_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/features/market/domain/models/candle.dart';
import 'package:my_app/features/market/domain/models/tick.dart';

void main() {
  test('Candle from REST JSON parsing', () {
    final json = {
      "time": "2025-01-01T10:00:00Z",
      "o": "1.1",
      "h": "1.2",
      "l": "1.05",
      "c": "1.15",
      "volume": "100"
    };

    final c = Candle.fromRestJson(json);
    expect(c.open, 1.1);
    expect(c.high, 1.2);
    expect(c.low, 1.05);
    expect(c.close, 1.15);
    expect(c.volume, 100);
  });

  test('Tick from OANDA WS JSON', () {
    final json = {
      "type": "PRICE",
      "time": "2025-01-01T10:00:01Z",
      "bids": [
        {"price": "1.25"}
      ],
      "asks": [
        {"price": "1.26"}
      ]
    };

    final t = Tick.fromOandaWs(json);
    expect(t.bid, 1.25);
    expect(t.ask, 1.26);
  });
}
EOF
cat > test/unit/network/rest_client_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:http/http.dart' as http;
import 'package:http/testing.dart';
import 'dart:convert';

import 'package:my_app/core/network/rest/rest_client.dart';

void main() {
  test('REST GET success', () async {
    final mockClient = MockClient((request) async {
      return http.Response(jsonEncode({"result": "ok"}), 200);
    });

    final client = RestClient();
    final res = await client.get("/test", headers: {"x": "y"});
    expect(res["result"], "ok");
  });

  test('REST GET failure throws', () async {
    final mockClient = MockClient((request) async {
      return http.Response("Error", 500);
    });

    final client = RestClient();
    expect(() => client.get("/fail"), throwsA(isA<Exception>());
  });
}
EOF
cat > test/bloc/market_bloc_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:bloc_test/bloc_test.dart';
import 'package:my_app/features/market/presentation/bloc/market/market_bloc.dart';
import 'package:my_app/features/market/presentation/bloc/market/market_state.dart';
import 'package:my_app/features/market/presentation/bloc/market/market_event.dart';
import 'package:my_app/features/market/data/market_repository.dart';
import 'package:my_app/core/network/rest/rest_client.dart';
import 'package:my_app/features/market/domain/streaming/live_stream_adapter.dart';

class FakeRepo extends MarketRepository {
  @override
  Future<List> getCandlesCached(
      String accountId, String instrument, String timeframe) async {
    return [];
  }
}

void main() {
  blocTest<MarketBloc, MarketState>(
    'MarketBloc load history',
    build: () => MarketBloc(FakeRepo(), LiveStreamAdapter()),
    act: (bloc) => bloc.add(LoadHistory("acc", "SYM", "M1")),
    expect: () => [isA<MarketLoadingHistory>(), isA<MarketHistoryReady>()],
  );
}
EOF
cat > test/widget/home_page_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter/material.dart';
import 'package:my_app/features/home/presentation/pages/home_page.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:my_app/features/market/presentation/bloc/oanda/oanda_bloc.dart';

void main() {
  testWidgets("Home Page loads and shows buttons",
      (WidgetTester tester) async {
    await tester.pumpWidget(
      MaterialApp(home: HomePage()),
    );

    expect(find.text("Fetch OANDA Instruments"), findsOneWidget);
    expect(find.text("Settings"), findsOneWidget);
  });
}
EOF
cat > integration_test/app_flow_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:my_app/main.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  testWidgets("App Launch and Navigate", (WidgetTester tester) async {
    await tester.pumpWidget(MyApp());
    await tester.pumpAndSettle();
    expect(find.text("Dashboard"), findsOneWidget);

    await tester.tap(find.text("Settings"));
    await tester.pumpAndSettle();
    expect(find.text("OANDA Settings"), findsOneWidget);
  });
}
EOF
cat > test/network/ws/ws_pipeline_test.dart << 'EOF'
import 'package:flutter_test/flutter_test.dart';
import 'package:my_app/core/network/ws/pipeline/ws_pipeline.dart';

void main() {
  test("Pipeline buffers and emits in order", () {
    final pipeline = WsPipeline(maxBufferSize: 3);
    final events = [];

    pipeline.stream.listen((data) {
      events.add(data);
    });

    pipeline.push(1);
    pipeline.push(2);
    pipeline.push(3);

    expect(events, [1, 2, 3]);
  });
}
EOF
cat > â€¦ << 'EOF'
â€¦ ÙƒÙˆØ¯
EOF
cat > lib/core/ui/widgets/optimized_chart_webview.dart << 'EOF'
import 'package:flutter/material.dart';
import 'package:webview_flutter/webview_flutter.dart';

class OptimizedChartWebView extends StatefulWidget {
  final List<Map<String, dynamic>> candles;
  final List<Map<String, dynamic>> emaShort;
  final List<Map<String, dynamic>> emaLong;
  final List<Map<String, dynamic>> rsi;

  const OptimizedChartWebView({
    required this.candles,
    required this.emaShort,
    required this.emaLong,
    required this.rsi,
    Key? key,
  }) : super(key: key);

  @override
  _OptimizedChartWebViewState createState() => _OptimizedChartWebViewState();
}

class _OptimizedChartWebViewState extends State<OptimizedChartWebView> {
  late final WebViewController _ctrl;

  @override
  void initState() {
    super.initState();
    _ctrl = WebViewController();
  }

  @override
  Widget build(BuildContext context) {
    return WebViewWidget(controller: _ctrl);
  }
}
EOF
cat > android/app/build.gradle << 'EOF'
android {
    flavorDimensions "env"
    productFlavors {
        dev {
            dimension "env"
            applicationIdSuffix ".dev"
        }
        staging {
            dimension "env"
        }
        prod {
            dimension "env"
        }
    }
    buildTypes {
        release {
            minifyEnabled true
            shrinkResources true
            signingConfig signingConfigs.release
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
EOF
cat > android/app/build.gradle << 'EOF'
android {
    buildTypes {
        release {
            dartObfuscate true
            minifyEnabled true
            shrinkResources true
        }
    }
}
EOF
cat > android/key.properties << 'EOF'
storePassword=YOUR_STORE_PASS
keyPassword=YOUR_KEY_PASS
keyAlias=myapp
storeFile=../myapp.keystore
EOF
cat > android/app/proguard-rules.pro << 'EOF'
# ProGuard rules here
EOF
cat > lib/core/firebase/firebase_init.dart << 'EOF'
import 'package:firebase_core/firebase_core.dart';
import 'package:flutter/material.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';

Future<void> initFirebase() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp();
  FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;
}
EOF
cat > lib/core/logging/performance_logger.dart << 'EOF'
import 'dart:developer';

class PerformanceLogger {
  static void start(String name) => Timeline.startSync(name);
  static void end() => Timeline.finishSync();
}
EOF
cat > lib/core/error/global_error_handler.dart << 'EOF'
import 'package:flutter/material.dart';

void setupGlobalErrorHandler() {
  FlutterError.onError = (details) {
    FlutterError.presentError(details);
  };
}
EOF
cat > scripts/release_android.sh << 'EOF'
#!/usr/bin/env bash
EOF
cat > scripts/release_ios.sh << 'EOF'
#!/usr/bin/env bash
EOF

echo "âœ… Batch 2 completed (No Flutter commands)"
date

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: batch_scripts_fixed/batch_002.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 862: batch_scripts_fixed/batch_001.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/batch_scripts_fixed/batch_001.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 18.6 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 475
================================================================================

#!/bin/bash
# Batch 1 of 2
# Commands: 460 (Flutter commands filtered out)
set -e  # Stop on error

echo "ğŸš€ Batch 1/2 - 460 commands (No Flutter)"
date

# Create all directories first
mkdir -p -p ~/projects/flutter_trading_app
mkdir -p -p lib/core/errors
mkdir -p -p lib/core/usecases
mkdir -p -p lib/core/utils
mkdir -p -p lib/features/market/data/models
mkdir -p -p lib/features/market/data/datasources
mkdir -p -p lib/features/market/data/repositories
mkdir -p -p lib/features/market/domain/entities
mkdir -p -p lib/features/market/domain/repositories
mkdir -p -p lib/features/market/domain/usecases
mkdir -p -p lib/features/market/presentation/bloc
mkdir -p -p lib/features/market/presentation/pages
mkdir -p -p lib/features/market/presentation/widgets
mkdir -p -p lib/features/market/domain/entities
mkdir -p -p lib/features/market/domain/usecases
mkdir -p -p lib/features/market/data/datasources
mkdir -p -p lib/features/market/presentation/pages
mkdir -p -p lib/features/market/presentation/pages
mkdir -p -p lib/features/market/domain/indicators
mkdir -p -p lib/features/market/data/indicators
mkdir -p -p lib/features/market/domain/trading
mkdir -p -p lib/features/market/data/trading
mkdir -p -p lib/features/market/domain/backtest
mkdir -p -p lib/features/market/data/backtest
mkdir -p -p lib/features/market/presentation/pages/backtest
mkdir -p -p lib/features/market/presentation/widgets/backtest
mkdir -p -p lib/features/market/presentation/pages/settings
mkdir -p -p lib/features/market/presentation/widgets/settings
mkdir -p -p lib/features/market/data/storage
mkdir -p -p lib/core/errors
mkdir -p -p test/core
mkdir -p -p test/features/market/domain
mkdir -p -p test/features/market/data
mkdir -p -p test/features/market/presentation
mkdir -p -p .github/workflows
mkdir -p -p lib/features/market/presentation/bloc/oanda
mkdir -p -p lib/features/market/presentation/bloc/markets
mkdir -p -p lib/features/market/presentation/bloc/chart
mkdir -p -p lib/features/market/presentation/bloc/trading
mkdir -p -p lib/features/market/presentation/bloc/backtest
mkdir -p -p lib/features/market/presentation/bloc/settings
mkdir -p -p lib/features/market/presentation/bloc/chart
mkdir -p -p lib/features/market/presentation/bloc/trading
mkdir -p -p lib/core/widgets
mkdir -p -p lib/features/market/domain/strategy
mkdir -p -p lib/features/market/domain/usecases
mkdir -p -p .github/workflows
mkdir -p -p lib/features/market/data/datasources
mkdir -p -p lib/features/market/presentation/widgets
mkdir -p -p lib/features/market/presentation/widgets/drawing_tools
mkdir -p -p lib/features/market/presentation/bloc/drawing_tools
mkdir -p -p lib/core/notifications
mkdir -p -p lib/features/market/domain/alerts
mkdir -p -p lib/features/market/presentation/bloc/alerts
mkdir -p -p lib/features/market/presentation/pages/alerts
mkdir -p -p lib/features/market/presentation/bloc/backtest
mkdir -p -p lib/features/market/presentation/pages/backtest
mkdir -p -p lib/features/market/presentation/bloc/settings
mkdir -p -p lib/features/market/presentation/pages/settings
mkdir -p -p lib/features/market/presentation/bloc/...
mkdir -p -p lib/core/isolate
mkdir -p -p lib/features/market/presentation/widgets/custom_chart
mkdir -p -p lib/features/market/domain/trading/orders
mkdir -p -p lib/features/market/presentation/bloc/trading_real
mkdir -p -p lib/features/market/data/models/position
mkdir -p -p lib/features/market/presentation/bloc/positions
mkdir -p -p lib/features/market/presentation/pages/positions
mkdir -p -p lib/features/market/domain/audit
mkdir -p -p lib/features/market/data/repositories/audit
mkdir -p -p lib/features/market/presentation/bloc/audit
mkdir -p -p lib/features/market/presentation/pages/audit
mkdir -p -p lib/features/market/domain/indicators/advanced
mkdir -p -p lib/features/market/domain/alerts/smart
mkdir -p -p lib/features/market/domain/alerts/smart/engine
mkdir -p -p lib/features/market/presentation/bloc/smart_alert
mkdir -p -p lib/features/market/domain/analytics
mkdir -p -p lib/features/market/presentation/bloc/analytics
mkdir -p -p lib/features/market/presentation/pages/analytics
mkdir -p -p lib/features/settings/domain/theme
mkdir -p -p lib/features/settings/data/theme
mkdir -p -p lib/features/settings/presentation/bloc/theme
mkdir -p -p lib/features/settings/presentation/pages/theme
mkdir -p -p test/unit
mkdir -p -p test/integration
mkdir -p -p test/widget
mkdir -p -p android/app/src/staging/res/values
mkdir -p -p android/app/src/dev/res/values
mkdir -p -p lib/core/widgets/loading
mkdir -p -p lib/features/market/domain/strategy/multi
mkdir -p -p lib/features/market/presentation/bloc/strategy_comparison
mkdir -p -p lib/features/market/presentation/pages/strategy_comparison
mkdir -p -p lib/features/market/domain/indicators/types
mkdir -p -p lib/features/market/domain/chart
mkdir -p -p lib/features/market/presentation/widgets/custom_chart/utils
mkdir -p -p lib/features/replay/domain/entities
mkdir -p -p lib/features/replay/data/datasources
mkdir -p -p lib/features/replay/domain/engine
mkdir -p -p lib/features/replay/presentation/bloc
mkdir -p -p lib/features/replay/presentation/pages
mkdir -p -p lib/features/strategy_builder/domain/entities
mkdir -p -p lib/features/strategy_builder/domain/models
mkdir -p -p lib/features/strategy_builder/presentation/widgets
mkdir -p -p lib/features/strategy_builder/presentation/pages
mkdir -p -p lib/features/strategy_builder/presentation/canvas
mkdir -p -p lib/features/strategy_builder/domain/interpreter
mkdir -p -p lib/features/strategy_builder/data
mkdir -p -p lib/features/portrait/presentation/pages
mkdir -p -p lib/features/strategy_script/domain
mkdir -p -p lib/features/strategy_script/presentation/pages
mkdir -p -p lib/features/market/presentation/widgets/chart_utils
mkdir -p -p lib/features/market/domain/backtest
mkdir -p -p lib/core/storage/theme
mkdir -p -p lib/core/storage/script
mkdir -p -p lib/core/storage/audit
mkdir -p -p lib/core/storage/indicator
mkdir -p -p lib/core/storage/oanda
mkdir -p -p test/domain/indicators
mkdir -p -p test/domain/backtest
mkdir -p -p test/bloc
mkdir -p -p test/widgets
mkdir -p -p lib/core/models
mkdir -p -p test/models
mkdir -p -p lib/features/strategy/domain/ast
mkdir -p -p lib/features/strategy/domain/indicators
mkdir -p -p lib/features/strategy/domain/evaluator
mkdir -p -p test/strategy
mkdir -p -p lib/core/network
mkdir -p -p lib/features/market/data/streaming
mkdir -p -p lib/features/market/data/rest
mkdir -p -p test/ws
mkdir -p -p lib/features/strategy/domain/indicators
mkdir -p -p test/indicators
mkdir -p -p lib/features/market/domain/backtest
mkdir -p -p test/backtest
mkdir -p -p test/bloc/oanda_setup
mkdir -p -p test/bloc/chart
mkdir -p -p test/bloc/trading
mkdir -p -p test/bloc/backtest
mkdir -p -p lib/core/storage/strategy
mkdir -p -p test/bloc/strategy_builder
mkdir -p -p lib/core/storage/theme
mkdir -p -p test/storage/theme
mkdir -p -p lib/core/storage/script
mkdir -p -p test/storage/script
mkdir -p -p lib/core/storage/audit
mkdir -p -p test/storage/audit
mkdir -p -p lib/core/storage/indicator
mkdir -p -p test/storage/indicator
mkdir -p -p lib/core/storage/replay
mkdir -p -p test/unit/indicators
mkdir -p -p test/unit/backtest
mkdir -p -p test/unit/streaming
mkdir -p -p test/bloc/replay
mkdir -p -p integration_test
mkdir -p -p test/integration/ws
mkdir -p -p lib/core/sync
mkdir -p -p test/sync
mkdir -p -p test/widgets/chart
mkdir -p -p lib/core/network
mkdir -p -p lib/market/data/repositories
mkdir -p -p lib/core/storage/chart_cache
mkdir -p -p test/widgets/offline
mkdir -p -p lib/core/time
mkdir -p -p lib/core/models/price
mkdir -p -p lib/features/strategy/domain/ast
mkdir -p -p lib/features/strategy/domain/signal
mkdir -p -p lib/features/strategy/domain/fsm
mkdir -p -p lib/features/trading/domain
mkdir -p -p lib/features/trading/domain/order
mkdir -p -p lib/features/trading/domain/errors
mkdir -p -p lib/features/trading/domain/history
mkdir -p -p lib/features/trading/domain/audit
mkdir -p -p lib/core/models/dto
mkdir -p -p lib/features/market/domain/repository
mkdir -p -p lib/features/market/data/repository
mkdir -p -p lib/features/trading/domain/interface
mkdir -p -p lib/features/trading/domain/usecases
mkdir -p -p lib/core/async
mkdir -p -p lib/features/market/presentation/bloc/chart
mkdir -p -p lib/features/backtest/domain
mkdir -p -p lib/features/common/data/cache
mkdir -p -p lib/core/network/websocket
mkdir -p -p lib/features/market/data/cache
mkdir -p -p lib/features/market/domain/sync
mkdir -p -p lib/features/indicators/domain
mkdir -p -p lib/features/chart/domain/tools
mkdir -p -p lib/core/storage/hive
mkdir -p -p lib/features/indicators/engine
mkdir -p -p lib/features/indicators/plugins
mkdir -p -p assets/js
mkdir -p -p lib/core/navigation
mkdir -p -p lib/core/widgets
mkdir -p -p lib/features/settings/domain
mkdir -p -p lib/features/settings/presentation
mkdir -p -p lib/features/alerts/domain
mkdir -p -p lib/features/alerts/data
mkdir -p -p lib/features/analytics/domain
mkdir -p -p lib/features/market/presentation/screens
mkdir -p -p lib/features/trading/data/exchanges/crypto
mkdir -p -p lib/features/trading/data/exchanges/stock
mkdir -p -p lib/features/settings/presentation/widgets
mkdir -p -p lib/features/strategy/domain/dsl
mkdir -p -p lib/core/export
mkdir -p -p lib/core/integration/telegram
mkdir -p -p lib/core/export/pdf
mkdir -p -p lib/core/sync/cloud
mkdir -p -p lib/core/export/settings
mkdir -p -p lib/core/permissions
mkdir -p -p lib/features/dashboard/presentation
mkdir -p -p lib/features/replay/domain
mkdir -p -p lib/features/replay/presentation/bloc
mkdir -p -p lib/features/market_depth/domain
mkdir -p -p lib/features/market_depth/presentation/widgets
mkdir -p -p lib/features/market_depth/presentation/bloc
mkdir -p -p lib/features/tape/domain
mkdir -p -p lib/features/tape/presentation/widgets
mkdir -p -p lib/core/network/ws
mkdir -p -p lib/core/streams
mkdir -p -p lib/features/market/data/repository
mkdir -p -p lib/core/compute
mkdir -p -p lib/features/chart/domain
mkdir -p -p lib/features/indicators/domain
mkdir -p -p lib/core/compute
mkdir -p -p lib/features/alerts/data
mkdir -p -p lib/core/storage/sync
mkdir -p -p lib/core/network/ws/parsers
mkdir -p -p lib/features/strategy/domain/dsl
mkdir -p -p lib/features/market/data/cache
mkdir -p -p lib/core/bloc/init
mkdir -p -p lib/core/network/rest
mkdir -p -p lib/features/indicators/data/cache
mkdir -p -p lib/features/strategy/domain
mkdir -p -p lib/core/state/event
mkdir -p -p lib/core/network/ws
mkdir -p -p lib/core/network/retry
mkdir -p -p lib/core/state/shared
mkdir -p -p lib/features/backtest/domain
mkdir -p -p lib/core/state/bloc
mkdir -p -p lib/features/chart/domain
mkdir -p -p lib/features/market/domain
mkdir -p -p lib/features/replay/domain
mkdir -p -p lib/core/widgets/fix
mkdir -p -p lib/features/replay/domain
mkdir -p -p lib/core/lifecycle
mkdir -p -p lib/core/bloc/sync
mkdir -p -p lib/features/trading/domain
mkdir -p -p lib/features/backtest/domain
mkdir -p -p lib/core/lifecycle
mkdir -p -p lib/core/network/ws/lifecycle
mkdir -p -p lib/core/state/tab
mkdir -p -p lib/core/network/ws
mkdir -p -p lib/core/network/rest/parsers
mkdir -p -p lib/core/network/ws/error
mkdir -p -p lib/features/backtest/domain/cancel
mkdir -p -p lib/core/webview
mkdir -p -p lib/features/settings/domain
mkdir -p -p lib/core/network/retry
mkdir -p -p lib/core/storage/transaction
mkdir -p -p lib/core/bloc/subscription_manager
mkdir -p -p lib/core/filters
mkdir -p -p lib/core/queue
mkdir -p -p lib/features/backtest/domain
mkdir -p -p lib/features/trading/data
mkdir -p -p lib/core/sync
mkdir -p -p lib/features/chart/domain/drawing
mkdir -p -p lib/core/buffer
mkdir -p -p lib/core/widgets
mkdir -p -p lib/core/lifecycle
mkdir -p -p lib/features/chart/presentation/bloc
mkdir -p -p lib/features/market/data/repository
mkdir -p -p lib/core/network/ws/smart
mkdir -p -p lib/features/market/presentation/bloc/ws
mkdir -p -p lib/core/data/sanitizer
mkdir -p -p lib/core/network/rest/parsers
mkdir -p -p lib/core/network/ws/parsers
mkdir -p -p lib/features/replay/domain/controller
mkdir -p -p lib/features/replay/presentation/bloc
mkdir -p -p lib/features/backtest/domain/engine
mkdir -p -p lib/features/settings/domain/controllers
mkdir -p -p lib/core/sync
mkdir -p -p lib/features/market/presentation/bloc
mkdir -p -p lib/core/network/error
mkdir -p -p lib/features/market/data/repository
mkdir -p -p lib/core/utils
mkdir -p -p lib/features/market/presentation/bloc
mkdir -p -p lib/core/mode
mkdir -p -p lib/features/backtest/presentation/bloc
mkdir -p -p lib/core/persistence
mkdir -p -p lib/core/lifecycle
mkdir -p -p lib/core/persistence
mkdir -p -p lib/core/time
mkdir -p -p lib/core/bloc/mixins
mkdir -p -p lib/core/state/shared
mkdir -p -p lib/core/network/rest/parsers
mkdir -p -p lib/core/webview
mkdir -p -p lib/features/backtest/domain/strategy
mkdir -p -p lib/features/settings/data
mkdir -p -p lib/core/compute
mkdir -p -p lib/features/alerts/domain
mkdir -p -p lib/core/sync
mkdir -p -p lib/features/strategy/domain
mkdir -p -p lib/core/cache
mkdir -p -p lib/core/chart
mkdir -p -p lib/core/filters
mkdir -p -p lib/features/trading/domain
mkdir -p -p lib/core/network/retry
mkdir -p -p lib/core/bloc/guards
mkdir -p -p lib/core/widgets/fix
mkdir -p -p lib/core/chart/update
mkdir -p -p lib/core/market
mkdir -p -p lib/core/sync
mkdir -p -p lib/features/indicators/domain
mkdir -p -p lib/core/webview/guard
mkdir -p -p lib/core/network/rest/guard
mkdir -p -p lib/core/bloc/mixins
mkdir -p -p lib/features/indicators/domain/gap
mkdir -p -p lib/core/navigation
mkdir -p -p lib/core/compute
mkdir -p -p lib/core/filters
mkdir -p -p lib/core/localization
mkdir -p -p lib/core/utils
mkdir -p -p lib/core/mode
mkdir -p -p lib/core/sync
mkdir -p -p lib/features/backtest/domain/check
mkdir -p -p lib/core/widgets
mkdir -p -p lib/core/network/rest/parsers
mkdir -p -p lib/core/network/ws/backoff
mkdir -p -p lib/core/storage
mkdir -p -p lib/core/widgets
mkdir -p -p lib/core/navigation
mkdir -p -p lib/core/network/rest/timeout
mkdir -p -p lib/core/bloc/mixins
mkdir -p -p lib/core/widgets/mixins
mkdir -p -p lib/core/ui
mkdir -p -p lib/core/time
mkdir -p -p lib/core/chart/data
mkdir -p -p lib/features/market_depth/domain
mkdir -p -p lib/features/trading/domain/execution
mkdir -p -p lib/core/network/ws/security
mkdir -p -p lib/core/security
mkdir -p -p lib/core/network/rest/throttle
mkdir -p -p lib/core/state/paging
mkdir -p -p lib/core/network/ws/manager
mkdir -p -p lib/core/chart/gap
mkdir -p -p lib/core/bloc/mixins
mkdir -p -p lib/features/market/presentation/bloc/chart
mkdir -p -p lib/features/market_depth/presentation/bloc
mkdir -p -p lib/core/cache
mkdir -p -p lib/features/trading/domain/execution
mkdir -p -p lib/core/security
mkdir -p -p lib/features/watchlist/domain
mkdir -p -p lib/core/compute
mkdir -p -p lib/core/network/manager
mkdir -p -p lib/features/chart/data/storage
mkdir -p -p lib/features/indicators/render
mkdir -p -p lib/core/network/rest/guard
mkdir -p -p lib/core/ui/fonts
mkdir -p -p lib/core/state/empty
mkdir -p -p lib/core/notifications
mkdir -p -p lib/core/state/paging
mkdir -p -p lib/core/storage
mkdir -p -p lib/core/state/guard
mkdir -p -p lib/features/trading/domain/execution
mkdir -p -p lib/features/backtest/domain/engine
mkdir -p -p lib/core/network/ws/parsers
mkdir -p -p lib/core/storage
mkdir -p -p lib/core/sync
mkdir -p -p lib/core/network/ws/registry
mkdir -p -p lib/core/startup
mkdir -p -p lib/features/trading/presentation/bloc
mkdir -p -p lib/core/chart/filter
mkdir -p -p lib/core/models/factories
mkdir -p -p lib/features/chart/domain/drawing
mkdir -p -p lib/features/trading/domain/simulation
mkdir -p -p lib/core/network/ws/smart
mkdir -p -p lib/core/bloc/mixins
mkdir -p -p lib/core/models/adapters
mkdir -p -p lib/core/di
mkdir -p -p lib/core/navigation
mkdir -p -p lib/core/bloc
mkdir -p -p lib/core/startup
mkdir -p -p lib/core/ui
mkdir -p -p lib/core/models/adapters
mkdir -p -p lib/features/home/presentation
mkdir -p -p lib/features/home/presentation/pages
mkdir -p -p lib/features/chart/presentation/pages
mkdir -p -p lib/features/settings/presentation/pages
mkdir -p -p lib/features/trading/presentation/pages
mkdir -p -p lib/features/backtest/presentation/pages
mkdir -p -p lib/core/network/oanda
mkdir -p -p lib/core/security
mkdir -p -p lib/core/network/oanda/client
mkdir -p -p lib/core/network/oanda/stream
mkdir -p -p lib/features/market/data
mkdir -p -p lib/features/market/presentation/bloc/oanda
mkdir -p -p lib/features/chart/presentation/bloc
mkdir -p -p lib/features/settings/presentation/pages
mkdir -p -p assets/lightweight_charts
mkdir -p -p lib/features/chart/presentation/widgets
mkdir -p -p lib/features/chart/presentation/bloc/live_chart
mkdir -p -p lib/features/indicators/domain
mkdir -p -p lib/features/indicators/presentation/bloc
mkdir -p -p assets/lightweight_charts
mkdir -p -p lib/features/chart/presentation/widgets
mkdir -p -p lib/features/chart/presentation/bloc/live_chart
mkdir -p -p lib/features/market/domain/aggregator
mkdir -p -p lib/features/market/domain/timeframes
mkdir -p -p lib/features/trading/domain/execution
mkdir -p -p lib/features/trading/data
mkdir -p -p lib/features/trading/presentation/bloc
mkdir -p -p lib/core/security/refresh
mkdir -p -p lib/core/network/security
mkdir -p -p lib/core/network/retry
mkdir -p -p lib/core/logging
mkdir -p -p lib/core/ui/widgets
mkdir -p -p lib/core/ui/styles
mkdir -p -p lib/features/trading/presentation/widgets
mkdir -p -p lib/core/storage
mkdir -p -p lib/core/settings
mkdir -p -p lib/core/logging/ui
mkdir -p -p test/unit
mkdir -p -p test/integration
mkdir -p -p test/widget
mkdir -p -p lib/flavors
mkdir -p -p .github/workflows
mkdir -p -p docs
mkdir -p -p lib/core/network/rest
mkdir -p -p lib/core/network/ws/transport
mkdir -p -p lib/core/network/ws/pipeline
mkdir -p -p lib/features/market/domain/streaming
mkdir -p -p lib/features/market/presentation/bloc/stream
mkdir -p -p lib/features/market/domain/models
mkdir -p -p lib/features/trading/domain/models
mkdir -p -p lib/core/network/security/pinning
mkdir -p -p test/pinning
mkdir -p -p lib/core/network/retry
mkdir -p -p lib/core/storage/hive_adapters
mkdir -p -p lib/core/storage/cache
mkdir -p -p lib/core/bloc
mkdir -p -p lib/core/bloc/subscriptions
mkdir -p -p lib/features/market/presentation/bloc/market
mkdir -p -p lib/core/error
mkdir -p -p lib/features/market/presentation/bloc/market
mkdir -p -p lib/features/market/presentation/bloc/stream
mkdir -p -p lib/core/bloc/root
mkdir -p -p lib/core/bloc/providers
mkdir -p -p lib/core/ui/theme
mkdir -p -p lib/core/ui/widgets
mkdir -p -p lib/core/navigation
mkdir -p -p test/unit/models
mkdir -p -p test/unit/domain
mkdir -p -p test/unit/network
mkdir -p -p test/bloc
mkdir -p -p test/widget
mkdir -p -p integration_test
mkdir -p -p test/network/ws
mkdir -p â€¦ 
mkdir -p -p lib/core/ui/widgets
mkdir -p -p lib/core/error
mkdir -p -p scripts

echo 'âœ… All directories created'


echo "âœ… Batch 1 completed (No Flutter commands)"
date

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: batch_scripts_fixed/batch_001.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 863: ios/Flutter/AppFrameworkInfo.plist
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Flutter/AppFrameworkInfo.plist
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Plist
Ø§Ù„Ø­Ø¬Ù…: 720.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 24
================================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>CFBundleDevelopmentRegion</key>
  <string>en</string>
  <key>CFBundleExecutable</key>
  <string>App</string>
  <key>CFBundleIdentifier</key>
  <string>io.flutter.flutter.app</string>
  <key>CFBundleInfoDictionaryVersion</key>
  <string>6.0</string>
  <key>CFBundleName</key>
  <string>App</string>
  <key>CFBundlePackageType</key>
  <string>FMWK</string>
  <key>CFBundleShortVersionString</key>
  <string>1.0</string>
  <key>CFBundleSignature</key>
  <string>????</string>
  <key>CFBundleVersion</key>
  <string>1.0</string>
</dict>
</plist>

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Flutter/AppFrameworkInfo.plist
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 864: ios/Flutter/flutter_export_environment.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Flutter/flutter_export_environment.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 614.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

#!/bin/sh
# This is a generated file; do not edit or check into version control.
export "FLUTTER_ROOT=/root/flutter"
export "FLUTTER_APPLICATION_PATH=/root/falto"
export "FLUTTER_FRAMEWORK_SWIFT_PACKAGE_PATH=/root/falto/ios/Flutter/ephemeral/Packages/.packages/FlutterFramework"
export "COCOAPODS_PARALLEL_CODE_SIGN=true"
export "FLUTTER_TARGET=lib/main.dart"
export "FLUTTER_BUILD_DIR=build"
export "FLUTTER_BUILD_NAME=1.0.0"
export "FLUTTER_BUILD_NUMBER=1"
export "DART_OBFUSCATION=false"
export "TRACK_WIDGET_CREATION=true"
export "TREE_SHAKE_ICONS=false"
export "PACKAGE_CONFIG=.dart_tool/package_config.json"

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Flutter/flutter_export_environment.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 865: ios/Flutter/ephemeral/flutter_lldb_helper.py
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/ios/Flutter/ephemeral/flutter_lldb_helper.py
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Python
Ø§Ù„Ø­Ø¬Ù…: 1.2 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 32
================================================================================

#
# Generated file, do not edit.
#

import lldb

def handle_new_rx_page(frame: lldb.SBFrame, bp_loc, extra_args, intern_dict):
    """Intercept NOTIFY_DEBUGGER_ABOUT_RX_PAGES and touch the pages."""
    base = frame.register["x0"].GetValueAsAddress()
    page_len = frame.register["x1"].GetValueAsUnsigned()

    # Note: NOTIFY_DEBUGGER_ABOUT_RX_PAGES will check contents of the
    # first page to see if handled it correctly. This makes diagnosing
    # misconfiguration (e.g. missing breakpoint) easier.
    data = bytearray(page_len)
    data[0:8] = b'IHELPED!'

    error = lldb.SBError()
    frame.GetThread().GetProcess().WriteMemory(base, data, error)
    if not error.Success():
        print(f'Failed to write into {base}[+{page_len}]', error)
        return

def __lldb_init_module(debugger: lldb.SBDebugger, _):
    target = debugger.GetDummyTarget()
    # Caveat: must use BreakpointCreateByRegEx here and not
    # BreakpointCreateByName. For some reasons callback function does not
    # get carried over from dummy target for the later.
    bp = target.BreakpointCreateByRegex("^NOTIFY_DEBUGGER_ABOUT_RX_PAGES$")
    bp.SetScriptCallbackFunction('{}.handle_new_rx_page'.format(__name__))
    bp.SetAutoContinue(True)
    print("-- LLDB integration loaded --")

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: ios/Flutter/ephemeral/flutter_lldb_helper.py
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 866: macos/Flutter/GeneratedPluginRegistrant.swift
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Flutter/GeneratedPluginRegistrant.swift
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Swift
Ø§Ù„Ø­Ø¬Ù…: 427.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 14
================================================================================

//
//  Generated file. Do not edit.
//

import FlutterMacOS
import Foundation

import flutter_secure_storage_darwin
import webview_flutter_wkwebview

func RegisterGeneratedPlugins(registry: FlutterPluginRegistry) {
  FlutterSecureStorageDarwinPlugin.register(with: registry.registrar(forPlugin: "FlutterSecureStorageDarwinPlugin"))
  WebViewFlutterPlugin.register(with: registry.registrar(forPlugin: "WebViewFlutterPlugin"))
}

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Flutter/GeneratedPluginRegistrant.swift
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 867: macos/Flutter/ephemeral/flutter_export_environment.sh
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/macos/Flutter/ephemeral/flutter_export_environment.sh
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Shell
Ø§Ù„Ø­Ø¬Ù…: 578.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 13
================================================================================

#!/bin/sh
# This is a generated file; do not edit or check into version control.
export "FLUTTER_ROOT=/root/flutter"
export "FLUTTER_APPLICATION_PATH=/root/falto"
export "FLUTTER_FRAMEWORK_SWIFT_PACKAGE_PATH=/root/falto/macos/Flutter/ephemeral/Packages/.packages/FlutterFramework"
export "COCOAPODS_PARALLEL_CODE_SIGN=true"
export "FLUTTER_BUILD_DIR=build"
export "FLUTTER_BUILD_NAME=1.0.0"
export "FLUTTER_BUILD_NUMBER=1"
export "DART_OBFUSCATION=false"
export "TRACK_WIDGET_CREATION=true"
export "TREE_SHAKE_ICONS=false"
export "PACKAGE_CONFIG=.dart_tool/package_config.json"

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: macos/Flutter/ephemeral/flutter_export_environment.sh
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 868: windows/CMakeLists.txt
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/CMakeLists.txt
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Text
Ø§Ù„Ø­Ø¬Ù…: 4.1 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 108
================================================================================

# Project-level configuration.
cmake_minimum_required(VERSION 3.14)
project(flutter_trading_app LANGUAGES CXX)

# The name of the executable created for the application. Change this to change
# the on-disk name of your application.
set(BINARY_NAME "flutter_trading_app")

# Explicitly opt in to modern CMake behaviors to avoid warnings with recent
# versions of CMake.
cmake_policy(VERSION 3.14...3.25)

# Define build configuration option.
get_property(IS_MULTICONFIG GLOBAL PROPERTY GENERATOR_IS_MULTI_CONFIG)
if(IS_MULTICONFIG)
  set(CMAKE_CONFIGURATION_TYPES "Debug;Profile;Release"
    CACHE STRING "" FORCE)
else()
  if(NOT CMAKE_BUILD_TYPE AND NOT CMAKE_CONFIGURATION_TYPES)
    set(CMAKE_BUILD_TYPE "Debug" CACHE
      STRING "Flutter build mode" FORCE)
    set_property(CACHE CMAKE_BUILD_TYPE PROPERTY STRINGS
      "Debug" "Profile" "Release")
  endif()
endif()
# Define settings for the Profile build mode.
set(CMAKE_EXE_LINKER_FLAGS_PROFILE "${CMAKE_EXE_LINKER_FLAGS_RELEASE}")
set(CMAKE_SHARED_LINKER_FLAGS_PROFILE "${CMAKE_SHARED_LINKER_FLAGS_RELEASE}")
set(CMAKE_C_FLAGS_PROFILE "${CMAKE_C_FLAGS_RELEASE}")
set(CMAKE_CXX_FLAGS_PROFILE "${CMAKE_CXX_FLAGS_RELEASE}")

# Use Unicode for all projects.
add_definitions(-DUNICODE -D_UNICODE)

# Compilation settings that should be applied to most targets.
#
# Be cautious about adding new options here, as plugins use this function by
# default. In most cases, you should add new options to specific targets instead
# of modifying this function.
function(APPLY_STANDARD_SETTINGS TARGET)
  target_compile_features(${TARGET} PUBLIC cxx_std_17)
  target_compile_options(${TARGET} PRIVATE /W4 /WX /wd"4100")
  target_compile_options(${TARGET} PRIVATE /EHsc)
  target_compile_definitions(${TARGET} PRIVATE "_HAS_EXCEPTIONS=0")
  target_compile_definitions(${TARGET} PRIVATE "$<$<CONFIG:Debug>:_DEBUG>")
endfunction()

# Flutter library and tool build rules.
set(FLUTTER_MANAGED_DIR "${CMAKE_CURRENT_SOURCE_DIR}/flutter")
add_subdirectory(${FLUTTER_MANAGED_DIR})

# Application build; see runner/CMakeLists.txt.
add_subdirectory("runner")


# Generated plugin build rules, which manage building the plugins and adding
# them to the application.
include(flutter/generated_plugins.cmake)


# === Installation ===
# Support files are copied into place next to the executable, so that it can
# run in place. This is done instead of making a separate bundle (as on Linux)
# so that building and running from within Visual Studio will work.
set(BUILD_BUNDLE_DIR "$<TARGET_FILE_DIR:${BINARY_NAME}>")
# Make the "install" step default, as it's required to run.
set(CMAKE_VS_INCLUDE_INSTALL_TO_DEFAULT_BUILD 1)
if(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
  set(CMAKE_INSTALL_PREFIX "${BUILD_BUNDLE_DIR}" CACHE PATH "..." FORCE)
endif()

set(INSTALL_BUNDLE_DATA_DIR "${CMAKE_INSTALL_PREFIX}/data")
set(INSTALL_BUNDLE_LIB_DIR "${CMAKE_INSTALL_PREFIX}")

install(TARGETS ${BINARY_NAME} RUNTIME DESTINATION "${CMAKE_INSTALL_PREFIX}"
  COMPONENT Runtime)

install(FILES "${FLUTTER_ICU_DATA_FILE}" DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  COMPONENT Runtime)

install(FILES "${FLUTTER_LIBRARY}" DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
  COMPONENT Runtime)

if(PLUGIN_BUNDLED_LIBRARIES)
  install(FILES "${PLUGIN_BUNDLED_LIBRARIES}"
    DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
    COMPONENT Runtime)
endif()

# Copy the native assets provided by the build.dart from all packages.
set(NATIVE_ASSETS_DIR "${PROJECT_BUILD_DIR}native_assets/windows/")
install(DIRECTORY "${NATIVE_ASSETS_DIR}"
   DESTINATION "${INSTALL_BUNDLE_LIB_DIR}"
   COMPONENT Runtime)

# Fully re-copy the assets directory on each build to avoid having stale files
# from a previous install.
set(FLUTTER_ASSET_DIR_NAME "flutter_assets")
install(CODE "
  file(REMOVE_RECURSE \"${INSTALL_BUNDLE_DATA_DIR}/${FLUTTER_ASSET_DIR_NAME}\")
  " COMPONENT Runtime)
install(DIRECTORY "${PROJECT_BUILD_DIR}/${FLUTTER_ASSET_DIR_NAME}"
  DESTINATION "${INSTALL_BUNDLE_DATA_DIR}" COMPONENT Runtime)

# Install the AOT library on non-Debug builds only.
install(FILES "${AOT_LIBRARY}" DESTINATION "${INSTALL_BUNDLE_DATA_DIR}"
  CONFIGURATIONS Profile;Release
  COMPONENT Runtime)

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/CMakeLists.txt
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 869: windows/flutter/CMakeLists.txt
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/flutter/CMakeLists.txt
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Text
Ø§Ù„Ø­Ø¬Ù…: 3.7 KB
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 109
================================================================================

# This file controls Flutter-level build steps. It should not be edited.
cmake_minimum_required(VERSION 3.14)

set(EPHEMERAL_DIR "${CMAKE_CURRENT_SOURCE_DIR}/ephemeral")

# Configuration provided via flutter tool.
include(${EPHEMERAL_DIR}/generated_config.cmake)

# TODO: Move the rest of this into files in ephemeral. See
# https://github.com/flutter/flutter/issues/57146.
set(WRAPPER_ROOT "${EPHEMERAL_DIR}/cpp_client_wrapper")

# Set fallback configurations for older versions of the flutter tool.
if (NOT DEFINED FLUTTER_TARGET_PLATFORM)
  set(FLUTTER_TARGET_PLATFORM "windows-x64")
endif()

# === Flutter Library ===
set(FLUTTER_LIBRARY "${EPHEMERAL_DIR}/flutter_windows.dll")

# Published to parent scope for install step.
set(FLUTTER_LIBRARY ${FLUTTER_LIBRARY} PARENT_SCOPE)
set(FLUTTER_ICU_DATA_FILE "${EPHEMERAL_DIR}/icudtl.dat" PARENT_SCOPE)
set(PROJECT_BUILD_DIR "${PROJECT_DIR}/build/" PARENT_SCOPE)
set(AOT_LIBRARY "${PROJECT_DIR}/build/windows/app.so" PARENT_SCOPE)

list(APPEND FLUTTER_LIBRARY_HEADERS
  "flutter_export.h"
  "flutter_windows.h"
  "flutter_messenger.h"
  "flutter_plugin_registrar.h"
  "flutter_texture_registrar.h"
)
list(TRANSFORM FLUTTER_LIBRARY_HEADERS PREPEND "${EPHEMERAL_DIR}/")
add_library(flutter INTERFACE)
target_include_directories(flutter INTERFACE
  "${EPHEMERAL_DIR}"
)
target_link_libraries(flutter INTERFACE "${FLUTTER_LIBRARY}.lib")
add_dependencies(flutter flutter_assemble)

# === Wrapper ===
list(APPEND CPP_WRAPPER_SOURCES_CORE
  "core_implementations.cc"
  "standard_codec.cc"
)
list(TRANSFORM CPP_WRAPPER_SOURCES_CORE PREPEND "${WRAPPER_ROOT}/")
list(APPEND CPP_WRAPPER_SOURCES_PLUGIN
  "plugin_registrar.cc"
)
list(TRANSFORM CPP_WRAPPER_SOURCES_PLUGIN PREPEND "${WRAPPER_ROOT}/")
list(APPEND CPP_WRAPPER_SOURCES_APP
  "flutter_engine.cc"
  "flutter_view_controller.cc"
)
list(TRANSFORM CPP_WRAPPER_SOURCES_APP PREPEND "${WRAPPER_ROOT}/")

# Wrapper sources needed for a plugin.
add_library(flutter_wrapper_plugin STATIC
  ${CPP_WRAPPER_SOURCES_CORE}
  ${CPP_WRAPPER_SOURCES_PLUGIN}
)
apply_standard_settings(flutter_wrapper_plugin)
set_target_properties(flutter_wrapper_plugin PROPERTIES
  POSITION_INDEPENDENT_CODE ON)
set_target_properties(flutter_wrapper_plugin PROPERTIES
  CXX_VISIBILITY_PRESET hidden)
target_link_libraries(flutter_wrapper_plugin PUBLIC flutter)
target_include_directories(flutter_wrapper_plugin PUBLIC
  "${WRAPPER_ROOT}/include"
)
add_dependencies(flutter_wrapper_plugin flutter_assemble)

# Wrapper sources needed for the runner.
add_library(flutter_wrapper_app STATIC
  ${CPP_WRAPPER_SOURCES_CORE}
  ${CPP_WRAPPER_SOURCES_APP}
)
apply_standard_settings(flutter_wrapper_app)
target_link_libraries(flutter_wrapper_app PUBLIC flutter)
target_include_directories(flutter_wrapper_app PUBLIC
  "${WRAPPER_ROOT}/include"
)
add_dependencies(flutter_wrapper_app flutter_assemble)

# === Flutter tool backend ===
# _phony_ is a non-existent file to force this command to run every time,
# since currently there's no way to get a full input/output list from the
# flutter tool.
set(PHONY_OUTPUT "${CMAKE_CURRENT_BINARY_DIR}/_phony_")
set_source_files_properties("${PHONY_OUTPUT}" PROPERTIES SYMBOLIC TRUE)
add_custom_command(
  OUTPUT ${FLUTTER_LIBRARY} ${FLUTTER_LIBRARY_HEADERS}
    ${CPP_WRAPPER_SOURCES_CORE} ${CPP_WRAPPER_SOURCES_PLUGIN}
    ${CPP_WRAPPER_SOURCES_APP}
    ${PHONY_OUTPUT}
  COMMAND ${CMAKE_COMMAND} -E env
    ${FLUTTER_TOOL_ENVIRONMENT}
    "${FLUTTER_ROOT}/packages/flutter_tools/bin/tool_backend.bat"
      ${FLUTTER_TARGET_PLATFORM} $<CONFIG>
  VERBATIM
)
add_custom_target(flutter_assemble DEPENDS
  "${FLUTTER_LIBRARY}"
  ${FLUTTER_LIBRARY_HEADERS}
  ${CPP_WRAPPER_SOURCES_CORE}
  ${CPP_WRAPPER_SOURCES_PLUGIN}
  ${CPP_WRAPPER_SOURCES_APP}
)

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/flutter/CMakeLists.txt
================================================================================


================================================================================
Ø§Ù„Ù…Ù„Ù 870: windows/flutter/generated_plugin_registrant.h
--------------------------------------------------------------------------------
Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„: /root/falto/windows/flutter/generated_plugin_registrant.h
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù: Header
Ø§Ù„Ø­Ø¬Ù…: 302.0 B
Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·Ø±: 15
================================================================================

//
//  Generated file. Do not edit.
//

// clang-format off

#ifndef GENERATED_PLUGIN_REGISTRANT_
#define GENERATED_PLUGIN_REGISTRANT_

#include <flutter/plugin_registry.h>

// Registers Flutter plugins.
void RegisterPlugins(flutter::PluginRegistry* registry);

#endif  // GENERATED_PLUGIN_REGISTRANT_

================================================================================
Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù: windows/flutter/generated_plugin_registrant.h
================================================================================


================================================================================
ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
================================================================================

ğŸ“ˆ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹:
  â€¢ C++: 4 Ù…Ù„Ù
  â€¢ Dart: 797 Ù…Ù„Ù
  â€¢ HTML: 2 Ù…Ù„Ù
  â€¢ Header: 7 Ù…Ù„Ù
  â€¢ JSON: 3 Ù…Ù„Ù
  â€¢ Java: 1 Ù…Ù„Ù
  â€¢ JavaScript: 7 Ù…Ù„Ù
  â€¢ Kotlin: 1 Ù…Ù„Ù
  â€¢ Markdown: 3 Ù…Ù„Ù
  â€¢ Objective-C: 1 Ù…Ù„Ù
  â€¢ Plist: 7 Ù…Ù„Ù
  â€¢ Properties: 4 Ù…Ù„Ù
  â€¢ Python: 3 Ù…Ù„Ù
  â€¢ Shell: 7 Ù…Ù„Ù
  â€¢ Swift: 7 Ù…Ù„Ù
  â€¢ Text: 4 Ù…Ù„Ù
  â€¢ XML: 9 Ù…Ù„Ù
  â€¢ YAML: 3 Ù…Ù„Ù

ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù„Ø¯ (Ø£Ø¹Ù„Ù‰ 10):
  â€¢ lib/features/market/presentation/widgets: 17 Ù…Ù„Ù
  â€¢ lib/core/network: 15 Ù…Ù„Ù
  â€¢ lib/core/storage: 11 Ù…Ù„Ù
  â€¢ lib/features/indicators/domain: 11 Ù…Ù„Ù
  â€¢ lib/features/replay/domain: 10 Ù…Ù„Ù
  â€¢ lib/core/widgets: 9 Ù…Ù„Ù
  â€¢ lib/features/market/presentation/bloc/chart: 9 Ù…Ù„Ù
  â€¢ windows/runner: 9 Ù…Ù„Ù
  â€¢ lib/core/time: 8 Ù…Ù„Ù
  â€¢ lib/core/ui/widgets: 8 Ù…Ù„Ù

================================================================================
ğŸ‰ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨Ù†Ø¬Ø§Ø­!
================================================================================
